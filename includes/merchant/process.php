<?php
/******** 
@USE : merchant side functions
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/

error_reporting(0);
session_start();
header('Content-type: text/html; charset=utf-8');

require_once(LIBRARY."/class.phpmailer.php");
include(LIBRARY.'/simpleimage.php');
require_once(LIBRARY."/PHP-PasswordLib-master/lib/PasswordLib/PasswordLib.php"); 

/******** 
@USE : get merchant session id
@PARAMETER : session_data
@RETURN : session id
@USED IN PAGES : process.php
*********/
function get_merchant_session_id($session_data){

	global $objDB;
	/*$Sql = "SELECT * FROM user_sessions WHERE session_data='".$session_data."'AND user_type='2' ORDER BY id DESC LIMIT 1";
	
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * FROM user_sessions WHERE session_data=? AND user_type=? ORDER BY id DESC LIMIT 1",array($session_data,2));
	if($RS->RecordCount()>0){
		/*$Sql = "DELETE FROM user_sessions WHERE session_id='".$RS->fields['session_id']."' AND user_type='2' AND sessiontime < '".strtotime(date("Y-m-d"))."'";
		$objDB->Conn->Execute($Sql);*/
		$objDBWrt->Conn->Execute("DELETE FROM user_sessions WHERE session_id=? AND user_type=? AND sessiontime < ?",array($RS->fields['session_id'],2,strtotime(date("Y-m-d"))));
		$session_id = base64_decode($RS->fields['session_id']);
		return $session_id;
	}
	return "";
	
}

/* */
if(isset($_REQUEST['doAction']))
{
	switch($_REQUEST['doAction'])
	{
            case "sendmail":
		       echo $_REQUEST['email_ids'];
                       $email_arr = explode($_REQUEST['email_ids']);
                       for($i=0;$i<count($email_arr);$i++)
                       {
				                           
                       }
	    break;
        }
}
/******** 
@USE : to login
@PARAMETER : lemail, lpassword
@RETURN : json user data
@USED IN PAGES : process.php, register.php, manage-groups.php
*********/
if(isset($_REQUEST['btnLogin']))
{
		
		$array = $json_array = array();
			$array_role = $json_array = array();
		$array1 = $json_array = array();
		$array2 = $json_array = array();
		
		
		$array['email'] = $_REQUEST['lemail'];
		//$array['password'] = md5($_REQUEST['lpassword']);
		
		$RS = $objDB->Show("merchant_user",$array);
		$merchant_parent_value=$RS->fields['merchant_parent'];
		
		
		
		$array2['email'] = $_REQUEST['lemail'];
		$get_password = $objDB->Show("merchant_user",$array2);
		
		
		 if($get_password->RecordCount()<=0)
		 {
			$json_array['status'] = "false";
			$json_array['message'] = $merchant_msg['login_register']['Msg_not_register'];
			$json = json_encode($json_array);
			echo $json;
			exit();
		 }
		 else 
		 {
			 $PasswordLib2 = new \PasswordLib\PasswordLib;
			
		$result = $PasswordLib2->verifyPasswordHash($_REQUEST['lpassword'],$RS->fields['password']);
			 if(!$result)
			{
				$json_array['status'] = "false";
				$json_array['message'] = $client_msg["login_register"]["Msg_Email_Password"];
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
		}
		
		/*$br_sql = "Select * from merchant_user where id=".$RS->fields['id'];
		$br_rs =  $objDB->Conn->Execute($br_sql);*/
		$br_rs =  $objDB->Conn->Execute("Select * from merchant_user where id=?",array($RS->fields['id']));
		$br = $br_rs->fields['profile_complete'];
		if($br=="1")
		{
                        
			$_SESSION['profile_complete']="1";
		}
		else
		{ 
                        
			$json_array['status'] = "merchantsetup";
			$json_array['url']="merchant-setup.php";
			if(isset($_REQUEST['redirecttab']))
			{		
				if($_REQUEST['redirecttab']!="")
				{
					$json_array['url']="merchant-setup.php?tab=".$_REQUEST['redirecttab'];
				}
				else if($RS->fields['last_tab']!="")
				{
					$json_array['url']="merchant-setup.php?tab=".$RS->fields['last_tab'];
				}
				else
				{
					$json_array['url']="merchant-setup.php";
				}
			}
			
			$_SESSION['merchant_id'] = $RS->fields['id'];
			$Row = $RS->FetchRow();
			$_SESSION['merchant_info'] = $Row;
			$_SESSION['profile_complete']="0";
			$_SESSION['password_changed']=$br_rs->fields['password_changed'];
			$json = json_encode($json_array);
			echo $json;
			exit();
		}
		
		
		if($RS->fields['profile_complete']!=1)
		{
		
		}
	
		 if($merchant_parent_value == 0)
		 {
			
			if($RS->fields['active'] == 0)
			{
			
				$json_array['status'] = "false";
				$json_array['message'] = $merchant_msg['login_register']['Msg_login_password_not_match'];
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			if($RS->fields['approve'] == 0)
			{
				$json_array['status'] = "false";
				$json_array['message'] = $merchant_msg['login_register']['Msg_status_blocked'];
				$json = json_encode($json_array);
				echo $json;
				exit();		
			}
					
			
		}
		else
		{
			$array1['id'] = $merchant_parent_value;
			$RS1 = $objDB->Show("merchant_user",$array1);
			
			
			if($RS1->fields['approve'] == 0)
			{
			
				$json_array['status'] = "false";
				$json_array['message'] = $merchant_msg['login_register']['Msg_status_blocked'];
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			if($RS->fields['active'] == 0)
			{
			
				$json_array['status'] = "false";
				$json_array['message'] = $merchant_msg['login_register']['Msg_login_password_not_match'];
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			if($RS->fields['approve'] == 0)
			{
			
				$json_array['status'] = "false";
				$json_array['message'] = $merchant_msg['login_register']['Msg_employee_status_blocked'];
				$json = json_encode($json_array);
				echo $json;
				exit();
			}		
				  
			
			
		}
		
        $Row = $RS->FetchRow();
         
        $phone_number=$Row['phone_number'];
        $address=$Row['address'];
        
        if($phone_number == "" || $address == "")
        {
           
        }
        
        $cntry = array();	
		$cntry['id'] = $Row['country'];
		$RS_cntry = $objDB->Show("country", $cntry);
        
		//$currency = $objDB->Conn->Execute("select currency_code,currrency_symbol from currencies where country_name=?",array($Row['country']));
		$currency = $objDB->Conn->Execute("select currency_code,currrency_symbol from currencies where id_countries=?",array($RS_cntry->fields['currency_id']));
		
		$_SESSION['merchant_id'] = $Row['id'];
		$_SESSION['merchant_info'] = $Row;  
                $_SESSION['merchant_info']['currency_code']=$currency->fields['currency_code'];
                $_SESSION['merchant_info']['currrency_symbol']=$currency->fields['currrency_symbol'];
        
		// 08 01 2015
		
		$arr_1=file(WEB_PATH.'/merchant/process.php?getmainmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);
		if(trim($arr_1[0]) == "")
		{
		 unset($arr_1[0]);
		 $arr_1 = array_values($arr_1);
		}
		$json_1 = json_decode($arr_1[0]);
		$main_merchant_id = $json_1->main_merchant_id;
		
		$array_nw = array();
		$array_nw['id'] = $main_merchant_id;
		$RS = $objDB->Show("merchant_user",$array_nw);
		$_SESSION['merchant_info']['image_count'] = $RS->fields['image_count']; 
        
        // 08 01 2015
        
        /*$Sql = "SELECT * from merchant_user_role where merchant_user_id =".$_SESSION['merchant_id'];     
        $RS_role = $objDB->Conn->Execute($Sql);*/
		$RS_role = $objDB->Conn->Execute("SELECT * from merchant_user_role where merchant_user_id =?",array($_SESSION['merchant_id']));
	
	
	
        if($RS_role->RecordCount()>0)
		{
            
            while($Row_role = $RS_role->FetchRow())
            {
                    $Row_role['merchant_user_id'];
                    $ass_page = unserialize($Row_role['ass_page']);
                    $ass_role = unserialize($Row_role['ass_role']);
                    foreach ($ass_page as $op_page)
                    {
                            $op_page;
                    }
                    foreach ($ass_role as $op_role)
                    {
                            $op_role;
                    }
			}
            
        }
        else
        {
            echo "";
        }
         
	$array_values = $where_clause = $array = array();
	$array_values['last_login'] = date("Y-m-d H:i:s");
	$where_clause['id'] = $_SESSION['merchant_id'];
        
	
        $objDBWrt->Update($array_values, "merchant_user", $where_clause);
	
	$array = array();
	$user_session = session_id();
	$array['sessiontime'] = strtotime(date("Y-m-d H:i:s")); 
	$array['session_id'] = base64_encode($_SESSION['merchant_id']); 
	$array['session_data'] = md5("merchant".$array['sessiontime'].$user_session); 
	
	
        
    $objDBWrt->Insert($array, "user_sessions");
	
	$json_array['status'] = "true";
	$json_array['merchant_id'] = $array['session_data'];
	
	$Sql = "SELECT * from merchant_user where id =".$_SESSION['merchant_id'];
		       
        $RS = $objDB->Conn->Execute($Sql);
	$ar = ($RS->fields);
	$filed_value = get_field_value($ar);
	$json_array['merchant_info'] = $filed_value;
	
	
	$cookie_email = $_REQUEST['lemail'];
	$cookie_password = $_REQUEST['lpassword'];
	$cookie_time = time()+60*60*24*30;
        if(isset($_REQUEST['keepme']))
        {
              $rememberme = $_REQUEST['keepme'];
        }
	
	if(isset($_REQUEST['keepme']))
	{
		setcookie("cookie_email",$cookie_email,$cookie_time,'','','');
		
	}
	else
	{
		$time = time();
		setcookie("cookie_email",'',$time - 3600,'','','');
		
	}
	
	
	/*$br_sql = "Select * from merchant_user where id=".$_SESSION['merchant_id'];
	$br_rs =  $objDB->Conn->Execute($br_sql);*/
	$br_rs =  $objDB->Conn->Execute("Select * from merchant_user where id=?",array($_SESSION['merchant_id']));
	$br = $br_rs->fields['profile_complete'];
	if($br=="1")
	{
		$_SESSION['profile_complete']="1";
	}
	else
	{
		$json_array['status'] = "merchantsetup";
		if(isset($_REQUEST['redirecttab']))
		{		
			if($_REQUEST['redirecttab']!="")
			{
				$json_array['url']="merchant-setup.php?tab=".$_REQUEST['redirecttab'];
			}
			else
			{
				$json_array['url']="merchant-setup.php";
			}
		}
		$_SESSION['profile_complete']="0";
		
	}
	$_SESSION['password_changed']=$br_rs->fields['password_changed'];
   	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : to register
@PARAMETER : email, business, firstname, lastname
@RETURN : json user id 
@USED IN PAGES : process.php, register.php, manage-groups.php
*********/
if(isset($_REQUEST['btnRegister'])){
	$array = $json_array = array();
	$array['email'] = $_REQUEST['email'];
	
	//echo "<pre>";print_r($_REQUEST);echo "</pre>";//exit();
	$RS = $objDB->Show("merchant_user",$array);
	if($RS->RecordCount()>0){
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg['login_register']['Msg_email_exist'];
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	
	
        $array['business'] = ucwords(strtolower($_REQUEST['business']));
		
	$array['firstname'] = ucwords(strtolower($_REQUEST['firstname']));
	$array['lastname'] = ucwords(strtolower($_REQUEST['lastname']));

	
	//$array['available_point'] = 100;
	$array['total_no_of_campaign'] = 0;
	
	$array['created_date'] = date("Y-m-d H:i:s");
	$array['approve'] = "0";
	$muid = $objDBWrt->Insert($array, "merchant_user");
	$_SESSION["merchant_id"] = $muid;
	
	$array = array();
	$array['id'] = $muid;
	
	$RS = $objDB->Show("merchant_user",$array);
	$Row = $RS->FetchRow();
	$_SESSION['merchant_info'] = $Row;      
	                
	
	$json_array['status'] = "true";
	$json_array['url']="merchant-setup.php";
	$json_array['message'] = $merchant_msg['login_register']['Msg_merchant_register'];
	$json = json_encode($json_array);
	echo $json;
	exit();
	
	
}

/******** 
@USE : get campaign list from reward card
@PARAMETER : reward_card_number
@RETURN : json campaign list
@USED IN PAGES : process.php, redeem-deal.php
*********/
if(isset($_REQUEST['getcamplist_from_rewardcard']))
{
	$array = $json_array = array();
	$campaign_records = array();
	$count=0;
	$html="";
	
	$reward_card_number = $_REQUEST['reward_card_number'];
	$merchant_id = $_SESSION['merchant_id'];
	
	if($_SESSION['merchant_info']['merchant_parent'] == 0)
	{ 
		$location_id = $_SESSION['merchant_info']['redeem_location'];
    }
    else
    {
		$array_mr=array();
		$array_mr['merchant_user_id'] = $_SESSION['merchant_id'];
		$RS_mr = $objDB->Show("merchant_user_role",$array_mr);
			
		$location_id = $RS_mr->fields['location_access'];
	}
	
	$arr_cust = array();
	$arr_cust['card_id'] = $reward_card_number;
	$RS_cust = $objDB->Show("customer_user",$arr_cust);
	
	
	if($RS_cust->RecordCount()>0)
	{
		$customer_id = $RS_cust->fields['id'];
	
		/*$campaign_sql = "SELECT c.id,c.title,c.business_logo,cc.coupon_code 
				FROM campaign_location  cl
				inner join campaigns c  on cl.campaign_id =c.id 
				inner join locations l on l.id = cl.location_id 
				inner join coupon_codes cc on cc.customer_campaign_code=c.id 
				WHERE l.id=$location_id and l.active = 1 
					  and c.id in ( select campaign_id from customer_campaigns where customer_id =$customer_id and location_id=cl.location_id and activation_status=1) 
					  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN c.start_date AND c.expiration_date 
					  and cl.active=1 and cc.customer_id=$customer_id and cc.location_id=$location_id 
				ORDER BY c.expiration_date";
	
		
	   $RS_campaign_data=$objDB->Conn->Execute($campaign_sql);*/
		$RS_campaign_data=$objDB->Conn->Execute("SELECT c.id,c.title,c.business_logo,cc.coupon_code 
				FROM campaign_location  cl
				inner join campaigns c  on cl.campaign_id =c.id 
				inner join locations l on l.id = cl.location_id 
				inner join coupon_codes cc on cc.customer_campaign_code=c.id 
				WHERE l.id=? and l.active = ? and c.id in ( select campaign_id from customer_campaigns where customer_id =? and location_id=cl.location_id and activation_status=?) AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN c.start_date AND c.expiration_date and cl.active=? and cc.customer_id=? and cc.location_id=? 
				ORDER BY c.expiration_date",array($location_id,1,$customer_id,1,1,$customer_id,$location_id));
 
	   if($RS_campaign_data->RecordCount()>0)
		{
			$html.="<div class='campaign_main_container'>";
			$html.="<div class='campaign_inner_container'>";
			$html.="<div class='cic_left'>Select Campaign To Redeem</div>";
			$html.="<div class='cic_right'><input type='button' id='goback_rewardcard' name='goback_rewardcard' value='Go Back' /></div>";
			$html.="</div>";
			
			$html.='<div class="filtergroup">
						<h3>Filter</h3>
						<div class="filters">
						  <input type="button" class="fltr_button" id="fltr_all" value="Show All" />
						  <input type="button" class="fltr_button" id="fltr_campaign" value="Campaign" />
						  <input type="button" class="fltr_button" id="fltr_stamp" value="Stamp" />
						</div>
					</div>';
			
			$html.="<div id='campaign_inner_div_cnter'>";
			while($Row_campaign = $RS_campaign_data->FetchRow())
			{
				
				
				$html.="<div class='campaign_inner_div' camp='1'>";
				
				$html.="<img class='lst_img' src='".ASSETS_IMG."/m/campaign/block/".$Row_campaign['business_logo']."'/>";
				$html.="<div class='lst_title'>".$Row_campaign['title']."</div>";
				$html.="<div class='lst_select'><input type='button' name='campaign_select_".$Row_campaign['id']."' id='campaign_select_".$Row_campaign['id']."' coupon_code='".$Row_campaign['coupon_code']."' value='Select' /></div>";
				
				$html.="</div>";
				
				$count++;
			}
			$html.="</div>";
			$html.="</div>";
				
			$json_array['status'] = "true";
			$json_array['code_status'] = 1;
			$json_array['total_records'] = $RS_campaign_data->RecordCount();
			$json_array['html'] = $html;
			$json = json_encode($json_array);
			echo $json;
			exit(); 
		
		}
		else
		{
			
			/*$campaign_sql = "SELECT c.id,c.title,c.business_logo,cc.coupon_code 
				FROM campaign_location  cl
				inner join campaigns c  on cl.campaign_id =c.id 
				inner join locations l on l.id = cl.location_id 
				inner join coupon_codes cc on cc.customer_campaign_code=c.id 
				WHERE l.active = 1 
					  and c.id in ( select campaign_id from customer_campaigns where customer_id =$customer_id and location_id=cl.location_id and activation_status=1) 
					  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN c.start_date AND c.expiration_date 
					  and cl.active=1 and cc.customer_id=$customer_id  
				ORDER BY c.expiration_date";
	
			
		   $RS_campaign_data=$objDB->Conn->Execute($campaign_sql);*/
			$RS_campaign_data=$objDB->Conn->Execute("SELECT c.id,c.title,c.business_logo,cc.coupon_code 
				FROM campaign_location  cl
				inner join campaigns c  on cl.campaign_id =c.id 
				inner join locations l on l.id = cl.location_id 
				inner join coupon_codes cc on cc.customer_campaign_code=c.id 
				WHERE l.active = ? 
					  and c.id in ( select campaign_id from customer_campaigns where customer_id =? and location_id=cl.location_id and activation_status=?) 
					  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN c.start_date AND c.expiration_date 
					  and cl.active=? and cc.customer_id=?  
				ORDER BY c.expiration_date",array(1,$customer_id,1,1,$customer_id));
		
			if($RS_campaign_data->RecordCount()>0)
			{
				$json_array['status'] = "false";
				$json_array['code_status'] = 1;
				$json_array['error_msg'] =  $merchant_msg["redeem-deal"]["Msg_no_offer_assigned_location"];
				$json_array['total_records'] = 0;
				$json = json_encode($json_array);
				echo $json;
				exit;			
			}
			else
			{
				$json_array['status'] = "false";
				$json_array['code_status'] = 1;
				$json_array['error_msg'] =  $merchant_msg["redeem-deal"]["Msg_no_offer"];
				$json_array['total_records'] = 0;
				$json = json_encode($json_array);
				echo $json;
				exit;		
			}
		}
	} 
    else
	{
	
		$json_array['status'] = "false";
		$json_array['code_status'] = 0;
		$json_array['error_msg'] =  $merchant_msg["redeem-deal"]["Msg_enter_reward_card"];
		$json_array['total_records'] = 0;
		$json = json_encode($json_array);
		echo $json;
		exit;		
	}
    
     
	
}

/******** 
@USE : check captcha code
@PARAMETER : code
@RETURN : code
@USED IN PAGES : register.php, contact-us.php
*********/
if(isset($_REQUEST['captchacode_check_m_r']))
{
	if(strtolower($_REQUEST['code']) == strtolower($_SESSION['random_number_m_r']))
	{
		
				
		echo 1;// submitted 
		
	}
	else
	{
		echo 0; // invalid code
	}
}


$timezoness =array(
    'Pacific/Wake' => '(GMT-12:00) International Date Line West',
    'Pacific/Apia' => '(GMT-11:00) Samoa',
    'US/Hawaii' => '(GMT-10:00) Hawaii',
    'America/Anchorage' => '(GMT-09:00) Alaska',
    'America/Los_Angeles' => '(GMT-08:00) Pacific Time (US & Canada); Tijuana',
    'America/Phoenix' => '(GMT-07:00) Arizona',
    'America/Chihuahua' => '(GMT-07:00) Mazatlan',
    'America/Denver' => '(GMT-07:00) Mountain Time (US & Canada)',
    'America/Managua' => '(GMT-06:00) Central America',
    'America/Chicago' => '(GMT-06:00) Central Time (US & Canada)',
    'America/Mexico_City' => '(GMT-06:00) Monterrey',
    'America/Regina' => '(GMT-06:00) Saskatchewan',
    'America/Bogota' => '(GMT-05:00) Quito',
    'America/New_York' => '(GMT-05:00) Eastern Time (US & Canada)',
    'America/Indiana/Indianapolis' => '(GMT-05:00) Indiana (East)',
    'America/Halifax' => '(GMT-04:00) Atlantic Time (Canada)',
    'America/Caracas' => '(GMT-04:00) La Paz',
    'America/Santiago' => '(GMT-04:00) Santiago',
    'America/St_Johns' => '(GMT-03:30) Newfoundland',
    'America/Sao_Paulo' => '(GMT-03:00) Brasilia',
    'America/Argentina/Buenos_Aires' => '(GMT-03:00) Georgetown',
    'America/Godthab' => '(GMT-03:00) Greenland',
    'America/Noronha' => '(GMT-02:00) Mid-Atlantic',
    'Atlantic/Azores' => '(GMT-01:00) Azores',
    'Atlantic/Cape_Verde' => '(GMT-01:00) Cape Verde Is.',
    'Africa/Casablanca' => '(GMT) Monrovia',
    'Europe/London' => '(GMT) London',
    'Europe/Berlin' => '(GMT+01:00) Vienna',
    'Europe/Belgrade' => '(GMT+01:00) Prague',
    'Europe/Paris' => '(GMT+01:00) Paris',
    'Europe/Sarajevo' => '(GMT+01:00) Zagreb',
    'Africa/Lagos' => '(GMT+01:00) West Central Africa',
    'Europe/Istanbul' => '(GMT+02:00) Minsk',
    'Europe/Bucharest' => '(GMT+02:00) Bucharest',
    'Africa/Cairo' => '(GMT+02:00) Cairo',
    'Africa/Johannesburg' => '(GMT+02:00) Pretoria',
    'Europe/Helsinki' => '(GMT+02:00) Vilnius',
    'Asia/Jerusalem' => '(GMT+02:00) Jerusalem',
    'Asia/Baghdad' => '(GMT+03:00) Baghdad',
    'Asia/Riyadh' => '(GMT+03:00) Riyadh',
    'Europe/Moscow' => '(GMT+03:00) Volgograd',
    'Africa/Nairobi' => '(GMT+03:00) Nairobi',
    'Asia/Tehran' => '(GMT+03:30) Tehran',
    'Asia/Muscat' => '(GMT+04:00) Muscat',
    'Asia/Tbilisi' => '(GMT+04:00) Yerevan',
    'Asia/Kabul' => '(GMT+04:30) Kabul',
    'Asia/Yekaterinburg' => '(GMT+05:00) Ekaterinburg',
    'Asia/Karachi' => '(GMT+05:00) Tashkent',
    'Asia/Calcutta' => '(GMT+05:30) New Delhi',
    'Asia/Katmandu' => '(GMT+05:45) Kathmandu',
    'Asia/Novosibirsk' => '(GMT+06:00) Novosibirsk',
    'Asia/Dhaka' => '(GMT+06:00) Dhaka',
    'Asia/Colombo' => '(GMT+06:00) Sri Jayawardenepura',
    'Asia/Rangoon' => '(GMT+06:30) Rangoon',
    'Asia/Bangkok' => '(GMT+07:00) Jakarta',
    'Asia/Krasnoyarsk' => '(GMT+07:00) Krasnoyarsk',
    'Asia/Hong_Kong' => '(GMT+08:00) Urumqi',
    'Asia/Irkutsk' => '(GMT+08:00) Ulaan Bataar',
    'Asia/Singapore' => '(GMT+08:00) Singapore',
    'Australia/Perth' => '(GMT+08:00) Perth',
    'Asia/Taipei' => '(GMT+08:00) Taipei',
    'Asia/Tokyo' => '(GMT+09:00) Tokyo',
    'Asia/Seoul' => '(GMT+09:00) Seoul',
    'Asia/Yakutsk' => '(GMT+09:00) Yakutsk',
    'Australia/Adelaide' => '(GMT+09:30) Adelaide',
    'Australia/Darwin' => '(GMT+09:30) Darwin',
    'Australia/Brisbane' => '(GMT+10:00) Brisbane',
    'Australia/Sydney' => '(GMT+10:00) Sydney',
    'Pacific/Guam' => '(GMT+10:00) Port Moresby',
    'Australia/Hobart' => '(GMT+10:00) Hobart',
    'Asia/Vladivostok' => '(GMT+10:00) Vladivostok',
    'Asia/Magadan' => '(GMT+11:00) Solomon Is.',
    'Pacific/Auckland' => '(GMT+12:00) Wellington',
    'Pacific/Fiji' => '(GMT+12:00) Marshall Is.',
    'Pacific/Tongatapu' => '(GMT+13:00) Nuku\'alofa',
);
$timezones_value = array();
foreach($timezoness as $key=>$value)
{
 $arr = explode(")",$timezoness[$key]);
 $arr1 =  explode("T",$arr[0]);
 $timezones_value[$key] =  $arr1[1];
}
/******** 
@USE : to add location
@PARAMETER : country,city,state,zip,address,email,hdn_image_path,mobile_country_code,mobileno_area_code,mobileno2,mobileno,businessname,location_name,pricerange,chk_parking,website,facebook,google,hdnlc1,hdn_more_images,monhdn,tuehdn,wedhdn,thuhdn,frihdn,sathdn,sunhdn,
@RETURN : json data
@USED IN PAGES : add-location.php
*********/
if(isset($_REQUEST['btnAddLocation']))
{
	
   $mobile_no=$_REQUEST['mobile_country_code']."-".$_REQUEST['mobileno_area_code']."-".$_REQUEST['mobileno2']."-".$_REQUEST['mobileno'];
	
    $array = $json_array = array();
    
         /*  start of PAY-508-28033  */
	if($_REQUEST['hdn_image_path'] == "")
	{
		
		$array['picture'] = "";
	}	
	
	else
	{
		
		$array['picture'] = $_REQUEST['hdn_image_path'];	
	}
	/*  end of PAY-508-28033  */
 
    if(isset($_REQUEST['id'])){if($_REQUEST['id'] == ""){
		$array['created_by'] = $_SESSION['merchant_id'];
	}else{
		$array['created_by'] = get_merchant_session_id($_REQUEST['id']);
	}}else{$array['created_by'] = $_SESSION['merchant_id'];}
        $array['email'] = $_REQUEST['email'];
	$string_address = $_REQUEST['address'].", ".$_REQUEST['city'].", ".$_REQUEST['state'].", ".$_REQUEST['zip'];
	$string_address = urlencode($string_address);
	$geocode= file_get_contents("https://maps.googleapis.com/maps/api/geocode/json?address=".$string_address."&sensor=false");
	$geojson= json_decode($geocode,true);
	if($geojson['status']=='OK'){
		$array['latitude'] = $geojson['results'][0]['geometry']['location']['lat'];
		$array['longitude'] = $geojson['results'][0]['geometry']['location']['lng'];
		
		/****** get location timezone information from lattitude and longitude *********/
		 $geocode= file_get_contents("http://api.timezonedb.com/?lat=".$array['latitude']."&lng=".$array['longitude']."&key=V5R3I13VWW28&format=json");
		$geojson_timezone= json_decode($geocode,true);	
		
		if($geojson_timezone['dst'] == 1)
		{
			$timezone_name = $geojson_timezone['zoneName'];
			$zonehouroffset = timezone_offsethour_string($geojson_timezone['gmtOffset']).",0";
			
		}
		else
		{
			$timezone_name = $geojson_timezone['zoneName'];
			$zonehouroffset = getStandardOffsetUTC($geojson_timezone['zoneName'],$geojson_timezone['gmtOffset']).",0";
			
		}
		$array['is_dst'] = $geojson_timezone['dst'];
		 $array['timezone'] = $zonehouroffset;
          $array['timezone_name'] = $timezone_name;
		/****** get location timezone information from lattitude and longitude *********/		
	}
        if($_REQUEST['location_name'] == "")
	{
	$b = $_REQUEST['businessname'];
		$array['location_name'] = ucwords(strtolower($_REQUEST['businessname']));
	}
	else
	{
	$b = $_REQUEST['location_name'];
		$array['location_name'] = ucwords(strtolower($_REQUEST['location_name']));
	}
    if(isset($_POST['chk_payment_method']))
	{
		$payment_method="";
		foreach($_POST['chk_payment_method'] as $payment_method1)
		{
			$payment_method.=$payment_method1.",";
		}
		$payment_method=substr($payment_method, 0, -1);
		$array['payment_method'] = $payment_method;
	}
	if(isset($_POST['services']))
	{         
		$array['services'] = $_POST['services'];         
	}
	if(isset($_POST['amenities']))
	{         
		$array['amenities'] = $_POST['amenities'];         
	}
	if(isset($_POST['restrictions']))
	{         
		$array['restrictions'] = $_POST['restrictions'];         
	}
	if(isset($_POST['rdo_google_street']))
	{	               		
		$array['display_google_street_view_image'] = $_POST['rdo_google_street'];			
	}    
	if(isset($_POST['pricerange']))
	{
		$pricerange=$_POST['pricerange'];
		$array['pricerange'] =$pricerange;
	}
	if(isset($_POST['chk_parking']))
	{
		$parking="";
		foreach($_POST['chk_parking'] as $parking1)
		{
			$parking.=$parking1.",";
		}
		$parking=substr($parking, 0, -1);
		$array['parking'] = $parking;
	}
	
	$array['address'] = ucwords(strtolower($_REQUEST['address']));
	$array['city'] = ucwords(strtolower($_REQUEST['city']));
	$array['state'] = $_REQUEST['state'];
	$array['zip'] = strtoupper($_REQUEST['zip']);
        
       
         //Website Code
		 
		if($_REQUEST['website']!="")
		{		
			$website_array=array();
			$website_array = explode("/",$_REQUEST['website']);
			
			if($website_array[0] == "http:" || $website_array[0] == "https:")
			{
				
				$array['website'] = $_REQUEST['website'];
			}
			else
			{
			   $array['website'] = "http://".$_REQUEST['website'];
			}
		}
                else
                {
                    $array['website'] = $_REQUEST['website'];
                }
		if($_REQUEST['facebook']!="")
		{
			$facebook_array=array();        
			 $facebook_array = explode("/",$_REQUEST['facebook']);
			if($facebook_array[0] == "http:" || $facebook_array[0] == "https:")
			{
				$array['facebook'] = $_REQUEST['facebook'];
				
			}
			else
			{
			  $array['facebook'] = "http://".$_REQUEST['facebook'];
			}
		}
                else
                {
                    $array['facebook'] = $_REQUEST['facebook'];
                }
		if($_REQUEST['google']!="")
		{
			$google_array=array();
			$google_array = explode("/",$_REQUEST['google']);
			if($google_array[0] == "http:" || $google_array[0] == "https:")
			{
				$array['google'] = $_REQUEST['google'];
				
			}
			else
			{
			  $array['google'] = "http://".$_REQUEST['google'];
			}
		}
                else
                {
                    $array['google'] = $_REQUEST['google'];
                }
        // end of website code
          
	//$array['country'] = $_REQUEST['country'];
	$array['country'] = $_SESSION['merchant_info']['country'];
	
	if(isset($_REQUEST['facebookradio'])){ $array['location_publish']=$_REQUEST['facebookradio']; }
    if(isset($_REQUEST['googleradio'])){ $array['location_publish_google']=$_REQUEST['googleradio']; }
	
	$array['phone_number']=$mobile_no;
	if(isset($_REQUEST['chk_is_primary'])){$array['is_primary']=$_REQUEST['chk_is_primary']; }
	
	$array['created_date'] = date("Y-m-d H:i:s");
        $array['modified_date'] = date("Y-m-d H:i:s");
	$array['active'] = 1;
	

			$location_categories=array();
			if($_POST['hdnlc1'])
			{
				array_push($location_categories,$_POST['hdnlc1']);
			}
			if($_POST['hdnlc2'])
			{
				array_push($location_categories,$_POST['hdnlc2']);
			}
			if($_POST['hdnlc3'])
			{
				array_push($location_categories,$_POST['hdnlc3']);
			}
			
			$array['categories']=implode(",",$location_categories);
		
			
			$id = $objDBWrt->Insert($array, "locations");
			$array_new = $where_clause1 = array();
			$permalink_url = $objJSON->create_location_url($id,$b,$_REQUEST['city']);
			$array_new['location_permalink'] = $permalink_url;
            
			
			$where_clause1['id'] = $id;
			$objDBWrt->Update($array_new , "locations", $where_clause1);
            
            
	       $json_array['status'] = "true";
            /*
             $where_mg = array();    
        $where_mg['merchant_id'] = $_SESSION['merchant_id'];
        $where_mg['group_name'] = 'private';
        $where_mg['location_id'] = $id;
        $where_mg['private'] = 1;	
		$RS_mg = $objDB->Show("merchant_groups", $where_mg);      
		
        if($RS_mg->RecordCount()>0){
		
		}
		else
		{
		
		 $group_array = array();
             $group_array['group_name'] = "private";
             $group_array['location_id'] = $id;
              $group_array['merchant_id'] = $_SESSION['merchant_id'];
              $group_array['active']= 1;
               $group_array['private'] = 1;
               
             $objDBWrt->Insert($group_array, "merchant_groups");
        }
        */     
             /* Image Upload Task*/
        $array_images_more = $where_clause_images  = array();
        $hdn_images=$_REQUEST['hdn_more_images'];
        
        if(count($hdn_images) > 0)
        {    
            for($i=0;$i<count($hdn_images);$i++)
             {


                     $array_images_more['location_id']=$id;
                     $array_images_more['main_image']=$hdn_images[$i];
                     $array_images_more['image_id']=$i;
                      $objDBWrt->Insert($array_images_more, "location_images");

                 copy(UPLOAD_IMG.'/m/location/temp_main/'.$hdn_images[$i],UPLOAD_IMG.'/m/location/'.$hdn_images[$i]);
                 copy(UPLOAD_IMG.'/m/location/temp_thumb/'.$hdn_images[$i],UPLOAD_IMG.'/m/location/thumb/'.$hdn_images[$i] );

                 unlink(UPLOAD_IMG."/m/location/temp_main/".$hdn_images[$i]);
                 unlink(UPLOAD_IMG."/m/location/temp_thumb/".$hdn_images[$i]);


             }
        }
        /* End Image Upload Task*/
             
                /* Add Hours Code */
            $array_hours = $where_clause_hours  = array();
        if($_REQUEST['monhdn']!="")
        {
            $array_monhdn=explode("-",$_REQUEST['monhdn']);
            
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            
            $objDBWrt->Insert($array_hours, "location_hours");
            
        }
        
        if($_REQUEST['tuehdn']!="")
        {
            $array_monhdn=explode("-",$_REQUEST['tuehdn']);
            
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            
            $objDBWrt->Insert($array_hours, "location_hours");
            
        }
        
        if($_REQUEST['wedhdn']!="")
        {
            $array_monhdn=explode("-",$_REQUEST['wedhdn']);

            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $objDBWrt->Insert($array_hours, "location_hours");
            
        }
        
        if($_REQUEST['thuhdn']!="")
        {
            $array_monhdn=explode("-",$_REQUEST['thuhdn']);

            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $objDBWrt->Insert($array_hours, "location_hours");
            
        }
        
         if($_REQUEST['frihdn']!="")
        {
            $array_monhdn=explode("-",$_REQUEST['frihdn']);
            
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
           
            $objDBWrt->Insert($array_hours, "location_hours");
            
        }
        
         if($_REQUEST['sathdn']!="")
        {
            $array_monhdn=explode("-",$_REQUEST['sathdn']);
            
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $objDBWrt->Insert($array_hours, "location_hours");
            
        }
        
        if($_REQUEST['sunhdn']!="")
        {
            $array_monhdn=explode("-",$_REQUEST['sunhdn']);
            
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $objDBWrt->Insert($array_hours, "location_hours");
            
        }
  
        
        /* End of Add Hours Code */
             
             
	 $_SESSION['msg'] = $merchant_msg['addlocation']['Msg_location_added'];
	       $json_array['message'] = $merchant_msg['addlocation']['Msg_location_added'];

	
	$json = json_encode($json_array);
	echo $json;
       
	exit();
         
         
}

/***** 
@USE : Before go to add location page  check  whether max number Of location limit is reached or not
@PERAMETER : Current login merchant id
@RETURN : Add location status
@USED IN PAGES :  locations.php
******/

if(isset($_REQUEST['btnGetMaxNumberOfLocation'])){
    $array = $json_array = array();
	/*
	$Sql = "SELECT * from merchant_user where id =".$_SESSION['merchant_id'];       
	$RS_merchant = $objDB->Conn->Execute($Sql);
	
    $max_loca=$RS_merchant->fields['number_of_locations'];
    */
    $array_where_mb['merchant_id'] = $_SESSION['merchant_id'];
    $RS_mb = $objDB->Show("merchant_billing", $array_where_mb);
    $array_where_bp['id'] = $RS_mb->fields['pack_id'];
    $RS_bp = $objDB->Show("billing_packages", $array_where_bp);
    $max_loca=$RS_bp->fields['no_of_loca'];
 
    $where_clause['created_by'] = $_SESSION['merchant_id'];
	$RSt = $objDB->Show("locations", $where_clause);
	$tot_loca= $RSt->RecordCount();
	if($tot_loca<$max_loca)
	{
		$json_array['status'] = "true";
		$json = json_encode($json_array);
		echo $json;
		
		exit();
    }
    else
    {
		$json_array['status'] = "false";
		//$_SESSION['msg'] = "At present you can only add ".$max_loca." location. Please contact scanflip sales team if you wish to increase number of locations for your account.";
		$json_array['message'] = "At present you can only add ".$max_loca." location.<br /> Please contact Scanflip sales team if you wish to increase number of locations for your account.";
	$json = json_encode($json_array);
		echo $json;
		exit();
      }
}
/* end max number of location */

/******** 
@USE : to edit location
@PARAMETER : id,country,city,state,zip,address,email,hdn_image_path,mobile_country_code,mobileno_area_code,mobileno2,mobileno,businessname,location_name,pricerange,chk_parking,website,facebook,google,hdnlc1,hdn_more_images,monhdn,tuehdn,wedhdn,thuhdn,frihdn,sathdn,sunhdn,
@RETURN : json data
@USED IN PAGES : edit-location.php
*********/
if(isset($_REQUEST['btnEditLocation'])){
	/*
		echo "<pre>";
		print_r($_POST);
		echo "</pre>";
		exit();
	*/
	$array = $where_clause = $json_array = array();
	
         /*  start of PAY-508-28033  */
        
        
	if($_REQUEST['hdn_image_path'] == "")
	{
		
		$array['picture'] = "";
	}	
	
	else
	{
		
		$array['picture'] = $_REQUEST['hdn_image_path'];	
	}
	/*  end of PAY-508-28033  */
        
         /* Image Upload Task*/
       //delete image code
        $array_remove_images_more = $where_remove_clause_images  = array();
        if(isset($_REQUEST['hdn_remove_more']))
        {
			$hdn_images_more=$_REQUEST['hdn_remove_more'];
		}
		else
		{
			$hdn_images_more=0;
		}
         for($i=0;$i<count($hdn_images_more);$i++)
         {
             $array_images_more['location_id']=$_REQUEST['id'];
             $array_images_more['main_image']=$hdn_images_more[$i];
             
             /*$sql="DELETE from location_images where location_id='". $_REQUEST['id']."' and main_image='".$hdn_images_more[$i]."'";

                $objDB->execute_query($sql);*/
		$objDBWrt->Conn->Execute("DELETE from location_images where location_id=? and main_image=?",array($_REQUEST['id'],$hdn_images_more[$i]));
            unlink(UPLOAD_IMG."/m/location/".$hdn_images_more[$i]);
            unlink(UPLOAD_IMG."/m/location/thumb/".$hdn_images_more[$i]);    
         }
        //end delete code
        $array_images_more = $where_clause_images  = array();
        $hdn_images=$_REQUEST['hdn_more_images'];
       
        
        /* $sql="select * from location_images where location_id=".$_REQUEST['id']."";
            
         $RS_images = $objDB->execute_query($sql);*/
	$RS_images = $objDB->Conn->Execute("select * from location_images where location_id=?",array($_REQUEST['id']));

         /*$sql="DELETE from location_images where location_id='". $_REQUEST['id']."'";
         $objDB->execute_query($sql);*/
	$objDBWrt->Conn->Execute("DELETE from location_images where location_id=?",array($_REQUEST['id']));

       $image_postion=1;
       for($i=0;$i<count($hdn_images);$i++)
        {
            
            
                $array_images_more['location_id']=$_REQUEST['id'];
                $array_images_more['main_image']=$hdn_images[$i];
                $array_images_more['image_id']=$i;
                
                $where_clause_images['location_id'] = $_REQUEST['id'];
                $where_clause_images['image_id'] = $i;
            
                 $objDBWrt->Insert($array_images_more, "location_images");
                 copy(UPLOAD_IMG.'/m/location/temp_main/'.$hdn_images[$i],UPLOAD_IMG.'/m/location/'.$hdn_images[$i]);
            copy(UPLOAD_IMG.'/m/location/temp_thumb/'.$hdn_images[$i],UPLOAD_IMG.'/m/location/thumb/'.$hdn_images[$i] );
                 
            unlink(UPLOAD_IMG."/m/location/temp_main/".$hdn_images[$i]);
            unlink(UPLOAD_IMG."/m/location/temp_thumb/".$hdn_images[$i]);
            
        }
        
        /* End Image Upload Task*/
        /*** get real data of location before edit *****/
		$old_location_where = array();
		$old_location_where['id']  = $_REQUEST['id'];
		$RS_old_location_data = $objDB->Show("locations",$old_location_where);
		
	$string_address = $_REQUEST['address'].", ".$_REQUEST['city'].", ".$_REQUEST['state'].", ".$_REQUEST['zip'];
	
	$string_address = urlencode($string_address);
	
	$geocode= file_get_contents("https://maps.googleapis.com/maps/api/geocode/json?address=".$string_address."&sensor=false");
	
	$geojson= json_decode($geocode,true);
	if($geojson['status']=='OK'){
		$array['latitude'] = $geojson['results'][0]['geometry']['location']['lat'];
		$array['longitude'] = $geojson['results'][0]['geometry']['location']['lng'];
		
		/***** if latitude and longitude change then change tizone data of location *****/
		if($RS_old_location_data->fields['latitude'] != $array['latitude'] && $RS_old_location_data->fields['longitude'] != $array['longitude'])
		{
			/****** get location timezone information from lattitude and longitude *********/
			 $geocode= file_get_contents("http://api.timezonedb.com/?lat=".$array['latitude']."&lng=".$array['longitude']."&key=V5R3I13VWW28&format=json");
			$geojson_timezone= json_decode($geocode,true);	
			
			if($geojson_timezone['dst'] == 1)
			{
				$timezone_name = $geojson_timezone['zoneName'];
				$zonehouroffset = timezone_offsethour_string($geojson_timezone['gmtOffset']).",0";
				
			}
			else
			{
				$timezone_name = $geojson_timezone['zoneName'];
				$zonehouroffset = getStandardOffsetUTC($geojson_timezone['zoneName'],$geojson_timezone['gmtOffset']).",0";
				
			}
			
			$array['is_dst'] = $geojson_timezone['dst'];
			 $array['timezone'] = $zonehouroffset;
			  $array['timezone_name'] = $timezone_name;
			 
			/****** get location timezone information from lattitude and longitude *********/	
		}
		$endpoint = "https://maps.google.com/cbk?output=json&hl=en&ll=".$array['latitude'].",".$array['longitude'];
	
		$handler = curl_init();
		curl_setopt($handler, CURLOPT_HEADER, 0);
		curl_setopt($handler, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($handler, CURLOPT_URL, $endpoint);
		$data = curl_exec($handler);
		curl_close($handler);
	
		// if data value is an empty json document ('{}') , the panorama is not available for that point
		if ($data==='{}') 
		{
			//print "StreetView Panorama isn't available for the selected location";
			unlink(UPLOAD_IMG."/m/location/street_".$_REQUEST['id'].".jpeg");
			unlink(UPLOAD_IMG."/m/location/thumb/street_".$_REQUEST['id'].".jpeg");
		}
		else
		{
			$image_path_main=UPLOAD_IMG."/m/location/";
			
			$street_main_image = file_get_contents('https://maps.googleapis.com/maps/api/streetview?size=400x310&location='.$array['latitude'].",".$array['longitude'].'&sensor=false'); 
			$fp  = fopen($image_path_main.'street_'.$_REQUEST['id'].'.jpeg', 'w+');
			fputs($fp, $street_main_image);
			
			$image = new SimpleImage();
			$image->load($image_path_main.'street_'.$_REQUEST['id'].'.jpeg');
			$image->resize(70,70);
			$image->save($image_path_main.'thumb/street_'.$_REQUEST['id'].'.jpeg');	
		}
	
	}
	$array['email'] = $_REQUEST['email'];
	if($_REQUEST['location_name'] == "")
	{
			$b = $_REQUEST['businessname'];
	        $array['location_name'] = ucwords(strtolower($_REQUEST['businessname'])) ;
	}
	else
	{
		$b = $_REQUEST['location_name'];
		$array['location_name'] = ucwords(strtolower($_REQUEST['location_name'])) ;
	}
	if(isset($_POST['chk_payment_method']))
	{
		$payment_method="";
		foreach($_POST['chk_payment_method'] as $payment_method1)
		{
			$payment_method.=$payment_method1.",";
		}
		$payment_method=substr($payment_method, 0, -1);
		$array['payment_method'] = $payment_method;
	}
	else
	{
		$array['payment_method'] = "";
	}
	if(isset($_POST['services']))
	{         
		$array['services'] = $_POST['services'];         
	}
	if(isset($_POST['amenities']))
	{         
		$array['amenities'] = $_POST['amenities'];         
	}
	if(isset($_POST['restrictions']))
	{         
		$array['restrictions'] = $_POST['restrictions'];         
	}
	if(isset($_POST['rdo_google_street']))
	{	               		
		$array['display_google_street_view_image'] = $_POST['rdo_google_street'];			
	} 
	if(isset($_POST['pricerange']))
	{
		$pricerange=$_POST['pricerange'];
		$array['pricerange'] =$pricerange;
	}
	if(isset($_POST['chk_parking']))
	{
		$parking="";
		foreach($_POST['chk_parking'] as $parking1)
		{
			$parking.=$parking1.",";
		}
		$parking=substr($parking, 0, -1);
		$array['parking'] = $parking;
	}
	
	$array['modified_by'] = $_SESSION['merchant_id'];
	$array['address'] = ucwords(strtolower($_REQUEST['address']));
	$array['city'] = ucwords(strtolower($_REQUEST['city']));
	$array['state'] = $_REQUEST['state'];
	$array['zip'] = strtoupper($_REQUEST['zip']);
        
        //Website Code
		if($_REQUEST['website']!="")
		{		
			$website_array = explode("/",$_REQUEST['website']);
			
			if($website_array[0] == "http:" || $website_array[0] == "https:")
			{
				
				$array['website'] = $_REQUEST['website'];
			}
			else
			{
			   $array['website'] = "http://".$_REQUEST['website'];
			}
                }
                else
                {
                    $array['website'] = $_REQUEST['website'];
                }
		if($_REQUEST['facebook']!="")
		{        
			 $facebook_array = explode("/",$_REQUEST['facebook']);
			if($facebook_array[0] == "http:" || $facebook_array[0] == "https:")
			{
				$array['facebook'] = $_REQUEST['facebook'];
				
			}
			else
			{
			  $array['facebook'] = "http://".$_REQUEST['facebook'];
			}
		}
                else
                {
                    $array['facebook'] = $_REQUEST['facebook'];
                }
        if($_REQUEST['google']!="")
		{
			$google_array = explode("/",$_REQUEST['google']);
			if($google_array[0] == "http:" || $google_array[0] == "https:")
			{
				$array['google'] = $_REQUEST['google'];
				
			}
			else
			{
			  $array['google'] = "http://".$_REQUEST['google'];
			}
		}
                else
                {
                  $array['google'] = $_REQUEST['google'];  
                }
        // end of website code
        
	//$array['country'] = $_REQUEST['country'];
	$array['country'] = $_SESSION['merchant_info']['country'];
        
	$mobile_no=$_REQUEST['mobile_country_code']."-".$_REQUEST['mobileno_area_code']."-".$_REQUEST['mobileno2']."-".$_REQUEST['mobileno'];
	$array['phone_number']=$mobile_no;

	$array['modified_date'] = date("Y-m-d H:i:s");
	
            // 4/4/2013
        
	if(isset($_REQUEST['created_by']) == ""){
		$where_clause['created_by'] = $_SESSION['merchant_id'];
	}else{
		$where_clause['created_by'] = get_merchant_session_id($_REQUEST['created_by']);
	}
	$where_clause['id'] = $_REQUEST['id'];
       
	$array_hours = $where_clause_hours  = array();
        /* */
		/*$sql_qw = "select * from locations where id=".$_REQUEST['id'];
		$RS_qw = $objDB->execute_query($sql_qw);*/
		$RS_qw = $objDB->Conn->Execute("select * from locations where id=?",array($_REQUEST['id']));
		
				$permalink_url = $objJSON->create_location_url($_REQUEST['id'],$b,$_REQUEST['city']);
			$array['location_permalink'] = $permalink_url;
		
		
	$location_categories=array();
		if($_POST['hdnlc1'])
		{
			array_push($location_categories,$_POST['hdnlc1']);
		}
		if($_POST['hdnlc2'])
		{
			array_push($location_categories,$_POST['hdnlc2']);
		}
		if($_POST['hdnlc3'])
		{
			array_push($location_categories,$_POST['hdnlc3']);
		}
		
		$array['categories']=implode(",",$location_categories);
		
	$objDBWrt->Update($array, "locations", $where_clause);
        
          /* Add Hours Code */
        if(strlen($_REQUEST['monhdn'])<=1)
        {  
        }
        else
        {
            $array_monhdn=explode("-",$_REQUEST['monhdn']);
            $location_id=$_REQUEST['id'];
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$location_id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $where_clause_hours['location_id'] = $_REQUEST['id'];
            $where_clause_hours['day'] = $day;
            /*$sql="select * from location_hours where location_id=".$location_id." and day='".$day."'";
            
            $RS_hours = $objDB->execute_query($sql);*/
		$RS_hours = $objDB->Conn->Execute("select * from location_hours where location_id=? and day=?",array($location_id,$day));
            
            if($RS_hours->RecordCount()>0){
                $objDBWrt->Update($array_hours, "location_hours", $where_clause_hours);
            }
            else
            {
                $objDBWrt->Insert($array_hours, "location_hours");
            }
            
            
        }
        
        if(strlen($_REQUEST['tuehdn'])<=1)
        {  
        }
        else
        {
            $array_monhdn=explode("-",$_REQUEST['tuehdn']);
            $location_id=$_REQUEST['id'];
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$location_id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $where_clause_hours['location_id'] = $_REQUEST['id'];
            $where_clause_hours['day'] = $day;
            
            /*$sql="select * from location_hours where location_id=".$location_id." and day='".$day."'";
            
            $RS_hours = $objDB->execute_query($sql);*/
		$RS_hours = $objDB->Conn->Execute("select * from location_hours where location_id=? and day=?",array($location_id,$day));
            
            if($RS_hours->RecordCount()>0){
                $objDBWrt->Update($array_hours, "location_hours", $where_clause_hours);
            }
            else
            {
                $objDBWrt->Insert($array_hours, "location_hours");
            }
            
        }
        
       if(strlen($_REQUEST['wedhdn'])<=1)
        {  
        }
        else
        {
            $array_monhdn=explode("-",$_REQUEST['wedhdn']);
            $location_id=$_REQUEST['id'];
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$location_id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $where_clause_hours['location_id'] = $_REQUEST['id'];
            $where_clause_hours['day'] = $day;
            
             /*$sql="select * from location_hours where location_id=".$location_id." and day='".$day."'";
            
            $RS_hours = $objDB->execute_query($sql);*/
	$RS_hours = $objDB->Conn->Execute("select * from location_hours where location_id=? and day=?",array($location_id,$day));
            
            if($RS_hours->RecordCount()>0){
                $objDBWrt->Update($array_hours, "location_hours", $where_clause_hours);
            }
            else
            {
                $objDBWrt->Insert($array_hours, "location_hours");
            }
            
        }
        
        if(strlen($_REQUEST['thuhdn'])<=1)
        {  
        }
        else
        {
            $array_monhdn=explode("-",$_REQUEST['thuhdn']);
            $location_id=$_REQUEST['id'];
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$location_id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $where_clause_hours['location_id'] = $_REQUEST['id'];
            $where_clause_hours['day'] = $day;
            
             /*$sql="select * from location_hours where location_id=".$location_id." and day='".$day."'";
            
            $RS_hours = $objDB->execute_query($sql);*/
		$RS_hours = $objDB->Conn->Execute("select * from location_hours where location_id=? and day=?",array($location_id,$day));
            
            if($RS_hours->RecordCount()>0){
                $objDBWrt->Update($array_hours, "location_hours", $where_clause_hours);
            }
            else
            {
                $objDBWrt->Insert($array_hours, "location_hours");
            }
            
        }
        
        if(strlen($_REQUEST['frihdn'])<=1)
        {  
        }
        else
        {
            $array_monhdn=explode("-",$_REQUEST['frihdn']);
            $location_id=$_REQUEST['id'];
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$location_id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $where_clause_hours['location_id'] = $_REQUEST['id'];
            $where_clause_hours['day'] = $day;
            
             /*$sql="select * from location_hours where location_id=".$location_id." and day='".$day."'";
            
            $RS_hours = $objDB->execute_query($sql);*/
		$RS_hours = $objDB->Conn->Execute("select * from location_hours where location_id=? and day=?",array($location_id,$day));
            
            if($RS_hours->RecordCount()>0){
                $objDBWrt->Update($array_hours, "location_hours", $where_clause_hours);
            }
            else
            {
                $objDBWrt->Insert($array_hours, "location_hours");
            }
            
        }
        
         if(strlen($_REQUEST['sathdn'])<=1)
        {  
        }
        else
        {
            $array_monhdn=explode("-",$_REQUEST['sathdn']);
            $location_id=$_REQUEST['id'];
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$location_id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $where_clause_hours['location_id'] = $_REQUEST['id'];
            $where_clause_hours['day'] = $day;
            
             /*$sql="select * from location_hours where location_id=".$location_id." and day='".$day."'";
            
            $RS_hours = $objDB->execute_query($sql);*/
		$RS_hours = $objDB->Conn->Execute("select * from location_hours where location_id=? and day=?",array($location_id,$day));
            
            if($RS_hours->RecordCount()>0){
                $objDBWrt->Update($array_hours, "location_hours", $where_clause_hours);
            }
            else
            {
                $objDBWrt->Insert($array_hours, "location_hours");
            }
            
        }
        
        if(strlen($_REQUEST['sunhdn'])<=1)
        {  
        }
        else
        {
            $array_monhdn=explode("-",$_REQUEST['sunhdn']);
            $location_id=$_REQUEST['id'];
            $day= $array_monhdn[0];
            $starttime=$array_monhdn[1];
            $endtime=$array_monhdn[2];
            
            $array_hours['location_id']=$location_id;
            $array_hours['day']=$day;
            $array_hours['start_time']=strtoupper($starttime);
            $array_hours['end_time']=strtoupper($endtime);
            
            $where_clause_hours['location_id'] = $_REQUEST['id'];
            $where_clause_hours['day'] = $day;
            
             /*$sql="select * from location_hours where location_id=".$location_id." and day='".$day."'";
            
            $RS_hours = $objDB->execute_query($sql);*/
		$RS_hours = $objDB->Conn->Execute("select * from location_hours where location_id=? and day=?",array($location_id,$day));
            
            if($RS_hours->RecordCount()>0){
                $objDBWrt->Update($array_hours, "location_hours", $where_clause_hours);
            }
            else
            {
                $objDBWrt->Insert($array_hours, "location_hours");
            }
            
        }   
        
        $where_clause_hours_remove=array();
        if(isset($_REQUEST['remove_mon']))
        {
			if($_REQUEST['remove_mon']=="mon")
			{     
				$where_clause_hours_remove['location_id']=$_REQUEST['id'];
				$where_clause_hours_remove['day']=$_REQUEST['remove_mon'];
				/*$sql="DELETE from location_hours where location_id='". $_REQUEST['id']."' and day='".$_REQUEST['remove_mon']."'";
				$objDB->execute_query($sql);*/
				$objDBWrt->Conn->Execute("DELETE from location_hours where location_id=? and day=?",array($_REQUEST['id'],$_REQUEST['remove_mon']));
			}
		}
        if(isset($_REQUEST['remove_tue']))
        {
			if($_REQUEST['remove_tue']=="tue")
			{     
				$where_clause_hours_remove['location_id']=$_REQUEST['id'];
				$where_clause_hours_remove['day']=$_REQUEST['remove_tue'];
				/* $sql="DELETE from location_hours where location_id='". $_REQUEST['id']."' and day='".$_REQUEST['remove_tue']."'";
				$objDB->execute_query($sql);*/
				$objDBWrt->Conn->Execute("DELETE from location_hours where location_id=? and day=?",array($_REQUEST['id'],$_REQUEST['remove_tue']));
			 }
		}
		if(isset($_REQUEST['remove_wed']))
        {
			if($_REQUEST['remove_wed']=="wed")
			{     
				$where_clause_hours_remove['location_id']=$_REQUEST['id'];
				$where_clause_hours_remove['day']=$_REQUEST['remove_wed'];
				/* $sql="DELETE from location_hours where location_id='". $_REQUEST['id']."' and day='".$_REQUEST['remove_wed']."'";
				$objDB->execute_query($sql);*/
				$objDBWrt->Conn->Execute("DELETE from location_hours where location_id=? and day=?",array($_REQUEST['id'],$_REQUEST['remove_wed']));
			}
		}
		if(isset($_REQUEST['remove_thu']))
        {
			if($_REQUEST['remove_thu']=="thu")
			{     
				$where_clause_hours_remove['location_id']=$_REQUEST['id'];
				$where_clause_hours_remove['day']=$_REQUEST['remove_thu'];
				/*$sql="DELETE from location_hours where location_id='". $_REQUEST['id']."' and day='".$_REQUEST['remove_thu']."'";
				$objDB->execute_query($sql);*/
				$objDBWrt->Conn->Execute("DELETE from location_hours where location_id=? and day=?",array($_REQUEST['id'],$_REQUEST['remove_thu']));
			}
		}
		if(isset($_REQUEST['remove_fri']))
        {
			if($_REQUEST['remove_fri']=="fri")
			{     
				$where_clause_hours_remove['location_id']=$_REQUEST['id'];
				$where_clause_hours_remove['day']=$_REQUEST['remove_fri'];
				/*$sql="DELETE from location_hours where location_id='". $_REQUEST['id']."' and day='".$_REQUEST['remove_fri']."'";
				$objDB->execute_query($sql);*/
				$objDBWrt->Conn->Execute("DELETE from location_hours where location_id=? and day=?",array($_REQUEST['id'],$_REQUEST['remove_fri']));
			}
		}
		if(isset($_REQUEST['remove_sat']))
        {
			if($_REQUEST['remove_sat']=="sat")
			{     
				$where_clause_hours_remove['location_id']=$_REQUEST['id'];
				$where_clause_hours_remove['day']=$_REQUEST['remove_sat'];
				/*$sql="DELETE from location_hours where location_id='". $_REQUEST['id']."' and day='".$_REQUEST['remove_sat']."'";
				$objDB->execute_query($sql);*/
				$objDBWrt->Conn->Execute("DELETE from location_hours where location_id=? and day=?",array($_REQUEST['id'],$_REQUEST['remove_sat']));
			}
		}
		if(isset($_REQUEST['remove_sun']))
        {
			if($_REQUEST['remove_sun']=="sun")
			{     
				$where_clause_hours_remove['location_id']=$_REQUEST['id'];
				$where_clause_hours_remove['day']=$_REQUEST['remove_sun'];
				/*$sql="DELETE from location_hours where location_id='". $_REQUEST['id']."' and day='".$_REQUEST['remove_sun']."'";
				$objDB->execute_query($sql);*/
				$objDBWrt->Conn->Execute("DELETE from location_hours where location_id=? and day=?",array($_REQUEST['id'],$_REQUEST['remove_sun']));
			}
        }
        
        /* End of Add Hours Code */
           
	$json_array['status'] = "true";
	$json_array['message'] = $merchant_msg['addlocation']['Msg_location_edited'];
	$json = json_encode($json_array);
	// 369
	$_SESSION['msg'] = $merchant_msg['addlocation']['Msg_location_edited'];
	$json_array=array();
	$json_array['status']='true';
	$json_array['message']= $merchant_msg['addlocation']['Msg_location_edited'];
	$json = json_encode($json_array);
	echo $json;
    exit();
	// 369
}

/******** 
@USE : to add location detail
@PARAMETER : chk_location,chk_dining,price_min,price_max,chk_ambience,chk_attire,chk_goodfor,chk_payment_method,chk_parking,rdo_pet,rdo_wheelchair,rdo_wifi,rdo_tv,rdo_airconditioned,rdo_smoking,chk_alcohol,rdo_noiselevel,minimum_age,rdo_will_deliver,delivery_from,delivery_to,rdo_caters,hdnlc1
@RETURN : json data
@USED IN PAGES : add-location-detail.php
*********/

if(isset($_REQUEST['btnAddLocationDetail'])){
	
	foreach($_POST['chk_location'] as $lid)
	{
		$array = $where_clause = $json_array = array();
		
		if(isset($_POST['chk_dining']))
		{
			$dining="";
			foreach($_POST['chk_dining'] as $dining1)
			{
				$dining.=$dining1.",";
			}
			$dining=substr($dining, 0, -1);
			$array['dining'] = $dining;
		}
		if(isset($_POST['price_min']))
		{
			$pricerange_min=$_POST['price_min'];
			$array['pricerange_min'] =$pricerange_min;
		}
		if(isset($_POST['price_max']))
		{
			$pricerange_max=$_POST['price_max'];
			$array['pricerange_max'] = $pricerange_max;
		}
		if(isset($_POST['chk_ambience']))
		{
			$ambience="";
			foreach($_POST['chk_ambience'] as $ambience1)
			{
				$ambience.=$ambience1.",";
			}
			$ambience=substr($ambience, 0, -1);
			$array['ambience'] = $ambience;
		}
		if(isset($_POST['chk_attire']))
		{
			$attire="";
			foreach($_POST['chk_attire'] as $attire1)
			{
				$attire.=$attire1.",";
			}
			$attire=substr($attire, 0, -1);
			$array['attire'] = $attire;
		}
		if(isset($_POST['chk_goodfor']))
		{
			$good_for="";
			foreach($_POST['chk_goodfor'] as $good_for1)
			{
				$good_for.=$good_for1.",";
			}
			$good_for=substr($good_for, 0, -1);
			$array['good_for'] = $good_for;
		}
		if(isset($_POST['chk_payment_method']))
		{
			$payment_method="";
			foreach($_POST['chk_payment_method'] as $payment_method1)
			{
				$payment_method.=$payment_method1.",";
			}
			$payment_method=substr($payment_method, 0, -1);
			$array['payment_method'] = $payment_method;
		}
		if(isset($_POST['chk_parking']))
		{
			$parking="";
			foreach($_POST['chk_parking'] as $parking1)
			{
				$parking.=$parking1.",";
			}
			$parking=substr($parking, 0, -1);
			$array['parking'] = $parking;
		}
		if(isset($_POST['rdo_pet']))
		{
                        if($_POST['rdo_pet']!="Not Applicable")
                        {
                            $array['pet'] = $_POST['rdo_pet'];
                        }
                        else
                        {
                            $array['pet'] = "";
                        }
		}
		if(isset($_POST['rdo_wheelchair']))
		{
                    if($_POST['rdo_wheelchair']!="Not Applicable")
                        {
			$array['wheelchair'] = $_POST['rdo_wheelchair'];
                        }
                        else
                        {
                            $array['wheelchair'] = "";
                        } 
		}
		if(isset($_POST['rdo_wifi']))
		{
                     if($_POST['rdo_wifi']!="Not Applicable")
                        {
			$array['wifi'] = $_POST['rdo_wifi'];
                        }
                        else
                        {
                         $array['wifi'] = "";
                        }
		}
		if(isset($_POST['rdo_tv']))
		{
                    if($_POST['rdo_tv']!="Not Applicable")
                        {
			$array['has_tv'] = $_POST['rdo_tv'];
                        }
                        else
                        {
                         $array['has_tv'] = "";
                        }
		}
		if(isset($_POST['rdo_airconditioned']))
		{
                    if($_POST['rdo_airconditioned']!="Not Applicable")
                        {
			$array['airconditioned'] = $_POST['rdo_airconditioned'];
                        }
                        else
                        {
                         $array['airconditioned'] = "";  
                        }
		}
		if(isset($_POST['rdo_smoking']))
		{
                    if($_POST['rdo_smoking']!="Not Applicable")
                        {
			$array['smoking'] = $_POST['rdo_smoking'];
                        }
                        else
                        {
                         $array['smoking'] = "";
                        }
		}
		if(isset($_POST['chk_alcohol']))
		{
			$alcohol="";
			foreach($_POST['chk_alcohol'] as $alcohol1)
			{
				$alcohol.=$alcohol1.",";
			}
			$alcohol=substr($alcohol, 0, -1);
			$array['alcohol'] = $alcohol;
		}
		if(isset($_POST['rdo_noiselevel']))
		{
                    if($_POST['rdo_noiselevel']!="Not Applicable")
                        {
                        $array['noise_level'] = $_POST['rdo_noiselevel'];
                        }
                        else
                        {
                          $array['noise_level'] = "";   
                        }
			
		}
		if(isset($_POST['minimum_age']))
		{
			$array['minimum_age'] = $_POST['minimum_age'];
		}
		
		if(isset($_POST['rdo_will_deliver']))
		{
			$array['will_deliver'] = $_POST['rdo_will_deliver'];
			if($_POST['rdo_will_deliver']=="Yes")
			{
				$array['deliveryarea_from']=$_POST['delivery_from'];
				$array['deliveryarea_to']=$_POST['delivery_to'];
			}
			if(isset($_POST['minimum_order']))
			{
				$array['minimum_order']=$_POST['minimum_order'];
			}
                        if($_POST['rdo_will_deliver']!="Not Applicable")
                        {
                            $array['will_deliver'] = "";
                        }
		}
		if(isset($_POST['rdo_caters']))
		{
                    if($_POST['rdo_caters']!="Not Applicable")
                    {
			$array['caters'] = $_POST['rdo_caters'];
                    }
                    else
                    {
                        $array['caters'] = "";
                    }
		}
		
		$location_categories=array();
		if($_POST['hdnlc1'])
		{
			array_push($location_categories,$_POST['hdnlc1']);
		}
		if($_POST['hdnlc2'])
		{
			array_push($location_categories,$_POST['hdnlc2']);
		}
		if($_POST['hdnlc3'])
		{
			array_push($location_categories,$_POST['hdnlc3']);
		}
		
		$array['categories']=implode(",",$location_categories);
			
		$array['modified_by'] = $_SESSION['merchant_id'];
		
		$where_clause['id'] = $lid;
		$where_clause['created_by'] = $_SESSION['merchant_id'];
		
		$objDBWrt->Update($array, "locations", $where_clause);
	}
	
                       
	// 369
	$_SESSION['msg'] = $merchant_msg['addlocationdetail']['Msg_location_detail_added'];
	$json_array=array();
	$json_array['status']='true';
	$json_array['message']= $merchant_msg['addlocationdetail']['Msg_location_detail_added'];
	$json = json_encode($json_array);
	header("Location:".WEB_PATH."/merchant/locations.php");
	echo $json;
    exit();
	// 369
}


/******** 
@USE : to edit location detail
@PARAMETER : hdn_location_id,chk_location,chk_dining,price_min,price_max,chk_ambience,chk_attire,chk_goodfor,chk_payment_method,chk_parking,rdo_pet,rdo_wheelchair,rdo_wifi,rdo_tv,rdo_airconditioned,rdo_smoking,chk_alcohol,rdo_noiselevel,minimum_age,rdo_will_deliver,delivery_from,delivery_to,rdo_caters,hdnlc1
@RETURN : json data
@USED IN PAGES : edit-location-detail.php
*********/
if(isset($_REQUEST['btnEditLocationDetail'])){

		$lid=$_REQUEST['hdn_location_id'];
		
		$array = $where_clause = $json_array = array();
		
		if(isset($_POST['chk_dining']))
		{
			$dining="";
			foreach($_POST['chk_dining'] as $dining1)
			{
				$dining.=$dining1.",";
			}
			$dining=substr($dining, 0, -1);
			$array['dining'] = $dining;
		}
		else
		{
			$array['dining'] = "";
		}
		
		if(isset($_POST['rdo_reservation']))
		{
            
			if($_POST['rdo_reservation']!="Not Applicable")
                    {
			$array['reservation'] = $_POST['rdo_reservation'];
                    }
                    else
                    {
                        $array['reservation'] = "";
                    }	
		}
		
		if(isset($_POST['rdo_takeout']))
		{
            
			if($_POST['rdo_takeout']!="Not Applicable")
                    {
			$array['takeout'] = $_POST['rdo_takeout'];
                    }
                    else
                    {
                        $array['takeout'] = "";
                    }			
		}
		
		if(isset($_POST['chk_ambience']))
		{
			$ambience="";
			foreach($_POST['chk_ambience'] as $ambience1)
			{
				$ambience.=$ambience1.",";
			}
			$ambience=substr($ambience, 0, -1);
			$array['ambience'] = $ambience;
		}
		else
		{
			$array['ambience'] = "";
		}
		
		if(isset($_POST['chk_attire']))
		{
			$attire="";
			foreach($_POST['chk_attire'] as $attire1)
			{
				$attire.=$attire1.",";
			}
			$attire=substr($attire, 0, -1);
			$array['attire'] = $attire;
		}
		else
		{
			$array['attire'] = "";
		}
		
		if(isset($_POST['chk_goodfor']))
		{
			$good_for="";
			foreach($_POST['chk_goodfor'] as $good_for1)
			{
				$good_for.=$good_for1.",";
			}
			$good_for=substr($good_for, 0, -1);
			$array['good_for'] = $good_for;
		}
		else
		{
			$array['good_for'] = "";
		}
		
		if(isset($_POST['chk_payment_method']))
		{
			$payment_method="";
			foreach($_POST['chk_payment_method'] as $payment_method1)
			{
				$payment_method.=$payment_method1.",";
			}
			$payment_method=substr($payment_method, 0, -1);
			$array['payment_method'] = $payment_method;
		}
		else
		{
			$array['payment_method'] = "";
		}
		
		
		if(isset($_POST['rdo_pet']))
		{
			
			if($_POST['rdo_pet']!="Not Applicable")
                        {
                            $array['pet'] = $_POST['rdo_pet'];
                        }
                        else
                        {
                            $array['pet'] = "";
                        }
		}
		if(isset($_POST['rdo_wheelchair']))
		{
			 if($_POST['rdo_wheelchair']!="Not Applicable")
                        {
			$array['wheelchair'] = $_POST['rdo_wheelchair'];
                        }
                        else
                        {
                            $array['wheelchair'] = "";
                        } 
		}
		if(isset($_POST['rdo_wifi']))
		{
			 if($_POST['rdo_wifi']!="Not Applicable")
                        {
			$array['wifi'] = $_POST['rdo_wifi'];
                        }
                        else
                        {
                         $array['wifi'] = "";
                        }
		}
		if(isset($_POST['rdo_tv']))
		{
			if($_POST['rdo_tv']!="Not Applicable")
                        {
			$array['has_tv'] = $_POST['rdo_tv'];
                        }
                        else
                        {
                         $array['has_tv'] = "";
                        }
		}
		if(isset($_POST['rdo_airconditioned']))
		{      
			 if($_POST['rdo_airconditioned']!="Not Applicable")
                        {
			$array['airconditioned'] = $_POST['rdo_airconditioned'];
                        }
                        else
                        {
                         $array['airconditioned'] = "";  
                        }	
		}
		if(isset($_POST['rdo_smoking']))
		{                     
			 if($_POST['rdo_smoking']!="Not Applicable")
                        {
			$array['smoking'] = $_POST['rdo_smoking'];
                        }
                        else
                        {
                         $array['smoking'] = "";
                        }
		}
		if(isset($_POST['rdo_alcohol']))
		{	
			if($_POST['rdo_alcohol']!="Not Applicable")
                        {
                        $array['alcohol'] = $_POST['rdo_alcohol'];
                        }
                        else
                        {
                          $array['alcohol'] = "";   
                        }	
		}
		if(isset($_POST['rdo_noiselevel']))
		{          
			 if($_POST['rdo_noiselevel']!="Not Applicable")
                        {
                        $array['noise_level'] = $_POST['rdo_noiselevel'];
                        }
                        else
                        {
                          $array['noise_level'] = "";   
                        }
		}
		if(isset($_POST['minimum_age']))
		{
			$array['minimum_age'] = $_POST['minimum_age'];
		}
		
		if(isset($_POST['rdo_will_deliver']))
		{
			$array['will_deliver'] = $_POST['rdo_will_deliver'];
			if($_POST['rdo_will_deliver']=="Yes")
			{
				$array['deliveryarea_from']=strtoupper($_POST['delivery_from']);
				$array['deliveryarea_to']=strtoupper($_POST['delivery_to']);
			}
			if(isset($_POST['minimum_order']))
			{
				$array['minimum_order']=$_POST['minimum_order'];
			} 
			if($_POST['rdo_will_deliver']!="Not Applicable")
                        {
                            $array['will_deliver'] = $_POST['rdo_will_deliver'];
                        }
						else
						{
							$array['will_deliver'] = "";
						}						
		}
		if(isset($_POST['rdo_caters']))
		{
			if($_POST['rdo_caters']!="Not Applicable")
                    {
			$array['caters'] = $_POST['rdo_caters'];
                    }
                    else
                    {
                        $array['caters'] = "";
                    }
		}
		if(isset($_POST['services']))
		{         
			$array['services'] = $_POST['services'];         
		}
		if(isset($_POST['amenities']))
		{         
			$array['amenities'] = $_POST['amenities'];         
		}
		
		$array['modified_by'] = $_SESSION['merchant_id'];
		
		$where_clause['id'] = $lid;
		$where_clause['created_by'] = $_SESSION['merchant_id'];
		
		$objDBWrt->Update($array, "locations", $where_clause);
   
	// 369
	$_SESSION['msg'] = $merchant_msg['addlocationdetail']['Msg_location_detail_edited'];
	$json_array=array();
	$json_array['status']='true';
	$json_array['message']= $merchant_msg['addlocationdetail']['Msg_location_detail_edited'];
	$json = json_encode($json_array);
	header("Location:".WEB_PATH."/merchant/locations.php");
	echo $json;
    exit();
	// 369
}

/******** 
@USE : create campaign code (activation code)
@PARAMETER : campaign_id
@RETURN : code
@USED IN PAGES : process.php
*********/
function create_campaign_code($campaign_id)
{
    $code_length=8;
    $alfa = "123456789ABCDEFGHJKLMNOPQRSTU".$campaign_id."VWXYZ";
    $code="";
    for($i = 0; $i < $code_length; $i ++) 
    {
      $code .= $alfa[rand(0, strlen($alfa)-1)];
    } 
    return $code;
}

/******** 
@USE : create loyalty activation code
@PARAMETER : 
@RETURN : code
@USED IN PAGES : process.php
*********/
function create_loyalty_activation_code()
{
    $code_length=6;
    $alfa = "123456789ABCDEFGHJKLMNPQRSTUVWXYZ";
    $code="";
    for($i = 0; $i < $code_length; $i ++) 
    {
      $code .= $alfa[rand(0, strlen($alfa)-1)];
    } 
    return $code;
}

/******** 
@USE : to get location ids with image gallery
@PARAMETER : 
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['btnGetlocatioidwithgallery'])){
	$array_where_t = array();
	$RSTemplate = $objDB->Show("merchant_image_gallery",$array_where_t);
	$records = array();
	$count=0;
	$lids=array();
	while($Row = $RSTemplate->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      array_push($lids,$Row['location_id']);
	      $count++;
	}
	$json_array["records"]= $lids;
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	return $json;
}


/******** 
@USE : to get location image view gallery
@PARAMETER :
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['btngetlocationgalleryforviewgallery'])){
	$json_array = array();
	$html ="";
	$RS = $objDB->Conn->Execute("SELECT image from merchant_media mm,merchant_image_gallery_detail migd,merchant_image_gallery mig
								where migd.merchant_image_gallery_id=mig.id and mm.id = migd.merchant_media_id and mig.location_id =".$_REQUEST['location_id']);
								
	$RS1 = $objDB->Conn->Execute("SELECT thumbnail_url from merchant_videos mv,location_video_gallery_detail lvgd,location_video_gallery lvg
								where lvgd.location_video_gallery_id=lvg.id and mv.id = lvgd.merchant_videos_id and lvg.location_id =".$_REQUEST['location_id']);
								
	$html.='<div id="media-upload-header">
	<ul id="sidemenu">
		<li class="div_img" data-hashval="imgdiv" id="tab-type">
			<a class="current">Images</a>
		</li>
		<li class="div_vdo" data-hashval="vdodiv" id="tab-type">
			<a class="">Videos</a>
		</li>
	</ul>
	</div>';
	
	$html.='<div class="all_div_container">
				<div id="div_img" class="tabs" style="display: block;">
					<div id="mediya_image_container_popup" style="display:inline-block">';
						if($RS->RecordCount()>0)
						{
							while($Row = $RS->FetchRow())
							{
								$html.='<div class="mediya_img_blk locationfilter">';
									
									$html.='<img class="mediya_grid1" src="'.ASSETS_IMG.'/m/location/'.$Row['image'].'">';
									
								$html.='</div>';
							}
						}
						else
						{
							$html.='<div>No images available to display.</div>';
						}
		
			$html.='</div>
				</div>
				<div id="div_vdo" class="tabs" style="display: none;">
					<div id="mediya_video_container_popup" style="display:inline-block">';
						if($RS1->RecordCount()>0)
						{
							while($Row = $RS1->FetchRow())
							{
								$html.='<div class="mediya_img_blk locationfilter">';
									
									$html.='<img class="mediya_grid1" src="'.$Row['thumbnail_url'].'">';
									
								$html.='</div>';
							}
						}
						else
						{
							$html.='<div>No videos available to display.</div>';
						}
			$html.='</div>
				</div>
			</div>';							
	
	$json_array['status'] = "true";
	$json_array["html"]= $html;
	
	$json = json_encode($json_array);
	echo $json;
	return $json;							
}

/******** 
@USE : to get location image assign gallery
@PARAMETER :
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['btngetlocationgalleryforassigngallery'])){
	$json_array = array();
	$html ="";
	$RS = $objDB->Conn->Execute("SELECT mm.id,image from merchant_media mm,merchant_image_gallery_detail migd,merchant_image_gallery mig
								where migd.merchant_image_gallery_id=mig.id and mm.id = migd.merchant_media_id and mig.location_id =".$_REQUEST['location_id']);
	
	$RS1 = $objDB->Conn->Execute("SELECT mv.id,thumbnail_url from merchant_videos mv,location_video_gallery_detail lvgd,location_video_gallery lvg
								where lvgd.location_video_gallery_id=lvg.id and mv.id = lvgd.merchant_videos_id and lvg.location_id =".$_REQUEST['location_id']);
								
	$html.='<div id="media-upload-header">
	<ul id="sidemenu">
		<li class="div_img" data-hashval="imgdiv" id="tab-type">
			<a class="current">Images</a>
		</li>
		<li class="div_vdo" data-hashval="vdodiv" id="tab-type">
			<a class="">Videos</a>
		</li>
	</ul>
	</div>';
								
	$html.='<div class="all_div_container">
				<div id="div_img" class="tabs" style="display: block;">
					<div id="mediya_image_container_popup" style="display:inline-block">';						
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							$html.='<div class="mediya_img_blk locationfilter">';
								
								$html.='<img class="mediya_grid1" src="'.ASSETS_IMG.'/m/location/'.$Row['image'].'">';
								$html.='<img class="mediya_grid1_img_selected mediya_slctd" src="'.ASSETS_IMG.'/m/image_Added_to_lbry.png">';
								$html.='<a title="Select Image" href="javascript:void(0)" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediaselectunassigned_'.$Row['id'].'" class="mediya_select_pp">
														<img style="display: block;text-align: left;" src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
														<span>Select Image</span>
													</a>';
							$html.='</div>';
						}
					}
					else
					{
						$html.='<div>No images available to remove.</div>';
					}
		$html.='	</div>
				</div>
				<div id="div_vdo" class="tabs" style="display: none;">
					<div id="mediya_video_container_popup" style="display:inline-block">';
					if($RS1->RecordCount()>0)
					{
						while($Row = $RS1->FetchRow())
						{
							$html.='<div class="mediya_img_blk locationfilter">';
								
								$html.='<img class="mediya_grid1" src="'.$Row['thumbnail_url'].'">';
								$html.='<img class="mediya_grid1_img_selected mediya_slctd" src="'.ASSETS_IMG.'/m/image_Added_to_lbry.png">';
								$html.='<a title="Select Video" href="javascript:void(0)" id="mediaselectunassignedvideo_'.$Row['id'].'" class="mediya_select_pp">
														<img style="display: block;text-align: left;" src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
														<span>Select Video</span>
													</a>';
							$html.='</div>';
						}
					}
					else
					{
						$html.='<div>No videos available to remove.</div>';
					}
			$html.='</div>
				</div>
			</div>';
	
	$json_array['status'] = "true";
	$json_array["html"]= $html;
	
	$json = json_encode($json_array);
	echo $json;
	return $json;							
}

/******** 
@USE : to get location image assign gallery
@PARAMETER :
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['btngetlocationgalleryforunassigngallery'])){
	$json_array = array();
	$html ="";
	
	$arr_1=file(WEB_PATH.'/merchant/process.php?getmainmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);
		if(trim($arr_1[0]) == "")
		{
		 unset($arr_1[0]);
		 $arr_1 = array_values($arr_1);
		}
		$json_1 = json_decode($arr_1[0]);
		$main_merchant_id = $json_1->main_merchant_id;
		
	$arr=file(WEB_PATH.'/merchant/process.php?getallsubmercahnt_id=yes&mer_id='.$main_merchant_id);
		if(trim($arr[0]) == "")
		{
				unset($arr[0]);
				$arr = array_values($arr);
		}
		$json = json_decode($arr[0]);
		$ids= $json->all_sub_merchant_id;
		if($ids == "")
		  {
			  $ids =$_SESSION['merchant_id'];
		  }
	$arr=file(WEB_PATH.'/merchant/process.php?getallmainmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);
					 
	 if(trim($arr[0]) == "")
	 {
	  unset($arr[0]);
	  $arr = array_values($arr);
	 }
	 $json = json_decode($arr[0]);
			
	  $all_main_merchant_id= $json->all_main_merchant_id; 
	  
	  $all_main_mer_array = array ();
	  
	  if($all_main_merchant_id == "")
	  {
		  $all_main_merchant_id =$_SESSION['merchant_id'];
	  }
	  else
	  {
		  $all_main_mer_array=explode(",",$all_main_merchant_id);
	  }   
	
	$arr_id= array();
	$arr_id1= array();
	$RS = $objDB->Conn->Execute("SELECT mm.id,image from merchant_media mm,merchant_image_gallery_detail migd,merchant_image_gallery mig
								where migd.merchant_image_gallery_id=mig.id and mm.id = migd.merchant_media_id and mig.location_id =".$_REQUEST['location_id']);
	
	$RS1 = $objDB->Conn->Execute("SELECT mv.id,thumbnail_url from merchant_videos mv,location_video_gallery_detail lvgd,location_video_gallery lvg
								where lvgd.location_video_gallery_id=lvg.id and mv.id = lvgd.merchant_videos_id and lvg.location_id =".$_REQUEST['location_id']);
															
	//$html.='<div id="mediya_image_container_popup" style="display:inline-block">';							
	while($Row = $RS->FetchRow())
	{
		array_push($arr_id,$Row[id]);
	}
	while($Row = $RS1->FetchRow())
	{
		array_push($arr_id1,$Row[id]);
	}
	//echo "<pre>";
	//print_r($arr_id);
	//echo "</pre>";	  
	$query_l = "select * from merchant_media where media_type_id=2 and ( merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) or id in( select merchant_media_id from media_import_image where merchant_id=?) ) order by id desc " ; // with prepare query				
	$RS_l = $objDB->Conn->Execute($query_l,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id'],$_SESSION['merchant_id']));

	$query_l1 = "select * from merchant_videos where ( merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?)) order by id desc " ; // with prepare query				
	$RS_l1 = $objDB->Conn->Execute($query_l1,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id']));
		
	$html.='<div id="media-upload-header">
	<ul id="sidemenu">
		<li class="div_img" data-hashval="imgdiv" id="tab-type">
			<a class="current">Images</a>
		</li>
		<li class="div_vdo" data-hashval="vdodiv" id="tab-type">
			<a class="">Videos</a>
		</li>
	</ul>
	</div>';
	
	$html.='<div class="all_div_container">
				<div id="div_img" class="tabs" style="display: block;">
					<div id="mediya_image_container_popup" style="display:inline-block">';
					$remain_img_cnt=0;
					
					while($Row = $RS_l->FetchRow())
					{
						if(in_array($Row['id'], $arr_id))
						{
						}
						else
						{
							$html.='<div class="mediya_img_blk locationfilter">';
							$html.='<img class="mediya_grid1" src="'.ASSETS_IMG.'/m/location/'.$Row['image'].'">';
							$html.='<img class="mediya_grid1_img_selected mediya_slctd" src="'.ASSETS_IMG.'/m/image_Added_to_lbry.png">';
							$html.='<a title="Select Image" href="javascript:void(0)" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediaselectassigned_'.$Row['id'].'" class="mediya_select_pp">
													<img style="display: block;text-align: left;" src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
													<span>Select Image</span>
												</a>';
							$html.='</div>';
							$remain_img_cnt++;
						}
					}
					
					if($remain_img_cnt>0)
					{
					}
					else
					{
						$html.='<div>No images available to add.</div>';
					}
			$html.='</div>
				</div>
				<div id="div_vdo" class="tabs" style="display: none;">
					<div id="mediya_video_container_popup" style="display:inline-block">';
					$remain_vdo_cnt=0;
					
					while($Row = $RS_l1->FetchRow())
					{
						if(in_array($Row['id'], $arr_id1))
						{
						}
						else
						{
							$html.='<div class="mediya_img_blk locationfilter">';
							$html.='<img class="mediya_grid1" src="'.$Row['thumbnail_url'].'">';
							$html.='<img class="mediya_grid1_img_selected mediya_slctd" src="'.ASSETS_IMG.'/m/image_Added_to_lbry.png">';
							$html.='<a title="Select Video" href="javascript:void(0)" id="mediaselectassignedvideo_'.$Row['id'].'" class="mediya_select_pp">
													<img style="display: block;text-align: left;" src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
													<span>Select Video</span>
												</a>';
							$html.='</div>';
							$remain_vdo_cnt++;
						}
					}
					
					if($remain_vdo_cnt>0)
					{
					}
					else
					{
						$html.='<div>No videos available to add.</div>';
					}
			$html.='</div>
				</div>
			</div>';
	
	
	$json_array['status'] = "true";
	$json_array["html"]= $html;
	
	$json = json_encode($json_array);
	echo $json;
	return $json;							
}

/******** 
@USE : to get location with image gallery count
@PARAMETER :
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['btngetlocationgallery'])){

	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ".$_REQUEST['iDisplayStart'] .", ".
			$_REQUEST['iDisplayLength'] ;
	}
	
	$json_array = $records = array();
	$count=0;	
	/*
	$RS = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS l.id,l.address,l.city,l.state,l.zip,(select count(migd.merchant_media_id) from merchant_image_gallery_detail migd where migd.merchant_image_gallery_id=mig.id) total_count 
								from merchant_image_gallery mig,locations l where l.id=mig.location_id and l.created_by=".$_SESSION['merchant_id']);
    */
    
    $RS = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS l.id,l.address,l.city,l.state,l.zip,
	(select count(migd.merchant_media_id) 
	from merchant_image_gallery mig,merchant_image_gallery_detail migd 
	where l.id=mig.location_id and migd.merchant_image_gallery_id=mig.id) total_count,
	(select count(lvgd.merchant_videos_id) 
	from  location_video_gallery lvg,location_video_gallery_detail lvgd 
	where l.id=lvg.location_id and lvgd.location_video_gallery_id=lvg.id) total_video_count 
from locations l
where l.id in (select location_id from merchant_image_gallery) or l.id in (select location_id from location_video_gallery) and l.created_by=".$_SESSION['merchant_id']." ".$sLimit);
    
    $sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
	$total= $sQuery->fields['FOUND_ROWS()'];
	
	$Json = array();
	$Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
	$Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
	$Json['iTotalDisplayRecords'] = $total;
	$Json['sEcho'] = $_REQUEST['sEcho'];
	$Json['sSearch'] = $_REQUEST['sSearch'];
	$Json['aaData'] = array();    
	
	if($RS->RecordCount()>0)
	{
		 $k=0;
		while($Row = $RS->FetchRow())
		{                   
			//$records[$count] = get_field_value($Row);
			//$count++; 
			$array_where = array();
			$array_where['id'] = $Row['state'];
			$RS_state = $objDB->Show("state", $array_where);

			$array_where = array();
			$array_where['id'] = $Row['city'];
			$RS_city = $objDB->Show("city", $array_where);

			$Json['aaData'][$k][] = $Row['address'] . ", " . $RS_city->fields['name'] . ", " . $RS_state->fields['short_form'] . ", " . $Row['zip'];
 
			//$Json['aaData'][$k][]=$Row['address'].",".$Row['city'].",".$Row['state'].",".$Row['zip'];
			$Json['aaData'][$k][]=$Row['total_video_count'];
			$Json['aaData'][$k][]=$Row['total_count'];
			
			$html="";
			$html .= 'More  Actions';
			$html .='<div class="action_wrapper">';
			$html .='<div id="actiondiv" class="actiondivclass"> ';
			$html .='<a class="commonclass" lid='.$Row['id'].' link="edit-user.php?id='.$Row['id'].'" href="javascript:void(0);">View Gallery</a>';
			$html .='<a class="commonclass" lid='.$Row['id'].' link="edit-user.php?id='.$Row['id'].'" href="javascript:void(0);">Assigned Media</a>';
			$html .='<a class="commonclass" lid='.$Row['id'].' link="edit-user.php?id='.$Row['id'].'" href="javascript:void(0);">Unassigned Media</a>';
			if($Row['total_count']==0 && $Row['total_video_count']==0)
			{
				$html .='<a class="commonclass" lid='.$Row['id'].' link="edit-user.php?id='.$Row['id'].'" href="javascript:void(0);">Delete</a>';
			}
			$html .='</div>';
			$html .='</div>';
			
			$Json['aaData'][$k][]=$html;
			$k++;

		}
	}
	
	$json = json_encode($Json);
	 echo $json;
	 exit();
}

/******** 
@USE : to add image gallery
@PARAMETER : location id, image ids
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['btnAddlocationgallery'])){
	$location_id = $_REQUEST['location_id'];
	
	// for image library
	
	if($_REQUEST['image_ids']!="")
	{	
		$image_ids = $_REQUEST['image_ids'];
		$imag_arr = explode(",",$image_ids);
		
		// start new code to check image id exist in system
		
		$img_not_found=0;
		foreach($imag_arr as $img)
		{	
			$array = array();
			$array['id'] = $img;
			$RS = $objDB->Show("merchant_media",$array);
			if($RS->RecordCount()==0)
			{
				$img_not_found=1;	
			}
		}
		if($img_not_found==1)
		{
			$json_array = array();
			$json_array['status'] = "false";
			$json = json_encode($json_array);
			echo $json;
			exit();
		}
		
		// end new code to check image id exist in system
		
		$array = array();
		$array['location_id'] = $location_id;
		$RS = $objDB->Show("merchant_image_gallery",$array);
		
		if($RS->RecordCount()>0)
		{
			$merchant_image_gallery_id = $RS->fields['id'];
		}
		else
		{
			$array=array();	
			$array['location_id'] = $location_id;
			$merchant_image_gallery_id = $objDBWrt->Insert($array, "merchant_image_gallery");
		}
			
		foreach($imag_arr as $img)
		{	
			$array=array();	
			$array['merchant_image_gallery_id'] = $merchant_image_gallery_id;
			$array['merchant_media_id'] = $img;  
			$merchant_image_gallery_detail_id = $objDBWrt->Insert($array, "merchant_image_gallery_detail");
		}
	}
	
	// for video library
	
	if($_REQUEST['video_ids']!="")
	{
		$video_ids = $_REQUEST['video_ids'];
		$video_arr = explode(",",$video_ids);
		
		// start new code to check video id exist in system
		
		$vdo_not_found=0;
		foreach($video_arr as $vdo)
		{	
			$array = array();
			$array['id'] = $vdo;
			$RS = $objDB->Show("merchant_videos",$array);
			if($RS->RecordCount()==0)
			{
				$vdo_not_found=1;	
			}
		}
		if($vdo_not_found==1)
		{
			$json_array = array();
			$json_array['status'] = "false";
			$json = json_encode($json_array);
			echo $json;
			exit();
		}
		
		// end new code to check video id exist in system
		
		$array = array();
		$array['location_id'] = $location_id;
		$RS = $objDB->Show("location_video_gallery",$array);
		if($RS->RecordCount()>0)
		{
			$merchant_video_gallery_id = $RS->fields['id'];
		}
		else
		{
			$array=array();	
			$array['location_id'] = $location_id;
			$merchant_video_gallery_id = $objDBWrt->Insert($array, "location_video_gallery");
		}
			
		foreach($video_arr as $vdo)
		{	
			$array=array();	
			$array['location_video_gallery_id'] = $merchant_video_gallery_id;
			$array['merchant_videos_id'] = $vdo;  
			$merchant_video_gallery_detail_id = $objDBWrt->Insert($array, "location_video_gallery_detail");
		}
	}
	$json_array = array();
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : to remove image from gallery
@PARAMETER : location id, image ids
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['btnRemoveimagefromlocationgallery'])){
	$location_id = $_REQUEST['location_id'];
	
	// for images
	
	if($_REQUEST['image_ids']!="")
	{
		$image_ids = $_REQUEST['image_ids'];
		
		$imag_arr = explode(",",$image_ids);
		
		$array = array();
		$array['location_id'] = $location_id;
		$RS = $objDB->Show("merchant_image_gallery",$array);
		if($RS->RecordCount()>0)
		{
			$merchant_image_gallery_id = $RS->fields['id'];
		}
			
		//echo $merchant_image_gallery_id."-";
		foreach($imag_arr as $img)
		{	
			$array_where = array();
			$array_where['merchant_image_gallery_id'] = $merchant_image_gallery_id;
			$array_where['merchant_media_id'] = $img;
			$objDBWrt->Remove("merchant_image_gallery_detail", $array_where);
		}
	}
	
	// for videos
	
	if($_REQUEST['video_ids']!="")
	{
		$video_ids = $_REQUEST['video_ids'];
		
		$video_arr = explode(",",$video_ids);
		
		$array = array();
		$array['location_id'] = $location_id;
		$RS = $objDB->Show("location_video_gallery",$array);
		if($RS->RecordCount()>0)
		{
			$merchant_video_gallery_id = $RS->fields['id'];
		}
			
		//echo $merchant_image_gallery_id."-";
		foreach($video_arr as $vdo)
		{	
			$array_where = array();
			$array_where['location_video_gallery_id'] = $merchant_video_gallery_id;
			$array_where['merchant_videos_id'] = $vdo;
			$objDBWrt->Remove("location_video_gallery_detail", $array_where);
		}
	}
	echo "success";
}


/******** 
@USE : to remove location gallery
@PARAMETER : location id
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['delete_location_gallery'])){
	
	$json_array = array();
	
	$location_id = $_REQUEST['id'];
	
	$array_where = array();
	$array_where['location_id'] = $location_id;
	$objDBWrt->Remove("merchant_image_gallery", $array_where);
	
	$array_where = array();
	$array_where['location_id'] = $location_id;
	$objDBWrt->Remove("location_video_gallery", $array_where);
	
	$array_where = array();
	$array_where['id'] = $location_id;
	$RS = $objDB->Show("locations", $array_where);
	
	$location_string = $RS->fields['address'].', '.$RS->fields['city'].', '.$RS->fields['state'].', '.$RS->fields['zip'];
	$location_string = (strlen($location_string) > 57) ? substr($location_string, 0, 57) . '...' : $location_string;
												
	$html='<option title="'.$RS->fields['address'].', '.$RS->fields['city'].', '.$RS->fields['state'].', '.$RS->fields['zip'].'" value="'.$RS->fields['id'].'" >'.$location_string.'</option>';
	
	$json_array['status'] = "true";
	$json_array['html'] = $html;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : to add campaign
@PARAMETER : hdn_image_path,title,campaign_tag,category_id,description,terms_condition,deal_value,discount,saving,start_date,expiration_date,redeem_rewards,referral_rewards,required_point,hdn_transcation_fees,new_customer_only,remaining_point,max_no_of_sharing,number_of_use,is_walkin,max_coupns,location_id,hdn_location_id,chk_location_groups
@RETURN : json data
@USED IN PAGES : add-compaign.phpcopy-compaign.php
*********/

if(isset($_REQUEST['btnAddCampaigns'])){
	
try{
	$objDB->Conn->StartTrans();
	$array = array();        
	
           /*  start of PAY-508-28033  */
	if($_REQUEST['hdn_image_path'] == "")
	{
		
		$array['business_logo'] = "";	
	}
	else
	{
		
		$array['business_logo'] = $_REQUEST['hdn_image_path'];	
	}
	/*  end of PAY-508-28033  */
        
	$array['title'] = $_REQUEST['title'];
        
        $tag_temp=  explode(",", $_REQUEST['campaign_tag']);
        
       
       if(isset($tag_temp[0]) && isset($tag_temp[1]) && isset($tag_temp[2]))
		{
		   if(str_replace(' ', '', $tag_temp[0]) != "" && str_replace(' ', '', $tag_temp[1]) != "" && str_replace(' ', '', $tag_temp[2]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[0]).",".str_replace(' ', '', $tag_temp[1]).",".str_replace(' ', '', $tag_temp[2]);
		   }
		}
       if(isset($tag_temp[0]) && isset($tag_temp[1]) )
		{ 
			if(str_replace(' ', '', $tag_temp[0]) != "" && str_replace(' ', '', $tag_temp[1]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[0]).",".str_replace(' ', '', $tag_temp[1]);
		   }
		}
      if(isset($tag_temp[0]) && isset($tag_temp[2]))
		{ 
			  if(str_replace(' ', '', $tag_temp[0]) != "" && str_replace(' ', '', $tag_temp[2]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[0]).",".str_replace(' ', '', $tag_temp[2]);
		   }
       }
       if(isset($tag_temp[1]) && isset($tag_temp[2]))
		{ 
			 if(str_replace(' ', '', $tag_temp[1]) != "" && str_replace(' ', '', $tag_temp[2]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[1]).",".str_replace(' ', '', $tag_temp[2]);
		   }
       }
       if(isset($tag_temp[0]))
		{ 
			 if(str_replace(' ', '', $tag_temp[0]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[0]);
		   }
		}
        if( isset($tag_temp[1]))
		{ 
			if(str_replace(' ', '', $tag_temp[1]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[1]);
		   }
       }
       if( isset($tag_temp[2]))
		{ 
			 if(str_replace(' ', '', $tag_temp[2]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[2]);
		   }
		} 
        $array['campaign_tag']=$tag_main;
        
        
	// 02 10 2013
	
	// 02 10 2013
	$array['category_id'] = $_REQUEST['category_id'];
	$array['description'] = $_REQUEST['description'];
        $array['terms_condition'] = $_REQUEST['terms_condition'];
        
        
        $array['deal_value'] = round($_REQUEST['deal_value']);
		$array['discount'] = round($_REQUEST['discount']);
		$array['saving'] = round($_REQUEST['saving']);
	
        $array['start_date'] = $_REQUEST['start_date'];
	
        $array['expiration_date'] = $_REQUEST['expiration_date'];
	
	$array['redeem_rewards'] = $_REQUEST['redeem_rewards'];
	$array['referral_rewards'] = $_REQUEST['referral_rewards'];
	/* Block point*/
        $array['block_point'] = $_REQUEST['required_point'];
		$array['transaction_fees'] = $_REQUEST['hdn_transcation_fees'];
        if(isset($_REQUEST['new_customer_only']))
        {
            $array['new_customer']=$_REQUEST['new_customer_only'];
        }
	
		/*$Sql = "Update merchant_user set available_point =". $_REQUEST['remaining_point']." where id=".getmainmercahnt_id($_SESSION['merchant_id']);
		$objDB->Conn->Execute($Sql);*/
		$merchant_id = getmainmercahnt_id($_SESSION['merchant_id']);
		$objDBWrt->Conn->Execute("Update merchant_user set available_point =? where id=?",array($_REQUEST['remaining_point'],$merchant_id));

		/* block point */
        $array['max_no_sharing'] = $_REQUEST['max_no_of_sharing'];
	
	$array['number_of_use'] = $_REQUEST['number_of_use'];
        if($_REQUEST['is_walkin'] == 0)
        {
               $array['is_walkin'] =0;
               /* */
                 if(isset($_REQUEST['assign_group']))
		 {
			$array['level'] = 1;
		 }
		 else{
			$array['level'] = 0;
		 }
        }
        else
        {
            $array['level'] = 0;
            $array['is_walkin'] = 1;
        }
	
        if(isset($_REQUEST['max_coupns']))
        {
            $array['max_coupns'] = $_REQUEST['max_coupns'];
        }
	
	
	$array['created_date'] = date("Y-m-d H:i:s");
        $array['modified_date'] = date("Y-m-d H:i:s");
       
            if(isset($_REQUEST['created_by']) == ""){
                    $array['created_by'] = $_SESSION['merchant_id'];
            }else{
                    $array['created_by'] = get_merchant_session_id($_REQUEST['created_by']);
            }
       
	$array['visible'] = 1;
	$campaign_id = $objDBWrt->Insert($array, "campaigns");
          $count=0;
          
	if($_SESSION['merchant_info']['merchant_parent'] == 0){ 
		if(isset($_REQUEST['location_id']))
		{
			foreach($_REQUEST['location_id'] as $location_id){
				$array_cl = array();
				$array_cl['campaign_id'] = $campaign_id;
				$array_cl['location_id'] = $location_id;
                                
                        	$array_cl['num_activation_code'] = $_REQUEST['num_activation_code_'.$location_id];
                              $array_cl['offers_left'] = $_REQUEST['num_activation_code_'.$location_id];
							  $array_cl['campaign_type'] = $_REQUEST['hdn_campaign_type_'.$location_id];
							  $permalink_url = $objJSON->create_camapign_url($campaign_id,$location_id,$_REQUEST['title'],$_SESSION['merchant_info']['business'],$_REQUEST['category_id']);
							  $array_cl['permalink'] = $permalink_url;
							
				$objDBWrt->Insert($array_cl, "campaign_location");
				$count++;
			
			}
		}
               
	}
	else{
	$arr=file(WEB_PATH.'/process.php?getlocationbusinessname=yes&l_id='.$_REQUEST['hdn_location_id']);
                                                if(trim($arr[0]) == "")
                                                     {
                                                             unset($arr[0]);
                                                             $arr = array_values($arr);
                                                     }
                                                     $json = json_decode($arr[0]);
                                                $busines_name  = $json->bus_name;
                                                $b = $busines_name;
		$array_cl = array();
		$array_cl['campaign_id'] = $campaign_id;
		$array_cl['location_id'] = $_REQUEST['hdn_location_id'];
		$array_cl['num_activation_code'] = $_REQUEST['num_activation_code_'.$_REQUEST['hdn_location_id']];
                $array_cl['offers_left'] =$_REQUEST['num_activation_code_'.$_REQUEST['hdn_location_id']];
				$array_cl['campaign_type'] = $_REQUEST['hdn_campaign_type_'.$_REQUEST['hdn_location_id']];
				$permalink_url = $objJSON->create_camapign_url($campaign_id,$_REQUEST['hdn_location_id'],$_REQUEST['title'], $b,$_REQUEST['category_id']);
							  $array_cl['permalink'] = $permalink_url;
		$objDBWrt->Insert($array_cl, "campaign_location");
		//$objJSON->create_camapign_url($campaign_id,$_REQUEST['hdn_location_id'],$_REQUEST['title'],$_SESSION['merchant_info']['business'],$_REQUEST['category_id']);
	}
        if($_REQUEST['is_walkin'] == 0)
        {
            if(isset($_REQUEST['chk_location_groups']))
            {
                    foreach($_REQUEST['chk_location_groups'] as $group_id){
                            /*$Sql = "INSERT  INTO campaign_groups SET group_id='$group_id', campaign_id='$campaign_id', merchant_id='$array[created_by]'";
                            $objDB->Conn->Execute($Sql);*/
			$objDBWrt->Conn->Execute("INSERT  INTO campaign_groups SET group_id=?, campaign_id=?, merchant_id=?",array($group_id,$campaign_id,$array['created_by']));		
                    }
            }
        
        }
	
$array = array();
	
        $array['activation_code'] = create_campaign_code($campaign_id);
	$array['campaign_id'] = $campaign_id;
	$objDBWrt->Insert($array, "activation_codes");
	
        $_SESSION['msg'] = $merchant_msg["edit-compaign"]["Msg_campaign_added"];
	$json_array=array();
	$json_array['status']='true';
	$json_array['message']=$merchant_msg["edit-compaign"]["Msg_campaign_added"];
	$json = json_encode($json_array);
	echo $json;
        
	$objDB->Conn->CompleteTrans(); 
	}catch (Exception $e) {
    echo 'Caught exception: ',  $e->getMessage(), "\n";
}
	// 369
	$_SESSION['msg'] = $merchant_msg["edit-compaign"]["Msg_campaign_added"];
	$_SESSION['inserted_id'] = $campaign_id ;
	$_SESSION['action'] = "add";
	$json_array=array();
	$json_array['status']='true';
	$json_array['message']=$merchant_msg["edit-compaign"]["Msg_campaign_added"];
	$json = json_encode($json_array);
	
    exit();
	// 369

}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btncancelprofile'])){
	header("Location: ".WEB_PATH."/merchant/my-account.php");
}

/******** 
@USE : to cancel change password
@PARAMETER : 
@RETURN : 
@USED IN PAGES : change-password.php
*********/
if(isset($_REQUEST['btncancelpassword'])){
	header("Location: ".WEB_PATH."/merchant/my-account.php");
}

/******** 
@USE : to cancel campaign
@PARAMETER : 
@RETURN : 
@USED IN PAGES : add-compaign.php,edit-compaign.php,copy-compaign.php
*********/
if(isset($_REQUEST['btnCanCampaigns'])){
	header("Location: ".WEB_PATH."/merchant/compaigns.php?action=active");
}

/******** 
@USE : to check campaign exist on location
@PARAMETER : campaign_id
@RETURN : json data
@USED IN PAGES : edit-compaign.php
*********/
if(isset($_REQUEST['checkCampaignExistOnLocation']))
{
	$json_array = array();
	
	$CampId = $_REQUEST['campaign_id'];
	/*$Sql = "SELECT * from campaign_location WHERE campaign_id=".$CampId;
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * from campaign_location WHERE campaign_id=?",array($CampId));
	if($RS->RecordCount() > 0 )
	{
		$json_array['status'] = "true";
	}
	else
	{
		$json_array['status'] = "false";
	}
	$json= json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : to edit campaign
@PARAMETER : id,hdn_image_path,title,campaign_tag,category_id,description,terms_condition,deal_value,discount,saving,start_date,expiration_date,redeem_rewards,referral_rewards,required_point,hdn_transcation_fees,new_customer_only,remaining_point,max_no_of_sharing,number_of_use,is_walkin,max_coupns,location_id,hdn_location_id,chk_location_groups
@RETURN : json data
@USED IN PAGES : edit-compaign.php
*********/

if(isset($_REQUEST['btnEditCampaigns'])){
   try
   {
$objDB->Conn->StartTrans();
    $array = $where_clause = array();
	
    if($_REQUEST['hdn_image_path'] == "")
	{		
		
		$array['business_logo'] = "";	
	}
	else
	{		
		$array['business_logo'] = $_REQUEST['hdn_image_path'];	
	}

		if(isset($_REQUEST['title']))
		{
		$array['title'] = str_replace("'","''",$_REQUEST['title']);

		}
         if($_REQUEST['is_walkin'] == 0)
         {
                $array['is_walkin'] =0;
                if(isset($_REQUEST['assign_group']))
                {
                    
                    
                    if($_REQUEST['assign_group'] == "1")
                    {
                           $array['level'] = 1;
                    }
                    else{
                           $array['level'] = 0;
                    }
                }
                else
                {
                        $array['level'] = 0;
                }
        }else
        {
            $array['is_walkin'] =1;
            $array['level'] = 0;
        }
	
	$array['max_no_sharing'] = $_REQUEST['max_no_of_sharing'];
	
       if(isset($_REQUEST['max_coupns']))
	   {
            $array['max_coupns'] = $_REQUEST['max_coupns'];
       }
       
       $tag_temp=  explode(",", $_REQUEST['campaign_tag']);
       
		if(isset($tag_temp[0]) && isset($tag_temp[1]) && isset($tag_temp[2]))
		{
		   if(str_replace(' ', '', $tag_temp[0]) != "" && str_replace(' ', '', $tag_temp[1]) != "" && str_replace(' ', '', $tag_temp[2]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[0]).",".str_replace(' ', '', $tag_temp[1]).",".str_replace(' ', '', $tag_temp[2]);
		   }
		}
       if(isset($tag_temp[0]) && isset($tag_temp[1]) )
		{ 
			if(str_replace(' ', '', $tag_temp[0]) != "" && str_replace(' ', '', $tag_temp[1]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[0]).",".str_replace(' ', '', $tag_temp[1]);
		   }
		}
      if(isset($tag_temp[0]) && isset($tag_temp[2]))
		{ 
			  if(str_replace(' ', '', $tag_temp[0]) != "" && str_replace(' ', '', $tag_temp[2]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[0]).",".str_replace(' ', '', $tag_temp[2]);
		   }
       }
       if(isset($tag_temp[1]) && isset($tag_temp[2]))
		{ 
			 if(str_replace(' ', '', $tag_temp[1]) != "" && str_replace(' ', '', $tag_temp[2]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[1]).",".str_replace(' ', '', $tag_temp[2]);
		   }
       }
       if(isset($tag_temp[0]))
		{ 
			 if(str_replace(' ', '', $tag_temp[0]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[0]);
		   }
		}
        if( isset($tag_temp[1]))
		{ 
			if(str_replace(' ', '', $tag_temp[1]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[1]);
		   }
       }
       if( isset($tag_temp[2]))
		{ 
			 if(str_replace(' ', '', $tag_temp[2]) != "")
		   {
			   $tag_main=str_replace(' ', '', $tag_temp[2]);
		   }
		}
        
        $array['campaign_tag']=$tag_main;
        
	$array['category_id'] = $_REQUEST['category_id'];        
	$array['description'] = $_REQUEST['description'];
	// 06 11 2013
        $array['terms_condition'] = $_REQUEST['terms_condition'];
	// 06 11 2013
       
        
        $array['deal_value'] = round($_REQUEST['deal_value']);
		$array['discount'] = round($_REQUEST['discount']);
		$array['saving'] = round($_REQUEST['saving']);
       
		if(isset($_REQUEST['start_date']))
		{
			if($_REQUEST['start_date']!=""){
				 $array['start_date'] = date("Y-m-d H:i:s",strtotime($_REQUEST['start_date']));
				$array['expiration_date'] =  date("Y-m-d H:i:s",strtotime($_REQUEST['expiration_date']));
			}
		}
		
	$array['number_of_use'] = $_REQUEST['number_of_use'];
     
        $array['new_customer']=isset($_REQUEST['new_customer_only']);
        
	/* Block point*/
        $array['block_point'] = $_REQUEST['required_point'];
	        $array['transaction_fees'] = $_REQUEST['hdn_transcation_fees'];

        if(isset($_REQUEST['remaining_point']))
		{
			$remaining_point=$_REQUEST['remaining_point'];
                       
			$Sql = "Update merchant_user set available_point =". $remaining_point." where id=".getmainmercahnt_id($_SESSION['merchant_id']);
		}
               
		//$objDB->Conn->Execute($Sql);
		$objDBWrt->Conn->Execute("Update merchant_user set available_point =? where id=?",array($remaining_point,getmainmercahnt_id($_SESSION['merchant_id'])));
          
	/* block point */
		
	//$array['timezone'] = $_REQUEST['timezone'];
	$array['number_of_use'] = $_REQUEST['number_of_use'];
	$array['modified_date'] = date("Y-m-d H:i:s");
	$array['modified_by'] = $_SESSION['merchant_id'];
	
	$where_clause['id'] = $_REQUEST['id'];
       
	$objDBWrt->Update($array, "campaigns", $where_clause);
     
	 /*$Sql = "delete FROM campaign_groups WHERE campaign_id=".$_REQUEST['id'];
           $objDB->Conn->Execute($Sql);*/
	$objDBWrt->Conn->Execute("delete FROM campaign_groups WHERE campaign_id=?",array($_REQUEST['id']));
          
            if($_REQUEST['is_walkin'] == 0)
        {
		foreach($_REQUEST['chk_location_groups'] as $group_id){
	
				/*$Sql = "INSERT  INTO campaign_groups SET group_id=".$group_id.", campaign_id=".$_REQUEST['id'].", merchant_id=".$_SESSION['merchant_id'];
                               
				$objDB->Conn->Execute($Sql);*/
				$objDBWrt->Conn->Execute("INSERT  INTO campaign_groups SET group_id=?, campaign_id=?, merchant_id=?",array($group_id,$_REQUEST['id'],$_SESSION['merchant_id']));
			
		}
        }
         
	if($_SESSION['merchant_info']['merchant_parent'] == 0){ 
        if(isset($_REQUEST['location_id']))
	    {
                	$where_clause = array();
	$where_clause['campaign_id'] = $_REQUEST['id'];
	$RS_campaign_location=$objDB->Show("campaign_location", $where_clause);
	
        $c_l_array= array();
        
        while($Row_c_l = $RS_campaign_location->FetchRow())
        {
            array_push($c_l_array,$Row_c_l['location_id']);
        }
        foreach($_REQUEST['location_id'] as $location_id){
                      if(in_array($location_id,$c_l_array))
                      {
                          $where_clause = array();
                          $where_clause['campaign_id'] = $_REQUEST['id'];
                          $where_clause['location_id']= $location_id;
	$RS_campaign_offers_left=$objDB->Show("campaign_location", $where_clause);
                            $used = $RS_campaign_offers_left->fields['used_offers'];
                            $campaign_type = $_REQUEST['hdn_campaign_type_'.$location_id];
                            $last_a_p = $_REQUEST['num_activation_code_'.$location_id] -  $used;
                          $sql_up = "Update campaign_location set num_activation_code=".$_REQUEST['num_activation_code_'.$location_id]." , offers_left=". $last_a_p.", campaign_type=".$campaign_type." where campaign_id=".$_REQUEST['id']." and location_id=".$location_id;
                         
							if(isset($_REQUEST['title']))
							{
								$t= $_REQUEST['title'];
							}
							else{
								$t = $_REQUEST['campaign_title'];
							}
							
                                                        
                if($_REQUEST['is_walkin'] == 0)
                {                                        
						  if( $RS_campaign_offers_left->fields['permalink'] == "")
						
						  {
						 
						  $permalink_url = $objJSON->create_camapign_url($_REQUEST['id'],$location_id,$t, $_SESSION['merchant_info']['business'],$_REQUEST['category_id']);
						 
						  $sql_up = "Update campaign_location set num_activation_code=".$_REQUEST['num_activation_code_'.$location_id]." , offers_left=". $last_a_p.", campaign_type=".$campaign_type." , permalink='".$permalink_url."' where campaign_id=".$_REQUEST['id']." and location_id=".$location_id;
							  
							  }
							  else{
							  $sql_up = "Update campaign_location set num_activation_code=".$_REQUEST['num_activation_code_'.$location_id]." , offers_left=". $last_a_p.", campaign_type=".$campaign_type." where campaign_id=".$_REQUEST['id']." and location_id=".$location_id;
							
							 }
                }
                else
                {
                           
						  if( $RS_campaign_offers_left->fields['permalink'] == ""){
						 
						  $permalink_url = $objJSON->create_camapign_url($_REQUEST['id'],$location_id,$t, $_SESSION['merchant_info']['business'],$_REQUEST['category_id']);
						
						  $sql_up = "Update campaign_location set num_activation_code=".$_REQUEST['num_activation_code_'.$location_id]." , offers_left=". $last_a_p.", permalink='".$permalink_url."' where campaign_id=".$_REQUEST['id']." and location_id=".$location_id;
							  
							  }
							  else{
							  $sql_up = "Update campaign_location set num_activation_code=".$_REQUEST['num_activation_code_'.$location_id]." , offers_left=". $last_a_p." where campaign_id=".$_REQUEST['id']." and location_id=".$location_id;
							
							 }
                }
                          $objDB->Conn->Execute($sql_up);
                      }
                    else {
			$array = array();
			$array['campaign_id'] = $_REQUEST['id'];
			$array['location_id'] = $location_id;
                        $array['offers_left'] = $_REQUEST['num_activation_code_'.$location_id];
			$array['num_activation_code'] =  $_REQUEST['num_activation_code_'.$location_id];
                        if($_REQUEST['is_walkin'] == 0)
                        { 
                            $array['campaign_type'] = $_REQUEST['hdn_campaign_type_'.$location_id];
                        }
                       
			if(isset($_REQUEST['title']))
			{
				$t= $_REQUEST['title'];
			}
			else{
				$t = $_REQUEST['campaign_title'];
			}
			$permalink_url = $objJSON->create_camapign_url($_REQUEST['id'],$location_id,$t, $_SESSION['merchant_info']['business'],$_REQUEST['category_id']);
			$array['permalink'] = $permalink_url;
			$objDBWrt->Insert($array, "campaign_location");
			$count++;
                     }
		 }
               
        
	   }
	}
	else{
            
            
		$array = array();
		$array['campaign_id'] =  $_REQUEST['id'];
		$array['location_id'] = $_REQUEST['hdn_location_id'];
                $location_id=$_REQUEST['hdn_location_id'];
                $where_clause = array();
                          $where_clause['campaign_id'] = $_REQUEST['id'];
                          $where_clause['location_id']= $location_id;
							$RS_campaign_offers_left=$objDB->Show("campaign_location", $where_clause);
                            $used = $RS_campaign_offers_left->fields['used_offers'];
                            
                           $campaign_type = $_REQUEST['hdn_campaign_type_'.$location_id];
                          
                            $last_a_p = $_REQUEST['num_activation_code_'.$_REQUEST['hdn_location_id']] -  $used;
		$array['num_activation_code'] = $_REQUEST['num_activation_code_'.$_REQUEST['hdn_location_id']];
                
		/*$sql_up = "Update campaign_location set num_activation_code=".$_REQUEST['num_activation_code_'.$_REQUEST['hdn_location_id']]." , offers_left=". $last_a_p.",campaign_type=".$campaign_type." where campaign_id=".$_REQUEST['id']." and location_id=".$_REQUEST['hdn_location_id'];
                
                $objDB->Conn->Execute($sql_up);*/
		$objDBWrt->Conn->Execute("Update campaign_location set num_activation_code=? , offers_left=?,campaign_type=? where campaign_id=? and location_id=?",array($_REQUEST['num_activation_code_'.$_REQUEST['hdn_location_id']],$last_a_p,$campaign_type,$_REQUEST['id'],$_REQUEST['hdn_location_id']));

		//$objDB->Insert($array, "campaign_location");
	}
       
	$objDB->Conn->CompleteTrans();
}catch (Exception $e) {
    echo 'Caught exception: ',  $e->getMessage(), "\n";
}	
	// 369
	$_SESSION['inserted_id'] = $_REQUEST['id'];
	$_SESSION['msg'] = $merchant_msg["edit-compaign"]["Msg_campaign_edited"];
	$_SESSION['action'] = "edit";
	$json_array=array();
	$json_array['status']='true';
	$json_array['message']=$merchant_msg["edit-compaign"]["Msg_campaign_edited"];
	$json = json_encode($json_array);
	echo $json;
	header("Location: ".WEB_PATH."/merchant/compaigns.php?action=active");
    exit();
	
}

/******** 
@USE : to add template
@PARAMETER : hdn_image_path,title,category_id,description,terms_condition,description
@RETURN : json data
@USED IN PAGES : add-template.php,customize-template.php
*********/
if(isset($_REQUEST['btnAddTemplate'])){
	$array = array();
	
	/*  start of PAY-508-28033  */
	if($_REQUEST['hdn_image_path'] == "")
	{
		$array['business_logo'] = "";
	}
	else
	{		
		$array['business_logo'] = trim($_REQUEST['hdn_image_path']);	
	}
	/*  end of PAY-508-28033  */
        
	$array['title'] = $_REQUEST['title'];
	
	$array['category_id'] = $_REQUEST['category_id'];
	$array['description'] = $_REQUEST['description'];
        $array['terms_condition'] = $_REQUEST['terms_condition'];
        
	$json_array['status']='false';
	$json_array['message']=$_REQUEST['description'];
	
	$array['created_date'] = date("Y-m-d H:i:s");
        $array['modified_date'] = date("Y-m-d H:i:s");
	
	// 07-09-2013
	$array['created_by'] = $_SESSION['merchant_id'];
	
	$objDBWrt->Insert($array, "campaigns_template");
	// 369
	$_SESSION['msg'] = $merchant_msg['templates']['Msg_template_added'];
	$json_array=array();
	$json_array['status']='true';
	$json_array['message']=$merchant_msg['templates']['Msg_template_added'];
	$json = json_encode($json_array);
	echo $json;
    exit();
	
}

/******** 
@USE : to edit template
@PARAMETER : bna,hdn_image_path,title,category_id,description,terms_condition,description
@RETURN : json data
@USED IN PAGES : edit-template.php
*********/
if(isset($_REQUEST['btneditTemplate'])){
	$array = array();
	if($_REQUEST['hdn_image_path'] == "")
	{
		$array['business_logo'] = "";
	}
	else
	{		
		$array['business_logo'] = trim($_REQUEST['hdn_image_path']);	
	}
	
	$array['title'] = $_REQUEST['title'];
	
	$array['category_id'] = $_REQUEST['category_id'];
	$array['description'] = $_REQUEST['description'];
        $array['terms_condition'] = $_REQUEST['terms_condition'];
       
	$array['modified_date'] = date("Y-m-d H:i:s");
	$array['modified_by'] = $_SESSION['merchant_id'];
        	
	$where_clause['id'] = $_REQUEST['bna'];
	
	$objDBWrt->Update($array, "campaigns_template", $where_clause);
	// 369
	$_SESSION['msg'] = $merchant_msg['templates']['Msg_template_edited'];
	$json_array=array();
	$json_array['status']='true';
	$json_array['message']=$merchant_msg['templates']['Msg_template_edited'];
	$json = json_encode($json_array);
	echo $json;
    exit();
	
}

/******** 
@USE : to add user
@PARAMETER : location_id,state,address,city,zipcode,country,email,firstname,lastname,mobile_country_code,mobileno_area_code,mobileno_area_code,mobileno,ass_page,ass_role,media_access
@RETURN : json data
@USED IN PAGES : add-user.php
*********/
if(isset($_REQUEST['btnAddUser'])){
		$array = $json_array = array();
        $array_role = $json_array = array();
        $location_id=$_REQUEST['location_id'];
            
		if(isset($_REQUEST['state'])){$array['state'] = $_REQUEST['state'];}
		if(isset($_REQUEST['address'])){$array['address'] = ucwords(strtolower($_REQUEST['address']));}
		if(isset($_REQUEST['city'])){$array['city'] = ucwords(strtolower($_REQUEST['city']));}
		if(isset($_REQUEST['zipcode'])){$array['zipcode'] = strtoupper($_REQUEST['zipcode']);}
		if(isset($_REQUEST['country'])){$array['country'] = $_REQUEST['country'];} 
		$array['email'] = $_REQUEST['email'];
		$array['firstname'] = ucwords(strtolower($_REQUEST['firstname']));
		$array['lastname'] =ucwords(strtolower( $_REQUEST['lastname']));
		$mobile_no=$_REQUEST['mobile_country_code']."-".$_REQUEST['mobileno_area_code']."-".$_REQUEST['mobileno_area_code']."-".$_REQUEST['mobileno'];
		$array['phone_number']=$mobile_no;
		$array['created_date'] = date("Y-m-d H:i:s");
		$array['approve'] = "0";
		$array['active'] = "1";
		$array['group'] = "";	
		$array['profile_complete'] = "1";		
		
		if(!isset($_REQUEST['id'])){
				$array['merchant_parent'] = $_SESSION['merchant_id'];
		}else{
				$array['merchant_parent'] = get_merchant_session_id($_REQUEST['id']);
		}

        $lastid = $objDBWrt->Insert($array, "merchant_user");             
		/* T_8 */
		$array_role['location_access'] = $_REQUEST['location_id'];
		/* T_8 */
        $array_role['merchant_user_id'] = $lastid ;
		$array_role['ass_page'] = serialize($_REQUEST['ass_page']);
		if(isset($_REQUEST['ass_role']))
		{
			$array_role['ass_role'] = serialize($_REQUEST['ass_role']);
		}
		$array_role['media_access'] = serialize($_REQUEST['media_access']);

		if($lastid!="")
		{            
			$objDBWrt->Insert($array_role, "merchant_user_role");
		}
		$_SESSION['msg']= $merchant_msg['locationemployee']['Msg_employee_added'];
		$json_array['status'] = "true";
		$json_array['message'] = $merchant_msg['locationemployee']['Msg_employee_added'];
		$json = json_encode($json_array);
		
		$mail = new PHPMailer();
	$body='<body bgcolor="#e4e4e4" topmargin="0" leftmargin="0" marginheight="0" marginwidth="0" style="-webkit-font-smoothing: antialiased;width:100% !important;background:#e4e4e4;-webkit-text-size-adjust:none;">
	
<table width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="#e4e4e4">
    <tr>
        <td bgcolor="#e4e4e4" width="100%">
            <table width="600" cellpadding="0" cellspacing="0" border="0" align="center" class="table"
                style="background: #D2D2D2; border: 2px solid #ddd; padding: 20px; border-radius: 10px;">
                <tr>
                    <td width="600" class="cell">
                        <table width="600" cellpadding="0" cellspacing="0" border="0" class="table">
                            <tr>
                                <td width="250" class="logocell">
									<img src="'.ASSETS_IMG.'/m/logo-merchant.png" width="250" height="30" alt="Scanflip Merchant"
                                        style="-ms-interpolation-mode: bicubic; padding: 20px 0;">
                                </td>
                            </tr>
                        </table>
                        <repeater>
			<layout label="New feature">
			<table width="100%" cellpadding="0" cellspacing="0" border="0">
			<tr>
				<td bgcolor="#F37E0A" nowrap><img border="0" src="'.ASSETS_IMG.'/m/spacer.gif" width="5" height="1"></td>
				<td width="100%" bgcolor="#ffffff">
			
					<table width="100%" cellpadding="20" cellspacing="0" border="0">
					<tr>
						<td bgcolor="white" class="contentblock">							                   	
							<h4 style="color:black; font-size:16px; line-height:24px; font-family:Helvetica Neue,Helvetica,Arial,sans-serif; margin-top:0; margin-bottom:10px; padding-top:0; padding-bottom:0; font-weight:normal;"><strong><singleline label="Title">Hi '.ucwords(strtolower($_REQUEST['firstname'])).',</singleline></strong></h4>
							<multiline label="Description"><p style=" color: black; font-family:Helvetica Neue,Helvetica,Arial,sans-serif; font-size: 13px; font-weight: normal; line-height: 19px; margin-bottom: 12px; margin-top: 0; padding-bottom: 0; padding-top: 0;">Welcome to Scanflip! Please click the button below to verify your email address.</p></multiline>
                            <h5 style="margin-bottom:0px;"><a href="'.WEB_PATH.'/merchant/process.php?btnverifyemail=yes&employee=1&email='.$_REQUEST['email'].'" style=" background: none repeat scroll 0 0 #F37E0A; font-family: Helvetica Neue,Helvetica,Arial,sans-serif; border-radius: 3px; color: #FFFFFF; font-size: 14px; padding: 5px 15px; text-align: center; text-decoration: none;">Verify</a></h5>                                
                    		<h5><p style=" color: black; font-family:Helvetica Neue,Helvetica,Arial,sans-serif; font-size: 13px; font-weight: normal; line-height: 19px; margin-bottom: 12px; margin-top: 0; padding-bottom: 0; padding-top: 0;">Thank You,<br/>Scanflip Support Team.</p></h5>
						</td>
					</tr>
					</table>
				</td>
			</tr>
			</table>  
			</layout>
		</repeater>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>

</body>';
		$mail->AddReplyTo('no-reply@scanflip.com','ScanFlip Support');
		$mail->AddAddress($_REQUEST['email']);
		$mail->From = "no-reply@scanflip.com";
		$mail->FromName = "ScanFlip Support";
		$mail->Subject    = ucwords(strtolower($_REQUEST['firstname'])).",Verify your email to finish setting up your merchant account.";
		$mail->MsgHTML($body);
					  
		$mail->Send();

		echo $json;
		exit();
}

/******** 
@USE : to edit user
@PARAMETER : userid,location_id,state,address,city,zipcode,country,email,firstname,lastname,mobile_country_code,mobileno_area_code,mobileno_area_code,mobileno,ass_page,ass_role,media_access
@RETURN : json data
@USED IN PAGES : edit-user.php
*********/
if(isset($_REQUEST['btnEditUser'])){
        
	$array = $json_array = array();
    $array_role = $json_array = array();
	
	$countrystate=$_REQUEST['country']; 
	$location_id=$_REQUEST['location_id'];
  
    /*$Sql = "SELECT * from locations where id=".$location_id;
       		
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * from locations where id=?",array($location_id));
        
	if($RS->RecordCount()>0)
	{
		while($Row = $RS->FetchRow())
		{                   
			$array['state'] = $Row['state'];
			$array['country'] = $Row['country'];  
		}
	}
        
    $all_arr = explode(",", $countrystate);
             
	$array['firstname'] = ucwords(strtolower($_REQUEST['firstname']));
	$array['lastname'] = ucwords(strtolower($_REQUEST['lastname']));
	
	if(isset($_REQUEST['address']))
		$array['address'] = ucwords(strtolower($_REQUEST['address']));
    if(isset($_REQUEST['city']))
		$array['city'] = ucwords(strtolower($_REQUEST['city']));
	if(isset($_REQUEST['state']))
		$array['state'] = $_REQUEST['state'];
	if(isset($_REQUEST['zipcode']))
		$array['zipcode'] = strtoupper($_REQUEST['zipcode']);
	if(isset($_REQUEST['country_main']))
	{
		$array['country'] = $_REQUEST['country_main'];		
	}
	
	$mobile_no=$_REQUEST['mobile_country_code']."-".$_REQUEST['mobileno_area_code']."-".$_REQUEST['mobileno2']."-".$_REQUEST['mobileno'];
	$array['phone_number']=$mobile_no;
	
    $array['profile_complete'] = "1";   
        
	$array['group'] = "";
	
	$where_clause['id'] = $_REQUEST['userid'];
	$objDBWrt->Update($array, "merchant_user", $where_clause);
        /* T_8 */
	$array_role['location_access'] = $_REQUEST['location_id'];
	/* T_8 */
	$array_role['ass_page'] = serialize($_REQUEST['ass_page']);
	if(isset($_REQUEST['ass_role']))
	{
		$array_role['ass_role'] = serialize($_REQUEST['ass_role']);
	}
	if(isset($_REQUEST['media_access']))
	{
		$array_role['media_access'] = serialize($_REQUEST['media_access']);
	}
	else
	{
		$array_role['media_access'] = "";
	}
 
	$where_role['merchant_user_id'] = $_REQUEST['userid'];
	
	if($_SESSION['merchant_id']!="")
	{                      
		$objDBWrt->Update($array_role, "merchant_user_role", $where_role);
	}
        
	$json_array['status'] = "true";
	// 369
	$_SESSION['msg']=$merchant_msg['locationemployee']['Msg_employee_edited'];
	$json_array['message'] = $merchant_msg['locationemployee']['Msg_employee_edited'];
	// 369
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnGetCompaigns'])){
	$json_array = array();
	$merchant_id = get_merchant_session_id($_REQUEST['id']);
	/*$Sql = "SELECT C.*, CAT.cat_name
			FROM campaigns C, categories CAT
			WHERE C.created_by='$merchant_id' AND CAT.id=C.category_id 
			ORDER BY C.id DESC";		
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT C.*, CAT.cat_name
			FROM campaigns C, categories CAT
			WHERE C.created_by=? AND CAT.id=C.category_id 
			ORDER BY C.id DESC",array($merchant_id));
	if($RS->RecordCount()>0){
		$json_array['status'] = "true";
		$json_array['total_records'] = $RS->RecordCount();
		$count=0;
		while($Row = $RS->FetchRow()){
			$json_array[$count] = $Row;
			$count++;
		}
	}else{
		$json_array['status'] = "false";
		$json_array['total_records'] = 0;
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	$json = json_encode($json_array);
	echo $json;
	exit();
	
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnReports'])){
	$json_array = array();
	$merchant_id = get_merchant_session_id($_REQUEST['id']);
	$today_date = date("Y-m-d")." 00:00:00";
	$Where = "";
	if($_REQUEST['action'] == "active"){
		$Where .= " AND C.expiration_date >= '".$today_date."' ";
		//$array_where['expiration_date']	
	}elseif($_REQUEST['action'] == "expired"){
		$Where .= " AND C.expiration_date < '".$today_date."' ";
	}

	/*$Sql = "SELECT C.*, CAT.cat_name
			FROM campaigns C, categories CAT
			WHERE C.created_by='$merchant_id' AND CAT.id=C.category_id $Where 
			ORDER BY C.id DESC";
	//echo $Sql."<hr>"; die();		
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT C.*, CAT.cat_name
			FROM campaigns C, categories CAT
			WHERE C.created_by=? AND CAT.id=C.category_id $Where 
			ORDER BY C.id DESC",array($merchant_id));

	if($RS->RecordCount()>0){
		$json_array['status'] = "true";
		$json_array['total_records'] = $RS->RecordCount();
		$count=0;
		while($Row = $RS->FetchRow()){
			$json_array[$count] = $Row;
			$count++;
		}
	}else{
		$json_array['status'] = "false";
		$json_array['total_records'] = 0;
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnActivationCode'])){
	$json_array = array();
	$merchant_id = get_merchant_session_id($_REQUEST['id']);
	if($merchant_id == ""){
		$json_array['status'] = "false";
		$json_array['total_records'] = 0;
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	$campaign_id = $_REQUEST['campaign_id'];
	/*$Sql = "SELECT AC.*
			FROM activation_codes AC, campaigns C
			WHERE AC.campaign_id=C.id AND AC.campaign_id='$campaign_id' AND C.created_by='$merchant_id'";		
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT AC.*
			FROM activation_codes AC, campaigns C
			WHERE AC.campaign_id=C.id AND AC.campaign_id=? AND C.created_by=?",array($campaign_id,$merchant_id));

	if($RS->RecordCount()>0){
		$Row = $RS->FetchRow();
		$json_array[0] = $Row;
	}else{
		$json_array['status'] = "false";
		$json_array['total_records'] = 0;
		
	}
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnAssignGroup'])){
	foreach($_REQUEST['group_id'] as $group_id){

/*		$Sql = "SELECT * FROM campaign_groups WHERE group_id='$group_id' AND campaign_id='$_REQUEST[id]'";
		$RS = $objDB->Conn->Execute($Sql);*/
		$RS = $objDB->Conn->Execute("SELECT * FROM campaign_groups WHERE group_id=? AND campaign_id=?",array($group_id,$_REQUEST[id]));

		if($RS->RecordCount()<=0){
			/*$Sql = "INSERT  INTO campaign_groups SET group_id='$group_id', campaign_id='$_REQUEST[id]', merchant_id='$_SESSION[merchant_id]'";
			$objDB->Conn->Execute($Sql);*/
			$objDBWrt->Conn->Execute("INSERT  INTO campaign_groups SET group_id=?, campaign_id=?, merchant_id=?",array($group_id,$_REQUEST[id],$_SESSION[merchant_id]));

		}
		
	}
	$json_array = array();
	$json_array['message'] = "Deal has been grouped successfully";
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnAddGroup'])){
	$json_array = array();
	if($_REQUEST['mer_id'] != ""){ $merchant_id = $_REQUEST['mer_id']; }
	else{
	if($_REQUEST['id'] == ""){
	 $merchant_id = $_SESSION['merchant_id'];
	}else{
	 $merchant_id = get_merchant_session_id($_REQUEST['id']);
	}
	if($merchant_id == ""){
	 $json_array['message'] = "Please enter Valid ID";
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
	}
	}
	$group_name = $_REQUEST['group_name'];
	/*$Sql = "SELECT * FROM merchant_groups WHERE group_name='$group_name' AND merchant_id='$merchant_id'";
	$RS = $objDB->Conn->Execute($Sql);   */
	$RS = $objDB->Conn->Execute("SELECT * FROM merchant_groups WHERE group_name=? AND merchant_id=?",array($group_name,$merchant_id));   
	if($RS->RecordCount()>0){
	 $json_array['message'] = "Group is already Present";
	}else{
	 /*$Sql = "INSERT INTO merchant_groups SET group_name='$group_name', merchant_id='$merchant_id'"; 
	 $objDB->Conn->Execute($Sql);*/
		$objDBwrt->Conn->Execute("INSERT INTO merchant_groups SET group_name=?, merchant_id=?",array($group_name,$merchant_id));

	 // 369
	 $_SESSION['msg']= $merchant_msg['distributionlist']['Msg_distlist_added'];
	 $json_array['status'] = "true";
	 $json_array['message'] = $merchant_msg['distributionlist']['Msg_distlist_added'];
	 // 369
	} 
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btncanGroup'])){
	header("Location: ".WEB_PATH."/merchant/manage-groups.php");
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnEditGroup'])){
	$json_array = array();
	if($_REQUEST['mer_id'] != "")
	{ 
		$merchant_id = $_REQUEST['mer_id']; 
	}
	else
	{
		if($_REQUEST['id'] == ""){
			$merchant_id = $_SESSION['merchant_id'];
		}else{
			$merchant_id = get_merchant_session_id($_REQUEST['id']);
		}
		if($merchant_id == ""){
			$json_array['message'] = "Please enter Valid ID";
			$json = json_encode($json_array);
			echo $json;
			exit();
		}
	}
	$group_name = $_REQUEST['group_name'];
	$id = $_REQUEST['group_id'];
	/*$Sql = "UPDATE merchant_groups SET group_name='$group_name' WHERE id='$id' AND merchant_id='$merchant_id'";	
	$objDB->Conn->Execute($Sql);*/
	$objDBWrt->Conn->Execute("UPDATE merchant_groups SET group_name=? WHERE id=? AND merchant_id=?",array($group_name,$id.$merchant_id));
	// 369
	$_SESSION['msg']= $merchant_msg['distributionlist']['Msg_distlist_edited'];
	$json_array['status'] = "true";
	$json_array['message'] = $merchant_msg['distributionlist']['Msg_distlist_edited'];
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : check valid email
@PARAMETER : email
@RETURN : true or false
@USED IN PAGES : process.php
*********/
function email_test($email){
    $regex = '/^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)*(\.[a-z]{2,3})$/'; 
// Run the preg_match() function on regex against the email address
    if (preg_match($regex, $email))
                    {
            return true;
    } else { 
         return false;
    } 
}

//-- For import User from Merchant
/******** 
@USE : add distribution list
@PARAMETER : group_name,location_name,hdn_csvfile
@RETURN : json data
@USED IN PAGES : import-customers.php
*********/
if(isset($_REQUEST['Import_user'])){
    $private=0;
     $clone_group = array();
         $duplicate_counter = 0;   
           
        $merchant_id =  $_SESSION['merchant_id'];
        /*$Sql = "SELECT * from merchant_user WHERE id='$merchant_id'";
        $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * from merchant_user WHERE id=?",array($merchant_id));
        if($RS->RecordCount()>0){
             $Row = $RS->FetchRow();
        }
		$mechant_business = $Row['business'];
		$business_icon = ASSETS_IMG."/m/icon/".$Row['merchant_icon'];
        $mechant_nm = $Row['firstname'];
        $mechant_lnm = $Row['lastname'];
        
    $dirname = $mechant_nm."_".$merchant_id;    
    $filename = ("upload/" . "$dirname" . "/");
  
    if (file_exists($filename)) {        
    } else {
        mkdir("upload/" . "$dirname", 0777);        
    }
$image_folder = "upload/".$dirname."/";
$uploaded = false;
        
//---- if not uploaded any file
//        if($_FILES['userImport']['error'] != 0 ){
//            $_SESSION['msg'] = "File Not Input";
//            header("Location: ".WEB_PATH."/merchant/import-customers.php");
//            exit();
//        }

//----- for Input any CSv file
    $clone_group['group_name'] = $_REQUEST["group_name"];
              // change1 remove location id,private
              $clone_group['merchant_id'] = $_SESSION['merchant_id'];
              $clone_group['active'] = 1;
               $clone_group['is_segmented'] = 0;
              /*
              $clone_group['location_id'] = $_REQUEST["location_name"];
               $clone_group['private'] = 0;
               $lid =  $_REQUEST["location_name"];
               */ 
           $inserted_grop_id = $objDBWrt->Insert($clone_group, "merchant_customerlist");
//if($_FILES['userImport']['error'] == 0 ){
    if(1){
//$up = move_uploaded_file($_FILES['userImport']['tmp_name'], $image_folder.$_FILES['userImport']['name']);

    //
    //if($up){
    if(1){
        $uploaded = true;
        $userimp = $_REQUEST['hdn_csvfile'];// "upload/".$dirname."/".$_FILES["userImport"]["name"];       
        $userimp = addslashes($userimp);
        $handle = fopen($userimp, "r");  
        $success_count = 0;
            if($handle)
            {
		        $stack=array(); 
                for($i =1;($data = fgetcsv($handle, 10000, ",")) !== FALSE; $i++)
                {
		
                    if($i==1 )
                    continue;
                    
                    /*$Sql_s = "SELECT * from customer_user WHERE emailaddress='".trim($data['6'])."'";
                    $RS_u = $objDB->Conn->Execute($Sql_s);*/
			$RS_u = $objDB->Conn->Execute("SELECT * from customer_user WHERE emailaddress=?",array(trim($data['6'])));

                    if($RS_u->RecordCount()>0)
					{

								$success_count = $success_count +1;
							   // echo "this user is already inserted";
								// --- For data entry in merchant_subscribe
								$user_id = $RS_u->fields['id'];
								$user_email = $RS_u->fields['emailaddress'];
								/*$Sql = "SELECT * FROM merchant_subscribs WHERE merchant_id='$_SESSION[merchant_id]' AND user_id='$user_id' AND group_id=".$inserted_grop_id;
								$RS_ms = $objDB->Conn->Execute($Sql);*/
			
								//$RS_ms = $objDB->Conn->Execute("SELECT * FROM merchant_subscribs WHERE merchant_id=? AND user_id=? AND group_id=?",array($_SESSION['merchant_id'],$user_id,$inserted_grop_id));
			
								// change2 remove merchant_subscribs table and check in merchant_group_detail if customer is in the custlist
								
								$RS_ms = $objDB->Conn->Execute("SELECT * FROM merchant_customerlist_detail mcd,merchant_customerlist mc WHERE mc.id= mcd.merchant_group_id and mc.merchant_id=? AND mcd.customer_id=? AND mc.id=?",array($_SESSION['merchant_id'],$user_id,$inserted_grop_id));
								
								if($RS_ms->RecordCount()<=0)
								{
								  
									
									/*$Sql = "INSERT INTO merchant_subscribs SET merchant_id='$_SESSION[merchant_id]', user_id='$user_id',group_id='$inserted_grop_id'";
									$objDB->Conn->Execute($Sql);*/
									
									//$objDBWrt->Conn->Execute("INSERT INTO merchant_subscribs SET merchant_id=?, user_id=?,group_id=?",array($_SESSION[merchant_id],$user_id,$inserted_grop_id));
									
									// change3 insert in merchant_group_detail with customer id
									
									$objDBWrt->Conn->Execute("INSERT INTO merchant_customerlist_detail SET customer_id=?,merchant_group_id=?",array($user_id,$inserted_grop_id));
								}
                                else
								{
                                    $duplicate_counter = $duplicate_counter + 1;
                                }
								
								$array_cust_invite = array();
								$array_cust_invite['customer_id'] = $user_id;
								$array_cust_invite['merchant_id'] = $_SESSION['merchant_id'];
								$RS_cust_invite = $objDB->Show("customer_invite_counter",$array_cust_invite);
								if($RS_cust_invite->RecordCount()>0)
								{
								}
								else
								{
									$array_ci = array();
									$array_ci['customer_id'] = $user_id;
									$array_ci['merchant_id'] = $_SESSION['merchant_id'];
									$array_ci['invite_counter'] = 0;
									$objDBWrt->Insert($array_ci, "customer_invite_counter");	
								}
				
                    }
					else
                    {
					
						$PasswordLib = new \PasswordLib\PasswordLib;
						
						$password = $data['0']."123";
					
					
						// This is for gender...
						if($data['5'] == "Male") $gender = 1; else $gender = 2;
							  
						$user_id=0; 
						if(email_test(trim($data['6'])))		 
                        {
                                    $success_count =$success_count +1;
									   
							$objDBWrt->Conn->Execute("INSERT INTO customer_user SET firstname=?, lastname=?, dob_year=?, dob_month=?,dob_day=?, gender=?, emailaddress=?, registered_date=?,is_registered=? ",array($data['0'],$data['1'],$data['2'],$data['3'],$data['4'],$gender,trim($data['6'],'Now()',0)));
							// --- For data entry in merchant_subscribe
							 $user_id = $objDB->Conn->Insert_ID();
							/*$Sql = "INSERT INTO merchant_subscribs SET merchant_id='$_SESSION[merchant_id]', user_id='$user_id',group_id='$inserted_grop_id'";
							$objDB->Conn->Execute($Sql);	*/
							
							//$objDBWrt->Conn->Execute("INSERT INTO merchant_subscribs SET merchant_id=?, user_id=?,group_id=?",array($_SESSION[merchant_id],$user_id,$inserted_grop_id));	
							
							// change4 insert in merchant_group_detail with customer id
							
							$objDBWrt->Conn->Execute("INSERT INTO merchant_customerlist_detail SET customer_id=?,merchant_group_id=?",array($user_id,$inserted_grop_id));
						}
						else
						{
							
								if(trim($data['0'])=="" && trim($data['1'])=="" && trim($data['2'])=="" && trim($data['3'])=="" && trim($data['4'])=="" && trim($data['5'])=="" && trim($data['6'])=="")
								{

								}
								else
								{
									$list = array($data['0'],$data['1'],$data['2'],$data['3'],$data['4'],$data['5'],$data['6']);
									array_push($stack,$list);
								}
                        }
				 
					
					
						$array_cust_invite = array();
						$array_cust_invite['customer_id'] = $user_id;
						$array_cust_invite['merchant_id'] = $_SESSION['merchant_id'];
						$RS_cust_invite = $objDB->Show("customer_invite_counter",$array_cust_invite);
						if($RS_cust_invite->RecordCount()>0)
						{
						}
						else
						{
							$array_ci = array();
							$array_ci['customer_id'] = $user_id;
							$array_ci['merchant_id'] = $_SESSION['merchant_id'];
							$array_ci['invite_counter'] = 0;
							$objDBWrt->Insert($array_ci, "customer_invite_counter");	
						}

                    }  // else
					
                      
				
                }
				
				if(count($stack) != 0)
			    {
					 $fp = fopen('ProblemOfCSV'.$merchant_id.'.csv', 'w');
					
					 $list = array (array("firstname","lastname","dob_year","dob_month","dob_day","gender","emailaddress"));
					 
					 foreach ($list as $fields) {
								fputcsv($fp, $fields);
							}
							foreach ($stack as $fields) {
								fputcsv($fp, $fields);
							}

							fclose($fp);
				}
            }
	 
			//  25 12 2014 delete file after insert records
			
			$dirname = $mechant_nm."_".$merchant_id;    
			$filename = ("upload/" . "$dirname" . "/");
			
			$userimp = $_REQUEST['hdn_csvfile'];// "upload/".$dirname."/".$_FILES["userImport"]["name"];       
			$userimp = addslashes($userimp);
			unlink($userimp);
			rmdir("upload/".$dirname); 
			
			//  25 12 2014 delete file after insert records
			
			 if(count($stack) == 0)
			   {
				   //$_SESSION['msg'] = "Distribution list successfully updated.";
				   //header("Location:".WEB_PATH."/merchant/manage-customers.php");
				   $_SESSION['msg'] = $merchant_msg['distributionlist']['Msg_distlist_added'];
				   //echo "added";
			          header("Location: ".WEB_PATH."/merchant/manage-customers.php");
					//exit();
			   }
			   else
			   {
				  $_SESSION['msg'] = "";
				  $value="1";
				   setcookie("csvfilecookie",$value);
				   /*$Sqleditid = "SELECT max(id) as id from merchant_groups where merchant_id=".$_SESSION['merchant_id'];
 
					$result_edit=$objDB->Conn->Execute($Sqleditid);*/
					$result_edit=$objDB->Conn->Execute("SELECT max(id) as id from merchant_customerlist where merchant_id=?",array($_SESSION['merchant_id']));

				
				   $_SESSION['dowload_err_msg'] = $success_count." records from the attach file were added successfully. ".(count($stack)+$duplicate_counter)." records of customers from attached file were not added due to missing, invalid or duplicate email address of customers. Please click here to download the affected records.";
				   header("Location:".WEB_PATH."/merchant/edit-distributionlist.php?id=".$result_edit->fields['id']);
				   
			   }
        }
        
    }        
        
}

//-- For import User  from Merchant and clone group
/******** 
@USE : copy distribution list
@PARAMETER : group_name,location_name,hdn_csvfile
@RETURN : json data
@USED IN PAGES : group_clone_distributionlist.php
*********/
if(isset($_REQUEST['Import_user_clone'])){
    $private=0;
     $clone_group = array();
             $clone_group['group_name'] = $_REQUEST["group_name"];
             $clone_group['location_id'] = $_REQUEST["location_name"];
              $clone_group['merchant_id'] = $_SESSION['merchant_id'];
              $clone_group['active'] = 1;
               $clone_group['private'] = 0;
               $lid = $_REQUEST["location_name"];
           $inserted_grop_id = $objDBWrt->Insert($clone_group, "merchant_groups");
    
    //$Sql = "INSERT INTO location_group SET group_name='".$_REQUEST["group_name"]."',location_id=".$_REQUEST["location_name"].",merchant_id='$_SESSION[merchant_id]',private=".$private."";
    //$objDB->Conn->Execute($Sql);
     
        $merchant_id =  $_SESSION['merchant_id'];
        /*$Sql = "SELECT * from merchant_user WHERE id='$merchant_id'";
        $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * from merchant_user WHERE id=?",array($merchant_id));
        if($RS->RecordCount()>0){
             $Row = $RS->FetchRow();
        }
		$mechant_business = $Row['business'];
		$business_icon = ASSETS_IMG."/m/icon/".$Row['merchant_icon'];
        $mechant_nm = $Row['firstname'];
        $mechant_lnm = $Row['lastname'];
        
    $dirname = $mechant_nm."_".$merchant_id;    
    $filename = ("upload/" . "$dirname" . "/");
  
    if (file_exists($filename)) {        
    } else {
        mkdir("upload/" . "$dirname", 0777);        
    }
$image_folder = "upload/".$dirname."/";
$uploaded = false;
        



//---- for clone  users as well as

/*$Sql = "SELECT * FROM merchant_subscribs WHERE merchant_id='$_SESSION[merchant_id]' AND group_id=".$_REQUEST['group_id'];

$RS_clone_users = $objDB->Conn->Execute($Sql);*/
$RS_clone_users = $objDB->Conn->Execute("SELECT * FROM merchant_subscribs WHERE merchant_id=? AND group_id=?",array($_SESSION[merchant_id],$_REQUEST['group_id']));

        if($RS_clone_users->RecordCount()>0){
            while($Row_u=$RS_clone_users->FetchRow())
            {
                /*$Sql_check = "SELECT * FROM merchant_subscribs WHERE merchant_id='$_SESSION[merchant_id]' AND user_id=".$Row_u['user_id']." AND group_id=".$inserted_grop_id;
                $RS_users_check = $objDB->Conn->Execute($Sql_check);*/
		$RS_users_check = $objDB->Conn->Execute("SELECT * FROM merchant_subscribs WHERE merchant_id=? AND user_id=? AND group_id=?",array($_SESSION[merchant_id],$Row_u['user_id'],$inserted_grop_id));
               
        if($RS_users_check->RecordCount()<=0){
                /*$Sql = "INSERT INTO merchant_subscribs SET merchant_id='$_SESSION[merchant_id]', user_id=".$Row_u['user_id'].",group_id=".$inserted_grop_id;
                $objDB->Conn->Execute($Sql);*/
		$objDBWrt->Conn->Execute("INSERT INTO merchant_subscribs SET merchant_id=?, user_id=?,group_id=?",array($_SESSION[merchant_id],$Row_u['user_id'],$inserted_grop_id));

                }
            }
        }
//---- if not uploaded any file
//        if($_FILES['userImport']['error'] != 0 ){
//
//
//            exit();
//        }
//----- for Input any CSv file
//if($_FILES['userImport']['error'] == 0 ){
//$up = move_uploaded_file($_FILES['userImport']['tmp_name'], $image_folder.$_FILES['userImport']['name']);

    if(1){
//$up = move_uploaded_file($_FILES['userImport']['tmp_name'], $image_folder.$_FILES['userImport']['name']);

    //
    //if($up){
    if(1){
        $uploaded = true;
        $userimp = $_REQUEST['hdn_csvfile'];// "upload/".$dirname."/".$_FILES["userImport"]["name"];       
        $userimp = addslashes($userimp);
        $handle = fopen($userimp, "r");  
        $success_count = 0;
            if($handle)
            {
		        $stack=array(); 
                for($i =1;($data = fgetcsv($handle, 10000, ",")) !== FALSE; $i++)
                {
		
                    if($i==1 )
                    continue;
                    
                    /*$Sql_s = "SELECT * from customer_user WHERE emailaddress='".trim($data['6'])."'";
                    $RS_u = $objDB->Conn->Execute($Sql_s);*/
			$RS_u = $objDB->Conn->Execute("SELECT * from customer_user WHERE emailaddress=?",array(trim($data['6'])));
                    if($RS_u->RecordCount()>0)
					{
						
						$success_count = $success_count +1;
                       // echo "this user is already inserted";
			// --- For data entry in merchant_subscribe
			$user_id = $RS_u->fields['id'];
			$user_email = $RS_u->fields['emailaddress'];
				/*$Sql = "SELECT * FROM merchant_subscribs WHERE merchant_id='$_SESSION[merchant_id]' AND user_id='$user_id' AND group_id=".$inserted_grop_id;
				$RS_ms = $objDB->Conn->Execute($Sql);*/
				$RS_ms = $objDB->Conn->Execute("SELECT * FROM merchant_subscribs WHERE merchant_id=? AND user_id=? AND group_id=?",array($_SESSION[merchant_id],$user_id,$inserted_grop_id));


				if($RS_ms->RecordCount()<=0){
				  
					
					/*$Sql = "INSERT INTO merchant_subscribs SET merchant_id='$_SESSION[merchant_id]', user_id='$user_id',group_id='$inserted_grop_id'";
					$objDB->Conn->Execute($Sql);*/
					$objDBWrt->Conn->Execute("INSERT INTO merchant_subscribs SET merchant_id=?, user_id=?,group_id=?",array($_SESSION[merchant_id],$user_id,$inserted_grop_id));
					
				}
                                else{
                                    if(trim($data['0'])=="" && trim($data['1'])=="" && trim($data['2'])=="" && trim($data['3'])=="" && trim($data['4'])=="" && trim($data['5'])=="" && trim($data['6'])=="")
                                        {

                                        }
                                        else{
                                          $list = array($data['0'],$data['1'],$data['2'],$data['3'],$data['4'],$data['5'],$data['6']);
                                              array_push($stack,$list);
                                        }
                                    $duplicate_counter = $duplicate_counter + 1;
                                }
                                /* CHECK WHETHER USER ASUBSCRIBE INTO STORE OR NOT */
                                //$Sql = "select * from subscribe"
//                                 $sql_chk ="select * from subscribed_stores where customer_id= ".$user_id." and location_id=". $lid;
//                                 echo $sql_chk.'======<br />';
//                          $subscibed_store_rs =$objDB->Conn->Execute($sql_chk);
//                          if($subscibed_store_rs->RecordCount()==0)
//                          {
//                              echo "1======";
//                               $insert_subscribed_store_sql ="insert into subscribed_stores set customer_id= ".$user_id." ,location_id=".$lid." ,subscribed_date='".date('Y-m-d H:i:s')."' ,subscribed_status=1";
//                                echo $insert_subscribed_store_sql;
//                                $objDB->Conn->Execute($insert_subscribed_store_sql);
//                          }
                                /* CHECK WHETHER USER ASUBSCRIBE INTO STORE OR NOT */
								
							$array_cust_invite = array();
							$array_cust_invite['customer_id'] = $user_id;
							$array_cust_invite['merchant_id'] = $_SESSION['merchant_id'];
							$RS_cust_invite = $objDB->Show("customer_invite_counter",$array_cust_invite);
							if($RS_cust_invite->RecordCount()>0)
							{
							}
							else
							{
								$array_ci = array();
								$array_ci['customer_id'] = $user_id;
								$array_ci['merchant_id'] = $_SESSION['merchant_id'];
								$array_ci['invite_counter'] = 0;
								$objDBWrt->Insert($array_ci, "customer_invite_counter");	
							}		
			// ---
                    }
					else
                    {
					$PasswordLib = new \PasswordLib\PasswordLib;
                    $password = $data['0']."123";
		    // This is for gender...
		    if($data['5'] == "Male") $gender = 1; else $gender = 2;
                  //  $Sql = "INSERT INTO customer_user SET firstname='".$data['0']."', lastname='".$data['1']."', dob_year='".$data['2']."', dob_month='".$data['3']."', 
			//			dob_day='".$data['4']."', gender=".$gender.", emailaddress='".$data['6']."', password='".md5($password)."', emailnotification=".$data['7'].", registered_date='".$data['8']."', lastvisit_date='".$data['9']."', active=".$data['10'].", ruserid=".$data['11'].", current_location='".$data['12']."'";
			    
				$user_id=0;    
				if(email_test(trim($data['6'])))		 
                                    {
                                    $success_count =$success_count +1;
                               //     echo trim($data['0'])."===".trim($data['1'])."===".trim($data['2'])."===".trim($data['3'])."===".trim($data['4'])."===".trim($data['5'])."===".trim($data['6'])."--<br/>";
				// if (filter_var(trim($data['6']), FILTER_VALIDATE_EMAIL)) {
				 
				     //$Sql = "INSERT INTO customer_user SET firstname='".$data['0']."', lastname='".$data['1']."', dob_year='".$data['2']."', dob_month='".$data['3']."', 
						//dob_day='".$data['4']."', gender=".$gender.", emailaddress='".$data['6']."', password='".md5($password)."', registered_date=Now() ,active='1' ";
					/*$Sql = "INSERT INTO customer_user SET firstname='".$data['0']."', lastname='".$data['1']."', dob_year='".$data['2']."', dob_month='".$data['3']."', 
						dob_day='".$data['4']."', gender=".$gender.", emailaddress='".trim($data['6'])."', registered_date=Now(),is_registered='0' ";	
						
					$objDB->Conn->Execute($Sql);*/
					$objDBWrt->Conn->Execute("INSERT INTO customer_user SET firstname=?, lastname=?, dob_year=?, dob_month=?, dob_day=?, gender=?, emailaddress=?, registered_date=?,is_registered=? ",array($data['0'],$data['1'],$data['2'],$data['3'],$data['4'],$gender,trim($data['6']),'Now()',0));
					// --- For data entry in merchant_subscribe
					 $user_id = $objDB->Conn->Insert_ID();
					/*$Sql = "INSERT INTO merchant_subscribs SET merchant_id='$_SESSION[merchant_id]', user_id='$user_id',group_id='$inserted_grop_id'";
					$objDB->Conn->Execute($Sql);*/
					$objDBWrt->Conn->Execute("INSERT INTO merchant_subscribs SET merchant_id=?, user_id=?,group_id=?",array($_SESSION[merchant_id],$user_id,$inserted_grop_id));		
				 }
				 else
				 {
                                    // echo trim($data['0'])."===".trim($data['1'])."===".trim($data['2'])."===".trim($data['3'])."===".trim($data['4'])."===".trim($data['5'])."===".trim($data['6'])."---<br/>";
                                        if(trim($data['0'])=="" && trim($data['1'])=="" && trim($data['2'])=="" && trim($data['3'])=="" && trim($data['4'])=="" && trim($data['5'])=="" && trim($data['6'])=="")
                                        {

                                        }
                                        else{
                                          $list = array($data['0'],$data['1'],$data['2'],$data['3'],$data['4'],$data['5'],$data['6']);
                                              array_push($stack,$list);
                                        }
                                }
				 
				//echo $Sql."<hr>";
				//echo "<br /><hr><br />".$Sql."<br /><hr><br />";
				
                                
                                /* CHECK WHETHER USER ASUBSCRIBE INTO STORE OR NOT */
                                //$Sql = "select * from subscribe"
//                                 $sql_chk ="select * from subscribed_stores where customer_id= ".$user_id." and location_id=". $lid;
//                               
//                          $subscibed_store_rs =$objDB->Conn->Execute($sql_chk);
//                          if($subscibed_store_rs->RecordCount()==0)
//                          {
//                              
//                               $insert_subscribed_store_sql ="insert into subscribed_stores set customer_id= ".$user_id." ,location_id=".$lid." ,subscribed_date='".date('Y-m-d H:i:s')."' ,subscribed_status=1";
//                             
//                                $objDB->Conn->Execute($insert_subscribed_store_sql);
//                          }
                                /* CHECK WHETHER USER ASUBSCRIBE INTO STORE OR NOT */
                                
				// ---

							$array_cust_invite = array();
							$array_cust_invite['customer_id'] = $user_id;
							$array_cust_invite['merchant_id'] = $_SESSION['merchant_id'];
							$RS_cust_invite = $objDB->Show("customer_invite_counter",$array_cust_invite);
							if($RS_cust_invite->RecordCount()>0)
							{
							}
							else
							{
								$array_ci = array();
								$array_ci['customer_id'] = $user_id;
								$array_ci['merchant_id'] = $_SESSION['merchant_id'];
								$array_ci['invite_counter'] = 0;
								$objDBWrt->Insert($array_ci, "customer_invite_counter");	
							}				
				
                    }            
                    //echo "<pre>"; print_r($data); echo "</pre>";exit;    
				
                }
				
				if(count($stack) != 0)
			    {
					 $fp = fopen('ProblemOfCSV'.$merchant_id.'.csv', 'w');
					
					 $list = array (array("firstname","lastname","dob_year","dob_month","dob_day","gender","emailaddress"));
					 
					 foreach ($list as $fields) {
								fputcsv($fp, $fields);
							}
							foreach ($stack as $fields) {
								fputcsv($fp, $fields);
							}

							fclose($fp);
				}
            }
	 
	   
            //  25 12 2014 delete file after insert records
			
			$dirname = $mechant_nm."_".$merchant_id;    
			$filename = ("upload/" . "$dirname" . "/");
			
			$userimp = $_REQUEST['hdn_csvfile'];// "upload/".$dirname."/".$_FILES["userImport"]["name"];       
			$userimp = addslashes($userimp);
			unlink($userimp);
			rmdir("upload/".$dirname); 
			
			//  25 12 2014 delete file after insert records
			
			 if(count($stack) == 0)
			   {
				   //$_SESSION['msg'] = "Distribution list successfully updated.";
				   //header("Location:".WEB_PATH."/merchant/manage-customers.php");
				   $_SESSION['msg'] = $merchant_msg['distributionlist']['Msg_distlist_added'];
				   header("Location: ".WEB_PATH."/merchant/manage-customers.php");
					//exit();
			   }
			   else
			   {
				  $_SESSION['msg'] = "";
				  $value="1";
				   setcookie("csvfilecookie",$value);
				   /*$Sqleditid = "SELECT max(id) as id from merchant_groups where merchant_id=".$_SESSION['merchant_id'];
 
					$result_edit=$objDB->Conn->Execute($Sqleditid);*/
					$result_edit=$objDB->Conn->Execute("SELECT max(id) as id from merchant_groups where merchant_id=?",array($_SESSION['merchant_id']));
				
				   $_SESSION['dowload_err_msg'] = $success_count." records from the attach file were added successfully. ".(count($stack)+$duplicate_counter)." records of customers from attached file were not added due to missing, invalid or duplicate email address of customers. Please click here to download the affected records.";
				   header("Location:".WEB_PATH."/merchant/edit-distributionlist.php?id=".$result_edit->fields['id']);
				   
			   }
        }
        
    } 		   
}

//---------
/* start of PAY-508-28033 */
/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['px-submit']))
{ 
$array = $json_array = array();
$array['merchant_id'] = $_SESSION['merchant_id'];
$array['created_date'] = date("Y-m-d H:i:s");
$array['image'] = $_FILES['userfile']['name'];
$array['image_type'] = $_REQUEST['img_type'];
$objDBWrt->Insert($array, "merchant_media");
}
/* end of PAY-508-28033*/

/* start of T_5 */
/******** 
@USE : to cancel event
@PARAMETER : hdn_redirectpath
@RETURN : redirect to page
@USED IN PAGES : edit-location.php,add-group.php,edit-group.php,add-user.php,edit-user.php,add-location.php,edit-template.php,edit-customer.php,add-template.php,customize-template.php,merchant-setup.php,edit-location-detail.php,add-location-detail.php
*********/
if(isset($_REQUEST['btnCancel']))
{
	header("Location: ".$_REQUEST['hdn_redirectpath']);
}
/* end of T_5 */

// ---- for customer list edit
/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnEditCustomer']))
{
	$json_array = array();
	$update_array = array();
	
	$all_groups = $_REQUEST['user_group'];
	$mer_id="";
	if(isset($_REQUEST['mer_id']))
	{
		$mer_id = $_REQUEST['mer_id'];
	}
	else
	{
		$mer_id = $_SESSION['merchant_id'];
	}
	
	/*$Sql = "DELETE  FROM merchant_subscribs where user_id='$_REQUEST[customerid]' AND merchant_id='$mer_id'";
	$objDB->Conn->Execute($Sql);*/
	$objDBWrt->Conn->Execute("DELETE  FROM merchant_subscribs where user_id=? AND merchant_id=?",array($_REQUEST[customerid],$mer_id));
	
	if(count($all_groups) == 0)
	{
		/*$Sql = "INSERT INTO merchant_subscribs SET user_id='$_REQUEST[customerid]' , merchant_id='$mer_id'";
		$objDB->Conn->Execute($Sql);*/
		$objDBWrt->Conn->Execute("INSERT INTO merchant_subscribs SET user_id=? , merchant_id=?",array($_REQUEST[customerid],$mer_id));
	
	}
	
	if(isset($_REQUEST['mer_id']))
	{
		$user_group = $_REQUEST['user_group_iphone'];
		$all_groups = explode(",",$user_group);
	}
	for($i=0;$i<count($all_groups);$i++)
	{
	
		//$update_array['group_id'] = serialize($_REQUEST['user_group']);
		$update_array['group_id'] = $all_groups[$i];
		$update_array['merchant_id'] = $mer_id;
		$update_array['user_id'] = $_REQUEST['customerid'];
		$objDBWrt->Insert($update_array, "merchant_subscribs");
	}
	
	// for subscribed_stores
	
	$all_locations = $_REQUEST['location_subscribe'];
	
	/*$Sql = "DELETE  FROM subscribed_stores where customer_id='$_REQUEST[customerid]' ";
	$objDB->Conn->Execute($Sql);*/
	$objDBWrt->Conn->Execute("DELETE  FROM subscribed_stores where customer_id=? ",array($_REQUEST[customerid]));
	
	for($i=0;$i<count($all_locations);$i++)
	{
		//echo "iterating";
		$arr = array();
		$arr['customer_id'] = $_REQUEST['customerid'];
		$arr['location_id'] = $all_locations[$i];
		$arr['subscribed_date'] = date("Y-m-d H:i:s") ;
		$objDBWrt->Insert($arr, "subscribed_stores");
		
	}
	
	// 369
	$_SESSION['msg']= "Customer Has Been Updated Successfully";
	$json_array['status'] = "true";
	$json_array['message'] = "Customer Has Been Updated Successfully";
	$json = json_encode($json_array);
	echo $json;
	exit();
	
	// 369
	
	
	
}

// ---

// --- for download csv
/******** 
@USE : download csv file
@PARAMETER : 
@RETURN : 
@USED IN PAGES : group_clone_distributionlist.php,edit-distributionlist.php,import-customers.php
*********/
if(isset($_REQUEST['download_csv']))
{
    header('Content-Type: application/csv');
    header('Content-Disposition: attachment; filename=sample_csv.csv');
    header('Content-Transfer-Encoding: binary');
    header('Expires: 0');
   // header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
    header('Pragma: public');
    header('Content-Length: ' . filesize(ASSETS.'/sample_csv.csv'));
    ob_clean();
    flush();
	
    readfile(ASSETS.'/sample_csv.csv');
  
}

/******** 
@USE : download csv problem file
@PARAMETER : 
@RETURN : 
@USED IN PAGES : group_clone_distributionlist.php,edit-distributionlist.php,import-customers.php
*********/
if(isset($_REQUEST['download_csv_problem']))
{
    $merchant_id =  $_SESSION['merchant_id'];
    header('Content-Type: application/csv');
    header('Content-Disposition: attachment; filename=ProblemOfCSV'.$merchant_id.'.csv');
    header('Content-Transfer-Encoding: binary');
    header('Expires: 0');
   // header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
    header('Pragma: public');
    header('Content-Length: ' . filesize('ProblemOfCSV'.$merchant_id.'.csv'));
    ob_clean();
    flush();
	
    readfile('ProblemOfCSV'.$merchant_id.'.csv');
	unlink('ProblemOfCSV'.$merchant_id.'.csv');
  
}


// ----- For redeem coupon
/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btn_submit']))
{
    
	 $st = false;
	$json_array = array();
       
    if($_REQUEST['txt_barcode'] != "")
	{
        
				
		/*$Sql = "SELECT * FROM coupon_codes where coupon_code='".$_REQUEST['txt_barcode']."'";			
		$RS = $objDB->Conn->Execute($Sql);*/
		$RS = $objDB->Conn->Execute("SELECT * FROM coupon_codes where coupon_code=?",array($_REQUEST['txt_barcode']));
		//echo $RS->fields['customer_campaign_code'];
                
		//echo $RS->RecordCount()."mara data che";
              if($RS->RecordCount() > 0)
              {
		if($_SESSION['merchant_info']['merchant_parent'] == 0)
		{
             
			$arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
			$ids=  implode(",", $arr_ids);
            
			if($ids=="")
				$ids=$_SESSION['merchant_id'];
			
			/*$Sql = "SELECT * FROM campaigns cp WHERE cp.id=".$RS->fields['customer_campaign_code']." and (cp.created_by = '$_SESSION[merchant_id]' or cp.created_by in (".$ids."))";
			
                        $RS = $objDB->Conn->Execute($Sql);*/
			$RS = $objDB->Conn->Execute("SELECT * FROM campaigns cp WHERE cp.id=? and (cp.created_by =? or cp.created_by in (?))",array($RS->fields['customer_campaign_code'],$_SESSION[merchant_id],$ids));
                                          
			if($RS->RecordCount()<=0)
			{
				$json_array['status'] = "false";
				//$json_array['message'] = "This coupon is not for this store.";

				$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_different_merchant"];

				$json = json_encode($json_array);
				echo $json;
				return $json;
				exit;
			}
             
		}
                
		else
		{
			//$Sql = "SELECT * FROM campaigns cp WHERE cp.id=".$RS->fields['customer_campaign_code']." and cp.created_by = '$_SESSION[merchant_id]'";
			
			//04 10 2013
			
			/*$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
						FROM coupon_codes c, campaigns cp WHERE c.active =1 and 
						c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code  and c.location_id in
							(select id from locations where active =1 )  and  cp.id in 
							(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
							mur.merchant_user_id = ".$_SESSION[merchant_id]." and cl.location_id = mur.location_access and c.location_id=mur.location_access) ";
			
				
			//04 10 2013
			
			$RS = $objDB->Conn->Execute($Sql);*/
			$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
						FROM coupon_codes c, campaigns cp WHERE c.active =? and 
						c.coupon_code=? and cp.id=c.customer_campaign_code  and c.location_id in
							(select id from locations where active =? )  and  cp.id in 
							(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
							mur.merchant_user_id =? and cl.location_id = mur.location_access and c.location_id=mur.location_access) ",array(1,$_REQUEST['txt_barcode'],1,$_SESSION[merchant_id]));

			if($RS->RecordCount()<=0)
			{
				$json_array['status'] = "false";
				//$json_array['message'] = "This coupon is not for this store.";
				
				$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_different_location"];
				
				$json = json_encode($json_array);
				echo $json;
				return $json;
				exit;
			}
		}
                
		
		if($_SESSION['merchant_info']['merchant_parent'] == 0)
		{
			// to redeem all child coupon
			$arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
			 $ids=  implode(",", $arr_ids);
		
			 if($ids=="")
				$ids=$_SESSION['merchant_id'];
			// 	to redeem all child coupon
			
			//$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE start_date<='$date_f' AND expiration_date >='$date_f' AND visible='1' AND id =".$RS->fields['customer_campaign_code'] ." AND (created_by = '$_SESSION[merchant_id]' or created_by in ( select id from merchant_user where merchant_parent = ". $_SESSION[merchant_id] ." ))";
			
			//$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =1 ) and (cp.created_by = '$_SESSION[merchant_id]' or cp.created_by in ( select id from merchant_user where merchant_parent = ". $_SESSION[merchant_id] ." ))";
			
			// change query for all child 
			//$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =1 ) and (cp.created_by = '$_SESSION[merchant_id]' or cp.created_by in (".$ids."))";
			// change query for all child 
			$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =? and c.coupon_code=? and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =? ) and (cp.created_by = ? or cp.created_by in (?))",array(1,$_REQUEST['txt_barcode'],1,$_SESSION[merchant_id],$ids));
		}
		else
		{
				
			if(isset($_COOKIE['merchant_'.$_SESSION['merchant_id']]))
			{
				if($_COOKIE['merchant_'.$_SESSION['merchant_id']] ==  "")
				{
				   $Where_miles = "";	  
				}
				else
				{
					$lnglat = $_COOKIE['merchant_'.$_SESSION['merchant_id']];
					$lnglat_arr = explode(";",$lnglat);
			//        $curr_longitude = $lnglat_arr[1];
			//        $curr_latitude = $lnglat_arr[0];
						$curr_latitude = 43.64953;
							$curr_longitude = -79.37043;
					 $miles = 2000 * 0.00062137;
				$Where_miles = " or 
						cp.id in (select cl.campaign_id from campaign_location cl , locations l where 
								(((acos(sin((".$curr_latitude."*pi()/180)) * 
						sin((`latitude`*pi()/180))+cos((".$curr_latitude."*pi()/180)) * 
						cos((`latitude`*pi()/180)) * cos((((".$curr_longitude.")- `longitude`)* 
						pi()/180))))*180/pi())*60*1.1515
					) <=".$miles." and l.id=c.location_id) " ;	
				}
			}
			else
			{
				 $miles = 200 * 0.00062137;
				$Where_miles = "";	   
			}
			/*$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
						FROM coupon_codes c, campaigns cp WHERE c.active =1 and 
						c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code  and c.location_id in
							(select id from locations where active =1 )  and ( cp.id in 
							(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
							mur.merchant_user_id = ".$_SESSION[merchant_id]." and cl.location_id = mur.location_access ) ".$Where_miles." )";*/
			$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
						FROM coupon_codes c, campaigns cp WHERE c.active =? and 
						c.coupon_code=? and cp.id=c.customer_campaign_code  and c.location_id in
							(select id from locations where active =? )  and ( cp.id in 
							(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
							mur.merchant_user_id =? and cl.location_id = mur.location_access ) ".$Where_miles." )",array(1,$_REQUEST['txt_barcode'],1,$_SESSION[merchant_id]));

		}
		
		//$RS = $objDB->Conn->Execute($Sql);
		if($RS->RecordCount()<=0){
			$json_array['status'] = "false";
			//$json_array['message'] = "This coupon is not for this store.";
			$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_voucher_code_not_valid"];
			$json = json_encode($json_array);
			echo $json;
			return $json;
			
		}
		else
		{
			//$dt_wh = " CONVERT_TZ(NOW(),'+00:00','+00:00') BETWEEN CONVERT_TZ(start_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) AND CONVERT_TZ(expiration_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) ";
                      //$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."','+00:00') BETWEEN CONVERT_TZ(c.start_date,'+00:00',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) AND CONVERT_TZ(c.expiration_date,'+00:00',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))"; 
                    $date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN  c.start_date AND c.expiration_date   and cl.active_in_future<>1"; 
			$date_f = date("Y-m-d H:i:s");
			/*$Sql = "SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible='1' AND c.id =".$RS->fields['customer_campaign_code']." and l.id =".$RS->fields['location_id'];
			
			$RS_t = $objDB->Conn->Execute($Sql);*/
			$RS_t = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible=? AND c.id =? and l.id =?",array(1,$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

			if($RS_t->fields['total'] == 0)
			{
				$json_array['status'] = "false";
				$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_campaign_expire"];
				$json = json_encode($json_array);
				echo $json;
				return $json;
			}else{
                             $sharing_msg = ".";
				/*$Sql = "SELECT number_of_use, redeem_rewards FROM campaigns WHERE id =".$RS->fields['customer_campaign_code'];
				$RS_camp_detail = $objDB->Conn->Execute($Sql);*/
				$RS_camp_detail = $objDB->Conn->Execute("SELECT number_of_use, redeem_rewards FROM campaigns WHERE id =?",array($RS->fields['customer_campaign_code']));

				//-- start for point deduction
						$array_where_user = array();
						$array_where_user['id'] = $_SESSION['merchant_id'];
						$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
						$m_parent = $RS_merchant_User->fields['merchant_parent'];
						//if($RS_User->fields['merchant_parent'] == 0)
						if($RS_merchant_User->fields['merchant_parent'] == 0)
						{
							$merchant_id = $_SESSION['merchant_id'];
						}
						else
						{
							$merchant_id = $RS_merchant_User->fields['merchant_parent'];
						}
						
						$array_where_user = array();
						$array_where_user['id'] = $merchant_id;
						$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
				//-- End of point deduction
                                           
				if($RS_camp_detail->fields['number_of_use'] == 1)
				{
					/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']. " and location_id=".$RS->fields['location_id'];
					$RS_user_exist = $objDB->Conn->Execute($Sql);*/
					$RS_user_exist = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(0,$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

					if($RS_user_exist->RecordCount() == 0){
						$st = true;
                                                /* Don't give point if max nof sharing rich */
						
						 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
						// echo $Sql_shared ;
							 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
							$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));
				
							 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] ){
						
								/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
								$RS_referral_customer = $objDB->Conn->Execute($Sql);/*/
								$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

								if($RS_referral_customer->RecordCount() != 0)
								{
									$where = array();
									$where['referred_customer_id'] = $RS->fields['customer_id'];
									$where['campaign_id'] = $RS->fields['customer_campaign_code'];
									$where['referral_reward'] = 0;
									$where['location_id'] = $RS->fields['location_id'];
									
									$u_array = array();
									if(($RS->fields['block_point']-$RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
									{
										//$u_array['referral_reward'] = $RS->fields['referral_rewards'];
                                                                            $sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
                                                                        }
                                                                        else{
                                                                             $sharing_msg = ".";
                                                                        }
																		
								}
							 }
						/* Don't give point if max nof sharing rich */
						if($RS->fields['block_point'] < $RS_camp_detail->fields['redeem_rewards'])
						{
							$json_array['point_message'] = "Customer will earn O points.";
						}
						else
						{
							$json_array['point_message'] = "Customer will earn ".$RS_camp_detail->fields['redeem_rewards']." scanflip points".$sharing_msg;
						}
						$json_array['status'] = "true";
						$json_array['id'] = $RS->fields['customer_campaign_code'];
						$json_array['message'] = "";
						$json = json_encode($json_array);
						echo $json;
						return $json;
					}
					else{
						$json_array['status'] = "false";
						$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_campaign_already_redeemed"];
						$json = json_encode($json_array);
						echo $json;
						return $json;
					}
				}
				else if($RS_camp_detail->fields['number_of_use'] == 2)
				{
//                                    $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
//                                    $RS_2_use = $objDB->Conn->Execute($Sql_2_use);
//                                    if($RS_2_use->RecordCount() >0){
                                        /* $location_max_sql = "Select num_activation_code , offers_left from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
         $location_max = $objDB->Conn->Execute($location_max_sql);*/
		$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));

           $max_coupon = $location_max->fields['num_activation_code'];
           $o_left = $location_max->fields['offers_left'];
                                //    }
           $flag_redeem =1;
          // $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
            /*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
                                    $RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
				$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

                                    if($RS_2_use->RecordCount() <=0){
                                        $flag_redeem =0;
                                }
//                                while($loopcouponid=$Sql_2_use->FetchRow())
//                                {
//                                    $r_coupon_id = $loopcouponid['coupon_id'];
//                                }
                                    if($o_left>0 || $flag_redeem==0)
                                    {
                                       
				//	$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code'] ." and  DATE_FORMAT(reward_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  and location_id=".$RS->fields['location_id'];
                                        /*$Sql = "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  ";
					
                                        $RS_user_exist = $objDB->Conn->Execute($Sql);*/
					$RS_user_exist = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  =? ",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id'],date('Y-m-d')));
                                       
					if($RS_user_exist->RecordCount() == 0){
						$st = true;
                                                 /* Don't give point if max nof sharing rich */
						
						 $Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
						// echo $Sql_shared ;
							 $RS_shared = $objDB->Conn->Execute($Sql_shared);
				
							 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] ){
						
								/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
												
								$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
								$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ? AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

								if($RS_referral_customer->RecordCount() != 0)
								{
									$where = array();
									$where['referred_customer_id'] = $RS->fields['customer_id'];
									$where['campaign_id'] = $RS->fields['customer_campaign_code'];
									$where['referral_reward'] = 0;
									$where['location_id'] = $RS->fields['location_id'];
									
									$u_array = array();
									if(($RS->fields['block_point']-$RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
									{
										//$u_array['referral_reward'] = $RS->fields['referral_rewards'];
                                                                            $sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
                                                                        }
                                                                        else{
                                                                             $sharing_msg = ".";
                                                                        }
																		
								}
							 }
						/* Don't give point if max nof sharing rich */
						if($RS->fields['block_point'] < $RS_camp_detail->fields['redeem_rewards'])
						{
							$json_array['point_message'] = "Customer will earn O scanflip points.";
						}
						else
						{
							$json_array['point_message'] = "Customer will earn ".$RS_camp_detail->fields['redeem_rewards']." scanflip points".$sharing_msg;
						}
						$json_array['status'] = "true";
						$json_array['id'] = $RS->fields['customer_campaign_code'];
						$json_array['message'] = "";
						$json = json_encode($json_array);
						echo $json;
						return $json;
					}
					else{
                                            $msg = "Sorry!  This voucher is already redeemed today by customer at ".date("g:i A", strtotime($RS_user_exist->fields['redeem_date'])) ." . Offer Limit : 1 per customer per day";
						$json_array['status'] = "false";
						$json_array['message'] = $msg ;
						$json = json_encode($json_array);
						echo $json;
						return $json;
					}
                                    }else{
						$json_array['status'] = "false";
						$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_no_offer_available"];
                                               
						$json = json_encode($json_array);
						echo $json;
						return $json;
					}
					
				}
				else if($RS_camp_detail->fields['number_of_use'] == 3)
				{
                                                     /*$location_max_sql = "Select num_activation_code , offers_left from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
                                                $location_max = $objDB->Conn->Execute($location_max_sql);*/
						$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));

                                                  $max_coupon = $location_max->fields['num_activation_code'];
                                                  $o_left = $location_max->fields['offers_left'];
                                //    }
                                   $flag_redeem =1;
      //     $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
            /* $Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
                                    $RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
					
$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));
                                    if($RS_2_use->RecordCount() <=0){
                                        $flag_redeem =0;
                                }
                                    if($o_left>0 || $flag_redeem==0)
                                    {
					$st = true;
                                          /* Don't give point if max nof sharing rich */
						
						/* $Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
							 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
							$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));

							 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] ){
						
								/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
													
								$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
								$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

								if($RS_referral_customer->RecordCount() != 0)
								{
									$where = array();
									$where['referred_customer_id'] = $RS->fields['customer_id'];
									$where['campaign_id'] = $RS->fields['customer_campaign_code'];
									$where['referral_reward'] = 0;
									$where['location_id'] = $RS->fields['location_id'];
									
									$u_array = array();
									if(($RS->fields['block_point'] - $RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
									{
										//$u_array['referral_reward'] = $RS->fields['referral_rewards'];
                                                                            $sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
                                                                        }
                                                                        else{
                                                                             $sharing_msg = ".";
                                                                        }
																		
								}
							 }
						/* Don't give point if max nof sharing rich */
					if($RS->fields['block_point'] < $RS_camp_detail->fields['redeem_rewards'])
						{
							$json_array['point_message'] = "Customer will earn O scanflip points.";
						}
						else
						{
							$json_array['point_message'] = "Customer will earn ".$RS_camp_detail->fields['redeem_rewards']." scanflip points".$sharing_msg ;
						}
						
					$json_array['status'] = "true";
                                        $json_array['loginstatus'] = "true";
					$json_array['id'] = $RS->fields['customer_campaign_code'];
					$json_array['message'] = "";
					$json = json_encode($json_array);
					echo $json;
					return $json;
                                    }
                                    else{
                                                $json_array['loginstatus'] = "true";
						$json_array['status'] = "false";
						$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_no_offer_available"];
                                               
						$json = json_encode($json_array);
						echo $json;
						return $json;
					}
				}
				
				
			}
		}
        }
        else // Wrong data
        {
             $json_array['loginstatus'] = "true";
            $json_array['status'] = "false";
            $json_array['message'] = $merchant_msg["redeem-deal"]["Msg_coupon_code_not_exist"];
            $json = json_encode($json_array);
            echo $json;
            return $json;
        } 
      }else
      {
          $json_array['loginstatus'] = "true";
	$json_array['status'] = "false";
	$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_enter_proper_coupon_code"];
	$json = json_encode($json_array);
	echo $json;
	return $json;
      }
        		  

    
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btn_campaign_detail']))
{
	  
    $array = array();
    $array['id'] = $_REQUEST['id'];
   $RS = $objDB->Show("campaigns",$array);
    
    /*$Sql = "SELECT c.*,u.firstname, u.id uid , u.lastname  FROM coupon_codes c , customer_user u WHERE c.coupon_code='".$_REQUEST['coupon_code']."' and u.id=c.customer_id";
    $RS_userinfo = $objDB->execute_query($Sql);*/
	$RS_userinfo = $objDB->Conn->Execute("SELECT c.*,u.firstname, u.id uid , u.lastname  FROM coupon_codes c , customer_user u WHERE c.coupon_code=? and u.id=c.customer_id",array($_REQUEST['coupon_code']));
    
    $array = array();
    $array['campaign_id'] = $_REQUEST['id'];
    $RSCode = $objDB->Show("activation_codes",$array);
    
   /* $Sql = "SELECT * FROM locations l WHERE l.id IN (SELECT cl.location_id FROM campaign_location cl WHERE cl.campaign_id = ".$_REQUEST['id']." ) ";
    $RS_locations =  $objDB->execute_query($Sql);*/
	$RS_locations =  $objDB->Conn->Execute("SELECT * FROM locations l WHERE l.id IN (SELECT cl.location_id FROM campaign_location cl WHERE cl.campaign_id =? ) ",array($_REQUEST['id']));

	?>
	 
	 <input type="hidden" id="hdn_coupon_code" name="hdn_coupon_code" value="<?=$_REQUEST['coupon_code']?>" />
    
   <div>&nbsp;Update Customer Total Sales $: <input type="text" value="<?php echo $RS->fields['deal_value']; ?>" name="txt_redeem_deal_value" id="txt_redeem_deal_value" />
       <input type="submit" value="Redeem" name="btn_redeem" id="btn_redeem" />&nbsp;&nbsp;
       <input type="button" value="Cancel" name="btn_cancle" id="btn_cancle" onclick="window.location.href=window.location.href;" />
   </div>
         <h2>Campaign Detail</h2>
<div class="mer_chant">
                  <div class="mer_chant_div">
			<div class="dealDetailDiv">
			<div class="detail" style="position: relative;">
		     <table width="100%">
			<tr>
				<td align="left" width="50%" valign="top">
				   <div id="dealslist">
				      <div class="offersexyellow">
					 <div id="campaign_detail"><div class="dealtitle" style="margin:10px;">
								<b>Customer : </b>
								<?=$RS_userinfo->fields['firstname']." ".$RS_userinfo->fields['lastname']?>
							</div>
							<div class="dealtitle" style="margin:10px;">
								<b>Customer Status : </b>
								<?php
                                                                
                                                                 $sql_chk ="select * from coupon_redeem where coupon_id in( select id from coupon_codes where customer_id=".$RS_userinfo->fields['uid']." and location_id=".$RS_userinfo->fields['location_id'].") ";
                                                                $Rs_is_new_customer=$objDB->Conn->Execute($sql_chk);
                                                                if($Rs_is_new_customer->RecordCount()==0)
                                                                {
                                                                    echo "New User";
                                                                }
                                                                else {
                                                                    echo "Existing User";
                                                                }
                                                                ?>
                                                                
							</div>
<!--						<div class="percetage" style="">
							<span><?=$RS->fields['title']?></span>
							
							
							
							
						</div>-->
						
						<div style="overflow:hidden;width:900px;padding-top: 10px;border-top: 1px solid grey;">
						   <div class="other_details" style="float:left;padding-left: 10px;width:62%;">
                                                       
							<div class="percetage" style="">
							<span><?=$RS->fields['title']?></span>
                                                        
						</div>
						    <div class="offers_wrapper">
							<div class="dealdt2">
								<b>Redeem point :</b>
								<span><?=$RS->fields['redeem_rewards']?></span>
							</div>
							<div class="dealdt3">
								<b>Sharing point :</b>
								<span><?=$RS->fields['referral_rewards']?></span>
							</div>
						    </div>
						    <div class="counter" style="clear:both">
							<div style="clear:both;margin:10px;">
								<div>
								<b>Start Date : </b>
								<?=date("Y-m-d g:i:s A",strtotime($RS->fields['start_date']));?>
								</div>
							</div>
							<div style="clear:both;margin:10px;">
								<div>
								<b>Expiration Date : </b>
								<?=date("Y-m-d g:i:s A",strtotime($RS->fields['expiration_date']));?>
								</div>
							</div>
							<div style="margin:10px;">
								<b>Number of use : </b>
								<?php if($RS->fields['number_of_use'] == 1) { echo "One Per Customer";}else if($RS->fields['number_of_use'] == 2){echo "One Per Customer Per Day";}else if($RS->fields['number_of_use'] == 3){ echo "Redeem Points Per Visit";}?>
							</div>
							<?php
							$address = $RS_locations->fields['address'].", ".$RS_locations->fields['city'].", ".$RS_locations->fields['state'].", ".$RS_locations->fields['zip'].", ".$RS_locations->fields['country'];
							?>
							<div style="margin:10px;width:446px">
								<b>Location Address:</b>
								<?php echo $address; ?>
							</div>
							<div style="margin:10px;width:446px">
								<b>Campaign Description :</b>
								<?=$RS->fields['description']?>
							</div>
							<div style="margin:10px;">
								<b>Coupon generated date :</b>
								<?=date("Y-m-d g:i:s A",strtotime($RS_userinfo->fields['generated_date']));?>
							</div>
							<div style="margin:10px;">
								<b>Created Date :</b>
								<?=date("Y-m-d g:i:s A",strtotime($RS->fields['created_date']));?>
							</div>
							
							
						
						    </div>
						   </div>
						   
						   <p class="image_det">
							<?php 
							 if($RS->fields['business_logo']!="")
							{
							    $img_src=ASSETS_IMG."/m/campaign/".$RS->fields['business_logo']; 
							}
						      
							else 
							{
							    $img_src=ASSETS_IMG."/c/Merchant_Offer.png";
							}
							
							?>
                        <img src="<?php echo $img_src; ?>" border="0" /> </p>
						      
						   </p>
						   
							
						</div>
					 </div>
				      </div>
				   </div>
			    <!--<td colspan="2">
				<p><span>Customer</span><span>&nbsp;:&nbsp;</span><?=$RS_userinfo->fields['firstname']." ".$RS_userinfo->fields['lastname']?></p>
			    </td>-->
			
			</tr>
			
			
			
			
		     </table>
			</div>
			</div>
              
                  </div>
		<!--  <div class="mer_chant_div">
                         <p><span>Campaign Avilable At this Locations</span><span>&nbsp;:&nbsp;</span><?=$RS_locations->RecordCount()?></p>
                         <?php if($RS_locations->RecordCount() != 0){?>
			 <table>
			 <tr style="font-size: 0.8em;">
			   	<th width="17%" align="left">Location Name</th>
				<th width="40%" align="left">Address</th>
				<th width="10%" align="left">Phone</th>
				<th width="11%" align="left">Website</th>
				<th width="7%" align="left">Status</th>
				<th width="14%" align="left">Merchant</th>
			  </tr>
		<?php	 while($Row = $RS_locations->FetchRow()){  $where_clause = array();
				$where_clause['id'] = $Row['created_by'];
				$RSMerchant = $objDB->Show("merchant_user", $where_clause); ?>
		       <tr style="font-size: 0.8em;">
			    <td><?=$Row['location_name']?></a></td>
			    <td><?=$Row['address'].", ".$Row['city'].", ".$Row['state'].", ".$Row['zip']?></td>
			    <td><?=$Row['phone_number']?></td>
			    <td><?=$Row['website']?></td>
			    <td>
			    <?php
			    if($Row['active'] == 1) echo "Active"; else echo "Inactive";
			    ?>
			    </td>
			    <td><?=$RSMerchant->fields['firstname']." ".$RSMerchant->fields['lastname']?></td>
		      </tr>
                         
                         <?php } echo "</table>";
			 }?>
                    </div>-->
	<?php
}


/******** 
@USE : Redeem campaign voucher code
@PARAMETER : current login merchant id , voucher code , redeem value
@RETURN : error message or success
@USED IN PAGES : redeem-deal.php
@EXPLAINATION : 
- Parent merchant can redeem voucher code which is created by own and his employees
- Employee can redeem voucher code of his assigned location
- Voucher code is invalid in this condition
  - If voucher code is expire 
  - If offer left is zero
  - If voucher code is belong to another location
  - If voucher code is already redeem (campaign type: One per customer)
  - If voucher code is already redeem for current day(campaign type:  One Per Customer Per Day )
  - If campaigns no offer left for that campaign (campaign type: Redeem Points Per Visit  )
- Redeem point criteria
  - If block point available for that location 
- Sharing point criteria
  - Customer get voucher code of campaign shared by another user then on redeem that voucher code , customer will get sharing point
  - If sharing limit is reached then customer will get sharing point on redeem another voucher code on that location
*********/

if(isset($_REQUEST['btn_redeem']))
{
try{
$objDB->Conn->StartTrans(); 
/*	$objDB->Conn->StartTrans(); 
	//$saveErrHandlers = $objDB->Conn->IgnoreErrors();
	$sql="insert into sections values (0,'primary',1)";
	$RS = $objDB->Conn->Execute($sql);
	
	$sql="insert into sections values (0,'secondary')";
	$RS = $objDB->Conn->Execute($sql);
	//if (!CheckRecords()) $objDB->Conn->FailTrans(); 
	//$objDB->Conn->IgnoreErrors($saveErrHandlers);
$objDB->Conn->CompleteTrans();
	
	exit; */
	$json_array = array(); 
	$used=0;
	
	$barcode = $_REQUEST['txt_barcode'];

	if($barcode != "")
	{
		/*$Sql = "SELECT * FROM coupon_codes where coupon_code='".$barcode."'";			
		$RS = $objDB->Conn->Execute($Sql);*/
		$RS = $objDB->Conn->Execute("SELECT * FROM coupon_codes where coupon_code=?",array($barcode));
		//echo $RS->fields['customer_campaign_code'];
                
		//echo $RS->RecordCount()."mara data che";
		if($RS->RecordCount() > 0)
		{
			if($_SESSION['merchant_info']['merchant_parent'] == 0)
			{
				 
				$arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
				$ids=  implode(",", $arr_ids);
				
				if($ids=="")
					$ids=$_SESSION['merchant_id'];
				
				/*$Sql = "SELECT * FROM campaigns cp WHERE cp.id=".$RS->fields['customer_campaign_code']." and (cp.created_by = '$_SESSION[merchant_id]' or cp.created_by in (".$ids."))";
				
				$RS = $objDB->Conn->Execute($Sql);*/
				$RS = $objDB->Conn->Execute("SELECT * FROM campaigns cp WHERE cp.id=? and (cp.created_by =? or cp.created_by in (?))",array($RS->fields['customer_campaign_code'],$_SESSION['merchant_id'],$ids));

				$arr=file(WEB_PATH.'/merchant/process.php?get_point_package=yes');
				if(trim($arr[0]) == "")
				{
						unset($arr[0]);
						$arr = array_values($arr);
				}
				$json = json_decode($arr[0]);
				$total_records= $json->total_records;
				$records_array = $json->records;
				if($total_records>0){
								foreach($records_array as $Row)
								{	

						$price =$Row->price;
						$point_=$Row->points;
						$p= (1*$price)/$point_;
								}
				}
				$B4 = (1*$price)/$point_;						  
				if($RS->RecordCount()<=0)
				{
					$json_array['status'] = "false";
					//$json_array['message'] = "This coupon is not for this store.";

					$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_different_merchant"];

					$json = json_encode($json_array);
					$objDB->Conn->CompleteTrans(); 
					echo $json;
					return $json;
					exit;
				}
				
				// 15 12 2014 start check coupon code is for assigned location or not
				
				
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
							FROM coupon_codes c, campaigns cp WHERE 
							c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code  and c.location_id in
								(select id from locations where active =1 )  and  cp.id in 
								(select cl.campaign_id from campaign_location cl , merchant_user mur where
								mur.id = ".$_SESSION['merchant_id']." and cl.location_id = mur.redeem_location and c.location_id=mur.redeem_location) ";
				
				
				$RS = $objDB->Conn->Execute($Sql);*/
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing FROM coupon_codes c, campaigns cp WHERE c.coupon_code=? and cp.id=c.customer_campaign_code  and c.location_id in(select id from locations where active =? )  and  cp.id in (select cl.campaign_id from campaign_location cl , merchant_user mur where mur.id =? and cl.location_id = mur.redeem_location and c.location_id=mur.redeem_location) ",array($_REQUEST['txt_barcode'],1,$_SESSION['merchant_id']));
				
				if($RS->RecordCount()<=0)
				{
					$json_array['status'] = "false";
					//$json_array['message'] = "This coupon is not for this store.";
					
					$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_different_location"];
					
					$json = json_encode($json_array);
					$objDB->Conn->CompleteTrans(); 
					echo $json;
					return $json;
					exit;
				}
				
				// 15 12 2014 end check coupon code is for assigned location or not
				 
			}
			else
			{
				//$Sql = "SELECT * FROM campaigns cp WHERE cp.id=".$RS->fields['customer_campaign_code']." and cp.created_by = '$_SESSION[merchant_id]'";
				
				//04 10 2013
				
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
							FROM coupon_codes c, campaigns cp WHERE c.active =1 and 
							c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code  and c.location_id in
								(select id from locations where active =1 )  and  cp.id in 
								(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
								mur.merchant_user_id = ".$_SESSION[merchant_id]." and cl.location_id = mur.location_access and c.location_id=mur.location_access) ";
				
					
				//04 10 2013
				
				$RS = $objDB->Conn->Execute($Sql);*/
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing FROM coupon_codes c, campaigns cp WHERE c.active =? and c.coupon_code=? and cp.id=c.customer_campaign_code  and c.location_id in(select id from locations where active =? )  and  cp.id in(select cl.campaign_id from campaign_location cl , merchant_user_role mur where mur.merchant_user_id = ? and cl.location_id = mur.location_access and c.location_id=mur.location_access) ",array(1,$_REQUEST['txt_barcode'],1,$_SESSION[merchant_id]));
				
				if($RS->RecordCount()<=0)
				{
					$json_array['status'] = "false";
					//$json_array['message'] = "This coupon is not for this store.";
					
					$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_different_location"];
					
					$json = json_encode($json_array);
					$objDB->Conn->CompleteTrans(); 
					echo $json;
					return $json;
					exit;
				}
			}
			if($_SESSION['merchant_info']['merchant_parent'] == 0)
			{
				// to redeem all child coupon
				$arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
				 $ids=  implode(",", $arr_ids);
			
				 if($ids=="")
					$ids=$_SESSION['merchant_id'];
				// 	to redeem all child coupon
				
				//$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE start_date<='$date_f' AND expiration_date >='$date_f' AND visible='1' AND id =".$RS->fields['customer_campaign_code'] ." AND (created_by = '$_SESSION[merchant_id]' or created_by in ( select id from merchant_user where merchant_parent = ". $_SESSION[merchant_id] ." ))";
				
				//$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =1 ) and (cp.created_by = '$_SESSION[merchant_id]' or cp.created_by in ( select id from merchant_user where merchant_parent = ". $_SESSION[merchant_id] ." ))";
				
				// change query for all child 
				/*$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =1 ) and (cp.created_by = '$_SESSION[merchant_id]' or cp.created_by in (".$ids."))";*/
				// change query for all child 
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code=? and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =? ) and (cp.created_by =? or cp.created_by in (?))",array($_REQUEST['txt_barcode'],1,$_SESSION['merchant_id'],$ids));
			}
			else
			{
					
				if(isset($_COOKIE['merchant_'.$_SESSION['merchant_id']]))
				{
					if($_COOKIE['merchant_'.$_SESSION['merchant_id']] ==  "")
					{
					   $Where_miles = "";	  
					}
					else
					{
						$lnglat = $_COOKIE['merchant_'.$_SESSION['merchant_id']];
						$lnglat_arr = explode(";",$lnglat);
				//        $curr_longitude = $lnglat_arr[1];
				//        $curr_latitude = $lnglat_arr[0];
							$curr_latitude = 43.64953;
								$curr_longitude = -79.37043;
						 $miles = 2000 * 0.00062137;
					$Where_miles = " or 
							cp.id in (select cl.campaign_id from campaign_location cl , locations l where 
									(((acos(sin((".$curr_latitude."*pi()/180)) * 
							sin((`latitude`*pi()/180))+cos((".$curr_latitude."*pi()/180)) * 
							cos((`latitude`*pi()/180)) * cos((((".$curr_longitude.")- `longitude`)* 
							pi()/180))))*180/pi())*60*1.1515
						) <=".$miles." and l.id=c.location_id) " ;	
					}
				}
				else
				{
					 $miles = 200 * 0.00062137;
					$Where_miles = "";	   
				}
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
							FROM coupon_codes c, campaigns cp WHERE c.active =1 and 
							c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code  and c.location_id in
								(select id from locations where active =1 )  and ( cp.id in 
								(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
								mur.merchant_user_id = ".$_SESSION[merchant_id]." and cl.location_id = mur.location_access ) ".$Where_miles." )";*/

				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing FROM coupon_codes c, campaigns cp WHERE c.active =? and c.coupon_code=? and cp.id=c.customer_campaign_code  and c.location_id in(select id from locations where active =? )  and ( cp.id in (select cl.campaign_id from campaign_location cl , merchant_user_role mur where mur.merchant_user_id =? and cl.location_id = mur.location_access ) ".$Where_miles." )",array(1,$_REQUEST['txt_barcode'],1,$_SESSION[merchant_id]));
			
			}
			
			//$RS = $objDB->Conn->Execute($Sql);
				
			if($RS->RecordCount()<=0){
				$json_array['status'] = "false";
				//$json_array['message'] = "This coupon is not for this store.";
				$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_voucher_code_not_valid"];
				$json = json_encode($json_array);
				$objDB->Conn->CompleteTrans(); 
				echo $json;
				return $json;
				
			}
			else
			{
				$array_loc['id']=$RS->fields['location_id'];
				$RS_location = $objDB->Show("locations",$array_loc);
				$time_zone=$RS_location->fields['timezone_name'];
				date_default_timezone_set($time_zone);
			
				//$dt_wh = " CONVERT_TZ(NOW(),'+00:00','+00:00') BETWEEN CONVERT_TZ(start_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) AND CONVERT_TZ(expiration_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) ";
						  //$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."','+00:00') BETWEEN CONVERT_TZ(c.start_date,'+00:00',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) AND CONVERT_TZ(c.expiration_date,'+00:00',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))"; 
						$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN  c.start_date AND c.expiration_date   and cl.active_in_future<>1"; 
				$date_f = date("Y-m-d H:i:s");
				
				/*$Sql = "SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible='1' AND c.id =".$RS->fields['customer_campaign_code']." and l.id =".$RS->fields['location_id'];
				
				$RS_t = $objDB->Conn->Execute($Sql);*/
				$RS_t = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible=? AND c.id =? and l.id =?",array(1,$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

				if($RS_t->fields['total'] == 0)
				{
					$json_array['status'] = "false";
					$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_campaign_expire"];
					$json = json_encode($json_array);
					$objDB->Conn->CompleteTrans(); 
					echo $json;
					return $json;
				}else{
								 $sharing_msg = ".";
					/*$Sql = "SELECT number_of_use, redeem_rewards FROM campaigns WHERE id =".$RS->fields['customer_campaign_code'];
					$RS_camp_detail = $objDB->Conn->Execute($Sql);*/
					$RS_camp_detail = $objDB->Conn->Execute("SELECT number_of_use, redeem_rewards FROM campaigns WHERE id =?",array($RS->fields['customer_campaign_code']));

					//-- start for point deduction
							$array_where_user = array();
							$array_where_user['id'] = $_SESSION['merchant_id'];
							$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
							$m_parent = $RS_merchant_User->fields['merchant_parent'];
							//if($RS_User->fields['merchant_parent'] == 0)
							if($RS_merchant_User->fields['merchant_parent'] == 0)
							{
								$merchant_id = $_SESSION['merchant_id'];
							}
							else
							{
								$merchant_id = $RS_merchant_User->fields['merchant_parent'];
							}
							
							$array_where_user = array();
							$array_where_user['id'] = $merchant_id;
							$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
					//-- End of point deduction
												
					if($RS_camp_detail->fields['number_of_use'] == 1)
					{
						/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']. " and location_id=".$RS->fields['location_id'];
						$RS_user_exist = $objDB->Conn->Execute($Sql);*/
						$RS_user_exist = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(0,$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

						if($RS_user_exist->RecordCount() == 0){
							$st = true;
													/* Don't give point if max nof sharing rich */
							
							 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
							
								 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
								$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>0 and referral_reward<>?",array($RS->fields['customer_campaign_code'],0));
					
								 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] ){
							
									/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];							
									$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
									$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

									if($RS_referral_customer->RecordCount() != 0)
									{
										$where = array();
										$where['referred_customer_id'] = $RS->fields['customer_id'];
										$where['campaign_id'] = $RS->fields['customer_campaign_code'];
										$where['referral_reward'] = 0;
										$where['location_id'] = $RS->fields['location_id'];
										
										$u_array = array();
										if(($RS->fields['block_point']-$RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
										{
											//$u_array['referral_reward'] = $RS->fields['referral_rewards'];
																				$sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
																			}
																			else{
																				 $sharing_msg = ".";
																			}
																			
									}
								 }
							/* Don't give point if max nof sharing rich */
							/*
							if($RS->fields['block_point'] < $RS_camp_detail->fields['redeem_rewards'])
							{
								$json_array['point_message'] = "Customer will earn O points.";
							}
							else
							{
								$json_array['point_message'] = "Customer will earn ".$RS_camp_detail->fields['redeem_rewards']." scanflip points".$sharing_msg;
							}
							$json_array['status'] = "true";
							$json_array['id'] = $RS->fields['customer_campaign_code'];
							$json_array['message'] = "";
							$json = json_encode($json_array);
							echo $json;
							return $json;
							*/
						}
						else{
							$json_array['status'] = "false";
							$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_campaign_already_redeemed"];
							$json = json_encode($json_array);
							$objDB->Conn->CompleteTrans(); 
							echo $json;
							return $json;
						}
					}
					else if($RS_camp_detail->fields['number_of_use'] == 2)
					{
	//                                    $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
	//                                    $RS_2_use = $objDB->Conn->Execute($Sql_2_use);
	//                                    if($RS_2_use->RecordCount() >0){
											/* $location_max_sql = "Select num_activation_code , offers_left from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
			 $location_max = $objDB->Conn->Execute($location_max_sql);*/
			$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));

			   $max_coupon = $location_max->fields['num_activation_code'];
			   $o_left = $location_max->fields['offers_left'];
									//    }
			   $flag_redeem =1;
			  // $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
				/*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
										$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
								$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));
										if($RS_2_use->RecordCount() <=0){
											$flag_redeem =0;
									}
	//                                while($loopcouponid=$Sql_2_use->FetchRow())
	//                                {
	//                                    $r_coupon_id = $loopcouponid['coupon_id'];
	//                                }
										if($o_left>0 || $flag_redeem==0)
										{
										   
					//	$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code'] ." and  DATE_FORMAT(reward_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  and location_id=".$RS->fields['location_id'];
					

															
											/*$Sql = "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  ";
						
											$RS_user_exist = $objDB->Conn->Execute($Sql);*/
						$RS_user_exist = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  =?  ",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id'],date('Y-m-d')));
										   
						if($RS_user_exist->RecordCount() == 0){
							$st = true;
													 /* Don't give point if max nof sharing rich */
							
							 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
							
								 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
								$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));
					
								 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] ){
							
									/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
												
									$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
									$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

									if($RS_referral_customer->RecordCount() != 0)
									{
										$where = array();
										$where['referred_customer_id'] = $RS->fields['customer_id'];
										$where['campaign_id'] = $RS->fields['customer_campaign_code'];
										$where['referral_reward'] = 0;
										$where['location_id'] = $RS->fields['location_id'];
										
										$u_array = array();
										if(($RS->fields['block_point']-$RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
										{
											//$u_array['referral_reward'] = $RS->fields['referral_rewards'];
											$sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
										}
										else{
											 $sharing_msg = ".";
										}
																			
									}
								 }
							/* Don't give point if max nof sharing rich */
							/*
							if($RS->fields['block_point'] < $RS_camp_detail->fields['redeem_rewards'])
							{
								$json_array['point_message'] = "Customer will earn O scanflip points.";
							}
							else
							{
								$json_array['point_message'] = "Customer will earn ".$RS_camp_detail->fields['redeem_rewards']." scanflip points".$sharing_msg;
							}
							$json_array['status'] = "true";
							$json_array['id'] = $RS->fields['customer_campaign_code'];
							$json_array['message'] = "";
							$json = json_encode($json_array);
							echo $json;
							return $json;
							*/
						}
						else
						{

										
							$msg = "Sorry!  This voucher is already redeemed today by customer at ".date("g:i A", strtotime($RS_user_exist->fields['redeem_date'])) ." . Offer Limit : 1 per customer per day";
							$json_array['status'] = "false";
							$json_array['message'] = $msg ;
							$json = json_encode($json_array);
							$objDB->Conn->CompleteTrans(); 
							echo $json;
							return $json;
						}
										}else{
							$json_array['status'] = "false";
							$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_no_offer_available"];
												   
							$json = json_encode($json_array);
							$objDB->Conn->CompleteTrans(); 
							echo $json;
							return $json;
						}
						
					}
					else if($RS_camp_detail->fields['number_of_use'] == 3)
					{
						 /*$location_max_sql = "Select num_activation_code , offers_left from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
					$location_max = $objDB->Conn->Execute($location_max_sql);*/

						$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));

					  $max_coupon = $location_max->fields['num_activation_code'];
					  $o_left = $location_max->fields['offers_left'];
									//    }
									   $flag_redeem =1;
		  //     $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
				 /*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
										$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/

					$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

						if($RS_2_use->RecordCount() <=0){
							$flag_redeem =0;
						}
						if($o_left>0 || $flag_redeem==0)
						{
						$st = true;
						 /* Don't give point if max nof sharing rich */
							
							 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
							 
								 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
								$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));

								 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] ){
							
									/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
									
														
									$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
							
									$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

									if($RS_referral_customer->RecordCount() != 0)
									{
										$where = array();
										$where['referred_customer_id'] = $RS->fields['customer_id'];
										$where['campaign_id'] = $RS->fields['customer_campaign_code'];
										$where['referral_reward'] = 0;
										$where['location_id'] = $RS->fields['location_id'];
										
										$u_array = array();
										if(($RS->fields['block_point'] - $RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
										{
											//$u_array['referral_reward'] = $RS->fields['referral_rewards'];
																				$sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
										}
										else{
											 $sharing_msg = ".";
										}
																			
									}
								 }
							/* Don't give point if max nof sharing rich */
							/*
						if($RS->fields['block_point'] < $RS_camp_detail->fields['redeem_rewards'])
							{
								$json_array['point_message'] = "Customer will earn O scanflip points.";
							}
							else
							{
								$json_array['point_message'] = "Customer will earn ".$RS_camp_detail->fields['redeem_rewards']." scanflip points".$sharing_msg ;
							}
							
						$json_array['status'] = "true";
											$json_array['loginstatus'] = "true";
						$json_array['id'] = $RS->fields['customer_campaign_code'];
						$json_array['message'] = "";
						$json = json_encode($json_array);
						echo $json;
						return $json;
						*/
										}
										else{
													$json_array['loginstatus'] = "true";
							$json_array['status'] = "false";
							$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_no_offer_available"];
												   
							$json = json_encode($json_array);
							$objDB->Conn->CompleteTrans(); 
							echo $json;
							return $json;
						}
					}
					
					
				}
			}
			

			$array_loc['id']=$RS->fields['location_id'];
			$RS_location = $objDB->Show("locations",$array_loc);
			$time_zone=$RS_location->fields['timezone_name'];
			date_default_timezone_set($time_zone);
				
			if($_SESSION['merchant_info']['merchant_parent'] == 0)
			{
				
				// to redeem all child coupon
				$arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
				$ids=  implode(",", $arr_ids);
				if($ids=="")
				$ids=$_SESSION['merchant_id'];
				// 	to redeem all child coupon

				//$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.max_no_sharing ,cp.block_point  FROM coupon_codes c, campaigns cp WHERE c.active =1 and  c.coupon_code='".$_REQUEST['hdn_coupon_code']."' and cp.id=c.customer_campaign_code  and c.location_id in (select id from locations where active =1 ) and (cp.created_by = '$_SESSION[merchant_id]' or cp.created_by in ( select id from merchant_user where merchant_parent = ". $_SESSION[merchant_id] ." ))";

				// change query for all child 
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.no_of_shared, cp.transaction_fees ,cp.referral_rewards ,cp.max_no_sharing ,cp.block_point,cp.deal_value,cp.discount,cp.saving  
				FROM coupon_codes c, campaigns cp WHERE c.active =1 and  c.coupon_code='".$barcode."' 
				and cp.id=c.customer_campaign_code  and c.location_id in (select l.id from locations l where l.active =1 ) 
				and (cp.created_by = '$_SESSION[merchant_id]' or cp.created_by in (".$ids."))";*/
				// change query for all child 
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.no_of_shared, cp.transaction_fees ,cp.referral_rewards ,cp.max_no_sharing ,cp.block_point,cp.deal_value,cp.discount,cp.saving  
				FROM coupon_codes c, campaigns cp WHERE c.active =? and  c.coupon_code=? 
				and cp.id=c.customer_campaign_code  and c.location_id in (select l.id from locations l where l.active =? ) 
				and (cp.created_by =? or cp.created_by in (?))",array(1,$barcode,1,$_SESSION['merchant_id'],$ids));

				
			}
			else
			{
				  
				if(isset($_COOKIE['merchant_'.$_SESSION['merchant_id']]))
				{
					if($_COOKIE['merchant_'.$_SESSION['merchant_id']] ==  "")
					{
					   $Where_miles = "";	  
					}
					else
					{
						$lnglat = $_COOKIE['merchant_'.$_SESSION['merchant_id']];
						$lnglat_arr = explode(";",$lnglat);
						//        $curr_longitude = $lnglat_arr[1];
						//        $curr_latitude = $lnglat_arr[0];
						$curr_latitude = 43.64953;
						$curr_longitude = -79.37043;
						$miles = 2000 * 0.00062137;
						$Where_miles = " or 
						cp.id in (select cl.campaign_id from campaign_location cl , locations l where 
						(((acos(sin((".$curr_latitude."*pi()/180)) * 
						sin((`latitude`*pi()/180))+cos((".$curr_latitude."*pi()/180)) * 
						cos((`latitude`*pi()/180)) * cos((((".$curr_longitude.")- `longitude`)* 
						pi()/180))))*180/pi())*60*1.1515
						) <=".$miles." and l.id=c.location_id) " ;	
					}
				}
				else
				{
					$miles = 200 * 0.00062137;
					$Where_miles = "";	   
				}
				$Where_miles = "";	
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.no_of_shared,cp.transaction_fees , cp.referral_rewards  ,cp.max_no_sharing ,cp.block_point,cp.deal_value,cp.discount,cp.saving  
				FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code='".$barcode."'
				and cp.id=c.customer_campaign_code and ( c.location_id in (select l.id from locations l where l.active =1  ) 
				and cp.id in (select cl.campaign_id from 
				campaign_location cl , merchant_user_role mur where mur.merchant_user_id = ".$_SESSION[merchant_id]." 
				and cl.location_id = mur.location_access ) ".$Where_miles." )";*/
			
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.no_of_shared,cp.transaction_fees , cp.referral_rewards  ,cp.max_no_sharing ,cp.block_point,cp.deal_value,cp.discount,cp.saving  
				FROM coupon_codes c, campaigns cp WHERE c.active =? and c.coupon_code=?
				and cp.id=c.customer_campaign_code and ( c.location_id in (select l.id from locations l where l.active =?  ) 
				and cp.id in (select cl.campaign_id from 
				campaign_location cl , merchant_user_role mur where mur.merchant_user_id =? 
				and cl.location_id = mur.location_access ) ".$Where_miles." )",array(1,$barcode,1,$_SESSION[merchant_id]));
			}
			
			//$RS = $objDB->Conn->Execute($Sql);
			if($RS->RecordCount()<=0){
				$json_array['status'] = "false";
				$json_array['message'] = "This coupon is not for this store";
				$json = json_encode($json_array);
				$objDB->Conn->CompleteTrans(); 
				echo $json;
				return $json;
				
			}
			else
			{
                            $redeem_deal_value = 0;
                            if(($RS->fields['deal_value'] - $RS->fields['saving']) > $_REQUEST['txt_redeem_deal_value'] )
                            {
                               $redeem_deal_value = $RS->fields['deal_value'] - $RS->fields['saving'];
                            }
                            else
                            {
                                $redeem_deal_value = $_REQUEST['txt_redeem_deal_value'];
                            }
							
							// 11/08/2014 insert redeemption fee if enable in package
							
								$redeemption_fee = 0;
								
								$discounted_coupon_value = $RS->fields['deal_value'] - $RS->fields['saving'];
								$array_where_mb = array();
								$array_where_mb['merchant_id'] = $_SESSION['merchant_id'];
								$RS_mb = $objDB->Show("merchant_billing", $array_where_mb);
								$array_where_bp = array();
								$array_where_bp['id'] = $RS_mb->fields['pack_id'];
								$RS_bp = $objDB->Show("billing_packages", $array_where_bp);
								if($RS_bp->fields['enable_coupon_redeemption_fee']==1)
								{
									 $Sql_r_f_c = "SELECT * FROM redeemption_fee_charge";
									 $Rs_r_f_c = $objDB->Conn->Execute($Sql_r_f_c);
									 $count = 0;
									 while($Row_r_f_c = $Rs_r_f_c->FetchRow())
									 {
										//echo $discounted_coupon_value.">=".$Row_r_f_c['start_value']." && ".$discounted_coupon_value."<=".$Row_r_f_c['end_value'];
										if($discounted_coupon_value>=$Row_r_f_c['start_value'] && $discounted_coupon_value<=$Row_r_f_c['end_value'])
										{
											if($Row_r_f_c['type']=="amount")
											{
												//echo "amount";
												$redeemption_fee = $Row_r_f_c['amount_value'];
											}
											else
											{
												//echo "percentage";
												$redeemption_fee = ($discounted_coupon_value*$Row_r_f_c['amount_value'])/100;
											}
										}																									  
									 }
									 
								}
							//echo "Discounted coupon value : ".$discounted_coupon_value;	
							//echo " Redeemption fee : ".$redeemption_fee;
							//exit();
								
							// 11/08/2014 
							
							/*
                            echo "deal value = ".$RS->fields['deal_value']." ";
                            echo "saving = ".$RS->fields['saving']." ";
                            echo "sales value = ".$_REQUEST['txt_redeem_deal_value']." ";
                            echo "redeem value = ".$redeem_deal_value;
                            exit();
                            */
							
				//			$dt_wh = " CONVERT_TZ(NOW(),'+00:00','+00:00') BETWEEN CONVERT_TZ(start_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) AND CONVERT_TZ(expiration_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) ";
				//			$date_f = date("Y-m-d H:i:s");
				//			$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE ".$dt_wh." AND visible='1' AND id =".$RS->fields['customer_campaign_code'];
				//$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN  c.start_date AND c.expiration_date"; 
				$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN  c.start_date AND c.expiration_date  and cl.active_in_future<>1"; 
				//  $dt_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1";
				$date_f = date("Y-m-d H:i:s");
				/*$Sql = "SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible='1' AND c.id =".$RS->fields['customer_campaign_code']." and l.id =".$RS->fields['location_id'];
				
				$RS_t = $objDB->Conn->Execute($Sql);*/
				$RS_t = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible=? AND c.id =? and l.id =?",array(1,$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

				if($RS_t->fields['total'] == 0)
				{
				//	echo "In if ";
				}
				else
				{
				
						/*$Sql = "SELECT number_of_use FROM campaigns WHERE id =".$RS->fields['customer_campaign_code'];
						
						$RS_camp_detail = $objDB->Conn->Execute($Sql);*/
						$RS_camp_detail = $objDB->Conn->Execute("SELECT number_of_use FROM campaigns WHERE id =?",array($RS->fields['customer_campaign_code']));

						$flag = true;
						if($RS_camp_detail->fields['number_of_use'] == 1)
						{
							//$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and  customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code'] ." and location_id=".$RS->fields['location_id'];
												/*$Sql =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";*/
							$RS_user_exist = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));
							
						}
						else if($RS_camp_detail->fields['number_of_use'] == 2)
						{
											  
							//$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and  customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code'] ." and  DATE_FORMAT(reward_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  and location_id=".$RS->fields['location_id'];
											 /*$Sql = "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  ";*/
					$RS_user_exist = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

							
						}
						else if($RS_camp_detail->fields['number_of_use'] == 3)
						{
							$flag = false;
						}
										/*$SQl_coupon_id = "select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." ";
									 
										$Rs_coupon_id =  $objDB->Conn->Execute($SQl_coupon_id);*/
										$Rs_coupon_id =  $objDB->Conn->Execute("select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? ",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

										$generated_coupon_id = $Rs_coupon_id->fields['id'];
									 
						if($flag){
											
							   /*$location_max_sql = "Select num_activation_code , offers_left, used_offers from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
										$location_max = $objDB->Conn->Execute($location_max_sql);*/
								$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left, used_offers from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));

										  $max_coupon = $location_max->fields['num_activation_code'];
										  $o_left = $location_max->fields['offers_left'];
										  $used_offer = $location_max->fields['used_offers'];
										//    }
														  $flag_redeem =1;
														//  $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
											/*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
										 
											$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
											$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

											if($RS_2_use->RecordCount() <=0){
												$flag_redeem =0;
										}
									   
											if($o_left>0 || $flag_redeem==0)
											{
										   
											  //  $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
												  /*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
										  
											$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
											$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

											if($RS_2_use->RecordCount() >0){
												$used= 1;
											}
											
										//	echo "bla bla";
											//echo $Sql;
							
							if($RS_user_exist->RecordCount() == 0){
							
								$deduct_points = 0;
								//-- start for point deduction
								$array_where_user = array();
								$array_where_user['id'] = $_SESSION['merchant_id'];
								$RS_User = $objDB->Show("merchant_user", $array_where_user);
								$m_parent = $RS_User->fields['merchant_parent'];
								if($RS_User->fields['merchant_parent'] == 0)
								{
									$merchant_id = $_SESSION['merchant_id'];
								}
								else
								{
									$merchant_id = $RS_User->fields['merchant_parent'];
								}
								//echo $merchant_id ."==";
								
								$array_where_user = array();
								$array_where_user['id'] = $merchant_id;
								$RS_User = $objDB->Show("merchant_user", $array_where_user);
								
								// start transcation 
							//	$objDB->Conn->StartTrans(); 
								//-- End of point deduction
								/*
								if($RS_User->fields['available_point'] < 100)
								{
									$mail = new PHPMailer();
									$body = "<p>Dear Scanflip merchant user,</p>"; 
									$body .= "<p> We are informing u that your points about to finish. So please to get scanflip functionality benefits renew your package as early as possible </p>";
									$mail->AddReplyTo('no-reply@scanflip.com','ScanFlip Support');
									$mail->AddAddress($RS_User->fields['email']);
									$mail->From = "no-reply@scanflip.com";
									$mail->FromName = "ScanFlip Support";
									$mail->Subject    = "ScanFlip Subscription";
									$mail->MsgHTML($body);
									$mail->Send();
								}
								*/
								$redeem_array = array();
								$redeem_array['customer_id'] = $RS->fields['customer_id'] ;
								$redeem_array['campaign_id'] = $RS->fields['customer_campaign_code'] ;
								if($RS->fields['block_point'] >= ($RS->fields['redeem_rewards'] - $RS->fields['transaction_fees']) )
								{
									$redeem_array['earned_reward'] = $RS->fields['redeem_rewards'] ;
																$giving_points = $RS->fields['redeem_rewards'];
									$deduct_points = $RS->fields['block_point'] - $RS->fields['redeem_rewards'] - $RS->fields['transaction_fees'];
								}else{
									$redeem_array['earned_reward'] = 0 ;
																$giving_points = 0;
									$deduct_points = $RS->fields['block_point'];
								}
		//					$Sql = "Update campaigns set block_point =".$deduct_points." where id=".$RS->fields['customer_campaign_code'];
		//						
		//						$objDB->Conn->Execute($Sql);
														if($flag_redeem == 0)
														{
														
														// insert here //
								$redeem_array['referral_reward'] = 0;
								$redeem_array['referred_customer_id'] = 0;
								$redeem_array['reward_date'] =  date("Y-m-d H:i:s");
													   $redeem_array['coupon_code_id'] =  $RS->fields['id'];
														$redeem_array['location_id'] =  $RS->fields['location_id'];
													$redeem_array['redeem_deal_value'] =  $redeem_deal_value;
												//	print_r($redeem_array);
								$objDBWrt->Insert($redeem_array, "reward_user");
														}
														else{
														// insert here //
															/*$sql_get_earned_reward = "select * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
															$rs_get_earned_reward =$objDB->Conn->Execute($sql_get_earned_reward);*/
										$rs_get_earned_reward =$objDB->Conn->Execute("select * FROM reward_user WHERE referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(0,$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

															$total_earned_reward = $rs_get_earned_reward->fields['earned_reward'];
															/*$up_sql ="Update reward_user set earned_reward =".($total_earned_reward + $giving_points)."  where referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
															$objDB->Conn->Execute($up_sql);       */
			$objDBWrt->Conn->Execute("Update reward_user set earned_reward =?  where referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(($total_earned_reward + $giving_points),0,$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));       

														}
												 
								$coupon_redeem_array = array();
								
															
														$coupon_redeem_array['coupon_id'] =  $RS->fields['id'];
														$coupon_redeem_array['redeem_date'] =  date("Y-m-d H:i:s");
														$coupon_redeem_array['redeem_value'] =  $redeem_deal_value;
														$coupon_redeem_array['redeemption_fee'] =  $redeemption_fee;
														$coupon_redeem_array['redeem_merchant_id'] = $_SESSION['merchant_id'];
														$coupon_redeem_array['transaction_fees'] = $RS->fields['transaction_fees'];
														$coupon_redeem_array['transaction_fees_price'] = ($RS->fields['transaction_fees'])* $B4;
														$objDBWrt->Insert($coupon_redeem_array, "coupon_redeem");
														
														// redeem trigger	
														
														$redeem_point=$redeem_array['earned_reward'];
														$arr_bus=file(WEB_PATH.'/process.php?getlocationbusinessname=yes&l_id='. $RS->fields['location_id']);
														if(trim($arr_bus[0]) == "")
															 {
																	 unset($arr_bus[0]);
																	 $arr_bus = array_values($arr_bus);
															 }
															 $json_bus = json_decode($arr_bus[0]);
														$business_name  = $json_bus->bus_name;
														
														$array_gcm = array();
														$array_gcm['id'] = $RS->fields['customer_id'];
														$RS_gcm = $objDB->Show("customer_user",$array_gcm);
														if($RS_gcm->fields['notification_setting']==1)
														{
															if($RS_gcm->fields['gcm_registration_id']!="")
															{
																$gcm_registration_id=$RS_gcm->fields['gcm_registration_id'];
		
																$device_id = $gcm_registration_id;
																$arr=file(WEB_PATH.'/merchant/process.php?send_gcm_message=yes&customer_id='.$RS->fields['customer_id'].'&device_id='.$device_id.'&redeem_point='.$redeem_point.'&business_name='.urlencode($business_name).'&notificationtype=point_for_visit');
															}
															if($RS_gcm->fields['device_id']!="")
															{
																$device_id=$RS_gcm->fields['device_id'];
	
																$arr=file(WEB_PATH.'/merchant/process.php?send_push_message=yes&customer_id='.$RS->fields['customer_id'].'&device_id='.$device_id.'&redeem_point='.$redeem_point.'&business_name='.urlencode($business_name).'&notificationtype=point_for_visit');
															}
														}
													
														// redeem trigger
														
														 /* for make entry in subscribed store table */
														/*$Sql_r_c = "Select * from coupon_redeem where coupon_id =".$generated_coupon_id ;
													  
														$RS_r_c =  $objDB->Conn->Execute($Sql_r_c);*/
	$RS_r_c =  $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id =?",array($generated_coupon_id));
														if($RS_r_c->RecordCount() == 1)
														{
														  /* $sql_chk ="select * from subscribed_stores where customer_id= ".$RS->fields['customer_id'] ." and location_id=". $RS->fields['location_id'];
															$subscibed_store_rs =$objDB->Conn->Execute($sql_chk);*/
	$subscibed_store_rs =$objDB->Conn->Execute("select * from subscribed_stores where customer_id= ? and location_id=?",array($RS->fields['customer_id'],$RS->fields['location_id']));

														  if($subscibed_store_rs->RecordCount()!=0 && $subscibed_store_rs->fields['first_redeemed_date']=="0000-00-00 00:00:00")
														  {
															   /*$up_subscribed_store = "Update subscribed_stores set first_redeemed_date='".date("Y-m-d H:i:s")."'  where  customer_id= ".$RS->fields['customer_id']." and location_id=".$RS->fields['location_id'];
																   $objDB->Conn->Execute($up_subscribed_store);*/
		$objDBWrt->Conn->Execute("Update subscribed_stores set first_redeemed_date=?  where  customer_id=? and location_id=?",array(date("Y-m-d H:i:s"),$RS->fields['customer_id'],$RS->fields['location_id']));
														  }
														}
														/* for make entry in subscribed store table*/
														if($used==1)
														{
															/*$of_up=  "Update campaign_location set offers_left=".($o_left-1)." , used_offers=".($used_offer+1)."  where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
														   
														   $objDB->Conn->Execute($of_up);*/
$objDBWrt->Conn->Execute("Update campaign_location set offers_left=? , used_offers=?  where  campaign_id=? and location_id=?",array(($o_left-1),($used_offer+1),$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

														}
								
								
								/* Don't give point if max nof sharing rich */
								
								 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
								
									 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
									$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));

									 
									$shared_counter = $RS->fields['no_of_shared'];
									//echo $shared_counter."==share counter";
									 if($RS->fields['no_of_shared'] <  $RS->fields['max_no_sharing'] ){
									 
									 // set actually shared campaign 
									 /*$sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id = ".$RS->fields['customer_campaign_code']."   AND location_id=".$RS->fields['location_id'];
									
									 $RS_referral_customer = $objDB->Conn->Execute($sql);*/
									$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id = ?   AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

									 $where = array();
									$where['referred_customer_id'] = $RS->fields['customer_id'];
									$where['campaign_id'] = $RS->fields['customer_campaign_code'];
									$where['referral_reward'] = 0;
									 $where['location_id'] = $RS->fields['location_id'];
									$u_array = array();
									//echo "<br/>record count".$RS_referral_customer->RecordCount();
									//echo "<br/>deduct point ==".$deduct_points."==".$RS->fields['referral_rewards'];
									 if($RS_referral_customer->RecordCount() != 0)
									 {
										if($RS_referral_customer->fields['referral_reward'] == 0 )
										{
										if($deduct_points >= $RS->fields['referral_rewards'] )
										{
											$u_array['referral_reward'] = $RS->fields['referral_rewards'];
											$u_array['reward_date'] =   date("Y-m-d H:i:s");
											$deduct_points = $deduct_points - $RS->fields['referral_rewards'];
											$shared_counter++;
										}else{
											$u_array['referral_reward']  = 0 ;
											$u_array['reward_date'] =   date("Y-m-d H:i:s");
											$deduct_points = $RS->fields['block_point'];
										}
																	
										/*
										echo "<pre>u array====";
										print_r($u_array);
										echo "where:";
										print_r($where);
										echo "</pre>"; */
									
										$objDBWrt->Update($u_array, "reward_user", $where);
										}
									 }
										/* $Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']."  AND referral_reward = 0 AND location_id=".$RS->fields['location_id'];
										
												$RS_referral_customer = $objDB->Conn->Execute($Sql);*/

$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=?  AND referral_reward = ? AND location_id=?",array($RS->fields['customer_id'],0,$RS->fields['location_id']));

																				
												if($RS_referral_customer->RecordCount() != 0)
												{
													
													while($row_referral_customer = $RS_referral_customer->FetchRow() )
													{
													/*$sql = "Select * from reward_user where customer_id =".$row_referral_customer['referred_customer_id']." and location_id =".$row_referral_customer['location_id'] ." and campaign_id = ". $row_referral_customer['campaign_id'];
												
														$RS_coupon_redeem = $objDB->Conn->Execute($sql);*/
		$RS_coupon_redeem = $objDB->Conn->Execute("Select * from reward_user where customer_id =? and location_id =? and campaign_id =?",array($row_referral_customer['referred_customer_id'],$row_referral_customer['location_id'],$row_referral_customer['campaign_id']));

														if($RS_coupon_redeem->RecordCount() != 0)
														{
														$where = array();
															$where['referred_customer_id'] = $RS->fields['customer_id'];
														$where['campaign_id'] =  $row_referral_customer['campaign_id'];
														$where['referral_reward'] = 0;
														 $where['location_id'] = $RS->fields['location_id'];
														$u_array = array();
												//	echo "<br/>record count".$RS_referral_customer->RecordCount();
											//			echo "<br/>deduct point ==".$deduct_points."==".$RS->fields['referral_rewards'];
									 //
														if($shared_counter <    $RS->fields['max_no_sharing'])	
														{
															if($deduct_points >= $RS->fields['referral_rewards'] )
															{
																$u_array['referral_reward'] = $RS->fields['referral_rewards'];
																$u_array['reward_date'] =   date("Y-m-d H:i:s");
																$deduct_points = $deduct_points - $RS->fields['referral_rewards'];
																$u_array['campaign_id'] = $RS->fields['customer_campaign_code'];
																$shared_counter++;
															}else{
																$u_array['referral_reward']  = 0 ;
																$u_array['reward_date'] =   date("Y-m-d H:i:s");
																$deduct_points = $RS->fields['block_point'];
															}
														/*
														echo "<pre>u array";
														print_r($u_array);
														echo "where:";
														print_r($where);
														echo "</pre>"; */
														$objDBWrt->Update($u_array, "reward_user", $where);
														}
													
													}
													
													}
												}
									 }
									 
									 //update sharing counter 
									/* $sql = "update campaigns set no_of_shared=".$shared_counter." where id=". $RS->fields['customer_campaign_code'];
									
									 $objDB->Conn->Execute($sql);*/
									$objDBWrt->Conn->Execute("update campaigns set no_of_shared=? where id=?",array($shared_counter,$RS->fields['customer_campaign_code']));

																 
																 // if sharing point not available then send message
			 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 ";
			  $RS_shared_ = $objDB->Conn->Execute($Sql_shared);*/
				$RS_shared_ = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>?",array($RS->fields['customer_campaign_code'],0));

				if($RS_shared_->RecordCount() >  $RS->fields['max_no_sharing'] ){
																		 //$sql_get_merchant = "";
																	 }
																 // 
								/* Don't give point if max nof sharing rich  */
								
								
								
								
								
								
								//-- start for point deduction
								
								
								
								/*$Sql = "Update campaigns set block_point =".$deduct_points." where id=".$RS->fields['customer_campaign_code'];
								
								$objDB->Conn->Execute($Sql);*/
								$objDBWrt->Conn->Execute("Update campaigns set block_point =? where id=?",array($deduct_points,$RS->fields['customer_campaign_code']));

								
								//-- End of point deduction	
								
								// review insert here //
								/*$sql = "update reward_user set review_rating_visibility = 1 where customer_id=".$RS->fields['customer_id']." and location_id= ".$RS->fields['location_id']." and campaign_id=".$RS->fields['customer_campaign_code'];
									$rs = $objDB->Conn->Execute($sql);*/
								$rs = $objDBWrt->Conn->Execute("update reward_user set review_rating_visibility = ? where customer_id=? and location_id=? and campaign_id=?",array(1,$RS->fields['customer_id'],$RS->fields['location_id'],$RS->fields['customer_campaign_code']));

								$json_array['status'] = "true";
								$json_array['id'] = $RS->fields['customer_campaign_code'];
								$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_coupon_redeemed"];
														$_SESSION['msg'] = $merchant_msg["redeem-deal"]["Msg_coupon_redeemed"];
								$json = json_encode($json_array);
								
								//finish transaction - This will rollback the transcation if any error occure
							$objDB->Conn->CompleteTrans();
								echo $json;
								return $json;
							}
											}
						}
						else{
							  /*$location_max_sql = "Select num_activation_code , offers_left , used_offers from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
														$location_max = $objDB->Conn->Execute($location_max_sql);*/

				$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left , used_offers from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));

								  $max_coupon = $location_max->fields['num_activation_code'];
								  $o_left = $location_max->fields['offers_left'];
										  $used_offer = $location_max->fields['used_offers'];
										//    }
											$flag_redeem =1;
										   //$Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
											/*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
											$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
									
							$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=?)",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

											if($RS_2_use->RecordCount() <=0){
												$flag_redeem =0;
										}
											if($o_left>0 || $flag_redeem==0)
											{
												//$Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
												/*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
											$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
						$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=?)",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

											if($RS_2_use->RecordCount() >0){
												$used= 1;
											}
							$deduct_points = 0;
							
							//-- start for point deduction
								$array_where_user = array();
								$array_where_user['id'] = $_SESSION['merchant_id'];
								$RS_User = $objDB->Show("merchant_user", $array_where_user);
								$m_parent = $RS_User->fields['merchant_parent'];
								if($RS_User->fields['merchant_parent'] == 0)
								{
									$merchant_id = $_SESSION['merchant_id'];
								}
								else
								{
									$merchant_id = $RS_User->fields['merchant_parent'];
								}
								
								$array_where_user = array();
								$array_where_user['id'] = $merchant_id;
								$RS_User = $objDB->Show("merchant_user", $array_where_user);
								
								//start tarnsaction
								
								//$objDB->Conn->StartTrans(); 
								//-- End of point deduction
								/*
								if($RS_User->fields['available_point'] < 100)
								{
									$mail = new PHPMailer();
									$body = "<p>Dear Scanflip merchant user,</p>"; 
									$body .= "<p> We are inform u that your points about to finish. So please to get scanflip functionality benefits renew your package as early as possible </p>";
									$mail->AddReplyTo('no-reply@scanflip.com','ScanFlip Support');
									$mail->AddAddress($RS_User->fields['email']);
									$mail->From = "no-reply@scanflip.com";
									$mail->FromName = "ScanFlip Support";
									$mail->Subject    = "ScanFlip Subscription";
									$mail->MsgHTML($body);
									$mail->Send();
								}
								*/
							$redeem_array = array();
								$redeem_array['customer_id'] = $RS->fields['customer_id'] ;
								$redeem_array['campaign_id'] = $RS->fields['customer_campaign_code'] ;
								
								if($RS->fields['block_point'] >= $RS->fields['redeem_rewards'] )
								{
									$redeem_array['earned_reward'] = $RS->fields['redeem_rewards'] ;
									$deduct_points =  $RS->fields['block_point'] - $RS->fields['redeem_rewards'];
																$giving_points = $RS->fields['redeem_rewards'] ;
								}else{
									$redeem_array['earned_reward'] = 0 ;
									$deduct_points = $RS->fields['block_point'];
																$giving_points = 0;
								}
								if($flag_redeem == 0)
														{
															$redeem_array['referral_reward'] = 0;
															$redeem_array['referred_customer_id'] = 0;
															$redeem_array['reward_date'] =  date("Y-m-d H:i:s");
															$redeem_array['coupon_code_id'] =  $RS->fields['id'];
															$redeem_array['location_id'] =  $RS->fields['location_id'];
															$redeem_array['redeem_deal_value'] =  $redeem_deal_value;;
																/*echo "<pre>";
																print_r($redeem_array);
																echo "</pre>"; */
																
														$objDBWrt->Insert($redeem_array, "reward_user");
														
														}
														 else{
															/*$sql_get_earned_reward = "select * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
															$rs_get_earned_reward =$objDB->Conn->Execute($sql_get_earned_reward);*/
								$rs_get_earned_reward =$objDB->Conn->Execute("select * FROM reward_user WHERE referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(0,$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

															$total_earned_reward = $rs_get_earned_reward->fields['earned_reward'];
															/*$up_sql ="Update reward_user set earned_reward =".($total_earned_reward + $giving_points)."  where referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
															$objDB->Conn->Execute($up_sql);       */
			$objDBWrt->Conn->Execute("Update reward_user set earned_reward =?  where referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(($total_earned_reward + $giving_points),$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

														}
														   
								$coupon_redeem_array = array();

															
														$coupon_redeem_array['coupon_id'] =  $RS->fields['id'];
														$coupon_redeem_array['redeem_date'] =  date("Y-m-d H:i:s");
														$coupon_redeem_array['redeem_value'] =  $redeem_deal_value;
														$coupon_redeem_array['redeemption_fee'] =  $redeemption_fee;
															$coupon_redeem_array['redeem_merchant_id'] = $_SESSION['merchant_id'];
															$coupon_redeem_array['transaction_fees'] = $RS->fields['transaction_fees'];
															$coupon_redeem_array['transaction_fees_price'] = ($RS->fields['transaction_fees'])* $B4;
								$objDBWrt->Insert($coupon_redeem_array, "coupon_redeem");
														
														// redeem trigger	
														
														$redeem_point=$redeem_array['earned_reward'];
														$arr_bus=file(WEB_PATH.'/process.php?getlocationbusinessname=yes&l_id='. $RS->fields['location_id']);
														if(trim($arr_bus[0]) == "")
															 {
																	 unset($arr_bus[0]);
																	 $arr_bus = array_values($arr_bus);
															 }
															 $json_bus = json_decode($arr_bus[0]);
														$business_name  = $json_bus->bus_name;
														
														$array_gcm = array();
														$array_gcm['id'] = $RS->fields['customer_id'];
														$RS_gcm = $objDB->Show("customer_user",$array_gcm);
														if($RS_gcm->fields['notification_setting']==1)
														{
															if($RS_gcm->fields['gcm_registration_id']!="")
															{
																$gcm_registration_id=$RS_gcm->fields['gcm_registration_id'];
		
																$device_id = $gcm_registration_id;
																$arr=file(WEB_PATH.'/merchant/process.php?send_gcm_message=yes&customer_id='.$RS->fields['customer_id'].'&device_id='.$device_id.'&redeem_point='.$redeem_point.'&business_name='.urlencode($business_name).'&notificationtype=point_for_visit');
															}
															if($RS_gcm->fields['device_id']!="")
															{
																$device_id=$RS_gcm->fields['device_id'];
	
																$arr=file(WEB_PATH.'/merchant/process.php?send_push_message=yes&customer_id='.$RS->fields['customer_id'].'&device_id='.$device_id.'&redeem_point='.$redeem_point.'&business_name='.urlencode($business_name).'&notificationtype=point_for_visit');
															}
														}
													
														// redeem trigger
														
														  /* for make entry in subscribed store table */
													  //  $Sql_r_c = "Select * from reward_user where location_id=".$RS->fields['location_id']." and customer_id=".$RS->fields['customer_id'];
														 /*$Sql_r_c = "Select * from coupon_redeem where coupon_id =".$generated_coupon_id ;
														$RS_r_c =  $objDB->Conn->Execute($Sql_r_c);*/

									$RS_r_c =  $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id =?",array($generated_coupon_id));

														if($RS_r_c->RecordCount() == 1)
														{
														   /*$sql_chk ="select * from subscribed_stores where customer_id= ".$RS->fields['customer_id'] ." and location_id=". $RS->fields['location_id'];
															$subscibed_store_rs =$objDB->Conn->Execute($sql_chk);*/
		$subscibed_store_rs =$objDB->Conn->Execute("select * from subscribed_stores where customer_id=? and location_id=?",array($RS->fields['customer_id'],$RS->fields['location_id']));

														  if($subscibed_store_rs->RecordCount()!=0)
														  {
															   /*$up_subscribed_store = "Update subscribed_stores set first_redeemed_date='".date("Y-m-d H:i:s")."'  where  customer_id= ".$RS->fields['customer_id']." and location_id=".$RS->fields['location_id'];
																   $objDB->Conn->Execute($up_subscribed_store);*/
$objDBWrt->Conn->Execute("Update subscribed_stores set first_redeemed_date=?  where  customer_id=? and location_id=?",array(date("Y-m-d H:i:s"),$RS->fields['customer_id'],$RS->fields['location_id']));

														  }
														}
														/* for make entry in subscribed store table*/
								 if($used==1)
														{
															/*$of_up=  "Update campaign_location set offers_left=".($o_left-1)." , used_offers=".($used_offer+1)."  where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
														   $objDB->Conn->Execute($of_up);*/
	$objDBWrt->Conn->Execute("Update campaign_location set offers_left=? , used_offers=?  where  campaign_id=? and location_id=?",array(($o_left-1),($used_offer+1),$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

														}
							
							
									
									
									
							
							
									/* Don't give point if max nof sharing rich */
								
							/* Don't give point if max nof sharing rich */
								
								 $Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
								
									 //$RS_shared = $objDB->Conn->Execute($Sql_shared);
									 
									$shared_counter = $RS->fields['no_of_shared'];
									
									 if($shared_counter <  $RS->fields['max_no_sharing'] ){
									 
									 // set actually shared campaign 
									 /*$sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id = ".$RS->fields['customer_campaign_code']."  AND location_id=".$RS->fields['location_id'];
									 
									 $RS_referral_customer = $objDB->Conn->Execute($sql);*/
										$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

									 $where = array();
														$where['referred_customer_id'] = $RS->fields['customer_id'];
														$where['campaign_id'] = $RS->fields['customer_campaign_code'];
														$where['referral_reward'] = 0;
														 $where['location_id'] = $RS->fields['location_id'];
														$u_array = array();
														//echo "<br/>record count".$RS_referral_customer->RecordCount();
														//echo "<br/>deduct point ==".$deduct_points."==".$RS->fields['referral_rewards'];
									 if($RS_referral_customer->RecordCount() != 0)
									 {
										if($RS_referral_customer->fields['referral_reward'] == 0)
										{
										if($deduct_points >= $RS->fields['referral_rewards'] )
										{
											$u_array['referral_reward'] = $RS->fields['referral_rewards'];
											$u_array['reward_date'] =   date("Y-m-d H:i:s");
											$deduct_points = $deduct_points - $RS->fields['referral_rewards'];
											$u_array['campaign_id'] = $RS->fields['customer_campaign_code'];
											$shared_counter++;
										}else{
											$u_array['referral_reward']  = 0 ;
											$u_array['reward_date'] =   date("Y-m-d H:i:s");
											$deduct_points = $RS->fields['block_point'];
										}
																	
										/*
										echo "<pre>u array===";
										print_r($u_array);
										echo "where:";
										print_r($where);
										echo "</pre>"; */
										
										$objDBWrt->Update($u_array, "reward_user", $where);
										}
									 }
										 /*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']."  AND referral_reward = 0 AND location_id=".$RS->fields['location_id'];
									
												$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=?  AND referral_reward = ? AND location_id=?",array($RS->fields['customer_id'],0,$RS->fields['location_id']));

												if($RS_referral_customer->RecordCount() != 0)
												{
													
													while($row_referral_customer = $RS_referral_customer->FetchRow() )
													{
													/*$sql = "Select * from reward_user where customer_id =".$row_referral_customer['referred_customer_id']." and location_id =".$row_referral_customer['location_id'] ." and campaign_id = ".$row_referral_customer['campaign_id'];
													
														$RS_coupon_redeem = $objDB->Conn->Execute($sql);*/
				$RS_coupon_redeem = $objDB->Conn->Execute("Select * from reward_user where customer_id =? and location_id =? and campaign_id = ?",array($row_referral_customer['referred_customer_id'],$row_referral_customer['location_id'],$row_referral_customer['campaign_id']));

														if($RS_coupon_redeem->RecordCount() != 0)
														{
														$where = array();
														$where['referred_customer_id'] = $RS->fields['customer_id'];
														$where['campaign_id'] = $row_referral_customer['campaign_id'];
														$where['referral_reward'] = 0;
														$where['location_id'] = $RS->fields['location_id'];
														$u_array = array();
													
									 
														if($shared_counter <    $RS->fields['max_no_sharing'])	
														{
															if($deduct_points >= $RS->fields['referral_rewards'] )
															{
																$u_array['referral_reward'] = $RS->fields['referral_rewards'];
																$u_array['reward_date'] =   date("Y-m-d H:i:s");
																$deduct_points = $deduct_points - $RS->fields['referral_rewards'];
																$shared_counter++;
															}else{
																$u_array['referral_reward']  = 0 ;
																$u_array['reward_date'] =   date("Y-m-d H:i:s");
																$deduct_points = $RS->fields['block_point'];
															}
															/* echo "<pre>u array";
															print_r($u_array);
															echo "where:";
															print_r($where);
															echo "</pre>"; */
														$objDBWrt->Update($u_array, "reward_user", $where);
														}
													
													}
													
													}
												}
									 }
									 
									 //update sharing counter 
									 /*$sql = "update campaigns set no_of_shared=".$shared_counter." where id=". $RS->fields['customer_campaign_code'];
									
									 $objDB->Conn->Execute($sql);*/
								$objDBWrt->Conn->Execute("update campaigns set no_of_shared=? where id=?",array($shared_counter,$RS->fields['customer_campaign_code']));
									 /***ich */
								
								
								//-- start for point deduction
								
								
								
								/*$Sql = "Update campaigns set block_point =".$deduct_points." where id=".$RS->fields['customer_campaign_code'];
								
								$objDB->Conn->Execute($Sql);*/
								$objDBWrt->Conn->Execute("Update campaigns set block_point =? where id=?",array($deduct_points,$RS->fields['customer_campaign_code']));

								
								//-- End of point deduction	
									// review insert here //
								/*$sql = "update reward_user set review_rating_visibility = 1 where customer_id=".$RS->fields['customer_id']." and location_id= ".$RS->fields['location_id']." and campaign_id=".$RS->fields['customer_campaign_code'];
									$rs = $objDB->Conn->Execute($sql);*/
								$rs = $objDBWrt->Conn->Execute("update reward_user set review_rating_visibility = ? where customer_id=? and location_id=? and campaign_id=?",array(1,$RS->fields['customer_id'],$RS->fields['location_id'],$RS->fields['customer_campaign_code']));

								$json_array['status'] = "true";
								$json_array['id'] = $RS->fields['customer_campaign_code'];
								$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_coupon_redeemed"];
								$_SESSION['msg'] = $merchant_msg["redeem-deal"]["Msg_coupon_redeemed"];
								$json = json_encode($json_array);
								$objDB->Conn->CompleteTrans(); 
								echo $json;
								return $json;
						}
										else
										{
										// review insert here //
									/*$sql = "update reward_user set review_rating_visibility = 1 where customer_id=".$RS->fields['customer_id']." and location_id= ".$RS->fields['location_id']." and campaign_id=".$RS->fields['customer_campaign_code'];
									$rs = $objDB->Conn->Execute($sql);*/
				$rs = $objDBWrt->Conn->Execute("update reward_user set review_rating_visibility = ? where customer_id=? and location_id=? and campaign_id=?",array(1,$RS->fields['customer_id'],$RS->fields['location_id'],$RS->fields['customer_campaign_code']));

											//$rs = $objDB->Conn->Execute($sql);
											$json_array['status'] = "true";
								$json_array['id'] = $RS->fields['customer_campaign_code'];
								$json_array['message'] =$merchant_msg["redeem-deal"]["Msg_campaign_ended"];
								$_SESSION['msg'] = $merchant_msg["redeem-deal"]["Msg_campaign_ended"];
								$json = json_encode($json_array);
								//$objDB->Conn->CompleteTrans();
								$objDB->Conn->CompleteTrans(); 								
								echo $json;
								return $json;
										}
									   }
						
				}
			}
		}
		else // Wrong data
        {
             $json_array['loginstatus'] = "true";
            $json_array['status'] = "false";
            $json_array['message'] = $merchant_msg["redeem-deal"]["Msg_coupon_code_not_exist"];
            $json = json_encode($json_array);
			$objDB->Conn->CompleteTrans(); 
            echo $json;
            return $json;
        } 		
	}
	else
	{
		$json_array['loginstatus'] = "true";
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_enter_proper_coupon_code"];
		$json = json_encode($json_array);
		$objDB->Conn->CompleteTrans(); 
		echo $json;
		return $json;
	}
	}catch (Exception $e) {
	$json_array = array();
	$json_array['status'] = "false";
					$json_array['message'] = "My sql error cuming".$e->getMessage();
$json = json_encode($json_array);
$objDB->Conn->CompleteTrans(); 
			echo $json;
			return $json;
			exit;
  
}
}
// bsb

// templates
/******** 
@USE : Get All Templates
@PARAMETER : current login merchant id
@RETURN : Tempalte list
@USED IN PAGES : Templates.php
@Explaination : - Main merchant will get all templates which are created by own and by his employees as well as super admin
*********/

if(isset($_REQUEST['btnGetAllTemplateOfMerchant']))
{
	$start_index = 0;
	$num_of_records = 8;
	$next_index = $start_index + $num_of_records;
										
	 $json_array = array();
	 $records = array();
	
	 $merchant_id = $_REQUEST['mer_id'];
	 //$main_merchant_id = $_REQUEST['main_merchant_id'];
         
         // to show child templates
         $arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
	 
         $ids=  implode(",", $arr_ids);
         
	  $arr_ids1=getallmainmercahnt_id($_REQUEST['mer_id']);
	 $ids1=  implode(",", $arr_ids1);
         
	 
	 
         if($ids=="")
            $ids=$_REQUEST['mer_id'];
	 if($ids1=="")
            $ids1=$_REQUEST['mer_id'];   
	 
	 //$Sql = "SELECT * FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1)) ORDER BY modified_date DESC";
     
    /* $Sql = "SELECT * FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1) or created_by in($ids) or created_by in ($ids1)) ORDER BY modified_date DESC";
	 
	 // to show child templates
	 
	 $RS = $objDB->Conn->Execute($Sql);*/
	 
	$RS = $objDB->Conn->Execute("SELECT * FROM campaigns_template WHERE (created_by=? or (created_by=? and is_default=?) or created_by in(?) or created_by in (?)) ORDER BY modified_date DESC",array($merchant_id,0,1,$ids,$ids1));
	
	$RS1 = $objDB->Conn->Execute("SELECT * FROM campaigns_template WHERE (created_by=? or (created_by=? and is_default=?) or created_by in(?) or created_by in (?)) ORDER BY modified_date DESC limit 0,$num_of_records",array($merchant_id,0,1,$ids,$ids1));

	 if($RS1->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS1->RecordCount();
			$json_array['total_template_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS1->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json_array['total_template_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

// templates
/******** 
@USE : Get more Templates using ajax
@PARAMETER : current login merchant id , next index, num_of_records
@RETURN : Tempalte list
@USED IN PAGES : add-campaign.php
@Explaination : - 
*********/

if(isset($_REQUEST['btnGetTemplateOfMerchant_ajax']))
{
	$start_index = $_REQUEST['next_index'];
	$num_of_records = $_REQUEST['num_of_records'];
	$next_index = $start_index + $num_of_records;
							
	$html="";		
		
	 $json_array = array();
	 $records = array();
	
	 $merchant_id = $_SESSION['merchant_id'];
	 //$main_merchant_id = $_REQUEST['main_merchant_id'];
         
         // to show child templates
         $arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
	 
         $ids=  implode(",", $arr_ids);
         
	  $arr_ids1=getallmainmercahnt_id($_SESSION['merchant_id']);
	 $ids1=  implode(",", $arr_ids1);
         
	 
	 
         if($ids=="")
            $ids=$_SESSION['merchant_id'];
	 if($ids1=="")
            $ids1=$_SESSION['merchant_id'];
	 
	 //$Sql = "SELECT * FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1)) ORDER BY modified_date DESC";
     
    /* $Sql = "SELECT * FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1) or created_by in($ids) or created_by in ($ids1)) ORDER BY modified_date DESC";
	 
	 // to show child templates
	 
	 $RS = $objDB->Conn->Execute($Sql);*/
	 
	//$RS = $objDB->Conn->Execute("SELECT * FROM campaigns_template WHERE (created_by=? or (created_by=? and is_default=?) or created_by in(?) or created_by in (?)) ORDER BY modified_date DESC",array($merchant_id,0,1,$ids,$ids1));
	
	$RS1 = $objDB->Conn->Execute("SELECT * FROM campaigns_template WHERE (created_by=? or (created_by=? and is_default=?) or created_by in(?) or created_by in (?)) ORDER BY modified_date DESC limit $start_index,$num_of_records",array($merchant_id,0,1,$ids,$ids1));

	//echo "SELECT * FROM campaigns_template WHERE (created_by=".$merchant_id." or (created_by=0 and is_default=1) or created_by in(".$ids.") or created_by in (".$ids1.")) ORDER BY modified_date DESC limit $start_index,$num_of_records";	
	 if($RS1->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		 	
		  $json_array['records_return'] = $RS1->RecordCount();
			//$json_array['total_template_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS1->FetchRow())
		  {
			  
			
				$html.='<div class="col-md-3"><div class="template-image">';
				$html.='<img alt="tempalate-image" src="'.ASSETS_IMG .'/m/campaign/'.$Row['business_logo'].'">';
				$html.='</div></div>';
			
		  }
		  
		  $json_array['html'] = $html ;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  	$json_array['html'] = $html ;
		  $json_array['records_return'] = $RS1->RecordCount();
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

/******** 
@USE : to delete template
@PARAMETER : id
@RETURN : success
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnDeleteTemplate']))
{
	$array_where = array();
	$array_where['id'] = $_REQUEST['id'];
	$objDBWrt->Remove("campaigns_template", $array_where);
	echo "success";
	exit();
}
/******** 
@USE : get all templates
@PARAMETER : mer_id, start_index, num_of_records
@RETURN : json data
@USED IN PAGES : templates.php
*********/
if(isset($_REQUEST['btnGetAllTemplateOfMerchant_limit']))
{
	 $json_array = array();
	 $records = array();
	
	$start_index =  $_REQUEST['start_index'];
	$num_of_records = $_REQUEST['num_of_records'];
	$next_index = $start_index + $num_of_records;
	
	 $merchant_id = $_REQUEST['mer_id'];
	 //$main_merchant_id = $_REQUEST['main_merchant_id'];
         
         // to show child templates
         $arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
	 
         $ids=  implode(",", $arr_ids);
         
	  $arr_ids1=getallmainmercahnt_id($_REQUEST['mer_id']);
	 $ids1=  implode(",", $arr_ids1);
         
	 
	 
         if($ids=="")
            $ids=$_REQUEST['mer_id'];
	 if($ids1=="")
            $ids1=$_REQUEST['mer_id'];   
	 
	 //$Sql = "SELECT * FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1)) ORDER BY modified_date DESC";
     
     //$Sql = "SELECT * FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1) or created_by in($ids) or created_by in ($ids1)) ORDER BY modified_date DESC";
	
	/* $Sql = "SELECT * FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1) or created_by in($ids) or created_by in ($ids1)) ORDER BY modified_date DESC limit $start_index,$num_of_records" ;
	 $Sql1 = "SELECT count(*) total FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1) or created_by in($ids) or created_by in ($ids1)) ORDER BY modified_date DESC" ;*/
	 
	 // to show child templates
	 
	 //$RS1 = $objDB->Conn->Execute($Sql1);
	$RS1 = $objDB->Conn->Execute("SELECT count(*) total FROM campaigns_template WHERE (created_by=? or (created_by=? and is_default=?) or created_by in(?) or created_by in (?)) ORDER BY modified_date DESC",array($merchant_id,0,1,$ids,$ids1));
	 $total_templates = $RS1->fields['total'];
	 
	 //$RS = $objDB->Conn->Execute($Sql);
	$RS = $objDB->Conn->Execute("SELECT * FROM campaigns_template WHERE (created_by=? or (created_by=? and is_default=?) or created_by in(?) or created_by in (?)) ORDER BY modified_date DESC limit $start_index,$num_of_records",array($merchant_id,0,1,$ids,$ids1));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $json_array['total_templates'] = $total_templates;

		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}
/******** 
@USE : get templates show more
@PARAMETER : next_index, num_of_records
@RETURN : json data
@USED IN PAGES : templates.php
*********/
if(isset($_REQUEST['show_more_template_media']))
{
	 $json_array = array();
	 $records = array();
	
	$start_index =  $_REQUEST['next_index'];
	$num_of_records = $_REQUEST['num_of_records'];
	$next_index = $start_index + $num_of_records;
	
	 $merchant_id = $_SESSION['merchant_id'];
	 //$main_merchant_id = $_REQUEST['main_merchant_id'];
         
         // to show child templates
         $arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
	 
         $ids=  implode(",", $arr_ids);
         
	  $arr_ids1=getallmainmercahnt_id($_SESSION['merchant_id']);
	 $ids1=  implode(",", $arr_ids1);
         
	 
	 
         if($ids=="")
            $ids=$_SESSION['merchant_id'];
	 if($ids1=="")
            $ids1=$_SESSION['merchant_id'];   
	 
	 //$Sql = "SELECT * FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1)) ORDER BY modified_date DESC";
     
     //$Sql = "SELECT * FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1) or created_by in($ids) or created_by in ($ids1)) ORDER BY modified_date DESC";
	
	 /*$Sql = "SELECT * FROM campaigns_template WHERE (created_by=$merchant_id or (created_by=0 and is_default=1) or created_by in($ids) or created_by in ($ids1)) ORDER BY modified_date DESC limit $start_index,$num_of_records" ;
	 
	 // to show child templates
	 
	 $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * FROM campaigns_template WHERE (created_by=? or (created_by=? and is_default=?) or created_by in(?) or created_by in (?)) ORDER BY modified_date DESC limit $start_index,$num_of_records",array($merchant_id,0,1,$ids,$ids1));
	 $html="";
	 
	$arr=file(WEB_PATH.'/merchant/process.php?btnGetMerchantRole=yes&mer_id='.$_SESSION['merchant_id']);
	if(trim($arr[0]) == "")
	{
		unset($arr[0]);
		$arr = array_values($arr);
	}
	$json = json_decode($arr[0]);
	$total_records1= $json->total_records;
	$records_array1 = $json->records;

	if($total_records1>0)
	{
		foreach($records_array1 as $Row_role)
		{
			$Row_role->merchant_user_id;
			$ass_page = unserialize($Row_role->ass_page);
			$ass_role = unserialize($Row_role->ass_role);
		}
	}
	
	$merchant_parent_value = $_SESSION['merchant_info']['merchant_parent'];
	
	$active_locations =1;
	
	if($_SESSION['merchant_info']['merchant_parent'] == 0)
	{
		/* * ****** check if any active location is there or not if not then dont allow to add campaign  ***************** */

		$arr=file(WEB_PATH.'/merchant/process.php?is_any_active_location=yes&merchant_id='.$_SESSION['merchant_id']);
		if(trim($arr[0]) == "")
		{
				unset($arr[0]);
				$arr = array_values($arr);
		}
		$json = json_decode($arr[0]);
		$active_locations = $json->active_locations;
	}
	
	$arr_c=file(WEB_PATH.'/merchant/process.php?num_campaigns_per_month=yes&mer_id='.$_SESSION['merchant_id']);

	if(trim($arr_c[0]) == "")
	{
		unset($arr_c[0]);
		$arr_c = array_values($arr_c);
	}
	$json = json_decode($arr_c[0]);

	$total_campaigns= $json->total_records;
	$addcampaign_status = $json->status;
	$max_camapign = $json->max_campaigns;
    
    $merchant_parent_value = $_SESSION['merchant_info']['merchant_parent'];
	$array1['id'] = $merchant_parent_value;
	$RS1 = $objDB->Show("merchant_user",$array1);
	
    /*    
	echo "<pre>";
	print_r($ass_page);
	echo "</pre>";
	echo "<br/>";
	echo "parent = ".$merchant_parent_value."<br/>";
	echo "active_locations = ".$active_locations."<br/>";
	echo "addcampaign_status = ".$addcampaign_status."<br/>";
	exit();
	*/
	 
	if($RS->RecordCount()>0)
	{
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	//$records[$count] = get_field_value($Row);
		   	//$count++;
		   	$html.='<div class="mediya_template_blk" cat_id="'.$Row['category_id'].'">
					<img src="'.ASSETS_IMG.'/m/campaign/'.$Row['business_logo'].'" class= "mediya_template_grid" />
					<div class="mediya_template_blk_Action">';
						if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-template.php",$ass_page) || in_array("delete-template.php",$ass_page) )
						{
							if($merchant_parent_value == 0)
							{
								if($_SESSION['merchant_info']['approve'] == 2)
								{
								}
								else
								{
									if($Row->is_default ==0)
									{	   
										if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("edit_template.php",$ass_page))
										{
											$html.='<a href="javascript:void(0)" id="temp_edit_'.$Row['id'].'" class="temp_edit temp_actions" title="Edit" link="edit_template.php?id='.$Row['id'].'">
												<img src="'.ASSETS_IMG.'/m/template_edit.png">
											</a>';
										}
										if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("delete-template.php",$ass_page) )
										{
											$html.='<a href="javascript:void(0)" id="temp_delete_'.$Row['id'].'" class="temp_delete temp_actions" title="Delete" link="templates.php?id='.$Row['id'].'&action=delete">
												<img src="'.ASSETS_IMG.'/m/mediya_delete.png">
											</a>';
										}
										if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-compaign.php",$ass_page) )
										{
											if($active_locations>0) 
											{
												if($addcampaign_status=="true") 
												{
													$html.='<a href="javascript:void(0)" id="temp_create_'.$Row['id'].'" class="temp_create temp_actions" title="Create Campaign" link="add-compaign.php?template_id='.$Row['id'].'">
														<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
													</a>';
												}
											}
										}
									}
									else
									{
										$html.='<a href="javascript:void(0)" id="temp_customize_'.$Row['id'].'" class="temp_customize temp_actions" title="Customize" link="customize-template.php?id='.$Row['id'].'">
											<img src="'.ASSETS_IMG.'/m/template_customize.png">
										</a>';
										
										if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-compaign.php",$ass_page) )
										{
											if($active_locations>0) 
											{
												if($addcampaign_status=="true") 
												{
													$html.='<a href="javascript:void(0)" id="temp_create_'.$Row['id'].'" class="temp_create temp_actions" title="Create Campaign" link="add-compaign.php?template_id='.$Row['id'].'">
														<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
													</a>';
												}
											}
										}
									}
								}
							}
							else
							{
								if($RS1->fields['approve'] == 2)
							    { 
							    } 
							    else
							    {
									if($Row['is_default'] ==0)
									{
										if (in_array($Row['created_by'], $all_main_mer_array)) 
									    {
											$html.='<a href="javascript:void(0)" id="temp_customize_'.$Row['id'].'" class="temp_customize temp_actions" title="Customize" link="customize-template.php?id='.$Row['id'].'">
												<img src="'.ASSETS_IMG.'/m/template_customize.png">
											</a>';
										
											if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-compaign.php",$ass_page) )
											{
												if($active_locations>0) 
												{
													if($addcampaign_status=="true") 
													{
														$html.='<a href="javascript:void(0)" id="temp_create_'.$Row['id'].'" class="temp_create temp_actions" title="Create Campaign" link="add-compaign.php?template_id='.$Row['id'].'">
															<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
														</a>';
													}
												}
											}
										}
										else
										{
											if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("edit_template.php",$ass_page))
											{
												$html.='<a href="javascript:void(0)" id="temp_edit_'.$Row['id'].'" class="temp_edit temp_actions" title="Edit" link="edit_template.php?id='.$Row['id'].'">
													<img src="'.ASSETS_IMG.'/m/template_edit.png">
												</a>';
											}
											if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("delete-template.php",$ass_page) )
											{
												$html.='<a href="javascript:void(0)" id="temp_delete_'.$Row['id'].'" class="temp_delete temp_actions" title="Delete" link="templates.php?id='.$Row['id'].'&action=delete">
													<img src="'.ASSETS_IMG.'/m/mediya_delete.png">
												</a>';
											}
											if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-compaign.php",$ass_page) )
											{
												if($active_locations>0) 
												{
													if($addcampaign_status=="true") 
													{
														$html.='<a href="javascript:void(0)" id="temp_create_'.$Row['id'].'" class="temp_create temp_actions" title="Create Campaign" link="add-compaign.php?template_id='.$Row['id'].'">
															<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
														</a>';
													}
												}
											}
											if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-template.php",$ass_page) )
											{
												$html.='<a href="javascript:void(0)" id="temp_customize_'.$Row['id'].'" class="temp_customize temp_actions" title="Customize" link="customize-template.php?id='.$Row['id'].'">
													<img src="'.ASSETS_IMG.'/m/template_customize.png">
												</a>';
											}
										}
									}
									else
								    {
										$html.='<a href="javascript:void(0)" id="temp_customize_'.$Row['id'].'" class="temp_customize temp_actions" title="Customize" link="customize-template.php?id='.$Row['id'].'">
											<img src="'.ASSETS_IMG.'/m/template_customize.png">
										</a>';
									}
								}
							}
						}
						else
						{	
							if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-compaign.php",$ass_page) )
							{
								if($active_locations>0) 
								{
									if($addcampaign_status=="true") 
									{
										$html.='<a href="javascript:void(0)" id="temp_create_'.$Row['id'].'" class="temp_create temp_actions" title="Create Campaign" link="add-compaign.php?template_id='.$Row['id'].'">
											<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
										</a>';
									}
								}
							}
						}
						/*					
						$html.='<a href="javascript:void(0)" id="temp_edit_'.$Row['id'].'" class="temp_edit temp_actions" title="Edit" link="edit_template.php?id='.$Row['id'].'">
							<img src="templates/images/template_edit.png">
						</a>';
						
						$html.='<a href="javascript:void(0)" id="temp_delete_'.$Row['id'].'" class="temp_delete temp_actions" title="Delete" link="templates.php?id='.$Row['id'].'&action=delete">
							<img src="templates/images/mediya_delete.png">
						</a>';
						
						$html.='<a href="javascript:void(0)" id="temp_customize_'.$Row['id'].'" class="temp_customize temp_actions" title="Customize" link="customize-template.php?id='.$Row['id'].'">
							<img src="templates/images/template_customize.png">
						</a>';
						
						$html.='<a href="javascript:void(0)" id="temp_create_'.$Row['id'].'" class="temp_create temp_actions" title="Create Campaign" link="add-compaign.php?template_id='.$Row['id'].'">
							<img src="templates/images/add_image_to_lbry.png">
						</a>';
						*/ 
						
			$html.='</div>
					<span id="media_template_name" title="'.$Row['title'].'">'.$Row['title'].'</span>
				</div>';
		  }
	 }
	 
	 $json_array['status'] = "true";
	 $json_array['total_records'] = $RS->RecordCount();
	 $json_array['html'] = $html ;
	 $json_array['records_return'] = $RS->RecordCount();
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

/***** 
@USE : Get employee role 
@PERAMETER : current login user
@RETURN : role access information
@USED IN PAGES : compaigns.php , locations.php , manage-customers.php , template.php , manage-customers.php
******/
if(isset($_REQUEST['btnGetMerchantRole']))
{
	 $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
	 
	 /*$Sql = "SELECT * from merchant_user_role where merchant_user_id =$merchant_id";
	 
	 $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * from merchant_user_role where merchant_user_id =?",array($merchant_id));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
                   $json_array["records"]= "";
		  $json = json_encode($json_array);
                  
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

/****
@USE : Get location list of login merchant
-	If main merchant then get all active locations 
-	If location employee  is login  then  get employee\91s assigned location information
@PARAMETER : 
-   If main merchant is login then login merchant id ( store in session - $_SESSION['merchant_id'])
-	If location employee  is login  then login employee id and assigned location id
@RETURN : 
-   If main merchant then location list in json formate
-	If location employee  is login then location information of passed campaign id 
@USED IN PAGES : compaigns.php , reports.php
****/

if(isset($_REQUEST['btnGetAllLocationOfMerchant']))
{
	 $json_array = array();
	 $records = array();
	 $merchant_id = $_REQUEST['mer_id'];
	 if(isset($_REQUEST['loc_id']) && $_REQUEST['loc_id'] !="")
	 {
		//$location_val = isset($_REQUEST['loc_id']);
               
	 	//$Sql = "SELECT * FROM locations WHERE id in (select l.id from locations l where  l.created_by=$merchant_id and l.id =$location_val) and active=1 ORDER BY id DESC";
                //$Sql = "SELECT * FROM locations WHERE id =".$_REQUEST['loc_id']." and active=1";
		$RS = $objDB->Conn->Execute("SELECT * FROM locations WHERE id =? and active=?",array($_REQUEST['loc_id'],1));
	
	 }
	 else
	 {
		//$Sql = "SELECT * FROM locations WHERE created_by=$merchant_id  and active=1 ORDER BY id DESC"; 
		$RS = $objDB->Conn->Execute("SELECT * FROM locations WHERE created_by=?  and active=? ORDER BY id DESC",array($merchant_id,1));
	
	 }
         
	
	 //$RS = $objDB->Conn->Execute($Sql);
        
	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
          $json_array["records"]= "";
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
//	 print_r($json_array);
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

/******** 
@USE : get location info
@PARAMETER : mer_id, loc_id
@RETURN : json data
@USED IN PAGES : locationcopy-ajax.php
*********/
if(isset($_REQUEST['getlocationinfo']))
{
    $json_array = array();
    $location_val=0;        
    $records = array();
         if(isset($_REQUEST['mer_id']))
         {
            $merchant_id = $_REQUEST['mer_id'];
         }
         if(isset($_REQUEST['loc_id']))
         {
            $location_val = $_REQUEST['loc_id'];
         }
        
         
       /* $Sql = "SELECT * FROM locations WHERE id =".$location_val." and active=1";
	
        $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * FROM locations WHERE id =? and active=?",array($location_val,1));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";

		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
                  $json_array['sql'] = $Sql;
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
                  $json_array["records"]= "";
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
//	 print_r($json_array);
	 $json = json_encode($json_array);
	 echo $json;
	 exit(); 
}
/***** 
@USE : Status of location 
@PERAMETER : location id
@RETURN : location status , and color related status which is set lanagauage/merchant-lable file
@USED IN PAGES :  locations.php ,location-edit.php
@EXPLAINATION :
  - status -> Active in use : campaigns are currently linked to the location  
			  Active not in use : Campaigns are currently not linked to the location.
			  Not Active : Location is de-activated.
******/
if(isset($_REQUEST['getlocationstatus']))
{
$json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
	 $Where .= " a.location_id = ".$_REQUEST['loc_id']." and (a.active =1 or a.active_in_future=1 or (b.start_date  > CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) )";
	 $Sql="SELECT distinct b.id 
from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id 
where ".$Where ;
	$RS = $objDB->Conn->Execute($Sql);
	 
	 if($RS->RecordCount()>0)
	 {
	 $json_array['status'] = "true";
	 $json_array['deactivating'] = 0;
	  $json_array['location_status'] = $merchant_msg["locations"]['Field_Satus_Active-In-Use'];;
	   $json_array['mapping_status'] = "active-inuse";
	   $json_array['color'] = $merchant_msg["locations"]['Field_Satus_Active-In-Use-Color'];
		 
	  }
	else{
	 $Sql = "select * from campaign_location where location_id= ".$_REQUEST['loc_id'];
		 $RS_new = $objDB->Conn->Execute($Sql);
		 $json_array['status'] = "true";
		 $json_array['deactivating'] = 1;
		 $json_array['mapping_status'] = "active-notinuse";
		 $json_array['color'] = $merchant_msg["locations"]['Field_Satus_Active-Not-In-Use-Color'];
		 $json_array['location_status'] = $merchant_msg["locations"]['Field_Satus_Active-Not-In-Use'];;
}	
	
	
//	 print_r($json_array);
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

/******** 
@USE : Get all location list of login merchant user
@PARAMETER : current login merchant id
@RETURN : Location list
@USED IN PAGES : locations.php , locations_for_marketing material
*********/
if(isset($_REQUEST['btnGetAllLocationforgrid']))
{
	 $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
	 
	$array_where = array();
	$array_where_user['id'] = $_SESSION['merchant_id'];
	$RS_User = $objDB->Show("merchant_user", $array_where_user);
	$merchant_parent_value = $RS->fields['merchant_parent'];

	$array1['id'] = $merchant_parent_value;
	$RS1 = $objDB->Show("merchant_user", $array1);

	/* 
	 * Paging
	 */
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'].", ".
			 $_REQUEST['iDisplayLength'] ;
	}

	/**
	* Searching	
	*/
	
	$search ='';
	if(isset($_REQUEST['lstatus'])){
		if($_REQUEST['lstatus']	==1 ){
			$search ='AND l.active =1';		
		}
		if($_REQUEST['lstatus']	==3 ){
			$search ='AND l.active =0';		
		}
		
	}

	 if(isset($_REQUEST['loc_id']))
	 {
		$location_val = $_REQUEST['loc_id'];
	 	/*$Sql = "SELECT * FROM locations WHERE id in (select l.id from locations l where  l.created_by=$merchant_id and l.id =$location_val) ORDER BY modified_date DESC";*/
		$RS = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS * FROM locations WHERE id in (select l.id from locations l where  l.created_by=? and l.id =?) ORDER BY modified_date DESC ".$sLimit,array($merchant_id,$location_val));
		
	 }
	 else
	 {
		//$Sql = "SELECT * FROM locations WHERE created_by=$merchant_id  ORDER BY modified_date DESC"; 
		//$Sql = "SELECT id,location_name,address,city,state,zip,phone_number,created_by,active FROM locations WHERE created_by=$merchant_id  ORDER BY modified_date DESC"; 
		/*
		$RS = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS l.id,l.location_name,l.address,l.city,l.state,l.zip,l.phone_number,l.created_by,l.active,count(c.id)
lstatus,count(c1.id) active_campaigns  FROM locations l   
    left JOIN campaign_location cl
     ON cl.location_id=l.id 
	left JOIN campaigns c  
     ON cl.campaign_id=c.id and (cl.active =1 or cl.active_in_future=1 or (c.start_date > CONVERT_TZ(NOW(),'-06:00',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) ) )
	left JOIN campaigns c1  
     ON cl.campaign_id=c1.id and CONVERT_TZ(NOW(),'-06:00',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN c.start_date AND c.expiration_date and cl.active =1 and cl.active_in_future<>1
        WHERE l.created_by=? ".$search." group by l.id ORDER BY l.modified_date DESC ".$sLimit,array($merchant_id));
        */
        $RS = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS l.id,l.location_name,l.address,l.city,l.state,l.zip,l.phone_number,l.created_by,l.active 
				FROM locations l 
				WHERE l.created_by=? ".$search." group by l.id ORDER BY l.modified_date DESC ".$sLimit,array($merchant_id));

	 }
	        $sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
		$total= $sQuery->fields['FOUND_ROWS()'];
	// $RS = $objDB->Conn->Execute($Sql);

		$Json = array();
                $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
                $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
                $Json['iTotalDisplayRecords'] = $total;
                $Json['sEcho'] = $_REQUEST['sEcho'];
                $Json['sSearch'] = $_REQUEST['sSearch'];
                $Json['aaData'] = array();
		
	 	if($RS->RecordCount()>0)
                {
                        $k =0;
			while($Row = $RS->FetchRow())
		 	{
				if ($Row['active'] != 1) {
                                       $css = "background-color:#E1E1E1";
                                }
				$array_where = array();
				$array_where['id'] = $Row['state'];
				$RS_state = $objDB->Show("state", $array_where);

				$array_where = array();
				$array_where['id'] = $Row['city'];
				$RS_city = $objDB->Show("city", $array_where);

				//$Json['aaData'][$k][]=$Row['address'] . ", " . $Row['city'] . ", " . $Row['state'] . ", " . $Row['zip'];
				$Json['aaData'][$k][]=$Row['address'] . ", " . $RS_city->fields['name'] . ", " . $RS_state->fields['short_form'] . ", " . $Row['zip'];
				$phno = explode("-", $Row['phone_number']);
                                $newphno = "(".$phno[1].") ".$phno[2]."-".$phno[3];

				$Json['aaData'][$k][]=$newphno;
				/*
				$Json['aaData'][$k][]=$Row['active_campaigns'];

				if ($Row['lstatus'] > 0) {
					$deactivating = 0;
					$location_status= $merchant_msg["locations"]['Field_Satus_Active-In-Use'];
					$mapping_status = "active-inuse";
					$color = $merchant_msg["locations"]['Field_Satus_Active-In-Use-Color'];
					
				}else {
					$deactivating = 1;
					$location_status= $merchant_msg["locations"]['Field_Satus_Active-Not-In-Use'];
					$mapping_status = "active-notinuse";
					$color = $merchant_msg["locations"]['Field_Satus_Active-Not-In-Use-Color'];
				}
				if ($Row['active'] != 1) {
                                       $deactivity = 1;
					$Json['aaData'][$k][]='<span style="color:' . $merchant_msg["locations"]['Field_Satus_Not-Active-Color'] . '" >' . $merchant_msg["locations"]['Field_Satus_Not-Active'] . '</span>';
                                }else{
					$deactivity = $deactivating;
					$Json['aaData'][$k][]='<span style="color:' . $color . '" >' . $location_status . '</span>';
				}
				*/
				if ($Row['active'] == 1) 
				{
					$color = $merchant_msg["locations"]['Field_Satus_Active-In-Use-Color'];
					$location_status= $merchant_msg["locations"]['Field_Satus_Active-In-Use'];
					$Json['aaData'][$k][]='<span style="color:' . $color . '" >' . $location_status . '</span>';
				}
				else
				{
					$color = $merchant_msg["locations"]['Field_Satus_Not-Active-Color'];
					$location_status= $merchant_msg["locations"]['Field_Satus_Not-Active'];
					$Json['aaData'][$k][]='<span style="color:' . $color . '" >' . $location_status . '</span>';
				}
				$html ='<div class="action_wrapper">';
				$html .='<div id="actiondiv" class="actiondivclass" >';
				if ($merchant_parent_value == 0) {

					if ($RS_User->fields['approve'] != 2) {
						if ($_SESSION['merchant_info']['merchant_parent'] == 0) {
							$html .='<a class="commonclass" link="edit-location.php?id='.$Row['id'].'" href="javascript:void(0);">Edit</a>';
						
							if ($RS_User->fields['location_detail_display'] == 1) {
								//$html .='<a class="commonclass" link="edit-location-detail.php?id='.$Row['id'].'" href="javascript:void(0);">Edit Detail</a>';
							}
							if ($RS_User->fields['menu_price_display'] == 1) {
								//$html .='<a class="updatemenu" id="" link="'.$Row['id'].'" href="javascript:void(0);">Update Menu/Price</a>';							
							}
							//if ($deactivity == 1) {
								if ($Row['active'] == 1) {
									$html .='<a class="commonclass" link="process.php?id='.$Row['id'].'&btnActivateDeactivateLocation=yes&action=0" href="javascript:void(0);">Deactivate</a>';
								}else{
									$html .='<a class="commonclass" link="process.php?id='.$Row['id'].'&btnActivateDeactivateLocation=yes&action=1" href="javascript:void(0);">Activate</a>';
								}
							//}
						}

						
					}
				}else{
					if ($RS_User->fields['approve'] != 2) {
						if ($_SESSION['merchant_info']['merchant_parent'] == 0) {
							$html .= '<a class="commonclass" link="edit-location.php?id='.$Row['id'].'" href="javascript:void(0);">Edit</a>';
							if ($deactivity == 1) {
								if ($Row['active'] == 1) {
									$html .='<a class="commonclass" link="process.php?id='.$Row['id'].'&btnActivateDeactivateLocation=yes&action=0" href="javascript:void(0);">Deactivate</a>';
								}else{
									$html .='<a class="commonclass" link="process.php?id='.$Row['id'].'&btnActivateDeactivateLocation=yes&action=1" href="javascript:void(0);">Activate</a>';
								}
							}
						}
					}
				}
				$html .='</div>';
				$html .='</div>';
 				$Json['aaData'][$k][]= 'More  Actions '.$html;
				$k++;
			}
			      
                }
	echo json_encode($Json);
         
        exit;

}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnGetLocationListOfMerchant']))
{
	 $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
	 $mer_parent_id = $_REQUEST['mer_parent_id'];
	
	 	/*$Sql = "SELECT * FROM locations WHERE id in (select l.id from locations l where l.created_by=$mer_parent_id and l.id =(select location_access from merchant_user_role where merchant_user_id = $merchant_id))";
	
	
	 $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * FROM locations WHERE id in (select l.id from locations l where l.created_by=? and l.id =(select location_access from merchant_user_role where merchant_user_id = ?))",array($mer_parent_id,$merchant_id));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
//	 print_r($json_array);
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

/******** 
@USE : publish/unpublish pricelist
@PARAMETER : 
@RETURN : json data
@USED IN PAGES : pricelist.php
*********/
if(isset($_REQUEST['publish_pricelist']))
{
	$json_array = array();
	$records = array();
	$html="";
	$pricelist_id = $_REQUEST['pricelist_id'];
	$publish = $_REQUEST['publish'];
	 
	$array_values = $where_clause = $array = array();
	$array_values['publish'] = $publish;
	$where_clause['id'] = $pricelist_id;
	$objDBWrt->Update($array_values, "pricelists", $where_clause);
	/*
	$html.='<table class="table display" id="pricelist_table">
			<thead>
				<tr>
					<th></th>
					<th>Pricelist Name</th>
					<th>Last Updated</th>
					<th>Display order</th>
					<th>Publish status</th>
					<th>Pricelist type</th>

					<th>Actions</th>
			</tr>
			</thead>
			<tbody>';
				
				
					$errors=0;
					//include("dbconnect.php");
					$TableName= "pricelists";
					if($errors ==0){
						$SQLstring = 'SELECT * FROM '.$TableName.' where merchant_id='.$_SESSION['merchant_id'].' ORDER BY display_order ASC';
						$QueryResult = mysql_query($SQLstring);
						if($QueryResult !=0){
							while($Row = mysql_fetch_row($QueryResult)){
							$publish;
							 if($Row[4] == 0 ){ 
							 	$publish= 'publish';
							 	$pbls=1;
							 }
							 else{
							  $publish ='unpublish';
							  $pbls=0;
							};
							$publish_status;
							$disable;
							 if($Row[4] == 0 ){ 
							 	$publish_status= 'not published';
							 	$disable = 'data-disabled="false"';
							 }
							 else{
							  $publish_status ='published';
							  $disable = 'data-disabled="true"';
							};
							$pricelist_type = mysql_fetch_array(mysql_query('select name from pricelist_type where id ='.$Row[7]));
							$html.='<tr data-id="'.$Row[0].'">
									<td><input type="checkbox" name="chkgrp" id="chk_'.$Row[0].'" value="'.$Row[0].'"></td>
									<td>'.$Row[1].'</td>
									<td>'.$Row[6].'</td>
									<td>'.$Row[5].'</td>
									<td>'.$publish_status.'</td>
									<td>'.$pricelist_type[0].'</td>
									<td>
										<div class="btn-group">
										  <button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
										    More<span class="caret"></span>
										  </button>
										  <ul class="dropdown-menu" role="menu">
										    <li><a  class="edit_pricelist">Edit</a></li>
										    <li><a class="delete_pricelist_row" '.$disable.'>Delete</a></li>
										    <li><a id="'.$Row[0].'" publish='.$pbls.' class="publish_pricelist_row">'.$publish.'</a></li>
										  </ul>
										   <form  class="edit_form" method="post" action="'.$pricelist_type[0].'_edit_pricelist.php">
											<input name="id" type="hidden" value="'.$Row[0].'"></div>
										  </form>
										  <form method="post" class="delete_form" action="delete_pricelist.php">
											<input name="id" type="hidden" value="'.$Row[0].'" ></div>
										  </form>
										  <form method="post" class="publish_form" action="publish.php">
											<input name="id" type="hidden" value="'.$Row[0].'"></div>
										  </form>
										</div>
									</td>

								</tr>';
								
							}
						}
						//mysql_close($DBConnect);
					}
					

			$html.='</tbody></table>';
	*/	
	
	$json_array['status'] = "true";
	//$json_array['html'] = $html;
	//print_r($json_array);
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : get locations of merchant for pricelist unassigned
@PARAMETER : 
@RETURN : json data
@USED IN PAGES : pricelist.php
*********/
if(isset($_REQUEST['btnGetLocationListForPricelistAssigned']))
{
	$json_array = array();
	$records = array();
	$html="";
	$merchant_id = $_SESSION['merchant_id'];
	$mer_parent_id = $_SESSION['merchant_info']['merchant_parent'];
	$pid=$_REQUEST['pid'];
	
	/*$Sql = "SELECT * FROM locations WHERE id in (select l.id from locations l where l.created_by=$mer_parent_id and l.id =(select location_access from merchant_user_role where merchant_user_id = $merchant_id))";
	$RS = $objDB->Conn->Execute($Sql);*/
	
	//$RS = $objDB->Conn->Execute("SELECT id,address,city,state,zip FROM locations WHERE created_by=?",array($merchant_id));
	$RS = $objDB->Conn->Execute("SELECT id,address,city,state,zip FROM locations WHERE created_by=? 
	and id not in (SELECT location_id FROM `location_pricelist` WHERE pricelist_id in(?))",array($merchant_id,$pid));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  $html.=' <div class="pl_detail_heading">Assign price list to location</div>
		  <div id="pl_l_error" class="pl_l_error">Please select at least one location</div>
		  <div class="assign_pl_header">
			 <table class="a_pl_table_heading" >
				 <tr >			
					<th class="pl_th_1" align="left"></th>
					<th class="pl_th_2" align="left">Location Address</th>
				</tr>
			</table>
			</div>
			<div class="assign_pl_body">
		    <table class="a_pl_table_main">';
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		   	
		   	$array_where = array();
			$array_where['id'] = $Row['state'];
			$RS_state = $objDB->Show("state", $array_where);

			$array_where = array();
			$array_where['id'] = $Row['city'];
			$RS_city = $objDB->Show("city", $array_where);
			
		   	$html.='<tr class="pl_tr">
					<td class=""><input type="checkbox" name="chkgrpl" id="chkl_'.$Row['id'].'" value="'.$Row['id'].'"> </td>
					<td class="pl_location_address"><label for="chkl_'.$Row['id'].'">'.$Row['address'].','.$RS_city->fields['name'].','.$RS_state->fields['short_form'].','.$Row['zip'].'</label></td>
				   </tr>';
		  }
		  $html.='</table></div>';
		  $html.='<div class="pl_asign_div"><button type="button" class="btn btn-primary" id="assign_pricelist_location">Save</button>
		<button type="button" class="btn btn-primary" id="assign_pricelist_cancel">Cancel</button></div>';
		  $json_array["records"]= $records;
		  $json_array["html"]= $html;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json_array["html"]= $html;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
//	 print_r($json_array);
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

/******** 
@USE : get locations of merchant for pricelist assigned
@PARAMETER : 
@RETURN : json data
@USED IN PAGES : pricelist.php
*********/
if(isset($_REQUEST['btnGetLocationListForPricelistUnassigned']))
{
	$json_array = array();
	$records = array();
	$html="";
	$merchant_id = $_SESSION['merchant_id'];
	$mer_parent_id = $_SESSION['merchant_info']['merchant_parent'];
	$pid=$_REQUEST['pid'];
	$pid=explode(",",$pid);
	//print_r($pid);
	//exit();
	$qry="";
	foreach($pid as $pd)
	{
		$qry.=" and id in (SELECT location_id FROM location_pricelist WHERE pricelist_id =".$pd.") ";
		//echo $pd."-";
	}

	//echo $qry;
	//exit();
	/*$Sql = "SELECT * FROM locations WHERE id in (select l.id from locations l where l.created_by=$mer_parent_id and l.id =(select location_access from merchant_user_role where merchant_user_id = $merchant_id))";
	$RS = $objDB->Conn->Execute($Sql);*/
	
	//$RS = $objDB->Conn->Execute("SELECT id,address,city,state,zip FROM locations WHERE created_by=?",array($merchant_id));
	$RS = $objDB->Conn->Execute("SELECT id,address,city,state,zip FROM locations WHERE created_by=? ".$qry,array($merchant_id));
	
	
	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  $html.=' <div class="pl_detail_heading">Unassign price list from location</div>
		  <div id="pl_l_error" class="pl_l_error">Please select at least one location</div>
		  <div class="assign_pl_header">
			 <table class="a_pl_table_heading" >
				 <tr >			
					<th class="pl_th_1" align="left"></th>
					<th class="pl_th_2" align="left">Location Address</th>
				</tr>
			</table>
			</div>
			<div class="assign_pl_body">
		    <table class="a_pl_table_main">';
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		   	
		   	$array_where = array();
			$array_where['id'] = $Row['state'];
			$RS_state = $objDB->Show("state", $array_where);

			$array_where = array();
			$array_where['id'] = $Row['city'];
			$RS_city = $objDB->Show("city", $array_where);
			
		   	$html.='<tr class="pl_tr">
					<td class=""><input type="checkbox" name="chkgrpl" id="chkl_'.$Row['id'].'" value="'.$Row['id'].'"> </td>
					<td class="pl_location_address"><label for="chkl_'.$Row['id'].'">'.$Row['address'].','.$RS_city->fields['name'].','.$RS_state->fields['short_form'].','.$Row['zip'].'</label></td>
				   </tr>';
		  }
		  $html.='</table></div>';
		  $html.='<div class="pl_asign_div"><button type="button" class="btn btn-primary" id="unassign_pricelist_location">Save</button>
		<button type="button" class="btn btn-primary" id="unassign_pricelist_cancel">Cancel</button></div>';
		  $json_array["records"]= $records;
		  $json_array["html"]= $html;
	 }
	 else
	 {
		 $html='<div class="pl_detail_heading">Unassign price list from location</div>
		  <div style="width:400px;">Price list is not assigned.</div>';
		 
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json_array["html"]= $html;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
//	 print_r($json_array);
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}


/******** 
@USE : assign pricelist to location
@PARAMETER : pricelist ids, location ids
@RETURN : json data
@USED IN PAGES : pricelist.php
*********/
if(isset($_REQUEST['btnAssignPricelistToLocation']))
{
	$json_array = array();
	$records = array();
	$pricelist_ids = $_REQUEST['pricelist_ids'];
	$location_ids = $_REQUEST['location_ids'];
	
	$pricelist_ids = explode(",",$pricelist_ids);
	$location_ids = explode(",",$location_ids);
	
	/* echo "<pre>";
	print_r($pricelist_ids);
	print_r($location_ids);
	echo "</pre>";
	exit(); */
	
	foreach ($pricelist_ids as $pl_value) 
	{
		$pricelist_id = $pl_value;
		
		foreach ($location_ids as $l_value) 
		{
			$location_id = $l_value;
			
			$RS_pl = $objDB->Conn->Execute("Select * from location_pricelist where location_id=? and pricelist_id=?",array($location_id,$pricelist_id));
			if($RS_pl->RecordCount()>0)
			{
			}
			else
			{
				$array_insert = array();
				$array_insert['location_id'] =  $location_id;
				$array_insert['pricelist_id'] = $pricelist_id;
				$objDBWrt->Insert($array_insert, "location_pricelist");
			}
		}
	}
	
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : unassign pricelist from location
@PARAMETER : pricelist ids, location ids
@RETURN : json data
@USED IN PAGES : pricelist.php
*********/
if(isset($_REQUEST['btnUnssignPricelistFromLocation']))
{
	$json_array = array();
	$records = array();
	$pricelist_ids = $_REQUEST['pricelist_ids'];
	$location_ids = $_REQUEST['location_ids'];
	
	$pricelist_ids = explode(",",$pricelist_ids);
	$location_ids = explode(",",$location_ids);
	
	/* echo "<pre>";
	print_r($pricelist_ids);
	print_r($location_ids);
	echo "</pre>";
	exit(); */
	
	foreach ($pricelist_ids as $pl_value) 
	{
		$pricelist_id = $pl_value;
		
		foreach ($location_ids as $l_value) 
		{
			$location_id = $l_value;
			
			$RS_pl = $objDB->Conn->Execute("Select * from location_pricelist where location_id=? and pricelist_id=?",array($location_id,$pricelist_id));
			if($RS_pl->RecordCount()>0)
			{		
				$array_where = array();
				$array_where['location_id'] = $location_id;
				$array_where['pricelist_id'] = $pricelist_id;
				$objDBWrt->Remove("location_pricelist", $array_where);
			}
			else
			{	
			}
		}
	}
	
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();
}


/******** 
@USE :  get all campaign list of merchant 
@PARAMETER : merchant id ,  employee id array
@RETURN :  campaign list of merchant 
@USED IN PAGES : purchase-points.php
*********/
if(isset($_REQUEST['btnGetAllCampaignOfMerchant']))
{
	 $json_array = array();
	 $records = array();
	 
	/* 
	 * Paging
	 */
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'];
	}

	 $merchant_id = $_REQUEST['mer_id'];
         $ids=$_REQUEST['ids'];
         if($ids=="")
             $ids=$_REQUEST['mer_id'];
	 $action=$_REQUEST['action'];
	 $today_date = date("Y-m-d")." 00:00:00";

	if ($_REQUEST['year'] != 0 && $_REQUEST['month'] != 0) {
                $from_date = $_REQUEST['year'] . "-" . $_REQUEST['month'] . "-01 00:00:00";
                $to_date = $_REQUEST['year'] . "-" . $_REQUEST['month'] . "-31 23:59:59";
        } else if ($_REQUEST['year'] != 0 && $_REQUEST['month'] == 0) {
                $from_date = $_REQUEST['year'] . "-01-01 00:00:00";
                $to_date = $_REQUEST['year'] . "-12-31 23:59:59";
        } else if ($_REQUEST['year'] == 0 && $_REQUEST['month'] != 0) {
                for ($y = date('Y'); $y <= date('Y') + 2; $y++) {
                        $date_str .= " (b.created_date>='" . $y . "-" . $_REQUEST['month'] . "-01 00:00:00' AND b.created_date<='" . $y . "-" . $_REQUEST['month'] . "-31 00:00:00' ) ";

                        if ($y != date('Y')) {
                                $date_str .= " || ";
                        }
                }
        } else if ($_REQUEST['year'] == 0 && $_REQUEST['month'] == 0) {
    
        }
	
	$date_str .= " (b.created_date>= '$from_date' AND b.created_date<='$to_date')";
	
	 $Where = "";
	 if($action == "active")
	 {
	
            
             $Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1 and a.offers_left>0 ";
            
             
	}elseif($_REQUEST['action'] == "expired"){
             
            $Where .= " AND b.expiration_date <  CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1))  and b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(z.timezone,1, POSITION(',' IN z.timezone)-1)) BETWEEN y.start_date and y.expiration_date and ( x.active_in_future<>1 OR x.active=1 ) ) and a.active_in_future<>1 and a.active<>1 ";
		
	}elseif($_REQUEST['action'] == "activeinfuture"){
            $Where .= "  AND (((( b.start_date  > CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) )) or   a.active_in_future =1 and a.offers_left>0 ) and  b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE x.active=1 and x.offers_left>0 ) and a.active <> 1   ";
           
        }elseif($_REQUEST['action'] == "endcampaigns"){
			 
            
            $Where .= "  AND ( a.offers_left <=0  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date ) and  b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE (x.active=1 or x.active_in_future=1) and x.offers_left>0)and (a.active_in_future<>1 and a.active=1) or (a.active_in_future=1 and a.active<>1)  and a.offers_left <=0";
            
        }
		
	
		 
		$merchant_array = array();
		$merchant_array['id'] = $_REQUEST['mer_id'];
		$merchant_info = $objDB->Show("merchant_user",$merchant_array);
		
		$total_spent =0;
		
		 if($merchant_info->fields['merchant_parent'] == 0)
		 { 

		/*echo "SELECT SQL_CALC_FOUND_ROWS distinct b.* ,sum(cr.transaction_fees) as total_transaction_fees,sum(ru.earned_reward) 'total_earned',sum(ru.referral_reward) 'total_referral' from campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id left JOIN coupon_codes cc on cc.customer_campaign_code =b.id left JOIN `coupon_redeem` cr on cr.coupon_id= cc.id left JOIN reward_user ru on ru.campaign_id=b.id where (b.created_by = $merchant_id or b.created_by in ($ids)) AND $date_str $Where   group by b.id ORDER BY b.modified_date DESC"; */

		 $RS = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS distinct b.* ,sum(cr.transaction_fees) as total_transaction_fees,sum(ru.earned_reward) 'total_earned',sum(ru.referral_reward) 'total_referral' from campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id left JOIN coupon_codes cc on cc.customer_campaign_code =b.id left JOIN `coupon_redeem` cr on cr.coupon_id= cc.id left JOIN reward_user ru on ru.campaign_id=b.id where (b.created_by = ? or b.created_by in (?)) AND $date_str $Where   group by b.id ORDER BY b.modified_date DESC ".$sLimit,array($merchant_id,$ids));

		/* $RS = $objDB->Conn->Execute("SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where (b.created_by = ? or b.created_by in ( ?))  $Where ORDER BY modified_date DESC",array($merchant_id,$ids)); */
			
			$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
		$total= $sQuery->fields['FOUND_ROWS()'];

			if($_REQUEST['action'] == "expired"){


		$sRS = $objDB->Conn->Execute("SELECT sum(b.block_point) as total_block_point ,sum(cr.transaction_fees) as total_transaction_fees,sum(ru.earned_reward) 'total_earned',sum(ru.referral_reward) 'total_referral' from campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id left JOIN coupon_codes cc on cc.customer_campaign_code =b.id left JOIN `coupon_redeem` cr on cr.coupon_id= cc.id left JOIN reward_user ru on ru.campaign_id=b.id where (b.created_by = ? or b.created_by in (?)) AND $date_str $Where ORDER BY b.modified_date DESC ",array($merchant_id,$ids));

			$total_spent = $sRS->fields['total_transaction_fees']+$sRS->fields['total_earned']+$sRS->fields['total_referral']-$sRS->fields['total_block_point'];

			}

		 }
		 else
		 {
			$merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where1=" a.location_id=".$merchant_info->fields['location_access'];
			
			 
                         $Sql = "SELECT SQL_CALC_FOUND_ROWS distinct b.* ,sum(cr.transaction_fees) as total_transaction_fees,sum(ru.earned_reward) 'total_earned',sum(ru.referral_reward) 'total_referral' from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id left JOIN coupon_codes cc on cc.customer_campaign_code =b.id left JOIN `coupon_redeem` cr on cr.coupon_id= cc.id left JOIN reward_user ru on ru.campaign_id=b.id where 
                     $Where1 $Where group by b.id ORDER BY b.modified_date DESC"; 
			$RS = $objDB->Conn->Execute($Sql);
			$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
		$total= $sQuery->fields['FOUND_ROWS()'];

			if($_REQUEST['action'] == "expired"){

		$sRS = $objDB->Conn->Execute("SELECT sum(b.block_point) as total_block_point,sum(cr.transaction_fees) as total_transaction_fees,sum(ru.earned_reward) 'total_earned',sum(ru.referral_reward) 'total_referral' from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id left JOIN coupon_codes cc on cc.customer_campaign_code =b.id left JOIN `coupon_redeem` cr on cr.coupon_id= cc.id left JOIN reward_user ru on ru.campaign_id=b.id where 
                     $Where1 $Where group by b.id ORDER BY b.modified_date DESC");

			$total_spent = $sRS->fields['total_transaction_fees']+$sRS->fields['total_earned']+$sRS->fields['total_referral']-$sRS->fields['total_block_point'];

			}

		 }
	
		$Json = array();
                $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
                $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
                $Json['iTotalDisplayRecords'] = $total;
                $Json['sEcho'] = $_REQUEST['sEcho'];
                $Json['sSearch'] = $_REQUEST['sSearch'];
                
                $Json['aaData'] = array();
		
		if($RS->RecordCount()>0)
                {
                        $k =0;
			$t =0;
			while($Row = $RS->FetchRow())
		 	{
				if(!empty($Row['id'])){
				if ($Row['total_referral'] == "")
                                    $Row['total_referral'] = 0;
                            	if ($Row['total_earned'] == "")
                                    $Row['total_earned'] = 0;
				if (empty($Row['total_transaction_fees'])) {
                                        $Row['total_transaction_fees'] = 0;
                                }
				if($Row['point_credited'] == '')
					$Row['point_credited']=0;

				if(empty($Row['block_point'])){
					$Row['block_point']=0;
				}		

				$Json['aaData'][$k][]='<span >' . $Row['title'] . '</span>';
				$Json['aaData'][$k][]=date("Y-m-d g:i:s A", strtotime($Row['expiration_date']));

				$total = $Row['total_earned'] + $Row['total_referral'] + $Row['block_point'] + $Row['total_transaction_fees'];
				
				if ($_REQUEST['action'] == "expired") {
					$Json['aaData'][$k][]= $total + $Row['point_credited'];
					
				}else{
					$Json['aaData'][$k][]= $total;
				}
				if ($_REQUEST['action'] == "active") {
					$Json['aaData'][$k][]=$Row['block_point'];
				}
				
				
				$Json['aaData'][$k][]='<span class="notification_tooltip no_notfication" title="Referral Points = '.$Row['total_referral'].', Redemption Points = '.$Row['total_earned'].', Transaction Points = '.$Row['total_transaction_fees'] .'">'.($total - $Row['block_point']).'</span>';

				if ($_REQUEST['action'] == "expired") {
					$Json['aaData'][$k][]=$Row['point_credited'];
					//$t +=$total - $Row['block_point'];				
				}
				
				$k++;
				}else{$Json['iTotalDisplayRecords'] = 0;}
			}
		}
		$Json['spent_campaign'] = $total_spent;
	echo json_encode($Json);
         
        exit;

}
/******** 
@USE : Get campaign detail
@PARAMETER : campaign id
@RETURN : json of single campaign
@USED IN PAGES : reports.php
*********/
if(isset($_REQUEST['btnGetCampaignDetail']))
{
	 $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
	 //$parent_id = $_REQUEST['parent'];
	 $id = $_REQUEST['id'];
	 
	 /*
	 if(isset($_REQUEST['parent']))
	 {
		// 369
		$Sql = "SELECT * FROM campaigns WHERE id= ".$id." and (created_by = ".$merchant_id." or created_by in ( select id from merchant_user where merchant_parent = ". $parent_id ." )) ORDER BY id DESC";
	// 369
	}
	else{
		$Sql = "SELECT * FROM campaigns WHERE id= ".$id." and created_by = ".$merchant_id." ORDER BY id DESC";
	}
	 */
	 
	 $arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
    $ids=  implode(",", $arr_ids);
    
    if($ids=="")
        $ids=$_REQUEST['mer_id'];
	
	//$Sql = "SELECT * FROM campaigns WHERE id= ".$id." and (created_by = ".$merchant_id." or created_by in ( ". $ids ." )) ORDER BY id DESC";
	/*$Sql = "SELECT * FROM campaigns WHERE id= ".$id;
	
	 $RS = $objDB->Conn->Execute($Sql);*/
		$RS = $objDB->Conn->Execute("SELECT * FROM campaigns WHERE id=?",array($id));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

/******** 
@USE : show more media browse
@PARAMETER : next_index,num_of_records,img_type
@RETURN : json data
@USED IN PAGES : add-compaign.php,edit-compaign.php,copy-compaign.php,add-location.php,edit-location.php,add-template.php,edit-template.php,customize-template.php
*********/
if(isset($_REQUEST['show_more_media_browse']))
{
	$start_index =  $_REQUEST['next_index'];
	$num_of_records = $_REQUEST['num_of_records'];
	$next_index = $start_index + $num_of_records;
	$img_type = $_REQUEST['img_type'];
	
	$merchant_id = $_SESSION['merchant_id'];
	$merchant_parent = $_SESSION['merchant_info']['merchant_parent'];

	
	$arr123=file(WEB_PATH."/merchant/process.php?btnGetLogosOfMerchant=yes&mer_id=".$merchant_id."&img_type=".$img_type."&mer_parent_id=".$merchant_parent."&start_index=".$start_index."&num_of_records=".$num_of_records);
								
	//print_r($arr);
	if(trim($arr123[0]) == "")
	{
												
		unset($arr123[0]);
		$arr123 = array_values($arr123);
													
	}
	$json123 = json_decode($arr123[0]);
											 
	$total_records123= $json123->total_records;
	
	$records_array123 = $json123->records;
	
	$total_images = $json123->total_images;
	
	//echo $json123->query_new;
	//echo $json123->query_old;
	
	$html ="";
	
	if($total_records123>0)
	{
		foreach($records_array123 as $Row)
		{
			$html.='<li class="li_image_list" id="li_img_'.$Row->id.'">
										<div>';
											
											
						$src="";
						if($img_type=="campaign")
						{
							$src = ASSETS_IMG."/m/campaign/block/".$Row->image;												
						}
						if($img_type=="template")
						{
							$src = ASSETS_IMG."/m/campaign/block/".$Row->image;
						}
						if($img_type=="store")
						{
							$src = ASSETS_IMG."/m/location/mythumb/".$Row->image;
						}
											
											
					$html.='<img src="'.$src.'" />
							<span style="display:none;" class="vertical_top" id="span_img_text_'.$Row->id.'">'.$Row->image.'</span>
							<span style="display:none;" class="vertical_top cls_right"> Use this image&nbsp;<input type="radio" class="useradioclass" id="useradioid_'.$Row->id.'" name="use_image" value="'.$Row->id.'" /></span>
						</div>
						
					</li>';
		}
	}
	if($total_records123>0)
	{
		$json_array = array();
		$json_array['status'] = "true";
		$json_array['html'] = $html;
		$json_array['total_records'] = $total_records123;
			  
		$json = json_encode($json_array);
		echo $json;
		exit();
	}									
}

/******** 
@USE : get media
@PARAMETER : start_index,num_of_records,mer_id,mer_parent_id
@RETURN : json data
@USED IN PAGES : add-compaign.php,add-location.php,add-template.php,edit-location.php,customize-template.php,import_media_library_more.php,import_media_library.php
*********/

if(isset($_REQUEST['btnGetLogosOfMerchant']))
{
	 $json_array = array();
	 $records = array();
	 
	 $start_index = $_REQUEST['start_index'];
	 $num_of_records = $_REQUEST['num_of_records'];
	 $next_index = $start_index + $num_of_records;
	 
	 $merchant_id = $_REQUEST['mer_id'];
	 $mer_parent_id= $_REQUEST['mer_parent_id'];
        //9-10-2013 Display all images syblic  
        $main_merchant_id = getmainmercahnt_id($_REQUEST['mer_id']);
        
        $arr_ids_string=getallsubmercahnt_id($main_merchant_id);
        
		$sub_merchant=  implode(",", $arr_ids_string);
		if($sub_merchant=="")
                {
		    $sub_merchant=$_REQUEST['mer_id'];
                }    
        //End 9-10-2013
	 $img_type = $_REQUEST['img_type'];
          $merchant_array = array();
	  //$merchant_array['id'] = $_SESSION['merchant_id'];
	  $merchant_array['id'] = (isset($_SESSION['merchant_id']))?$_SESSION['merchant_id']:'';
	  $merchant_info = $objDB->Show("merchant_user",$merchant_array);
          
	 	if($img_type=="campaign")
	 	{
			$img_type = 1;
		}
	 	if($img_type=="store")
	 	{
			$img_type = 2;
		}
		if($img_type=="template")
	 	{
			$img_type = 1;
		}
		if($img_type=="giftcard")
	 	{
			$img_type = 3;
		}
		
	  /*$Sql = "select * from merchant_media where media_type_id='".$img_type."' and (merchant_id in ($sub_merchant) or merchant_id=$merchant_id or merchant_id=$mer_parent_id or merchant_id in (select id from merchant_user where merchant_parent =". $merchant_id ."))  order by id desc limit $start_index,$num_of_records" ;
	  $Sql1 = "select count(*) total from merchant_media where media_type_id='".$img_type."' and (merchant_id in ($sub_merchant) or merchant_id=$merchant_id or merchant_id=$mer_parent_id or merchant_id in (select id from merchant_user where merchant_parent =". $merchant_id ."))  order by id" ;

      //echo $Sql;

      $RS1 =$objDB->Conn->Execute($Sql1);*/
	//$RS1 =$objDB->Conn->Execute("select count(*) total from merchant_media where media_type_id=? and (merchant_id in (?) or merchant_id=? or merchant_id=$mer_parent_id or merchant_id in (select id from merchant_user where merchant_parent =?))  order by id",array($img_type,$sub_merchant,$merchant_id,$merchant_id));
	// 25 02 2015 change because admin images not comming those are added in my library from media management
	$RS1 =$objDB->Conn->Execute("select count(*) total from merchant_media where media_type_id=? and (merchant_id in (?) or merchant_id=? or merchant_id=$mer_parent_id or merchant_id in (select id from merchant_user where merchant_parent =?) or id in( select merchant_media_id from media_import_image where merchant_id=?))  order by id",array($img_type,$sub_merchant,$merchant_id,$merchant_id,$merchant_id));

      $total_images = $RS1->fields['total'];
           
	 //$RS = $objDB->Conn->Execute($Sql);
	//$RS = $objDB->Conn->Execute("select * from merchant_media where media_type_id=? and (merchant_id in ($sub_merchant) or merchant_id=$merchant_id or merchant_id=$mer_parent_id or merchant_id in (select id from merchant_user where merchant_parent =?))  order by id desc limit $start_index,$num_of_records",array($img_type,$merchant_id));
	// 25 02 2015 change because admin images not comming those are added in my library from media management
	$RS = $objDB->Conn->Execute("select * from merchant_media where media_type_id=? and (merchant_id in (?) or merchant_id=? or merchant_id=$mer_parent_id or merchant_id in (select id from merchant_user where merchant_parent =?) or id in( select merchant_media_id from media_import_image where merchant_id=?))  order by id desc limit $start_index,$num_of_records",array($img_type,$sub_merchant,$merchant_id,$merchant_id,$merchant_id));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $json_array['total_images'] = $total_images;

                          
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
          $json_array['total_images'] = "";
          $json_array["records"]= "";
     
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/

if(isset($_REQUEST['get_location_name_of_campaigns']))
{
 //$Sql = "Select location_name from campaign_location cl , locations l where campaign_id = ". $_REQUEST['camp_id'] ." and l.id = cl.location_id and l.active = 1" ;
    $count="";
 /*$Sql = "Select l.* from campaign_location cl , locations l where campaign_id = ". $_REQUEST['camp_id'] ." and l.id = cl.location_id and l.active = 1" ;
 $Rs = $objDB->execute_query($Sql);*/
	$Rs = $objDB->Conn->Execute("Select l.* from campaign_location cl , locations l where campaign_id =? and l.id = cl.location_id and l.active = ?",array($_REQUEST['camp_id'],1));

 $records = array();
 while($Row = $Rs->FetchRow())
 {
  $records[$count] = get_field_value($Row);
  $count++;
 }

    $json_array["total_records"] = $Rs->RecordCount();
    $json_array["records"]= $records;
    $json = json_encode($json_array);
    echo $json;
    exit();

 
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['get_group_name_of_campaigns']))
{
	 /*$Sql = "Select group_name from merchant_groups mg , campaign_groups cg where campaign_id = ". $_REQUEST['camp_id'] ." and mg.id = cg.group_id" ;
	 $Rs = $objDB->execute_query($Sql);*/
	$Rs = $objDB->execute_query("Select group_name from merchant_groups mg , campaign_groups cg where campaign_id =? and mg.id = cg.group_id",array($_REQUEST['camp_id']));

	 $records = array();
	 $count="";
	 while($Row = $Rs->FetchRow())
	 {
	    $records[$count] = get_field_value($Row);
	    $count++;
	 }
	 $json_array["total_records"] = $Rs->RecordCount();
	 $json_array["records"]= $records;
	  $json = json_encode($json_array);
	  echo $json;
	  exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/

if(isset($_REQUEST['get_campaign_coupons'])){
	 $json_array = array();
	 $merchant_id=$_REQUEST['mer_id'];
	 /*$Sql = "SELECT C.id as campaign_id, C.title, CC.*,AC.activation_code
	  FROM campaigns C, activation_codes AC, coupon_codes CC
	  WHERE C.created_by=$merchant_id AND AC.campaign_id=C.id AND CC.customer_campaign_code=AC.campaign_id ";
	 $RS = $objDB->Conn->Execute($Sql);*/
		$RS = $objDB->Conn->Execute("SELECT C.id as campaign_id, C.title, CC.*,AC.activation_code
         FROM campaigns C, activation_codes AC, coupon_codes CC
         WHERE C.created_by=? AND AC.campaign_id=C.id AND CC.customer_campaign_code=AC.campaign_id ",array($merchant_id));

	  while($Row = $RS->FetchRow())
	 {
	       $records[$count] = get_field_value($Row);
	       $count++;
	 }
	 $json_array['status'] = "true";
	 $json_array['total_records'] = $RS->RecordCount();
	 $json_array["records"]= $records;
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}


/******** 
@USE : Get all employees of current login mechant 
@PARAMETER : current login merchant id
@RETURN : Employee array
@USED IN PAGES : manage-users.php
@EXPAINATION : Main merchant can view all employees , which are created by own and by his employees too
- Employee can view only that employee which are on his assigned location
- Employee list only include the employees of active locations
- Employee list only include the active employees
*********/
if(isset($_REQUEST['btnGetUsersOfMerchant']))
{
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}
	 
	$json_array = array();
	 $records = array();
	 $merchant_id = $_REQUEST['mer_id'];
	$all_main_mer_array = $_REQUEST['all_main_mer_array'];
	$ass_page = $_REQUEST['ass_page'];
	 $all_sub_mer_array = $_REQUEST['all_sub_mer_array'];

	 $arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
		$ids=  implode(",", $arr_ids);
		if($ids=="")
		    $ids=$_REQUEST['mer_id'];
                
	 $merchant_array = array();
        $merchant_array['id'] = $_REQUEST['mer_id'];
        $merchant_info = $objDB->Show("merchant_user",$merchant_array);
	
		$main_merchant_id = $merchant_info->fields['merchant_parent'];
        
        if($merchant_info->fields['merchant_parent'] == 0)
         { 
            /*echo "SELECT SQL_CALC_FOUND_ROWS * FROM merchant_user mu ,merchant_user_role mur WHERE mu.active=1 and mu.id = mur.merchant_user_id and mur.location_access in( select id from locations l where l.active=1) and ( merchant_parent=$merchant_id or merchant_parent in ( $ids )) ORDER BY id DESC";*/
		$RS = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS mu.id,mu.firstname,mu.lastname,mu.phone_number,mu.email,mu.merchant_parent,mu.approve,lo.state,lo.city,lo.address,lo.zip FROM merchant_user mu ,merchant_user_role mur Inner join locations lo on lo.id in(select location_access from merchant_user_role where merchant_user_id=mu.id) WHERE mu.active=1 and mu.id = mur.merchant_user_id and mur.location_access in( select id from locations l where l.active=1) and ( merchant_parent=? or merchant_parent in ( ? )) ORDER BY id DESC ".$sLimit,array($merchant_id,$ids));

         }
         else
         {
            $merchant_array = array();
            $merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
            $merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
           
/*echo "SELECT SQL_CALC_FOUND_ROWS mu.id,mu.firstname,mu.lastname,mu.phone_number,mu.email,mu.merchant_parent,lo.state,lo.city,lo.address,lo.zip FROM merchant_user mu ,merchant_user_role mur Inner join locations lo on lo.id in(select location_access from merchant_user_role where merchant_user_id=mu.id) WHERE mu.active=1 and mu.id = mur.merchant_user_id and mur.location_access in( select id from locations l where l.active=1) and mur.location_access=".$merchant_info->fields['location_access']." and mu.id<>$merchant_id ORDER BY id DESC";*/

		$RS = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS mu.id,mu.firstname,mu.lastname,mu.phone_number,mu.email,mu.merchant_parent,mu.approve,lo.state,lo.city,lo.address,lo.zip FROM merchant_user mu ,merchant_user_role mur Inner join locations lo on lo.id in(select location_access from merchant_user_role where merchant_user_id=mu.id) WHERE mu.active=? and mu.id = mur.merchant_user_id and mur.location_access in( select id from locations l where l.active=1) and mur.location_access=? and mu.id<>? ORDER BY id DESC ".$sLimit,array(1,$merchant_info->fields['location_access'],$merchant_id));
            

         }

	$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
	$total= $sQuery->fields['FOUND_ROWS()'];

	$Json = array();
        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
        $Json['iTotalDisplayRecords'] = $total;
        $Json['sEcho'] = $_REQUEST['sEcho'];
        $Json['sSearch'] = $_REQUEST['sSearch'];
        $Json['aaData'] = array();
	 
	 if($RS->RecordCount()>0)
	 {
		  
		  $k=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$Json['aaData'][$k][]=$Row['firstname'] . " " . $Row['lastname'];
			$Json['aaData'][$k][]=substr($Row['phone_number'], 4);
			$Json['aaData'][$k][]=$Row['email'];
			
			$array_where = array();
			$array_where['id'] = $Row['state'];
			$RS_state = $objDB->Show("state", $array_where);

			$array_where = array();
			$array_where['id'] = $Row['city'];
			$RS_city = $objDB->Show("city", $array_where);

			//$Json['aaData'][$k][]=$Row['address'] . ", " . $Row['city'] . ", " . $Row['state'] . ", " . $Row['zip'];
			$Json['aaData'][$k][]=$Row['address'] . ", " . $RS_city->fields['name'] . ", " . $RS_state->fields['short_form'] . ", " . $Row['zip'];

			$html="";
			
			if (in_array($Row['merchant_parent'], $all_main_mer_array)) {
			
				$html .= '<span class="disable_moreaction" >More  Actions</span>';
			
			} else if (!in_array($Row['merchant_parent'], $all_main_mer_array) && !in_array($Row['merchant_parent'], $all_sub_mer_array) && $Row['merchant_parent'] != $_SESSION['merchant_id']) {
			
				$html .='<span class="disable_moreaction" >More  Actions</span>';
			 } else {

				$html .= 'More  Actions';
			}

			if ($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-user.php", $ass_page) || in_array("delete-user.php", $ass_page)) {
			
			if (in_array($Row['merchant_parent'], $all_main_mer_array)) {

			} else {
			$html .='<div class="action_wrapper">';
			
			if ($_SESSION['merchant_info']['merchant_parent'] == 0) {
			if ($_SESSION['merchant_info']['approve'] == 2) {
			} else {
			   
			    $html .='<div id="actiondiv" class="actiondivclass"> ';
				
				if ($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("edit-user.php", $ass_page)) {
					if (in_array($Row['merchant_parent'], $all_main_mer_array)) {
							
					} else {
						
						$html .='<a class="commonclass"  link="edit-user.php?id='.$Row['id'].'" href="javascript:void(0);">Edit</a>';
						
					}
				}
						 
		
				if ($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("delete-user.php", $ass_page)) {
				        if (in_array($Row['merchant_parent'], $all_main_mer_array)) {
				                
				        } else {
						               
				               $html .=' <a class="commonclass empdelete" link="process.php?id='.$Row['id'].'&deactivate_employee=delete&main_merchant_id='.$main_merchant_id.'" href="javascript:void(0);">Delete</a>';
				                
				        }
				}
						
				if ($_SESSION['merchant_info']['merchant_parent'] == 0) {
				        if (in_array($Row['merchant_parent'], $all_main_mer_array)) {
				                
				        } else {
				               
				                $html .='<a class="commonclass"   link="process.php?employeeblock=yes&approve='.(($Row['approve'] == 1)?0:1).'&id='.$Row['id'].'" href="javascript:void(0);">'.(($Row['approve'] == 1)?"Block":"Activate").'</a>';
				                 
				        }
				}
						                
		            $html .='</div>';
		            
		    	}
			} else {
				
			    if ($merchant_info->fields['approve'] == 2) {
			            
			     } else {
			            
			            if (in_array($Row['merchant_parent'], $all_main_mer_array)) {
			                    
			            } else if (!in_array($Row['merchant_parent'], $all_main_mer_array) && !in_array($Row['merchant_parent'], $all_sub_mer_array) && $Row['merchant_parent'] != $_SESSION['merchant_id']) {
			                     } else {
			                   

			                    $html .='<div id="actiondiv" class="actiondivclass" >'; 
			                        
			                        if ($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-user.php", $ass_page)) {
			                                if (in_array($Row['merchant_parent'], $all_main_mer_array)) {
			                                        
			                                } else {
			                                        
			                                        $html .='<a class="commonclass"  link="edit-user.php?id='.$Row['id'].'" href="javascript:void(0);">Edit</a>';
			                                }
			                        } 
			                                       
	                                        if ($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("delete-user.php", $ass_page)) {
	                                                if (in_array($Row['merchant_parent'], $all_main_mer_array)) {
	                                                        
	                                                } else {
	                                                        
	                                                        $html .='<a class="commonclass" link="process.php?id='.$Row['id'].'&deactivate_employee=delete&main_merchant_id='.$main_merchant_id.'" href="javascript:void(0);">Delete</a>';
	                                                       
	                                                }
	                                        }
			                                        
	                                        if ($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-user.php", $ass_page)) {
	                                                if (in_array($Row['merchant_parent'], $all_main_mer_array)) {
	                                                        
	                                                } else {
	                                                        
	                                                        $html .='<a class="commonclass"   link="process.php?employeeblock=yes&approve='.(($Row['approve'] == 1)?0:1).'&id='.$Row['id'] .'" href="javascript:void(0);">'.(($Row['approve'] == 1)?"Block":"Activate").'</a>';
	                                                        
	                                                 }
	                                         } 
			                                                       
			                                  $html .='</div>';
			                                                    
	                                            }
	                                    }
	                            }
			                            
	                        $html .='</div>';
	                        
	                }
	        }

		$Json['aaData'][$k][]=$html;
	   	$k++;
	  }
		  
	}
	 
	 $json = json_encode($Json);
	 echo $json;
	 exit();
}

// customers
/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnEditCustomersOfMerchant']))
{
	 $json_array = array();
	 $records = array();
	 $merchant_id = $_REQUEST['mer_id'];
	 
	 /*$Sql = "SELECT distinct CU.* FROM customer_user CU, merchant_subscribs MS WHERE MS.user_id = CU.id AND MS.merchant_id = '". $merchant_id ."'  AND MS.user_id = '".$_REQUEST['id']."'";
	 
	 $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT distinct CU.* FROM customer_user CU, merchant_subscribs MS WHERE MS.user_id = CU.id AND MS.merchant_id =?  AND MS.user_id =?",array($merchant_id,$_REQUEST['id']));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}	

/******** 
@USE : get active campaign of month
@PARAMETER : from_date,to_date,mer_id
@RETURN : json data
@USED IN PAGES : filter_report_by_year.php
*********/
if(isset($_REQUEST['active_campaign_list_of_month'])){
	$from_date = urldecode($_REQUEST['from_date']);
	$to_date = urldecode($_REQUEST['to_date']);
	$merchant_id = $_REQUEST['mer_id'];
	/*$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE  ((start_date <= '$from_date' and expiration_date >= '$from_date' ) or (start_date between '$from_date' and '$to_date' and expiration_date >= '$from_date' )) AND created_by=$merchant_id";
	
	$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE  ((start_date <= '".$from_date."' and expiration_date >= '".$from_date."' ) or (start_date between '".$from_date."' and '".$to_date."' and expiration_date >= '".$from_date."' )) AND created_by=".$merchant_id;

	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns WHERE  ((start_date <=? and expiration_date >= ? ) or (start_date between '".$from_date."' and '".$to_date."' and expiration_date >= ? )) AND created_by=?",array($from_date,$from_date,$from_date,$merchant_id));

	$count=0;
	while($Row = $RS->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array['status'] = "true";
	$json_array['total_records'] = $RS->RecordCount();
	$json_array["records"]= $records;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : get reserve campaign of month
@PARAMETER : from_date,to_date,mer_id
@RETURN : json data
@USED IN PAGES : filter_report_by_year.php
*********/
if(isset($_REQUEST['reserve_campaign_list_of_month'])){
	$from_date = urldecode($_REQUEST['from_date']);
	$to_date = urldecode($_REQUEST['to_date']);
	$merchant_id = $_REQUEST['mer_id'];
        
	/*$Sql = "SELECT count(*) as total FROM campaigns c , customer_campaigns cc WHERE  c.id = cc.campaign_id and c.created_by =$merchant_id and cc.coupon_generation_date BETWEEN '$from_date' and '$to_date'";

	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT count(*) as total FROM campaigns c , customer_campaigns cc WHERE  c.id = cc.campaign_id and c.created_by =? and cc.coupon_generation_date BETWEEN ? and ?",array($merchant_id,$from_date,$to_date));

	$count=0;
	while($Row = $RS->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array['status'] = "true";
	$json_array['total_records'] = $RS->RecordCount();
	$json_array["records"]= $records;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : get referral user list of month
@PARAMETER : from_date,to_date,mer_id
@RETURN : json data
@USED IN PAGES : filter_report_by_year.php
*********/
if(isset($_REQUEST['referral_user_list_of_month'])){
	$from_date = urldecode($_REQUEST['from_date']);
	$to_date = urldecode($_REQUEST['to_date']);
	$merchant_id = $_REQUEST['mer_id'];
        
          /*$Sql = " select count(*) as total from customer_user where id in (select c.referred_customer_id from reward_user c where c.campaign_id in (SELECT id from campaigns where created_by= $merchant_id) and c.referred_customer_id <> 0 and c.reward_date>='$from_date' and c.reward_date<='$to_date'  GROUP BY  DATE_FORMAT(c.reward_date,'%Y %c %d'))";

	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute(" select count(*) as total from customer_user where id in (select c.referred_customer_id from reward_user c where c.campaign_id in (SELECT id from campaigns where created_by= ?) and c.referred_customer_id <> ? and c.reward_date>=? and c.reward_date<=?  GROUP BY  DATE_FORMAT(c.reward_date,'%Y %c %d'))",array($merchant_id,0,$from_date,$to_date));

	$count=0;
	while($Row = $RS->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array['status'] = "true";
	$json_array['total_records'] = $RS->RecordCount();
	$json_array["records"]= $records;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : get redeemed user list of month
@PARAMETER : from_date,to_date,mer_id
@RETURN : json data
@USED IN PAGES : filter_report_by_year.php
*********/
if(isset($_REQUEST['redeemed_user_list_of_month'])){
	$from_date = urldecode($_REQUEST['from_date']);
	$to_date = urldecode($_REQUEST['to_date']);
	$merchant_id = $_REQUEST['mer_id'];
        
	//$Sql = "SELECT count(*) as total FROM campaigns c , customer_campaigns cc WHERE  c.id = cc.campaign_id and c.created_by =$merchant_id and cc.coupon_generation_date BETWEEN '$from_date' and '$to_date'";
        /* $Sql = "select count(*) as total from customer_user where id in (select c.customer_id from reward_user c where c.campaign_id in (SELECT id from campaigns where created_by= $merchant_id) and c.referred_customer_id = 0 and c.reward_date>='$from_date' and c.reward_date<='$to_date'  GROUP BY  DATE_FORMAT(c.reward_date,'%Y %c %d'))";

	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("select count(*) as total from customer_user where id in (select c.customer_id from reward_user c where c.campaign_id in (SELECT id from campaigns where created_by= ?) and c.referred_customer_id = ? and c.reward_date>=? and c.reward_date<=?  GROUP BY  DATE_FORMAT(c.reward_date,'%Y %c %d'))",array($merchant_id,0,$from_date,$to_date));

	$count=0;
	while($Row = $RS->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array['status'] = "true";
	$json_array['total_records'] = $RS->RecordCount();
	$json_array["records"]= $records;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : get campaign list of month
@PARAMETER : from_date,to_date,mer_id
@RETURN : json data
@USED IN PAGES : filter_report_by_year.php
*********/
if(isset($_REQUEST['campaign_list_of_month'])){
	$from_date = urldecode($_REQUEST['from_date']);
	$to_date = urldecode($_REQUEST['to_date']);
	$merchant_id = $_REQUEST['mer_id'];
	/*$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE  (created_date>='$from_date' AND created_date<='$to_date') AND created_by=$merchant_id";

	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns WHERE  (created_date>=? AND created_date<=?) AND created_by=?",array($from_date,$to_date,$merchant_id));

	$count=0;
	while($Row = $RS->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array['status'] = "true";
	$json_array['total_records'] = $RS->RecordCount();
	$json_array["records"]= $records;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : get redeem campaign list of month
@PARAMETER : from_date,to_date,mer_id
@RETURN : json data
@USED IN PAGES : filter_report_by_year.php
*********/
if(isset($_REQUEST['redeem_campaign_list_of_month']))
{
	$from_date = urldecode($_REQUEST['from_date']);
	$to_date = urldecode($_REQUEST['to_date']);
	$merchant_id = $_REQUEST['mer_id'];
	/*$Sql = "SELECT COUNT(*) as total FROM campaigns c , reward_user r WHERE  r.reward_date>='".$from_date."' AND r.reward_date<='".$to_date."'  AND c.created_by=".$merchant_id." and c.id= r.campaign_id and r.referred_customer_id = 0";
	//echo $Sql."<hr>";
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns c , reward_user r WHERE  r.reward_date>=? AND r.reward_date<=?  AND c.created_by=? and c.id= r.campaign_id and r.referred_customer_id = ?",array($from_date,$to_date,$merchant_id,0));

	$count=0;
	while($Row = $RS->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array['status'] = "true";
	$json_array['total_records'] = $RS->RecordCount();
	$json_array["records"]= $records;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : get expired campaign list of month
@PARAMETER : from_date,to_date,mer_id
@RETURN : json data
@USED IN PAGES : filter_report_by_year.php
*********/
if(isset($_REQUEST['expired_campaign_list_of_month']))
{
	$from_date = urldecode($_REQUEST['from_date']);
	$to_date = urldecode($_REQUEST['to_date']);
	$merchant_id = $_REQUEST['mer_id'];
	/*$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE  expiration_date>='".$from_date."' AND expiration_date<='".$to_date."'  AND created_by=".$merchant_id;
	//echo $Sql."<hr>";
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns WHERE  expiration_date>=? AND expiration_date<=?  AND created_by=?",array($from_date,$to_date,$merchant_id));

	$count=0;
	while($Row = $RS->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array['status'] = "true";
	$json_array['total_records'] = $RS->RecordCount();
	$json_array["records"]= $records;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : get generated coupon monthly
@PARAMETER : from_date,to_date,mer_id
@RETURN : json data
@USED IN PAGES : filter_report_by_year.php
*********/
if(isset($_REQUEST['generated_coupon_monthly']))
{
	$from_date = urldecode($_REQUEST['from_date']);
	$to_date = urldecode($_REQUEST['to_date']);
	$merchant_id = $_REQUEST['mer_id'];
	
	/*$Sql = "SELECT count(*) as total   FROM campaigns C, activation_codes AC,coupon_codes CC  WHERE  (CC.generated_date>='$from_date' AND CC.generated_date<='$to_date') and ( C.created_by=$merchant_id or C.created_by in (select id from merchant_user where merchant_parent = $merchant_id) )  and C.created_by=$merchant_id AND AC.campaign_id=C.id AND CC.customer_campaign_code=AC.campaign_id";

	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT count(*) as total   FROM campaigns C, activation_codes AC,coupon_codes CC  WHERE  (CC.generated_date>=? AND CC.generated_date<='$to_date') and ( C.created_by=$merchant_id or C.created_by in (select id from merchant_user where merchant_parent = ?) )  and C.created_by=? AND AC.campaign_id=C.id AND CC.customer_campaign_code=AC.campaign_id",array($from_date,$merchant_id,$merchant_id));

	$count=0;
	while($Row = $RS->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array['status'] = "true";
	$json_array['total_records'] = $RS->RecordCount();
	$json_array["records"]= $records;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : get generated coupon monthly
@PARAMETER : mer_id,point_package,txt_price
@RETURN : json data
@USED IN PAGES : apply_pointfilter.php,purchase-points.php
*********/
if(isset($_REQUEST['btnPurchasePoints']))
{
	$array = array();
	if(isset($_REQUEST['mer_id']))
	{
		$array['merchant_id'] =  $_REQUEST['mer_id'];
		$merchant_id = $_REQUEST['mer_id'];
	}
	else{
		$array['merchant_id'] = $_SESSION['merchant_id'] ;
		$merchant_id = $_SESSION['merchant_id'];
	}
	$array['point_package_id'] = isset($_REQUEST['point_package']);
	$array['subscribed_date'] = date("Y-m-d H:i:s");
	$objDBWrt->Insert($array, "merchant_package_subscribe");
	
	/*$Sql = "SELECT available_point from merchant_user where id=".$merchant_id ." or id = (select merchant_parent from merchant_user where id =".$merchant_id.")";
	$RS =  $objDB->execute_query($Sql);*/
	$RS =  $objDB->execute_query("SELECT available_point from merchant_user where id=? or id = (select merchant_parent from merchant_user where id =?)",array($merchant_id,$merchant_id));

	
	$available_points = $RS->fields['available_point'];
	
        // -- 4-12-2012
        $price = $_REQUEST['txt_price'];
        
        $array_where1 = array();
        $RS_point_pkg = $objDB->Show("point_packages", $array_where1);
	$package_point = $RS_point_pkg->fields['points'];
        $package_rate = $RS_point_pkg->fields['price'];
        $i_point = (($price * $package_point)/$package_rate);
        
        // -- 4-12-2012
        
	
	
	$array_values = $where_clause = $array = array();
	$array_values['available_point'] = ($available_points + $i_point);
	$where_clause['id'] = $merchant_id;
	$objDBWrt->Update($array_values, "merchant_user", $where_clause);
	
	$_SESSION['msg'] = "Thank you for purchasing Scanflip points. You have earned $i_point points for $price $.<br />";
	$json_array=array();
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
    exit();
}
/******** 
@USE : Get conversation rate which set by scanflip admin from admin side 
@PARAMETER : current login merchant id
@RETURN : Get conversation rate
@USED IN PAGES : purchase-points.php,purchasepoints-edit.php
*********/
if(isset($_REQUEST['get_point_package']))
{
	$RS = $objDB->Show("point_packages");
	$records = array();
	$count = 0;
	while($Row = $RS->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array['status'] = "true";
	$json_array['total_records'] = $RS->RecordCount();
	$json_array["records"]= $records;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['redeem_coupon_monthly']))
{
	$merchant_id = $_REQUEST['mer_id'];
	$months = array("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12");
	$redeem_array = array();
	$final_array = array();
	$data_array = array();
	$lid = $_REQUEST['location_id'];
	foreach($months as $month){
	$from_date = date("Y")."-".$month."-01 00:00:00";
	$to_date = date("Y")."-".$month."-31 23:59:59";
		$location_str .= "'".$Row1['location_name']."',";
               
	 /*  $sql = "select * from coupon_redeem r
		where r.coupon_id in ( select id from coupon_codes where location_id=".$lid.") and
		r.redeem_date>='$from_date' and r.redeem_date<='$to_date' 	";	

	$RS = $objDB->Conn->Execute($sql);*/
	$RS = $objDB->Conn->Execute("select * from coupon_redeem r
		where r.coupon_id in ( select id from coupon_codes where location_id=?) and
		r.redeem_date>=? and r.redeem_date<=?",array($lid,$from_date,$to_date));


		
	array_push($redeem_array,$RS->RecordCount());	
	}

	$json_array=array();
	$json_array['records']=$redeem_array;
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['locationchartfileerdata']))
{
    if($_REQUEST['month'] != 0)
    {
        if($_REQUEST['month']==4 ||$_REQUEST['month']==6 ||$_REQUEST['month']==9 ||$_REQUEST['month']==11 )
        {
            $m=30;
        }
        else if($_REQUEST['month']==2)
        {
            $m=28;
        }
        else
        {
            $m =31;
        }
    }
	if($_REQUEST['year'] != 0 && $_REQUEST['month'] != 0)
	{
                 $months = array($_REQUEST['month']);
	}
	else if($_REQUEST['year'] != 0 && $_REQUEST['month'] == 0)
	{
			 
                $months = array("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12");
	}
    
    $total_customers = array();
     $redeem_array = array();
     $reserve_array = array();
     $campaigns_array = array();
     $cost_array = array();
     $revenue_array = array();
     $_array = array();
     
     $lid = $_REQUEST['location_id'];
     foreach($months as $month){
         if($month==4 ||$month==6 ||$month==9 ||$month==11 )
        {
            $m=30;
        }
        else if($_REQUEST['month']==2)
        {
            $m=28;
        }
        else
        {
            $m =31;
        }
         $total_counpon_issued_sql =0 ; $total_coupon_redeem_sql =0 ;
       $from_date = $_REQUEST['year']."-".$m."-01 00:00:00";
	$to_date = $_REQUEST['year']."-".$m."-31 23:59:59";
	$month_expr = " and DATE_FORMAT(c.expiration_date,'%m') =".$month;
        //$month_expr = " ";
	 $dt_wh = "c.expiration_date <'".$to_date."' "; 
    $arr1=file(WEB_PATH.'/merchant/process.php?getlocationinfo=yes&loc_id='.$lid);

				if(trim($arr1[0]) == "")
				{
					unset($arr1[0]);
					$arr1 = array_values($arr1);
				}
				$json1 = json_decode($arr1[0]);
				$total_records1= $json1->total_records;
				$records_array1 = $json1->records;
			
		 $arr=file(WEB_PATH.'/merchant/process.php?get_point_package=yes');
                                    if(trim($arr[0]) == "")
                                    {
                                            unset($arr[0]);
                                            $arr = array_values($arr);
                                    }
                                    $json = json_decode($arr[0]);
                                    $total_records_= $json->total_records;
                                    $records_array_ = $json->records;
                                    if($total_records_>0){
                                                    foreach($records_array_ as $Row_)
                                                    {	
		
                                            $price =$Row_->price;
                                            $point_=$Row_->points;
											$p= (1*$price)/$point_;
							}
													$B4 = $p;
						}
                                                                   
				if($total_records1 > 0){
					$cnt=0;
				  foreach($records_array1 as $Row)
				  {
                                      
				?>
                 
			 
				<?php 
					$arr_new_cust_ref = array();
				$arr_exsting_cust_reft = array();
				$arr_age = array();
				$t_v =0;
				$arr_new_cust_ref = array();
				$arr_exsting_cust_reft = array();
                                 $wh_status = "";
                                 $total_cust =0;
                                if($_REQUEST['status'] == "active")
                                {
                                    $wh_status = " and cl.active=1  and cl.active_in_future<>1";
                                }elseif ($_REQUEST['status']=="expire") {
                                    $wh_status = " and cl.active<>1 and cl.active_in_future<>1";
                                }elseif ($_REQUEST['status']=="end") {
                                }
                                 $wh_status ="";
				  $Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date ";
				
				 // $dt_wh = "c.expiration_date <'".$from_date."' ";
                                   $dt_wh = "c.expiration_date <'".$to_date."' "; 
                                     $dt_wh1 = "";
				/*$tc_sql = $sql = "SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=".$Row->id." and c.id = cl.campaign_id   and ($dt_wh) $month_expr and cl.active<>1 and cl.active_in_future<>1  ";
				
							
                                                  //      echo "<br />".$tc_sql."<br />"; 
						   $RS_l_tc= $objDB->Conn->Execute($tc_sql);*/
							$RS_l_tc= $objDB->Conn->Execute("SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=? and c.id = cl.campaign_id   and ($dt_wh) $month_expr and cl.active<>1 and cl.active_in_future<>?",array($Row->id,1));

                        $r_l_tc = $RS_l_tc->RecordCount();
						$t_c = $r_l_tc;
				
							
				// $dt_wh = "c.expiration_date <'".$from_date."' ";
                                                 $dt_wh = "c.expiration_date <'".$to_date."' "; 
                                     $dt_wh1 = "";
                                   /* $tc_sql = $sql = "SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=".$Row->id." and c.id = cl.campaign_id   and ($dt_wh) $month_expr and cl.active<>1 and cl.active_in_future<>1  ";
								
							
			
				  $RS_l= $objDB->Conn->Execute($sql);*/
				$RS_l= $objDB->Conn->Execute("SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=? and c.id = cl.campaign_id   and ($dt_wh) $month_expr and cl.active<>? and cl.active_in_future<>?  ",array($Row->id,1,1));

                        $r_l = $RS_l->RecordCount();
						$t_c = $r_l;
						 
						$total_coupon_issued =0;
						  $total_cost =0;
                                                  $total_coupon_redeemed =0;
                                                  if( $RS_l->RecordCount() !=0)
                                                  {
                                                      
                                                  
						while($loc =  $RS_l->FetchRow()){
							$dealvalue = $loc['deal_value'];

                                                 /*$total_counpon_issued_sql = "select * from coupon_codes where customer_campaign_code=".$loc['id']." and location_id=".$loc['location_id']." ";
                                                 $total_counpon_issued_rs = $objDB->Conn->Execute($total_counpon_issued_sql);*/
						$total_counpon_issued_rs = $objDB->Conn->Execute("select * from coupon_codes where customer_campaign_code=? and location_id=?",array($loc['id'],$loc['location_id']));

						 $total_coupon_issued = $total_coupon_issued + $total_counpon_issued_rs->RecordCount();
						
						 /*$total_coupon_redeem_sql = "SELECT * FROM `coupon_redeem` where coupon_id in( select id from coupon_codes where location_id=".$loc['location_id']." and customer_campaign_code=".$loc['id'].")";
						 $total_coupon_redeem_rs = $objDB->Conn->Execute($total_coupon_redeem_sql);*/
						$total_coupon_redeem_rs = $objDB->Conn->Execute("SELECT * FROM `coupon_redeem` where coupon_id in( select id from coupon_codes where location_id=? and customer_campaign_code=?)",array($loc['location_id'],$loc['id']));

						 $total_coupon_redeemed = $total_coupon_redeemed + $total_coupon_redeem_rs->RecordCount();
                                               
							/*$sql = "SELECT cc.customer_id ,cc.customer_campaign_code ,cc.location_id , cr.coupon_id , cr.redeem_value FROM `coupon_redeem` cr , coupon_codes cc where cr.coupon_id= cc.id and cc.customer_campaign_code=".$loc['id']." and cc.location_id= ".$loc['location_id'];
							
							  $a= $objDB->Conn->Execute($sql);*/
							$a= $objDB->Conn->Execute("SELECT cc.customer_id ,cc.customer_campaign_code ,cc.location_id , cr.coupon_id , cr.redeem_value FROM `coupon_redeem` cr , coupon_codes cc where cr.coupon_id= cc.id and cc.customer_campaign_code=? and cc.location_id= ?",array($loc['id'],$loc['location_id']));

							//   $sql_tot_redeem_coupon = "SELECT sum(redeem_deal_value) as T_R_V  FROM `reward_user` where campaign_id=".$loc['id']." and referred_customer_id=0   and location_id=".$loc['location_id']." GROUP BY coupon_code_id";
                                                          /*$sql_tot_redeem_coupon = "SELECT sum(redeem_value) as T_R_V  FROM `coupon_redeem` where coupon_id in( select id from coupon_codes where location_id=".$loc['location_id']." and   customer_campaign_code=".$loc['id']." )";
                        $RS_tot_redeem_coupon =  $objDB->Conn->Execute( $sql_tot_redeem_coupon);*/
			$RS_tot_redeem_coupon =  $objDB->Conn->Execute( "SELECT sum(redeem_value) as T_R_V  FROM `coupon_redeem` where coupon_id in( select id from coupon_codes where location_id=? and   customer_campaign_code=? )",array($loc['location_id'],$loc['id']));

							  while($newcust_row =  $a->FetchRow())
							  {
                                                             /* $sql2 = "SELECT cc.customer_id ,cc.customer_campaign_code ,cc.location_id , cr.coupon_id , cr.redeem_value
                                    ,(select gender from customer_user where id=".$newcust_row['customer_id'].") gender ,
                                         (select dob_year from  customer_user where id=".$newcust_row['customer_id'].") dob_year
                                    FROM `coupon_redeem` cr , coupon_codes cc where cr.coupon_id= cc.id and cc.customer_id=".$newcust_row['customer_id']." and  location_id =".$loc['location_id'];				

									
                                 $RS2_newcust =  $objDB->Conn->Execute($sql2);*/
				$RS2_newcust =  $objDB->Conn->Execute("SELECT cc.customer_id ,cc.customer_campaign_code ,cc.location_id , cr.coupon_id , cr.redeem_value
                                    ,(select gender from customer_user where id=?) gender ,
                                         (select dob_year from  customer_user where id=?) dob_year
                                    FROM `coupon_redeem` cr , coupon_codes cc where cr.coupon_id= cc.id and cc.customer_id=? and  location_id =?",array($newcust_row['customer_id'],$newcust_row['customer_id'],$newcust_row['customer_id'],$loc['location_id']));

									/*print_r($RS2_newcust);*/
							
                                   if($RS2_newcust->RecordCount()== 1)
                                    {
											
                                        if(!key_exists($newcust_row['customer_id'], $arr_new_cust_ref))
                                        {
                                           $arr_new_cust_ref[$newcust_row['customer_id']]= $RS2_newcust->fields['gender'];
										   if($RS2_newcust->fields['dob_year'] != "")
										   {
											   $age = date("Y")-$RS2_newcust->fields['dob_year'];
											   array_push($arr_age, $age);
										   }
										   
                                        }
                                      
                                    }
                                    else if($RS2_newcust->RecordCount()>1) {
										if(!key_exists($newcust_row['customer_id'], $arr_exsting_cust_reft))
                                        {
                                      	  $arr_exsting_cust_reft[$newcust_row['customer_id']]= $RS2_newcust->fields['gender'];
										  if($RS2_newcust->fields['dob_year'] != "")
										   {
											   $age = date("Y")-$RS2_newcust->fields['dob_year'];
											   array_push($arr_age, $age);
										   }
										}
                                    }
							  }
					
                        $a_c = $a->RecordCount();
						$t_v = $t_v + $RS_tot_redeem_coupon->fields['T_R_V'];
						
		  				
							
					$total_cust =  count($arr_exsting_cust_reft) + count($arr_new_cust_ref);

					/*$sql = "select sum(earned_reward) red_point , SUM(referral_reward) ref_point from reward_user r  where  r.location_id=".$Row->id." and r.campaign_id = ".$loc['id'];
						
							  $abc= $objDB->Conn->Execute($sql);*/
							$abc= $objDB->Conn->Execute("select sum(earned_reward) red_point , SUM(referral_reward) ref_point from reward_user r  where  r.location_id=? and r.campaign_id = ?",array($Row->id,$loc['id']));

							  while($rowabc =  $abc->FetchRow())
							   {
								  $total_cost = $total_cost +  ($rowabc['ref_point'] * $B4 ) + ($rowabc['red_point'] * $B4 );
                                                        
							  }
                                                }
						  } 						
                                                  else{

                                                  }
											
						  
}
                                }
                                 if( $RS_l->RecordCount() ==0)
                                                  {
                                                   array_push($redeem_array,0 );
                                                   array_push($reserve_array,0);
                                                   array_push($campaigns_array,0);
                                                   array_push($cost_array , 0);
                                                   array_push($revenue_array,0);
                                                    array_push($total_customers,0);
                                                  }
                                                  else{
                                 array_push($redeem_array,$total_coupon_redeemed );
                                                   array_push($reserve_array,$total_coupon_issued);
                                                   array_push($campaigns_array,$t_c );
                                                   array_push($cost_array , $total_cost);
                                                   array_push($revenue_array,$t_v);
                                                   array_push($total_customers,$total_cust);
                                                  }
                                }
                                $redeem_array1 = array();
                                $reserved_array1 = array();
                                $campaigns_array1 = array();
                                $cost_array1 = array();
                                $revenue_array1 = array();
                                $total_customers1 = array();
                               if(count($months) != 12) 
                               {
                                 
                                   for($k=1;$k<12;$k++)
                                   {
                                     
                                       if($k == $_REQUEST['month'])
                                       {
                                        
                                            array_push($redeem_array1,$redeem_array[0] );
                                                  array_push($reserved_array1,$reserved_array[0]);
                                                   array_push($campaigns_array1,$campaigns_array[0] );
                                                   array_push($cost_array1 , $cost_array[0]);
                                                   array_push($revenue_array1,$revenue_array[0]);
                                                   array_push($total_customers1,$total_customers[0]);
                                       }
                                       else{
                                           
                                           array_push($redeem_array1,0 );
                                                  array_push($reserved_array1,0);
                                                   array_push($campaigns_array1,0);
                                                   array_push($cost_array1 , 0);
                                                   array_push($revenue_array1,0);
                                                   array_push($total_customers1,0);
                                       }
                                   }
                               }
                           if(count($months) != 12) 
                               {   
        $json_array=array();
	$json_array['redeem_records']=$redeem_array1;
        $json_array['reserve_records']=$reserve_array1;
        $json_array['campaigns_records']=$campaigns_array1;
        $json_array['total_cost']=$cost_array1;
        $json_array['total_revenue']=$revenue_array1 ;
        $json_array['total_customer']=$total_customers1 ;
                               }
                               else{
                                   $json_array=array();
	$json_array['redeem_records']=$redeem_array;
        $json_array['reserve_records']=$reserve_array;
        $json_array['campaigns_records']=$campaigns_array;
        $json_array['total_cost']=$cost_array;
        $json_array['total_revenue']=$revenue_array ;
        $json_array['total_customer']=$total_customers ;
                               }
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();
    
}

/******** 
@USE : get location chart data
@PARAMETER : location_id,month,status
@RETURN : json data
@USED IN PAGES : locationcopy-ajax.php,reports.php
*********/
if(isset($_REQUEST['locationchartdata']))
{
    $total_customers = array();
     $redeem_array = array();
     $reserve_array = array();
     $campaigns_array = array();
     $cost_array = array();
     $revenue_array = array();
     $_array = array();
     $months = array("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12");
     $lid = $_REQUEST['location_id'];
     foreach($months as $month){
         if($month==4 ||$month==6 ||$month==9 ||$month==11 )
        {
            $m=30;
        }
        else if($_REQUEST['month']==2)
        {
            $m=28;
        }
        else
        {
            $m =31;
        }
         $total_counpon_issued_sql =0 ; $total_coupon_redeem_sql =0 ;
       $from_date = date("Y")."-".$m."-01 00:00:00";
	$to_date = date("Y")."-".$m."-31 23:59:59";
	$month_expr = " and DATE_FORMAT(c.expiration_date,'%m') =".$month;
        //$month_expr = " ";
	 $dt_wh = "c.expiration_date <'".$to_date."' "; 
    $arr1=file(WEB_PATH.'/merchant/process.php?getlocationinfo=yes&loc_id='.$lid);

				if(trim($arr1[0]) == "")
				{
					unset($arr1[0]);
					$arr1 = array_values($arr1);
				}
				$json1 = json_decode($arr1[0]);
				$total_records1= $json1->total_records;
				$records_array1 = $json1->records;
			
		 $arr=file(WEB_PATH.'/merchant/process.php?get_point_package=yes');
                                    if(trim($arr[0]) == "")
                                    {
                                            unset($arr[0]);
                                            $arr = array_values($arr);
                                    }
                                    $json = json_decode($arr[0]);
                                    $total_records_= $json->total_records;
                                    $records_array_ = $json->records;
                                    if($total_records_>0){
                                                    foreach($records_array_ as $Row_)
                                                    {	
		
                                            $price =$Row_->price;
                                            $point_=$Row_->points;
											$p= (1*$price)/$point_;
													}
													$B4 = $p;
									}
                                                                   
				if($total_records1 > 0){
					$cnt=0;
				  foreach($records_array1 as $Row)
				  {
                                      
				?>
                 
			 
				<?php 
					$arr_new_cust_ref = array();
				$arr_exsting_cust_reft = array();
				$arr_age = array();
				$t_v =0;
				$arr_new_cust_ref = array();
				$arr_exsting_cust_reft = array();
                                 $wh_status = "";
                                 $total_cust =0;
                                if($_REQUEST['status'] == "active")
                                {
                                    $wh_status = " and cl.active=1  and cl.active_in_future<>1";
                                }elseif ($_REQUEST['status']=="expire") {
                                    $wh_status = " and cl.active<>1 and cl.active_in_future<>1";
                                }elseif ($_REQUEST['status']=="end") {
                                }
                                 $wh_status ="";
				  $Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date ";
				
                                   $dt_wh = "c.expiration_date <'".$to_date."' "; 
                                     $dt_wh1 = "";
				/*$tc_sql = $sql = "SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=".$Row->id." and c.id = cl.campaign_id   and ($dt_wh) $month_expr and cl.active<>1 and cl.active_in_future<>1  ";
				
						
						   $RS_l_tc= $objDB->Conn->Execute($tc_sql);*/
				$RS_l_tc= $objDB->Conn->Execute("SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=? and c.id = cl.campaign_id   and ($dt_wh) $month_expr and cl.active<>? and cl.active_in_future<>?",array($Row->id,1,1));

                        $r_l_tc = $RS_l_tc->RecordCount();
						$t_c = $r_l_tc;
				
							
				// $dt_wh = "c.expiration_date <'".$from_date."' ";
                                                 $dt_wh = "c.expiration_date <'".$to_date."' "; 
                                     $dt_wh1 = "";
                                   /* $tc_sql = $sql = "SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=".$Row->id." and c.id = cl.campaign_id   and ($dt_wh) $month_expr and cl.active<>1 and cl.active_in_future<>1  ";
					
				  $RS_l= $objDB->Conn->Execute($sql);*/
				$RS_l= $objDB->Conn->Execute("SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=? and c.id = cl.campaign_id   and ($dt_wh) $month_expr and cl.active<>? and cl.active_in_future<>?",array($Row->id,1,1));

                        $r_l = $RS_l->RecordCount();
						$t_c = $r_l;
						 
						$total_coupon_issued =0;
						  $total_cost =0;
                                                  $total_coupon_redeemed =0;
                                                  if( $RS_l->RecordCount() !=0)
                                                  {
                                                      
                                                  
						while($loc =  $RS_l->FetchRow()){
							$dealvalue = $loc['deal_value'];

                                                 /*$total_counpon_issued_sql = "select * from coupon_codes where customer_campaign_code=".$loc['id']." and location_id=".$loc['location_id']." ";
                                                 $total_counpon_issued_rs = $objDB->Conn->Execute($total_counpon_issued_sql);*/
						$total_counpon_issued_rs = $objDB->Conn->Execute("select * from coupon_codes where customer_campaign_code=? and location_id=?",array($loc['id'],$loc['location_id']));

						 $total_coupon_issued = $total_coupon_issued + $total_counpon_issued_rs->RecordCount();
						
						 /*$total_coupon_redeem_sql = "SELECT * FROM `coupon_redeem` where coupon_id in( select id from coupon_codes where location_id=".$loc['location_id']." and customer_campaign_code=".$loc['id'].")";
						 $total_coupon_redeem_rs = $objDB->Conn->Execute($total_coupon_redeem_sql);*/
						$total_coupon_redeem_rs = $objDB->Conn->Execute("SELECT * FROM `coupon_redeem` where coupon_id in( select id from coupon_codes where location_id=? and customer_campaign_code=?)",array($loc['location_id'],$loc['id']));

						 $total_coupon_redeemed = $total_coupon_redeemed + $total_coupon_redeem_rs->RecordCount();
                                               
							/*$sql = "SELECT cc.customer_id ,cc.customer_campaign_code ,cc.location_id , cr.coupon_id , cr.redeem_value FROM `coupon_redeem` cr , coupon_codes cc where cr.coupon_id= cc.id and cc.customer_campaign_code=".$loc['id']." and cc.location_id= ".$loc['location_id'];
							
							  $a= $objDB->Conn->Execute($sql);*/
								$a= $objDB->Conn->Execute("SELECT cc.customer_id ,cc.customer_campaign_code ,cc.location_id , cr.coupon_id , cr.redeem_value FROM `coupon_redeem` cr , coupon_codes cc where cr.coupon_id= cc.id and cc.customer_campaign_code=? and cc.location_id=?",array($loc['id'],$loc['location_id']));

							//   $sql_tot_redeem_coupon = "SELECT sum(redeem_deal_value) as T_R_V  FROM `reward_user` where campaign_id=".$loc['id']." and referred_customer_id=0   and location_id=".$loc['location_id']." GROUP BY coupon_code_id";
                                                          /*$sql_tot_redeem_coupon = "SELECT sum(redeem_value) as T_R_V  FROM `coupon_redeem` where coupon_id in( select id from coupon_codes where location_id=".$loc['location_id']." and   customer_campaign_code=".$loc['id']." )";
                        $RS_tot_redeem_coupon =  $objDB->Conn->Execute( $sql_tot_redeem_coupon);*/
			$RS_tot_redeem_coupon =  $objDB->Conn->Execute("SELECT sum(redeem_value) as T_R_V  FROM `coupon_redeem` where coupon_id in( select id from coupon_codes where location_id=? and   customer_campaign_code=?)",array($loc['location_id'],$loc['id']));

							  while($newcust_row =  $a->FetchRow())
							  {
                                                              /*$sql2 = "SELECT cc.customer_id ,cc.customer_campaign_code ,cc.location_id , cr.coupon_id , cr.redeem_value
                                    ,(select gender from customer_user where id=".$newcust_row['customer_id'].") gender ,
                                         (select dob_year from  customer_user where id=".$newcust_row['customer_id'].") dob_year
                                    FROM `coupon_redeem` cr , coupon_codes cc where cr.coupon_id= cc.id and cc.customer_id=".$newcust_row['customer_id']." and  location_id =".$loc['location_id'];				

									
                                 $RS2_newcust =  $objDB->Conn->Execute($sql2);*/
				 $RS2_newcust =  $objDB->Conn->Execute("SELECT cc.customer_id ,cc.customer_campaign_code ,cc.location_id , cr.coupon_id , cr.redeem_value ,(select gender from customer_user where id=?) gender ,(select dob_year from  customer_user where id=?) dob_year
FROM `coupon_redeem` cr , coupon_codes cc where cr.coupon_id= cc.id and cc.customer_id=? and  location_id =?",array($newcust_row['customer_id'],$newcust_row['customer_id'],$newcust_row['customer_id'],$loc['location_id']));
							
                                   if($RS2_newcust->RecordCount()== 1)
                                    {
											
                                        if(!key_exists($newcust_row['customer_id'], $arr_new_cust_ref))
                                        {
                                           $arr_new_cust_ref[$newcust_row['customer_id']]= $RS2_newcust->fields['gender'];
										   if($RS2_newcust->fields['dob_year'] != "")
										   {
											   $age = date("Y")-$RS2_newcust->fields['dob_year'];
											   array_push($arr_age, $age);
										   }
										   
                                        }
                                      
                                    }
                                    else if($RS2_newcust->RecordCount()>1) {
										if(!key_exists($newcust_row['customer_id'], $arr_exsting_cust_reft))
                                        {
                                      	  $arr_exsting_cust_reft[$newcust_row['customer_id']]= $RS2_newcust->fields['gender'];
										  if($RS2_newcust->fields['dob_year'] != "")
										   {
											   $age = date("Y")-$RS2_newcust->fields['dob_year'];
											   array_push($arr_age, $age);
										   }
										}
                                    }
							  }
					
                        $a_c = $a->RecordCount();
						$t_v = $t_v + $RS_tot_redeem_coupon->fields['T_R_V'];
						
		  				
							
					$total_cust =  count($arr_exsting_cust_reft) + count($arr_new_cust_ref);

					/*$sql = "select sum(earned_reward) red_point , SUM(referral_reward) ref_point from reward_user r  where  r.location_id=".$Row->id." and r.campaign_id = ".$loc['id'];
						
							  $abc= $objDB->Conn->Execute($sql);*/
							$abc= $objDB->Conn->Execute("select sum(earned_reward) red_point , SUM(referral_reward) ref_point from reward_user r  where  r.location_id=? and r.campaign_id =?",array($Row->id,$loc['id']));

							  while($rowabc =  $abc->FetchRow())
							  {
								  $total_cost = $total_cost +  ($rowabc['ref_point'] * $B4 ) + ($rowabc['red_point'] * $B4 );
                                                        
							  }
                                                }
						  } 						
                                                  else{

                                                  }
											
						  
}
                                }
                                 if( $RS_l->RecordCount() ==0)
                                                  {
                                                   array_push($redeem_array,0 );
                                                   array_push($reserve_array,0);
                                                   array_push($campaigns_array,0);
                                                   array_push($cost_array , 0);
                                                   array_push($revenue_array,0);
                                                    array_push($total_customers,0);
                                                  }
                                                  else{
                                                   array_push($redeem_array,$total_coupon_redeemed );
                                                   array_push($reserve_array,$total_coupon_issued);
                                                   array_push($campaigns_array,$t_c );
                                                   array_push($cost_array , $total_cost);
                                                   array_push($revenue_array,$t_v);
                                                   array_push($total_customers,$total_cust);
                                                  }
                                }
                                
                              
        $json_array=array();
	$json_array['redeem_records']=$redeem_array;
        $json_array['reserve_records']=$reserve_array;
        $json_array['campaigns_records']=$campaigns_array;
        $json_array['total_cost']=$cost_array ;
        $json_array['total_revenue']=$revenue_array ;
        $json_array['total_customer']=$total_customers ;
        
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['reserve_coupon_monthly']))
{
	$merchant_id = $_REQUEST['mer_id'];
	$months = array("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12");
	$redeem_array = array();
	$final_array = array();
	$data_array = array();
	$lid = $_REQUEST['location_id'];
	foreach($months as $month){
	$from_date = date("Y")."-".$month."-01 00:00:00";
	$to_date = date("Y")."-".$month."-31 23:59:59";
		$location_str .= "'".$Row1['location_name']."',";
	   /*$sql = "select * from coupon_codes where  location_id=".$lid." and
		generated_date>='$from_date' and generated_date<='$to_date' 	";	
	
	$RS = $objDB->Conn->Execute($sql);*/
	$RS = $objDB->Conn->Execute("select * from coupon_codes where  location_id=? and
		generated_date>=? and generated_date<=?",array($lid,$from_date,$to_date));

		
	array_push($redeem_array,$RS->RecordCount());	
	}

	$json_array=array();
	$json_array['records']=$redeem_array;
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['campaigns_monthly']))
{
	$merchant_id = $_REQUEST['mer_id'];
	$months = array("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12");
	$redeem_array = array();
	$final_array = array();
	$data_array = array();
	$lid = $_REQUEST['location_id'];
	foreach($months as $month){
	$from_date = date("Y")."-".$month."-01 00:00:00";
	$to_date = date("Y")."-".$month."-31 23:59:59";
		$location_str .= "'".$Row1['location_name']."',";
		   $dt_wh = "c.expiration_date <'".$to_date."' ";
	  /* $sql = "SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl ,locations l
                            where l.id=cl.location_id and  cl.location_id=".$lid." and c.id = cl.campaign_id and cl.active<>1 and cl.active_in_future<>1  AND c.expiration_date <  CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))	and ". $dt_wh;	
	
	$RS = $objDB->Conn->Execute($sql);*/
	$RS = $objDB->Conn->Execute("SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl ,locations l where l.id=cl.location_id and  cl.location_id=? and c.id = cl.campaign_id and cl.active<>1 and cl.active_in_future<>?  AND c.expiration_date <  CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))	and ". $dt_wh,array($lid,1));

		
	array_push($redeem_array,$RS->RecordCount());	
	}

	$json_array=array();
	$json_array['records']=$redeem_array;
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['total_campaign_cost_monthly']))
{
    
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['total_revenue_monthly']))
{
    
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['total_customer_monthly']))
{
    
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['get_avarage_coupon_percentage']))
{
	$from_date = date("Y")."-01-01 00:00:00";
	$to_date = date("Y")."-10-31 23:59:59";
	$merchant_id = $_REQUEST['mer_id'];
	
	/*$Sql1 = "SELECT * FROM campaigns C, activation_codes AC,coupon_codes CC  WHERE (CC.generated_date>='$from_date' AND CC.generated_date<='$to_date') and  ( C.created_by=$merchant_id or C.created_by in (select id from merchant_user where merchant_parent = $merchant_id) )  AND AC.campaign_id=C.id AND CC.customer_campaign_code=AC.campaign_id";
	$Sql2 = "SELECT * FROM campaigns c where c.id in
			(select distinct R.campaign_id 
			from reward_user R, coupon_codes CC
			WHERE (CC.generated_date>='$from_date' AND CC.generated_date<='$to_date') AND
			CC.customer_campaign_code=R.campaign_id
			) AND (c.created_by=$merchant_id or c.created_by in (select id from merchant_user where merchant_parent =$merchant_id))";
	
	$RS = $objDB->Conn->Execute($Sql1);*/
	$RS = $objDB->Conn->Execute("SELECT * FROM campaigns C, activation_codes AC,coupon_codes CC  WHERE (CC.generated_date>=? AND CC.generated_date<=?) and  ( C.created_by=? or C.created_by in (select id from merchant_user where merchant_parent = ?) )  AND AC.campaign_id=C.id AND CC.customer_campaign_code=AC.campaign_id",array($from_date,$to_date,$merchant_id,$merchant_id));

	$json_array['total_generated'] = $RS->RecordCount();
	//$RS = $objDB->Conn->Execute($Sql2);
	$RS = $objDB->Conn->Execute("SELECT * FROM campaigns c where c.id in
			(select distinct R.campaign_id from reward_user R, coupon_codes CC
			WHERE (CC.generated_date>=? AND CC.generated_date<=?) AND
			CC.customer_campaign_code=R.campaign_id) AND (c.created_by=? or c.created_by in (select id from merchant_user where merchant_parent =?))",array($from_date,$to_date,$merchant_id,$merchant_id));

	$json_array['redeemed_total'] = $RS->RecordCount();
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['locationwise_avarage_campaigns']))
{
	$merchant_id = $_REQUEST['mer_id'];
	/*$Sql = "SELECT * FROM locations WHERE created_by=$merchant_id ORDER BY id DESC";
	$RS1 = $objDB->Conn->Execute($Sql);*/
	$RS1 = $objDB->Conn->Execute("SELECT * FROM locations WHERE created_by=? ORDER BY id DESC",array($merchant_id));

	$redeem_array = array();
	$final_array = array();
	$data_array = array();
	$count=0;
	
	$location_str ="";
	while($Row1 = $RS1->FetchRow())
	{
		$location_str .= "'".$Row1['location_name']."',";
	  /* $sql = "select c.created_by as cid ,count(*) as total, (select firstname from merchant_user where id=c.created_by) as user_name
		from campaigns c 
		where c.id in ( select cl.campaign_id from campaign_location cl where cl.location_id = ".$Row1['id'].")  and (c.created_by = $merchant_id or
		c.created_by in (select id from merchant_user where merchant_parent = $merchant_id)) 
		group by c.created_by";	
	$RS = $objDB->Conn->Execute($sql);*/
		$RS = $objDB->Conn->Execute("select c.created_by as cid ,count(*) as total, (select firstname from merchant_user where id=c.created_by) as user_name from campaigns c 
		where c.id in ( select cl.campaign_id from campaign_location cl where cl.location_id = ?)  and (c.created_by =? or
		c.created_by in (select id from merchant_user where merchant_parent = ?)) 
		group by c.created_by",array($Row1['id'],$merchant_id,$merchant_id));

		
		while($Row = $RS->FetchRow())
		{
			$main_array = array();
			$main_array['name'] = $Row['user_name'];
			
			$main_array['stack'] = "generated";
			
			$t_val = $Row['total'];
			$temp_array = array();
			if($t_val == "")
			{
				$t_val = 0;	
			}
			$str = "";
			if($count == 0)
			{
				array_push($temp_array,intval($Row['total']));
				$data_array[$Row['cid']] =$temp_array;
					
			}else if(!key_exists($Row['cid'],$data_array))
			{
				for($v=0;$v<$count;$v++)
				{
					array_push($temp_array,0);
				}
				array_push($temp_array,intval($Row['total']));
				$data_array[$Row['cid']] = $temp_array;
		        }
			else{
				//echo  $data_array[$Row['cid']];
				$temp_array = $data_array[$Row['cid']];
				$temp_array = $temp_array;
				array_push($temp_array ,intval($Row['total']));
				$data_array[$Row['cid']] =$temp_array;
			}
			$main_array['data'] = $data_array;
			$redeem_array[$Row['cid']] = $main_array ;
			
		}
		$count++;
		
	}
	$location_str = trim($location_str,",");
	foreach($data_array as $key=>$value)
	{
		$a =$data_array[$key];
		$arr = array();
		$arr  = $a;
		for($j=count($a);$j<$RS1->RecordCount();$j++){
			array_push($a,0);
		}
		$redeem_array[$key]['data'] = $a;
		array_push($final_array,$redeem_array[$key]);
	}
	$json_array=array();
	$json_array['records']=$final_array;
	$json_array['locations'] =  $location_str;
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['merchantwise_campaigns']))
{
	$merchant_id = $_REQUEST['mer_id'];
	$merchant_id_array = array();
	$merchant_display_id_array = array();
	$merchant_name_array = array();
	$merchant_tot_campaign = array();
	array_push($merchant_id_array,$_REQUEST['mer_id']);
	
	/*$sql = "select id from merchant_user where merchant_parent = $merchant_id";
	$RS = $objDB->Conn->Execute($sql);*/
	$RS = $objDB->Conn->Execute("select id from merchant_user where merchant_parent =?",array($merchant_id));

	while($Row = $RS->FetchRow())
	{
		array_push($merchant_id_array,$Row['id']);
	}
	for($i=0;$i<count($merchant_id_array);$i++){
		/*$Sql = "select count(*) as total , c.created_by cid ,
			(select firstname from merchant_user where id = c.created_by )
			as fname from campaigns c  where  c.created_by =". $merchant_id_array[$i] ." group by c.created_by";
		$RSd = $objDB->Conn->Execute($Sql);*/
		$RSd = $objDB->Conn->Execute("select count(*) as total , c.created_by cid ,
			(select firstname from merchant_user where id = c.created_by )
			as fname from campaigns c  where  c.created_by =? group by c.created_by",array($merchant_id_array[$i]));

		while($Row = $RSd->FetchRow())
		{
			array_push($merchant_name_array,$Row['fname']);
			array_push($merchant_tot_campaign,intval($Row['total']));
			array_push($merchant_display_id_array,intval($Row['cid']));
			
		}
	
	}
	$json_array=array();
	$json_array['merchant_name_array']=$merchant_name_array;
	$json_array['merchant_tot_campaign'] =  $merchant_tot_campaign;
	$json_array['merchant_display_id_array'] =  $merchant_display_id_array;
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['campaignwise_used_points']))
{
	//select 	sum(earned_reward)
	//	from reward_user r
	//	where
	//	r.reward_date>='2012-10-01 00:00:00' and r.reward_date<='2012-10-31 23:59:59' 
	//	and r.campaign_id in ( select id from campaigns where created_by = 7 or created_by in ( select id from merchant_user where merchant_parent =7))
	
	
	//select r.campaign_id  cid ,sum(earned_reward) total_reward_point , (select title from campaigns where id = r.campaign_id) as title
	//	from reward_user r
	//	where
	//	r.reward_date>='2012-10-01 00:00:00' and r.reward_date<='2012-10-31 23:59:59' 
	//	and r.campaign_id in ( select id from campaigns where created_by = 7 or created_by in ( select id from merchant_user where merchant_parent =7))
	//	group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')
    
	$merchant_id = $_REQUEST['mer_id'];
	$months = array("01", "02", "03", "04", "05", "06", "07", "08", "09", "10", "11", "12");
	$redeem_array = array();
	$final_array = array();
	$data_array = array();
	
	foreach($months as $month){
	$from_date = date("Y")."-".$month."-01 00:00:00";
	$to_date = date("Y")."-".$month."-31 23:59:59";
		$location_str .= "'".$Row1['location_name']."',";
	   /*$sql = "select r.campaign_id  cid ,sum(earned_reward) total_reward_point , sum(referral_reward) total_referral_point , (select title from campaigns where id = r.campaign_id) as title
		from reward_user r
		where
		r.reward_date>='$from_date' and r.reward_date<='$to_date' 
		and r.campaign_id in ( select id from campaigns where created_by = $merchant_id or created_by in ( select id from merchant_user where merchant_parent =$merchant_id ))
		group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')";

	$RS = $objDB->Conn->Execute($sql);*/
	$RS = $objDB->Conn->Execute("select r.campaign_id  cid ,sum(earned_reward) total_reward_point , sum(referral_reward) total_referral_point , (select title from campaigns where id = r.campaign_id) as title
		from reward_user r
		where
		r.reward_date>=? and r.reward_date<=? 
		and r.campaign_id in ( select id from campaigns where created_by =?  or created_by in ( select id from merchant_user where merchant_parent =? ))
		group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')",array($from_date,$to_date,$merchant_id,$merchant_id));

		while($Row = $RS->FetchRow())
		{
					
			$main_array = array();
			$main_array['name'] = $Row['title'];
			
			$main_array['stack'] = "redeemed";
			
			$t_val = $Row['total_reward_point'] + $Row['total_referral_point'];
			$temp_array = array();
			if($t_val == "")
			{
				$t_val = 0;	
			}
			$str = "";
			if($count == 0)
			{
				array_push($temp_array,intval($Row['total_reward_point'] + $Row['total_referral_point']));
				$data_array[$Row['cid']] =$temp_array;
					
			}else if(!key_exists($Row['cid'],$data_array))
			{
				
				for($v=0;$v<$count;$v++)
				{
					array_push($temp_array,0);
				}
				array_push($temp_array,intval($Row['total_reward_point'] + $Row['total_referral_point']));
				$data_array[$Row['cid']] = $temp_array;
		        }
			else{
				//echo  $data_array[$Row['cid']];
				$temp_array = $data_array[$Row['cid']];
				$temp_array = $temp_array;
				array_push($temp_array ,intval($Row['total_reward_point'] + $Row['total_referral_point']));
				$data_array[$Row['cid']] =$temp_array;
			}
			$main_array['data'] = $data_array;
			$redeem_array[$Row['cid']] = $main_array ;
			
		}
		$count++;
		
	}
	foreach($data_array as $key=>$value)
	{
		$a =$data_array[$key];
		$arr = array();
		$arr  = $a;
		for($j=count($a);$j<12;$j++){
			array_push($a,0);
		}
		$redeem_array[$key]['data'] = $a;
		array_push($final_array,$redeem_array[$key]);
	}
	$json_array=array();
	$json_array['records']=$final_array;
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();

}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['campaignswise_usedtotPoint']))
{
	$from_date = date("Y")."-".date("m")."-01 00:00:00";
	$to_date = date("Y")."-".date("m")."-31 23:59:59";
	$merchant_id = $_REQUEST['mer_id'];
	/*$Sql = "SELECT * FROM campaigns WHERE created_by=$merchant_id or created_by in ( select id from merchant_user where merchant_parent = $merchant_id  )ORDER BY id DESC";
	$RS1 = $objDB->Conn->Execute($Sql);*/
	$RS1 = $objDB->Conn->Execute("SELECT * FROM campaigns WHERE created_by=? or created_by in ( select id from merchant_user where merchant_parent = ?  )ORDER BY id DESC",array($merchant_id,$merchant_id));
	$redeem_array = array();
	$final_array = array();
	$data_array = array();
	$count=0;

	//echo "<pre>";
	//			
	//echo "</pre>";
	$location_str ="";
	$value_str  = "";
	while($Row1 = $RS1->FetchRow())
	{
		
	  /* $sql = "select r.campaign_id  cid ,sum(earned_reward) total_reward_point , sum(referral_reward) total_referral_point , (select title from campaigns where id = r.campaign_id) as title
		from reward_user r
		where  r.reward_date >='".$from_date."' AND r.reward_date <='".$to_date."' and
		r.campaign_id = ".$Row1['id']." group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')";	
		$RS = $objDB->Conn->Execute($sql);*/
		$RS = $objDB->Conn->Execute("select r.campaign_id  cid ,sum(earned_reward) total_reward_point , sum(referral_reward) total_referral_point , (select title from campaigns where id = r.campaign_id) as title
		from reward_user r
		where  r.reward_date >=? AND r.reward_date <=? and
		r.campaign_id =? group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')",array($from_date,$to_date,$Row1['id']));

		while($Row = $RS->FetchRow())
		{
                    $v= $Row['total_reward_point'] + $Row['total_referral_point'];
                    if($v>0)
                    {
			$location_str .= "'".$Row1['title']."',";
				$value_str .=  	$Row['total_reward_point'] + $Row['total_referral_point'] . ",";
                    }
		}

	}
	$location_str = trim($location_str,",");
	$value_str = trim($value_str,",");
	
	$json_array=array();
	$json_array['campaign_total_values']=$value_str;
	$json_array['campaigns'] =  $location_str;
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['campaignswise_usedRdeemedPoint']))
{
	$from_date = date("Y")."-".date("m")."-01 00:00:00";
	$to_date = date("Y")."-".date("m")."-31 23:59:59";
	$merchant_id = $_REQUEST['mer_id'];
	/*$Sql = "SELECT * FROM campaigns WHERE created_by=$merchant_id or created_by in ( select id from merchant_user where merchant_parent = $merchant_id  )ORDER BY id DESC";
	$RS1 = $objDB->Conn->Execute($Sql);*/
	$RS1 = $objDB->Conn->Execute("SELECT * FROM campaigns WHERE created_by=? or created_by in ( select id from merchant_user where merchant_parent = ?  )ORDER BY id DESC",array($merchant_id,$merchant_id));

	$redeem_array = array();
	$final_array = array();
	$data_array = array();
	$count=0;
	
	$location_str ="";
	$value_str  = "";
	while($Row1 = $RS1->FetchRow())
	{
		
	   /*$sql = "select r.campaign_id  cid ,sum(earned_reward) total_reward_point , sum(referral_reward) total_referral_point , (select title from campaigns where id = r.campaign_id) as title
		from reward_user r
		where  r.reward_date >='".$from_date."' AND r.reward_date <='".$to_date."' and
		r.campaign_id = ".$Row1['id']." group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')";	
		$RS = $objDB->Conn->Execute($sql);*/
		$RS = $objDB->Conn->Execute("select r.campaign_id  cid ,sum(earned_reward) total_reward_point , sum(referral_reward) total_referral_point , (select title from campaigns where id = r.campaign_id) as title
		from reward_user r
		where  r.reward_date >=? AND r.reward_date <=? and
		r.campaign_id = ? group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')",array($from_date,$to_date,$Row1['id']));

		while($Row = $RS->FetchRow())
		{
                    if($Row['total_reward_point']>0)
                    {
			$location_str .= "'".$Row1['title']."',";
				$value_str .=  	$Row['total_reward_point'] . ",";
                    }
		}

	}
	$location_str = trim($location_str,",");
	$value_str = trim($value_str,",");
	
	$json_array=array();
	$json_array['campaign_total_values']=$value_str;
	$json_array['campaigns'] =  $location_str;
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['campaignswise_usedsharedPoint']))
{
        $from_date = date("Y")."-".date("m")."-01 00:00:00";
	$to_date = date("Y")."-".date("m")."-31 23:59:59";
	$merchant_id = $_REQUEST['mer_id'];
	/*$Sql = "SELECT * FROM campaigns WHERE created_by=$merchant_id or created_by in ( select id from merchant_user where merchant_parent = $merchant_id  )ORDER BY id DESC";
	$RS1 = $objDB->Conn->Execute($Sql);*/
	$RS1 = $objDB->Conn->Execute("SELECT * FROM campaigns WHERE created_by=? or created_by in ( select id from merchant_user where merchant_parent = ?  )ORDER BY id DESC",array($merchant_id,$merchant_id));

	$redeem_array = array();
	$final_array = array();
	$data_array = array();
	$count=0;
	
	$location_str ="";
	$value_str  = "";
	while($Row1 = $RS1->FetchRow())
	{
		
	  /* $sql = "select r.campaign_id  cid ,sum(earned_reward) total_reward_point , sum(referral_reward) total_referral_point , (select title from campaigns where id = r.campaign_id) as title
		from reward_user r
		where  r.reward_date >='".$from_date."' AND r.reward_date <='".$to_date."' and
		r.campaign_id = ".$Row1['id']." group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')";	
		$RS = $objDB->Conn->Execute($sql);*/
		$RS = $objDB->Conn->Execute("select r.campaign_id  cid ,sum(earned_reward) total_reward_point , sum(referral_reward) total_referral_point , (select title from campaigns where id = r.campaign_id) as title
		from reward_user r
		where  r.reward_date >=? AND r.reward_date <=? and
		r.campaign_id =? group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')",array($from_date,$to_date,$Row1['id']));

		while($Row = $RS->FetchRow())
		{
                    if($Row['total_referral_point']>0)
                    {
			$location_str .= "'".$Row1['title']."',";
				$value_str .=  	 $Row['total_referral_point'] . ",";
                    }
		}

	}
	$location_str = trim($location_str,",");
	$value_str = trim($value_str,",");
	
	$json_array=array();
	$json_array['campaign_total_values']=$value_str;
	$json_array['campaigns'] =  $location_str;
	$json_array['status']='true';
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['list_campaignwise_used_points']))
{
	
	$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	$to_date = $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";
	
	$merchant_id = $_REQUEST['mer_id'];
	 /*$sql = "select * , (select title from campaigns where id = r.campaign_id) as title ,
		(select activation_code from activation_codes where campaign_id = r.campaign_id limit 1) as activation_code,
		(select coupon_code from coupon_codes where customer_campaign_code = r.campaign_id limit 1) as coupon_code ,
		sum(earned_reward) total_reward_point , sum(referral_reward) total_referral_point
		from reward_user r
		where
		r.reward_date>='$from_date' and r.reward_date<='$to_date' 
		and r.campaign_id in ( select id from campaigns where created_by = $merchant_id or created_by in ( select id from merchant_user where merchant_parent =$merchant_id ))
		group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')";
		//echo $sql;
	$RS = $objDB->Conn->Execute($sql);*/
	$RS = $objDB->Conn->Execute("select * , (select title from campaigns where id = r.campaign_id) as title ,
		(select activation_code from activation_codes where campaign_id = r.campaign_id limit 1) as activation_code,
		(select coupon_code from coupon_codes where customer_campaign_code = r.campaign_id limit 1) as coupon_code ,
		sum(earned_reward) total_reward_point , sum(referral_reward) total_referral_point
		from reward_user r
		where
		r.reward_date>=? and r.reward_date<=? 
		and r.campaign_id in ( select id from campaigns where created_by =? or created_by in ( select id from merchant_user where merchant_parent =? ))
		group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')",array($from_date,$to_date,$merchant_id,$merchant_id));

	$count=0;

	$j = 0;
	$cnt1 = 1;
	$t = count($RS->RecordCount());
	?>
	<table width="100%"  border="0" cellspacing="2" cellpadding="2" class="tableMerchant" style="background-color: #F5F5F5">
	  <tr>
		<th width="25%" align="left" class="tableDealTh">Campaign</th>
		<th width="28%" align="left" class="tableDealTh">Activation Code </th>
		<th width="15%" align="left" class="tableDealTh">Coupon  </th>
		<th width="10%" align="left" class="tableDealTh">Generated Date</th>
		<th width="10%" align="left" class="tableDealTh">Total</th>
		<th width="7%" align="left" class="tableDealTh">redeem point</th>
		<th width="7%" align="left" class="tableDealTh">sharing point</th>
		
		</tr>
	
	  <?php
	  if($RS->RecordCount()>0){
			
	while($Row = $RS->FetchRow()){
				if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
		

	?>
	  <tr class="tableDeal">
		<td style="width: 25%"><a href="<?=WEB_PATH?>/merchant/campaign-details.php?id=<?=$Row['campaign_id']?>"><?=$Row['title']?></a></td>
		<td style="width: 25%"><?=$Row['activation_code']?></td>
		<td style="width: 15%"><?=$Row['coupon_code']?></td>
		<td style="width: 10%"><?=date("m-d-Y",strtotime($Row['generated_date']));?></td>
		<td style="width: 10%"><?=$Row['total_reward_point'] + $Row['total_referral_point']?></td>
		<td style="width: 7%"><?=$Row['total_reward_point']?></td>
		<td style="width: 7%"><?=$Row['total_referral_point']?></td>
		</tr>
	 <?php
			$j++;
	  	}
	  }else{
	  ?>
			
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">	

	  <tr>
		<td colspan="5">No Point is used in this month</td>
		</tr>
	  
</table>
	  <?php
	  }
	  ?></table>
	<input type="hidden" id="hdn_cnt5" value="<?php echo $cnt1;?>" name="hdn_cnt4" />
	 <?php
}

if(isset($_REQUEST['list_reserved_campaign']))
{
	
	$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	$to_date = $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";
	 
	$merchant_id = $_REQUEST['mer_id'];
	
	/*$Sql = "SELECT * FROM campaigns c , customer_campaigns cc WHERE  c.id = cc.campaign_id and c.created_by =$merchant_id and cc.coupon_generation_date BETWEEN '$from_date' and '$to_date'";

	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * FROM campaigns c , customer_campaigns cc WHERE  c.id = cc.campaign_id and c.created_by =? and cc.coupon_generation_date BETWEEN ? and ?",array($merchant_id,$from_date,$to_date));

	$count=0;
	$j = 0;
	$cnt1 = 1;
	$t = count($RS->RecordCount());
	?>
	<table width="100%"  border="0" cellspacing="2" cellpadding="2" class="tableMerchant"  style="background-color: #F5F5F5">
	  
	  <tr>
		<th align="left" style="width: 25%" >Campaign Name</th>
		<th align="left" style="width: 25%">Campaign Description</th>
		<th align="left" style="width: 12%">Start Date</th>
		<th align="left" style="width: 12%">Expiration Date</th>
		<th align="left" style="width: 10%">Deal Value</th>
		<th align="left" style="width: 7%">Sharing point</th>
		<th align="left" >Redeem point</th>
		
	  </tr>
	</table>
	  <?php
	  if($RS->RecordCount()>0){
	  	while($Row = $RS->FetchRow()){
			$dtm = explode(" ",$Row['start_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['start_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			
			$dtm = explode(" ",$Row['expiration_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['expiration_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
			?>
			<tr>
				<td style="width: 25%"><a href="<?=WEB_PATH?>/merchant/campaign-details.php?id=<?=$Row['id']?>"><?=$Row['title']?></a></td>
				<td style="width: 25%"><? echo substr($Row['description'],0,50)." ..";?></td>
				<td style="width: 12%"><?=$Row['start_date']?></td>
				<td style="width: 12%"> <?=$Row['expiration_date']?></td>
				<td style="width: 10%"><?=$Row['deal_value']?></td>
				<td style="width: 7%"><?=$Row['referral_rewards']?></td>
				<td><?=$Row['redeem_rewards']?></td>
				
			</tr>
				
			<?php
			$j++;
	  	}
	  }else{
	  ?>
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
	  <tr style="width: 100%">
		<td colspan="7" style="width: 100%">No campaign reserved in this month</td>
		</tr>
	</table>
	  <?php
	  } 
	  ?>
	</table>
	<input type="hidden" id="hdn_cnt_reserved" value="<?php echo $cnt1;?>" name="hdn_cnt" />
	<?php

}
if(isset($_REQUEST['list_referral_user']))
{
	
	$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	$to_date = $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";
	 
	$merchant_id = $_REQUEST['mer_id'];
	
	
        /*$Sql = " select * from customer_user where id in (select c.referred_customer_id from reward_user c where c.campaign_id in (SELECT id from campaigns where created_by= $merchant_id) and c.referred_customer_id <> 0 and c.reward_date>='$from_date' and c.reward_date<='$to_date'  GROUP BY  DATE_FORMAT(c.reward_date,'%Y %c %d'))";
        //$Sql = "select * from customer_user where id in (select c.customer_id from reward_user c where c.campaign_id in (SELECT id from campaigns where created_by= $merchant_id) and c.reward_date>='$from_date' and c.reward_date<='$to_date'  GROUP BY  DATE_FORMAT(c.reward_date,'%Y %c %d'))";

	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("select * from customer_user where id in (select c.referred_customer_id from reward_user c where c.campaign_id in (SELECT id from campaigns where created_by= ?) and c.referred_customer_id <> ? and c.reward_date>=? and c.reward_date<=?  GROUP BY  DATE_FORMAT(c.reward_date,'%Y %c %d'))",array($merchant_id,0,$from_date,$to_date));

	$count=0;
	$j = 0;
	$cnt1 = 1;
	$t = count($RS->RecordCount());
	?>
	<table width="100%"  border="0" cellspacing="2" cellpadding="2" class="tableMerchant"  style="">
	  
	  <tr>
		<th align="left" style="width: 25%">First Name</th>
		<th align="left" style="width: 25%">Last Name</th>
		<th align="left" style="width: 25%">Email</th>
		<th align="left" style="width: 25%">Current Location</th>
		
		
	  </tr>
	</table>
	  <?php
	  if($RS->RecordCount()>0){
	  	while($Row = $RS->FetchRow()){
			if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?php
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
			?>
			<tr>
				<td style="width: 25%"><?=$Row['firstname']?></a></td>
				<td style="width: 25%"><?=$Row['lastname']?></td>
				<td style="width: 25%"><?=$Row['emailaddress']?></td>
				<td style="width: 25%"><?=$Row['current_location']?></td>
				
			</tr>
				
			<?php
			$j++;
	  	}
	  }else{
	  ?>
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
	  <tr style="width: 100%">
		<td colspan="4" style="width: 100%">No referral users in this month</td>
		</tr>
	</table>
	  <?php
	  } 
	  ?>
	</table>
	<input type="hidden" id="hdn_cnt_referral" value="<?php echo $cnt1;?>" name="hdn_cnt" />
	<?php

}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['list_redeemed_user']))
{
	
	$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	$to_date = $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";
	 
	$merchant_id = $_REQUEST['mer_id'];
	
	
        //$Sql = "select * from customer_user where id in (select c.customer_id from reward_user c where c.campaign_id in (SELECT id from campaigns where created_by=17))";
        /*$Sql = "select * from customer_user where id in (select c.customer_id from reward_user c where c.campaign_id in (SELECT id from campaigns where created_by= $merchant_id) and c.referred_customer_id = 0 and c.reward_date>='$from_date' and c.reward_date<='$to_date'  GROUP BY  DATE_FORMAT(c.reward_date,'%Y %c %d'))";

	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("select * from customer_user where id in (select c.customer_id from reward_user c where c.campaign_id in (SELECT id from campaigns where created_by= ?) and c.referred_customer_id = ? and c.reward_date>=? and c.reward_date<=?  GROUP BY  DATE_FORMAT(c.reward_date,'%Y %c %d'))",array($merchant_id,0,$from_date,$to_date));

	$count=0;
	$j = 0;
	$cnt1 = 1;
	$t = count($RS->RecordCount());
	?>
	<table width="100%"  border="0" cellspacing="2" cellpadding="2" class="tableMerchant"  style="">
	  
	  <tr>
		<th align="left" style="width: 25%">First Name</th>
		<th align="left" style="width: 25%">Last Name</th>
		<th align="left" style="width: 25%">Email</th>
		<th align="left" style="width: 25%">Current Location</th>
		
		
	  </tr>
	</table>
	  <?php
	  if($RS->RecordCount()>0){
	  	while($Row = $RS->FetchRow()){
			if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?php
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
			?>
			<tr>
				<td style="width: 25%"><?=$Row['firstname']?></a></td>
				<td style="width: 25%"><?=$Row['lastname']?></td>
				<td style="width: 25%"><?=$Row['emailaddress']?></td>
				<td style="width: 25%"><?=$Row['current_location']?></td>
				
			</tr>
				
			<?php
			$j++;
	  	}
	  }else{
	  ?>
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
	  <tr style="width: 100%">
		<td colspan="4" style="width: 100%">No redeemed users in this month</td>
		</tr>
	</table>
	  <?php
	  } 
	  ?>
	</table>
	<input type="hidden" id="hdn_cnt_redeemed" value="<?php echo $cnt1;?>" name="hdn_cnt" />
	<?php

}
/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['list_generated_campaign']))
{
	
	$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	$to_date = $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";
	 
	$merchant_id = $_REQUEST['mer_id'];
	
	/*$Sql = "SELECT *  FROM campaigns WHERE  (created_date>='$from_date' AND created_date<='$to_date') AND created_by=$merchant_id";

	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT *  FROM campaigns WHERE  (created_date>=? AND created_date<=?) AND created_by=?",array($from_date,$to_date,$merchant_id));

	$count=0;
	$j = 0;
	$cnt1 = 1;
	$t = count($RS->RecordCount());
	?>
	<table width="100%"  border="0" cellspacing="2" cellpadding="2" class="tableMerchant"  style="background-color: #F5F5F5">
	  
	  <tr>
		<th align="left" style="width: 25%" >Campaign Name</th>
		<th align="left" style="width: 25%">Campaign Description</th>
		<th align="left" style="width: 12%">Start Date</th>
		<th align="left" style="width: 12%">Expiration Date</th>
		<th align="left" style="width: 10%">Deal Value</th>
		<th align="left" style="width: 7%">Sharing point</th>
		<th align="left" >Redeem point</th>
		
	  </tr>
	</table>
	  <?php
	  if($RS->RecordCount()>0){
	  	while($Row = $RS->FetchRow()){
			$dtm = explode(" ",$Row['start_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['start_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			
			$dtm = explode(" ",$Row['expiration_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['expiration_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?php
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
			?>
			<tr>
				<td style="width: 25%"><a href="<?=WEB_PATH?>/merchant/campaign-details.php?id=<?=$Row['id']?>"><?=$Row['title']?></a></td>
				<td style="width: 25%"><? echo substr($Row['description'],0,50)." ..";?></td>
				<td style="width: 12%"><?=$Row['start_date']?></td>
				<td style="width: 12%"> <?=$Row['expiration_date']?></td>
				<td style="width: 10%"><?=$Row['deal_value']?></td>
				<td style="width: 7%"><?=$Row['referral_rewards']?></td>
				<td><?=$Row['redeem_rewards']?></td>
				
			</tr>
				
			<?php
			$j++;
	  	}
	  }else{
	  ?>
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
	  <tr style="width: 100%">
		<td colspan="7" style="width: 100%">No campaign generated in this month</td>
		</tr>
	</table>
	  <?php
	  } 
	  ?>
	</table>
	<input type="hidden" id="hdn_cnt" value="<?php echo $cnt1;?>" name="hdn_cnt" />
	<?php

}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['list_activated_campaign']))
{
	
	$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	$to_date = $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";
	
	$merchant_id = $_REQUEST['mer_id'];
	
	/*$Sql = "SELECT * FROM campaigns WHERE  ((start_date <= '".$from_date."' and expiration_date >= '".$from_date."' ) or (start_date between '".$from_date."' and '".$to_date."' and expiration_date >= '".$from_date."' )) AND created_by=".$merchant_id;
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * FROM campaigns WHERE  ((start_date <= ? and expiration_date >= ? ) or (start_date between ? and ? and expiration_date >= ? )) AND created_by=".$merchant_id,array($from_date,$from_date,$from_date,$to_date,$from_date));
	$count=0;

	$j = 0;
	$cnt1 = 1;
	$t = count($RS->RecordCount());
	?>
	<table width="100%"  border="0" cellspacing="2" cellpadding="2" class="tableMerchant" style="background-color: #F5F5F5">
	  
	  <tr>
		<th align="left" style="width: 25%" >Campaign Name</th>
		<th align="left" style="width: 25%">Campaign Description</th>
		<th align="left" style="width: 12%">Start Date</th>
		<th align="left" style="width: 12%">Expiration Date</th>
		<th align="left" style="width: 10%">Deal Value</th>
		<th align="left" style="width: 7%">Sharing point</th>
		<th align="left" >Redeem point</th>
		
	  </tr>
	</table>
	  <?php
	  if($RS->RecordCount()>0){
	  	while($Row = $RS->FetchRow()){
			$dtm = explode(" ",$Row['start_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['start_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			
			$dtm = explode(" ",$Row['expiration_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['expiration_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?php
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
			?>
			<tr>
				<td style="width: 25%"><a href="<?=WEB_PATH?>/merchant/campaign-details.php?id=<?=$Row['id']?>"><?=$Row['title']?></a></td>
				<td style="width: 25%"><? echo substr($Row['description'],0,50)." ..";?></td>
				<td style="width: 12%"><?=$Row['start_date']?></td>
				<td style="width: 12%"> <?=$Row['expiration_date']?></td>
				<td style="width: 10%"><?=$Row['deal_value']?></td>
				<td style="width: 7%"><?=$Row['referral_rewards']?></td>
				<td><?=$Row['redeem_rewards']?></td>
				
			</tr>
				
			<?php
			$j++;
	  	}
	  }else{
	  ?>
			
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
	  <tr style="width: 100%">
		<td colspan="7" style="width: 100%">No campaign active in this month</td>
		</tr>
	</table>
	  <?php
	  } 
	  ?>
	</table>
	<input type="hidden" id="hdn_cnt1" value="<?php echo $cnt1;?>" name="hdn_cnt1" />
	<?php

}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['list_expired_campaign']))
{
	
	$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	$to_date = $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";
	
	$merchant_id = $_REQUEST['mer_id'];
	
	$Sql = "SELECT * FROM campaigns WHERE  expiration_date>='".$from_date."' AND expiration_date<='".$to_date."'  AND created_by=".$merchant_id;


	$RS = $objDB->Conn->Execute($Sql);
	$count=0;

	$j = 0;
	$cnt1 = 1;
	$t = count($RS->RecordCount());
	?>
	<table width="100%"  border="0" cellspacing="2" cellpadding="2" class="tableMerchant" style="background-color: #F5F5F5">
	  
	  <tr>
		<th align="left" style="width: 25%" >Campaign Name</th>
		<th align="left" style="width: 25%">Campaign Description</th>
		<th align="left" style="width: 12%">Start Date</th>
		<th align="left" style="width: 12%">Expiration Date</th>
		<th align="left" style="width: 10%">Deal Value</th>
		<th align="left" style="width: 7%">Sharing point</th>
		<th align="left" >Redeem point</th>
		
	  </tr>
	</table>
	  <?php
	  if($RS->RecordCount()>0){
	  	while($Row = $RS->FetchRow()){
			$dtm = explode(" ",$Row['start_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['start_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			
			$dtm = explode(" ",$Row['expiration_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['expiration_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?php
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
			?>
			<tr>
				<td style="width: 25%"><a href="<?=WEB_PATH?>/merchant/campaign-details.php?id=<?=$Row['id']?>"><?=$Row['title']?></a></td>
				<td style="width: 25%"><? echo substr($Row['description'],0,50)." ..";?></td>
				<td style="width: 12%"><?=$Row['start_date']?></td>
				<td style="width: 12%"> <?=$Row['expiration_date']?></td>
				<td style="width: 10%"><?=$Row['deal_value']?></td>
				<td style="width: 7%"><?=$Row['referral_rewards']?></td>
				<td><?=$Row['redeem_rewards']?></td>
				
			</tr>
				
			<?php
			$j++;
	  	}
	  }else{
	  ?>
			
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
	  <tr style="width: 100%">
		<td colspan="7" style="width: 100%">No campaign expire in this month</td>
		</tr>
	</table>
	  <?php
	  } 
	  ?>
	</table>
	<input type="hidden" id="hdn_cnt2" value="<?php echo $cnt1;?>" name="hdn_cnt2" />
	<?php

}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['list_generated_coupons']))
{
	$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	$to_date = $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";
	
	$merchant_id = $_REQUEST['mer_id'];
	/*$Sql = "SELECT *  FROM campaigns C, activation_codes AC,coupon_codes CC  WHERE  (CC.generated_date>='$from_date' AND CC.generated_date<='$to_date') and ( C.created_by=$merchant_id or C.created_by in (select id from merchant_user where merchant_parent = $merchant_id) )  and C.created_by=$merchant_id AND AC.campaign_id=C.id AND CC.customer_campaign_code=AC.campaign_id";
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT *  FROM campaigns C, activation_codes AC,coupon_codes CC  WHERE  (CC.generated_date>=? AND CC.generated_date<=?) and ( C.created_by=? or C.created_by in (select id from merchant_user where merchant_parent = ?) )  and C.created_by=? AND AC.campaign_id=C.id AND CC.customer_campaign_code=AC.campaign_id",array($from_date,$to_date,$merchant_id,$merchant_id,$merchant_id));

	$count=0;
	?>
	<table width="100%"  border="0" cellspacing="1" cellpadding="2" style="border-style:solid; border-collaps:collaps; border-color:#ddd;" class="tableMerchant">
	  <tr>
		<th width="25%" align="left" class="tableDealTh">Campaign</th>
		<th width="26%" align="left" class="tableDealTh">Activation Code </th>
		<th width="25%" align="left" class="tableDealTh">Coupon  </th>
		<th width="24%" align="left" class="tableDealTh">Generated Date</th>
		</tr>
	  <?php
	  if($RS->RecordCount()>0){
			while($Row = $RS->FetchRow()){
				if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
		

	?>
	  <tr class="tableDeal">
		<td width="25%"><a href="<?=WEB_PATH?>/merchant/campaign-details.php?id=<?=$Row['campaign_id']?>"><?=$Row['title']?></a></td>
		<td width="26%"><?=$Row['activation_code']?></td>
		<td width="25%"><?=$Row['coupon_code']?></td>
		<td width="24%"><?=date("m-d-Y",strtotime($Row['generated_date']));?></td>
		</tr>
	  <?php
			$j++;
	  	}
	  }else{
	  ?>
			
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
	  <tr>
		<td colspan="4">No Coupon is Generated in this month</td>
		</tr>
	</table>
	  <?php
	  }
	  ?></table>
	<input type="hidden" id="hdn_cnt3" value="<?php echo $cnt1;?>" name="hdn_cnt3" />
	 <?php
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['list_redeemed_coupons']))
{
	
	$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	$to_date = $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";
	
	$merchant_id = $_REQUEST['mer_id'];
	/* $sql = "select * , (select title from campaigns where id = r.campaign_id) as title ,
		(select activation_code from activation_codes where campaign_id = r.campaign_id limit 1) as activation_code,
		(select coupon_code from coupon_codes where customer_campaign_code = r.campaign_id limit 1) as coupon_code ,
		count(*) as total 
		from reward_user r
		where
		r.reward_date>='$from_date' and r.reward_date<='$to_date' 
		and r.campaign_id in ( select id from campaigns where created_by = $merchant_id or created_by in ( select id from merchant_user where merchant_parent =$merchant_id ))
		group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')";
		$RS = $objDB->Conn->Execute($sql);*/
		$RS = $objDB->Conn->Execute("select * , (select title from campaigns where id = r.campaign_id) as title ,
		(select activation_code from activation_codes where campaign_id = r.campaign_id limit 1) as activation_code,
		(select coupon_code from coupon_codes where customer_campaign_code = r.campaign_id limit 1) as coupon_code ,
		count(*) as total 
		from reward_user r
		where
		r.reward_date>=? and r.reward_date<=? 
		and r.campaign_id in ( select id from campaigns where created_by = ? or created_by in ( select id from merchant_user where merchant_parent =? ))
		group by r.campaign_id , DATE_FORMAT(r.reward_date,'%Y %c %d')",array($from_date,$to_date,$merchant_id,$merchant_id));

	$count=0;
     
	$j = 0;
	$cnt1 = 1;
	$t = count($RS->RecordCount());
	?>
	<table width="100%"  border="0" cellspacing="2" cellpadding="2" class="tableMerchant" style="background-color: #F5F5F5">
	  <tr>
		<th width="25%" align="left" class="tableDealTh">Campaign</th>
		<th width="26%" align="left" class="tableDealTh">Activation Code </th>
		<th width="25%" align="left" class="tableDealTh">Coupon  </th>
		<th width="15%" align="left" class="tableDealTh">Generated Date</th>
		<th width="8%" align="left" class="tableDealTh">Total</th>
		</tr>
	
	  <?php
	  if($RS->RecordCount()>0){
			
	while($Row = $RS->FetchRow()){
				if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?php
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
		

	?>
	  <tr class="tableDeal">
		<td  width="25%"><a href="<?=WEB_PATH?>/merchant/campaign-details.php?id=<?=$Row['campaign_id']?>"><?=$Row['title']?></a></td>
		<td  width="26%"><?=$Row['activation_code']?></td>
		<td  width="25%"><?=$Row['coupon_code']?></td>
		<td  width="15%"> <?=date("m-d-Y",strtotime($Row['generated_date']));?></td>
		<td  width="8%"><?=$Row['total'];?></td>
		</tr>
	 <?php
			$j++;
	  	}
	  }else{
	  ?>
			
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">	

	  <tr>
		<td colspan="5">No Coupon is redeemed in this month</td>
		</tr>
	  
</table>
	  <?php
	  }
	  ?></table>
	<input type="hidden" id="hdn_cnt4" value="<?php echo $cnt1;?>" name="hdn_cnt4" />
	 <?php
}

if(isset($_REQUEST['list_locationwise_campaigns']))
{
	
	$from_date = $_REQUEST['year']."-01-01 00:00:00";
	$to_date = $_REQUEST['year']."-12-31 23:59:59";
	$location_id = $_REQUEST['l_id'];
	$merchant_id = $_REQUEST['mer_id'];
	
	/* $sql = "select *, (select firstname from merchant_user where id=c.created_by) as user_name
		from campaigns c 
		where  c.created_date>='".$from_date."' AND c.created_date<='".$to_date."' and
		c.id in (select cl.campaign_id from campaign_location cl where cl.location_id = ".$location_id.") and (c.created_by = $merchant_id or
		c.created_by in (select id from merchant_user where merchant_parent = $merchant_id))";
		
	$RS = $objDB->Conn->Execute($sql);*/
	$RS = $objDB->Conn->Execute("select *, (select firstname from merchant_user where id=c.created_by) as user_name
		from campaigns c 
		where  c.created_date>=? AND c.created_date<=? and
		c.id in (select cl.campaign_id from campaign_location cl where cl.location_id = ?) and (c.created_by = ? or
		c.created_by in (select id from merchant_user where merchant_parent = ?))",array($from_date,$to_date,$location_id,$merchant_id,$merchant_id));

	
	$count=0;
	$j = 0;
	$cnt1 = 1;
	$t = count($RS->RecordCount());
	?>
	<table width="100%"  border="0" cellspacing="2" cellpadding="2" class="tableMerchant">
	  
	  <tr>
	
		
		<th align="left" style="width: 15%" >Campaign Name</th>
		<th align="left" style="width: 10%">created_by</th>
		<th align="left" style="width: 25%">Campaign Description</th>
		<th align="left" style="width: 12%">Start Date</th>
		<th align="left" style="width: 12%">Expiration Date</th>
		<th align="left" style="width: 10%">Deal Value</th>
		<th align="left" style="width: 7%">Sharing point</th>
		<th align="left" >Redeem point</th>
		
	  </tr>
	  <?php
	  if($RS->RecordCount()>0){
	  	while($Row = $RS->FetchRow()){
				if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?php
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
		
		$dtm = explode(" ",$Row['start_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['start_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			
			$dtm = explode(" ",$Row['expiration_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['expiration_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
	  ?>
	
		
		<td style="width: 15%"><a href="<?=WEB_PATH?>/merchant/campaign-details.php?id=<?=$Row['campaign_id']?>"><?=$Row['title']?></a></td>
		<td style="width: 10%"><?=$Row['user_name']?></td>
		<td style="width: 25%"><? echo substr($Row['description'],0,50)." .."; ?></td>
		<td style="width: 12%"><?=$Row['start_date']?></td>
		<td style="width: 12%"> <?=$Row['expiration_date']?></td>
		<td style="width: 10%"><?=$Row['deal_value']?></td>
		<td style="width: 7%"><?=$Row['referral_rewards']?></td>
		<td><?=$Row['redeem_rewards']?></td>
		
	  </tr>
	   <?php
			$j++;
	  	}
	  }else{
	  ?>
			
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">	
	  <tr>
		<td colspan="7">No Campaign Found at this location</td>
		</tr>
	
</table>
	  <?php
	  }
	  ?></table>
	<input type="hidden" id="hdn_cnt6" value="<?php echo $cnt1;?>" name="hdn_cnt5" />
	 <?php
}
if(isset($_REQUEST['list_merchantwise_campaigns']))
{
	
	$merchant_search_id = $_REQUEST['m_id'];
	/*$Sql = "select * 
	from campaigns c  where  c.created_by =". $merchant_search_id ;
	$RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("select * from campaigns c  where  c.created_by =?",array($merchant_search_id));
	
	$count=0;

	$j = 0;
	$cnt1 = 1;
	$t = count($RS->RecordCount());
	?>
	<table width="100%"  border="0" cellspacing="2" cellpadding="2" class="tableMerchant" style="background-color: #F5F5F5">
	  
	  <tr>
		<th align="left" style="width: 25%" >Campaign Name</th>
		<th align="left" style="width: 25%">Campaign Description</th>
		<th align="left" style="width: 12%">Start Date</th>
		<th align="left" style="width: 12%">Expiration Date</th>
		<th align="left" style="width: 10%">Deal Value</th>
		<th align="left" style="width: 7%">Sharing point</th>
		<th align="left" >Redeem point</th>
		
	  </tr>
	</table>
	  <?php
	  if($RS->RecordCount()>0){
	  	while($Row = $RS->FetchRow()){
			$dtm = explode(" ",$Row['start_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['start_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			
			$dtm = explode(" ",$Row['expiration_date']);
			$dtm = explode("-",$dtm[0]);
			$Row['expiration_date'] = $dtm[1]."-".$dtm[2]."-".$dtm[0];
			if($j == 0 )
                        {
				?>
				<table id="p<?php echo $cnt1;?>" class="pagedemo _current tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
				<?php
				$cnt1++;
			}
			else if($j % 4 == 0)
                        {
				?>
				</table>
			 <table id="p<?php echo $cnt1;?>" class="pagedemo tableMerchant" style="display: none;padding:0px 10px 0px 10px;background-color: #F5F5F5" width="100%"  border="0" cellspacing="2" cellpadding="2" >
				<?php
				$cnt1++;
			}
			?>
			<tr>
				<td style="width: 25%"><a href="<?=WEB_PATH?>/merchant/campaign-details.php?id=<?=$Row['campaign_id']?>"><?=$Row['title']?></a></td>
				<td style="width: 25%"><? echo substr($Row['description'],0,50)." .."; ?></td>
				<td style="width: 12%"><?=$Row['start_date']?></td>
				<td style="width: 12%"> <?=$Row['expiration_date']?></td>
				<td style="width: 10%"><?=$Row['deal_value']?></td>
				<td style="width: 7%"><?=$Row['referral_rewards']?></td>
				<td><?=$Row['redeem_rewards']?></td>
				
			</tr>
				
			<?php
			$j++;
	  	}
	  }else{
	  ?>
			
	<table  class="tableMerchant" width="100%"  border="0" cellspacing="2" cellpadding="2" style="padding:0px 10px 0px 10px;background-color: #F5F5F5">
	  <tr style="width: 100%">
		<td colspan="7" style="width: 100%">No campaign generated in this month</td>
		</tr>
	</table>
	  <?php
	  } 
	  ?>
	</table>
	<input type="hidden" id="hdn_cnt6" value="<?php echo $cnt1;?>" name="hdn_cnt6" />
	<?php

}

// bsb

/* For i-phone */
if(isset($_REQUEST['btnGetActiveDealsOfMerchant'])){
	 $json_array = array();
	 $records = array();
	 $today_date = date("Y-m-d")." 00:00:00";
	 $Where = " AND expiration_date >= '".$today_date."' ";
	 $merchant_id = $_REQUEST['mer_id'];
	 /*$Sql = "SELECT * FROM campaigns WHERE created_by = '$merchant_id' $Where ORDER BY id DESC";
	 
	 $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * FROM campaigns WHERE created_by = ? AND expiration_date >= ? ORDER BY id DESC",array($merchant_id,$today_date));

	 if($RS->RecordCount()>0){
	  $json_array['status'] = "true";
	  $json_array['total_records'] = $RS->RecordCount();
	  $count=0;
	  while($Row = $RS->FetchRow()){
	   $records[$count] = get_field_value($Row);
	   $count++;
	  }

	  $json_array["records"]= $records;
	 }else{
	  $json_array['status'] = "false";
	  $json_array['total_records'] = 0;
	  $json = json_encode($json_array);
	  echo $json;
	  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

/******** 
@USE : check if any active location is there or not if not then dont allow to add campaign 
@PARAMETER : current login merchant id
@RETURN : location array of current login merchant id
@USED IN PAGES : compaigns.php
*********/
if(isset($_REQUEST['btnGetCustomersOfMerchant']))
{
	 $json_array = array();
	 $records = array();
	 $merchant_id = $_REQUEST['mer_id'];
	 /*$Sql = "SELECT DISTINCT CU.* ,MS.merchant_id
		FROM customer_user CU, merchant_subscribs MS
		WHERE MS.user_id = CU.id AND MS.merchant_id = $merchant_id order by CU.id desc";
	 
//         $Sql = "SELECT DISTINCT CU.* ,MS.merchant_id
//		FROM customer_user CU, merchant_subscribs MS , locations l , merchant_groups mg 
//		WHERE MS.user_id = CU.id AND MS.merchant_id = $merchant_id  and mg.location_id = l.id and l.active=1 and mg.id=MS.group_id  order by CU.id desc";
	 $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT DISTINCT CU.* ,MS.merchant_id
		FROM customer_user CU, merchant_subscribs MS
		WHERE MS.user_id = CU.id AND MS.merchant_id = ? order by CU.id desc",array($merchant_id));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}
if(isset($_REQUEST['btnviewconatctsbygroup']))
{
	 $json_array = array();
	 $records = array();
	 $merchant_id = $_REQUEST['mer_id'];
	 /*$Sql = "SELECT DISTINCT CU.* ,MS.merchant_id
		FROM customer_user CU, merchant_subscribs MS
		WHERE MS.user_id = CU.id AND MS.merchant_id = $merchant_id AND MS.group_id=".$_REQUEST['group_id']." order by CU.id desc";
	 
	 $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT DISTINCT CU.* ,MS.merchant_id
		FROM customer_user CU, merchant_subscribs MS
		WHERE MS.user_id = CU.id AND MS.merchant_id = ? AND MS.group_id=? order by CU.id desc",array($merchant_id,$_REQUEST['group_id']));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

if(isset($_REQUEST['btnGetProfileOfMerchant']))
{
	 $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];

	$RS = $objDB->Conn->Execute("SELECT * FROM merchant_user WHERE id=?",array($merchant_id));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] = get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

if(isset($_REQUEST['btnUpdateProfileOfMerchant'])){
	
	$array = $json_array = $where_clause = array();
	$merchant_id = $_REQUEST['mer_id'];
	if(isset($_REQUEST['firstname']))
		$array['firstname'] = $_REQUEST['firstname'];
	if(isset($_REQUEST['lastname']))
		$array['lastname'] = $_REQUEST['lastname'];
	if(isset($_REQUEST['address']))
		$array['address'] = $_REQUEST['address'];
	if(isset($_REQUEST['city']))
		$array['city'] = $_REQUEST['city'];
	if(isset($_REQUEST['state']))
		$array['state'] = $_REQUEST['state'];
	if(isset($_REQUEST['zipcode']))
		$array['zipcode'] = $_REQUEST['zipcode'];
	if(isset($_REQUEST['country']))
		$array['country'] = $_REQUEST['country'];
	if(isset($_REQUEST['phone_number']))
		$array['phone_number'] = $_REQUEST['phone_number'];
	
	$where_clause['id'] = $merchant_id;
		

	if($where_clause['id'] == ""){
		$json_array['status'] = "false";
		$json_array['message'] = "Invalid Merchant ID";
	}else{
		$objDBWrt->Update($array, "merchant_user", $where_clause);
		$json_array['status'] = "true";
		$json_array['message'] = "Profile has been updated successfully";
	}
	
	$json = json_encode($json_array);
	echo $json;
	exit();

}
if(isset($_REQUEST['btnUpdateProfile'])){
	
	$array = $json_array = $where_clause = array();
	$merchant_id = $_SESSION['merchant_id'];
	if(isset($_REQUEST['firstname']))
		$array['firstname'] = ucwords(strtolower($_REQUEST['firstname']));
	if(isset($_REQUEST['lastname']))
		$array['lastname'] = ucwords(strtolower($_REQUEST['lastname']));
	/*if(isset($_REQUEST['address']))
		$array['address'] = ucwords(strtolower($_REQUEST['address']));
        if(isset($_REQUEST['city']))
		$array['city'] = ucwords(strtolower($_REQUEST['city']));*/
	if(isset($_REQUEST['state']))
		$array['state'] = $_REQUEST['state'];
	if(isset($_REQUEST['zipcode']))
		$array['zipcode'] = strtoupper($_REQUEST['zipcode']);
	if(isset($_REQUEST['country']))
		$array['country'] = $_REQUEST['country'];
		
	//if(isset($_REQUEST['phone_number']))
	//	$array['phone_number'] = $_REQUEST['phone_number'];
	$mobile_no=$_REQUEST['mobile_country_code']."-".$_REQUEST['mobileno_area_code']."-".$_REQUEST['mobileno2']."-".$_REQUEST['mobileno'];
	$array['phone_number']=$mobile_no;
		
   /*     if(isset($_REQUEST['business']))
		$array['business'] = ucwords(strtolower($_REQUEST['business']));
        if(isset($_REQUEST['aboutus']))
	        $array['aboutus'] = $_REQUEST['aboutus'];
        if(isset($_REQUEST['aboutus_short']))
	        $array['aboutus_short'] = $_REQUEST['aboutus_short'];
			
			
		 if(isset($_REQUEST['business_tags']))
	        $array['business_tags'] = $_REQUEST['business_tags'];	
	*/		
			
	if($_REQUEST['hdn_image_path'] == "")
	{
		$array['merchant_icon'] = "";
	}
	else
	{		
		$array['merchant_icon'] = trim($_REQUEST['hdn_image_path']);	
	}
	$where_clause['id'] = $merchant_id;
		
	if($where_clause['id'] == "")
        {
		$json_array['status'] = "false";
		$json_array['message'] = "Invalid Merchant ID";
	}
        else
        {
		$objDBWrt->Update($array, "merchant_user", $where_clause);

		 
		$loc_arr = $loc_arr_where = array();
		$loc_arr['location_name'] = ucwords(strtolower($_REQUEST['business']));
		$loc_arr_where['created_by'] = $merchant_id;
		$objDBWrt->Update($loc_arr, "locations", $loc_arr_where);
		//change_permalink($merchant_id);
		$arr=file(WEB_PATH.'/process.php?getlocationbusinessname=yes&l_id='.$Row_location['id']);
                                                if(trim($arr[0]) == "")
                                                     {
                                                             unset($arr[0]);
                                                             $arr = array_values($arr);
                                                     }
                                                     $json = json_decode($arr[0]);
                                                $busines_name  = $json->bus_name;
                                               $b = $busines_name;  
		$arr = file(WEB_PATH . '/merchant/process.php?chage_permalink=yes&l_id=' . $merchant_id."&business_name=".$b);
                      /* if (trim($arr[0]) == "") {
                           unset($arr[0]);
                           $arr = array_values($arr);
                       }
                       $json = json_decode($arr[0]);
                       $busines_name = $json->bus_name;*/
		$json_array['status'] = "true";
                $_SESSION['msg'] = $merchant_msg['profile']['Msg_profile_updated'];
		$json_array['message'] = $merchant_msg['profile']['Msg_profile_updated'];
	}
	
	$json = json_encode($json_array);
	echo $json;
	exit();

}
if(isset($_REQUEST['btnUpdateLocationInfo'])){
	
	$array = $json_array = $where_clause = array();
	$merchant_id = $_SESSION['merchant_id'];
	
	if(isset($_REQUEST['redeem_location']))
		$array['redeem_location'] = $_REQUEST['redeem_location'];
	
	$where_clause['id'] = $merchant_id;
		
	if($where_clause['id'] == "")
    {
		$json_array['status'] = "false";
		$json_array['message'] = "Invalid Merchant ID";
	}
	else
	{
		$objDBWrt->Update($array, "merchant_user", $where_clause);
		$json_array['status'] = "true";
		//$_SESSION['msg'] = $merchant_msg['profile']['Msg_profile_updated'];
		$_SESSION['merchant_info']['redeem_location'] = $_REQUEST['redeem_location'];
		$json_array['message'] = $merchant_msg['profile']['Msg_profile_updated'];
	}
	
	$json = json_encode($json_array);
	echo $json;
	exit();

}
if(isset($_REQUEST['btnUpdatePersonalInfo'])){
	
	$array = $json_array = $where_clause = array();
	$merchant_id = $_SESSION['merchant_id'];
	if(isset($_REQUEST['firstname']))
		$array['firstname'] = ucwords(strtolower($_REQUEST['firstname']));
	if(isset($_REQUEST['lastname']))
		$array['lastname'] = ucwords(strtolower($_REQUEST['lastname']));
		
	$mobile_no=$_REQUEST['mobile_country_code']."-".$_REQUEST['mobileno_area_code']."-".$_REQUEST['mobileno2']."-".$_REQUEST['mobileno'];
	$array['phone_number']=$mobile_no;
	
	$where_clause['id'] = $merchant_id;
		
	if($where_clause['id'] == "")
    {
		$json_array['status'] = "false";
		$json_array['message'] = "Invalid Merchant ID";
	}
	else
	{
		$objDBWrt->Update($array, "merchant_user", $where_clause);
		$json_array['status'] = "true";
		//$_SESSION['msg'] = $merchant_msg['profile']['Msg_profile_updated'];
		$json_array['message'] = $merchant_msg['profile']['Msg_profile_updated'];
	}
	
	$json = json_encode($json_array);
	echo $json;
	exit();

}
if(isset($_REQUEST['btnUpdateAddressInfo'])){
	
	$array = $json_array = $where_clause = array();
	$merchant_id = $_SESSION['merchant_id'];
	
	if(isset($_REQUEST['address']))
		$array['address'] = ucwords(strtolower($_REQUEST['address']));
        if(isset($_REQUEST['city']))
		$array['city'] = ucwords(strtolower($_REQUEST['city']));
	if(isset($_REQUEST['state']))
		$array['state'] = $_REQUEST['state'];
	if(isset($_REQUEST['zipcode']))
		$array['zipcode'] = strtoupper($_REQUEST['zipcode']);
	//if(isset($_REQUEST['country']))
	//	$array['country'] = $_REQUEST['country'];
		
	//if(isset($_REQUEST['phone_number']))
	//	$array['phone_number'] = $_REQUEST['phone_number'];
	
	//$mobile_no=$_REQUEST['mobile_country_code']."-".$_REQUEST['mobileno_area_code']."-".$_REQUEST['mobileno2']."-".$_REQUEST['mobileno'];
	//$array['phone_number']=$mobile_no;
		
       
	$where_clause['id'] = $merchant_id;
		
	if($where_clause['id'] == "")
    {
		$json_array['status'] = "false";
		$json_array['message'] = "Invalid Merchant ID";
	}
	else
	{
		$objDBWrt->Update($array, "merchant_user", $where_clause);
		
		$cntry = array();	
		$cntry['id'] = $_REQUEST['country'];
		$RS_cntry = $objDB->Show("country", $cntry);
		
		$currency = $objDB->Conn->Execute("select currency_code from currencies where id_countries=?",array($RS_cntry->fields['currency_id']));
		$_SESSION['merchant_info']['currency_code']=$currency->fields['currency_code'];
                $_SESSION['merchant_info']['currrency_symbol']=$currency->fields['currrency_symbol'];

		$json_array['status'] = "true";
		//$_SESSION['msg'] = $merchant_msg['profile']['Msg_profile_updated'];
		$json_array['message'] = $merchant_msg['profile']['Msg_profile_updated'];
	}
	
	$json = json_encode($json_array);
	echo $json;
	exit();

}
if(isset($_REQUEST['btnUpdateAboutInfo'])){
	
	$array = $json_array = $where_clause = array();
	$merchant_id = $_SESSION['merchant_id'];
	
		
	if(isset($_REQUEST['business']))
	$array['business'] = ucwords(strtolower($_REQUEST['business']));
	if(isset($_REQUEST['aboutus']))
		$array['aboutus'] = $_REQUEST['aboutus'];
	if(isset($_REQUEST['aboutus_short']))
		$array['aboutus_short'] = $_REQUEST['aboutus_short'];
		
		
	 if(isset($_REQUEST['business_tags']))
		$array['business_tags'] = $_REQUEST['business_tags'];	

	if($_REQUEST['hdn_image_path'] == "")
	{
		$array['merchant_icon'] = "";
	}
	else
	{		
		$array['merchant_icon'] = trim($_REQUEST['hdn_image_path']);	
	}
	
	$where_clause['id'] = $merchant_id;
		
	if($where_clause['id'] == "")
    {
		$json_array['status'] = "false";
		$json_array['message'] = "Invalid Merchant ID";
	}
    else
    {
		$objDBWrt->Update($array, "merchant_user", $where_clause);

		$loc_arr = $loc_arr_where = array();
		$loc_arr['location_name'] = ucwords(strtolower($_REQUEST['business']));
		$loc_arr_where['created_by'] = $merchant_id;
		$objDBWrt->Update($loc_arr, "locations", $loc_arr_where);
		//change_permalink($merchant_id);
		
		$arr = file(WEB_PATH . '/merchant/process.php?chage_permalink=yes&l_id=' . $merchant_id."&business_name=".$_REQUEST['business']);
                     
		$json_array['status'] = "true";
        //$_SESSION['msg'] = $merchant_msg['profile']['Msg_profile_updated'];
		$json_array['message'] = $merchant_msg['profile']['Msg_profile_updated'];
	}
	
	$json = json_encode($json_array);
	echo $json;
	exit();

}

if(isset($_REQUEST['btnUpdatePassword']))
{
	$array = $json_array =array();
	$merchant_id = $_SESSION['merchant_id'];
	$array['id'] = $_SESSION['merchant_id'];
	if($merchant_id == ""){
		$json_array['status'] = "false";
		$json_array['message'] = "Invalid Merchant ID";
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	else
	{

			if($_REQUEST['old_password'] == ""){
				$json_array['message'] = $merchant_msg["changepassword"]["Msg_please_enter_old_password"];
				$json_array['status'] = "false";
				$_SESSION['msg'] = $merchant_msg["changepassword"]["Msg_please_enter_old_password"];
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			if($_REQUEST['new_password'] == ""){
				$json_array['message'] = $merchant_msg["changepassword"]["Msg_please_enter_new_password"];
				$json_array['status'] = "false";
				$_SESSION['msg'] = $merchant_msg["changepassword"]["Msg_please_enter_new_password"];
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			if($_REQUEST['con_new_password'] == ""){
				$json_array['message'] = $merchant_msg["changepassword"]["Msg_please_enter_confirm_new_password"];
				$json_array['status'] = "false";
				$_SESSION['msg'] = $merchant_msg["changepassword"]["Msg_please_enter_confirm_new_password"];
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			if($_REQUEST['new_password'] != $_REQUEST['con_new_password']){
				$json_array['message'] = $merchant_msg["changepassword"]["Msg_new_password_not_match"];
				$json_array['status'] = "false";
				$_SESSION['msg'] = $merchant_msg["changepassword"]["Msg_new_password_not_match"];
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			
			
			//$array['password'] = md5($_REQUEST['old_password']);
			$RS = $objDB->Show("merchant_user",$array);
			//print_r($RS);
			$PasswordLib2 = new \PasswordLib\PasswordLib;
			$result = $PasswordLib2->verifyPasswordHash($_REQUEST['old_password'],$RS->fields['password']);
			if(!$result ){
			//if($RS->RecordCount()<=0){
				$json_array['message'] = $merchant_msg["changepassword"]["Msg_please_enter_valid_old_password"];
				$json_array['status'] = "false";
				$_SESSION['msg'] = $merchant_msg["changepassword"]["Msg_please_enter_valid_old_password"];
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			$array = $json_array = $where_clause = array();
			$PasswordLib = new \PasswordLib\PasswordLib;
//$hash = $PasswordLib->createPasswordHash($password);
	//$array['password'] = $PasswordLib->createPasswordHash($_REQUEST['password']);
			$array['password'] =  $PasswordLib->createPasswordHash($_REQUEST['new_password']);
			
			$where_clause['id'] = $merchant_id;
			
			if($where_clause['id'] == ""){
				$json_array['message'] = "Invalid Merchant ID";
				$json_array['status'] = "false";
				$_SESSION['msg'] = "Invalid Merchant ID";
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			
			$objDBWrt->Update($array, "merchant_user", $where_clause);
			
			$json_array['message'] = $merchant_msg["changepassword"]["Msg_password_changed"];
			$json_array['status'] = "true";
			$_SESSION['msg'] = $merchant_msg["changepassword"]["Msg_password_changed"];
			$json = json_encode($json_array);
			echo $json;
			exit();
	}
	// 369
}
if(isset($_REQUEST['btnUpdateForgotPassword']))
{
	$array = $json_array =array();
	$merchant_id = $_SESSION['forgot_mer_id'];
	//exit();
	if($merchant_id == ""){
		$json_array['status'] = "false";
		$json_array['message'] = "Invalid Merchant ID";
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	else
	{

			if($_REQUEST['new_password'] == ""){
				$json_array['message'] = $merchant_msg["changepassword"]["Msg_please_enter_new_password"];
				$json_array['status'] = "false";
				//$_SESSION['msg'] = "Please enter New Password";
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			if($_REQUEST['con_new_password'] == ""){
				$json_array['message'] = $merchant_msg["changepassword"]["Msg_please_enter_confirm_new_password"];
				$json_array['status'] = "false";
				//$_SESSION['msg'] = "Please enter Confirm New Password";
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			if($_REQUEST['new_password'] != $_REQUEST['con_new_password']){
				$json_array['message'] = $merchant_msg["changepassword"]["Msg_new_password_not_match"];
				$json_array['status'] = "false";
				//$_SESSION['msg'] = "New Password does not Match";
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			if($_REQUEST['mycaptcha_fpm'] == ""){
				$json_array['message'] = $merchant_msg["changepassword"]["Msg_please_enter_captcha"];
				$json_array['status'] = "false";
				//$_SESSION['msg'] = "Please enter captcha";
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
                        if(strtolower($_REQUEST['mycaptcha_fpm'])==strtolower($_SESSION['random_number_m_f_p']))
                        {

                        }
                        else 
                        {
                            $json_array['status'] = "false";
                            $json_array['message'] = $merchant_msg["changepassword"]["Msg_captcha_not_match"];
                            $json = json_encode($json_array);
                            echo $json;
                            exit();
                        }
			
			//$array['password'] = md5($_REQUEST['old_password']);
			//$RS = $objDB->Show("merchant_user",$array);
			//if($RS->RecordCount()<=0){
			//	$json_array['message'] = "Please enter Valid Old Password";
			//	$json_array['status'] = "false";
			//	$_SESSION['msg'] = "Please enter Valid Old Password";
			//	$json = json_encode($json_array);
			//	echo $json;
			//	exit();
			//}
			
			$array = $json_array = $where_clause = array();
						
			$PasswordLib = new \PasswordLib\PasswordLib;
			//$hash = $PasswordLib->createPasswordHash($password);
			$array['password'] = $PasswordLib->createPasswordHash($_REQUEST['new_password']);
			
			
			$where_clause['id'] = $merchant_id;
			
			if($where_clause['id'] == ""){
				$json_array['message'] = "Invalid Merchant ID";
				$json_array['status'] = "false";
				//$_SESSION['msg'] = "Invalid Merchant ID";
				$json = json_encode($json_array);
				echo $json;
				exit();
			}
			
			$objDBWrt->Update($array, "merchant_user", $where_clause);
			
			$json_array['message'] = $merchant_msg["changepassword"]["Msg_password_changed"];
			$json_array['status'] = "true";
			//$_SESSION['msg'] = "Password has been changed successfully";
			$json = json_encode($json_array);
			echo $json;
			exit();
	}
	// 369
}
if(isset($_REQUEST['btndeletegroup'])){
	$array = $json_array = $where_clause = array();
	if($_REQUEST['id'] != "")
	{ 
		if($_REQUEST['hard']==1)
		{
			$group_id = $_REQUEST['id'];
			
			$array_where=array();
			$array_where['id'] = $group_id;
			$objDBWrt->Remove("merchant_customerlist", $array_where);
		}
		else
		{
			$group_id = $_REQUEST['id'];
			
			$array['isDeleted'] = 1;
			$where_clause['id'] = $group_id;
				
			$objDBWrt->Update($array, "merchant_customerlist", $where_clause);
		}
		
		$json_array['status'] = "true";
		$json_array['message'] =  $merchant_msg["manage-customers"]["msg_group_deleted"];
		//$_SESSION['msg'] =  $merchant_msg["manage-customers"]["msg_group_deleted"];
		
		//header("Location: ".WEB_PATH."/merchant/manage-customers.php");
		
		$json = json_encode($json_array);
		echo $json;
		exit();
		
	}
}
if(isset($_REQUEST['btnGetMerchantInfo'])){
	$json_array = array();
	if($_REQUEST['mer_id'] != "")
	{ 
		/*$Sql = "select * from merchant_user where id=".$_REQUEST['mer_id'];
		$RS_t = $objDB->Conn->Execute($Sql);*/
		$RS_t = $objDB->Conn->Execute("select * from merchant_user where id=?",array($_REQUEST['mer_id']));

		$count = 0 ;
		while($Row = $RS_t->FetchRow())
		{
			$records[$count] = get_field_value($Row);
			$count++;
		}
        $json_array['status'] = "true";
		$json_array['total_records'] = $RS_t->RecordCount();
		$json_array["records"]= $records;
		$json = json_encode($json_array);
		echo $json;
		
	}
}
// 2 10 2012 
if(isset($_REQUEST['btnGetAllBarcode'])){
	$json_array = array();

	$Sql = "select * from coupon_codes";
	$RS_t = $objDB->Conn->Execute($Sql);
	$count = 0 ;
	while($Row = $RS_t->FetchRow())
	{
		$records[$count] = get_field_value($Row);
		$count++;
	}
	$json_array['status'] = "true";
	$json_array['total_records'] = $RS_t->RecordCount();
	$json_array["records"]= $records;
	$json = json_encode($json_array);
	echo $json;
	exit();
}
if(isset($_REQUEST['btnGetLocationListOfCustomerOfMerchant']))
{
	 $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
	 $mer_parent_id = $_REQUEST['mer_parent_id'];
	 $customer_id = $_REQUEST['customer_id'];
	
	/* $Sql = "SELECT * FROM locations WHERE id in (select l.id from locations l where l.created_by=$mer_parent_id and l.id =(select location_access from merchant_user_role where merchant_user_id = $merchant_id))";
	
	
	 $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * FROM locations WHERE id in (select l.id from locations l where l.created_by=? and l.id =(select location_access from merchant_user_role where merchant_user_id = ?))",array($mer_parent_id,$merchant_id));
	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	//$records[$count] = get_field_value($Row);
		   	//$count++;
			/*$Sql1 = "SELECT * FROM subscribed_stores WHERE location_id = $Row[0] and customer_id =$customer_id";
	 		$RS1 = $objDB->Conn->Execute($Sql1);*/
			$RS1 = $objDB->Conn->Execute("SELECT * FROM subscribed_stores WHERE location_id = ? and customer_id =?",array($Row[0],$customer_id));

			if($RS1->RecordCount()>0)
	 		{
				  $json_array['status'] = "true";
				  $json_array['total_records'] = $RS1->RecordCount();
				  $count=0;
				  while($Row1 = $RS1->FetchRow())
				  {
					$records[$count] = get_field_value($Row);
					$count++; 
				  }
				  $json_array["records"]= $records;
			}
			else
			{
				//$json_array['status'] = "false";
			    //$json_array['total_records'] = 0;
			    //$json = json_encode($json_array);
			    //echo $json;
			    //exit();
			}
		  }
		  
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }

	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}
if(isset($_REQUEST['btnGetGroupListOfCustomerOfMerchant']))
{
	 $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
	 $customer_id = $_REQUEST['customer_id'];
	
	 /*$Sql = "SELECT * FROM merchant_groups WHERE merchant_id=$merchant_id";
	 $RS = $objDB->Conn->Execute($Sql);*/
	 $RS = $objDB->Conn->Execute("SELECT * FROM merchant_groups WHERE merchant_id=?",array($merchant_id));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
				//$records[$count] = get_field_value($Row);
				//$count++;
				/*$Sql1 = "SELECT * FROM merchant_subscribs WHERE merchant_id = $merchant_id and user_id = $customer_id and group_id = $Row[0]";
				$RS1 = $objDB->Conn->Execute($Sql1);*/
				$RS1 = $objDB->Conn->Execute("SELECT * FROM merchant_subscribs WHERE merchant_id =? and user_id = ? and group_id = ?",array($merchant_id,$customer_id,$Row[0]));

				if($RS1->RecordCount()>0)
				{				  
					  while($Row1 = $RS1->FetchRow())
					  {
						$records[$count] = get_field_value($Row);
						$count++; 
					  }
					  
				}
				else
				{
					//$json_array['status'] = "false";
					//$json_array['total_records'] = 0;
					//$json = json_encode($json_array);
					//echo $json;
					//exit();
				}
		  }
		  
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $count;
		  $json_array["records"]= $records;
		  
		  
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }

	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}
// 2 10 2012 

// 3 10 2021
if(isset($_REQUEST['btnGetPermissionOfMerchant']))
{
	 $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
	 
	/* $Sql = "SELECT * FROM merchant_user_role Where merchant_user_id = $merchant_id";
	 
	 $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * FROM merchant_user_role Where merchant_user_id = ?",array($merchant_id));

	 if($RS->RecordCount()>0)
	 {
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	//$records[$count] = get_field_value($Row);
			$records[$count] = unserialize($Row[2]);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

// 3 10 2012
// 4 10 2012
if(isset($_REQUEST['getCategories']))
{
	 $json_array = array();
	 $Sql = "SELECT * FROM categories";
	 $Rs = $objDB->Conn->Execute($Sql);
	 $count = 0;
	 while($Row = $Rs->FetchRow())
	 {
	  $records[$count] = get_field_value($Row);
	  $count++;
	 }
	 $json_array["total_records"] = $Rs->RecordCount();
	 $json_array["records"]= $records;
	 $json_array['status'] = "true";
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}
// 4 10 2012

// 5 10 2012
if(isset($_REQUEST['btnAddCampaignsforiphone'])){
	 $array = array();        
	 /*if($_FILES["business_logo"]["tmp_name"] != ''){
	  $Extension = strtolower(substr($_FILES["business_logo"]["name"],strrpos($_FILES["business_logo"]["name"],".")+1));
	  $array['business_logo'] = "compaign_".strtotime(date("Y-m-d H:i:s")).".".$Extension;
	  copy($_FILES["business_logo"]["tmp_name"], SERVER_PATH."/merchant/images/logo/$array[business_logo]"); 
	 }*/
		
		   /*  start of PAY-508-28033  */
			   
	 if($_REQUEST['hdn_image_path'] == "")
	 {
	  
	  $array['business_logo'] = ""; 
	 }
	 else
	 {
	  
	  $array['business_logo'] = trim($_REQUEST['hdn_image_path']); 
	 }
	 /*  end of PAY-508-28033  */
		
	 $array['title'] = $_REQUEST['title'];
	 $array['category_id'] = $_REQUEST['category_id'];
	 $array['description'] = $_REQUEST['description'];
		$array['deal_value'] = $_REQUEST['deal_value'];
	 //$start_date = explode("-",$_REQUEST['start_date']);
	 //$array['start_date'] = $start_date[2]."-".$start_date[0]."-".$start_date[1]; 
		$array['start_date'] = $_REQUEST['start_date'];
	 //$expiration_date = explode("-",$_REQUEST['expiration_date']);
	 //$array['expiration_date'] = $expiration_date[2]."-".$expiration_date[0]."-".$expiration_date[1];
		$array['expiration_date'] = $_REQUEST['expiration_date'];
	 // b
	 $array['redeem_rewards'] = $_REQUEST['redeem_rewards'];
	 $array['referral_rewards'] = $_REQUEST['referral_rewards'];
	 // b
	 $array['timezone'] = $_REQUEST['timezone'];
	 
	 
	 
	 $array['number_of_use'] = $_REQUEST['number_of_use'];
		       /* */
		         if($_REQUEST['assign_group'] == "1")
	   {
	   $array['level'] = 1;
	   }
	   else{
	   $array['level'] = 0;
	   }
	 /* */                
	 //echo "<pre>";print_r($_REQUEST);echo "</pre>";exit;
	 
	 //$array['daily_use'] = 1;
	 //$array['level'] = 1;
	 $array['max_coupns'] = $_REQUEST['max_coupns'];
	 
	 
	 
	 $array['created_date'] = date("Y-m-d H:i:s");
	 if(isset($_REQUEST['mer_id']))
	 {
	  $merchant_id = $_REQUEST['mer_id'];
	  $array['created_by'] = $merchant_id;
	 }
	 else
	 {
	  $merchant_id = $_SESSION['merchant_id'];
	  if($_REQUEST['created_by'] == ""){
	  $array['created_by'] = $_SESSION['merchant_id'];
	  }else{
	   $array['created_by'] = get_merchant_session_id($_REQUEST['created_by']);
	  }
	 }
	 
	 $array['visible'] = 1;
	 $campaign_id = $objDBWrt->Insert($array, "campaigns");
	 
	 
	 if(isset($_REQUEST['mer_id']))
	 {
	  
	   $user_group = $_REQUEST['user_group_iphone'];
	   $all_groups = explode(",",$user_group);
	  
	 }
	 else
	 {
	  
	  if(isset($_REQUEST['group_id']))
	  {
	   $all_groups = $_REQUEST['group_id'];
	   
	  }
	 }
	 foreach($all_groups as $group_id){
	  /*$Sql = "INSERT  INTO campaign_groups SET group_id='$group_id', campaign_id='$campaign_id', merchant_id='$array[created_by]'";
	  $objDB->Conn->Execute($Sql); */
		$objDBWt->Conn->Execute("INSERT  INTO campaign_groups SET group_id=?, campaign_id=?, merchant_id=?",array($group_id,$campaign_id,$array[created_by])); 

	 }
	 $count=0;
	 if(isset($_REQUEST['mer_id']))
	 {
	  $array = array();
	  $array['campaign_id'] = $campaign_id;
	  $array['location_id'] = $_REQUEST['hdn_location_id'];
	  $array['num_activation_code'] = $_REQUEST['num_activation_code'][$count];
	  $objDBWrt->Insert($array, "campaign_location");
	 }
	 else
	 {
	  if($_SESSION['merchant_info']['merchant_parent'] == 0){ 
	   if(isset($_REQUEST['location_id'])) 
	   {
	    foreach($_REQUEST['location_id'] as $location_id){
	     $array = array();
	     $array['campaign_id'] = $campaign_id;
	     $array['location_id'] = $location_id;
	     $array['num_activation_code'] = $_REQUEST['num_activation_code'][$count];
	     $objDBWrt->Insert($array, "campaign_location");
	     $count++;
	    }
	   }
	  }
	  else{
	   $array = array();
	   $array['campaign_id'] = $campaign_id;
	   $array['location_id'] = $_REQUEST['hdn_location_id'];
	   $array['num_activation_code'] = $_REQUEST['num_activation_code'][$count];
	   $objDBWrt->Insert($array, "campaign_location");
	  }
	 }
	 $array = array();
	 $array['activation_code'] = md5($campaign_id.date("Y-m-d H:i:s"));
	 $array['campaign_id'] = $campaign_id;
	 $objDBWrt->Insert($array, "activation_codes");

	 // 369
	 if(! isset($_REQUEST['mer_id']))
	 {
	  $_SESSION['msg'] = "Campaign is Added successfully";
	 }
	 
	 $json_array=array();
	 $json_array['status']='true';
	 $json_array['message']='Campaign is Added successfully';
	 $json = json_encode($json_array);
	 echo $json;
	    exit();
 // 369

}
// 5 10 2012

// 8 10 2012
if(isset($_REQUEST['btnDeleteCustomer']))
{
 $json_array = array();
 $array_where = array();
 $array_where['merchant_id'] = $_REQUEST['mer_id'];
 $array_where['user_id'] = $_REQUEST['cust_id'];
 $objDBWrt->Remove("merchant_subscribs", $array_where);
 $json_array['status'] = "true";
 $json_array['msg'] = "Customer deleted successfully.";
 $json = json_encode($json_array);
 echo $json;
 exit();
}

if(isset($_REQUEST['btnGetMedias']))
{
	 $merchant_id= $_REQUEST['mer_id'];
	 $json_array = array();
	 $merchant_array = array();
			$merchant_array['id'] = $merchant_id;
			$merchant_info = $objDB->Show("merchant_user",$merchant_array);
			 /*$query = "select * from merchant_media where merchant_id=".$merchant_id ." or merchant_id=".$merchant_info->fields['merchant_parent'] ." or merchant_id in (select id from merchant_user where merchant_parent =".$merchant_id .") order by id desc" ;
	 $Rs = $objDB->Conn->Execute($query);*/
			$Rs = $objDB->Conn->Execute("select * from merchant_media where merchant_id=? or merchant_id=? or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc",array($merchant_id,$merchant_info->fields['merchant_parent'],$merchant_id));

	 $count = 0;
	 while($Row = $Rs->FetchRow())
	 {
	  $records[$count] = get_field_value($Row);
	  $count++;
	 }
	  $json_array['status'] = "true";
	 $json_array["total_records"] = $Rs->RecordCount();
	 $json_array["records"]= $records;

	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

if(isset($_REQUEST['btnGetCampaignDetailforiphone']))
{
	 $json_array = array();
	 /*$Sql = "SELECT * FROM campaigns where id=".$_REQUEST['campaign_id'];
	 $Rs = $objDB->Conn->Execute($Sql);*/
	$Rs = $objDB->Conn->Execute("SELECT * FROM campaigns where id=?",array($_REQUEST['campaign_id']));
	 $count = 0;
	 while($Row = $Rs->FetchRow())
	 {
	  $records[$count] = get_field_value($Row);
	  $count++;
	 }
	 $json_array["total_records"] = $Rs->RecordCount();
	 $json_array["records"]= $records;
	 $json_array['status'] = "true";

	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}

// 8 10 2012

// 9 10 2012
// ----- For redeem coupon
if(isset($_REQUEST['btncheckdealiphone']))
{
	if(isset($_REQUEST['mer_id']))
	{
		$merchant_id = $_REQUEST['mer_id'];
		$merchant_parent = $_REQUEST['mer_parent'];
	}
	else
	{
		$merchant_id = $_SESSION['merchant_id'];
		$merchant_parent = $_SESSION['merchant_info']['merchant_parent'];
	}
	$json_array = array();
      if($_REQUEST['txt_barcode'] != ""){
	if($merchant_parent == 0){
		//$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE start_date<='$date_f' AND expiration_date >='$date_f' AND visible='1' AND id =".$RS->fields['customer_campaign_code'] ." AND (created_by = '$_SESSION[merchant_id]' or created_by in ( select id from merchant_user where merchant_parent = ". $_SESSION[merchant_id] ." ))";
		/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.no_of_shared, cp.referral_rewards  FROM coupon_codes c, campaigns cp WHERE c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code and (cp.created_by = '$merchant_id' or cp.created_by in ( select id from merchant_user where merchant_parent = ". $merchant_id ." ))";*/
		$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.no_of_shared, cp.referral_rewards  FROM coupon_codes c, campaigns cp WHERE c.coupon_code=? and cp.id=c.customer_campaign_code and (cp.created_by =? or cp.created_by in ( select id from merchant_user where merchant_parent =? ))",array($_REQUEST['txt_barcode'],$merchant_id,$merchant_id));

	}else{
		/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.no_of_shared , cp.referral_rewards  FROM coupon_codes c, campaigns cp WHERE c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code and cp.id in (select cl.campaign_id from campaign_location cl , merchant_user_role mur where mur.merchant_user_id = ".$merchant_id." and cl.location_id = mur.location_access )";*/
		$RS =$objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.no_of_shared , cp.referral_rewards  FROM coupon_codes c, campaigns cp WHERE c.coupon_code=? and cp.id=c.customer_campaign_code and cp.id in (select cl.campaign_id from campaign_location cl , merchant_user_role mur where mur.merchant_user_id =? and cl.location_id = mur.location_access )",array($_REQUEST['txt_barcode'],$merchant_id));

	}
	
		//$RS = $objDB->Conn->Execute($Sql);
		if($RS->RecordCount()<=0){
			$json_array['status'] = "false";
			$json_array['message'] = "This coupon is not for this store";
			$json = json_encode($json_array);
			echo $json;
			return $json;
			
		}
		else
		{
			$dt_wh = "  CONVERT_TZ(NOW(),'+00:00','+00:00') BETWEEN CONVERT_TZ(start_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) AND CONVERT_TZ(expiration_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) ";
			$date_f = date("Y-m-d H:i:s");
			/*$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE ".$dt_wh." AND visible='1' AND id =".$RS->fields['customer_campaign_code'];
			$RS_t = $objDB->Conn->Execute($Sql);*/
			$RS_t = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns WHERE ".$dt_wh." AND visible=? AND id =?",array(1,$RS->fields['customer_campaign_code']));

			if($RS_t->fields['total'] == 0)
			{
				$json_array['status'] = "false";
				$json_array['message'] = "Oppps ! This campaign is expire.";
				$json = json_encode($json_array);
				echo $json;
				return $json;
			}else{
				/*$Sql = "SELECT number_of_use FROM campaigns WHERE id =".$RS->fields['customer_campaign_code'];
				$RS_camp_detail = $objDB->Conn->Execute($Sql);*/
				$RS_camp_detail = $objDB->Conn->Execute("SELECT number_of_use FROM campaigns WHERE id =?",array($RS->fields['customer_campaign_code']));

				if($RS_camp_detail->fields['number_of_use'] == 1)
				{
					/*$Sql = "SELECT * FROM reward_user WHERE customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code'];
					$RS_user_exist = $objDB->Conn->Execute($Sql);*/
					$RS_user_exist = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE customer_id=? and campaign_id =?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code']));
					if($RS_user_exist->RecordCount() == 0){
						
						$json_array['status'] = "true";
						$json_array['id'] = $RS->fields['customer_campaign_code'];
						$json_array['message'] = "Campaign is available";
						$json = json_encode($json_array);
						echo $json;
						return $json;
					}
					else{
						$json_array['status'] = "false";
						$json_array['message'] = "Oppps ! This coupan is already redeemed";
						$json = json_encode($json_array);
						echo $json;
						return $json;
					}
				}
				else if($RS_camp_detail->fields['number_of_use'] == 2)
				{
					/*$Sql = "SELECT * FROM reward_user WHERE customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code'] ." and  DATE_FORMAT(reward_date, '%Y-%m-%d')  =  '".date('Y-m-d')."' " ;
					$RS_user_exist = $objDB->Conn->Execute($Sql);*/
					$RS_user_exist = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE customer_id=? and campaign_id =? and  DATE_FORMAT(reward_date, '%Y-%m-%d')  = ? ",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],date('Y-m-d')));

					if($RS_user_exist->RecordCount() == 0){
						
						$json_array['status'] = "true";
						$json_array['id'] = $RS->fields['customer_campaign_code'];
						$json_array['message'] = "Campaign is available";
						$json = json_encode($json_array);
						echo $json;
						return $json;
					}
					else{
						$json_array['status'] = "false";
						$json_array['message'] = "Oppps ! This coupan is already redeemed today";
						$json = json_encode($json_array);
						echo $json;
						return $json;
					}
					
				}
				else if($RS_camp_detail->fields['number_of_use'] == 3)
				{
					$json_array['status'] = "true";
					$json_array['id'] = $RS->fields['customer_campaign_code'];
					$json_array['message'] = "Campaign is available";
					$json = json_encode($json_array);
					echo $json;
					return $json;
				}
				
				
			}
		}
      }else
      {
	$json_array['status'] = "false";
	$json_array['message'] = "Enter proper Coupon code";
	$json = json_encode($json_array);
	echo $json;
	return $json;
      }
}

if(isset($_REQUEST['campaign_detail_for_iphone']))
{
	$array = $json_array = array();
	
	/*$Sql = "SELECT c.* , cg.cat_name category_name ,mu.firstname first_name , mu.lastname last_name FROM `campaigns` c , merchant_user mu , categories cg  WHERE c.id = ".$_REQUEST['id']." and mu.id = c.created_by and c.category_id = cg.id";
	$RS = $objDB->execute_query($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT c.* , cg.cat_name category_name ,mu.firstname first_name , mu.lastname last_name FROM `campaigns` c , merchant_user mu , categories cg  WHERE c.id = ? and mu.id = c.created_by and c.category_id = cg.id",array($_REQUEST['id']));
	
	$records = array();
	$count=0;
	while($Row = $RS->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array["records"]= $records;
	
	/*$Sql = "SELECT c.*,u.firstname , u.lastname  FROM coupon_codes c , customer_user u WHERE c.coupon_code='".$_REQUEST['coupon_code']."' and u.id=c.customer_id";
	$RS_userinfo = $objDB->execute_query($Sql);*/
	$RS_userinfo = $objDB->Conn->Execute("SELECT c.*,u.firstname , u.lastname  FROM coupon_codes c , customer_user u WHERE c.coupon_code=? and u.id=c.customer_id",array($_REQUEST['coupon_code']));

	
	$records = array();
	$count=0;
	while($Row = $RS_userinfo->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array["customer_info"]= $records;
	/*$Sql = "SELECT * from activation_codes where campaign_id =".$_REQUEST['id']." limit 1";
	$RSCode = $objDB->execute_query($Sql);*/
	$RSCode = $objDB->Conn->Execute("SELECT * from activation_codes where campaign_id =? limit 1",array($_REQUEST['id']));

	
	$records = array();
	$count=0;
	while($Row = $RSCode->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array["activation_code"]= $records;
	
	
	
	/*$Sql = "SELECT l.* , mu.firstname firstname , mu.lastname lastname FROM locations l , merchant_user mu  WHERE l.id IN (SELECT cl.location_id FROM campaign_location cl WHERE cl.campaign_id =". $_REQUEST['id']." ) and mu.id = l.created_by";
	$RS_locations =  $objDB->execute_query($Sql);*/
	$RS_locations =  $objDB->Conn->Execute("SELECT l.* , mu.firstname firstname , mu.lastname lastname FROM locations l , merchant_user mu  WHERE l.id IN (SELECT cl.location_id FROM campaign_location cl WHERE cl.campaign_id =? ) and mu.id = l.created_by",array($_REQUEST['id']));

	$records = array();
	$count=0;
	while($Row = $RS_locations->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array["locations"]= $records;
	
	
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	return $json;
}

// 9 10 2012
function get_field_value($Row)
{
	$ar = $Row;
	
	$ar1 = array_unique($ar);
	for ($i = 0; $i < (count($ar)) ; $i++) {
		if(key_exists($i,$ar))
		{
			unset($ar[$i]);
		}
	    }
	
	return $ar;	
}

//
if(isset($_REQUEST['get_campaign_template']))
{
	$array_where_t = array();
	$array_where_t['created_by'] = $_REQUEST['mer_id'];
	$RSTemplate = $objDB->Show("campaigns_template",$array_where_t);
	$records = array();
	$count=0;
	while($Row = $RSTemplate->FetchRow())
	{
	      $records[$count] = get_field_value($Row);
	      $count++;
	}
	$json_array["records"]= $records;
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	return $json;
}

/******** 
@USE : Get available point of merchant
@PARAMETER : merchant_id
@RETURN : available points
@USED IN PAGES : purchase-points.php , purchasepoint-edit.php
*********/
if(isset($_REQUEST['get_available_points_of_login_user']))
{
	$array = $json_array = array();
        $main_merchant_id=getmainmercahnt_id($_REQUEST['mer_id']);
	//$Sql = "SELECT available_point from merchant_user where id=".$_REQUEST['mer_id'] ." or id = (select merchant_parent from merchant_user where id =".$_REQUEST['mer_id'].")";
	/*$Sql = "SELECT available_point from merchant_user where id=".$main_merchant_id;
        $RS =  $objDB->execute_query($Sql);*/
	$RS =  $objDB->Conn->Execute("SELECT available_point from merchant_user where id=?",array($main_merchant_id));
	$records = array();
	$json_array['available_points'] = $RS->fields['available_point'];
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	return $json;
	
}

//bsb
if(isset($_REQUEST['getcategoryfortemplate']))
{
	 $json_array = array();
	 /*$Sql = "SELECT category_id FROM campaigns_template where id=".$_REQUEST['template_id'];
	 $Rs = $objDB->Conn->Execute($Sql);*/
	$Rs = $objDB->Conn->Execute("SELECT category_id FROM campaigns_template where id=?",array($_REQUEST['template_id']));

	 $cat_name = '';
	 while($Row = $Rs->FetchRow())
	 {	 
	  $cat_id = $Row[0];
	 }
	 /*$Sql = "SELECT cat_name FROM categories where id=".$cat_id;
	 $Rs = $objDB->Conn->Execute($Sql);*/
	$Rs = $objDB->Conn->Execute("SELECT cat_name FROM categories where id=?",array($cat_id));
	 $cat_name = '';
	 while($Row = $Rs->FetchRow())
	 {	 
	  $cat_name = $Row[0];
	 }
	 
	 $json_array['status'] = "true";
	 $json_array["catgory_name"]= $cat_name;

	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}
/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnDeleteTemplate'])){
	$json_array = array();
	if($_REQUEST['mer_id'] != "")
	{ 
		
		$merchant_id = $_REQUEST['mer_id'];
  		$template_id = $_REQUEST['template_id'];
        $array_where['created_by'] = $merchant_id;
        $array_where['id'] = $template_id;
  
		$objDBWrt->Remove("campaigns_template", $array_where);
		$json_array['status'] = "true";
		$json_array['message'] = "Template has been Deleted successfully";
		$json = json_encode($json_array);
		echo $json;
		exit();
		
	}
}
// 4- nov- 2012 for display latest new active campaign //

if(isset($_REQUEST['get_latest_5_campaigns']))
{
	$json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
	 $today_date = date("Y-m-d")." 00:00:00";
	 $Where = "";
	
		$Where .= " AND expiration_date >= '".$today_date."' ";
	
	 if(isset($_REQUEST['parent']))
	 {
		/*$Sql = "SELECT * FROM campaigns WHERE (created_by = $merchant_id or created_by in ( select id from merchant_user where merchant_parent = $merchant_id )) $Where ORDER BY created_by DESC limit 5";*/
		$RS = $objDB->Conn->Execute("SELECT * FROM campaigns WHERE (created_by = ? or created_by in ( select id from merchant_user where merchant_parent = ? )) $Where ORDER BY created_by DESC limit 5",array($merchant_id,$merchant_id));
	 }
	 else
	 {
//		$Sql = "SELECT * FROM campaigns WHERE created_by = $merchant_id $Where ORDER BY created_by DESC limit 5";
		$RS = $objDB->Conn->Execute("SELECT * FROM campaigns WHERE created_by = ? $Where ORDER BY created_by DESC limit 5",array($merchant_id));
	 }
	 
	 //$RS = $objDB->Conn->Execute($Sql);
	 if($RS->RecordCount()>0)
	 {
		 
		 
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] =get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();	
}
// end for 4- nov- 2012 for display latest new active campaign //


/******** 
@USE : Get category detail of given category id
@PARAMETER : category id
@RETURN : category detail
@USED IN PAGES : compaigns.php , reports.php
*********/
if(isset($_REQUEST['getCategoryfromid']))
{
    $json_array=$records=array();
    /*$Sql="select * from categories where id=".$_REQUEST['cat_id'];
    $RS=$objDB->Conn->Execute($Sql);*/
	$RS=$objDB->Conn->Execute("select * from categories where id=?",array($_REQUEST['cat_id']));
    if($RS->RecordCount()>0)
    {
        $json_array['status']='true';
        $json_array['total_records']=$RS->RecordCount();
        $count=0;
        while($Row=$RS->FetchRow())
        {
            $records[$count] = get_field_value($Row);
            $count++;
	}
	$json_array["records"]= $records;
            
    }
    else
    {
      $json_array['status'] = "false";
      $json_array['total_records'] = 0;
      $json = json_encode($json_array);
      echo $json;
      exit();
    }
    
   $json = json_encode($json_array);
   echo $json;
   exit();
    
}
/******** 
@USE : create segmentation list
@PARAMETER : segmentation name,other parameters
@RETURN :
@USED IN PAGES : segment-customers.php
*********/
if(isset($_REQUEST['create_segment_list']))
{
	/*
	echo "<pre>";
	print_r($_REQUEST);
	echo "</pre>";*/
	//exit();
	
	if($_REQUEST['seg_query']=="demographics")
	{
		$optvisitedfrom_demoraphics=$_REQUEST['optvisitedfrom_demoraphics'];
		$optvisitedto_demoraphics=$_REQUEST['optvisitedto_demoraphics'];
		$optvisitedfor_demoraphics=$_REQUEST['optvisitedfor_demoraphics'];
		$cust_id_array_final = array();
		
		
	    $cust_id_array_age= array();
          
		$age_condition ="";
		$age_param_cnt=0;
	
		if(isset($_REQUEST['optage']))
		{
			foreach($_REQUEST['optage'] as $optage)
			{
				if($optage==1)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) <=17)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) <=17)';
					}
					$age_param_cnt++;
				}
				if($optage==2)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=18 and (YEAR(CURDATE())-dob_year) <=24)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=18 and (YEAR(CURDATE())-dob_year) <=24)';
					}
					$age_param_cnt++;
				}
				if($optage==3)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=25 and (YEAR(CURDATE())-dob_year) <=44)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=25 and (YEAR(CURDATE())-dob_year) <=44)';
					}
					$age_param_cnt++;
				}
				if($optage==4)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=45 and (YEAR(CURDATE())-dob_year) <=54)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=45 and (YEAR(CURDATE())-dob_year) <=54)';
					}
					$age_param_cnt++;
				}
				if($optage==5)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=55 and (YEAR(CURDATE())-dob_year) <=64)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=55 and (YEAR(CURDATE())-dob_year) <=64)';
					}
					$age_param_cnt++;
				}
				if($optage==6)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=65)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=65)';
					}
					$age_param_cnt++;
				}
				
			}
			//echo $age_condition;
			$sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$age_condition;
			//echo $sql;
			$RS = $objDB->Conn->Execute($sql);
			if($RS->RecordCount()>0)
			{
				while($Row = $RS->FetchRow())
				{
					array_push($cust_id_array_age, $Row['cust_id']);	
				}
				/*
				echo "<pre>";
				print_r($cust_id_array_age);
				echo "</pre>";
				*/
			}
			
		}
		
		$cust_id_array_gender = array();
		
		$gender_condition ="";
		$gender_param_cnt=0;
		
		if(isset($_REQUEST['optgender']))
		{
			foreach($_REQUEST['optgender'] as $optgender)
			{
				if($optgender=='Male')
				{
					
					if($gender_param_cnt>0)
					{
						$gender_condition.=' or (gender="1")';
					}	
					else
					{
						$gender_condition.=' (gender="1")';
					}
					$gender_param_cnt++;
				}
				if($optgender=='Female')
				{
					
					if($gender_param_cnt>0)
					{
						$gender_condition.=' or (gender="2")';
					}	
					else
					{
						$gender_condition.=' (gender="2")';
					}
					$gender_param_cnt++;
				}
				if($optgender=='Unknown')
				{
					
					if($gender_param_cnt>0)
					{
						$gender_condition.=' or (gender="")';
					}	
					else
					{
						$gender_condition.=' (gender="")';
					}
					$gender_param_cnt++;
				}
			}
			//echo $gender_condition;
			//echo $sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$gender_condition;
			//echo $sql;
			
			if(count($cust_id_array_age)>0)
			{
				$cust_id_str = implode(",",$cust_id_array_age);
				$sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$gender_condition." and cu.id in (".$cust_id_str.")";
			}
			else
			{
				$sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$gender_condition;
			}
			
			$RS = $objDB->Conn->Execute($sql);
			if($RS->RecordCount()>0)
			{
				while($Row = $RS->FetchRow())
				{
					//if(in_array($Row['cust_id'], $cust_id_array))
					//{
					//}
					//else
					//{
						array_push($cust_id_array_gender, $Row['cust_id']);	
					//}
				}
				/*
				echo "<pre>";
				print_r($cust_id_array_gender);
				echo "</pre>";	
				*/ 
			}
		}
		/*
		echo "<pre>";
		print_r($cust_id_array_age);
		echo "</pre>";
		echo "<pre>";
		print_r($cust_id_array_gender);
		echo "</pre>";
		*/
		if(count($cust_id_array_age)>0 && count($cust_id_array_gender)>0)
		{
			$result_Array_Age_gender = array_values(array_intersect($cust_id_array_age, $cust_id_array_gender));
		}
		else if(count($cust_id_array_age)>0)
		{
			$result_Array_Age_gender = $cust_id_array_age;
		}
		else if(count($cust_id_array_gender)>0)
		{
			$result_Array_Age_gender = $cust_id_array_gender;
		}
		else
		{
			$result_Array_Age_gender = array();
		}
		/*
		echo "<pre>";
		print_r($result_Array_Age_gender);
		echo "</pre>";
		*/
		if($optvisitedfor_demoraphics!="" && $optvisitedfrom_demoraphics!="" && $optvisitedto_demoraphics!="")	
		{		
			if($optvisitedfor_demoraphics=="Campaigns")
			{
				if(count($result_Array_Age_gender)>0)
				{
					$result_Array_Age_gender_str = implode(",",$result_Array_Age_gender);
					$sql="SELECT distinct cu.id 'cust_id'
							FROM customer_user cu,customer_campaigns cc,campaign_redeem cr
							where (cc.customer_id=cu.id and cr.customer_campaign_id=cc.id) 
							and (date_format(cr.redeem_date,'%Y-%m-%d') between '".$optvisitedfrom_demoraphics."' and '".$optvisitedto_demoraphics."')
							and cu.id in (".$result_Array_Age_gender_str.")";
					//echo $sql;
					$RS = $objDB->Conn->Execute($sql);
					
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							array_push($cust_id_array_final, $Row['cust_id']);	
						}
						
					}
				}
				else
				{
					$sql="SELECT distinct cu.id 'cust_id'
							FROM customer_user cu,customer_campaigns cc,campaign_redeem cr
							where (cc.customer_id=cu.id and cr.customer_campaign_id=cc.id) 
							and (date_format(cr.redeem_date,'%Y-%m-%d') between '".$optvisitedfrom_demoraphics."' and '".$optvisitedto_demoraphics."')";
					//echo $sql;
					$RS = $objDB->Conn->Execute($sql);
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							array_push($cust_id_array_final, $Row['cust_id']);	
						}
						
					}
				}
						
			}
			else if($optvisitedfor_demoraphics=="Loyalty Card")
			{
				if(count($result_Array_Age_gender)>0)
				{
					$result_Array_Age_gender_str = implode(",",$result_Array_Age_gender);
					$sql="SELECT distinct cu.id 'cust_id'
							FROM customer_user cu,customer_loyalty_reward_card clrc,customer_loyalty_card_transaction clct
							where (clrc.user_id=cu.id and clct.user_card_id=clrc.id)  
							and (date_format(clct.transaction_date,'%Y-%m-%d') between '".$optvisitedfrom_demoraphics."' and '".$optvisitedto_demoraphics."') 
							and cu.id in (".$result_Array_Age_gender_str.")";
					//echo $sql;
					$RS = $objDB->Conn->Execute($sql);
					
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							array_push($cust_id_array_final, $Row['cust_id']);	
						}
						
					}
				}
				else
				{
					$sql="SELECT distinct cu.id 'cust_id'
							FROM customer_user cu,customer_loyalty_reward_card clrc,customer_loyalty_card_transaction clct
							where (clrc.user_id=cu.id and clct.user_card_id=clrc.id)  
							and (date_format(clct.transaction_date,'%Y-%m-%d') between '".$optvisitedfrom_demoraphics."' and '".$optvisitedto_demoraphics."')";
					//echo $sql;
					$RS = $objDB->Conn->Execute($sql);
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							array_push($cust_id_array_final, $Row['cust_id']);	
						}
						
					}
				}
			}
		}
		
		/*
		echo "<pre>";
		print_r($cust_id_array_final);
		echo "</pre>";	
		*/
		
		if(count($cust_id_array_final)>0)
		{
			$distribution_list_name=$_REQUEST['group_name'];
		
			$clone_group = array();
			$clone_group['group_name'] = $distribution_list_name;
			$clone_group['merchant_id'] = $_SESSION['merchant_id'];
			$clone_group['active'] = 1;
			$clone_group['is_segmented'] = 1;
			$inserted_grop_id = $objDBWrt->Insert($clone_group, "merchant_customerlist");
			
			if(count($cust_id_array_final)>0)
			{
				foreach($cust_id_array_final as $user_id)
				{
					$RS_ms = $objDB->Conn->Execute("SELECT * FROM merchant_customerlist_detail mcd,merchant_customerlist mc WHERE mc.id= mcd.merchant_group_id and mc.merchant_id=? AND mcd.customer_id=? AND mc.id=?",array($_SESSION['merchant_id'],$user_id,$inserted_grop_id));
											
					if($RS_ms->RecordCount()<=0)
					{
						$objDBWrt->Conn->Execute("INSERT INTO merchant_customerlist_detail SET customer_id=?,merchant_group_id=?",array($user_id,$inserted_grop_id));
					}
				}
			}
		}
		
		
	}
	else if($_REQUEST['seg_query']=="location")
	{
		$optvisitedfrom=$_REQUEST['optvisitedfrom'];
		$optvisitedto=$_REQUEST['optvisitedto'];
		$optvisitedfor_location=$_REQUEST['optvisitedfor_location'];
		
		if($optvisitedfor_location=="Campaigns")
		{
			$optratedlocation=$_REQUEST['optratedlocation'];
			$optrated=$_REQUEST['optrated'];
		}
			
		$optamountspent=$_REQUEST['optamountspent'];
		if(isset($_REQUEST['optrevenue']))
			$optrevenue=$_REQUEST['optrevenue'];
		
		$cust_id_array_final = array();
			
	    $cust_id_array_age= array();
          
		$age_condition ="";
		$age_param_cnt=0;
	
		if(isset($_REQUEST['optage_location']))
		{
			foreach($_REQUEST['optage_location'] as $optage)
			{
				if($optage==1)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) <=17)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) <=17)';
					}
					$age_param_cnt++;
				}
				if($optage==2)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=18 and (YEAR(CURDATE())-dob_year) <=24)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=18 and (YEAR(CURDATE())-dob_year) <=24)';
					}
					$age_param_cnt++;
				}
				if($optage==3)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=25 and (YEAR(CURDATE())-dob_year) <=44)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=25 and (YEAR(CURDATE())-dob_year) <=44)';
					}
					$age_param_cnt++;
				}
				if($optage==4)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=45 and (YEAR(CURDATE())-dob_year) <=54)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=45 and (YEAR(CURDATE())-dob_year) <=54)';
					}
					$age_param_cnt++;
				}
				if($optage==5)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=55 and (YEAR(CURDATE())-dob_year) <=64)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=55 and (YEAR(CURDATE())-dob_year) <=64)';
					}
					$age_param_cnt++;
				}
				if($optage==6)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=65)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=65)';
					}
					$age_param_cnt++;
				}
				
			}
			//echo $age_condition;
			$sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$age_condition;
			//echo $sql;
			$RS = $objDB->Conn->Execute($sql);
			if($RS->RecordCount()>0)
			{
				while($Row = $RS->FetchRow())
				{
					array_push($cust_id_array_age, $Row['cust_id']);	
				}
				/*
				echo "<pre>";
				print_r($cust_id_array_age);
				echo "</pre>";
				*/
			}
			
		}
		
		$cust_id_array_gender = array();
		
		$gender_condition ="";
		$gender_param_cnt=0;
		
		if(isset($_REQUEST['optgender_location']))
		{
			foreach($_REQUEST['optgender_location'] as $optgender)
			{
				if($optgender=='Male')
				{
					
					if($gender_param_cnt>0)
					{
						$gender_condition.=' or (gender="1")';
					}	
					else
					{
						$gender_condition.=' (gender="1")';
					}
					$gender_param_cnt++;
				}
				if($optgender=='Female')
				{
					
					if($gender_param_cnt>0)
					{
						$gender_condition.=' or (gender="2")';
					}	
					else
					{
						$gender_condition.=' (gender="2")';
					}
					$gender_param_cnt++;
				}
				if($optgender=='Unknown')
				{
					
					if($gender_param_cnt>0)
					{
						$gender_condition.=' or (gender="")';
					}	
					else
					{
						$gender_condition.=' (gender="")';
					}
					$gender_param_cnt++;
				}
			}
			//echo $gender_condition;
			//echo $sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$gender_condition;
			//echo $sql;
			
			if(count($cust_id_array_age)>0)
			{
				$cust_id_str = implode(",",$cust_id_array_age);
				$sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$gender_condition." and cu.id in (".$cust_id_str.")";
			}
			else
			{
				$sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$gender_condition;
			}
			
			$RS = $objDB->Conn->Execute($sql);
			if($RS->RecordCount()>0)
			{
				while($Row = $RS->FetchRow())
				{
					//if(in_array($Row['cust_id'], $cust_id_array))
					//{
					//}
					//else
					//{
						array_push($cust_id_array_gender, $Row['cust_id']);	
					//}
				}
				/*
				echo "<pre>";
				print_r($cust_id_array_gender);
				echo "</pre>";	
				*/ 
			}
		}
		/*
		echo "<pre>";
		print_r($cust_id_array_age);
		echo "</pre>";
		echo "<pre>";
		print_r($cust_id_array_gender);
		echo "</pre>";
		*/
		if(count($cust_id_array_age)>0 && count($cust_id_array_gender)>0)
		{
			$result_Array_Age_gender = array_values(array_intersect($cust_id_array_age, $cust_id_array_gender));
		}
		else if(count($cust_id_array_age)>0)
		{
			$result_Array_Age_gender = $cust_id_array_age;
		}
		else if(count($cust_id_array_gender)>0)
		{
			$result_Array_Age_gender = $cust_id_array_gender;
		}
		else
		{
			$result_Array_Age_gender = array();
		}
		
		$timezone_condition ="";
		$timezone_param_cnt=0;

		if(isset($_REQUEST['opttimezone']))
		{
			foreach($_REQUEST['opttimezone'] as $optimezone)
			{
				if($optimezone==1)
				{
					
					if($timezone_param_cnt>0)
					{
						$timezone_condition.=' or (day_timezone_id=1) ';
					}	
					else
					{
						$timezone_condition.=' (day_timezone_id=1) ';
					}
					$timezone_param_cnt++;
				}
				if($optimezone==2)
				{
					
					if($timezone_param_cnt>0)
					{
						$timezone_condition.=' or (day_timezone_id=2) ';
					}	
					else
					{
						$timezone_condition.=' (day_timezone_id=2) ';
					}
					$timezone_param_cnt++;
				}
				if($optimezone==3)
				{
					
					if($timezone_param_cnt>0)
					{
						$timezone_condition.=' or (day_timezone_id=3) ';
					}	
					else
					{
						$timezone_condition.=' (day_timezone_id=3) ';
					}
					$timezone_param_cnt++;
				}
				if($optimezone==4)
				{
					
					if($timezone_param_cnt>0)
					{
						$timezone_condition.=' or (day_timezone_id=4) ';
					}	
					else
					{
						$timezone_condition.=' (day_timezone_id=4) ';
					}
					$timezone_param_cnt++;
				}
			}				
			$timezone_condition=" and (".$timezone_condition.") ";
		}
		
		//echo $timezone_condition."<br/>";
		
		$location_condition ="";
		$location_param_cnt=0;

		if($optvisitedfor_location=="Campaigns")
		{
			if(isset($_REQUEST['optlocation']))
			{
				foreach($_REQUEST['optlocation'] as $optlocation)
				{
					if($location_param_cnt>0)
					{
						$location_condition.=' or (cr.location_id = '.$optlocation.' ) ';
					}	
					else
					{
						$location_condition.=' (cr.location_id = '.$optlocation.' ) ';
					}
					$location_param_cnt++;
				}
				$location_condition=" and (".$location_condition.") ";
			}
			
			//echo $location_condition."<br/>";
			
			$rating_condition = "";
			if($optrated!="")
				$rating_condition = " and rating ".$optratedlocation." ".$optrated;
				
			$revenue_condition = "";
			if($optrevenue!="")
				$revenue_condition =" and redeem_value ".$optamountspent." ".$optrevenue;
		}
		else
		{
			if(isset($_REQUEST['optlocation']))
			{
				foreach($_REQUEST['optlocation'] as $optlocation)
				{
					if($location_param_cnt>0)
					{
						$location_condition.=' or (clct.location_id = '.$optlocation.' ) ';
					}	
					else
					{
						$location_condition.=' (clct.location_id = '.$optlocation.' ) ';
					}
					$location_param_cnt++;
				}
				$location_condition=" and (".$location_condition.") ";
			}
			
			//echo $location_condition."<br/>";
				
			$revenue_condition = "";
			if($optrevenue!="")
				$revenue_condition =" and revenue ".$optamountspent." ".$optrevenue;
		}
		if($optvisitedfor_location!="" && $optvisitedfrom!="" && $optvisitedto!="")	
		{
			if($optvisitedfor_location=="Campaigns")
			{
				if(count($result_Array_Age_gender)>0)
				{
					$result_Array_Age_gender_str = implode(",",$result_Array_Age_gender);
					$sql="SELECT distinct cu.id 'cust_id'
							FROM customer_user cu,customer_campaigns cc,campaign_redeem cr,review_rating rr 
							where (cc.customer_id=cu.id and cr.customer_campaign_id=cc.id and rr.campaign_redeem_id=cr.id) 
							and (date_format(cr.redeem_date,'%Y-%m-%d') between '".$optvisitedfrom."' and '".$optvisitedto."') 
							and cu.id in (".$result_Array_Age_gender_str.") "
							 .$location_condition.$timezone_condition.$rating_condition.$revenue_condition ;
							
							
					//echo $sql;
					$RS = $objDB->Conn->Execute($sql);
					
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							array_push($cust_id_array_final, $Row['cust_id']);	
						}
						
					}
				}
				else
				{
					$sql="SELECT distinct cu.id 'cust_id'
							FROM customer_user cu,customer_campaigns cc,campaign_redeem cr,review_rating rr 
							where (cc.customer_id=cu.id and cr.customer_campaign_id=cc.id and rr.campaign_redeem_id=cr.id) 
							and (date_format(cr.redeem_date,'%Y-%m-%d') between '".$optvisitedfrom."' and '".$optvisitedto."') "
							 .$location_condition.$timezone_condition.$rating_condition.$revenue_condition ;
							
					//echo $sql;
					$RS = $objDB->Conn->Execute($sql);
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							array_push($cust_id_array_final, $Row['cust_id']);	
						}
						
					}
				}
			}
			else if($optvisitedfor_location=="Loyalty Card")
			{
				if(count($result_Array_Age_gender)>0)
				{
					$result_Array_Age_gender_str = implode(",",$result_Array_Age_gender);
					/*
					$sql="SELECT distinct cu.id 'cust_id'
							FROM customer_user cu,customer_campaigns cc,campaign_redeem cr,review_rating rr 
							where (cc.customer_id=cu.id and cr.customer_campaign_id=cc.id and rr.campaign_redeem_id=cr.id) 
							and (date_format(cr.redeem_date,'%Y-%m-%d') between '".$optvisitedfrom."' and '".$optvisitedto."') 
							and cu.id in (".$result_Array_Age_gender_str.") "
							 .$location_condition.$timezone_condition.$rating_condition.$revenue_condition ;
					*/		 
					$sql="SELECT distinct cu.id 'cust_id'
							FROM customer_user cu,customer_loyalty_reward_card clrc,customer_loyalty_card_transaction clct
							where (clrc.user_id=cu.id and clct.user_card_id=clrc.id)  
							and (date_format(clct.transaction_date,'%Y-%m-%d') between '".$optvisitedfrom."' and '".$optvisitedto."') 
							and cu.id in (".$result_Array_Age_gender_str.") "		
							 .$location_condition.$timezone_condition.$revenue_condition ;
							 
					//echo $sql;
					$RS = $objDB->Conn->Execute($sql);
					
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							array_push($cust_id_array_final, $Row['cust_id']);	
						}
						
					}
				}
				else
				{
					/*
					$sql="SELECT distinct cu.id 'cust_id'
							FROM customer_user cu,customer_campaigns cc,campaign_redeem cr,review_rating rr 
							where (cc.customer_id=cu.id and cr.customer_campaign_id=cc.id and rr.campaign_redeem_id=cr.id) 
							and (date_format(cr.redeem_date,'%Y-%m-%d') between '".$optvisitedfrom."' and '".$optvisitedto."') "
							 .$location_condition.$timezone_condition.$rating_condition.$revenue_condition ;
					*/ 
					$sql="SELECT distinct cu.id 'cust_id'
							FROM customer_user cu,customer_loyalty_reward_card clrc,customer_loyalty_card_transaction clct
							where (clrc.user_id=cu.id and clct.user_card_id=clrc.id)  
							and (date_format(clct.transaction_date,'%Y-%m-%d') between '".$optvisitedfrom."' and '".$optvisitedto."') "		
							 .$location_condition.$timezone_condition.$revenue_condition ;	
					//echo $sql;
					$RS = $objDB->Conn->Execute($sql);
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							array_push($cust_id_array_final, $Row['cust_id']);	
						}
						
					}
				}
			}
		}
		/*
		echo "<pre>";
		print_r($cust_id_array_final);
		echo "</pre>";	
		*/
		
		if(count($cust_id_array_final)>0)
		{
			$distribution_list_name=$_REQUEST['group_name'];
		
			$clone_group = array();
			$clone_group['group_name'] = $distribution_list_name;
			$clone_group['merchant_id'] = $_SESSION['merchant_id'];
			$clone_group['active'] = 1;
			$clone_group['is_segmented'] = 1;
			$inserted_grop_id = $objDBWrt->Insert($clone_group, "merchant_customerlist");
			
			if(count($cust_id_array_final)>0)
			{
				foreach($cust_id_array_final as $user_id)
				{
					$RS_ms = $objDB->Conn->Execute("SELECT * FROM merchant_customerlist_detail mcd,merchant_customerlist mc WHERE mc.id= mcd.merchant_group_id and mc.merchant_id=? AND mcd.customer_id=? AND mc.id=?",array($_SESSION['merchant_id'],$user_id,$inserted_grop_id));
											
					if($RS_ms->RecordCount()<=0)
					{
						$objDBWrt->Conn->Execute("INSERT INTO merchant_customerlist_detail SET customer_id=?,merchant_group_id=?",array($user_id,$inserted_grop_id));
					}
				}
			}
		}
		
	}
	else if($_REQUEST['seg_query']=="social")
	{
		if(isset($_REQUEST['optsharedcampaigns']))
			$optsharedcampaigns = $_REQUEST['optsharedcampaigns'];
		if(isset($_REQUEST['optsharedcampaignsvalue']))
			$optsharedcampaignsvalue = $_REQUEST['optsharedcampaignsvalue'];
			
		$optsharedfrom=$_REQUEST['optsharedfrom'];
		$optsharedto=$_REQUEST['optsharedto'];
		$cust_id_array_final = array();
		
		
	    $cust_id_array_age= array();
          
		$age_condition ="";
		$age_param_cnt=0;
	
		if(isset($_REQUEST['optage_social']))
		{
			foreach($_REQUEST['optage_social'] as $optage)
			{
				if($optage==1)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) <=17)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) <=17)';
					}
					$age_param_cnt++;
				}
				if($optage==2)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=18 and (YEAR(CURDATE())-dob_year) <=24)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=18 and (YEAR(CURDATE())-dob_year) <=24)';
					}
					$age_param_cnt++;
				}
				if($optage==3)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=25 and (YEAR(CURDATE())-dob_year) <=44)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=25 and (YEAR(CURDATE())-dob_year) <=44)';
					}
					$age_param_cnt++;
				}
				if($optage==4)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=45 and (YEAR(CURDATE())-dob_year) <=54)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=45 and (YEAR(CURDATE())-dob_year) <=54)';
					}
					$age_param_cnt++;
				}
				if($optage==5)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=55 and (YEAR(CURDATE())-dob_year) <=64)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=55 and (YEAR(CURDATE())-dob_year) <=64)';
					}
					$age_param_cnt++;
				}
				if($optage==6)
				{
					
					if($age_param_cnt>0)
					{
						$age_condition.=' or ((YEAR(CURDATE())-dob_year) >=65)';
					}	
					else
					{
						$age_condition.=' ((YEAR(CURDATE())-dob_year) >=65)';
					}
					$age_param_cnt++;
				}
				
			}
			//echo $age_condition;
			$sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$age_condition;
			//echo $sql;
			$RS = $objDB->Conn->Execute($sql);
			if($RS->RecordCount()>0)
			{
				while($Row = $RS->FetchRow())
				{
					array_push($cust_id_array_age, $Row['cust_id']);	
				}
				/*
				echo "<pre>";
				print_r($cust_id_array_age);
				echo "</pre>";
				*/
			}
			
		}
		
		$cust_id_array_gender = array();
		
		$gender_condition ="";
		$gender_param_cnt=0;
		
		if(isset($_REQUEST['optgender_social']))
		{
			foreach($_REQUEST['optgender_social'] as $optgender)
			{
				if($optgender=='Male')
				{
					
					if($gender_param_cnt>0)
					{
						$gender_condition.=' or (gender="1")';
					}	
					else
					{
						$gender_condition.=' (gender="1")';
					}
					$gender_param_cnt++;
				}
				if($optgender=='Female')
				{
					
					if($gender_param_cnt>0)
					{
						$gender_condition.=' or (gender="2")';
					}	
					else
					{
						$gender_condition.=' (gender="2")';
					}
					$gender_param_cnt++;
				}
				if($optgender=='Unknown')
				{
					
					if($gender_param_cnt>0)
					{
						$gender_condition.=' or (gender="")';
					}	
					else
					{
						$gender_condition.=' (gender="")';
					}
					$gender_param_cnt++;
				}
			}
			//echo $gender_condition;
			//echo $sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$gender_condition;
			//echo $sql;
			
			if(count($cust_id_array_age)>0)
			{
				$cust_id_str = implode(",",$cust_id_array_age);
				$sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$gender_condition." and cu.id in (".$cust_id_str.")";
			}
			else
			{
				$sql="SELECT cu.id 'cust_id' FROM customer_user cu where ".$gender_condition;
			}
			
			$RS = $objDB->Conn->Execute($sql);
			if($RS->RecordCount()>0)
			{
				while($Row = $RS->FetchRow())
				{
					//if(in_array($Row['cust_id'], $cust_id_array))
					//{
					//}
					//else
					//{
						array_push($cust_id_array_gender, $Row['cust_id']);	
					//}
				}
				/*
				echo "<pre>";
				print_r($cust_id_array_gender);
				echo "</pre>";	
				*/ 
			}
		}
		/*
		echo "<pre>";
		print_r($cust_id_array_age);
		echo "</pre>";
		echo "<pre>";
		print_r($cust_id_array_gender);
		echo "</pre>";
		*/
		if(count($cust_id_array_age)>0 && count($cust_id_array_gender)>0)
		{
			$result_Array_Age_gender = array_values(array_intersect($cust_id_array_age, $cust_id_array_gender));
		}
		else if(count($cust_id_array_age)>0)
		{
			$result_Array_Age_gender = $cust_id_array_age;
		}
		else if(count($cust_id_array_gender)>0)
		{
			$result_Array_Age_gender = $cust_id_array_gender;
		}
		else
		{
			$result_Array_Age_gender = array();
		}
		/*
		echo "<pre>";
		print_r($result_Array_Age_gender);
		echo "</pre>";
		*/
		$medium_condition ="";
		$medium_param_cnt=0;
		
		$cust_medium_array = array();
	
		if(isset($_REQUEST['optmedium']))
		{
			foreach($_REQUEST['optmedium'] as $optmedium)
			{
				if($optmedium==1)
				{
					
					if($medium_param_cnt>0)
					{
						$medium_condition.=' or (sc.campaign_share_medium=1)';
					}	
					else
					{
						$medium_condition.=' (sc.campaign_share_medium=1)';
					}
					$medium_param_cnt++;
				}
				if($optmedium==2)
				{
					
					if($medium_param_cnt>0)
					{
						$medium_condition.=' or (sc.campaign_share_medium=2)';
					}	
					else
					{
						$medium_condition.=' (sc.campaign_share_medium=2)';
					}
					$medium_param_cnt++;
				}
				if($optmedium==3)
				{
					
					if($medium_param_cnt>0)
					{
						$medium_condition.=' or (sc.campaign_share_medium=3)';
					}	
					else
					{
						$medium_condition.=' (sc.campaign_share_medium=3)';
					}
					$medium_param_cnt++;
				}
				if($optmedium==4)
				{
					
					if($medium_param_cnt>0)
					{
						$medium_condition.=' or (sc.campaign_share_medium=4)';
					}	
					else
					{
						$medium_condition.=' (sc.campaign_share_medium=4)';
					}
					$medium_param_cnt++;
				}
				if($optmedium==5)
				{
					
					if($medium_param_cnt>0)
					{
						$medium_condition.=' or (sc.campaign_share_medium=5)';
					}	
					else
					{
						$medium_condition.=' (sc.campaign_share_medium=5)';
					}
					$medium_param_cnt++;
				}
				if($optmedium==6)
				{
					
					if($medium_param_cnt>0)
					{
						$medium_condition.=' or (sc.campaign_share_medium=6)';
					}	
					else
					{
						$medium_condition.=' (sc.campaign_share_medium=6)';
					}
					$medium_param_cnt++;
				}
				
			}
			//echo $medium_condition;
			
			if($optsharedfrom!="" && $optsharedto!="") 	
			{
				if($optsharedcampaignsvalue!="")
				{
					$sql="SELECT distinct sc.customer_id 'cust_id' 
							FROM share_counter sc 
							where (date_format(sc.timestamp,'%Y-%m-%d') between '".$optsharedfrom."' and '".$optsharedto."') 
							and ".$medium_condition." 
							group by sc.customer_id 
							having count(*) ".$optsharedcampaigns." ".$optsharedcampaignsvalue;
					//echo $sql;
					$RS = $objDB->Conn->Execute($sql);
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							array_push($cust_medium_array, $Row['cust_id']);	
						}
						/*
						echo "<pre>";
						print_r($cust_medium_array);
						echo "</pre>";
						*/
					}
				}
				else
				{
					$sql="SELECT distinct sc.customer_id 'cust_id' 
							FROM share_counter sc 
							where (date_format(sc.timestamp,'%Y-%m-%d') between '".$optsharedfrom."' and '".$optsharedto."') 
							and ".$medium_condition;
					//echo $sql;
					$RS = $objDB->Conn->Execute($sql);
					if($RS->RecordCount()>0)
					{
						while($Row = $RS->FetchRow())
						{
							array_push($cust_medium_array, $Row['cust_id']);	
						}
						/*
						echo "<pre>";
						print_r($cust_medium_array);
						echo "</pre>";
						*/
					}
				}
			}	
		}
		
		$result_Array_Age_gender_meduim = array();
		if(count($result_Array_Age_gender)>0 && count($cust_medium_array)>0)
		{
			$result_Array_Age_gender_meduim = array_values(array_intersect($result_Array_Age_gender, $cust_medium_array));
		}
		else if(count($result_Array_Age_gender)>0)
		{
			$result_Array_Age_gender_meduim = $result_Array_Age_gender;
		}
		else if(count($cust_medium_array)>0)
		{
			$result_Array_Age_gender_meduim = $cust_medium_array;
		}
		else
		{
			$result_Array_Age_gender_meduim = array();
		}
		
		/*
		echo "<pre>";
		print_r($result_Array_Age_gender_meduim);
		echo "</pre>";	
		*/
		
		if(count($result_Array_Age_gender_meduim)>0)
		{
			$distribution_list_name=$_REQUEST['group_name'];
		
			$clone_group = array();
			$clone_group['group_name'] = $distribution_list_name;
			$clone_group['merchant_id'] = $_SESSION['merchant_id'];
			$clone_group['active'] = 1;
			$clone_group['is_segmented'] = 1;
			$inserted_grop_id = $objDBWrt->Insert($clone_group, "merchant_customerlist");
			
			if(count($result_Array_Age_gender_meduim)>0)
			{
				foreach($result_Array_Age_gender_meduim as $user_id)
				{
					$RS_ms = $objDB->Conn->Execute("SELECT * FROM merchant_customerlist_detail mcd,merchant_customerlist mc WHERE mc.id= mcd.merchant_group_id and mc.merchant_id=? AND mcd.customer_id=? AND mc.id=?",array($_SESSION['merchant_id'],$user_id,$inserted_grop_id));
											
					if($RS_ms->RecordCount()<=0)
					{
						$objDBWrt->Conn->Execute("INSERT INTO merchant_customerlist_detail SET customer_id=?,merchant_group_id=?",array($user_id,$inserted_grop_id));
					}
				}
			}
		}
		
		
	}
	header("Location:".WEB_PATH."/merchant/manage-customers.php");
}

//for group activate and decativate
/******** 
@USE : Activate / Deactivate the distreibution list
@PARAMETER : Distribution list id
@RETURN :
@USED IN PAGES : manage-customers.php
*********/
if(isset($_REQUEST['btnActivateDeactivateGroup']))
{
    $array = array();
    $where_clause = array();
    if($_REQUEST['action']==1)
    {
        $array['active'] =1 ;
    }
    else {
           $array['active'] =0 ;
    }
    $where_clause['id']=$_REQUEST['id'];
    $objDBWrt->Update($array, "merchant_customerlist", $where_clause);
    
    //header("Location:".WEB_PATH."/merchant/manage-customers.php");
	echo 1;
}
//for group activate and decativate

if(isset($_REQUEST['btnActivateDeactivateLocation']))
{
    $array = array();
    $where_clause = array();
    if($_REQUEST['action']==1)
    {
        $array['active'] =1 ;
    }
    else {
           $array['active'] =0 ;
           $array['qrcode_id'] =0 ;
    }
    $where_clause['id']=$_REQUEST['id'];
    $objDBWrt->Update($array, "locations", $where_clause);
    
	echo 1;
    //header("Location:".WEB_PATH."/merchant/locations.php");
}
// edit group(distributionlist)
if(isset($_REQUEST['edit_distribution_list']))
{
    $array = array();
    $where_clause = array();
    //$array['location_id'] = $_REQUEST['location_name'] ;
    $where_clause['id']=$_REQUEST['group_id'];
    $objDBWrt->Update($array, "merchant_customerlist", $where_clause);
    $success_count = 0;
    $duplicate_counter = 0;
    $merchant_id =  $_SESSION['merchant_id'];
        /*$Sql = "SELECT * from merchant_user WHERE id='$merchant_id'";
        $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT * from merchant_user WHERE id=?",array($merchant_id));
        if($RS->RecordCount()>0){
             $Row = $RS->FetchRow();
        }
		$mechant_business = $Row['business'];
		$business_icon = ASSETS_IMG."/m/icon/".$Row['merchant_icon'];
        echo $mechant_nm = $Row['firstname'];
        echo $mechant_lnm = $Row['lastname'];

     $dirname = $mechant_nm."_".$merchant_id;    
    $filename = ("upload/" . "$dirname" . "/");
  
    if (file_exists($filename)) {        
    } else {
        mkdir("upload/" . "$dirname", 0777);        
    }
    $image_folder = "upload/".$dirname."/";
    $uploaded = false;
    /*$Sql = "SELECT * FROM merchant_subscribs WHERE merchant_id='$_SESSION[merchant_id]' AND group_id=".$_REQUEST['group_id'];

$RS_clone_users = $objDB->Conn->Execute($Sql);*/
	
	//$RS_clone_users = $objDB->Conn->Execute("SELECT * FROM merchant_subscribs WHERE merchant_id=? AND group_id=?",array($_SESSION[merchant_id],$_REQUEST['group_id']));
	
	$RS_clone_users = $objDB->Conn->Execute("SELECT * FROM merchant_customerlist_detail mcd,merchant_customerlist mc WHERE mc.id= mcd.merchant_group_id and mc.merchant_id=? AND mc.id=?",array($_SESSION[merchant_id],$_REQUEST['group_id']));
	
        if($RS_clone_users->RecordCount()>0){
            while($Row_u=$RS_clone_users->FetchRow())
            {
                /*$Sql_check = "SELECT * FROM merchant_subscribs WHERE merchant_id='$_SESSION[merchant_id]' AND user_id=".$Row_u['user_id']." AND group_id=".$_REQUEST['group_id'];
                $RS_users_check = $objDB->Conn->Execute($Sql_check);*/
		
				//$RS_users_check = $objDB->Conn->Execute("SELECT * FROM merchant_subscribs WHERE merchant_id=? AND user_id=? AND group_id=?",array($_SESSION[merchant_id],$Row_u['user_id'],$_REQUEST['group_id']));
				
				$RS_users_check = $objDB->Conn->Execute("SELECT * FROM merchant_customerlist_detail mcd,merchant_customerlist mc WHERE mc.id= mcd.merchant_group_id and mc.merchant_id=? AND mcd.customer_id=? AND mc.id=?",array($_SESSION['merchant_id'],$Row_u['user_id'],$_REQUEST['group_id']));
               
				if($RS_users_check->RecordCount()<=0)
				{
				   /*$Sql = "INSERT INTO merchant_subscribs SET merchant_id='$_SESSION[merchant_id]', user_id=".$Row_u['user_id'].",group_id=".$_REQUEST['group_id'];
					$objDB->Conn->Execute($Sql);*/
					
					//$objDBWrt->Conn->Execute("INSERT INTO merchant_subscribs SET merchant_id=?, user_id=?,group_id=".$_REQUEST['group_id'],array($_SESSION[merchant_id],$Row_u['user_id']));
					
					$objDBWrt->Conn->Execute("INSERT INTO merchant_customerlist_detail SET customer_id=?,merchant_group_id=?",array($Row_u['user_id'],$_REQUEST['group_id']));

				}
            }
        }
       if( $_REQUEST['hdn_csvfile']!=""){
	//if($_FILES['userImport']['error'] == 0 ){
//$up = move_uploaded_file($_FILES['userImport']['tmp_name'], $image_folder.$_FILES['userImport']['name']);
    if(1){
    //if($up){

        $uploaded = true;
        $userimp = $_REQUEST['hdn_csvfile']; //"upload/".$dirname."/".$_FILES["userImport"]["name"];       
        $userimp = addslashes($userimp);
        $handle = fopen($userimp, "r");        
            if($handle)
            {
		        $stack=array();
			
                for($i =1;($data = fgetcsv($handle, 10000, ",")) !== FALSE; $i++)
                {
		
                    if($i==1 )
                    continue;
                    
                    /*$Sql_s = "SELECT * from customer_user WHERE emailaddress='".trim($data['6'])."'";
                    $RS_u = $objDB->Conn->Execute($Sql_s);*/
			$RS_u = $objDB->Conn->Execute("SELECT * from customer_user WHERE emailaddress=?",array(trim($data['6'])));

                       if($RS_u->RecordCount()>0)
					   {
																				
                          $success_count = $success_count +1;
                       // echo "this user is already inserted";
			// --- For data entry in merchant_subscribe
			$user_id = $RS_u->fields['id'];
			$user_email = $RS_u->fields['emailaddress'];
				/*$Sql = "SELECT * FROM merchant_subscribs WHERE merchant_id='$_SESSION[merchant_id]' AND user_id='$user_id' AND group_id=".$_REQUEST['group_id'];
				$RS_ms = $objDB->Conn->Execute($Sql);*/
				
				//$RS_ms = $objDB->Conn->Execute("SELECT * FROM merchant_subscribs WHERE merchant_id=? AND user_id=? AND group_id=?",array($_SESSION[merchant_id],$user_id,$_REQUEST['group_id']));

				$RS_ms = $objDB->Conn->Execute("SELECT * FROM merchant_customerlist_detail mcd,merchant_customerlist mc WHERE mc.id= mcd.merchant_group_id and mc.merchant_id=? AND mcd.customer_id=? AND mc.id=?",array($_SESSION['merchant_id'],$user_id,$_REQUEST['group_id']));
				
				if($RS_ms->RecordCount()<=0){
				  
					
					/*$Sql = "INSERT INTO merchant_subscribs SET merchant_id='$_SESSION[merchant_id]', user_id='$user_id',group_id=".$_REQUEST['group_id'];
					$objDB->Conn->Execute($Sql);*/
					
					//$objDBWrt->Conn->Execute("INSERT INTO merchant_subscribs SET merchant_id=?, user_id=?,group_id=?",array($_SESSION[merchant_id],$user_id,$_REQUEST['group_id']));
					
					$objDBWrt->Conn->Execute("INSERT INTO merchant_customerlist_detail SET customer_id=?,merchant_group_id=?",array($user_id,$_REQUEST['group_id']));
					
				}
                                else{
                                    $duplicate_counter = $duplicate_counter + 1;
                                }
                                /* CHECK WHETHER USER ASUBSCRIBE INTO STORE OR NOT */
                                //$Sql = "select * from subscribe"
//                                 $sql_chk ="select * from subscribed_stores where customer_id= ".$user_id." and location_id=". $lid;
//                                 echo $sql_chk.'======<br />';
//                          $subscibed_store_rs =$objDB->Conn->Execute($sql_chk);
//                          if($subscibed_store_rs->RecordCount()==0)
//                          {
//                              echo "1======";
//                               $insert_subscribed_store_sql ="insert into subscribed_stores set customer_id= ".$user_id." ,location_id=".$lid." ,subscribed_date='".date('Y-m-d H:i:s')."' ,subscribed_status=1";
//                                echo $insert_subscribed_store_sql;
//                                $objDB->Conn->Execute($insert_subscribed_store_sql);
//                          }
                                /* CHECK WHETHER USER ASUBSCRIBE INTO STORE OR NOT */
			// ---
							$array_cust_invite = array();
							$array_cust_invite['customer_id'] = $user_id;
							$array_cust_invite['merchant_id'] = $_SESSION['merchant_id'];
							$RS_cust_invite = $objDB->Show("customer_invite_counter",$array_cust_invite);
							if($RS_cust_invite->RecordCount()>0)
							{
							}
							else
							{
								$array_ci = array();
								$array_ci['customer_id'] = $user_id;
								$array_ci['merchant_id'] = $_SESSION['merchant_id'];
								$array_ci['invite_counter'] = 0;
								$objDBWrt->Insert($array_ci, "customer_invite_counter");	
							}
						
                    }
					else
                    {
					$PasswordLib = new \PasswordLib\PasswordLib;
                    $password = $data['0']."123";
		    // This is for gender...
		    if($data['5'] == "Male") $gender = 1; else $gender = 2;
                  //  $Sql = "INSERT INTO customer_user SET firstname='".$data['0']."', lastname='".$data['1']."', dob_year='".$data['2']."', dob_month='".$data['3']."', 
			//			dob_day='".$data['4']."', gender=".$gender.", emailaddress='".$data['6']."', password='".md5($password)."', emailnotification=".$data['7'].", registered_date='".$data['8']."', lastvisit_date='".$data['9']."', active=".$data['10'].", ruserid=".$data['11'].", current_location='".$data['12']."'";
			       $user_id = 0; 
				if(email_test(trim($data['6'])))		 
                                    {
                                    $success_count =$success_count +1;
                               //     echo trim($data['0'])."===".trim($data['1'])."===".trim($data['2'])."===".trim($data['3'])."===".trim($data['4'])."===".trim($data['5'])."===".trim($data['6'])."--<br/>";
				// if (filter_var(trim($data['6']), FILTER_VALIDATE_EMAIL)) {
				 
				     //$Sql = "INSERT INTO customer_user SET firstname='".$data['0']."', lastname='".$data['1']."', dob_year='".$data['2']."', dob_month='".$data['3']."', 
						//dob_day='".$data['4']."', gender=".$gender.", emailaddress='".$data['6']."', password='".md5($password)."', registered_date=Now() ,active='1' ";
					/*$Sql = "INSERT INTO customer_user SET firstname='".$data['0']."', lastname='".$data['1']."', dob_year='".$data['2']."', dob_month='".$data['3']."', 
						dob_day='".$data['4']."', gender=".$gender.", emailaddress='".trim($data['6'])."', registered_date=Now(),is_registered='0' ";
						
					$objDB->Conn->Execute($Sql);*/
					$objDBWrt->Conn->Execute("INSERT INTO customer_user SET firstname=?, lastname=?, dob_year=?, dob_month=?, dob_day=?, gender=?, emailaddress=?, registered_date=?,is_registered=? ",array($data['0'],$data['1'],$data['2'],$data['3'],$data['4'],$gender,trim($data['6'],'Now()',0)));

					// --- For data entry in merchant_subscribe
					 $user_id = $objDB->Conn->Insert_ID();
					/*$Sql = "INSERT INTO merchant_subscribs SET merchant_id='$_SESSION[merchant_id]', user_id='$user_id',group_id='$inserted_grop_id'";
					$objDB->Conn->Execute($Sql);	*/
				
					//$objDBWrt->Conn->Execute("INSERT INTO merchant_subscribs SET merchant_id=?, user_id=?,group_id=?",array($_SESSION[merchant_id],$user_id,$inserted_grop_id));	
					
					$objDBWrt->Conn->Execute("INSERT INTO merchant_customerlist_detail SET customer_id=?,merchant_group_id=?",array($user_id,$_REQUEST['group_id']));

				 }
				 else
				 {
                                    // echo trim($data['0'])."===".trim($data['1'])."===".trim($data['2'])."===".trim($data['3'])."===".trim($data['4'])."===".trim($data['5'])."===".trim($data['6'])."---<br/>";
                                        if(trim($data['0'])=="" && trim($data['1'])=="" && trim($data['2'])=="" && trim($data['3'])=="" && trim($data['4'])=="" && trim($data['5'])=="" && trim($data['6'])=="")
                                        {

                                        }
                                        else{
                                          $list = array($data['0'],$data['1'],$data['2'],$data['3'],$data['4'],$data['5'],$data['6']);
                                              array_push($stack,$list);
                                        }
                                }
				 
				//echo $Sql."<hr>";
				//echo "<br /><hr><br />".$Sql."<br /><hr><br />";
				
                                
                                /* CHECK WHETHER USER ASUBSCRIBE INTO STORE OR NOT */
                                //$Sql = "select * from subscribe"
//                                 $sql_chk ="select * from subscribed_stores where customer_id= ".$user_id." and location_id=". $lid;
//                               
//                          $subscibed_store_rs =$objDB->Conn->Execute($sql_chk);
//                          if($subscibed_store_rs->RecordCount()==0)
//                          {
//                              
//                               $insert_subscribed_store_sql ="insert into subscribed_stores set customer_id= ".$user_id." ,location_id=".$lid." ,subscribed_date='".date('Y-m-d H:i:s')."' ,subscribed_status=1";
//                             
//                                $objDB->Conn->Execute($insert_subscribed_store_sql);
//                          }
                                /* CHECK WHETHER USER ASUBSCRIBE INTO STORE OR NOT */
                                
				// ---
											
							$array_cust_invite = array();
							$array_cust_invite['customer_id'] = $user_id;
							$array_cust_invite['merchant_id'] = $_SESSION['merchant_id'];
							$RS_cust_invite = $objDB->Show("customer_invite_counter",$array_cust_invite);
							if($RS_cust_invite->RecordCount()>0)
							{
							}
							else
							{
								$array_ci = array();
								$array_ci['customer_id'] = $user_id;
								$array_ci['merchant_id'] = $_SESSION['merchant_id'];
								$array_ci['invite_counter'] = 0;
								$objDBWrt->Insert($array_ci, "customer_invite_counter");	
							}
				
				
                    }          
                    //echo "<pre>"; print_r($data); echo "</pre>";exit;                    
                }
				if(count($stack) != 0)
				{
					 $fp = fopen('ProblemOfCSV'.$merchant_id.'.csv', 'w');
					 $list = array (array("firstname","lastname","dob_year","dob_month","dob_day","gender","emailaddress"));
					 foreach ($list as $fields) {
							fputcsv($fp, $fields);
					 }
					 foreach ($stack as $fields) {
							fputcsv($fp, $fields);
					 }
					 fclose($fp);		
				}
            }
	 
	 
        }
        
    }
	
   //  25 12 2014 delete file after insert records
			
	$dirname = $mechant_nm."_".$merchant_id;    
	$filename = ("upload/" . "$dirname" . "/");
	
	$userimp = $_REQUEST['hdn_csvfile'];// "upload/".$dirname."/".$_FILES["userImport"]["name"];       
	$userimp = addslashes($userimp);
	unlink($userimp);
	rmdir("upload/".$dirname); 
	
	//  25 12 2014 delete file after insert records
   
   if(count($stack) == 0)
   {
       $_SESSION['msg'] = $merchant_msg['distributionlist']['Msg_distlist_edited'];
	   header("Location:".WEB_PATH."/merchant/manage-customers.php");
   }
   else
   {
      $_SESSION['msg'] = "";
	  $value="1";
	   setcookie("csvfilecookie",$value);
             $_SESSION['dowload_err_msg'] = $success_count." records from the attach file were added successfully. ".(count($stack)+$duplicate_counter)." records of customers from attached file were not added due to missing, invalid or duplicate email address of customers. Please click here to download the affected records.";
	   header("Location:".WEB_PATH."/merchant/edit-distributionlist.php?id=".$_REQUEST['id']);
   }
    
}

//
if(isset($_REQUEST['getlocationwisegroup']))
{
$RS = $objDB->Conn->Execute("select l.*,l.location_name ,l.id lid, mg.*,(select count(*) as Cust_Total from merchant_subscribs mu where mu.group_id =mg.id and mu.user_id in (select id from customer_user cu where cu.active=1)) Total 
	        from merchant_groups mg , locations l 
	        where mg.isDeleted!=1 and l.id = mg.location_id and l.id =? and mg.active=?",array($_REQUEST['location_id'],1));
if($RS->RecordCount()>0)
{ echo "&nbsp;";
?><tr id="locationid_<?php echo $RS->fields['lid']; ?>">
				<td class="table_th_5">
					<img src="<?php echo ASSETS_IMG."/m/marker_rounded_grey.png" ?>"/>
				</td>
                <td class="table_th_34">
                    <?php //echo  $RS->fields['location_name']; ?>
                    <?php echo $RS->fields['address'].", ".$RS->fields['city'].", ".$RS->fields['state'].", ".$RS->fields['zip']?>&nbsp;:&nbsp;
                </td>
				<td >
					<input type="hidden" name="hdn_campaign_type_<?php echo $RS->fields['lid']; ?>" id="hdn_campaign_type_<?php echo $RS->fields['lid']; ?>" value="<?php if($_REQUEST['public'] == 1){echo "1";}else{echo "0";} ?>" />
                                        <input type="hidden" name="hdn_campaign_type1_<?php echo $RS->fields['lid']; ?>" id="hdn_campaign_type1_<?php echo $RS->fields['lid']; ?>" value="<?php if($_REQUEST['public'] == 1){echo "1";}else{echo "0";} ?>" />
                    <ul style="padding-left:0px;margin-top: 0px" id="locationgroup_<?php echo $RS->fields['lid']; ?>">
                        <?php
                        while($Row=$RS->FetchRow())
                        {
							if($Row['private']==1)
							{
							?>
							<li class="location_li">
								<input  type="checkbox" id="chk_location_groups_<?php echo $Row['id']; ?>" name="chk_location_groups[]" value="<?php echo $Row['id'] ;?>" <?php if($Row['private'] == 1){ echo  "class='private_group' private_group=private_group";}else{echo  "class='other_group'";} ?> <?php if($Row['private'] == 1 && $_REQUEST['public'] == 1){ echo "checked";} ?> >
                                                                    <?php //echo $Row['group_name']; ?>
                                                                Location Subscribers
							</li>		
							<?php
							}
							else if($Row['private']==0) 
							{
								 if($Row['Total']>0) // condition to other show dist list with customers > 0 
								 {
						?>
                            <li class="location_li">
								
								<input type="checkbox" id="chk_location_groups_<?php echo $Row['id']; ?>" name="chk_location_groups[]" value="<?php echo $Row['id'] ;?>" <?php if($Row['private'] == 1){ echo  "class='private_group' private_group=private_group";}else{echo  "class='other_group'";} ?> <?php if($Row['private'] == 1 && $_REQUEST['public'] == 1){ echo "checked";} ?> ><?php echo $Row['group_name']; ?>
                            </li>
                        <?php
								}
							}
						}
						?>
                    </ul>
					
                </td>
            </tr>	
    <?php
			
    }
}

if(isset($_REQUEST['getlocationwisegroup_submerchant']))
{
    /*$Sql = "select l.location_name ,l.id lid, mg.* from merchant_groups mg , locations l where l.id = mg.location_id and mg.merchant_id = ".$_SESSION['merchant_id']." and mg.location_id =". $_REQUEST['location_id'];
    $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("select l.location_name ,l.id lid, mg.* from merchant_groups mg , locations l where l.id = mg.location_id and mg.merchant_id =? and mg.location_id =?",array($_SESSION['merchant_id'],$_REQUEST['location_id']));

   if($RS->RecordCount()>0)
    {
       ?>
                    <ul style="padding-left:0px;margin-top: 0px">
                        <?php
                        while($Row=$RS->FetchRow())
                        { ?>
                            <li class="location_li" style="list-style:none;">
                                <input type="radio"  name="group" value="<?php echo $Row['id'] ;?>" <?php if($Row['private'] == 1){ echo  "private_group=private_group";} ?> <?php if($Row['private'] == 1 && $_REQUEST['public'] == 1){ echo "checked";} ?> ><?php echo $Row['group_name']; ?>
                            </li>
                        <?php } ?>
                    </ul>
       
    <?php
    }
}
// cancel method of group
if(isset($_REQUEST['btnCanDistributionlist']))
{
    header("Location:".WEB_PATH."/merchant/manage-customers.php");
}

// -- 5/12/2012
if(isset($_REQUEST['check_group_name_exist']))
{
    $val= $_REQUEST['group_name'];
    $location_name=$_REQUEST['location_name'];
    //echo substr($val, 0,7);
    // exit;
    $val_ = substr($val, 0,7);
    $merchant_array = array();
	$merchant_array['id'] = $_REQUEST['mer_id'];
	$merchant_info = $objDB->Show("merchant_user",$merchant_array);
        //echo $merchant_info->fields['merchant_parent']."=====";
    if($merchant_info->fields['merchant_parent'] == 0){
        $m_id = $_REQUEST['mer_id'];
    }
    else{
        $m_id = $merchant_info->fields['merchant_parent'];
    }
   
   $arr_ids=getallsubmercahnt_id($m_id);
    $ids=  implode(",", $arr_ids);
      if(count($arr_ids) == 0){
        $mer_sql = "(  merchant_id = ".$m_id." )";
    }
    else{
        $mer_sql = "( merchant_id in ( ".$ids.") or merchant_id = ".$m_id." )";
    }
     /*$Sql = "select * from merchant_groups where group_name='".$val."' and merchant_id = ".$_SESSION['merchant_id'];*/
    if($val_ == "private")
    {
        //$Sql = "select * from merchant_groups where isDeleted!=1 and group_name like='".$val_."%' and ".$mer_sql;
	$RS = $objDB->Conn->Execute("select * from merchant_customerlist where isDeleted!= ? and group_name like='?%' and ".$mer_sql,array(1,$val_));
    }
    else{
        //$Sql = "select * from merchant_groups where isDeleted!=1 and group_name ='".$val."'   and ".$mer_sql;
	$RS = $objDB->Conn->Execute("select * from merchant_customerlist where isDeleted!=? and group_name =?   and ".$mer_sql,array(1,$val));
    }
  
    //$RS = $objDB->Conn->Execute($Sql);
   if($RS->RecordCount()>0)
    {
  
       echo 0;
   }
 else {
  
       echo 1;
       
 }
  
}


/******** 
@USE : get location list for end campaign
@PARAMETER : location_id
@RETURN : location list
@USED IN PAGES : compaigns.php
@EXPLAINATION : Campaign location's which have offer left greater then 0
*********/
// --- 8/12/2012
if(isset($_REQUEST['endcampaign_popup']))
{
  $cid = $_REQUEST['campaign_id'];
	   /*$Sql = "SELECT * FROM locations l WHERE l.id IN (SELECT cl.location_id FROM campaign_location cl WHERE cl.campaign_id = ".$cid."  and cl.offers_left<>0 ) ";
	//   echo $Sql; 
    $RS_locations =  $objDB->execute_query($Sql);*/
	$RS_locations =  $objDB->Conn->Execute("SELECT * FROM locations l WHERE l.id IN (SELECT cl.location_id FROM campaign_location cl WHERE cl.campaign_id =?  and cl.offers_left<>? )",array($cid,0));

	  if($RS_locations->RecordCount() != 0){ ?>
       <div style="line-height:2;height:40px;width:100%;border-radius:4px 4px 4px 4px;background:#D5D5D5;font-size:18px;font-weight:bold;text-align:center">Pause Campaign</div>     
      <form action="process.php" id="campaign_to_paused">
      <input type="hidden" name="campaign_id" id="campaign_id"  value="<?php echo $cid; ?>" />
			<div style="max-height:450px;overflow-y:auto;">
			 <table style="font-size:16px;text-align: left;margin-top: 10px;">
			 <tr style="font-size: 0.8em;">
			
                         
		<?php	 while($Row = $RS_locations->FetchRow()){  $where_clause = array();
                $m_arr  = array();
                $m_arr['campaign_id']=$cid;
                $m_arr['location_id']=$Row['id'];
                 $RS_m_c = $objDB->Show("campaign_location", $m_arr);
                $max_coupon = $RS_m_c->fields['num_activation_code'];
				
				
                        /*$remain_sql="select count(*) as total from coupon_codes where customer_campaign_code =".$cid." AND location_id=".$Row['id']."";
                        
                        $RS_remain = $objDB->Conn->Execute($remain_sql);*/
			$RS_remain = $objDB->Conn->Execute("select count(*) as total from coupon_codes where customer_campaign_code =? AND location_id=?",array($cid,$Row['id']));

                        $remain_val = $RS_remain->fields['total'];
    
                        /*$r_sql = "SELECT * FROM `reward_user` where campaign_id = ".$cid." and coupon_code_id in (select id from coupon_codes where customer_campaign_code=".$cid." AND location_id =".$Row['id']." ) and referred_customer_id=0 group by campaign_id ,customer_id";
                         
                        $RS_redeem = $objDB->Conn->Execute($r_sql);*/
			$RS_redeem = $objDB->Conn->Execute("SELECT * FROM `reward_user` where campaign_id =? and coupon_code_id in (select id from coupon_codes where customer_campaign_code=? AND location_id =? ) and referred_customer_id=0 group by campaign_id ,customer_id",array($cid,$cid,$Row['id']));
                        $redeem_val = $RS_redeem->RecordCount();
                        
                        $remain_val =$remain_val-$redeem_val;
                                ?>
		       <tr style="font-size: 0.8em;">
               <td><input type="checkbox" name="location_id[]"  value="<?php echo $Row['id']; ?>" /></td>
               <td> <?=$Row['location_name']?></td>
			    <td>
                                <?php //echo $Row['location_name']?>
                                <?=$Row['address'].", ".$Row['city'].", ".$Row['state'].", ".$Row['zip']?>
                            </td>
			    
			   
			    
		      </tr>
                         
                         <?php } echo "</table>";?>
                      <br>
					   </table>
						 </div>
                         <div align="center"> <input type="button" name="btn_expirecampaign" id="btn_expirecampaign" value="Pause" />&nbsp;&nbsp;&nbsp;<input onclick="close_popup('expire')" type="button" name="btn_cancel" id="btn_cancel" value="Cancel" />
                         </div>
						
                         </form>
                         <?php
			 }
}


/******** 
@USE : End campaign for selected location
@PARAMETER : selected location id array
@RETURN : {Page refresh}
@USED IN PAGES : compaigns.php
@EXPLAINATION : end campaign means set offer left to zero of selected locations and  deduct all blocked point which are reserved with that location's offers.
This point  will deduct from blocked points of campaigns and  add this point in merchant's availbale points.
- If campaign is active and offer left is zero for all location of campaigns then campaign will not available longer and in this condition if campaign had a sharing point available 
then it will also add in to merchants available points and deduct point from blocked point of campaign.
- If no offer is reserved and redeem at particular location and end campaign at location then campaign will remove from that location
*********/
if(isset($_REQUEST['btn_expirecampaign']))
{
try{
  $objDB->Conn->StartTrans();
    $campaign_id=$_REQUEST['campaign_id'];
	$_REQUEST['location_id'] = explode(',',$_REQUEST['location_id']);
	if(isset($_REQUEST['location_id']))
		{
			foreach($_REQUEST['location_id'] as $location_id){
				$array_cl = array();
				$array_cl['campaign_id'] = $campaign_id;
				$array_cl['location_id'] = $location_id;
                                //echo $campaign_id." ".$location_id;
                                //exit();
                                //$remain_sql="select count(*) as total from coupon_codes where customer_campaign_code =".$cid." AND location_id=".$Row['id'];
                       /* $remain_sql="select count(*) as total from coupon_codes where customer_campaign_code =".$campaign_id." AND location_id=".$location_id;
                        
                        $RS_remain = $objDB->Conn->Execute($remain_sql);*/
			$RS_remain = $objDB->Conn->Execute("select count(*) as total from coupon_codes where customer_campaign_code =? AND location_id=?",array($campaign_id,$location_id));

                        $remain_val = $RS_remain->fields['total'];
                                
                                
                        	/*$act_code_sql = "Select  num_activation_code from campaign_location where campaign_id=".$_REQUEST['campaign_id']." and location_id=".$location_id;
                                $act_code_rs = $objDB->execute_query($act_code_sql);*/
				$act_code_rs = $objDB->Conn->Execute("Select  num_activation_code from campaign_location where campaign_id=? and location_id=?",array($_REQUEST['campaign_id'],$location_id));

                                $act_code = $act_code_rs->fields['num_activation_code'];
                                
                                $last_remaining_act = $act_code - $remain_val;
                                
                                /*$redeem_sql = "Select redeem_rewards,created_by,block_point,transaction_fees from campaigns where id=".$_REQUEST['campaign_id'];
                             //   echo $redeem_sql."<br />";
                                $redeem_rs = $objDB->execute_query($redeem_sql);*/
				$redeem_rs = $objDB->Conn->Execute("Select redeem_rewards,created_by,block_point,transaction_fees from campaigns where id=?",array($_REQUEST['campaign_id']));

                                $redeem_point = $redeem_rs->fields['redeem_rewards'];
                                $cut_price = ($last_remaining_act*$redeem_point) + ( $last_remaining_act * $redeem_rs->fields['transaction_fees']);
                               // echo $cut_price."==cut price<br />";
								//exit();
                                
                                /********************** Deduting point from campaigns and add into merchant's available pints *******************/
                                $avail_point =    $cut_price;
                     // echo "<br />".$avail_point."=====".$rc['created_by']."====".getmainmercahnt_id($rc['created_by'])."<br/>" ;
                      /*$user_avial_sql = "select available_point from merchant_user where id=".getmainmercahnt_id( $redeem_rs->fields['created_by']);
                       $rs_use_avail =$objDB->execute_query( $user_avial_sql);*/
			$created_by = getmainmercahnt_id( $redeem_rs->fields['created_by']);
                       $rs_use_avail =$objDB->Conn->Execute( "select available_point from merchant_user where id=?",array($created_by));

                      $a_p = $rs_use_avail->fields['available_point'];
                       $t_p = $a_p + $avail_point;
                       /*$u_sql ="Update merchant_user set available_point=".$t_p."  where id=".getmainmercahnt_id( $redeem_rs->fields['created_by']);
                 
                       $objDB->execute_query( $u_sql);*/
			$objDBWrt->Conn->Execute("Update merchant_user set available_point=?  where id=?",array($t_p,$created_by));

                       /*$c_u_sql ="Update campaigns set block_point=". ($redeem_rs->fields['block_point'] -  $cut_price)." where id=".$_REQUEST['campaign_id'];
                      $objDB->execute_query( $c_u_sql);*/
			$objDBWrt->Conn->Execute("Update campaigns set block_point=? where id=?",array(($redeem_rs->fields['block_point'] -  $cut_price),$_REQUEST['campaign_id']));

                   
                      /********************** Deduting point from campaigns and add into merchant's available pints *******************/
                      
                      /* start get offers left */
                      //$camp_loc_ol_sql = "select offers_left from campaign_location where campaign_id=".$_REQUEST['campaign_id']." and location_id=".$location_id;
                      /*$camp_loc_ol_sql = "select * from campaign_location where campaign_id=".$_REQUEST['campaign_id']." and location_id=".$location_id;
                       $camp_loc_ol_rs =$objDB->execute_query( $camp_loc_ol_sql);*/
			$camp_loc_ol_rs =$objDB->Conn->Execute("select * from campaign_location where campaign_id=? and location_id=?",array($_REQUEST['campaign_id'],$location_id));

                      $camp_loc_ol = $camp_loc_ol_rs->fields['offers_left'];
                      /* end get offers left */
                      
                                /*************************** For set num_activation_code to 0 ****************/
                               // $Sql = "update campaign_location set  num_activation_code=0 , active=0, active_in_future=0,offers_left=0 where campaign_id=".$_REQUEST['campaign_id']." and location_id=".$location_id;
                                
                             //   echo $Sql ;
                                /*************************** For set num_activation_code to 0 ****************/
                                
                                /*************************** For set offers_left to 0 ****************/
                      
                                // 4 3 2013
                                $array_where_camp2=array();
                                $array_where_camp2['campaign_id'] = $campaign_id;                           
                                $array_where_camp2['location_id'] = $location_id;
                                $RS_cust_camp = $objDB->Show("customer_campaigns", $array_where_camp2);
                                $reserved=$RS_cust_camp->RecordCount();
                                
                                $array_where_camp=array();
                                $array_where_camp['campaign_id'] = $campaign_id;
                                $array_where_camp['referred_customer_id'] = 0;
                                $array_where_camp['location_id'] = $location_id;
                                $RS_camp = $objDB->Show("reward_user", $array_where_camp);
                                $redeemed=$RS_camp->RecordCount();
                                //echo $reserved." ".$redeemed;
                                //exit();
                                if($reserved<=0 && $redeemed<=0 && ($camp_loc_ol_rs->fields['num_activation_code']==$camp_loc_ol_rs->fields['offers_left']))
                                {
                                    $array_where=array();
                                    $array_where['campaign_id'] = $campaign_id;
                                    $array_where['location_id'] = $location_id;
                                   $objDBWrt->Remove("campaign_location", $array_where);
									
								
                                }
                                else// 4 3 2013
                                {
                                /*$Sql = "update campaign_location set  num_activation_code=num_activation_code-".$camp_loc_ol." , offers_left=0 where campaign_id=".$_REQUEST['campaign_id']." and location_id=".$location_id;
                            
                                /*************************** For set offers_left to 0 ****************/
                                
                               /* $objDB->execute_query($Sql);*/
				$objDBWrt->Conn->Execute("update campaign_location set  num_activation_code=num_activation_code-".$camp_loc_ol." , offers_left=0 where campaign_id=? and location_id=?",array($_REQUEST['campaign_id'],$location_id));
                                }
                                
			}
			/*$sql= "select * from campaign_location where campaign_id= ".$_REQUEST['campaign_id'];
			$total_location = $objDB->execute_query($sql);*/
			$total_location = $objDB->Conn->Execute("select * from campaign_location where campaign_id=?",array($_REQUEST['campaign_id']));

			if($total_location->RecordCount() == 0)
			{
				/*$redeem_sql = "Select block_point,created_by from campaigns where id=".$_REQUEST['campaign_id'];
				$redeem_rs = $objDB->execute_query($redeem_sql);*/
				$redeem_rs = $objDB->Conn->Execute("Select block_point,created_by from campaigns where id=?",array($_REQUEST['campaign_id']));
				$available_points = $redeem_rs->fields['block_point'];
				/*$user_avial_sql = "select available_point from merchant_user where id=".getmainmercahnt_id( $redeem_rs->fields['created_by']);
				$rs_use_avail =$objDB->execute_query( $user_avial_sql);*/
				$created_by = getmainmercahnt_id( $redeem_rs->fields['created_by']);
				$rs_use_avail =$objDB->Conn->Execute("select available_point from merchant_user where id=?",array($created_by));

			   $a_p = $rs_use_avail->fields['available_point'];
			   $t_p = $a_p + $available_points;
			   /*$c_u_sql ="Update campaigns set block_point=0 where id=".$_REQUEST['campaign_id'];
			   $objDB->execute_query( $c_u_sql);*/
				$objDBWrt->Conn->Execute("Update campaigns set block_point=? where id=?",array(0,$_REQUEST['campaign_id']));

			  /* $u_sql ="Update merchant_user set available_point=".$t_p."  where id=".getmainmercahnt_id( $redeem_rs->fields['created_by']);
			   $objDB->execute_query( $u_sql);*/
			$objDBWrt->Conn->Execute("Update merchant_user set available_point=?  where id=?",array($t_p,$created_by));
		   }
		}
		  $objDB->Conn->CompleteTrans();
			echo "1";
		  }catch (Exception $e) {
    echo 'Caught exception: ',  $e->getMessage(), "\n";
}
              //  exit;
		//$_SESSION['msg'] = $merchant_msg["edit-compaign"]['Msg_campaign_pause_successfully'];
		//$_SESSION['inserted_id'] = $_REQUEST['campaign_id'];
		//$_SESSION['action'] = "pause";
		//header("Location:".WEB_PATH."/merchant/compaigns.php?action=active");
}

/******** 
@USE : get campaign detail of give campaign id
@PARAMETER : campaign id
@RETURN : campaign detail
@USED IN PAGES : compaigns.php
*********/
if(isset($_REQUEST['getCmapaigndetail_for_popup']))
{
   $timezoness =array(
    'Pacific/Wake' => '(GMT-12:00) International Date Line West',
    'Pacific/Apia' => '(GMT-11:00) Samoa',
    'Pacific/Honolulu' => '(GMT-10:00) Hawaii',
    'America/Anchorage' => '(GMT-09:00) Alaska',
    'America/Los_Angeles' => '(GMT-08:00) Pacific Time (US & Canada); Tijuana',
    'America/Phoenix' => '(GMT-07:00) Arizona',
    'America/Chihuahua' => '(GMT-07:00) Mazatlan',
    'America/Denver' => '(GMT-07:00) Mountain Time (US & Canada)',
    'America/Managua' => '(GMT-06:00) Central America',
    'America/Chicago' => '(GMT-06:00) Central Time (US & Canada)',
    'America/Mexico_City' => '(GMT-06:00) Monterrey',
    'America/Regina' => '(GMT-06:00) Saskatchewan',
    'America/Bogota' => '(GMT-05:00) Quito',
    'America/New_York' => '(GMT-05:00) Eastern Time (US & Canada)',
    'America/Indiana/Indianapolis' => '(GMT-05:00) Indiana (East)',
    'America/Halifax' => '(GMT-04:00) Atlantic Time (Canada)',
    'America/Caracas' => '(GMT-04:00) La Paz',
    'America/Santiago' => '(GMT-04:00) Santiago',
    'America/St_Johns' => '(GMT-03:30) Newfoundland',
    'America/Sao_Paulo' => '(GMT-03:00) Brasilia',
    'America/Argentina/Buenos_Aires' => '(GMT-03:00) Georgetown',
    'America/Godthab' => '(GMT-03:00) Greenland',
    'America/Noronha' => '(GMT-02:00) Mid-Atlantic',
    'Atlantic/Azores' => '(GMT-01:00) Azores',
    'Atlantic/Cape_Verde' => '(GMT-01:00) Cape Verde Is.',
    'Africa/Casablanca' => '(GMT) Monrovia',
    'Europe/London' => '(GMT) London',
    'Europe/Berlin' => '(GMT+01:00) Vienna',
    'Europe/Belgrade' => '(GMT+01:00) Prague',
    'Europe/Paris' => '(GMT+01:00) Paris',
    'Europe/Sarajevo' => '(GMT+01:00) Zagreb',
    'Africa/Lagos' => '(GMT+01:00) West Central Africa',
    'Europe/Istanbul' => '(GMT+02:00) Minsk',
    'Europe/Bucharest' => '(GMT+02:00) Bucharest',
    'Africa/Cairo' => '(GMT+02:00) Cairo',
    'Africa/Johannesburg' => '(GMT+02:00) Pretoria',
    'Europe/Helsinki' => '(GMT+02:00) Vilnius',
    'Asia/Jerusalem' => '(GMT+02:00) Jerusalem',
    'Asia/Baghdad' => '(GMT+03:00) Baghdad',
    'Asia/Riyadh' => '(GMT+03:00) Riyadh',
    'Europe/Moscow' => '(GMT+03:00) Volgograd',
    'Africa/Nairobi' => '(GMT+03:00) Nairobi',
    'Asia/Tehran' => '(GMT+03:30) Tehran',
    'Asia/Muscat' => '(GMT+04:00) Muscat',
    'Asia/Tbilisi' => '(GMT+04:00) Yerevan',
    'Asia/Kabul' => '(GMT+04:30) Kabul',
    'Asia/Yekaterinburg' => '(GMT+05:00) Ekaterinburg',
    'Asia/Karachi' => '(GMT+05:00) Tashkent',
    'Asia/Calcutta' => '(GMT+05:30) New Delhi',
    'Asia/Katmandu' => '(GMT+05:45) Kathmandu',
    'Asia/Novosibirsk' => '(GMT+06:00) Novosibirsk',
    'Asia/Dhaka' => '(GMT+06:00) Dhaka',
    'Asia/Colombo' => '(GMT+06:00) Sri Jayawardenepura',
    'Asia/Rangoon' => '(GMT+06:30) Rangoon',
    'Asia/Bangkok' => '(GMT+07:00) Jakarta',
    'Asia/Krasnoyarsk' => '(GMT+07:00) Krasnoyarsk',
    'Asia/Hong_Kong' => '(GMT+08:00) Urumqi',
    'Asia/Irkutsk' => '(GMT+08:00) Ulaan Bataar',
    'Asia/Singapore' => '(GMT+08:00) Singapore',
    'Australia/Perth' => '(GMT+08:00) Perth',
    'Asia/Taipei' => '(GMT+08:00) Taipei',
    'Asia/Tokyo' => '(GMT+09:00) Tokyo',
    'Asia/Seoul' => '(GMT+09:00) Seoul',
    'Asia/Yakutsk' => '(GMT+09:00) Yakutsk',
    'Australia/Adelaide' => '(GMT+09:30) Adelaide',
    'Australia/Darwin' => '(GMT+09:30) Darwin',
    'Australia/Brisbane' => '(GMT+10:00) Brisbane',
    'Australia/Sydney' => '(GMT+10:00) Sydney',
    'Pacific/Guam' => '(GMT+10:00) Port Moresby',
    'Australia/Hobart' => '(GMT+10:00) Hobart',
    'Asia/Vladivostok' => '(GMT+10:00) Vladivostok',
    'Asia/Magadan' => '(GMT+11:00) Solomon Is.',
    'Pacific/Auckland' => '(GMT+12:00) Wellington',
    'Pacific/Fiji' => '(GMT+12:00) Marshall Is.',
    'Pacific/Tongatapu' => '(GMT+13:00) Nuku\'alofa',
);
  
   $cid = $_REQUEST['campaign_id'];
    $c_array = array();
    $c_array['id']= $cid;
    $RS = $objDB->Show("campaigns", $c_array);
    
    /*$sql = "SELECT * FROM customer_user c, customer_campaigns cc WHERE cc.campaign_id = ".$cid." AND cc.activation_status= 1 AND c.id = cc.customer_id";
    $RS_campaigns_subscribe =  $objDB->execute_query($sql);*/
	$RS_campaigns_subscribe =  $objDB->Conn->Execute("SELECT * FROM customer_user c, customer_campaigns cc WHERE cc.campaign_id =? AND cc.activation_status= ? AND c.id = cc.customer_id",array($cid,1));
   
    /*$Sql = "SELECT * FROM locations l WHERE l.id IN (SELECT cl.location_id FROM campaign_location cl WHERE cl.campaign_id = ".$cid." ) ";
    $RS_locations =  $objDB->execute_query($Sql);*/
	$RS_locations =  $objDB->Conn->Execute("SELECT * FROM locations l WHERE l.id IN (SELECT cl.location_id FROM campaign_location cl WHERE cl.campaign_id = ? ) ",array($cid));

	/*$sql = "SELECT RU.*,  CU.firstname, CU.lastname, C.title
			FROM reward_user RU, campaigns C, customer_user CU
			WHERE RU.campaign_id=C.id AND RU.campaign_id=".$cid." AND CU.id=RU.customer_id ";
	$rewards =  $objDB->execute_query($sql);*/
	$rewards =  $objDB->Conn->Execute("SELECT RU.*,  CU.firstname, CU.lastname, C.title
			FROM reward_user RU, campaigns C, customer_user CU
			WHERE RU.campaign_id=C.id AND RU.campaign_id=? AND CU.id=RU.customer_id ",array($cid));

  ?>
			<div class="fancywidth">
            <div class='campaign_detail_heading'>Campaign Detail</div>
			<div class="mer_chant campaign_detail_mer_chant" >
			<div class="mer_chant_div" >
            <table width="100%">
			<tr>
			    <td colspan="2"  >
				<p><span>Campaign Title</span><span >&nbsp;:&nbsp;</span><span class="campaign_detail_name"><?=$RS->fields['title']?></span></p>
			    </td>
			
			</tr>

			<?php
			    $array = array();
			    $array['campaign_id'] = $cid;
			    $RSCode = $objDB->Show("activation_codes",$array);
			?>
			<tr>
			    <td colspan="2">
				<p><span>Activation Code</span><span>&nbsp;:&nbsp;</span><?=$RSCode->fields['activation_code']?></p>
			    </td>
			
			</tr>
                  
                        
                         
			                         
                          <?php
                  $array_where = array();
                  $array_where['id'] = $RS->fields['category_id'];
    $RS_user = $objDB->Show("categories", $array_where); ?>
			<tr>
			    <td >
				<p><span>Limit</span><span>&nbsp;:&nbsp;</span>
				<?php 
				if($RS->fields['number_of_use'] == 1) 
				{ 
				echo "One Per Customer";
				}
				else if($RS->fields['number_of_use'] == 2)
				{
				echo "One Per Customer Per Day";
				}
				else if($RS->fields['number_of_use'] == 3)
				{ 
				echo "Redeem Points Per Visit ";
				}
				if($RS->fields['new_customer'] == 1) 
				{ 
				echo ",Valid For New Customer Only";
				}
				?>
				</p>
			    </td>
				<td >
					<p><span>Created By</span><span>&nbsp;:&nbsp;</span>
					<?php 
						$m_u  = array();
						$m_u['id']=$RS->fields['created_by'];
						$RS_m_u = $objDB->Show("merchant_user", $m_u);
						$merchant_name = $RS_m_u->fields['firstname']." ".$RS_m_u->fields['lastname'];
						echo $merchant_name;
					?>
					</p>
			    </td>
			</tr>
 
			<tr>
			    <td width="50%">
				 <p><span>Start Date</span><span>&nbsp;:&nbsp;</span> <?=date("Y-m-d g:i:s A", strtotime($RS->fields['start_date']))?></p>
			    </td>
			    <td>
				 <p><span>Expiration Date</span><span>&nbsp;:&nbsp;</span><?=date("Y-m-d g:i:s A", strtotime($RS->fields['expiration_date']))?></p>
			    </td>
			</tr>
			<tr>
			    <td width="50%">
				 <p><span>Redeem Points</span><span>&nbsp;:&nbsp;</span><?=$RS->fields['redeem_rewards']?></p>
			    </td>
			    <td>
				 <p><span>Referral/Sharing Points</span><span>&nbsp;:&nbsp;</span><?=$RS->fields['referral_rewards']?></p>
			    </td>
			</tr>
                        <tr>
			    <td colspan="2">
								 <p><span> Referral Customers Limit:</span><span>&nbsp;</span><?=$RS->fields['max_no_sharing'] ?></p>
			    </td>
			</tr>
	     </table>
		 <p><span>Available At Locations</span><span>&nbsp;:&nbsp;</span><?=$RS_locations->RecordCount()?></p>
		 </div>
         <?php 
			if($RS_locations->RecordCount() != 0)
			{
		?>	
			 <div class="mer_chant_div">
			 <table class="campaign_detail_table_heading" >
			 <tr class="campaign_detail_table_row" >
			
			   	<th class="td_20" align="left">Merchant Locations</th>
				<th class="td_20" align="left">Campaign Visibility</th>
				<th class="td_20" align="left">Campaign Status</th>
				<th class="td_15" align="left">Number of offers</th>
				<th class="td_15" align="left">Offers Left</th>
				<th class="td_15" align="left">Offer Reserved</th>
                <th class="td_15" align="left">Offer Redeemed</th>
			
			</tr>
			<tr><td colspan="7"><hr/></td></tr>
			</table>
			</div>
			 <div class="mer_chant_div" style="">
			 <table class="font_16">
			 
                          
		<?php	 
				while($Row = $RS_locations->FetchRow())
				{
						$where_clause = array();
						$m_arr  = array();
						$m_arr['campaign_id']=$cid;
						$m_arr['location_id']=$Row['id'];
						 $RS_m_c = $objDB->Show("campaign_location", $m_arr);
						$max_coupon = $RS_m_c->fields['num_activation_code'];
				
					$offers_left = $RS_m_c->fields['offers_left'];
					$reserve_offers = $RS_m_c->fields['used_offers']; 		
                        /*$remain_sql="select count(*) as total from coupon_codes where customer_campaign_code =".$cid." AND location_id=".$Row['id'];
                        
                        $RS_remain = $objDB->Conn->Execute($remain_sql);*/
			$RS_remain = $objDB->Conn->Execute("select count(*) as total from coupon_codes where customer_campaign_code =? AND location_id=?",array($cid,$Row['id']));

                        $remain_val = $RS_remain->fields['total'];
                                    $no_of_coupon_reserve= $remain_val ;
                        /*$r_sql = "SELECT * FROM coupon_redeem where coupon_id in (select id from coupon_codes where customer_campaign_code=".$cid." AND location_id =".$Row['id']." ) ";  

                        $RS_redeem = $objDB->Conn->Execute($r_sql);*/
			$RS_redeem = $objDB->Conn->Execute("SELECT * FROM coupon_redeem where coupon_id in (select id from coupon_codes where customer_campaign_code=? AND location_id =? ) ",array($cid,$Row['id']));

                        $redeem_val = $RS_redeem->RecordCount();
                        
                        $remain_val =$remain_val-$redeem_val;
						$campaign_visibility="";
						$campaign_status="";
						if($RS_m_c->fields['campaign_type']==1)
						{
							$campaign_visibility="Public";
						}
						else if($RS_m_c->fields['campaign_type']==2)
						{
							$campaign_visibility="Location Subscribers";
						}
						else if($RS_m_c->fields['campaign_type']==3)
						{
							$campaign_visibility="Distribution/customer List";
						}
						if($RS->fields['is_walkin']==1)
						{
							$campaign_visibility="QR Code Scan/Check-in Campaign";
						}
						
						// 04 10 2013
						
						if($RS_m_c->fields['active']==1 && $RS_m_c->fields['offers_left']>0)
						{
							$campaign_status="Active";
						}
						else if($RS_m_c->fields['active']==1 && $RS_m_c->fields['offers_left']==0)
						{
							$campaign_status="Pause";
						}
						else if($RS_m_c->fields['active_in_future']==1)
						{
							$campaign_status="Scheduled";
						}
						else{
							/* check whether in schedule or not */
							/*$sql= "SELECT  a.* from campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id
							where a.campaign_id=".$cid." and a.location_id=".$Row['id']."
							AND ( (  (   ( b.start_date > CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) )  )  or a.active_in_future =1) and a.offers_left>0 )" ;
							$RS_schedule = $objDB->Conn->Execute($sql);*/
							$RS_schedule = $objDB->Conn->Execute("SELECT  a.* from campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id
							where a.campaign_id=? and a.location_id=?
							AND ( (  (   ( b.start_date > CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) )  )  or a.active_in_future =?) and a.offers_left>?)",array($cid,$Row['id'],1,0));

							if($RS_schedule->RecordCount() == 0)
							{
								$campaign_status="Expired";
							}
							else
							{
								$campaign_status="Scheduled";
							}
						}
						
						// 04 10 2013
                                ?>
		       <tr class="camapaign_detail_row2">
			    <td class="td_20">
                                <?php //echo $Row['location_name']?>
                                <?=$Row['address'].", ".$Row['city'].", ".$Row['state'].", ".$Row['zip']?>
                            </td>
				<td class="td_20"><?=$campaign_visibility?></td>
				<td class="td_20"><?=$campaign_status?></td>				
			    <td class="td_15"><?=$max_coupon?></td>
			    <td class="td_15"><?=$offers_left?></td>
			    <td class="td_15"><?php echo $no_of_coupon_reserve ?></td>
			    <td class="td_15"><?=$redeem_val?></td>
			    
		      </tr>
                         
                <?php 
				
				}
				?>
				</table>
				</div>
				</div>
				</div>
			 <?php
			 }
}
if(isset($_REQUEST['getpoints']))
{
	$array = array();
	  // -- 4-12-2012
        $price = $_REQUEST['txt_price'];
        $array_where1 = array();
        $RS_point_pkg = $objDB->Show("point_packages", $array_where1);
	$package_point = $RS_point_pkg->fields['points'];
        $package_rate = $RS_point_pkg->fields['price'];
        $i_point = (($price * $package_point)/$package_rate);
        echo "$".$price." = ".$i_point."points";
        exit();
}
if(isset($_REQUEST['btnPurchasePointsnow']))
{
	//error_reporting(E_ALL);
	//ini_set('display_errors', 'On');
	require_once(LIBRARY . '/stripe-php/config.php');

	$json_array = array();
	$array_insert = array();
        $customer = array();
	/*$sql_available_point = "Select available_point from merchant_user where id=".$_SESSION['merchant_id'];
	 
	 $RS_available_point = $objDB->Conn->Execute($sql_available_point);*/
	 $RS_available_point = $objDB->Conn->Execute("Select stripe_customer_id from merchant_user where id=?",array($_SESSION['merchant_id']));
	 $RS_available_point1 = $objDB->Conn->Execute("Select points_available from merchant_point_management where merchant_id=?",array($_SESSION['merchant_id']));
   
	 $array_insert['date'] = date("Y-m-d H:i:s");
	 $array_insert['order_id'] =  $_SESSION['merchant_id'].strtotime(date("Y-m-d H:i:s"));
	 $json_array['order_id'] = $array_insert['order_id'];
	$array_insert['merchant_id'] = $_SESSION['merchant_id'];
	//$array_insert['refrence_number'] = 0;
	$array_insert['amount'] = $_REQUEST['txt_price'];
	$json_array['amount'] = $_REQUEST['txt_price'];
	$array_insert['points_before_order'] = $RS_available_point1->fields['points_available'];
	if($_REQUEST['billing_country'] == "USA")
	{
			$array_insert['currency'] = "USD";
	}
	else
	{
			$array_insert['currency'] = "CAD";
	}

	$json_array['status'] = "true";
	$array = array();
	$array['is_default'] =0;
	$json_array['serror']= '';
	$error = NULL;
	$customer_id = $RS_available_point->fields['stripe_customer_id'];

	    try {
	      if (isset($_REQUEST['stripeToken'])){
			$stoken = $_REQUEST['stripeToken'];
		
			//retrive token 
			$tkn = \Stripe\Token::retrieve($stoken);
			$myCard = array('number' => $_REQUEST['card_number'], 'exp_month' => $_REQUEST['exp_month'], 'exp_year' => $_REQUEST['exp_year'],'cvc'=>$_REQUEST['card_csv'],'address_line1'=>$_REQUEST['billing_address'],'address_city'=>$_REQUEST['billing_city'],'address_state'=>$_REQUEST['billing_state'],'address_zip'=>$_REQUEST['billing_postalcode'],'address_country'=>$_REQUEST['billing_country']);
		}
		
		if(empty($customer_id)){

			try {
				// Create a Customer

				$cus = \Stripe\Customer::create(array(
				  	"description" => "Purchase ScanFlip Points",
					"email"=>$_SESSION['merchant_info']['email'],
				  	"card" => $stoken // obtained with Stripe.js
				));
		
				$customer_id = $cus->id;

				//create charge
				$charge = \Stripe\Charge::create(array(
					'customer' => $customer_id, 
					'amount'   => $_REQUEST['txt_price'].'00',
					'currency' => $array_insert['currency'],
					//'receipt_email'=>$_SESSION['merchant_info']['email'],
					"description" => $merchant_msg['purchasepoint']['purchase_scanflip_points'].' with '.$_REQUEST['txt_price'].' '.strtoupper($array_insert['currency']),
				));
				$array['is_default'] =1;


			}catch(Exception $e){
				$json_array['status'] = "false";
				$json_array['serror'] =$e->getMessage();
			}

		}else{
			try {
				$customer = \Stripe\Customer::retrieve($customer_id);
			}catch(Exception $e){
				$json_array['status'] = "false";
				$json_array['serror'] =$e->getMessage();
			}
                        
                        if(!empty($customer)){
			if (isset($_REQUEST['stripeToken'])){
				
				//check cards already exist or not
				$cardf = array();
				foreach($customer->sources->data as $c){
	
					$cardf[] = $c->fingerprint;
				}
				
			
				if(!in_array($tkn->card->fingerprint,$cardf)){
					try { 
						$c=$customer->sources->create(array("card" => $stoken));
					
					}catch(Exception $e){
						$json_array['status'] = "false";
						$json_array['serror'] =$e->getMessage();
					}
					
					if(empty($json_array['serror']) && $json_array['status']== 'true'){
						try { 				
							$customer->default_source=$c->id;
							$customer->save();
						
							$array['is_default'] =1;
						
							$charge = \Stripe\Charge::create(array(
								'customer' => $customer_id, 
								'amount'   => $_REQUEST['txt_price']*100,
								'currency' => $array_insert['currency'],
								//'receipt_email'=>$_SESSION['merchant_info']['email'],
								"description" => $merchant_msg['purchasepoint']['purchase_scanflip_points'].' with '.$_REQUEST['txt_price'].' '.strtoupper($array_insert['currency']),
							));

						}catch(Exception $e){
							$json_array['status'] = "false";
							$json_array['serror'] =$e->getMessage();
						}
					}
				
				}else{
					$json_array['status'] = "false";
					$json_array['serror'] ="card already exist";
				}
			}else{
				$flag =0;
				if($customer->default_source != $_REQUEST['def_card']){
					$customer->default_source=$_REQUEST['def_card'];
					$customer->save();
					$flag =1;
				}
				
				try { 
					$charge = \Stripe\Charge::create(array(
						'customer' => $customer_id, 
						'amount'   => $_REQUEST['txt_price'].'00',
						'currency' => $array_insert['currency'],
						//'receipt_email'=>$_SESSION['merchant_info']['email'],
						"description" => $merchant_msg['purchasepoint']['purchase_scanflip_points'].' with '.$_REQUEST['txt_price'].' '.strtoupper($array_insert['currency']),
					));
				
				}catch(Exception $e){
					$json_array['status'] = "false";
					$json_array['serror'] =$e->getMessage();
				}

				
				
				if($flag == 1){
					$objDBWrt->Conn->Execute("UPDATE stripe_payment_cards SET is_default=? WHERE merchant_id=?",array(0,$_SESSION['merchant_id']));
					$objDBWrt->Conn->Execute("UPDATE stripe_payment_cards SET is_default=? WHERE merchant_id=? and card_id=?",array(1,$_SESSION['merchant_id'],$_REQUEST['def_card']));
				}

			}
                        }
		}

		if(!empty($customer_id) && !empty($customer)){
		
			if ((isset($_REQUEST['stripeToken'])) && (empty($json_array['serror'])) && ($json_array['status'] == "true")){
			$objDBWrt->Conn->Execute("UPDATE stripe_payment_cards SET is_default=? WHERE merchant_id=?",array(0,$_SESSION['merchant_id']));
			
			$array['card_id'] = $tkn->card->id;
			$array['merchant_id'] = $_SESSION['merchant_id'];
			$array['card_number'] = $tkn->card->last4;
			$array['card_holder_name'] = $tkn->card->name;
			$array['type'] =$tkn->card->brand;
			$array['exp_month'] =$tkn->card->exp_month;
			$array['exp_year'] =$tkn->card->exp_year;
			$array['country'] =$tkn->card->country;
			$array['billing_address1'] =$tkn->card->address_line1;
			$array['billing_address2'] =$tkn->card->address_line2;
			$array['billing_city'] =$tkn->card->address_city;
			$array['billing_state'] =$tkn->card->address_state;
			$array['billing_country'] =$tkn->card->address_country;
			$array['billing_zip'] =$tkn->card->address_zip;
			$array['cvv'] =$_REQUEST['card_csv'];
			$array['client_ip'] =$tkn->client_ip;
			$array['customer_id'] =$customer_id;
			$array['created'] =$tkn->created;
			//print_r($array);
			$objDBWrt->Insert($array, "stripe_payment_cards");
				
				$array_mer_up['billing_address'] = $_REQUEST['billing_address'];
				$SESSION['merchant_info']['billing_address'] = $_REQUEST['billing_address'];

				$array_mer_up['billing_state'] = $_REQUEST['billing_state'];
				$SESSION['merchant_info']['billing_state'] = $_REQUEST['billing_state'];

				$array_mer_up['billing_country'] = $_REQUEST['billing_country'];
				$SESSION['merchant_info']['billing_country'] = $_REQUEST['billing_country'];

				$array_mer_up['billing_city'] = $_REQUEST['billing_city'];
				$SESSION['merchant_info']['billing_city'] = $_REQUEST['billing_city'];

				$array_mer_up['billing_zip'] = $_REQUEST['billing_postalcode'];
				$SESSION['merchant_info']['billing_zip'] =  $_REQUEST['billing_postalcode'];

				$array_mer_up['stripe_customer_id'] = $customer_id;

				$merwhere_clause['id'] = $_SESSION['merchant_id'];
				$SESSION['merchant_info']['billing_address'] = $_REQUEST['billing_address'];
				//print_r($array_mer_up);
				$objDBWrt->Update($array_mer_up, "merchant_user", $merwhere_clause);
				
			}
			
			if ((empty($json_array['serror'])) && ($json_array['status'] == "true")){
							
				$array_insert['transaction_id'] = $charge->id;
		
				$array_insert['stripe_response'] = serialize($charge);

				$objDBWrt->Insert($array_insert, "purchase_point_order");
			}


			$array = array();
			if(isset($_REQUEST['mer_id']))
			{
				$array['merchant_id'] =  $_REQUEST['mer_id'];
				$merchant_id = $_REQUEST['mer_id'];
			}
			else{
				$array['merchant_id'] = $_SESSION['merchant_id'] ;
				$merchant_id = $_SESSION['merchant_id'];
			}

		}		

		
	    }
	    catch (Exception $e) {
		$json_array['status'] = "false";
		$json_array['serror'] = $e->getMessage();
		
	    }


        if(!empty($customer)){
            
        
        $merchant_id = getmainmercahnt_id($merchant_id);
	
	/*$Sql = "SELECT available_point from merchant_user where id=".$merchant_id ." or id = (select merchant_parent from merchant_user where id =".$merchant_id.")";
	$RS =  $objDB->execute_query($Sql);*/
	/*$RS =  $objDB->Conn->Execute("SELECT available_point from merchant_user where id=? or id = (select merchant_parent from merchant_user where id =?)",array($merchant_id,$merchant_id));
	
	$available_points = $RS->fields['available_point'];*/
	 $RS = $objDB->Conn->Execute("Select points_purchased,points_available from merchant_point_management where merchant_id=?",array($_SESSION['merchant_id']));
	$available_points = $RS->fields['points_available'];
	$points_purchased = $RS->fields['points_purchased'];
	//echo $available_points." ".$points_purchased;
        // -- 4-12-2012
        $price = $_REQUEST['txt_price'];
        
        $array_where1 = array();
        $RS_point_pkg = $objDB->Show("point_packages", $array_where1);
		$package_point = $RS_point_pkg->fields['points'];
        $package_rate = $RS_point_pkg->fields['price'];
		
        $i_point = (($price * $package_point)/$package_rate);
		
        // -- 4-12-2012
        
	
	$json_array['points'] = $i_point;
	$array_values = $where_clause = $array = array();
	$array_values['points_available'] = $available_points + $i_point;
	$array_values['points_purchased'] = $points_purchased + $i_point;
	$where_clause['merchant_id'] = $merchant_id;
	$objDBWrt->Update($array_values, "merchant_point_management", $where_clause);
	
	// 03 10 2013
	$group_array=array();
	$group_array['merchant_id']= $merchant_id;
    $group_array['purchased_point'] = $i_point;
	$group_array['purchased_date'] = date("Y-m-d H:i:s");
    $objDBWrt->Insert($group_array, "merchant_points");
	// 03 10 2013
	$json_array['purchased_points'] = $i_point;
	$json_array['available_points'] = ($available_points + $i_point);
        }
	/*$json_array['status'] = "flase"; */
	echo $json = json_encode($json_array);
    exit();
}


//17-12-2012
/******** 
@USE : Get filter qrcode scanning data according to year filter
@PARAMETER : current login merchant id , year , status
@RETURN : Qr code scan data
@USED IN PAGES : reports.php
*********/
if(isset($_REQUEST['get_filter_qrcodewie_report']))
{
      ?>   
       
<div class="fielter_location"  >
                     Year :&nbsp;&nbsp; <select id="qrcodescan_select_2" name="qrcodescan_select_2">
<!--   <option value="0" selected >---- ALL ----</option>-->
  <?php
  //for($y=2000;$y<=date('Y');$y++)
    for($y=date('Y');$y>=date('Y')-2;$y--)
  { ?>
	<option value="<?php echo $y; ?>" <?php if($y ==$_REQUEST['year']){ echo "selected";  }?> > <?php echo $y; ?> </option>
  <?php }
  ?>
  </select>
    <input type="button" value ="Show Results" id="btnfilterqrcodedata" name="btnfilterqrcodedata" /> 
                     &nbsp;&nbsp;&nbsp;
                </div>
                     <div class="view_btn" style="float:right"><span id="span_campaign" class="view_report" ><a href="javascript:void(0)"><img src="<?php echo ASSETS_IMG?>/m/menu_icon.png" alt="" style="padding:5px" /></a></span>
                                    <div id="qrcode_select_campaign" class="actiondiv-qrcode"  style="display:none;float:right" >

                                </div>
                                </div>
                                <div style="clear:both"></div>
                    	<div id="container_qrcodecampaignreport" class="qrcode_container"></div>
                       <div class="view_btn"><span id="span_location" class="view_report" ><a href="javascript:void(0)"><img src="<?php echo ASSETS_IMG?>/m/menu_icon.png" /></a></span>
                                    <div id="qrcode_select_location" class="actiondiv-qrcode"  style="display:none;" >

                                </div>
                                </div>
                                <div style="clear:both"></div>
                        <div id="container_qrcodelocationreport" class="qrcode_container"></div>
                       
                
               <script>
 var     tot_arr_male_arr_location = "";
                                    var tot_arr_female_arr_location =   "";
                                    var        tot_arr_unknown_arr_location= "";
                                    var   tot_arr_unique_qrcodelocation_arr = "";
                                    var tot_arr_unique_qrcodetotal_arr = "";
                                    var tot_arr_male_arr_campaign =  "";
                                    var tot_arr_female_arr_campaign=   "";
                                    var    tot_arr_unknown_arr_campaign= "";
                                    var tot_arr_all_qrcodecampaign_arr = "";
                                    var    tot_arr_unique_qrcodecampaign_arr = "";
                                    var tot_arr_locatino_json="";
                                    var all_locations = "";
                                    var chart;
									// initializing qr code report
                                    jQuery(document).ready(function() {
                                         // alert('qrcode-ajax.php?year=0&month=0&selected_locations=')
                                      /* for campaign */  
                                    var location_list=getCookie("selected_location_list_<?php echo $_SESSION['merchant_id'] ?>");
									  if (location_list!=null && location_list!="")
									  {
										  selected_locations  =getCookie("selected_location_list_<?php echo $_SESSION['merchant_id'] ?>");
									  }
									else
									  {
										  selected_locations  = "";
									  }
									  
									  if(selected_locations != ""){
									  var arr_v1 = selected_locations.split(";");
									  if(arr_v1.length != 1)
									  {
									  default_qrcode_campaign_report(selected_locations);
									  }else{
									single_campaign_qrcode_report(selected_locations);
									  }
									  }else{$.ajax({
                                                    type:"POST",
                                                    url:'process.php',
                                                    data : 'check_locations_report=1&year=2013&month=0&selected_locations=&mer_id=<?php echo $_SESSION['merchant_id'] ?>',
                                                    async: false,
                                                    success:function(msg)
                                                    {
														var obj = jQuery.parseJSON(msg);
															if (obj.total_locations==1)     
                                                                {
																 single_campaign_qrcode_report(obj.location_id);
																}
																else{
																default_qrcode_campaign_report(selected_locations);
																}
                                                    }
                                                });
									   //default_qrcode_campaign_report(selected_locations);
									  }
									/* for campaign */  
									/* for location */  
									var location_list=getCookie("selected_location_list_location_<?php echo $_SESSION['merchant_id'] ?>");
									  if (location_list!=null && location_list!="")
									  {
										  selected_locations1  =getCookie("selected_location_list_location_<?php echo $_SESSION['merchant_id'] ?>");
									  }
									else
									  {
										  selected_locations1  = "";
									  }
									  if(selected_locations1 != ""){
									  var arr_v1 = selected_locations1.split(";");
									  if(arr_v1.length != 1)
									  {
									  default_qrcode_location_report(selected_locations1);
									  }else{
									  single_location_qrcode_report(selected_locations1);
									  }
									  }
									  else{
									  //alert('check_locations_report=1&year=2013&month=0&selected_locations=&mer_id=<?php echo $_SESSION['merchant_id'] ?>');
									  $.ajax({
                                                    type:"POST",
                                                    url:'process.php',
                                                    data : 'check_locations_locationreport=1&year=2013&month=0&selected_locations=&mer_id=<?php echo $_SESSION['merchant_id'] ?>',
                                                    async: false,
                                                    success:function(msg)
                                                    {
														var obj = jQuery.parseJSON(msg);
															if (obj.total_locations==1)     
                                                                {
																 single_location_qrcode_report(obj.location_id);
																}
																else{
																default_qrcode_location_report(selected_locations1);
																}
                                                    }
                                                });
									  
									  }
									  
									  });
									/* for location */
        $(document).ready(function(){

//          $('#container_qrcodelocationreport .highcharts-axis span .label').hover( function(){
//                $(this).css('color','#008000');
//            }, function(){
//                       $(this).css('color','#666666');
//	    });
var w = $('#container_qrcodecampaignreport').css("width");
var wval = w.replace("px","");
//alert(wval);
wval = parseInt(wval);
wval = wval - 150;
var l_val = $('#container_qrcodecampaignreport .highcharts-axis span .labelcamp').length;
var a_val = wval/l_val;
//alert(a_val);
a_val = parseInt(a_val);
a_val = a_val+"px";
//alert(a_val);
$('#container_qrcodecampaignreport .highcharts-axis span .labelcamp').css("width",a_val);



 w = $('#container_qrcodelocationreport').css("width");
 wval = w.replace("px","");
//alert(wval);
wval = parseInt(wval);
wval = wval - 150;
l_val = $('#container_qrcodelocationreport .highcharts-axis-labels span .labelcamp').length;
 a_val = wval/l_val;
//alert(a_val);
a_val = parseInt(a_val);
a_val = a_val+"px";
//alert(a_val);
$('#container_qrcodelocationreport .highcharts-axis-labels span .labelcamp').css("width",a_val);
  $('.highcharts-axis-labels span .labelcamp').parent().css("white-space","normal");
             $('#.highcharts-axis-labels span .labelcamp').hover( function(){
                $(this).css('color','##0192b5');
            }, function(){
                       $(this).css('color','#666666');
	    });
           jQuery("#span_location").click(function(){
        // jQuery("#span_campaign")
        jQuery("#qrcode_select_location").slideToggle("slow");
    });
        
    jQuery("#span_campaign").click(function(){
           
        jQuery("#qrcode_select_campaign").slideToggle("slow");
    });
            $('.highcharts-axis-labels span .labelcamp').click( function(){
        
          lid =$(this).attr('lid');
            var arr_val = $(this).attr("qrcodescanloc_value").split("-=-");
           if((arr_val[0].toString()).split("#!#")[0] == " "){
                   $.ajax({
		  type:"POST",
		  url:'process.php',
		  data : 'location_business_address=1&loc_id='+lid,
                  async: false,
		    success:function(msg)
		    {
		      $(".qrcode_location_heading").html(msg);
                    }
        });
            }else{
              $(".qrcode_location_heading").html(arr_val[0].toString().split("#!#")[0]);
            }
            
         //   alert("unknown_arr_location"+obj.arr_male_arr_location[lid]);
            $("#Notification2PopUpContainer #spanp1").html("Total Male Users(%)");
            $("#Notification2PopUpContainer #span1").html(arr_val[1]+"%");
               
				$("#Notification2PopUpContainer #spanp2").html("Total Scans By Male");
                                  $("#Notification2PopUpContainer #span2").html(arr_val[2]+"%");
				$("#Notification2PopUpContainer #spanp3").html("Total Scans By Female");
                                $("#Notification2PopUpContainer #span3").html(arr_val[3].toString()+"%");
                                  $("#Notification2PopUpContainer #spanp4").html("Total Scans By Unknown");
				$("#Notification2PopUpContainer #span4").html(arr_val[4].toString());
                                  $("#Notification2PopUpContainer #spanp5").html("Total No. Of Scans");
				$("#Notification2PopUpContainer #span5").html(arr_val[5].toString());
                                jQuery.fancybox({
                                                content:jQuery('#Notification2mainContainer').html(),

                                                type: 'html',

                                                openSpeed  : 300,

                                                closeSpeed  : 300,
                                                // topRatio: 0,

                                                changeFade : 'fast',  

                                                helpers: {
                                                    overlay: {
                                                        opacity: 0.3
                                                    } // overlay
                                                }
                                            });
                                //open_popup('Notification2');
				
	    });
            $('.highcharts-axis-labels span .lbl_qrcode').click(function(){
	 
	 if($(this).text() == "Jan" || $(this).text() == "Feb" || $(this).text() == "Mar" || $(this).text() == "Apr" || $(this).text() == "May" || $(this).text() == "Jun" || $(this).text() == "Jul" || $(this).text() == "Aug" || $(this).text() == "Sep" || $(this).text() == "Oct" || $(this).text() == "Nov" || $(this).text() == "Dec")
                                                {
                   
                                                    var arr_val = $(this).attr("val").split("-");
                                                    
                                                    //                      
				
                                                    
                                                     $("#Notification2PopUpContainer #spanp1").html("Total Scans By Male");
                                            $("#Notification2PopUpContainer #span1").html(arr_val[0]+"%");
               
                                            $("#Notification2PopUpContainer #spanp2").html("Total Scans By Female");
                                            $("#Notification2PopUpContainer #span2").html(arr_val[1]+"%");
                                            $("#Notification2PopUpContainer #spanp3").html("Total Scans By Unknown");
                                            $("#Notification2PopUpContainer #span3").html(arr_val[2].toString()+"%");
                                            $("#Notification2PopUpContainer #spanp4").html("Total No. Of Unique Scans");
                                            $("#Notification2PopUpContainer #span4").html(arr_val[4].toString());
                                            $("#Notification2PopUpContainer #spanp5").html("Total No. Of Scans");
                                            $("#Notification2PopUpContainer #span5").html(arr_val[3].toString());
                                            jQuery.fancybox({
                                                content:jQuery('#Notification2mainContainer').html(),

                                                type: 'html',

                                                openSpeed  : 300,

                                                closeSpeed  : 300,
                                                // topRatio: 0,

                                                changeFade : 'fast',  

                                                helpers: {
                                                    overlay: {
                                                        opacity: 0.3
                                                    } // overlay
                                                },
					beforeShow:function(){
				
						$(".fancybox-inner").css ("overflow","hidden");	},
					
					afterShow:function(){
						$(".fancybox-inner").css ("overflow","hidden");	},

                                            });
			
                                                    //open_popup('Notification1');
                                                }
			});
            
        });
       
       
            
                </script>
<?php   ?>


<?php
}
/******** 
@USE : Get filter location data for report
@PARAMETER : current login merchant id , year ,month , status
@RETURN : location list
@USED IN PAGES : reports.php
*********/
if(isset($_REQUEST['get_filter_locationwie_report']))
{
    if($_REQUEST['month'] != 0)
    {
        if($_REQUEST['month']==4 ||$_REQUEST['month']==6 ||$_REQUEST['month']==9 ||$_REQUEST['month']==11 )
        {
            $m=30;
        }
        else if($_REQUEST['month']==2)
        {
            $m=28;
        }
        else
        {
            $m =31;
        }
    }
	if($_REQUEST['year'] != 0 && $_REQUEST['month'] != 0)
	{
		   $from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	    	$to_date =  $_REQUEST['year']."-".$_REQUEST['month']."-".$m." 23:59:59";
	}
	else if($_REQUEST['year'] != 0 && $_REQUEST['month'] == 0)
	{
			   $from_date = $_REQUEST['year']."-01-01 00:00:00";
     	     	$to_date =  $_REQUEST['year']."-12-31 23:59:59";
	}
	
	
	//////////////
?>
	<div class="fielter_location">		
   Year :&nbsp;&nbsp; <select id="location_select_2" name="location_select_2">
   <option value="0" >---- ALL ----</option>
  <?php
  //for($y=2000;$y<=date('Y');$y++)
  for($y=date('Y')-2;$y<=date('Y');$y++)
  { ?>
	<option value="<?php echo $y; ?>" <?php if($_REQUEST['year']== $y ){ echo "selected"; } ?> > <?php echo $y; ?> </option>
  <?php }
  ?>
  </select>&nbsp;&nbsp;&nbsp; 
<!--  <select id="location_select_1" name="location_select_1">
            <option value="0"  >---- ALL ----</option>
	<option value="01" <?php if($_REQUEST['month'] == '01'){ echo "selected" ;} ?> >January</option>
	<option value="02" <?php if($_REQUEST['month'] == '02'){ echo "selected" ;} ?> >February</option>
	<option value="03" <?php if($_REQUEST['month'] == '03'){ echo "selected" ;} ?>  >March</option>
	<option value="04" <?php if($_REQUEST['month'] == '04'){ echo "selected" ;} ?> >April</option>
	<option value="05" <?php if($_REQUEST['month'] == '05'){ echo "selected" ;} ?> >May</option>
	<option value="06" <?php if($_REQUEST['month'] == '06'){ echo "selected" ;} ?> >Jun</option>
	<option value="07" <?php if($_REQUEST['month'] == '07'){ echo "selected" ;} ?> >July</option>
	<option value="08" <?php if($_REQUEST['month'] == '08'){ echo "selected" ;} ?> >August</option>
	<option value="09" <?php if($_REQUEST['month'] == '09'){ echo "selected" ;} ?> >September</option>
	<option value="10" <?php if($_REQUEST['month'] == '10'){ echo "selected" ;} ?>>October</option>
	<option value="11" <?php if($_REQUEST['month'] == '11'){ echo "selected" ;} ?> >November</option>
	<option value="12" <?php if($_REQUEST['month'] == '12'){ echo "selected" ;} ?> >December</option>
  </select> &nbsp;&nbsp;-->
  <input type="button" value ="Show Results" id="btnfilterlocationdata" name="btnfilterlocationdata" />
  
        </div>
        <?php
		
		if($_SESSION['merchant_info']['merchant_parent'] != 0)
                {
                    $media_acc_array = array(); 
                        $media_acc_array['merchant_user_id'] = $_SESSION['merchant_id']; 
                        $RSmedia = $objDB->Show("merchant_user_role",$media_acc_array); 
                        $location_val = $RSmedia->fields['location_access'];
                   
                    $arr1=file(WEB_PATH.'/merchant/process.php?btnGetAllLocationOfMerchant=yes&mer_id='.$_SESSION['merchant_id'].'&loc_id='.$location_val);
                }
                else{
                    $arr1=file(WEB_PATH.'/merchant/process.php?btnGetAllLocationOfMerchant=yes&mer_id='.$_SESSION['merchant_id']);
                }
		//$arr1=file(WEB_PATH.'/merchant/process.php?btnGetAllLocationOfMerchant=yes&mer_id='.$_SESSION['merchant_id']);
				if(trim($arr1[0]) == "")
				{
					unset($arr1[0]);
					$arr1 = array_values($arr1);
				}
				$json1 = json_decode($arr1[0]);
				$total_records1= $json1->total_records;
				$records_array1 = $json1->records;
			
		 $arr=file(WEB_PATH.'/merchant/process.php?get_point_package=yes');
                                    if(trim($arr[0]) == "")
                                    {
                                            unset($arr[0]);
                                            $arr = array_values($arr);
                                    }
                                    $json = json_decode($arr[0]);
                                    $total_records_= $json->total_records;
                                    $records_array_ = $json->records;
                                    if($total_records_>0){
                                                    foreach($records_array_ as $Row_)
                                                    {	
		
                                            $price =$Row_->price;
                                            $point_=$Row_->points;
											$p= (1*$price)/$point_;
													}
													$B4 = $p;
									}
                                                                   
				if($total_records1 > 0){
					$cnt=0;
				  foreach($records_array1 as $Row)
				  {
				?>
                 <div class="location_heading">
                    <span><?php echo $merchant_msg['report']['location'];?><?=$Row->address.", ".$Row->city.", ".$Row->state.", ".$Row->zip?></span>
<!--                    <span class="plus_">+</span>-->
                    <div id="toggleIt-plus_<?php echo $Row->id ?>" class="mainIcon"></div> <!--<span style="padding-left: 20px">Collapse</span> -->
                 
                    </div>
                     <div  class="new_loca_eta" id="plus_<?php echo $Row->id ?>" style="display:<?php echo 'none'; ?>">
			 
        <div class="l_content">
			  <div class="divsummary_<?php echo $Row->id ?>"></div>
				<?php 
					$arr_new_cust_ref = array();
				$arr_exsting_cust_reft = array();
				$arr_age = array();
				$t_v =0;
                                $Where="";
				$arr_new_cust_ref = array();
				$arr_exsting_cust_reft = array();
                                 $wh_status = "";
                                 if(isset($_REQUEST['status']))
                                 {
                                        if($_REQUEST['status'] == "active")
                                        {
                                            $wh_status = " and cl.active=1  and cl.active_in_future<>1";
                                        }elseif ($_REQUEST['status']=="expire") {
                                            $wh_status = " and cl.active<>1 and cl.active_in_future<>1";
                                        }elseif ($_REQUEST['status']=="end") {
                                            $wh_status ="";
                                        }
                                 }
                                 else
                                 {
                                     $wh_status ="";
                                 }
                                
                                 
				  $Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date ";
                                   $month_expr = "";
                                  if($_REQUEST['month'] == 0 )
                                  {
                                     $month_expr = " and  DATE_FORMAT(c.expiration_date,'%Y') =".$_REQUEST['year']." ";
                                  }
                                  else
                                  {
                                       $month_expr = " and  DATE_FORMAT(c.expiration_date,'%m') =".$_REQUEST['month']." ";
                                  }
				if($_REQUEST['year'] != 0 )
							{
							//	$dt_wh = "CONVERT_TZ(c.start_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) between CONVERT_TZ('".$from_date."','+00:00','+00:00') and CONVERT_TZ('".$to_date."','+00:00','+00:00') and  CONVERT_TZ(c.expiration_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) >= CONVERT_TZ('".$from_date."','+00:00','+00:00')";
							//	$dt_wh1 = "CONVERT_TZ(c.start_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) <=  CONVERT_TZ('".$from_date."','+00:00','+00:00') and CONVERT_TZ('".$to_date."','+00:00','+00:00')  and  CONVERT_TZ(c.expiration_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) >= CONVERT_TZ('".$to_date."','+00:00','+00:00')";
                                                                
                                       // $dt_wh = "c.start_date between CONVERT_TZ('".$from_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) and CONVERT_TZ('".$to_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) and c.expiration_date >= CONVERT_TZ('".$from_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))";
					//$dt_wh1 = "c.start_date <=  CONVERT_TZ('".$from_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) and CONVERT_TZ('".$to_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))   and c.expiration_date >= CONVERT_TZ('".$to_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))";                    
                                     $dt_wh = "c.expiration_date <'".$to_date ."' ";
                                     $dt_wh1 = "";
				$tc_sql = $sql = "SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=".$Row->id." and c.id = cl.campaign_id   and ($dt_wh) $month_expr  and cl.active<>1 and cl.active_in_future<>1  ";
						 
				 
							}else
							{
								 $tc_sql = $sql = "SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=".$Row->id." and c.id = cl.campaign_id 
                                                                     and cl.active<>1 and cl.active_in_future<>1  AND c.expiration_date <  CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) ";
							
								
							} 
						   $RS_l_tc= $objDB->Conn->Execute($tc_sql);
                        $r_l_tc = $RS_l_tc->RecordCount();
						$t_c = $r_l_tc;
				if($_REQUEST['year'] != 0 )
							{
							//	$dt_wh = "  CONVERT_TZ(NOW(),'+00:00','+00:00') BETWEEN CONVERT_TZ(c.start_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) AND CONVERT_TZ(c.expiration_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ";
							//	$dt_wh = "CONVERT_TZ(c.start_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) between CONVERT_TZ('".$from_date."','+00:00','+00:00') and CONVERT_TZ('".$to_date."','+00:00','+00:00') and  CONVERT_TZ(c.expiration_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) >= CONVERT_TZ('".$from_date."','+00:00','+00:00')";
							//	$dt_wh1 = "CONVERT_TZ(c.start_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) <=  CONVERT_TZ('".$from_date."','+00:00','+00:00') and CONVERT_TZ('".$to_date."','+00:00','+00:00')  and  CONVERT_TZ(c.expiration_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) >= CONVERT_TZ('".$to_date."','+00:00','+00:00')";
                               // $dt_wh = "c.start_date between CONVERT_TZ('".$from_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) and CONVERT_TZ('".$to_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) and c.expiration_date >= CONVERT_TZ('".$from_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))";
				//$dt_wh1 = "c.start_date <=  CONVERT_TZ('".$from_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) and CONVERT_TZ('".$to_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))   and c.expiration_date >= CONVERT_TZ('".$to_date."','".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))";                    
				 $dt_wh = "c.expiration_date <'".$to_date ."' ";
                                     $dt_wh1 = "";
                                    $tc_sql = $sql = "SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=".$Row->id." and c.id = cl.campaign_id   and ($dt_wh)  $month_expr and cl.active<>1 and cl.active_in_future<>1  ";


								
							}else
							{
								$sql = "SELECT  distinct c.* , cl.location_id location_id , cl.num_activation_code num_activation_code   from  campaigns c , campaign_location cl , locations l where l.id=cl.location_id and cl.location_id=".$Row->id." and c.id = cl.campaign_id 
                                                                    and cl.active<>1 and cl.active_in_future<>1  AND c.expiration_date <  CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) ";
							
								
							}
						//echo $sql;
						$RS_l= $objDB->Conn->Execute($sql);
                        $r_l = $RS_l->RecordCount();
						$t_c = $r_l;
						 
						 $campaign_list_arr = array();
						  $total_cust =0;
									//echo "r_l =".$r_l;
                                                  if($r_l>0)
                                                  {
													  //echo " in if r_l =".$r_l;
                                                        while($loc =  $RS_l->FetchRow()){
                                                                array_push($campaign_list_arr,$loc['id']);

                                                        }
                                                         $campaign_list = implode(",",$campaign_list_arr);
                          
                                                        $sql = "select  c.gender , c.dob_year , b.customer_id ,b.customer_campaign_code ,b.location_id , a.coupon_id ,a.redeem_value 
                                                                        from `coupon_redeem` a inner join coupon_codes b on a.coupon_id = b.id inner join customer_user c on c.id= b.customer_id
                                                                        where  b.customer_campaign_code in ($campaign_list) and b.location_id =". $Row->id;
                                                        //echo $sql;
                                                         $a= $objDB->Conn->Execute($sql);
														
                                                         $t_c=$a->RecordCount();
                                                        //echo " in if t_c =".$t_c;
                                                  }
                                                
                                                 
                         //echo " in out t_c =".$t_c;
                        
                        ?>

  <div style="clear:both"></div>
          
             <div  class="chart_container">
							 <div class="location_report_div_right" align="center">
                         <div id="container_<?php echo $Row->id; ?>"  class="location_report_gender" cust_avail="<?php if($total_cust == 0) { echo "0";  } else { echo "1"; }?>" ></div>
                         </div>
 						<div class="location_report_div_right" align="center">
                         <div id="containerage_<?php echo $Row->id; ?>"  class="location_report_gender" ></div>
                         </div>
             </div>
                         <div style="clear:both"></div>
			
			<div id="container_report_<?php echo $Row->id; ?>" class="location_report_statics" camp_avail="<?php if($t_c == 0) { echo "0";  } else { echo "1"; }?>"></div>
			
                        <div class="cls_clear"></div>                         			 
                         
                   
                       </div>
                          <?php
                     	   if(isset($total_cust) != 0)
						 { ?>
                          <input type="hidden" name="hdncontainer_<?php echo $Row->id; ?>" value="<?php echo round($male_per,2)."-".round($female_per,2)."-".round($unknowne_per,2);  ?>" id="hdncontainer_<?php echo $Row->id; ?>" >
<input type="hidden" name="hdncontainerrange_<?php echo $Row->id; ?>" value="<?php echo round((($c_1* 100)/$total_cust),2)."-".round((($c_2* 100)/$total_cust),2)."-".round((($c_3* 100)/$total_cust),2)."-".round((($c_4* 100)/$total_cust),2)."-".round((($c_5* 100)/$total_cust),2)."-".round((($c_6* 100)/$total_cust),2);  ?>" id="hdncontainerrange_<?php echo $Row->id; ?>" >
                                                 <?php } ?>
      
        </div>
        
				<?php
					$cnt++;
				}
				}

		
	///////////////
}
//17-12-2012

// ---- 10/12/2012
/******** 
@USE : Get filter campaigns
@PARAMETER : current login merchant id , year , status
@RETURN : Qr code scan data
@USED IN PAGES : reports.php
*********/
if(isset($_REQUEST['get_filter_campaigns']))
{
	/* 
	 * Paging
	 */
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}

	$location_str = "";
	$Where_st  = "";
	if($_REQUEST['location_id'] != "0")
	{
		$location_str = " and c.id=".$_REQUEST['location_id'];
	}
	else
	{
		$location_str = "";
	}
	
	$action = $_REQUEST['status'];
	
	if($action == "active")
	{
						
		$Where_st .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1 and a.offers_left>0 ";
		
             
	}
	elseif($action == "expired")
	{
		if($_REQUEST['location_id'] != "0")
		{
			$location_q = " and x.location_id=".$_REQUEST['location_id'] ." ";
		}
		else
		{
			$location_q = "";
		}
	    $Where_st .= " AND b.expiration_date <  CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1))  and b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(z.timezone,1, POSITION(',' IN z.timezone)-1) ".$location_q.") BETWEEN y.start_date and y.expiration_date and ( x.active_in_future<>1 OR x.active=1 ) ) and a.active_in_future<>1 and a.active<>1 ";
	}
	elseif($action == "activeinfuture")
	{
		if($_REQUEST['location_id'] != "0")
		{
			$location_q = " and x.location_id=".$_REQUEST['location_id'] ." ";
		}
		else
		{
			$location_q = "";
		}
	    $Where_st .= "  AND (((( b.start_date  > CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) )) or   a.active_in_future =1 and a.offers_left>0 ) and  b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE x.active=1 and x.offers_left>0  ".$location_q." ) and a.active <> 1   ";
    }
	elseif($action == "endcampaigns")
	{
		if($_REQUEST['location_id'] != "0")
		{
			$location_q = " and x.location_id=".$_REQUEST['location_id'] ." ";
		}
		else
		{
			$location_q = "";
		}
        $Where_st .= "  AND ( a.offers_left <=0  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date ) and  b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE (x.active=1 or x.active_in_future=1) and x.offers_left>0  ".$location_q.")and (a.active_in_future<>1 and a.active=1) or (a.active_in_future=1 and a.active<>1)  and a.offers_left <=0";
            
    }
	else
	{
		$Where_st = "";
	}
	
    $arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
    $ids=  implode(",", $arr_ids);
    $Where="";
    if($ids=="")
        $ids=$_REQUEST['mer_id'];
		
    $merchant_array = array();
	$merchant_array['id'] = $_REQUEST['mer_id'];
	$merchant_info = $objDB->Show("merchant_user",$merchant_array);
		
	$today_date = date("Y-m-d")." 00:00:00";
	
    	$dt_wh ="";
	//$Where .= " AND (b.start_date <='$today_date' and b.expiration_date > '$today_date') ";

	 $cat_wh = "";
	if($_REQUEST['category']!=0)
	{
		$cat_wh = "b.category_id=".$_REQUEST['category']." and ";
	}

    	if($_REQUEST['year'] != 0 && $_REQUEST['month'] != 0)
	{
		$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	        $to_date =  $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";

		$date_str ="(b.created_date>='$from_date' AND b.created_date<='$to_date') ";
	}
	else if($_REQUEST['year'] != 0 && $_REQUEST['month'] == 0)
	{
		$from_date = $_REQUEST['year']."-01-01 00:00:00";
    		$to_date =  $_REQUEST['year']."-12-31 23:59:59";
		$date_str ="(b.created_date>='$from_date' AND b.created_date<='$to_date') ";

	}else if($_REQUEST['year'] == 0 && $_REQUEST['month'] != 0)
   	 {        
		
		for($y=date('Y');$y<=date('Y')+2;$y++)
		{  
			$date_str =  " (b.created_date>='".$y."-".$_REQUEST['month']."-01 00:00:00' AND b.created_date<='".$y."-".$_REQUEST['month']."-31 00:00:00' ) ";			
			if($y != date('Y'))
			{
				$date_str .= " || ";
			}
		}       
    }
    else if($_REQUEST['year'] == 0 && $_REQUEST['month'] == 0)
	{
		
		$last_month_date = date('Y-m-d', strtotime(date('Y-m-d')) - 60*60*24*30)." 00:00:00";
			$date_str =  "(b.created_date>='".$last_month_date."' AND b.created_date<=NOW()) ";

	}
	

	if($merchant_info->fields['merchant_parent'] == 0)
	 	{ 
           	$Sql = "SELECT SQL_CALC_FOUND_ROWS distinct b.id,b.title,b.category_id,b.start_date,b.expiration_date,cs.cat_name,ac.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id INNER JOIN categories cs on cs.id=b.category_id INNER JOIN activation_codes ac on ac.campaign_id=b.id
                WHERE  $cat_wh $date_str $Where AND (b.created_by = ".$_REQUEST['mer_id']." or b.created_by in ( $ids ))  ".$dt_wh ."  $location_str $Where_st  ORDER BY b.modified_date DESC ".$sLimit;
		}
		else
		{
							
			$merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
			$Where=" and a.location_id=".$merchant_info->fields['location_access'];
		
			$Sql = "SELECT SQL_CALC_FOUND_ROWS distinct b.id,b.title,b.category_id,b.start_date,b.expiration_date,cs.cat_name,ac.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id INNER JOIN categories cs on cs.id=b.category_id INNER JOIN activation_codes ac on ac.campaign_id=b.id
			 WHERE $cat_wh $date_str  $Where  $location_str $Where_st  ORDER BY b.modified_date DESC ".$sLimit;		
		}
	
	$RS = $objDB->Conn->Execute($Sql); 
	//error_reporting(-1);
//ini_set('display_errors', 'On');
	/*$objDB->Conn->memCache = true;
        $objDB->Conn->memCacheHost = array('67.228.220.60'); /// $db->memCacheHost = $ip1; will work too
        $objDB->Conn->memCachePort = 11211; /// this is default memCache port
        $objDB->Conn->memCacheCompress = false; /// Use 'true' to store the item compressed (uses zlib)*/
	//error_reporting(E_ALL);
	//$objDB->Conn->cacheSecs = 3600*24; # cache 24 hours
	//$RS =$objDB->Conn->CacheExecute(15,$Sql);exit;

	
	$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
		$total= $sQuery->fields['FOUND_ROWS()'];
		
	$Json = array();
                $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
                $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
                $Json['iTotalDisplayRecords'] = $total;
                $Json['sEcho'] = $_REQUEST['sEcho'];
                //$Json['sSearch'] = $_REQUEST['sSearch'];
                $Json['aaData'] = array();

		if($RS->RecordCount()>0)
		{
			
			$k =0;
			while($Row = $RS->FetchRow())
			{   
			$Json['aaData'][$k][]= '<a href="javascript:void(0);" ><span  class="show_camp" campid="'.$Row['id'].'" >'.$Row['title'].'</span></a>';
			$Json['aaData'][$k][]=$Row['cat_name'];
			$Json['aaData'][$k][]=$Row['activation_code'];
			$Json['aaData'][$k][]=date("Y-m-d g:i:s A",strtotime($Row['start_date']));
			$Json['aaData'][$k][]=date("Y-m-d g:i:s A",strtotime($Row['expiration_date']));
			$k++;
			}
                        
		}

	echo json_encode($Json);
         
        exit;

}

/******** 
@USE : at the time of add campaign , edit campaign , liating check whether campaign is active or not 
@PARAMETER : current login merchant id , and recently add , edit  or open campaign id 
@RETURN : Return  active, active-in-future , pause , expire
@USED IN PAGES : add-compaign.php , edit-compaign.php , compaigns.php
*********/
if(isset($_REQUEST['check_campaign_status']))
{
 $json_array=$records=array();
		$merchant_array = array();
		$merchant_array['id'] = $_REQUEST['mer_id'];
		$merchant_info = $objDB->Show("merchant_user",$merchant_array);
		$arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
		$ids=  implode(",", $arr_ids);
		$merchant_id =  $_REQUEST['mer_id'];
		$Where="";
		$date_str="";
		$lacation_str="";
		$Where_st = "";
		$Where_st .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1 and a.offers_left>0 ";
	 	if($merchant_info->fields['merchant_parent'] != 0)
		{
			$merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info_s = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where=" a.location_id=".$merchant_info_s->fields['location_access'];
		}
		if($merchant_info->fields['merchant_parent'] == 0)
		 { 
			$Sql = "SELECT distinct b.* , b.id campaign_id from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
					(b.created_by = $merchant_id or b.created_by in ( $ids))  $Where $date_str  $Where_st $lacation_str and b.id=".$_REQUEST['cid']." ORDER BY modified_date DESC";
		

		 }
		 else
		 {
			
			$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
					$Where $date_str $Where_st $lacation_str  and b.id=".$_REQUEST['cid']." ORDER BY modified_date DESC";
			
			
		 }
		// echo $Sql;
		 $counted = 0;
	 $RS = $objDB->Conn->Execute($Sql);
	 if($RS->RecordCount() != 0 )
	 {
		$status = "active";
		$counted = 1;
	 }
	 // check for active-in-future
	 if($counted == 0)
	 {
	 $Where_st = "";
					if($_REQUEST['location_id'] != "0")
					 {
						$location_q = " and x.location_id=".$_REQUEST['location_id'] ." ";
						$location_q = "";
					 }
					 else{
						$location_q = "";
					}
						$Where_st .= "  AND (((( b.start_date  > CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) )) or   a.active_in_future =1 and a.offers_left>0 ) and  b.id not in (
						SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
						WHERE x.active=1 and x.offers_left>0  ".$location_q." ) and a.active <> 1   ";
					if($merchant_info->fields['merchant_parent'] == 0)
					 { 
						$Sql = "SELECT distinct b.* , b.id campaign_id from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
								(b.created_by = $merchant_id or b.created_by in ( $ids))  $Where $date_str  $Where_st $lacation_str  and b.id=".$_REQUEST['cid']." ORDER BY modified_date DESC";
						

					 }
					 else
					 {
						
						$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
								$Where $date_str $Where_st $lacation_str   and b.id=".$_REQUEST['cid']." ORDER BY modified_date DESC";
					
						
					 }
					$RS = $objDB->Conn->Execute($Sql);
					 if($RS->RecordCount() != 0 )
					 {
						$status = "active-in-future";
						$counted = 1;
					 }	
					 if($counted == 0)
					 {
								$Where_st = "";
								 if($_REQUEST['location_id'] != "0")
								{
									$location_q = " and x.location_id=".$_REQUEST['location_id'] ." ";
									$location_q = "";
								}
								else{
									$location_q = "";
								}
								$Where_st .= "  AND ( a.offers_left <=0  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date ) and  b.id not in (
								SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
								 WHERE (x.active=1 or x.active_in_future=1) and x.offers_left>0  ".$location_q.")and ((a.active_in_future<>1 and a.active=1) or (a.active_in_future=1 and a.active<>1))  and a.offers_left <=0";
					if($merchant_info->fields['merchant_parent'] == 0)
					 { 
						$Sql = "SELECT distinct b.* , b.id campaign_id from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
								(b.created_by = $merchant_id or b.created_by in ( $ids))  $Where $date_str  $Where_st $lacation_str  and b.id=".$_REQUEST['cid']."  ORDER BY modified_date DESC";
						 

					 }
					 else
					 {
						
						$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
								$Where $date_str $Where_st $lacation_str  and b.id=".$_REQUEST['cid']."  ORDER BY modified_date DESC";
					
						
					 }
					// echo $Sql;
					$RS = $objDB->Conn->Execute($Sql);
					 if($RS->RecordCount() != 0 )
					 {
						$status = "pause";
						$counted = 1;
					 }
					 if($counted == 0)
					 {
						$Where_st = "";
						$status ="expire";
						$counted = 1;
					 }
					 }
	 }
	 $json_array['campaign_status'] = $status;
	 $json_array['status'] = "true";
     $json = json_encode($json_array);
		$json = json_encode($json_array);
   echo $json;
   exit();
}
/**** 
Campaign is not editable for active , pause
*****/
if(isset($_REQUEST['check_campaign_active_se']))
{
    $json_array=$records=array();
   /* $Where = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1  ";
    $Sql = "SELECT count(DISTINCT b.id) as total from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where
        b.id =". $_REQUEST['cid']." ".   $Where  ." ";
    $Sql="SELECT count(*) as total from campaigns where id =". $_REQUEST['cid']." AND NOW() BETWEEN start_date AND expiration_date";
   */
		$merchant_array = array();
		$merchant_array['id'] = $_REQUEST['mer_id'];
		$merchant_info = $objDB->Show("merchant_user",$merchant_array);
		$arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
		$ids=  implode(",", $arr_ids);
		//echo "===".$ids."==";
		$merchant_id =  $_REQUEST['mer_id'];
		
		
		/*$Where_st .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1 and a.offers_left>0 ";*/
		$Where_st .= " AND ((CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1 and a.offers_left>0 )";
		$Where_st .= " or (  ( a.offers_left <=0  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date ) and  b.id not in (
								SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
								 WHERE (x.active=1 or x.active_in_future=1) and x.offers_left>0  ".$location_q.")and ((a.active_in_future<>1 and a.active=1) or (a.active_in_future=1 and a.active<>1))  and a.offers_left <=0))";
		if($merchant_info->fields['merchant_parent'] != 0)
		{
			$merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where=" a.location_id=".$merchant_info->fields['location_access'];
		}
		if($_SESSION['merchant_info']['merchant_parent'] == 0)
		 { 
		// echo "in if";
			$Sql = "SELECT distinct b.* , b.id campaign_id from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
					(b.created_by = $merchant_id or b.created_by in ( $ids))  $Where $date_str  $Where_st $lacation_str and b.id=".$_REQUEST['cid']." ORDER BY modified_date DESC";
			
		 }
		 else
		 {
			//	echo "in else";
			$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
					$Where $date_str $Where_st $lacation_str  and b.id=".$_REQUEST['cid']." ORDER BY modified_date DESC";
			
			
		 }
		//	 echo $Sql;
    $RS=$objDB->Conn->Execute($Sql);

      $json_array['status'] = "false";
      $json_array['total_records'] = $RS->RecordCount();
      $json = json_encode($json_array);

   echo $json;
   exit();
    
}
if(isset($_REQUEST['check_campaign_active']))
{
    $json_array=$records=array();
   /* $Where = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1  ";
    $Sql = "SELECT count(DISTINCT b.id) as total from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where
        b.id =". $_REQUEST['cid']." ".   $Where  ." ";
    $Sql="SELECT count(*) as total from campaigns where id =". $_REQUEST['cid']." AND NOW() BETWEEN start_date AND expiration_date";
   */
		$merchant_array = array();
		$merchant_array['id'] = $_REQUEST['mer_id'];
		$merchant_info = $objDB->Show("merchant_user",$merchant_array);
		$arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
		$ids=  implode(",", $arr_ids);
		
		// 13/08/2014 if no submerchant found then error in "in()" query
		
		if($ids=="")
		{
			$ids = $_REQUEST['mer_id'];
		}
		
		// 13/08/2014 if no submerchant found then error in "in()" query
		
		$merchant_id =  $_REQUEST['mer_id'];
		
		$Where="";
		$date_str="";
		$lacation_str="";
		$Where_st="";
		$location_q="";
		$Where_st .= " AND ((CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1 and a.offers_left>0 )";
		$Where_st .= " or (  ( a.offers_left <=0  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date ) and  b.id not in (
								SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
								 WHERE (x.active=1 or x.active_in_future=1) and x.offers_left>0  ".$location_q.") and ((a.active_in_future<>1 and a.active=1) or (a.active_in_future=1 and a.active<>1))  and a.offers_left <=0))";
		if($merchant_info->fields['merchant_parent'] != 0)
		{
			$merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info_c = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where="  a.location_id=".$merchant_info_c->fields['location_access'];
		}
		if($merchant_info->fields['merchant_parent'] == 0)
		 { 
			$Sql = "SELECT distinct b.* , b.id campaign_id from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
					(b.created_by = $merchant_id or b.created_by in ( $ids))  $Where $date_str  $Where_st $lacation_str and b.id=".$_REQUEST['cid']." ORDER BY modified_date DESC";
	

		 }
		 else
		 {
			$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
					$Where $date_str $Where_st $lacation_str  and b.id=".$_REQUEST['cid']." ORDER BY modified_date DESC";


			
		 }
		// echo $Sql;
		 $json = "";
	$RS=$objDB->Conn->Execute($Sql); 
	$json_array = array();
      $json_array['status'] = "false";
      $json_array['total_records'] = $RS->RecordCount();
      $json = json_encode($json_array);
 echo $json;
   exit();
 }

?>
<?php
// echo getmainmercahnt_id(68)."========";
function getmainmercahnt_id($id)
{
  //  echo "<br />In".$id;
    $objDB = new DB();
  /* $Sql = "select merchant_parent from merchant_user where id=".$id;
             $rs =$objDB->execute_query($Sql);*/
      	$rs =$objDB->Conn->Execute("select merchant_parent from merchant_user where id=?",array($id));

            if($rs->fields['merchant_parent'] == 0)
            {
               // echo "<br />In if".$id;
              //  echo $id;
	      
                return $id;
                
            }
            else
            {
               //  $objDB = new DB();
            //   echo "In else".$rs->fields['merchant_parent'];
                //$mainid= $rs->fields['merchant_parent'];
              return   getmainmercahnt_id($rs->fields['merchant_parent']);
                //call_user_func("get_main_merchant_id",$mainid);
                
            }
}
/******** 
@USE : get parent merchant id for employee
@PARAMETER : current login merchant id
@RETURN : parent merchant id for employee
@USED IN PAGES : my-profile.php , manage-customers.php , templates.php
*********/
if(isset($_REQUEST['getmainmercahnt_id']))
{
     //  echo "<br />In".$id;
     $mid=getmainmercahnt_id($_REQUEST['mer_id']);
    
	$json_array = array();
	$json_array['status'] = "true";
	 $json_array['main_merchant_id'] = $mid;
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
               
           
}

function getMainOneLevel($id)
{
  
    $objDB = new DB();
   /*$Sql = "select merchant_parent from merchant_user where id=".$id;
             $rs =$objDB->execute_query($Sql);*/
		 $rs =$objDB->Conn->Execute("select merchant_parent from merchant_user where id=?",array($id));

	     $main_array=array();
      
             if($rs->fields['merchant_parent'] == 0)
	     {
		return $main_array;
	     }
	     else
	     {
		$main_array[]=$rs->fields['merchant_parent'];
		return $main_array; 
	     }
             
}
function getallmainmercahnt_id($id)
{
   
    $tree1 = Array();
    if (!empty($id)) {
        $tree1 = getMainOneLevel($id);
        foreach ($tree1 as $key => $val) {
            $ids1 = getallmainmercahnt_id($val);
            $tree1 = array_merge($tree1, $ids1);
        }
    }
    return $tree1;
}
/******** 
@USE : Get all parent merchants hierarchy of current login employee 
@PARAMETER : current login merchant id
@RETURN :  array of merchant id
@USED IN PAGES : compaigns.php, manage-users.php , manage-customers.php , manage-marketing-material.php
*********/
if(isset($_REQUEST['getallmainmercahnt_id']))
{
     $mid=getallmainmercahnt_id($_REQUEST['mer_id']);
     $midr_str=implode(",",$mid);
	$json_array = array();
	$json_array['status'] = "true";
	 $json_array['all_main_merchant_id'] = $midr_str;
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
               
           
}

//print_r(getallsubmercahnt_id(17));
function getOneLevel($id){
    $objDB = new DB();
    /*$s = "select * from merchant_user where merchant_parent =".$id;
    $r = $objDB->execute_query($s);*/
	 $r = $objDB->Conn->Execute("select * from merchant_user where merchant_parent =?",array($id));

    $mer_id=array();
    if($r->RecordCount()>0){
        while($row = $r->FetchRow()){
            $mer_id[]=$row['id'];
        }
    }   
    return $mer_id;
}
function getallsubmercahnt_id($id)
{
   
    $tree = Array();
    if (!empty($id)) {
        $tree = getOneLevel($id);
        foreach ($tree as $key => $val) {
            $ids = getallsubmercahnt_id($val);
            $tree = array_merge($tree, $ids);
        }
    }
    return $tree;
}


/******** 
@USE : Get all sub merchant of current login employee 
@PARAMETER : current login merchant id
@RETURN :  array of merchant id
@USED IN PAGES : compaigns.php , purchase-points.php, redeem-deal.php , manage-customers.php ,media-management.php , my-profile.php,manage-users.php
*********/
if(isset($_REQUEST['getallsubmercahnt_id']))
{
     
    $arr=getallsubmercahnt_id($_REQUEST['mer_id']);
    
    //print_r($arr);
    $arr_str=implode(",",$arr);
    $json_array = array();
     $json_array['all_sub_merchant_id'] = $arr_str;
     $json = json_encode($json_array);
     echo $json;
     exit();
               
           
}

/******** 
@USE : check whether number active campaign reached or not for current month
@PARAMETER : current login merchant id
@RETURN : Total number of active campaign of current month
@USED IN PAGES : my-profile.php , template.php, compaigns.php
*********/
if(isset($_REQUEST['num_campaigns_per_month']))
{
 //   echo "In";
    $json_array = array();
	$array_where_mb=array();
    $array_where_mb['id'] = getmainmercahnt_id($_REQUEST['mer_id']);
    $RS_mb = $objDB->Show("merchant_user", $array_where_mb);
	//print_r($RS_mb);
	
    $arr_package = array();
    $arr_package['merchant_id'] = getmainmercahnt_id($_REQUEST['mer_id']);
    $RS_package = $objDB->Show("merchant_billing", $arr_package);
    if($RS_package->RecordCount()>0)
    {
			$array_where_bp=array();
            $array_where_bp['id'] = $RS_package->fields['pack_id'];
            $RS_bp = $objDB->Show("billing_packages", $array_where_bp);
            $total_campaigns = $RS_bp->fields['total_no_of_camp_per_month'];
    }
//    $merchant_id =getmainmercahnt_id($_REQUEST['mer_id']);
//    
//    $curr_month = date('m');
//    $start_date=date('Y')."-".date('m')."-01 00:00:00";
//    $end_date=date('Y')."-".date('m')."-31 23:59:59";
//    $Where = " and b.created_date between '".$start_date ."' and '".$end_date."' ";
//		 $Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
//                    b.created_by = $merchant_id   $Where ORDER BY modified_date DESC";
//             
//                  $RS_count = $objDB->Conn->Execute($Sql);
                    
//    echo "<pre>";
//    print_r($RS_mb);
//    echo "</pre>";
           
                  if($RS_mb->fields['total_no_of_campaign'] != 0)
                  {
                      $json_array['status'] = "true";
                  }else{
                     
                      $json_array['status'] = "false";
                  }
                  
                  $json_array['max_campaigns'] = $total_campaigns;
                   $json_array['total_records'] = $RS_mb->fields['total_no_of_campaign'];
      $json = json_encode($json_array);
    
   echo $json;

            
   exit();

}
// check whether num activation campaign reached or not 
/***** 
@USE : Number of active campaigns for individual location
@PERAMETER : location id
@RETURN : return active campaign list for give location
@USED IN PAGES :  locations.php
******/

if(isset($_REQUEST['btnGetAllactiveCampaignOfMerchantLocation']))
{
  $json_array = array();
  $records = array();
  
  $merchant_id = $_REQUEST['mer_id'];
  $location_id = $_REQUEST['loc_id'];
 
  $today_date = date("Y-m-d")." 00:00:00";
  $Where = "";
  
  $Where .= " and c.id=".$location_id." AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1";
             
 /* $Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    b.created_by = $merchant_id   $Where ORDER BY modified_date DESC";
 
  $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    b.created_by = ?   $Where ORDER BY modified_date DESC",array($merchant_id));

  if($RS->RecordCount()>0)
  {   
    $json_array['status'] = "true";
    $json_array['total_records'] = $RS->RecordCount();
    $count=0;
    while($Row = $RS->FetchRow())
    {
      $records[$count] =get_field_value($Row);
      $count++;
    }
    $json_array["records"]= $records;
  }
  else
  {
    $json_array['status'] = "false";
    $json_array['total_records'] = 0;
    $json = json_encode($json_array);
    echo $json;
    exit();
  }
  $json = json_encode($json_array);
  echo $json;
  exit();
}
if(isset($_REQUEST['btnGetAllactiveCampaignOfMerchantLocationNew']))
{
  $json_array = array();
  $records = array();
  
  //$merchant_id = $_REQUEST['mer_id'];
  $location_id = $_REQUEST['loc_id'];
 
  $today_date = date("Y-m-d")." 00:00:00";
  $Where = "";
  
  $Where .= " c.id=".$location_id." AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1";
             
  $Sql = "SELECT distinct b.id from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where $Where ORDER BY c.modified_date DESC";
 
  $RS = $objDB->Conn->Execute($Sql);
  if($RS->RecordCount()>0)
  {   
    $json_array['status'] = "true";
    $json_array['total_records'] = $RS->RecordCount();
    $count=0;
    while($Row = $RS->FetchRow())
    {
      $records[$count] =get_field_value($Row);
      $count++;
    }
    $json_array["records"]= $records;
  }
  else
  {
    $json_array['status'] = "false";
    $json_array['total_records'] = 0;
    $json = json_encode($json_array);
    echo $json;
    exit();
  }
  $json = json_encode($json_array);
  echo $json;
  exit();
}

/******** 
@USE : Number of active campaigns for individual distribution list
@PARAMETER : distribution list id
@RETURN : total numer of avtive campaigns
@USED IN PAGES :  manage-customers.php
*********/
if(isset($_REQUEST['btnGetAllactiveCampaignOfMerchantLocationGroup']))
{
  $json_array = array();
  $records = array();
  
  $merchant_id = $_REQUEST['mer_id'];
  $location_id = $_REQUEST['loc_id'];
  $group_id = $_REQUEST['groupid'];
  
  $today_date = date("Y-m-d")." 00:00:00";
  $Where = "";
  
  $Where .= " and c.id=".$location_id." and (a.active =1 or a.active_in_future=1 or (b.start_date  > CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) )";
 // $Where .= "  AND (((( b.start_date  > CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) )) or   a.active_in_future =1 and a.offers_left>0 ) and  b.id not in (
///SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 //WHERE x.active=1 and x.offers_left>0 ) and a.active <> 1   "; 
  
 
  /*$Sql="SELECT distinct b.* 
from campaign_groups cg,campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id 
where cg.campaign_id=b.id and cg.campaign_id=a.campaign_id and cg.group_id=$group_id  $Where ORDER BY modified_date DESC";

  $RS = $objDB->Conn->Execute($Sql);*/
	$RS = $objDB->Conn->Execute("SELECT distinct b.* 
from campaign_groups cg,campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id 
where cg.campaign_id=b.id and cg.campaign_id=a.campaign_id and cg.group_id=?  $Where ORDER BY modified_date DESC",array($group_id));

  if($RS->RecordCount()>0)
  {   
    $json_array['status'] = "true";
    $json_array['total_records'] = $RS->RecordCount();
    $count=0;
    while($Row = $RS->FetchRow())
    {
      $records[$count] =get_field_value($Row);
      $count++;
    }
    $json_array["records"]= $records;
  }
  else
  {
    $json_array['status'] = "false";
    $json_array['total_records'] = 0;
    $json_array["records"] = "";
    $json = json_encode($json_array);
    echo $json;
    exit();
  }
  $json = json_encode($json_array);
  echo $json;
  exit();
}

/***** 
@USE : get all camapigns of current year. It Includes all submerchant's created campaign 
@PERAMETER : current login user
@RETURN : json of campaigns with all reqired information
@USED IN PAGES : compaigns.php , reports.php
******/
if(isset($_REQUEST['btnGetAllCampaignOfMerchant_allmonths']))
{
	$json_array = array();
	$records = array();
	
	$all_sub_mer_array = $_REQUEST['all_sub_mer_array'];
	
	$all_main_mer_array = $_REQUEST['all_main_mer_array'];
	
	$ass_page =$_REQUEST['ass_page'];

	$addcampaign_status =$_REQUEST['addcampaign_status']; 

	$merchant_parent_value = $_SESSION['merchant_info']['merchant_parent'];
	$array1['id'] = $merchant_parent_value;
	$RS1 = $objDB->Show("merchant_user", $array1);

	/* 
	 * Paging
	 */
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}

	if(isset($_REQUEST['location_id']))
	{
		 if($_REQUEST['location_id'] != 0)
		 {
			$location_str = " and c.id=".$_REQUEST['location_id'];
			$location_q = " and x.location_id=".$_REQUEST['location_id'] ." ";
		 }
		 else{
			$location_str ="";
			$lacation_q = "";
		 }
	}
	else
	{
		$lacation_str = "";
	}

		
	$Where_st = "";
	$action = $_REQUEST['status'];
	$action = $_REQUEST['status'];
	
	 if($action == "active")
	 {

             $Where_st .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1 and a.offers_left>0 ";
           
             
	}elseif($action == "expired"){
	
	       $Where_st .= " AND b.expiration_date <  CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1))  and b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(z.timezone,1, POSITION(',' IN z.timezone)-1) ".$location_q.") BETWEEN y.start_date and y.expiration_date and ( x.active_in_future<>1 OR x.active=1 ) ) and a.active_in_future<>1 and a.active<>1 ";
		
	}elseif($action == "activeinfuture"){
	
	        $Where_st .= "  AND (((( b.start_date  > CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) )) or   a.active_in_future =1 and a.offers_left>0 ) and  b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE x.active=1 and x.offers_left>0  ".$location_q." ) and a.active <> 1   ";
        }elseif($action == "endcampaigns"){
	        
            $Where_st .= "  AND ( a.offers_left <=0  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date ) and  b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE (x.active=1 or x.active_in_future=1) and x.offers_left>0  ".$location_q.")and (a.active_in_future<>1 and a.active=1) or (a.active_in_future=1 and a.active<>1)  and a.offers_left <=0";
            
        }else{
		$Where_st = "";
	}
	 $merchant_id = $_REQUEST['mer_id'];
	 //$action=$_REQUEST['action'];
         $arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
		 $ids=  implode(",", $arr_ids);
         if($ids=="")
         $ids=$_REQUEST['mer_id'];
	 $today_date = date("Y-m-d")." 00:00:00";
	 $Where = "";
         $date_str = "";
	$last_month_date = date('Y-m-d', strtotime(date('Y-m-d')) - 60*60*24*30)." 00:00:00";
	 //$date_str .=  " and  (b.created_date>='".$last_month_date."' AND b.created_date<=NOW()) ";
	 $y = date("Y");
	 $m = date("m");
	  $from_date = date("Y")."-01-01 00:00:00";
    $to_date =  date("Y")."-12-31 23:59:59";


//	 $date_str .=" and  (b.created_date>='$from_date' AND b.created_date<='$to_date') ";
	 if($_REQUEST['year'] != 0 && $_REQUEST['month'] != 0)
	{
		$from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
	    $to_date =  $_REQUEST['year']."-".$_REQUEST['month']."-31 23:59:59";
	}
	else if($_REQUEST['year'] != 0 && $_REQUEST['month'] == 0)
	{
		$from_date = $_REQUEST['year']."-01-01 00:00:00";
    	$to_date =  $_REQUEST['year']."-12-31 23:59:59";
	}
    else if($_REQUEST['year'] == 0 && $_REQUEST['month'] != 0)
    {        
		//for($y=2000;$y<=date('Y');$y++)
		for($y=date('Y');$y<=date('Y')+2;$y++)
		{  
			$date_str .=  " (b.created_date>='".$y."-".$_REQUEST['month']."-01 00:00:00' AND b.created_date<='".$y."-".$_REQUEST['month']."-31 00:00:00' ) ";			
			if($y != date('Y'))
			{
				$date_str .= " || ";
			}
		}       
    }
    else if($_REQUEST['year'] == 0 && $_REQUEST['month'] == 0)
	{
			
	}

	$date_str .=" and  (b.created_date>='$from_date' AND b.created_date<='$to_date') ";

	$cat_wh = "";
	if($_REQUEST['category']!=0)
	{
		$cat_wh = "b.category_id=".$_REQUEST['category']." and ";
	}
		
		$merchant_array = array();
		$merchant_array['id'] = $_REQUEST['mer_id'];
		$merchant_info = $objDB->Show("merchant_user",$merchant_array);
		
		 if($merchant_info->fields['merchant_parent'] == 0)
		 { 
		 
         	/*$Sql = "SELECT distinct b.* , b.id campaign_id ,(select cat_name from categories where id=b.category_id) category_name from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    (b.created_by = $merchant_id or b.created_by in ( $ids))  $Where $date_str  $Where_st $lacation_str ORDER BY modified_date DESC";*/
		$Sql = "SELECT SQL_CALC_FOUND_ROWS distinct b.id,b.title,b.start_date,b.expiration_date,b.created_by , b.id campaign_id ,(select cat_name from categories where id=b.category_id) category_name from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where $cat_wh 
                    (b.created_by = $merchant_id or b.created_by in ( $ids))  $Where $date_str  $Where_st $location_str ORDER BY b.modified_date DESC ".$sLimit;
		$RS = $objDB->Conn->Execute($Sql);
		$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
		$total= $sQuery->fields['FOUND_ROWS()'];

		 }
		 else
		 {
		
			$merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where=" a.location_id=".$merchant_info->fields['location_access'];

			/*$Sql = "SELECT distinct b.* , b.id campaign_id ,(select cat_name from categories where id=b.category_id) category_name from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    $Where $date_str $Where_st $lacation_str ORDER BY modified_date DESC";*/
		$Sql = "SELECT SQL_CALC_FOUND_ROWS distinct b.id,b.title,b.start_date,b.expiration_date,b.created_by , b.id campaign_id  ,(select cat_name from categories where id=b.category_id) category_name from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where $cat_wh 
                    $Where $date_str $Where_st $location_str ORDER BY b.modified_date DESC ".$sLimit;
			
			$RS = $objDB->Conn->Execute($Sql);
	$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
		$total= $sQuery->fields['FOUND_ROWS()'];
		 }

	 

		$Json = array();
                $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
                $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
               $Json['iTotalDisplayRecords'] = $total;
                $Json['sEcho'] = $_REQUEST['sEcho'];
                //$Json['sSearch'] = $_REQUEST['sSearch'];
                $Json['aaData'] = array();
		//print_r($RS->FetchRow());exit;
		if($RS->RecordCount()>0)
	 	{
			$k =0;
			while($Row = $RS->FetchRow())
		 	{
				$Json['aaData'][$k][]='<a href="javascript:void(0)" id="showCamp_'.$Row['id'].'">'.$Row['title'].'</a>';
				$Json['aaData'][$k][]= $Row['category_name'];
				$Json['aaData'][$k][]= date("Y-m-d g:i:s A", strtotime($Row['start_date']));
				$Json['aaData'][$k][]= date("Y-m-d g:i:s A", strtotime($Row['expiration_date']));

				$maction = '';
				if (in_array($Row['created_by'], $all_main_mer_array)) {
                                    if ($_REQUEST['action'] == "expired") {

                                            if (in_array("copy-compaign.php", $ass_page)) {
                                                   $maction = 'More Action';
					    } else { 
						 $maction = '<span class="disable_moreaction" >More  Actions</span>';
						
                                            }
                                    } else {
                                            $maction = '<span class="disable_moreaction" >More  Actions</span>';
                                    }
                            } else if (!in_array($Row['created_by'], $all_main_mer_array) && !in_array($Row['created_by'], $all_sub_mer_array) && $Row['created_by'] != $_SESSION['merchant_id']) { 
                                    if ($_REQUEST['action'] == "expired") {
                                            
                                            if (in_array("copy-compaign.php", $ass_page)) { //echo "8";
                                                    $maction = 'More Action';  } else {

                                                     $maction = '<span class="disable_moreaction" >More  Actions</span>';
                                            }
                                    } else { 
                                             $maction = '<span class="disable_moreaction" >More  Actions</span>';
                                    }
                            } else { 
                                    if (in_array("add-compaign.php", $ass_page) || $_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("copy-compaign.php", $ass_page)) {
                                            
                                             $maction = 'More  Actions';
                                    } else {
                                             $maction = '<span class="disable_moreaction" >More  Actions</span>';
                                    }
                            }

				$actionData = '';
				$actionData .= '<div class="action_wrapper">';
				if ($merchant_parent_value == 0) {

                                if ($Row['approve'] == 2) {
                                        
                                } else {
                                       $actionData .= '<div id="actiondiv" class="actiondivclass" >'; 
                                            
                                            if ($_REQUEST['action'] == "expired") {
                                                    if ($addcampaign_status == "true") {
                                                            
                                                           $actionData .= '<a link="copy-compaign.php?id='.$Row['id'].'" href="javascript:void(0);" class="copy commonclass">Copy</a>';
                                                            
                                                    } else {
                                                           
                                                           $actionData .= '<a  href="javascript:void(0)" class="addcampaign_chk scopy">Copy</a>';
                                                           
                                                    }
                                                    
                                            } else {
                                                    if ($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("edit-compaign.php", $ass_page)) {
                                                            if (in_array($Row['created_by'], $all_main_mer_array)) {
                                                                    
                                                            } else {
                                                                    
                                                                    $actionData .='<a class="commonclass" link="edit-compaign.php?id='.$Row['id'].'" href="javascript:void(0);">Edit</a>';
                                                                    
                                                            }
                                                    }
                                                    
                                                    if ($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("delete-compaign.php", $ass_page)) {
                                                            
                                                    }
                                                    
                                                    if ($_REQUEST['action'] != "endcampaigns") {
                                                            if (in_array($Row['created_by'], $all_main_mer_array)) {
                                                                    
                                                            } else {
                                                                    
                                                                    $actionData .= '<a href="javascript:void(0)"  class="expire" id="expireCamp_'.$Row['id'].'">Pause</a>';
                                                                    
                                                            }
                                                    }
                                                     } 
                                        $actionData .= '</div>';

                                }
                        } else {
				
                                if ($RS1->fields['approve'] == 2) {
                                        $actionData .= '<div  id="actiondiv" class="actiondivclass" >';
                                            if ($_REQUEST['action'] == "expired") {
                                                    
                                                    if ($addcampaign_status == "true") {
                                                            $actionData .= '<a link="copy-compaign.php?id='.$Row['id'] .'"  href="javascript:void(0);" class="copy commonclass">Copy</a>';
                                                            
                                                    } else {
                                                            $actionData .= '<a href="javascript:void(0)" class="addcampaign_chk scopy">Copy</a>';
                                                            
                                                    }
                                                    
                                            } else {
                                                    if (in_array($Row['created_by'], $all_main_mer_array)) {
                                                            
                                                    } else {
                                                            $actionData .= '<a  href="javascript:void(0)"  class="expire" id="expireCamp_'. $Row['id'].'">Pause</a>';
                                                           
                                                    }
                                            }
                                            
                                        $actionData .= '</div>';

                                } else {
                                        
                                        if ($_REQUEST['action'] == "expired") {
                                                if ($addcampaign_status == "true") {
                                                        if ($_SESSION['merchant_info']['merchant_parent'] == 0) {
                                                                
                                                                $actionData .= '<div id="actiondiv" class="actiondivclass"> ';
                                                                    $actionData .= '<a link="copy-compaign.php?id='. $Row['id'].'"  href="javascript:void(0);" class="copy commonclass">Copy</a>';
                                                                $actionData .= '</div>';
                                                                
                                                        } else {
                                                                if (in_array("copy-compaign.php", $ass_page)) {
                                                                        
                                                                        $actionData .= '<div id="actiondiv" class="actiondivclass">'; 
                                                                            $actionData .= '<a link="copy-compaign.php?id='. $Row['id'].'" href="javascript:void(0);" class="copy commonclass">Copy</a> ';
                                                                        $actionData .= '</div>';
                                                                        
                                                                } else {
                                                                        
                                                                }
                                                        }
                                                       
                                                } else {
                                                        
                                                }
                                        } else {
						
                                                if ($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-compaign.php", $ass_page)) {			
                                                        
                                                        if (in_array($Row['created_by'], $all_main_mer_array)) {
								
                                                                if ($_REQUEST['action'] == "expired") {
                                                                        if (in_array("copy-compaign.php", $ass_page)) {
                                                                                $actionData .= '<div id="actiondiv" class="actiondivclass" >'; 
                                                                                    $actionData .= '<a class="commonclass" link="edit-compaign.php?id='.$Row['id'].'" href="javascript:void(0);">Edit</a>';


                                                                                    
                                                                                    if ($_REQUEST['action'] != "endcampaigns") {
                                                                                            if (in_array($Row['created_by'], $all_main_mer_array)) {
                                                                                                    
                                                                                            } else {
                                                                                                    $actionData .= '<a href="javascript:void(0)"  class="expire" id="expireCamp_<?= $Row->id ?>">Pause</a>';
                                                                                            }
                                                                                    }
                                                                                    
                                                                                $actionData .= '</div>';

                                                                        } else {
                                                                        }
                                                                } else {
                                                                       
                                                                }
                                                        } else if (!in_array($Row['created_by'], $all_main_mer_array) && !in_array($Row['created_by'], $all_sub_mer_array) && $Row['created_by'] != $_SESSION['merchant_id']) {
                                                               
                                                        } else {
                                                              
                                                                if (in_array("add-compaign.php", $ass_page) || $_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("copy-compaign.php", $ass_page)) {
                                                                       
                                                                        $actionData .= '<div id="actiondiv" class="actiondivclass" >'; 
                                                                            $actionData .= '<a class="commonclass" link="edit-compaign.php?id='. $Row['id'].'" href="javascript:void(0);">Edit</a>';

                                                                            if ($_REQUEST['action'] != "endcampaigns") {
                                                                                    if (in_array($Row['created_by'], $all_main_mer_array)) {
                                                                                            
                                                                                    } else {
                                                                                            $actionData .= '<a href="javascript:void(0)"  class="expire" id="expireCamp_'. $Row['id'].'">Pause</a>';

                                                                                    }
                                                                            }
                                                                            $actionData .= '</div>';
                                                                        
                                                                } else {
                                                                        
                                                                }
                                                        }
                                                }
                                                 if ($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("delete-compaign.php", $ass_page)) {
                                                       
                                                }
                                                } 
                                }
                        }
				$actionData .= '</div>';

				$Json['aaData'][$k][]= $maction.$actionData;
				$k++;
			}
		}
		echo json_encode($Json);
         
        	exit;

	 
}
/**** for all months of current year *****/
/* for last 30 days campaigns */

if(isset($_REQUEST['btnGetAllCampaignOfMerchant_last3odays']))
{
	 $json_array = array();
	 $records = array();
	 if($_REQUEST['location_id'] != "")
	 {
		$lacation_str = " and c.id=".$_REQUEST['location_id'];
	 }
	 else{
		$lacation_str = "";
	 }
	$action = $_REQUEST['status'];
	 $action = $_REQUEST['status'];
	//echo "<br />".$_REQUEST['status']."<br />";
	 if($action == "active")
	 {
//	 echo "1";
	//	$Where_st .= " AND CONVERT_TZ(NOW(),'-06:00','+00:00') BETWEEN CONVERT_TZ(b.start_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) AND CONVERT_TZ(b.expiration_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) and a.active =1 and a.active_in_future<>1";
            
             $Where_st .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1 and a.offers_left>0 ";
            //$Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1";
             
	}elseif($action == "expired"){
	if($_REQUEST['location_id'] != "0")
	 {
		$location_q = " and x.location_id=".$_REQUEST['location_id'] ." ";
	 }
	 else{
		$location_q = "";
	 }
	       $Where_st .= " AND b.expiration_date <  CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1))  and b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(z.timezone,1, POSITION(',' IN z.timezone)-1) ".$location_q.") BETWEEN y.start_date and y.expiration_date and ( x.active_in_future<>1 OR x.active=1 ) ) and a.active_in_future<>1 and a.active<>1 ";
		
	}elseif($action == "activeinfuture"){
	if($_REQUEST['location_id'] != "0")
	 {
		$location_q = " and x.location_id=".$_REQUEST['location_id'] ." ";
	 }
	 else{
		$location_q = "";
		}
	        $Where_st .= "  AND (((( b.start_date  > CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) )) or   a.active_in_future =1 and a.offers_left>0 ) and  b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE x.active=1 and x.offers_left>0  ".$location_q." ) and a.active <> 1   ";
        }elseif($action == "endcampaigns"){
	        if($_REQUEST['location_id'] != "0")
	 {
		$location_q = " and x.location_id=".$_REQUEST['location_id'] ." ";
	 }
	 else{
		$location_q = "";
		}
            $Where_st .= "  AND ( a.offers_left <=0  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date ) and  b.id not in (
SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
 WHERE (x.active=1 or x.active_in_future=1) and x.offers_left>0  ".$location_q.")and (a.active_in_future<>1 and a.active=1) or (a.active_in_future=1 and a.active<>1)  and a.offers_left <=0";
            //$Where .= "  AND ( (a.num_activation_code - (select count(*) from coupon_codes where location_id=a.campaign_id)) <=0  AND CONVERT_TZ(NOW(),'-06:00','+00:00') BETWEEN CONVERT_TZ(b.start_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) AND CONVERT_TZ(b.expiration_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) and a.active_in_future<>1 and a.active<>1 ";
        }else{
			$Where_st = "";
		}
	 $merchant_id = $_REQUEST['mer_id'];
	 //$action=$_REQUEST['action'];
         $arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
		 $ids=  implode(",", $arr_ids);
         if($ids=="")
             $ids=$_REQUEST['mer_id'];
	 $today_date = date("Y-m-d")." 00:00:00";
	 $Where = "";
         $date_str = "";
	$last_month_date = date('Y-m-d', strtotime(date('Y-m-d')) - 60*60*24*30)." 00:00:00";
	 //$date_str .=  " and  (b.created_date>='".$last_month_date."' AND b.created_date<=NOW()) ";
	 $y = date("Y");
	 $m = date("m");
	 $date_str .=  "  and  (b.created_date>='".$y."-".$m."-01 00:00:00' AND b.created_date<='".$y."-".$m."-31 00:00:00' ) ";
        /*
	 if(isset($_REQUEST['parent']))
	 {
		//$Sql = "SELECT * FROM campaigns WHERE (created_by = $merchant_id or created_by in ( select id from merchant_user where merchant_parent = $merchant_id )) $Where ORDER BY modified_date DESC";
                $Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    (b.created_by = $merchant_id or b.created_by in ( select id from merchant_user where merchant_parent = $merchant_id))  $Where $date_str ORDER BY modified_date DESC";
                
	 }
	 else
	 {
		//$Sql = "SELECT * FROM campaigns WHERE created_by = $merchant_id $Where ORDER BY modified_date DESC";
		 $Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    b.created_by = $merchant_id   $Where $date_str ORDER BY modified_date DESC";
	 }
         
         */
		
		 $merchant_array = array();
		$merchant_array['id'] = $_REQUEST['mer_id'];
		$merchant_info = $objDB->Show("merchant_user",$merchant_array);
		//print_r($_SESSION);
	//	echo $_SESSION['merchant_id']."==".$_REQUEST['mer_id']."===".$merchant_info->fields['merchant_parent'];
		 if($merchant_info->fields['merchant_parent'] == 0)
		 { 
		 //echo "<br />I N If <br />";
         	$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    (b.created_by = $merchant_id or b.created_by in ( $ids))  $Where $date_str  $Where_st $lacation_str ORDER BY modified_date DESC";
		

		 }
		 else
		 {
		// echo "<br />I N else <br />";
			$merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where=" a.location_id=".$merchant_info->fields['location_access'];
			$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    $Where $date_str $Where_st $lacation_str ORDER BY modified_date DESC";
			
			
		 }
	
	 $RS = $objDB->Conn->Execute($Sql);
	 if($RS->RecordCount()>0)
	 {
		 
		 
		  $json_array['status'] = "true";
		  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] =get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}
/* */

if(isset($_REQUEST['displaymail']))
{
    //$campaign_id = 411;
     /*$sql_customers = " select u.* from customer_user u , customer_email_settings e where 
u.id=e.customer_id and e.subscribe_merchant_new_campaign=1 and u.id in(select ms.user_id from merchant_subscribs ms where ms.group_id in
( select group_id from campaign_groups where campaign_id=".$campaign_id.") )";
      //  echo $sql_customers."==<br />";
        $RS_allusers = $objDB->Conn->Execute($sql_customers);	*/
	$RS_allusers = $objDB->Conn->Execute(" select u.* from customer_user u , customer_email_settings e where 
u.id=e.customer_id and e.subscribe_merchant_new_campaign=? and u.id in(select ms.user_id from merchant_subscribs ms where ms.group_id in
( select group_id from campaign_groups where campaign_id=?) )",array(1,$campaign_id));

        while($Row_cust = $RS_allusers->FetchRow())
        {
             $mail = new PHPMailer();
      

      
      $array1 = $json_array = array();
      $array1['id'] = $campaign_id ;
      $RS_campaigns = $objDB->Show("campaigns",$array1);
      
      $array2 = $json_array = array();
      $array2['id'] =  $_SESSION['merchant_id'] ;
      $RS_camp_mer = $objDB->Show("merchant_user",$array2);
       
            $body = "<p><br/><br/>";
            if($Row_cust['firstname'] == "" && $Row_cust['firstname'] == "" )
            {
                $body .= "Dear Customer,</p>";
            }
            else{
            $body .= $Row_cust['firstname']." ".$Row_cust['lastname']." ,</p>";
            }
            $body .= "<p>Please review exclusive deal near you from Scanflip merchants .</p>";     
            /* */
            $body .="<div id='dealslist'>";
            $body .="<div class='offersexyellow' style='background: none repeat scroll 0 0 #EBEBEB !important;border: 1px solid #D1D1D1;color: #000000;margin: 2px 0 10px;padding: 5px 5px 10px;position: relative;'>";
                             $body .="<div id='campaign_detail'>";
                         $body .="<p style='text-align:right;width:645px; margin :0 auto'>";
                            $body .="<img alt='Scanflip' src='".ASSETS_IMG."/c/header-logo_new1.png'>";
                            $body .="</p>";	
                        $body .="<div class='offerstrip' style='font-size:18px;background:#fff; width:630px;padding-left:15px;margin :0 auto'></div>";
                       			
						
					$body .="<div style='overflow:hidden;padding:15px; width:615px; background:#fff; margin :0 auto'>";
	
						$body .="<div class='other_details' style='float: right;width:450px; '>";
							
	                         $body .="<div class='dealtitle' style='border-bottom: 1px dashed #C8C8C8;font-size: 19px;overflow: hidden;text-align: justify;'><b>".$RS_campaigns->fields['title']."</b></div>";
							 
							$body .="<div class='percetage' style='float:left;color: #000000;font-family: Arial;font-size: 16px;line-height: 25px;overflow: hidden;padding: 4px 85px 7px 0;text-shadow: 1px 1px 1px #A09F9F;'>";
                                                        //$urltitle=WEB_PATH."/location_detail.php?id=".$RS_location->fields['id'];
                                                        //$body .="<a href='".$urltitle."'>".$RS_location->fields['location_name']."</a>";
                                                        // $body .=$RS_location->fields['location_name'];
                                                        $body .= "Participating location";
                                                        $body .= "</div><div style='clear:both;margin: -8px 0 0;overflow: hidden;padding: 0px; float:left;' class='counter'>";
                                                        $array2 = $json_array = array();
                                                        $array2['campaign_id'] = $campaign_id ;
                                                        $RS_location_list = $objDB->Show("campaign_location",$array2);
                                                        
                                                        while($location_detail = $RS_location_list->FetchRow())
                                                        {
                                                            $array2 = $json_array = array();
                                                            $array2['id'] = $location_detail['location_id'] ;
                                                            $RS_location = $objDB->Show("locations",$array2);
                                                            
                                                            	$address = "Location : ".$RS_location->fields['address'].", ".$RS_location->fields['city'].", ".$RS_location->fields['state'].", ".$RS_location->fields['zip'].", ".$RS_location->fields['country'];
                                                                if($RS_location->fields['phone_number']!="")
                                                                {
                                                                    $phno = "Phone Number : ".$RS_location->fields['phone_number'];
                                                                }
                                                                else
                                                                {
                                                                    $phno = "Phone Number : ".$RS_camp_mer->fields['phone_number'];
                                                                }
                                                                
								
								$body .= "<div style='margin-top:5px;float:left'>";
								$body .= $address ;
								$body .= "</div>";
                                                                
                                                                $body .="<div style='margin-top:5px;float:left'>";
								$body .="&nbsp;&nbsp;&nbsp;&nbsp;".$phno;
								$body .="</div>";
                                                                
                                                                $body .="<div style='margin-top:5px;float:left'>";
								$body .="&nbsp;&nbsp;&nbsp;&nbsp;"."<a href='".WEB_PATH."/campaign.php?campaign_id=".$campaign_id."&l_id=".$RS_location->fields['id']."'>View deal</a>";
								$body .="</div>";
                                                            
                                                        }
                                                        
                                                        
                                                        $body .= "</div>";
	
	
							$body .= "<div class='counter' style='clear:both;margin: -8px 0 0;overflow: hidden;padding: 0px; float:left;'>";	
							$body .= "<div style='clear:both'>";
	
								
								
								

								
//								 $from_lati=$_SESSION['mycurrent_lati'];
//                
//								$from_long=$_SESSION['mycurrent_long'];
//								
//								$to_lati=$RS_location->fields['latitude'];
//								
//								$to_long=$RS_location->fields['longitude'];
//								
//								$maphref="http://maps.google.com/maps?saddr=&daddr=".$to_lati.",".$to_long;
								
								
								
								
	
	
	
							$body .="</div>";
                                                        
							
							
                                                        $body .="</div>";
						$body .="</div>";
							$body .="<p class=image_det' style='border: 3px solid #BBBBBB;float: left;margin: 0 !important;overflow: hidden;padding: 0 !important;width: 130px;'>";
							
							if($RS_campaigns->fields['business_logo']!="")
							{
							    $img_src=ASSETS_IMG."/m/campaign/".$RS_campaigns->fields['business_logo']; 
							}
                        				else 
							{
							    $img_src=ASSETS_IMG."/m/default_campaign.jpg";
							}
                        
							
                        
							$body .="<img style='border: 5px solid #FFFFFF;height: auto !important;ax-width: 293px;width: 130px !important;' border='0' src='".$img_src."'>";
							$body .="</p>";
							
							
							
							
						$body .="</div>";
                                                
                                                
                                                
                                                
                                                $body .="<div style='width:630px !important; margin: 0 auto; padding-top:10px; '>";
		     
			$body .="<img alt='Scanflip' src='".ASSETS_IMG."/c/header-logo_new1.png'>";
			$body .="<br>";
			$body .="Powering Smart Savings From Local Merchants";
		$body .="</div>";
                
                                                
                                                
                                                
						
					$body .="</div>";
                                        
                                        
                                        
                                         
				$body .="</div>";
                                
		       	$body .="</div>";
                        $body .= "<p >Thanks, </p>";
                
                $body .= "<p >". $_SESSION['customer_info']['firstname']." ".$_SESSION['customer_info']['lastname']." </p>";
		$body .="</div>";
	echo $body;				
            /* */
            
            $body .="Sincerely<br/><br/>Scanflip Support Team<br/>Powering smart savings from local merchants";
            $mail->AddReplyTo('no-reply@scanflip.com','ScanFlip Support');
          $mail->AddAddress("abababab778@gmail.com");
            $mail->From = "no-reply@scanflip.com";
            $mail->FromName = "ScanFlip Support";
            $mail->Subject    = "Scanflip Merchant Exclusive Offers ";
           // echo $body."===".$Row_cust['emailaddress'];
            $mail->MsgHTML($body);
            $mail->Send();
        }
}
/******** 
@USE : List of qr codes which are not linked to any campaign and location
@PARAMETER : 
@RETURN : List of qr codes which are not linked to any campaign and location
@USED IN PAGES : manage-marketing-material.php , locations_for_marketingmaterial.php
*********/
if(isset($_REQUEST['getQRcodelist']))
{
    ?>       
		<?php
		$arr_qrcode_group['merchant_id'] =  getmainmercahnt_id($_SESSION['merchant_id']);
		/*$sql = "SELECT q.* FROM `qrcode_group` qg , qrcodes q  , qrcodegroup_qrcode qq where qq.qrcode_id= q.id and qg.id=qq.qrcodegroup_id and qg.merchant_id=". $_SESSION['merchant_id']." and q.reserve=0";
		$RS_qrcode = $objDB->Conn->Execute($sql);*/
		$RS_qrcode = $objDB->Conn->Execute("SELECT q.* FROM `qrcode_group` qg , qrcodes q  , qrcodegroup_qrcode qq where qq.qrcode_id= q.id and qg.id=qq.qrcodegroup_id and qg.merchant_id=? and q.reserve=?",array($_SESSION['merchant_id'],0));
		
		if($RS_qrcode->RecordCount() != 0)
		{
		?>
		<form>
		   <div class="qrcodelist" >
				<input type="hidden" name="hdn_qrcode_campaign_id" id="hdn_qrcode_campaign_id" value="<?php if(isset($_REQUEST['campaign_id'])){echo $_REQUEST['campaign_id'];} ?>" >
				<input type="hidden" name="hdn_qrcode_location_id" id="hdn_qrcode_location_id" value="<?php if(isset($_REQUEST['location_id'])){echo $_REQUEST['location_id'];} ?>" >
				<input type="hidden" name="hdn_qrcode_loyalty_id" id="hdn_qrcode_loyalty_id" value="<?php if(isset($_REQUEST['cardid'])){echo $_REQUEST['cardid'];} ?>" >
				<?php
				$st = true;
				while($Rowqrcode = $RS_qrcode->FetchRow())
				{
					/*
					$wh_arr = array();
					$wh_arr['qrcode_id'] = $Rowqrcode['id'];
					$rs_qrcode_campaign = $objDB->Show("qrcode_campaign",$wh_arr) ;
					*/
					$rs_qrcode_campaign = $objDB->Conn->Execute("select qrcode_id from campaigns where qrcode_id=?",array($Rowqrcode['id']));
					
					if($rs_qrcode_campaign->RecordCount() == 0)
					{
					   $st = false;
					}
				?>
				<input type="hidden" name="hdn_qrcode_data_found" id="hdn_qrcode_data_found" value="true" >
				<div style="margin-top:7px">
					<span style="vertical-align:middle;">
						<input type="radio" id="opt_qrcode_<?php echo $Rowqrcode['id'];?>" name='opt_qrcode' value="<?php echo $Rowqrcode['id'];?>" >
					</span>
					<label class="lblqrcode" id="optqrcode_<?php echo $Rowqrcode['id'];?>" for="opt_qrcode_<?php echo $Rowqrcode['id'];?>">
						<?php echo $Rowqrcode['qrcode'];?>
					</label>
					<!--                                                                        <img src="<?php echo WEB_PATH."/admin/phpqrcode/temp/".$Rowqrcode['qrcode_image']; ?>" />-->
					<br />
				</div>
				<?php
				} 
			?>
			 </div>
			 </form>
			<div height="12px">&nbsp;</div>
			<div align='center'>
			<?php
			if(isset($_REQUEST['location_id']))
			{
			?>
				<input type="submit" name="btnattachqrcode_loc" id="btnattachqrcode_loc" value="Link QR Code" >&nbsp;&nbsp;&nbsp;
			<?php
			}
			else if(isset($_REQUEST['cardid']))
			{
			?>
				<input type="submit" name="btnattachqrcode_loyalty" id="btnattachqrcode_loyalty" value="Link QR Code" >&nbsp;&nbsp;&nbsp;
			<?php
			}
			else
			{
			?>
				<input type="submit" name="btnattachqrcode" id="btnattachqrcode" value="Link QR Code" >&nbsp;&nbsp;&nbsp;
			<?php
			}
			?>	
			
			<input type="submit" name="btncancel" id="btncancel" value="Cancel">
			
		</div>
	   <?php  
	     }
		else
		{
		?>
		<input type="hidden" name="hdn_qrcode_data_found" id="hdn_qrcode_data_found" value="false" >
			<div class="aligned_center"><?php echo $merchant_msg['marketingmaterial']['no_qr_code_available'];?>
			</div>
			<div align='center' style="margin-top: 20px;"> 
				<input type="submit" name="btncancel" id="btncancel" value="<?php echo $merchant_msg['index']['fancybox_ok'];?>">
			 </div>
		</div>
		<?php }
	   
		?></div> 
                                                               
            <?php
}

/******** 
@USE : Attach Qr code with campaign
@PARAMETER : camapagn id , qrcode id
@RETURN : Attach qr code with campaign
@USED IN PAGES : mange-marketing-material.php
@Explaination : Once qr code attcah with campaign qr code status will be declared as  reserved
*********/
if(isset($_REQUEST['attachQRcode_campaign']))
{
    $cid = $_REQUEST['campaign_id'];
    $qrcodeid = $_REQUEST['qrcode_id'];
    $qrcode_array = array();
    $qrcode_array['id'] = $_REQUEST['qrcode_id'];
    $qrcodedata = $objDB->Show("qrcodes",$qrcode_array);
    /*$sql_delete = "Delete  from qrcode_campaign where campaign_id =".$cid;
    $objDB->Conn->Execute($sql_delete);*/
    
	//$objDBWrt->Conn->Execute("Delete  from qrcode_campaign where campaign_id =?",array($cid));
	$objDBWrt->Conn->Execute("Update campaigns set qrcode_id=0 where id= ?",array($cid));

    /*$Sql = "Insert into qrcode_campaign values (0,$qrcodeid,$cid)";
    $objDB->Conn->Execute($Sql);*/
    
	//$objDBWrt->Conn->Execute("Insert into qrcode_campaign values (?,?,?)",array(0,$qrcodeid,$cid));
	$objDBWrt->Conn->Execute("Update campaigns set qrcode_id=? where id= ?",array($qrcodeid,$cid));
	
    $qrcodestring = "QR-Generator-PHP-master/php/qr.php?d=".$qrcodedata->fields['qrcode']."&size=120";
    /*$Sql_update = "Update qrcodes set reserve=1, qrcode_image='".$qrcodestring."' where id= ".$qrcodeid;
    $objDB->Conn->Execute($Sql_update);*/
	$objDBWrt->Conn->Execute("Update qrcodes set reserve=1, qrcode_image=? where id= ?",array($qrcodestring,$qrcodeid));

  $json_array['status'] = "false";
		  $json_array['qval'] = $qrcodedata->fields['qrcode'];
		  $json = json_encode($json_array);
		  echo $json;
		  exit();

    
}
/******** 
@USE : Link Qr code with location
@PARAMETER : location id , qrcode id
@RETURN : link qr code with location
@USED IN PAGES : locations_for_marketingmaterial.php
@EXPAINATION : Onnce Qr code is link with location , its status become reserved
*********/
if(isset($_REQUEST['attachQRcode_location']))
{
    $lid = $_REQUEST['location_id'];
    $qrcodeid = $_REQUEST['qrcode_id'];
    $qrcode_array = array();
    $qrcode_array['id'] = $_REQUEST['qrcode_id'];
    $qrcodedata = $objDB->Show("qrcodes",$qrcode_array);
    /*$sql_delete = "Delete  from qrcode_location where location_id =".$lid;
    $objDB->Conn->Execute($sql_delete);*/
    
    //$objDBWrt->Conn->Execute("Delete  from qrcode_location where location_id =?",array($lid));
    $objDBWrt->Conn->Execute("Update locations set qrcode_id=0 where id= ?",array($lid));
    
    /*$Sql = "Insert into qrcode_location values (0,$qrcodeid,$lid)";
    $objDB->Conn->Execute($Sql);*/
    
    //$objDBWrt->Conn->Execute("Insert into qrcode_location values (?,?,?)",array(0,$qrcodeid,$lid));
    $objDBWrt->Conn->Execute("Update locations set qrcode_id=? where id= ?",array($qrcodeid,$lid));
    
    $qrcodestring = "QR-Generator-PHP-master/php/qr.php?d=".$qrcodedata->fields['qrcode']."&size=120";
   /* $Sql_update = "Update qrcodes set reserve=1, qrcode_image='".$qrcodestring."' where id= ".$qrcodeid;
    $objDB->Conn->Execute($Sql_update);*/
    $objDBWrt->Conn->Execute("Update qrcodes set reserve=?, qrcode_image=? where id= ?",array(1,$qrcodestring,$qrcodeid));

  $json_array['status'] = "false";
		  $json_array['qval'] = $qrcodedata->fields['qrcode'];
		  $json = json_encode($json_array);
		  echo $json;
		  exit();

    
}

/******** 
@USE : Link Qr code with loyalty
@PARAMETER : card id , qrcode id
@RETURN : link qr code with loyalty
@USED IN PAGES : locations_for_marketingmaterial.php
@EXPAINATION : Onnce Qr code is link with card , its status become reserved
*********/
if(isset($_REQUEST['attachQRcode_loyalty']))
{
    $cardid = $_REQUEST['cardid'];
    $qrcodeid = $_REQUEST['qrcode_id'];
    $qrcode_array = array();
    $qrcode_array['id'] = $_REQUEST['qrcode_id'];
    $qrcodedata = $objDB->Show("qrcodes",$qrcode_array);
    /*$sql_delete = "Delete  from qrcode_location where location_id =".$lid;
    $objDB->Conn->Execute($sql_delete);*/
    $objDBWrt->Conn->Execute("update merchant_loyalty_card set qrcode_id='".$qrcodeid."' where id =?",array($cardid));
    
    $qrcodestring = "QR-Generator-PHP-master/php/qr.php?d=".$qrcodedata->fields['qrcode']."&size=120";
   /* $Sql_update = "Update qrcodes set reserve=1, qrcode_image='".$qrcodestring."' where id= ".$qrcodeid;
    $objDB->Conn->Execute($Sql_update);*/
    $objDBWrt->Conn->Execute("Update qrcodes set reserve=?, qrcode_image=? where id= ?",array(1,$qrcodestring,$qrcodeid));

  $json_array['status'] = "false";
		  $json_array['qval'] = $qrcodedata->fields['qrcode'];
		  $json = json_encode($json_array);
		  echo $json;
		  exit();

    
}

/******** 
@USE : Un link Qr code with location
@PARAMETER : location id , qrcode id
@RETURN : Un link qr code with location
@USED IN PAGES : locations_for_marketingmaterial.php
@EXPAINATION : After un link qrcode , qr code is free to link anything else campaign , location
*********/
if(isset($_REQUEST['removeqrcodeattachment_location'])) 
{
    $lid = $_REQUEST['location_id'];
    /*$sql = "select qrcode_id from qrcode_location where location_id =".$lid;
 
    $RS = $objDB->Conn->Execute($sql);*/
    
    //$RS = $objDB->Conn->Execute("select qrcode_id from qrcode_location where location_id =?",array($lid));
    $RS = $objDB->Conn->Execute("select qrcode_id from locations where id =?",array($lid));
    
    $qrcode_id= $RS->fields['qrcode_id'];
    
    
    /*$sql_delete = "Delete  from qrcode_location where location_id =".$lid;
    $objDB->Conn->Execute($sql_delete);*/
    
    //$objDBWrt->Conn->Execute("Delete  from qrcode_location where location_id =?",array($lid));
    $objDBWrt->Conn->Execute("Update locations set qrcode_id=0 where id= ?",array($lid));
    
     /*$Sql_update = "Update qrcodes set reserve=0  where id= ".$qrcode_id;
  
      $objDB->Conn->Execute($Sql_update);*/
      $objDBWrt->Conn->Execute("Update qrcodes set reserve=0  where id= ?",array($qrcode_id));
}



/******** 
@USE : Un Link Qr code with campaign
@PARAMETER : camapagn id 
@RETURN : Un link qr code from campaign
@USED IN PAGES : manage-marketing-material.php
@Explaination : Once qr code un link with campaign qr code status will be declared as  free . so merchant can link campaign with any location and campaign 
*********/
if(isset($_REQUEST['removeqrcodeattachment'])) 
{
    $cid = $_REQUEST['campaign_id'];
    /*$sql = "select qrcode_id from qrcode_campaign where campaign_id =".$cid;
 
    $RS = $objDB->Conn->Execute($sql);*/
    
    //$RS = $objDB->Conn->Execute("select qrcode_id from qrcode_campaign where campaign_id =?",array($cid));
    $RS = $objDB->Conn->Execute("select qrcode_id from campaigns where id =?",array($cid));
    
    $qrcode_id= $RS->fields['qrcode_id'];
    
    
   /* $sql_delete = "Delete  from qrcode_campaign where campaign_id =".$cid;
    $objDB->Conn->Execute($sql_delete);*/
    
    //$objDBWrt->Conn->Execute("Delete  from qrcode_campaign where campaign_id =?",array($cid));
    $objDBWrt->Conn->Execute("Update campaigns set qrcode_id=0 where id= ?",array($cid));
    
     /*$Sql_update = "Update qrcodes set reserve=0  where id= ".$qrcode_id;
  
      $objDB->Conn->Execute($Sql_update);*/
      $objDBWrt->Conn->Execute("Update qrcodes set reserve=0  where id= ?",array($qrcode_id));
}

/******** 
@USE : Un link Qr code with loyalty
@PARAMETER : location id , qrcode id
@RETURN : Un link qr code with loyalty
@USED IN PAGES : locations_for_marketingmaterial.php
@EXPAINATION : After un link qrcode , qr code is free to link anything else campaign , location
*********/
if(isset($_REQUEST['removeqrcodeattachment_loyalty'])) 
{
    $cardid = $_REQUEST['cardid'];
    /*$sql = "select qrcode_id from qrcode_location where location_id =".$lid;
 
    $RS = $objDB->Conn->Execute($sql);*/
    $RS = $objDB->Conn->Execute("select qrcode_id from merchant_loyalty_card where id =?",array($cardid));   
    $qrcode_id= $RS->fields['qrcode_id'];
    
    
    /*$sql_delete = "Delete  from qrcode_location where location_id =".$lid;
    $objDB->Conn->Execute($sql_delete);*/
   $objDBWrt->Conn->Execute("update merchant_loyalty_card set qrcode_id=0 where id =?",array($cardid));
    
     /*$Sql_update = "Update qrcodes set reserve=0  where id= ".$qrcode_id;
  
      $objDB->Conn->Execute($Sql_update);*/
      $objDBWrt->Conn->Execute("Update qrcodes set reserve=0  where id= ?",array($qrcode_id));
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['getlocationlist_for_marketingmaterial']))
{
    include_once 'locations_for_marketingmaterial.php';
}
/******** 
@USE : Download message
@PARAMETER : 
@RETURN : 
@USED IN PAGES : manage-marketing-material.php
*********/
if(isset($_REQUEST['attach_message']))
{
    ?>
     <div>
         <div align="center" style="margin-left:20px;margin-right:20px">
             <?php echo $merchant_msg['marketingmaterial']['wish_to_download_qr_code'];?>
         </div>
         <div align="center" style="margin-top:20px;">
             <input type="submit" name="btn_cancel" id="btn_cancel" value="<?php echo $merchant_msg['index']['btn_cancel'];?>" > &nbsp;&nbsp; 
             <!--<input type="submit" name="btn_continue" id="btn_continue" value="<?php echo $merchant_msg['index']['btn_continue'];?>" >-->
             
         </div>
         
     </div>
    <?php
}
/******** 
@USE : Download marketing material message
@PARAMETER : 
@RETURN : 
@USED IN PAGES : manage-marketing-material.php
*********/
if(isset($_REQUEST['attach_message_material']))
{
    ?>
     <div>
         <div align="center" style="margin-left:20px;margin-right:20px">
             <?php echo $merchant_msg['marketingmaterial']['wish_to_download_qr_code'];?>
         </div>
         <div align="center" style="margin-top:20px;">
             <input type="submit" name="btn_cancel" id="btn_cancel" value="<?php echo $merchant_msg['index']['btn_cancel'];?>" > &nbsp;&nbsp; 
             <!--<input type="submit" name="btn_continue_material" id="btn_continue_material" value="<?php echo $merchant_msg['index']['btn_continue'];?>" >-->
             
         </div>
         
     </div>
    <?php
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['attach_message_material_loc']))
{
    ?>
     <div>
         <div align="center" style="margin-left:20px;margin-right:20px">
             <?php echo $merchant_msg['marketingmaterial']['wish_to_download_qr_code_loc'];?>
         </div>
         <div align="center" style="margin-top:20px;">
             <input type="submit" name="btn_cancel" id="btn_cancel" value="<?php echo $merchant_msg['index']['btn_cancel'];?>" > &nbsp;&nbsp; 
             <!--<input type="submit" name="btn_continue_material" id="btn_continue_material" value="<?php echo $merchant_msg['index']['btn_continue'];?>" >-->
             
         </div>
         
     </div>
    <?php
}

/******** 
@USE : Location attach message
@PARAMETER : 
@RETURN : 
*********/
if(isset($_REQUEST['attach_message_location']))
{
    ?>
     <div>
         <div align="center" style="margin-top:80px;margin-left:20px;margin-right:20px">
             If You Wish To Download QR Code for the Campaign, Please Cancel and Select Campaign Title First.
         </div>
         <div align="center" style="margin-top:20px;">
             <input type="submit" name="btn_cancel" id="btn_cancel" value="Cancel" > 
      
             
         </div>
         
     </div>
    <?php
}

/******** 
@USE : Location attach message
@PARAMETER : 
@RETURN : 
*********/
if(isset($_REQUEST['get_location_name_of_campaigns_by_location_id']))
{
	 //   echo "here";
	    $locations = $_REQUEST['locationlist'];
	   $locations_ =  str_replace('-',',',$locations) ;
	   

	  /*$Sql = "Select l.* from campaign_location cl , locations l where campaign_id = ". $_REQUEST['camp_id'] ." and l.id = cl.location_id and l.active = 1 and l.id in(".$locations_.")" ;
	 
	 $Rs = $objDB->execute_query($Sql);*/
	$Rs = $objDB->Conn->Execute("Select l.* from campaign_location cl , locations l where campaign_id = ? and l.id = cl.location_id and l.active = ? and l.id in(?)",array($_REQUEST['camp_id'],1,$locations_));

	 $records = array();
	 while($Row = $Rs->FetchRow())
	 {
	  $records[$count] = get_field_value($Row);
	  $count++;
	 }
	 $json_array["total_records"] = $Rs->RecordCount();
	 $json_array["records"]= $records;
	  $json = json_encode($json_array);
	  echo $json;
	  exit();   
}

/******** 
@USE : get marketing material
@PARAMETER : size_id,locid,campid,image
@RETURN : 
@USED IN PAGES : merchant-marketing-template.php
*********/
if(isset($_REQUEST['getmarketingmaterial']))
{
	    /* $Sql = "Select material_format from marketing_material where material_size=".$_REQUEST['size_id'];
	  
	    $RS = $objDB->execute_query($Sql);*/
	    $RS = $objDB->Conn->Execute("Select material_format from marketing_material where material_size=?",array($_REQUEST['size_id']));
	 
	     $json_array["html_content"] = str_replace("&lt;","<",str_replace("&gt;",">",$RS->fields['material_format']));
	     
	 
		$address = "";
	    /*$Sql = "Select * from locations where id=".$_REQUEST['locid'];
	    $RS_locations = $objDB->execute_query($Sql);*/
	    $RS_locations = $objDB->Conn->Execute("Select * from locations where id=?",array($_REQUEST['locid']));

	  /*$Sql_merchant_icon = "select merchant_icon , business from merchant_user where id=".$RS_locations->fields['created_by'];
	 $RS_merchant_icon = $objDB->execute_query($Sql_merchant_icon);*/
	 $RS_merchant_icon = $objDB->Conn->Execute("select merchant_icon , business from merchant_user where id=?",array($RS_locations->fields['created_by']));

   $address .= $RS_merchant_icon->fields['business']."<br />";
    $phno = explode("-",$RS_locations->fields['phone_number']);
                     $newphno = "(".$phno[1].") ".$phno[2]."-".$phno[3];
                     
                    $array_where = array();
					$array_where['id'] = $RS_locations->fields['country'];
					$RS_country = $objDB->Show("country", $array_where);
					 
                    $array_where = array();
					$array_where['id'] = $RS_locations->fields['state'];
					$RS_state = $objDB->Show("state", $array_where);

					$array_where = array();
					$array_where['id'] = $RS_locations->fields['city'];
					$RS_city = $objDB->Show("city", $array_where);
			
    $address .="". $RS_locations->fields['address'].", <br />".$RS_city->fields['name'] .", ".$RS_state->fields['short_form'].", ".$RS_country->fields['name'].", ".$RS_locations->fields['zip']." <br />Phone:".$newphno;
 $json_array["location_address"] = $address;
 //print_r($RS_merchant_icon);
  //$json_array["location_image"] = $RS_locations->fields['picture'] ;
 //echo  "==".$RS_merchant_icon->fields['merchant_icon'];
 if($RS_merchant_icon->fields['merchant_icon']!="")
					{
						$img_src=ASSETS_IMG."/m/icon/".$RS_merchant_icon->fields['merchant_icon']; 
					}
					else 
					{
						$img_src=ASSETS_IMG."/m/default_campaign.jpg";
					}
 
     $json_array["location_image"] = $img_src ;
 
 if($_REQUEST['campid'] !=  0)
 {
     //$Sql  = "Select qrcode from qrcodes where id in(select qrcode_id from qrcode_campaign where campaign_id=".$_REQUEST['campid']." )";
	
	//$RS_qrcode = $objDB->Conn->Execute("Select qrcode from qrcodes where id in(select qrcode_id from qrcode_campaign where campaign_id=? )",array($_REQUEST['campid']));
	$RS_qrcode = $objDB->Conn->Execute("Select qrcode from qrcodes where id = (select qrcode_id from campaigns where id=? )",array($_REQUEST['campid']));
	
 }else{
      //$Sql  = "Select qrcode from qrcodes where id in(select qrcode_id from qrcode_location where location_id=".$_REQUEST['locid']." )";
	
	//$RS_qrcode = $objDB->Conn->Execute("Select qrcode from qrcodes where id in(select qrcode_id from qrcode_location where location_id=? )",array($_REQUEST['campid']));
	$RS_qrcode = $objDB->Conn->Execute("Select qrcode from qrcodes where id = (select qrcode_id from locations where id=? )",array($_REQUEST['campid']));
	
 }
 
 $filename =  UPLOAD_IMG."/m/campaign/".$_REQUEST['image'];
    list($Actualwidth, $Actualheight, $type, $attr) = getimagesize($filename);
    $w = 0;
    $width = $Actualwidth;
    $height = $Actualheight;
    $qrcode_size = 100;
    
if($_REQUEST['size_id']  == 1)
{
	$qrcode_size = 70;
	$Xmax = 549;
	$Ymax = 130;
}
else if($_REQUEST['size_id']  == 2)
{
    $qrcode_size = 100;
    $Xmax = 800;
	$Ymax = 150;
}
else if($_REQUEST['size_id']  == 3)
{
    $qrcode_size = 120;
    $Xmax = 800;
	//$Ymax = 235;
	$Ymax = 220;
}
else if($_REQUEST['size_id']  == 5)
{
    $qrcode_size = 90;
    $Xmax = 670;
	$Ymax = 140;
}


    
    
   
   if($width >  $Xmax || $height > $Ymax )
   {
      // echo "In 1";
       $AR = $Xmax / $Ymax ;
// $filename =  SERVER_PATH."/merchant/images/logo/campaign_1373603010.png";
//    list($Actualwidth, $Actualheight, $type, $attr) = getimagesize($filename);
    $Applywidth = 0;
    $Applyheight = 0;
    if($Actualwidth > $Xmax && $Actualheight > $Ymax)
    {
      //   echo "1";
        $Applywidth = $Xmax;
        $Applyheight = $Xmax / $AR ;
        
    }
    else if($Actualwidth <= $Xmax && $Actualheight > $Ymax)
    {
     //   echo "2";
            $Applywidth =   $Actualwidth;
            $Applyheight =  $Actualwidth / $AR ;
    }
    else if($Actualwidth <= $Xmax && $Actualheight <= $Ymax)
    {
      //  echo "3";
         $Applywidth =   $Actualwidth;
            $Applyheight =  $Actualheight ;
    }
    else{
       // echo "4";
        $Applywidth =   $Actualwidth;
            $Applyheight =  $Actualheight ;
    }
    $newWidth = round($Applywidth,2);
    $newHeight = round($Applyheight,2);
   }
   else{
     //  echo "In 2";
       
                        if($width == $Xmax && $height == $Ymax) 
			{
                          //   echo "In";
				$newHeight = $height;
				$newWidth = $width;
			}
			else
			{
                         //   echo "Else";
			   // echo "Main Else"; 
				if($width >  $Xmax || $height > $Ymax )
				{
					if ($width >= $height)
						{
					   //echo "In If";
							if ($width <= $Ymax && $height <= $Xmax)
							{
								return image;  // no resizing required
							}
							$wRatio = $Ymax / $width;
	
							$hRatio = $Xmax / $height;
						}
						else
							{
					  // echo "In Else";
						if ($height <= $Ymax && $width <= $Xmax)
						{
							//return image; // no resizing required
                                                    $newHeight = $height;
					      $newWidth = $width;
						}
	
						$wRatio = $Xmax / $width;
						$hRatio = $Ymax / $height;
					}
					$resizeRatio = Min($wRatio, $hRatio);
					$newHeight = $height * $resizeRatio;
					$newWidth = $width * $resizeRatio;
				}
				else
				{
				      //  echo "else ma ";
					$newHeight = $height;
					      $newWidth = $width;
				}
		 
			  
			}
    
   }
   if ($height <= $Ymax && $width <= $Xmax)
    {
     // echo "In 3";
       $newHeight = $height;
	$newWidth = $width;
   }
   else{
      // echo "In 4";
        $ratio1 = $Xmax / $width;
        $ratio2 = $Ymax / $height ;
        $ratio = min($ratio1, $ratio2);
        $newWidth = $width * $ratio;
        $newHeight = $height * $ratio ;
   }
	
    $dirname ='';
    if(isset($_REQUEST['merchant_id'])){
	    $merchant_id = $_REQUEST['merchant_id'];
	   
	    $dirname = $_REQUEST['merchant_id']."_upload";  
    }   
    $filename1 = (LIBRARY."/demopdf/".$dirname."/");
  
    if (file_exists($filename1)) {        
    } else {
        mkdir(LIBRARY."/demopdf/" . "$dirname", 0777);        
    }
$image_folder = LIBRARY."/demopdf/".$dirname."/"; 
    $resized_path = $image_folder."resized_image1.jpg" ;
    //echo "111";
    //$RS_qrcode = $objDB->execute_query($Sql);
 $url = WEB_PATH."/qr.php?qrcode=".base64_encode($RS_qrcode->fields['qrcode']);
 $json_array["qrcode"] = $url ;
        passthru("/usr/bin/convert ".$filename." -resize ".$newWidth."x".$newHeight."! ".$resized_path); 
      ////  echo "/usr/bin/convert ".$filename." -resize ".$newWidth."x".$newHeight."! ".$resized_path."<br/>";
  $filename= $image_folder."template-qrcode1.jpg";
$fname= WEB_PATH."/QR-Generator-PHP-master/php/qr.php?d='".$json_array["qrcode"]."&size=".$qrcode_size."'";
passthru("/usr/bin/convert ".$fname."  ".$filename);
//echo "/usr/bin/convert ".$fname."  ".$filename."<br />";
// echo $Sql;
 
  $json = json_encode($json_array);
  echo $json;
  exit(); 
}



/******** 
@USE : get marketing material for loyalty
@PARAMETER : size_id,locid,campid,image
@RETURN : 
@USED IN PAGES : merchant-marketing-template-loyalty.php
*********/
if(isset($_REQUEST['getmarketingmaterial_loyalty']))
{
	    /* $Sql = "Select material_format from marketing_material where material_size=".$_REQUEST['size_id'];
	  
	    $RS = $objDB->execute_query($Sql);*/
	    $RS = $objDB->Conn->Execute("Select material_format from marketing_material where material_size=?",array($_REQUEST['size_id']));
	 
	     $json_array["html_content"] = str_replace("&lt;","<",str_replace("&gt;",">",$RS->fields['material_format']));
	     
	 
		$address = "";
	    /*$Sql = "Select * from locations where id=".$_REQUEST['locid'];
	    $RS_locations = $objDB->execute_query($Sql);*/
	    $RS_locations = $objDB->Conn->Execute("Select * from locations where id=?",array($_REQUEST['locid']));

	  /*$Sql_merchant_icon = "select merchant_icon , business from merchant_user where id=".$RS_locations->fields['created_by'];
	 $RS_merchant_icon = $objDB->execute_query($Sql_merchant_icon);*/
	 $RS_merchant_icon = $objDB->Conn->Execute("select merchant_icon , business from merchant_user where id=?",array($RS_locations->fields['created_by']));

   $address .= $RS_merchant_icon->fields['business']."<br />";
    $phno = explode("-",$RS_locations->fields['phone_number']);
                     $newphno = "(".$phno[1].") ".$phno[2]."-".$phno[3];
                     
     $array_where = array();
					$array_where['id'] = $RS_locations->fields['country'];
					$RS_country = $objDB->Show("country", $array_where);
					 
                    $array_where = array();
					$array_where['id'] = $RS_locations->fields['state'];
					$RS_state = $objDB->Show("state", $array_where);

					$array_where = array();
					$array_where['id'] = $RS_locations->fields['city'];
					$RS_city = $objDB->Show("city", $array_where);
			
    $address .="". $RS_locations->fields['address'].", <br />".$RS_city->fields['name'].", ".$RS_state->fields['short_form'].", ".$RS_country->fields['name'].", ".$RS_locations->fields['zip']." <br />Phone:".$newphno;
 $json_array["location_address"] = $address;
 //print_r($RS_merchant_icon);
  //$json_array["location_image"] = $RS_locations->fields['picture'] ;
 //echo  "==".$RS_merchant_icon->fields['merchant_icon'];
 if($RS_merchant_icon->fields['merchant_icon']!="")
					{
						$img_src=ASSETS_IMG."/m/icon/".$RS_merchant_icon->fields['merchant_icon']; 
					}
					else 
					{
						$img_src=ASSETS_IMG."/m/default_campaign.jpg";
					}
 
     $json_array["location_image"] = $img_src ;
 
 if($_REQUEST['campid'] !=  0)
 {
     //$Sql  = "Select qrcode from qrcodes where id in(select qrcode_id from qrcode_campaign where campaign_id=".$_REQUEST['campid']." )";
	$RS_qrcode = $objDB->Conn->Execute("Select qrcode from qrcodes q, merchant_loyalty_card mlc where q.id=mlc.qrcode_id and mlc.id=?",array($_REQUEST['campid']));
 }
 
 $filename =  UPLOAD_IMG."/m/campaign/".$_REQUEST['image'];
    list($Actualwidth, $Actualheight, $type, $attr) = getimagesize($filename);
    $w = 0;
    $width = $Actualwidth;
    $height = $Actualheight;
    $qrcode_size = 100;
    
if($_REQUEST['size_id']  == 1)
{
	$qrcode_size = 70;
	$Xmax = 549;
	$Ymax = 130;
}
else if($_REQUEST['size_id']  == 2)
{
    $qrcode_size = 100;
    $Xmax = 800;
	$Ymax = 150;
}
else if($_REQUEST['size_id']  == 3)
{
    $qrcode_size = 120;
    $Xmax = 800;
	//$Ymax = 235;
	$Ymax = 220;
}
else if($_REQUEST['size_id']  == 5)
{
    $qrcode_size = 90;
    $Xmax = 670;
	$Ymax = 140;
}

   
   if($width >  $Xmax || $height > $Ymax )
   {
      // echo "In 1";
       $AR = $Xmax / $Ymax ;
// $filename =  SERVER_PATH."/merchant/images/logo/campaign_1373603010.png";
//    list($Actualwidth, $Actualheight, $type, $attr) = getimagesize($filename);
    $Applywidth = 0;
    $Applyheight = 0;
    if($Actualwidth > $Xmax && $Actualheight > $Ymax)
    {
      //   echo "1";
        $Applywidth = $Xmax;
        $Applyheight = $Xmax / $AR ;
        
    }
    else if($Actualwidth <= $Xmax && $Actualheight > $Ymax)
    {
     //   echo "2";
            $Applywidth =   $Actualwidth;
            $Applyheight =  $Actualwidth / $AR ;
    }
    else if($Actualwidth <= $Xmax && $Actualheight <= $Ymax)
    {
      //  echo "3";
         $Applywidth =   $Actualwidth;
            $Applyheight =  $Actualheight ;
    }
    else{
       // echo "4";
        $Applywidth =   $Actualwidth;
            $Applyheight =  $Actualheight ;
    }
    $newWidth = round($Applywidth,2);
    $newHeight = round($Applyheight,2);
   }
   else{
     //  echo "In 2";
       
                        if($width == $Xmax && $height == $Ymax) 
			{
                          //   echo "In";
				$newHeight = $height;
				$newWidth = $width;
			}
			else
			{
                         //   echo "Else";
			   // echo "Main Else"; 
				if($width >  $Xmax || $height > $Ymax )
				{
					if ($width >= $height)
						{
					   //echo "In If";
							if ($width <= $Ymax && $height <= $Xmax)
							{
								return image;  // no resizing required
							}
							$wRatio = $Ymax / $width;
	
							$hRatio = $Xmax / $height;
						}
						else
							{
					  // echo "In Else";
						if ($height <= $Ymax && $width <= $Xmax)
						{
							//return image; // no resizing required
                                                    $newHeight = $height;
					      $newWidth = $width;
						}
	
						$wRatio = $Xmax / $width;
						$hRatio = $Ymax / $height;
					}
					$resizeRatio = Min($wRatio, $hRatio);
					$newHeight = $height * $resizeRatio;
					$newWidth = $width * $resizeRatio;
				}
				else
				{
				      //  echo "else ma ";
					$newHeight = $height;
					      $newWidth = $width;
				}
		 
			  
			}
    
   }
   if ($height <= $Ymax && $width <= $Xmax)
    {
     // echo "In 3";
       $newHeight = $height;
	$newWidth = $width;
   }
   else{
      // echo "In 4";
        $ratio1 = $Xmax / $width;
        $ratio2 = $Ymax / $height ;
        $ratio = min($ratio1, $ratio2);
        $newWidth = $width * $ratio;
        $newHeight = $height * $ratio ;
   }
	
    $dirname ='';
    if(isset($_REQUEST['merchant_id'])){
	    $merchant_id = $_REQUEST['merchant_id'];
	   
	    $dirname = $_REQUEST['merchant_id']."_upload";  
    }   
    $filename1 = (LIBRARY."/demopdf/".$dirname."/");
  
    if (file_exists($filename1)) {        
    } else {
        mkdir(LIBRARY."/demopdf/" . "$dirname", 0777);        
    }
$image_folder = LIBRARY."/demopdf/".$dirname."/"; 
    $resized_path = $image_folder."resized_image1.jpg" ;
    //echo "111";
    //$RS_qrcode = $objDB->execute_query($Sql);
 $url = WEB_PATH."/qr.php?qrcode=".base64_encode($RS_qrcode->fields['qrcode']);
 $json_array["qrcode"] = $url ;
        passthru("/usr/bin/convert ".$filename." -resize ".$newWidth."x".$newHeight."! ".$resized_path); 
      ////  echo "/usr/bin/convert ".$filename." -resize ".$newWidth."x".$newHeight."! ".$resized_path."<br/>";
  $filename= $image_folder."template-qrcode1.jpg";
$fname= WEB_PATH."/QR-Generator-PHP-master/php/qr.php?d='".$json_array["qrcode"]."&size=".$qrcode_size."'";
passthru("/usr/bin/convert ".$fname."  ".$filename);
//echo "/usr/bin/convert ".$fname."  ".$filename."<br />";
// echo $Sql;
 
  $json = json_encode($json_array);
  echo $json;
  exit(); 
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btngetqrcodescanreport']))
{
     $sql = "select distinct a.* ,b.location_name ,b.id location_id ,(select gender c from customer_user c where  c.id=a.user_id) gender
 from scan_qrcode a inner join locations b on a.location_id = b.id  ";
    //$RS_qrcode = $objDB->execute_query($sql);
	$RS_qrcode = $objDB->Conn->Execute($sql);

    $location_arr = array();
    $unique_qrcodelocation_arr = array();
    $unique_qrcodecampaign_arr = array();
    $unique_qrcodetotal_arr = array();
    $all_qrcodecampaign_arr = array();
    $all_qrcodelocation_arr = array();
    $female_counter = 0;
    $male_counter = 0;
    $unknon_counter = 0;
    $female_arr_location = array();
    $male_arr_location = array();
      $unknown_arr_location = array();
      $female_arr_campaign = array();
    $male_arr_campaign = array();
      $unknown_arr_campaign = array();
    while($Row_qrcode = $RS_qrcode->FetchRow())
    {
        if($Row_qrcode['gender'] ==1)
        {
            $male_counter++;
        }
        else if($Row_qrcode['gender'] ==2)
        {
            $female_counter++;
        }
        else{
            $unknon_counter++;
        }
       
        if(in_array($Row_qrcode['location_id'],$location_arr)){
           
            $temparr =$location_arr[$Row_qrcode['location_id']];
            
            if($Row_qrcode['is_unique']==1 && $Row_qrcode['campaign_id']!=0)
            {
                  if($Row_qrcode['gender'] ==1)
                {
                    $male_arr_campaign[$Row_qrcode['location_id']]= $male_arr_campaign[$Row_qrcode['location_id']] + 1;
                   
                }
                else if($Row_qrcode['gender'] ==2)
                {
                    $female_arr_campaign[$Row_qrcode['location_id']]= $female_arr_campaign[$Row_qrcode['location_id']] + 1;
                    
                }
                else{
                //    echo 'In unknown - alll<br />';
                    $unknown_arr_campaign[$Row_qrcode['location_id']]= $unknown_arr_campaign[$Row_qrcode['location_id']] + 1;
               
                    //echo 'In unknown - alll'.$unknown_arr_location[$Row_qrcode['location_id']]."===".$unknown_arr_campaign[$Row_qrcode['location_id']]."<br />";
                }
          //      echo "===gender".$Row_qrcode['gender']."==<br/>";
                 $uniquecountercampaign =  $unique_qrcodecampaign_arr[$Row_qrcode['location_id']]+1;
                 $uniquecounterlocation = $unique_qrcodecampaign_arr[$Row_qrcode['location_id']] +1;
                 $allcounterlocation = $all_qrcodelocation_arr[$Row_qrcode['location_id']] +1;
                 $allcountercampaign = $all_qrcodecampaign_arr[$Row_qrcode['location_id']] +1;
            }
            else if($Row_qrcode['is_unique']==0 && $Row_qrcode['campaign_id']!=0)
            {
                  if($Row_qrcode['gender'] ==1)
                {
                    $male_arr_campaign[$Row_qrcode['location_id']]= $male_arr_campaign[$Row_qrcode['location_id']] + 1;
                }
                else if($Row_qrcode['gender'] ==2)
                {
                    $female_arr_campaign[$Row_qrcode['location_id']]= $female_arr_campaign[$Row_qrcode['location_id']] + 1;
                }
                else{
                 
                    $unknown_arr_campaign[$Row_qrcode['location_id']]= $unknown_arr_campaign[$Row_qrcode['location_id']] + 1;
                 //   echo 'In unknown - camp'.$unknown_arr_location[$Row_qrcode['location_id']]."===".$unknown_arr_campaign[$Row_qrcode['location_id']]."<br />";
                }
                 $allcountercampaign = $all_qrcodecampaign_arr[$Row_qrcode['location_id']] +1;
            }
            else if($Row_qrcode['is_unique']==1 && $Row_qrcode['campaign_id']==0)
            {
                 
                 $uniquecounterlocation = $unique_qrcodecampaign_arr[$Row_qrcode['location_id']] +1;
            }
            else if($Row_qrcode['is_unique']==0 && $Row_qrcode['campaign_id']==0)
            {
               
                 $allcounterlocation = $all_qrcodelocation_arr[$Row_qrcode['location_id']] +1;
            }
             if($Row_qrcode['gender'] ==1)
                {
                    $male_arr_location[$Row_qrcode['location_id']]= $male_arr_location[$Row_qrcode['location_id']] + 1;
                }
                else if($Row_qrcode['gender'] ==2)
                {
                    $female_arr_location[$Row_qrcode['location_id']]= $female_arr_location[$Row_qrcode['location_id']] + 1;
                }
                else{
                        $unknown_arr_location[$Row_qrcode['location_id']]= $unknown_arr_location[$Row_qrcode['location_id']] + 1;
                }
            $totalcounter = $unique_qrcodetotal_arr[$Row_qrcode['location_id']]+1;
          $unique_qrcodelocation_arr[$Row_qrcode['location_id']] = $uniquecounterlocation;
          $unique_qrcodecampaign_arr[$Row_qrcode['location_id']] = $uniquecountercampaign;
          $all_qrcodelocation_arr[$Row_qrcode['location_id']] = $allcounterlocation;
          $all_qrcodecampaign_arr[$Row_qrcode['location_id']] = $allcountercampaign;
          $unique_qrcodetotal_arr[$Row_qrcode['location_id']] = $totalcounter;
       //   echo "IN exists==".$Row_qrcode['location_id']."==".$uniquecounterlocation."===".$uniquecountercampaign."====".$totalcounter."<br/>";
        }
        else {
           
              array_push($location_arr,$Row_qrcode['location_id']);
                $unique_qrcodelocation_arr[$Row_qrcode['location_id']] = 0;
              $unique_qrcodecampaign_arr[$Row_qrcode['location_id']] = 0;
            $unique_qrcodetotal_arr[$Row_qrcode['location_id']] = 1;
            $all_qrcodelocation_arr[$Row_qrcode['location_id']] = 0;
            $all_qrcodecampaign_arr[$Row_qrcode['location_id']] = 0;
           
                    $male_arr_campaign[$Row_qrcode['location_id']]=  0;
                     $male_arr_location[$Row_qrcode['location_id']]=  0;
               
                    $female_arr_campaign[$Row_qrcode['location_id']]= 0;
                    $female_arr_location[$Row_qrcode['location_id']]=  0;
           
                    $unknown_arr_campaign[$Row_qrcode['location_id']]=  0;
                    $unknown_arr_location[$Row_qrcode['location_id']]=  0;
                 
      
                     if($Row_qrcode['gender'] ==1)
                {
                    $male_arr_location[$Row_qrcode['location_id']]=1;
                }
                else if($Row_qrcode['gender'] ==2)
                {
                    $female_arr_location[$Row_qrcode['location_id']]= 1;
                }
                else{
                   
                    $unknown_arr_location[$Row_qrcode['location_id']]= 1;
                }
            if($Row_qrcode['is_unique']==1 && $Row_qrcode['campaign_id']!=0)
            {
                  $unique_qrcodecampaign_arr[$Row_qrcode['location_id']]=1;
                  $unique_qrcodelocation_arr[$Row_qrcode['location_id']] =1;
                  $all_qrcodelocation_arr[$Row_qrcode['location_id']] =1;
                  $all_qrcodecampaign_arr[$Row_qrcode['location_id']] =1;
                  if($Row_qrcode['gender'] ==1)
                {
                    $male_arr_campaign[$Row_qrcode['location_id']]=  1;
                    
                }
                else if($Row_qrcode['gender'] ==2)
                {
                    $female_arr_campaign[$Row_qrcode['location_id']]= 1;
                    
                }
                else{
                    
                    $unknown_arr_campaign[$Row_qrcode['location_id']]=  1;
                   
                }
            }
            else if($Row_qrcode['is_unique']==0 && $Row_qrcode['campaign_id']!=0)
            {
                 if($Row_qrcode['gender'] ==1)
                {
                    $male_arr_campaign[$Row_qrcode['location_id']]= 1;
                }
                else if($Row_qrcode['gender'] ==2)
                {
                    $female_arr_campaign[$Row_qrcode['location_id']]= 1;
                }
                else{
                   
                    $unknown_arr_campaign[$Row_qrcode['location_id']]=  1;
                }
                 $all_qrcodecampaign_arr[$Row_qrcode['location_id']] =1;
            }
            else if($Row_qrcode['is_unique']==1 && $Row_qrcode['campaign_id']==0)
            {
               
                  $unique_qrcodelocation_arr[$Row_qrcode['location_id']] =1;
            }
            else if($Row_qrcode['is_unique']==0 && $Row_qrcode['campaign_id']==0)
            {
                
                $all_qrcodelocation_arr[$Row_qrcode['location_id']] =1;
            }

                    }
    }
    
    //calculate percentage
    foreach($male_arr_campaign as $key=>$value)
    {
        $tatal_users = $male_arr_campaign[$key]+$female_arr_campaign[$key]+$unknown_arr_campaign[$key];
        $per = round((($male_arr_campaign[$key]*100)/$tatal_users),2);
        $male_arr_campaign[$key]=$per;
        $per = round((($female_arr_campaign[$key]*100)/$tatal_users),2);
        $female_arr_campaign[$key]=$per;
        $per = round((($unknown_arr_campaign[$key]*100)/$tatal_users),2);
        $unknown_arr_campaign[$key]=$per;
    }
     foreach($male_arr_location as $key=>$value)
    {
        $tatal_users = $male_arr_location[$key]+$female_arr_location[$key]+$unknown_arr_location[$key];
        $per = round((($male_arr_location[$key]*100)/$tatal_users),2);
        $male_arr_location[$key]=$per;
        $per = round((($female_arr_location[$key]*100)/$tatal_users),2);
        $female_arr_location[$key]=$per;
        $per = round((($unknown_arr_location[$key]*100)/$tatal_users),2);
        $unknown_arr_location[$key]=$per;
    }
    
    //calculate percentage
    
   echo "<pre>";
   echo "unique_qrcodetotal_arr<br/>";
    print_r($male_arr_campaign);
    echo "all_qrcodelocation_arr<br/>";
    print_r($female_arr_campaign);
    echo "all_qrcodecampaign_arr<br/>";
    print_r($unknown_arr_campaign);
// 
    echo "unique_qrcodetotal_arr<br/>";
    print_r($male_arr_location);
    echo "all_qrcodelocation_arr<br/>";
    print_r($female_arr_location);
    echo "all_qrcodecampaign_arr<br/>";
    print_r($unknown_arr_location);
    echo "</pre>";//   echo "male counter".$male_counter."female counter".$female_counter."unknown counter".$unknon_counter ;
//    $locatino_json = json_encode($location_arr);
//    echo $locatino_json;
     $unique_qrcodetotal_arr = json_encode(array_values($unique_qrcodetotal_arr));
     $unique_qrcodelocation_arr = json_encode(array_values($unique_qrcodelocation_arr));
     $unique_qrcodecampaign_arr = json_encode(array_values($unique_qrcodecampaign_arr));
     $all_qrcodelocation_arr = json_encode(array_values($all_qrcodelocation_arr));
     $all_qrcodecampaign_arr = json_encode(array_values($all_qrcodecampaign_arr));
     $male_arr_campaign = json_encode(array_values($male_arr_campaign));
     $female_arr_campaign = json_encode(array_values($female_arr_campaign));
     $unknown_arr_campaign = json_encode(array_values($unknown_arr_campaign));
     $male_arr_location = json_encode(array_values($male_arr_campaign));
     $female_arr_location = json_encode(array_values($female_arr_location));
     $unknown_arr_location = json_encode(array_values($unknown_arr_location));
     
     
     
}

/******** 
@USE : get location adress
@PARAMETER : loc_id
@RETURN : business
@USED IN PAGES : reports.php
*********/
if(isset($_REQUEST['location_business_address']))
{
/*                    $sql = "select business merchant_user where id =(select l.created_by from locations l where l.id= ".$_REQUEST['loc_id'];
                $RS_business = $objDB->execute_query($sql);*/
		$RS_business = $objDB->Conn->Execute("select business merchant_user where id =(select l.created_by from locations l where l.id= ?",array($_REQUEST['loc_id']));
                echo  $RS_business->fields['business'];
}
/*16/04/2013*/
/******** 
@USE : Get all active campaign which are public and walk in deals. Private deals will not display here.
@PARAMETER : current login merchant id
@RETURN : List of campaign
@USED IN PAGES : manage-marketing-material.php
*********/

if(isset($_REQUEST['btnGetAllpublicwalkinCampaignOfMerchant']))
{
    $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
         $ids=$_REQUEST['ids'];
         if($ids=="")
             $ids=$_REQUEST['mer_id'];
	 $action=$_REQUEST['action'];
	 $today_date = date("Y-m-d")." 00:00:00";
	 $Where = "";
	 $location_q = ""; 
	 $merchant_array = array();
		$merchant_array['id'] = $_REQUEST['mer_id'];
		$merchant_info = $objDB->Show("merchant_user",$merchant_array);
	 if($action == "active")
	 {
	//	$Where .= " AND CONVERT_TZ(NOW(),'-06:00','+00:00') BETWEEN CONVERT_TZ(b.start_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) AND CONVERT_TZ(b.expiration_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) and a.active =1 and a.active_in_future<>1";
            
           //  $Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1  and (b.level=1 or b.is_walkin=1) and a.active_in_future<>1 and a.offers_left>0 ";
            //$Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1";
             $Where .= " AND ((CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1  and (b.level=1 or b.is_walkin=1) and a.active_in_future<>1 and a.offers_left>0 )";
		$Where .= " or (  ( a.offers_left <=0  AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date )  and (b.level=1 or b.is_walkin=1) and  b.id not in (
								SELECT y.id from campaign_location x  INNER JOIN campaigns y on x.campaign_id=y.id INNER JOIN locations z on x.location_id=z.id 
								 WHERE (x.active=1 or x.active_in_future=1) and x.offers_left>0  ".$location_q.") and ((a.active_in_future<>1 and a.active=1) or (a.active_in_future=1 and a.active<>1))  and a.offers_left <=0))";
		if($merchant_info->fields['merchant_parent'] != 0)
		{
			$merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info_c = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where ="  a.location_id=".$merchant_info_c->fields['location_access'];
		}
	}
		
	 
		
		 if($merchant_info->fields['merchant_parent'] == 0)
		 { 
         	/*$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    (b.created_by = $merchant_id or b.created_by in ( $ids))  $Where ORDER BY modified_date DESC";*/
			$RS = $objDB->Conn->Execute("SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    (b.created_by = ? or b.created_by in (?))  $Where ORDER BY modified_date DESC",array($merchant_id,$ids)); 
		 }
		 else
		 {
			 $merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where1=" a.location_id=".$merchant_info->fields['location_access'];
			
			 $Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                     $Where1 $Where ORDER BY modified_date DESC";
			$RS = $objDB->Conn->Execute($Sql); 
		 }
     
         //$json_array['query'] = $Sql;
	 //$RS = $objDB->Conn->Execute($Sql);
	 if($RS->RecordCount()>0)
	 {
		 
		 
		  $json_array['status'] = "true";
		  
                  $json_array['total_records'] = $RS->RecordCount();
		  $count=0;
		  while($Row = $RS->FetchRow())
		  {
		   	$records[$count] =get_field_value($Row);
		   	$count++;
		  }
		  $json_array["records"]= $records;
	 }
	 else
	 {
		  $json_array['status'] = "false";
		  $json_array['total_records'] = 0;
		  $json_array["records"]= "";
		  $json = json_encode($json_array);
		  echo $json;
		  exit();
	 }
	 $json = json_encode($json_array);
	 echo $json;
	 exit();
}   
/******** 
@USE : Get campaign /location qr code url
@PARAMETER : location id / campaign id
@RETURN : campaign /location qr code url
@USED IN PAGES : locations_for_marketingmaterial.php
*********/
if(isset($_REQUEST['get_campaign_qrcode_url']))
{
        $json_array = array();
        if(isset($_REQUEST['is_location']))
        {
            //$sql = "Select qrcode from qrcodes q, qrcode_location qc where q.id=qc.qrcode_id and qc.location_id=".$_REQUEST['id'];
            
            //$rs_qrcode = $objDB->Conn->Execute("Select qrcode from qrcodes q, qrcode_location qc where q.id=qc.qrcode_id and qc.location_id=?",array($_REQUEST['id']));
            $rs_qrcode = $objDB->Conn->Execute("Select qrcode from qrcodes where id = (select qrcode_id from locations where id=? )",array($_REQUEST['id']));
            
        }
        else{
            //$sql = "Select qrcode from qrcodes q, qrcode_campaign qc where q.id=qc.qrcode_id and qc.campaign_id=".$_REQUEST['id'];
            
            //$rs_qrcode = $objDB->Conn->Execute("Select qrcode from qrcodes q, qrcode_campaign qc where q.id=qc.qrcode_id and qc.campaign_id=?",array($_REQUEST['id']));
            $rs_qrcode = $objDB->Conn->Execute("Select qrcode from qrcodes where id = (select qrcode_id from campaigns where id=? )",array($_REQUEST['id']));
        }
        //$rs_qrcode = $objDB->Conn->Execute($sql);
        $url = WEB_PATH."/qr.php?qrcode=".$rs_qrcode->fields['qrcode'];
        $json_array['qrcode_url'] = $url;
		$json_array['qrcode_string'] =$rs_qrcode->fields['qrcode'];
         $json = json_encode($json_array);
                 echo $json;
	 exit();
}

/******** 
@USE : check package assigned to merchant
@PARAMETER : merchant_id
@RETURN : json data
@USED IN PAGES : my-account-left.php
*********/
if(isset($_REQUEST['is_package_assigned_to_merchant']))
{
    /*$sql = "Select * from merchant_billing where merchant_id=".$_REQUEST['merchant_id'];
    $rs_qrcode = $objDB->Conn->Execute($sql);*/
	$rs_qrcode = $objDB->Conn->Execute("Select * from merchant_billing where merchant_id=?",array($_REQUEST['merchant_id']));

    $json_array['is_assigned'] = $rs_qrcode->RecordCount();
 $json = json_encode($json_array);
	 echo $json;
	 exit();
    
}

/******** 
@USE : Check if any active location is there or not if not then dont allow to add campaign 
@PARAMETER : current login merchant id
@RETURN : location array of current login merchant id
@USED IN PAGES : compaigns.php , manage-users.php , manage-customers.php , template.php
*********/
if(isset($_REQUEST['is_any_active_location']))
{
    /*$sql = "Select count(*) total from locations where created_by=".$_REQUEST['merchant_id'] ." and active=1 " ;
    $rs_qrcode = $objDB->Conn->Execute($sql);*/
	$rs_qrcode = $objDB->Conn->Execute("Select count(*) total from locations where created_by=? and active=1 ",array($_REQUEST['merchant_id']));

    $json_array['active_locations'] = $rs_qrcode->fields['total'];
 $json = json_encode($json_array);
	 echo $json;
	 exit();
    
}

/******** 
@USE : check email exists or not
@PARAMETER : emailaddress
@RETURN : json data
@USED IN PAGES : add-user.php
*********/
if(isset($_REQUEST['is_emailaddress_exists']))
{
    $json = array();
    /*$Sql_s = "SELECT * from merchant_user WHERE email='".$_REQUEST['emailaddress']."' and active=1";
                    $RS_u = $objDB->Conn->Execute($Sql_s);*/
	$RS_u = $objDB->Conn->Execute("SELECT * from merchant_user WHERE email=? and active=?",array($_REQUEST['emailaddress'],1));
                    
                    $json_array['is_exists'] = $RS_u->RecordCount();
 $json = json_encode($json_array);
	 echo $json;
	 exit();
}


/******** 
@USE : Deactivate employee
@PARAMETER : employee id
@RETURN : deactivate employee
@USED IN PAGES : manage-users.php
*********/
if(isset($_REQUEST['deactivate_employee']))
{
	 $json_array = array();
// give all campaigns to main merchant
    $m_parent= $_REQUEST['main_merchant_id'];
    /*$sql="update campaigns set created_by=".$m_parent." , modified_by = ".$m_parent." where created_by=".$_REQUEST['id'];
     $RS_u = $objDB->Conn->Execute($sql);*/
     $RS_u = $objDBWrt->Conn->Execute("update campaigns set created_by=? , modified_by =? where created_by=?",array($m_parent,$m_parent,$_REQUEST['id']));
     
     // Give all groups to main merchant
     /*$sql = "Update merchant_groups set merchant_id = ".$m_parent." where  merchant_id =".$_REQUEST['id'];
     $RS_u = $objDB->Conn->Execute($sql);*/
     $RS_u = $objDBWrt->Conn->Execute("Update merchant_groups set merchant_id = ? where  merchant_id =?",array($m_parent,$_REQUEST['id']));
     
      // Give all sub merchants  to main merchant
     /*$sql = "Update merchant_user set merchant_parent = ".$m_parent." where  merchant_parent =".$_REQUEST['id'];
     $RS_u = $objDB->Conn->Execute($sql);*/
     $RS_u = $objDBWrt->Conn->Execute("Update merchant_user set merchant_parent = ? where  merchant_parent =?",array($m_parent,$_REQUEST['id']));
     
     // Give all tempaltes to main merchant
     /*$sql = "Update campaigns_template set created_by = ".$m_parent." where  created_by =".$_REQUEST['id'];
    $RS_u = $objDB->Conn->Execute($sql);*/
    $RS_u = $objDBWrt->Conn->Execute("Update campaigns_template set created_by = ? where  created_by =?",array($m_parent,$_REQUEST['id']));
     
     // Give all media to main merchant
     /*$sql = "Update merchant_media set merchant_id = ".$m_parent." where  merchant_id =".$_REQUEST['id'];
     $RS_u = $objDB->Conn->Execute($sql);*/
     $RS_u = $objDBWrt->Conn->Execute("Update merchant_media set merchant_id = ? where  merchant_id =?",array($m_parent,$_REQUEST['id']));
     
	 // set merchant status in active
     /*$sql  = "Update merchant_user set active=0 where id=".$_REQUEST['id'];
     $RS_u = $objDB->Conn->Execute($sql);*/
     $RS_u = $objDBWrt->Conn->Execute("Update merchant_user set active=? where id=?",array(0,$_REQUEST['id']));
	 
	 // delete merchant
	 /*$sql  = "Delete from merchant_user  where id=".$_REQUEST['id'];
     $RS_u = $objDB->Conn->Execute($sql);*/
     $RS_u = $objDBWrt->Conn->Execute("Delete from merchant_user  where id=?",array($_REQUEST['id']));
	 
//      while($Row = $RS->FetchRow())     
//      {
          
         // $update_sql = "Update campaigns set created_by=".."";
          
     // }
     
    $json_array['status'] = "true";
    $json_array['message'] = "Employee deleted successfully.";
	$json = json_encode($json_array);
	echo $json;
	exit();
	 
    //header("Location:manage-users.php");
    
}
/******** 
@USE : walk in deal list for marketing material page
@PARAMETER :  walk in status , merchant id , action , ids
@RETURN : Walk in campaign list
@USED IN PAGES : manage-marketing-material.php
*********/
if(isset($_REQUEST['walkingstatus']))
{
    if($_REQUEST['walkingstatus'] == "true")
    {
                $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
         $ids=$_REQUEST['ids'];
         if($ids=="")
             $ids=$_REQUEST['mer_id'];
	 $action=$_REQUEST['action'];
	 $today_date = date("Y-m-d")." 00:00:00";
	 $Where = "";
	 if($action == "active")
	 {
	//	$Where .= " AND CONVERT_TZ(NOW(),'-06:00','+00:00') BETWEEN CONVERT_TZ(b.start_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) AND CONVERT_TZ(b.expiration_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) and a.active =1 and a.active_in_future<>1";
            
             $Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1  and (b.level=1 or b.is_walkin=1) and a.active_in_future<>1 and a.offers_left>0 ";
           //$Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1";
             
	}
		
	 
		  $merchant_array = array();
		$merchant_array['id'] = $_REQUEST['mer_id'];		$merchant_info = $objDB->Show("merchant_user",$merchant_array);
		
		 if($merchant_info->fields['merchant_parent'] == 0)
		 { 
         	/*$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    (b.created_by = $merchant_id or b.created_by in ( $ids))  $Where and b.is_walkin=1 ORDER BY modified_date DESC"; */
		$RS = $objDB->Conn->Execute("SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where (b.created_by = ? or b.created_by in ( ?))  $Where and b.is_walkin=? ORDER BY modified_date DESC",array($merchant_id,$ids,1));

		 }
		 else
		 {
			 $merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where1=" a.location_id=".$merchant_info->fields['location_access'];
			
			$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                     $Where1 and b.is_walkin=1 $Where ORDER BY modified_date DESC"; 
		$RS = $objDB->Conn->Execute($Sql);

			
		 }
            
         $json_array['query'] = $Sql;
	 //$RS = $objDB->Conn->Execute($Sql);
	$walking_data="";
	$walking_data.="<table width='100%'  border='0' cellspacing='1' cellpadding='2' style='border-style:solid; border-collaps:collaps; border-color:#ddd;float: left' class='tableMerchant' id='example'>";
	$walking_data.="<thead>";
	 
	  
	$walking_data.="<tr>";
              $walking_data.="<th align='left' class='tableDealTh' style='width:2%;'>&nbsp;</th>";
		$walking_data.="<th align='left' class='tableDealTh' style='width:20%;'>Campaign Name</th>";
		$walking_data.="<th align='left' class='tableDealTh' style='width:10%;'>QR Code Status</th>";
             

	  $walking_data.="</tr>";
	  $walking_data.="</thead>";
	  
	  if($RS->RecordCount()>0)
	  {
	      
	      
		  while($Row = $RS->FetchRow())
		  {
			 //echo $Row['title'];
			 $walking_data.="<tbody>";
	
			$walking_data.="<tr class='tableDeal'>";
			    $walking_data.="<td>";
			      $walking_data.="<input type='radio'  visit='first' id='rd_campaigntitle_".$Row['id']."' name='rd_campaigntitle' value='".$Row['id']."' is_walkin='".$Row['is_walkin']."' />";
			    $walking_data.="</td>";
			    
			      $walking_data.="<td style='line-height:1.5;text-transform:uppercase;'>";
				 $walking_data.="<a href='javascript:void(0)' id='showCamp_".$Row['id']."'>".$Row['title']."</a>";
			      $walking_data.="</td>";
			      
				 $walking_data.="<td>";
				/*
				$wh_arr = array();
				$wh_arr['campaign_id'] = $Row['id'];
				$rs_qrcode_campaign = $objDB->Show("qrcode_campaign",$wh_arr) ;
				*/
				$rs_qrcode_campaign = $objDB->Conn->Execute("select qrcode_id from campaigns where id =? and qrcode_id!=0",array($Row['id']));
				
                $qrcodestring="";
				if($rs_qrcode_campaign->RecordCount() == 0)
				{
				  $printclass = "pcoupon";
					$downloadclass = "downloadqrcode";
					$linktext = "Link";
				}
				else
				{
					$wh_arr1 = array();
					$wh_arr1['id'] =$rs_qrcode_campaign->fields['qrcode_id'];
					$rs_qrcode = $objDB->Show("qrcodes",$wh_arr1) ;
					$qrcodestring = $rs_qrcode->fields['qrcode'];
					 $printclass = "rcoupon";
					 $downloadclass = " rdownloadqrcode";
					  $linktext = "Unlink";
				}
                        
				   $walking_data.="<a href='javascript:void(0)' campid='".$Row['id']."' qval='".$qrcodestring."' class='".$downloadclass."'>".$linktext."</a>";
				 $walking_data.="</td>";
			  $walking_data.="</tr>";
		       
			$walking_data.="</tbody>";
		 
		  }
		  
	 }

	
        $walking_data.="</table>";
        echo $walking_data;
        exit;
    }
    else
    {
                    $json_array = array();
	 $records = array();
	 
	 $merchant_id = $_REQUEST['mer_id'];
         $ids=$_REQUEST['ids'];
         if($ids=="")
             $ids=$_REQUEST['mer_id'];
	 $action=$_REQUEST['action'];
	 $today_date = date("Y-m-d")." 00:00:00";
	 $Where = "";
	 if($action == "active")
	 {
	//	$Where .= " AND CONVERT_TZ(NOW(),'-06:00','+00:00') BETWEEN CONVERT_TZ(b.start_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) AND CONVERT_TZ(b.expiration_date,'+00:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) and a.active =1 and a.active_in_future<>1";
            
             $Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1  and (b.level=1 or b.is_walkin=1) and a.active_in_future<>1 and a.offers_left>0 ";
            //$Where .= " AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1";
             
	}
		
	 
		  $merchant_array = array();
		$merchant_array['id'] = $_REQUEST['mer_id'];		$merchant_info = $objDB->Show("merchant_user",$merchant_array);
		
		 if($merchant_info->fields['merchant_parent'] == 0)
		 { 
         	/*$Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    (b.created_by = $merchant_id or b.created_by in ( $ids))  $Where ORDER BY modified_date DESC"; */
			$RS = $objDB->Conn->Execute("SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                    (b.created_by = ? or b.created_by in ( ?))  $Where ORDER BY modified_date DESC",array($merchant_id,$ids));

		 }
		 else
		 {
			 $merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where1=" a.location_id=".$merchant_info->fields['location_access'];
			
			 $Sql = "SELECT distinct b.* from campaign_location a  INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id where 
                     $Where1  $Where ORDER BY modified_date DESC"; 
			$RS = $objDB->Conn->Execute($Sql);
		 }
                
 
         $json_array['query'] = $Sql;
	 //$RS = $objDB->Conn->Execute($Sql);
	$walking_data="";
	$walking_data.="<table width='100%'  border='0' cellspacing='1' cellpadding='2' style='border-style:solid; border-collaps:collaps; border-color:#ddd;float: left' class='tableMerchant' id='example'>";
	$walking_data.="<thead>";
	 
	  
	$walking_data.="<tr>";
              $walking_data.="<th align='left' class='tableDealTh' style='width:2%;'>&nbsp;</th>";
		$walking_data.="<th align='left' class='tableDealTh' style='width:20%;'>Campaign Name</th>";
		$walking_data.="<th align='left' class='tableDealTh' style='width:10%;'>QR Code Status</th>";
             

	  $walking_data.="</tr>";
	  $walking_data.="</thead>";
	  
	  if($RS->RecordCount()>0)
	 {
	      
	      
		  while($Row = $RS->FetchRow())
		  {
			 //echo $Row['title'];
			 $walking_data.="<tbody>";
	
			$walking_data.="<tr class='tableDeal'>";
			    $walking_data.="<td>";
			      $walking_data.="<input type='radio' id='rd_campaigntitle_".$Row['id']."' name='rd_campaigntitle' value='".$Row['id']."' is_walkin='".$Row['is_walkin']."' />";
			    $walking_data.="</td>";
			    
			      $walking_data.="<td style='line-height:1.5;text-transform:uppercase;'>";
				 $walking_data.="<a href='javascript:void(0)' id='showCamp_".$Row['id']."'>".$Row['title']."</a>";
			      $walking_data.="</td>";
			      
				 $walking_data.="<td>";
				  /*
				  $wh_arr = array();
                  $wh_arr['campaign_id'] = $Row['id'];
                  $rs_qrcode_campaign = $objDB->Show("qrcode_campaign",$wh_arr) ;
                  */ 
                  $rs_qrcode_campaign = $objDB->Conn->Execute("select qrcode_id from campaigns where id =? and qrcode_id!=0",array($Row['id']));
                   
                   $qrcodestring="";
			if($rs_qrcode_campaign->RecordCount() == 0)
                        {
                          $printclass = "pcoupon";
                            $downloadclass = "downloadqrcode";
                            $linktext = "Link";
                        }
                        else{
                            $wh_arr1 = array();
                            $wh_arr1['id'] =$rs_qrcode_campaign->fields['qrcode_id'];
                            $rs_qrcode = $objDB->Show("qrcodes",$wh_arr1) ;
                            $qrcodestring = $rs_qrcode->fields['qrcode'];
                             $printclass = "rcoupon";
                             $downloadclass = " rdownloadqrcode";
                              $linktext = "Unlink";
                        }
                        
				   $walking_data.="<a href='javascript:void(0)' campid='".$Row['id']."' qval='".$qrcodestring."' class='".$downloadclass."'>".$linktext."</a>";
				 $walking_data.="</td>";
			  $walking_data.="</tr>";
		       
			$walking_data.="</tbody>";
		 
		  }
		  
            }

	
            $walking_data.="</table>";
            echo $walking_data;
            exit;
        
    }
    
    

}

/******** 
@USE : delete csv file
@PARAMETER : path
@RETURN : 
@USED IN PAGES : edit-distributionlist.php
*********/
if(isset($_REQUEST['deletecsvfile']) == "yes")
{
  unlink($_REQUEST['path']);
}

/******** 
@USE : filter distribution list according distribution list status
@PARAMETER : current login merchant id
@RETURN : location array of current login merchant id
@USED IN PAGES : compaigns.php
@EXPLAINATION : Distribution list status
Active in use : Active campaigns are linked to distribution list,
Active not in use : Campaigns are currently not linked to distribution list. 
Not Active : distribution list is de-activated.
*********/
if(isset($_REQUEST['filterlocation']))
{

    $json_array = array();
	$records = array();
	$merchant_array = array();
	$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
	$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);

	//$arr_ids1=getallmainmercahnt_id($_SESSION['merchant_id']);
	//$ids1=  implode(",", $arr_ids1);
	
	$all_sub_mer_array = $_REQUEST['all_sub_mer_array'];
	$ass_page = $_REQUEST['ass_page'];

	$l_str = '';
	/*
	if($_REQUEST['locationid'] > 0){
		$l_str = ' and l.id='.$_REQUEST['locationid'].' and  mg.location_id ='.$_REQUEST['locationid'];	
	}
    */
        
	if($_REQUEST['status'] == "all"){
            $sStr = "";
        }
        else if($_REQUEST['status'] == "active-inuse")
        {
            $sStr = "having total_campaigns >0 and active >0";
        }
        else if($_REQUEST['status'] == "active-notinuse")
        {
            $sStr = "having total_campaigns =0 and active =1";
        }
        else if($_REQUEST['status'] == "not-active")
        {
            $sStr = "having total_campaigns =0 and active =0";
        }
       
        
	//$arr_ids=getallsubmercahnt_id($_REQUEST['mer_id']);
    	//$ids=  implode(",", $arr_ids);
	$ids=implode(",", $all_sub_mer_array);
    
	    if($ids=="")
		$ids=$_REQUEST['mer_id'];

	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}
	/*
    if($_REQUEST['parent']==0)
    {
        
            if(strcmp($_REQUEST['locationid'],"all") == 0)
            {
        	
		$RS_t = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS mg.merchant_id,mg.id ,mg.group_name ,mg.active,mg.private,(select id from locations where id=mg.location_id) as l_id,
		(select GROUP_CONCAT(DISTINCT CONCAT(address,', ',city,', ',state,', ',zip)) from locations where id=mg.location_id) address, 
           ( select count(*) c from 
		merchant_subscribs mu  where 
		mu.group_id = mg.id and mu.user_id in 
		(select id from customer_user cu where cu.active=1)  group by mu.group_id )  as Cust_Total ,
		(SELECT count(cg.id)
                from campaign_groups cg,campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id
                where cg.campaign_id=b.id and cg.campaign_id=a.campaign_id and cg.group_id=mg.id and c.id=l.id and 
                (a.active =1 or a.active_in_future=1 or (b.start_date > CONVERT_TZ(NOW(),'-07:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) ) ) total_campaigns ,(select count(*) from merchant_groups mg1 where mg1.location_id=l.id) dist_list_count
				from merchant_groups mg , locations l where mg.isDeleted!=1 and l.active =1 and l.id=mg.location_id and  ( mg.merchant_id = ? or mg.merchant_id in (?)) having dist_list_count >1 $sStr order by mg.id desc ".$sLimit,array($_REQUEST["mer_id"],$ids));
           
            }
            else if(strcmp($_REQUEST['locationid'],"admin") == 0)
            {
               
		$RS_t = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS mg.merchant_id,mg.id ,mg.group_name ,mg.active,mg.private,(select id from locations where id=mg.location_id) as l_id,
				(select GROUP_CONCAT(DISTINCT CONCAT(address,', ',city,', ',state,', ',zip)) from locations where id=mg.location_id) address, 
           ( select count(*) c from 
		merchant_subscribs mu  where 
		mu.group_id = mg.id and mu.user_id in 
		(select id from customer_user cu where cu.active=1)  group by mu.group_id )  as Cust_Total,
		(SELECT count(cg.id)
                from campaign_groups cg,campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id
                where cg.campaign_id=b.id and cg.campaign_id=a.campaign_id and cg.group_id=mg.id and c.id=l.id and 
                (a.active =1 or a.active_in_future=1 or (b.start_date > CONVERT_TZ(NOW(),'-07:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) ) ) total_campaigns ,(select count(*) from merchant_groups mg1 where mg1.location_id=l.id) dist_list_count
		from merchant_groups mg , locations l where mg.isDeleted!=1 and l.active =0 and l.id=mg.location_id and 
                ( mg.merchant_id = ? or mg.merchant_id in (?)) having dist_list_count >1  $sStr order by mg.id desc ".$sLimit,array($_REQUEST["mer_id"],$ids));

                
            }
            else
            {
  
	$RS_t = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS mg.merchant_id,mg.id ,mg.group_name ,mg.active,mg.private,(select id from locations where id=mg.location_id) as l_id,
			(select GROUP_CONCAT(DISTINCT CONCAT(address,', ',city,', ',state,', ',zip)) from locations where id=mg.location_id) address, 
           ( select count(*) c from 
		merchant_subscribs mu  where 
		mu.group_id = mg.id and mu.user_id in 
		(select id from customer_user cu where cu.active=1)  group by mu.group_id )  as Cust_Total ,
	(SELECT count(cg.id)
                from campaign_groups cg,campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id
                where cg.campaign_id=b.id and cg.campaign_id=a.campaign_id and cg.group_id=mg.id and c.id=mg.location_id and 
                (a.active =1 or a.active_in_future=1 or (b.start_date > CONVERT_TZ(NOW(),'-07:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) ) ) total_campaigns,(select count(*) from merchant_groups mg1 where mg1.location_id=l.id) dist_list_count

		from merchant_groups mg , locations l where mg.isDeleted!=1 and mg.location_id=l.id and l.active =1 and mg.location_id=? and 
                ( mg.merchant_id = ? or mg.merchant_id in (?)) having dist_list_count >1  $sStr order by mg.id desc ".$sLimit,array($_REQUEST['locationid'],$_REQUEST["mer_id"],$ids));

            }
    }
    else
    {
       
            if(strcmp($_REQUEST['locationid'],"all") == 0)
            {
	
		       $RS_t = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS mg.merchant_id,mg.id ,mg.group_name ,mg.active,mg.private,(select id from locations where id=mg.location_id) as l_id,((select GROUP_CONCAT(DISTINCT CONCAT(address,', ',city,', ',state,', ',zip)) from locations where id=mg.location_id) address, 
           ( select count(*) c from 
merchant_subscribs mu  where 
mu.group_id = mg.id and mu.user_id in 
(select id from customer_user cu where cu.active=1)  group by mu.group_id )  as Cust_Total ,
(SELECT count(cg.id)
                from campaign_groups cg,campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id
                where cg.campaign_id=b.id and cg.campaign_id=a.campaign_id and cg.group_id=mg.id and c.id=l.id and 
                (a.active =1 or a.active_in_future=1 or (b.start_date > CONVERT_TZ(NOW(),'-07:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) ) ) total_campaigns,(select count(*) from merchant_groups mg1 where mg1.location_id=l.id) dist_list_count
 from merchant_groups mg , locations l  where mg.isDeleted!=1 and l.active =1 and l.id=mg.location_id and  mg.location_id = ? AND ( mg.merchant_id = ? or mg.merchant_id in (?)) having dist_list_count >1  $sStr order by mg.id desc ".$sLimit,array($merchant_info->fields['location_access'],$_REQUEST['mer_id'],$ids));
   
            }
            else if(strcmp($_REQUEST['locationid'],"admin") == 0)
            {
		
	$RS_t = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS mg.merchant_id,mg.id ,mg.group_name ,mg.active,mg.private,(select id from locations where id=mg.location_id) as l_id,
				 (select GROUP_CONCAT(DISTINCT CONCAT(address,', ',city,', ',state,', ',zip)) from locations where id=mg.location_id) address,
           ( select count(*) c from 
        merchant_subscribs mu  where 
        mu.group_id = mg.id and mu.user_id in 
        (select id from customer_user cu where cu.active=1)  group by mu.group_id )  as Cust_Total ,
(SELECT count(cg.id)
                from campaign_groups cg,campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id
                where cg.campaign_id=b.id and cg.campaign_id=a.campaign_id and cg.group_id=mg.id and c.id=l.id and 
                (a.active =1 or a.active_in_future=1 or (b.start_date > CONVERT_TZ(NOW(),'-07:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) ) ) total_campaigns	,(select count(*) from merchant_groups mg1 where mg1.location_id=l.id) dist_list_count
				from merchant_groups mg , locations l  where mg.isDeleted!=1 and 
        l.active =0 and l.id=mg.location_id and  mg.location_id = 0 AND ( mg.merchant_id = ? or mg.merchant_id in (?)) having dist_list_count >1 $sStr  order by mg.id desc ".$sLimit,array($merchant_info->fields['location_access'],$_REQUEST['mer_id'],$ids));   
                
            }
            else
            {
	

		$RS_t = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS mg.merchant_id,mg.id ,mg.group_name ,mg.active,(select id from locations where id=mg.location_id) as l_id,
					(select GROUP_CONCAT(DISTINCT CONCAT(address,', ',city,', ',state,', ',zip)) from locations where id=mg.location_id) address,  
				   ( select count(*) c from 
				merchant_subscribs mu  where 
				mu.group_id = mg.id and mu.user_id in 
				(select id from customer_user cu where cu.active=1)  group by mu.group_id )  as Cust_Total,
				(SELECT count(cg.id)
                from campaign_groups cg,campaign_location a INNER JOIN campaigns b on a.campaign_id=b.id INNER JOIN locations c on a.location_id=c.id
                where cg.campaign_id=b.id and cg.campaign_id=a.campaign_id and cg.group_id=mg.id and c.id=mg.location_id and 
                (a.active =1 or a.active_in_future=1 or (b.start_date > CONVERT_TZ(NOW(),'-07:00',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) ) ) ) total_campaigns,(select count(*) from merchant_groups mg1 where mg1.location_id=l.id) dist_list_count
 from merchant_groups mg , locations l  where mg.isDeleted!=1 and l.active =1 and l.id=? and  mg.location_id =? AND ( mg.merchant_id = ? or mg.merchant_id in (?)) having dist_list_count >1  $sStr order by mg.id desc ".$sLimit,array($_REQUEST['locationid'],$_REQUEST['locationid'],$_REQUEST['mer_id'],$ids));
   
            }
	}
	*/
	/*
	echo "select SQL_CALC_FOUND_ROWS mc.merchant_id,mc.id ,mc.group_name ,mc.active,
(select COUNT(*) from merchant_customerlist_detail mcd 
where mc.id=mcd.merchant_group_id ) as Cust_Total,
(select count(*) from campaign_customer_list ccl where ccl.merchant_group_id= mc.id) as total_campaigns
from merchant_customerlist mc
where mc.isDeleted!=1 and ( mc.merchant_id = ".$_REQUEST["mer_id"]." or mc.merchant_id in (".$ids.")) $sStr order by mc.id desc ".$sLimit; 
	*/ 
	$RS_t = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS mc.merchant_id,mc.id ,mc.group_name ,mc.active,mc.is_segmented,
(select COUNT(*) from merchant_customerlist_detail mcd 
where mc.id=mcd.merchant_group_id ) as Cust_Total,
(select count(*) from campaign_customer_list ccl where ccl.merchant_group_id= mc.id) as total_campaigns
from merchant_customerlist mc
where mc.isDeleted!=1 and ( mc.merchant_id = ? or mc.merchant_id in (?)) $sStr order by mc.id desc ".$sLimit,array($_REQUEST["mer_id"],$ids));

	$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
	$total= $sQuery->fields['FOUND_ROWS()'];
   
	$Json = array();
	$Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
	$Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
	$Json['iTotalDisplayRecords'] = $total;
	$Json['sEcho'] = $_REQUEST['sEcho'];
	$Json['sSearch'] = $_REQUEST['sSearch'];
	$Json['aaData'] = array();

	$k = 0 ;
	$all_loctions_counter = 0;
	 while($Row = $RS_t->FetchRow()){
		
                if ((in_array($Row['merchant_id'], $all_sub_mer_array)) || $Row['group_name']=="private" || $Row['merchant_id'] == $_SESSION['merchant_id']){
						/*
                        if($Row['group_name'] == "private")
                        {
                            $Json['aaData'][$k][]='Merchant location subscribers';
                        }
                        else
                        {
                            $Json['aaData'][$k][]=$Row['group_name'];
                        }
                        */ 
                        $Json['aaData'][$k][]=$Row['group_name'];
                        //$Json['aaData'][$k][]=$Row['address'];
                        $Json['aaData'][$k][]=($Row['Cust_Total'] >0)?$Row['Cust_Total']:0;

                        if($Row['total_campaigns'] == 0)
                        { 
                               if($Row['active'] == 1)
                                {
                                        $fs = $merchant_msg["manage-customers"]["Field_Satus_Active-Not-In-Use-Color"];
                                        $fsm = $merchant_msg["manage-customers"]["Field_Satus_Active-Not-In-Use"];
                                }
                                else 
                                {
                                        $fs = $merchant_msg["manage-customers"]["Field_Satus_Not-Active-Color"];
                                        $fsm = $merchant_msg["manage-customers"]["Field_Satus_Not-Active"];
                                }
                        }else{ 
                                        $fs = $merchant_msg["manage-customers"]["Field_Satus_Active-In-Use-Color"];
                                        $fsm = $merchant_msg["manage-customers"]["Field_Satus_Active-In-Use"];

                        }

                        $Json['aaData'][$k][]="<span style='color:".$fs."'  >".$fsm."</span>";

                        $html ='';
                        /*
                        if($Row['group_name']!="private" )
                        {
							if(in_array("add-group.php",$ass_page) || $_SESSION['merchant_info']['merchant_parent'] == 0 || (in_array("delete-group.php",$ass_page) && $total_records1==0 ))
							{ 
								$html .= 'More  Actions';
							}
							else
							{
								$html .= '<span class="inactive_moreaction" >More  Actions</span>';
							}
                        }
                        else
                        {
                            $html .='<span class="inactive_moreaction" >More  Actions</span>';
                        }
                        */ 
						//$html .='<div class="action_wrapper">';

                        if($Row['group_name']!="private" )
                        {
							if(in_array("add-group.php",$ass_page) || $_SESSION['merchant_info']['merchant_parent'] == 0 || (in_array("delete-group.php",$ass_page) && $total_records1==0 ))
							{
								//$html .= '<div id="actiondiv" class="actiondivclass">';
							
								if($Row['is_segmented']!=1)
								{	
									if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-group.php",$ass_page))
									{ 
										$html .= '<a class="commonclass" link="edit-distributionlist.php?id='.$Row['id'].'&status='.strtolower($fsm).'" href="javascript:void(0);">Edit</a>';
									}
								}
									
								if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("add-group.php",$ass_page))
								{ 
									//$html .='<a class="commonclass" link="group_clone_distributionlist.php?id='.$Row['id'].'" href="javascript:void(0);">Copy</a>';
								}
                                
								if($_SESSION['merchant_info']['merchant_parent'] == 0 || in_array("delete-group.php",$ass_page))
								{ 

									if($total_records1==0)
									{
										if($fsm != 'Active')
										{			
											if($Row['active'] == 1)
											{
												//$html .='<a class="commonclass" link="process.php?id='.$Row['id'].'&btnActivateDeactivateGroup=yes&action=0" href="javascript:void(0);">Deactivate</a>';
											}
											else 
											{
												$html .='<a class="commonclass" link="process.php?id='.$Row['id'].'&btnActivateDeactivateGroup=yes&action=1" href="javascript:void(0);">Activate</a>';
											}
										}							
									}

									if($Row['total_campaigns'] == 0)
									{ 
										if($Row['active'] == 1)
										{
											if($Row['Cust_Total']==0)
											{
												$html .='<a class="commonclass delete_dist_list" link="process.php?id='.$Row['id'].'&btndeletegroup=yes&action=1&hard=1" href="javascript:void(0);">Delete</a>';
											}
											else
											{
												$html .='<a class="commonclass delete_dist_list" link="process.php?id='.$Row['id'].'&btndeletegroup=yes&action=1&hard=0" href="javascript:void(0);">Delete</a>';
											}
										}
										else 
										{
											if($Row['Cust_Total']==0)
											{
												$html .='<a class="commonclass delete_dist_list" link="process.php?id='.$Row['id'].'&btndeletegroup=yes&action=1&hard=1" href="javascript:void(0);">Delete</a>';
											}
											else
											{
												$html .='<a class="commonclass delete_dist_list" link="process.php?id='.$Row['id'].'&btndeletegroup=yes&action=1&hard=0" href="javascript:void(0);">Delete</a>';
											}
										}
									}
                                }
							//$html .='</div>';
                            }
                        }
                        //$html .='</div>';
                        $Json['aaData'][$k][]= $html;
                }
		$k++;
       	}

        echo json_encode($Json);
        exit;
}

/******** 
@USE : check location active or not
@PARAMETER : loc_id
@RETURN : json data
@USED IN PAGES : add-compaign.php,edit-compaign.php,copy-compaign.php,edit-distributionlist.php,import-customers.php
*********/
if(isset($_REQUEST['check_location_active']))
{
	$array = $json_array = array();
    $location_id=$_REQUEST['loc_id'];
	/*$Sql = "select * FROM locations where id=".$location_id;
    $RS =  $objDB->execute_query($Sql);*/
	$RS =  $objDB->Conn->Execute("select * FROM locations where id=?",array($location_id));
	if($RS->fields['active']=="1")
	{
		$json_array['status'] = "true";
		$json_array['message'] =$RS->fields['location_name']." is active.";
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['message'] = $RS->fields['location_name'].$merchant_msg["edit-compaign"]["Msg_location_not_active"];
	}
	$json = json_encode($json_array);
	echo $json;
	return $json;	
}

/******** 
@USE : check campaign offer on location
@PARAMETER : loc_id,camp_id
@RETURN : json data
@USED IN PAGES : add-compaign.php,edit-compaign.php,copy-compaign.php,edit-distributionlist.php,import-customers.php
*********/
if(isset($_REQUEST['check_location_offer']))
{
	$array = $json_array = array();
    $location_id=$_REQUEST['loc_id'];
    $campaign_id=$_REQUEST['camp_id'];
	/*$Sql = "select * FROM campaign_location where campaign_id=".$campaign_id." and location_id=".$location_id;
    $RS =  $objDB->execute_query($Sql);*/
	$RS =  $objDB->Conn->Execute("select * FROM campaign_location where campaign_id=? and location_id=?",array($campaign_id,$location_id));

	$json_array['status'] = "true";
	$json_array['offers_left'] = $RS->fields['offers_left'];
	
	$json = json_encode($json_array);
	echo $json;
	return $json;	
}

/******** 
@USE : update referral customers limit left
@PARAMETER : camp_id
@RETURN : json data
@USED IN PAGES : edit-compaign.php
*********/
if(isset($_REQUEST['update_referral_customers_limit_left']))
{
	$array = $json_array = array();
    $campaign_id=$_REQUEST['camp_id'];
	/*$Sql = "select max_no_sharing,no_of_shared FROM campaigns where id=".$campaign_id;
    $RS =  $objDB->execute_query($Sql);*/
	$RS =  $objDB->Conn->Execute("select max_no_sharing,no_of_shared FROM campaigns where id=?",array($campaign_id));

	$json_array['status'] = "true";
	$json_array['max_no_sharing'] = $RS->fields['max_no_sharing'];
	$json_array['no_of_shared'] = $RS->fields['no_of_shared'];
	
	$json = json_encode($json_array);
	echo $json;
	return $json;	
}

/******** 
@USE : check login or not
@PARAMETER : 
@RETURN : json data
@USED IN PAGES : all pages
*********/
if(isset($_REQUEST['loginornot']))
{
    if($_SESSION['merchant_id'] == "")
	{    
		$json_array = array();
		$json_array['status'] = "false";
		if(isset($_REQUEST["tab"]))
		{
			$json_array['link'] =WEB_PATH."/merchant/register.php?url=".urlencode($_SERVER['HTTP_REFERER'])."&tab=".$_REQUEST["tab"];
		}
		else
		{
			$json_array['link'] =WEB_PATH."/merchant/register.php?url=".urlencode($_SERVER['HTTP_REFERER']);
		}
		$json_array['is_profileset'] = 1;
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	else
	{
		$json_array = array();
		$json_array['status'] = "true";
		$json_array['merchant_id'] = $_SESSION['merchant_id'];
		/*$Sql = "select approve from merchant_user where id=".$_SESSION['merchant_id'];

		$RS =  $objDB->execute_query($Sql);*/
		$RS =  $objDB->Conn->Execute("select approve from merchant_user where id=?",array($_SESSION['merchant_id']));
		$json_array['approve'] = $RS->fields['approve'];     
		$json_array['is_profileset'] = 1;
		$json = json_encode($json_array);
		echo $json;
		exit();
	}		
}

/******** 
@USE : check location exist for campaign
@PARAMETER : camp_id,dist_list_id
@RETURN : json data
@USED IN PAGES : add-compaign.php,edit-compaign.php
*********/
if(isset($_REQUEST['check_location_exist_for_campaign']))
{
	$array = $json_array = array();
    //$location_id=$_REQUEST['loc_id'];
	$dist_list_id=$_REQUEST['dist_list_id'];
	$campaign_id=$_REQUEST['camp_id'];
	
	//$Sql = "select * from campaign_location where location_id=".$location_id." and campaign_id=".$campaign_id;
/*	$Sql = "select * from campaign_groups where group_id=".$dist_list_id." and campaign_id=".$campaign_id;
    $RS =  $objDB->execute_query($Sql);*/
	$RS =  $objDB->Conn->Execute("select * from campaign_groups where group_id=? and campaign_id=?",array($dist_list_id,$campaign_id));

	if($RS->RecordCount()>0)
	{
		$json_array['status'] = "true";
	}
	else
	{
		$json_array['status'] = "false";
	}
	$json = json_encode($json_array);
	echo $json;
	return $json;	
}

/******** 
@USE : check distribution list active
@PARAMETER : dist_list_id
@RETURN : json data
@USED IN PAGES : add-compaign.php,edit-compaign.php,copy-compaign.php
*********/
if(isset($_REQUEST['check_dist_list_active']))
{
	$array = $json_array = array();
	$dist_list_id=$_REQUEST['dist_list_id'];
	/*$Sql = "select * from merchant_groups where id=".$dist_list_id;
    $RS =  $objDB->execute_query($Sql);*/
	$RS =  $objDB->Conn->Execute("select * from merchant_groups where id=?",array($dist_list_id));
	if($RS->fields['active']=="1")
	{
		$json_array['status'] = "true";
		$json_array['message'] =$RS->fields['group_name']." is active.";
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['message'] =$RS->fields['group_name'].$merchant_msg["edit-compaign"]["Msg_dist_list_not_active"];
	}
	$json = json_encode($json_array);
	echo $json;
	return $json;	
}

/******** 
@USE : check template name exist
@PARAMETER : template_name
@RETURN : json data
@USED IN PAGES : add-template.php,edit-template.php,customize-template.php
*********/
if(isset($_REQUEST['check_template_name_exist']))
{
    $val_= $_REQUEST['template_name'];
    
    
    $merchant_array = array();
	$merchant_array['id'] = $_REQUEST['mer_id'];
	$merchant_info = $objDB->Show("merchant_user",$merchant_array);
        //echo $merchant_info->fields['merchant_parent']."=====";
    if($merchant_info->fields['merchant_parent'] == 0){
        $m_id = $_REQUEST['mer_id'];
    }
    else{
        $m_id = $merchant_info->fields['merchant_parent'];
    }
   
   $arr_ids=getallsubmercahnt_id($m_id);
    $ids=  implode(",", $arr_ids);
      if(count($arr_ids) == 0){
        $mer_sql = "(  created_by = ".$m_id." or created_by = 0 )";
    }
    else{
        $mer_sql = "( created_by in ( ".$ids.") or created_by = ".$m_id." or created_by = 0 )";
    }
    
    if(isset($_REQUEST['id']))
    {
		if($_REQUEST['id'] == "")
		{
			//$Sql = "select * from campaigns_template where title='".$val_."'  and ".$mer_sql;
		 $RS = $objDB->Conn->Execute("select * from campaigns_template where title=?  and ".$mer_sql,array($val_));
		}
		else
		{
			//$Sql = "select * from campaigns_template where title='".$val_."'  and '".$mer_sql."' or title=(select title from campaigns_template where id='".$_REQUEST['id']."')";
	  /*$Sql = "select * from campaigns_template where title='".$val_."' and title!=(select title from campaigns_template where id='".$_REQUEST['id']."')";     */
			$RS = $objDB->Conn->Execute("select * from campaigns_template where title=? and title!=(select title from campaigns_template where id=?)",array($val_,$_REQUEST['id'])); 
		}
	}
	else
	{
		//$Sql = "select * from campaigns_template where title='".$val_."'  and ".$mer_sql;
		 $RS = $objDB->Conn->Execute("select * from campaigns_template where title=?  and ".$mer_sql,array($val_));
	}
    
    //$RS = $objDB->Conn->Execute($Sql);
   if($RS->RecordCount()>0)
    {
  
       echo 0;
   }
 else {
  
       echo 1;
       
 }
  
}

/******** 
@USE : check distribution list active in bulk
@PARAMETER : dist_list_id_str
@RETURN : json data
@USED IN PAGES : add-compaign.php,edit-compaign.php,copy-compaign.php
*********/
if(isset($_REQUEST['check_dist_list_active_bulk']))
{
	$array = $json_array = array();
	$dist_list_id_str=$_REQUEST['dist_list_id_str'];
	/*$Sql = "select * from merchant_groups where id in (".$dist_list_id_str.")";
    $RS =  $objDB->execute_query($Sql);*/
	$RS =  $objDB->Conn->Execute("select * from merchant_groups where id in (?)",array($dist_list_id_str));

	$total_records=$RS->RecordCount();
	$msg="";
	if($total_records>0)
	{           
            while($Row=$RS->FetchRow())
            {
                    if($Row['active']=="1")
					{
						$json_array['status'] = "true";
						$json_array['message'] =$Row['group_name']." is active.";
					}
					else
					{
						$json_array['status'] = "false";
						$msg .= '<div>* '.$Row["group_name"].$merchant_msg["edit-compaign"]["Msg_dist_list_not_active"].'</div>';
						//$json_array['message'] =$Row['group_name'].$merchant_msg["edit-compaign"]["Msg_dist_list_not_active"];
					}
		   }
	}	   
	$json_array['message'] = $msg;
	$json = json_encode($json_array);
	echo $json;
	return $json;	
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['checkphonenumber']))
{
	if($_REQUEST['location_id'] != "")
	{
		/*$Sql = "select * from locations where phone_number='".$_REQUEST['mobileno']."' and phone_number!=(select phone_number from locations where id='".$_REQUEST['location_id']."')" ;
	   
        $RS_loc = $objDB->Conn->Execute($Sql);*/
	$RS_loc = $objDB->Conn->Execute("select * from locations where phone_number=? and phone_number!=(select phone_number from locations where id=?)",array($_REQUEST['mobileno'],$_REQUEST['location_id']));
	
        if($RS_loc->RecordCount()>0){
            echo "1";
		}
	else
	{
		echo "0";
	}
	}
	else
	{
	/*$Sql = "select * from locations where phone_number='".$_REQUEST['mobileno']."'" ;
	   
        $RS_loc = $objDB->Conn->Execute($Sql);*/
	$RS_loc = $objDB->Conn->Execute("select * from locations where phone_number=?",array($_REQUEST['mobileno']));
	
        if($RS_loc->RecordCount()>0){
            echo "1";
		}
	else
	{
		echo "0";
	}
	}
}

/******** 
@USE : check primary location
@PARAMETER : location_id
@RETURN : json data
@USED IN PAGES : add-location.php,edit-location.php
*********/
if(isset($_REQUEST['checkprimarylocation']))
{
	if($_REQUEST['location_id'] != "")
	{
		/*$Sql = "select * from locations where is_primary='".$_REQUEST['checkboxvalue']."' and is_primary!=(select is_primary from locations where id='".$_REQUEST['location_id']."')" ;
	   
        $RS_loc = $objDB->Conn->Execute($Sql);*/
	$RS_loc = $objDB->Conn->Execute("select * from locations where is_primary=? and is_primary!=(select is_primary from locations where id=?)",array($_REQUEST['checkboxvalue'],$_REQUEST['location_id']));
	
        if($RS_loc->RecordCount()>0){
            echo "1";
		}
	else
	{
		echo "0";
	}
	}
	else
	{
	/*$Sql = "select * from locations where is_primary='".$_REQUEST['checkboxvalue']."'" ;
	    
        $RS_loc = $objDB->Conn->Execute($Sql);*/
	$RS_loc = $objDB->Conn->Execute("select * from locations where is_primary=?",array($_REQUEST['checkboxvalue']));
	
        if($RS_loc->RecordCount()>0){
            echo "1";
			
	}
	else
	{
		echo "0";
	}
	}
}

/******** 
@USE : Get total purchase points by merchant up to current date
@PARAMETER : current login merchant id
@RETURN : Sum of total purchase point
@USED IN PAGES : purchase-points.php , purchasepoint-edit.php
*********/
if(isset($_REQUEST['get_total_purchased_points']))
{
	$array = $json_array = array();
	$mer_id=$_REQUEST['mer_id'];
	/*$Sql = "select IFNULL(sum(purchased_point),0) 'total' from merchant_points where merchant_id=".$mer_id;
    $RS =  $objDB->execute_query($Sql);*/
	$RS =  $objDB->Conn->Execute("select IFNULL(sum(purchased_point),0) 'total' from merchant_points where merchant_id=?",array($mer_id));
	$total_records=$RS->RecordCount();
          
    $json_array['status'] = "true";
	$json_array['total_purchased_points'] =$RS->fields['total'];

	$json = json_encode($json_array);
	echo $json;
	return $json;	
}

/******** 
@USE : filet media images according to image type
@PARAMETER : image type
@RETURN : filtered media images according  to image type
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['medialfiltering']))
{
  $arr_ids1=getallmainmercahnt_id($_SESSION['merchant_id']);
  $ids1=  implode(",", $arr_ids1);
  
  if($ids1 == "")
  {
      $ids1 =$_SESSION['merchant_id'];
  }
  
   $arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
  $ids=  implode(",", $arr_ids);
  		if($ids=="")
                	$ids=$_SESSION['merchant_id'];  
    
  
    //9-10-2013 Display all images syblic  
        $main_merchant_id = getmainmercahnt_id($_SESSION['merchant_id']);
        
        $arr_ids_string=getallsubmercahnt_id($main_merchant_id);
       
		$sub_merchant=  implode(",", $arr_ids_string);
		if($sub_merchant=="")
                {
		    $sub_merchant=$_SESSION['merchant_id'];
                }    
        //End 9-10-2013
	 
        
     $merchant_array = array();
		$merchant_array['id'] = $_SESSION['merchant_id'];
		$merchant_info = $objDB->Show("merchant_user",$merchant_array);
                
                    if($_REQUEST['imagetype']!='all')
                    {
                        /*$query = "select * from merchant_media where media_type_id='".$_REQUEST['imagetype']."' and (merchant_id in (".$ids1.") or merchant_id=".$merchant_info->fields['merchant_parent'] ." or merchant_id in (".$sub_merchant.") or merchant_id in (select id from merchant_user where merchant_parent =". $_SESSION['merchant_id'] .")) order by id desc" ;*/
			$RS = $objDB->Conn->Execute("select * from merchant_media where media_type_id=? and (merchant_id in (?) or merchant_id=".$merchant_info->fields['merchant_parent'] ." or merchant_id in (".$sub_merchant.") or merchant_id in (select id from merchant_user where merchant_parent =?)) order by id desc",array($_REQUEST['imagetype'],$ids1,$_SESSION['merchant_id']));
                    }
                    else
                    {
                        //$query = "select * from merchant_media where merchant_id=".$_SESSION['merchant_id'] ." or merchant_id=".$merchant_info->fields['merchant_parent'] ." or merchant_id in (select id from merchant_user where merchant_parent =". $_SESSION['merchant_id'] .") order by id desc" ;
                        /*$query = "select * from merchant_media where merchant_id=".$_SESSION['merchant_id'] ." or merchant_id in (".$ids1.") or merchant_id in (".$sub_merchant.") or merchant_id in (select id from merchant_user where merchant_parent =". $_SESSION['merchant_id'] .") order by id desc" ;*/
			$RS = $objDB->Conn->Execute("select * from merchant_media where merchant_id=? or merchant_id in (?) or merchant_id in (".$sub_merchant.") or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc",array($_SESSION['merchant_id'],$ids1,$_SESSION['merchant_id']));

                    }
               
                    
       
	  //$RS = $objDB->execute_query($query);
           $flag_delete = true;
	  $flag_view = true;
	  $flag_upload = true;
		if($merchant_info->fields['merchant_parent'] != 0)
		{
			
			$media_acc_array = array();
			$media_acc_array['merchant_user_id'] = $_SESSION['merchant_id'];;
			$RSmedia = $objDB->Show("merchant_user_role",$media_acc_array);
			$media_val = unserialize($RSmedia->fields['media_access']);
			if(in_array("delete",$media_val))
			{
				$flag_delete = true;
			}
			else{
				$flag_delete = false;	
			}
			if(in_array("view-use",$media_val))
			{
				$flag_view = true;
			}
			else{
				$flag_view = false;	
			}
			if(in_array("upload",$media_val))
			{
				$flag_upload = true;
			}
			else{
				$flag_upload = false;	
			}
		}
		else{
			$flag_delete = true;
			  $flag_view = true;
			$flag_upload = true;
		}
         echo '<table width="100%"  border="0" cellspacing="1" cellpadding="10"  class="cls_left tableMerchant" id="example">';
	echo '<thead>';
	 echo  '<tr>';
		echo '<td colspan="5" class="msgclass table_errore_message" align="left" >'.$_SESSION['msg'].'</td>';
		echo '</tr>';
	  echo '<tr>';

		echo '<th width="table_th_50" align="left" class="tableDealTh">Image</th>';
		
		echo '<th width="table_th_20" align="left" class="tableDealTh">Created Date</th>';
		 if($flag_delete){
		echo '<th width="table_th_10" align="left" class="tableDealTh">Delete</th>';
		 }
	  echo '</tr>';
	  echo '</thead>';
	  echo '<tbody>';
          if($RS->RecordCount()>0){
	  	while($Row = $RS->FetchRow()){
		if($Row['image_type'] == "template" || $Row['image_type'] == "campaign")
		{
			$target = "campaign" ;
		}
		else{
			$target = "location";
		}
		if($Row['media_type_id'] == "1")
		{
			$target = "campaign" ;
		}
		if($Row['media_type_id'] == "2")
		{
			$target = "location";
		}
          echo '<tr class="tableDeal">';
          
		echo '<td>';
                $image_path=ASSETS_IMG."/m/".$target."/".$Row['image'];
                
		echo '<img src="'.$image_path.'" height="50px" width="50px" />';
                echo '<span class="vertical_top" id="span_img_text_"'.$Row['id'].'"">'.$Row['image'].'</span>';
                

                echo '</td>';
		
                echo '<td>';
                   echo  date("Y-m-d g:i:s A", strtotime($Row['created_date']));
                echo '</td>';
		
		
		
		if($flag_delete)
		{
                    
                    if(in_array($Row['merchant_id'], $arr_ids1))
                    {
                        echo '<td>&nbsp;</td>';
                    }
                    else if(!in_array($Row['merchant_id'], $arr_ids1) && !in_array($Row['merchant_id'], $arr_ids) && $Row['merchant_id']!=$_SESSION['merchant_id'])
                            
                    {
                       
                        echo '<td>&nbsp;</td>';
                                    
                    }
                    else
                    {
			
                       echo '<td>';
                       $href=WEB_PATH."/merchant/media-management.php?src=".$Row['image']."&id=".$Row['id']."&action=delete&image_type=".$Row['image_type'];
                       
                       echo '<a id="mediadeleteid_'.$Row['id'].'" href="javascript:void(0)" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'"><img src="'.ASSETS_IMG.'/m/icon-delete.png"/></a></td>';
                       
                }
               }
	  echo '</tr>';
          
          
         
	  
	  
		
                }
          }
          echo '</tbody>';
          echo '</table>';
}

/******** 
@USE : Block employee
@PARAMETER : employee id
@RETURN : block employee
@USED IN PAGES : manage-users.php
*********/
if(isset($_REQUEST['employeeblock']))
{
     $array = array();
    $where_clause = array();
     if($_REQUEST['approve']==1)
    {
        $array['approve'] =1 ;
    }
    else {
           $array['approve'] =0 ;
    }
         // $array['approve'] =0 ;
    $where_clause['id']=$_REQUEST['id'];
    $objDBWrt->Update($array, "merchant_user", $where_clause);
    
    //header("Location:".WEB_PATH."/merchant/manage-users.php");
    
}

/******** 
@USE : Get employee detail
@PARAMETER : employee id
@RETURN : Employee detail
@USED IN PAGES : manage-users.php
*********/
if(isset($_REQUEST['getEmployeedetail_for_popup']))
{
    $cid = $_REQUEST['empid'];
    $c_array = array();
    $c_array['id']= $cid;
    $RS = $objDB->Show("merchant_user", $c_array);
    
    $c_array1 = array();
    $c_array1['id']= $RS->fields['merchant_parent'];
    $RS1 = $objDB->Show("merchant_user", $c_array1);
    
    
    $main_var="";
    $main_var .="<div class='employee_detail_heading' >";
    $main_var.= "<div class='employee_detail_content_msg'>";
    $main_var.= "Employee Detail";
    $main_var.= "</div>";
    $main_var.= "<div class='content'>";
        $main_var.= "<table class='padding_10'>";
        $main_var.= "<tr>";
            $main_var.= "<td>";
            $main_var.= "<span>First Name :</span>";
            $main_var.= "</td>";
            $main_var.= "<td>";
            $main_var.= "<span>".$RS->fields['firstname']."</span>";
            $main_var.= "</td>";
            
                   
        $main_var.= "</tr>";
            
        $main_var.= "<tr>";
            $main_var.= "<td>";
                $main_var.= "<span>Last Name :</span>";
            $main_var.= "</td>";
            $main_var.= "<td>";
                $main_var.= "<span>".$RS->fields['lastname']."</span>";
            $main_var.= "</td>";
        $main_var.= "</tr>";
        
        $main_var.= "<tr>";
            $main_var.= "<td>";
                $main_var.= "<span>Address :</span>";
            $main_var.= "</td>";
            $main_var.= "<td>";
            if($RS->fields['address'] == "")
            {
                
            }
            else
            {
               $main_var.= "<div>".$RS->fields['address'].", "."<div>";
               $main_var.=  "<div>".$RS->fields['city'].", ".$RS->fields['state'].", ".$RS->fields['country'].", ".$RS->fields['zipcode']."</span>"; 
            }
                $main_var.= "</td>";
        $main_var.= "</tr>";
        $main_var.= "<tr>";
        
            $main_var.= "<td>";
                $main_var.= "<span>Phone Number :</span>";
            $main_var.= "</td>";
            $main_var.= "<td>";
            if($RS->fields['phone_number'] != ""){
                        $phno = explode("-",$RS->fields['phone_number']);
                     $newphno = "(".$phno[1].") ".$phno[2]."-".$phno[3];
                        
                    
                $main_var.= "<span>".$newphno."</span>";
            }
            
            $main_var.= "</td>";
        $main_var.= "</tr>";
        
        $main_var.= "<tr>";
            $main_var.= "<td>";
                $main_var.= "<span>Created by :</span>";
            $main_var.= "</td>";
            $main_var.= "<td>";
                $main_var.= "<span>".$RS1->fields['firstname']." ".$RS1->fields['lastname']."</span>";
            $main_var.= "</td>";
        $main_var.= "</tr>";
        
    $main_var.= "</table>";
    
    
    $main_var.= "</div>";
  $main_var.= "</div>";  
    
    echo $main_var;
    
}

/******** 
@USE : check distribution list active
@PARAMETER : address,mobile_country_code,mobileno_area_code,mobileno2,mobileno,city,zipcode
@RETURN : json data
@USED IN PAGES : my-account.php
*********/
if(isset($_REQUEST['notsetprofile']))
{
   $array = $json_array = $where_clause = array();
	$merchant_id = $_SESSION['merchant_id'];
	
	if(isset($_REQUEST['address']))
        {
		$array['address'] = ucwords(strtolower($_REQUEST['address']));
        }
		
	
	$mobile_no=$_REQUEST['mobile_country_code']."-".$_REQUEST['mobileno_area_code']."-".$_REQUEST['mobileno2']."-".$_REQUEST['mobileno'];
	$array['phone_number']=$mobile_no;
        $array['city']=$_REQUEST['city'];
        $array['zipcode']=$_REQUEST['zipcode'];
		
        
	$where_clause['id'] = $merchant_id;
        	if($where_clause['id'] == "")
        {
		$json_array['status'] = "false";
		$json_array['message'] = "Invalid Merchant ID";
	}
        else
        {
		$objDBWrt->Update($array, "merchant_user", $where_clause);
		$json_array['status'] = "true";
                $_SESSION['msg'] = "Profile has been updated successfully";
		$json_array['message'] = "Profile has been updated successfully";
	}
	 
	$json = json_encode($json_array);
	echo $json;
	exit();
    
}
/******** 
@USE : check whether parent merchant is login or employee login and employee assigned location
@PARAMETER : current login merchant id
@RETURN : location list
@USED IN PAGES : reports.php
*********/
if(isset($_REQUEST['check_locations_report']))
{
	$l ="";
$json_array = array();
$merchant_id = $_SESSION['merchant_id'];
$arr=file(WEB_PATH.'/merchant/process.php?getallsubmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);
if(trim($arr[0]) == "")
{
        unset($arr[0]);
        $arr = array_values($arr);
}
$json = json_decode($arr[0]);
$ids= $json->all_sub_merchant_id;
if($ids=="")
             $ids=$_SESSION['merchant_id'];
			 
			 
			 if($_SESSION['merchant_info']['merchant_parent'] == 0)
		 { 
         	$merchant_sql = " and (b.created_by = ".$merchant_id." or b.created_by in (".$ids.")) "; 
		 }
		 else
		 {
			 $merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where1=" a.location_id=".$merchant_info->fields['location_access'];
			
			 $merchant_sql = "and  b.created_by = ".$merchant_id  ; 
		 }
//echo 123;
		if(isset($_REQUEST['month']))
		{		
			if($_REQUEST['month'] != 0)
			{
				if($_REQUEST['month']==4 ||$_REQUEST['month']==6 ||$_REQUEST['month']==9 ||$_REQUEST['month']==11 )
				{
					$m=30;
				}
				else if($_REQUEST['month']==2)
				{
					$m=28;
				}
				else
				{
					$m =31;
				}
			}
		}
		if(isset($_REQUEST['month']) && isset($_REQUEST['year']))
		{
			if($_REQUEST['year'] != 0 && $_REQUEST['month'] != 0)
			{
				   $from_date = $_REQUEST['year']."-".$_REQUEST['month']."-01 00:00:00";
					$to_date =  $_REQUEST['year']."-".$_REQUEST['month']."-".$m." 23:59:59";
			}
			else if($_REQUEST['year'] != 0 && $_REQUEST['month'] == 0)
			{
					   $from_date = $_REQUEST['year']."-01-01 00:00:00";
						$to_date =  $_REQUEST['year']."-12-31 23:59:59";
			}
		}
		if(isset($_REQUEST['month']))
		{
			if($_REQUEST['month'] == 0 )
			{
				$month_expr = " and  DATE_FORMAT(c.expiration_date,'%Y') =".$_REQUEST['year']." ";
			}
			else
			{
			   $month_expr = " and  DATE_FORMAT(c.expiration_date,'%m') =".$_REQUEST['month']." ";
			}
		}
		if(isset($_REQUEST['year']))
		{	
			if($_REQUEST['year'] != 0 )
			{
				$dt_wh = "c.expiration_date <'".$to_date ."' ";
				$dt_wh1 = "";

								   
									   /*$sql = " select distinct a.* ,b.location_name ,b.address ,b.zip,b.created_by ,b.id location_id ,(select gender c from customer_user c where  c.id=a.user_id) gender
												from scan_qrcode a inner join locations b on a.location_id = b.id inner join campaigns c on a.campaign_id = c.id 
				where a.is_location<>1 and a.campaign_id in ( select campaign_id from campaign_location cl where cl.active<>1 and cl.active_in_future<>1 
				) and 
				($dt_wh) $month_expr $merchant_sql ";*/
				$RS_qrcode = $objDB->Conn->Execute(" select distinct a.* ,b.location_name ,b.address ,b.zip,b.created_by ,b.id location_id ,(select gender c from customer_user c where  c.id=a.user_id) gender from scan_qrcode a inner join locations b on a.location_id = b.id inner join campaigns c on a.campaign_id = c.id where a.is_location<>? and a.campaign_id in ( select campaign_id from campaign_location cl where cl.active<>? and cl.active_in_future<>? ) and ($dt_wh) $month_expr $merchant_sql ",array(1,1,1));

			}
			else
			{
											 
				  /*$sql = "select distinct a.* ,b.location_name ,b.address ,b.zip,b.created_by ,b.id location_id ,(select gender c from customer_user c where 
												  c.id=a.user_id) gender from scan_qrcode a inner join locations b on a.location_id = b.id    inner join campaigns c on a.campaign_id = c.id 
												  where a.is_location<>1 and a.campaign_id in ( select campaign_id from campaign_location cl where cl.active<>1 and cl.active_in_future<>1 
				  ) AND c.expiration_date <  CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(b.timezone,1, POSITION(',' IN b.timezone)-1)) ".$merchant_sql;*/
			$RS_qrcode = $objDB->Conn->Execute("select distinct a.* ,b.location_name ,b.address ,b.zip,b.created_by ,b.id location_id ,(select gender c from customer_user c where c.id=a.user_id) gender from scan_qrcode a inner join locations b on a.location_id = b.id    inner join campaigns c on a.campaign_id = c.id  where a.is_location<>? and a.campaign_id in ( select campaign_id from campaign_location cl where cl.active<>? and cl.active_in_future<>? ) AND c.expiration_date <  CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(b.timezone,1, POSITION(',' IN b.timezone)-1)) ".$merchant_sql,array(1,1,1));

			
			}
		}					
		//$RS_qrcode = $objDB->execute_query($sql);
		while($Row_qrcode = $RS_qrcode->FetchRow())
		{
			$l = $Row_qrcode['location_id'];
		}
		
	$json_array['location_id'] = $l;
	$json_array['total_locations'] = $RS_qrcode->RecordCount();
	$json = json_encode($json_array);
	echo $json;
	exit();
}
/******** 
@USE : check whether parent merchant is login or employee login and employee assigned location
@PARAMETER : current login merchant id
@RETURN : location list
@USED IN PAGES : reports.php
*********/
if(isset($_REQUEST['check_locations_locationreport']))
{
	$l ="";
$json_array = array();
$merchant_id = $_SESSION['merchant_id'];
$arr=file(WEB_PATH.'/merchant/process.php?getallsubmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);
if(trim($arr[0]) == "")
{
        unset($arr[0]);
        $arr = array_values($arr);
}
$json = json_decode($arr[0]);
$ids= $json->all_sub_merchant_id;
if($ids=="")
             $ids=$_SESSION['merchant_id'];
			 
			 
			 if($_SESSION['merchant_info']['merchant_parent'] == 0)
		 { 
         	$merchant_sql = " and (b.created_by = ".$merchant_id." or b.created_by in (".$ids.")) "; 
		 }
		 else
		 {
			 $merchant_array = array();
			$merchant_array['merchant_user_id'] = $_REQUEST['mer_id'];
			$merchant_info = $objDB->Show("merchant_user_role",$merchant_array);
	
			$Where1=" a.location_id=".$merchant_info->fields['location_access'];
			
			 $merchant_sql = "and  b.created_by = ".$merchant_id  ; 
		 }
//echo 123;
//echo 123;
if($_REQUEST['month'] != 0)
    {
        if($_REQUEST['month']==4 ||$_REQUEST['month']==6 ||$_REQUEST['month']==9 ||$_REQUEST['month']==11 )
        {
            $m=30;
        }
        else if($_REQUEST['month']==2)
        {
            $m=28;
        }
        else
        {
            $m =31;
        }
    }
	if($_REQUEST['year'] == 0 )
	{
		   $from_date = date('Y')."-01-01 00:00:00";
	    	$to_date =  date('Y')."-12-31 23:59:59";
	}
	else if($_REQUEST['year'] != 0 )
	{
			   $from_date = $_REQUEST['year']."-01-01 00:00:00";
     	     	$to_date =  $_REQUEST['year']."-12-31 23:59:59";
	}
        ?>
      
  <?php
   
             $month_expr = "  a.scaned_date between '".$from_date."' and '".$to_date."' ";
             $sql = " select distinct a.* ,b.location_name ,b.address ,b.zip,b.created_by  ,b.id location_id, (select gender c from customer_user c where  c.id=a.user_id) gender
               from scan_qrcode a inner join locations b on a.location_id = b.id where ".$month_expr . "  ".$merchant_sql;

							//$RS_qrcode = $objDB->execute_query($sql);
							$RS_qrcode = $objDB->Conn->Execute($sql);
							while($Row_qrcode = $RS_qrcode->FetchRow())
							{
								$l = $Row_qrcode['location_id'];
							}
		
$json_array['location_id'] = $l;
$json_array['total_locations'] = $RS_qrcode->RecordCount();
$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : delete media image 
@PARAMETER : media image id
@RETURN : status(error/success)
@USED IN PAGES : media-management.php
@EXPLAINATION : If media image use for create any campaign , location or template  then do not delete media image.
if delete image then remove physic from our system
*********/

if(isset($_REQUEST['mediaactiondelete']))
{
	// 09-01-2015 check delete permission when click on delete
	
	$flag_delete = "true";
	
	if($_SESSION['merchant_info']['merchant_parent'] != 0)
	{
		//echo "employee";
		$media_acc_array = array();
		$media_acc_array['merchant_user_id'] = $_SESSION['merchant_id'];
		$RSmedia = $objDB->Show("merchant_user_role",$media_acc_array);
		$media_val = unserialize($RSmedia->fields['media_access']);
		if(in_array("delete",$media_val))
		{
			//echo "in array if";
			$flag_delete = "true";
		}
		else{
			//echo "in array else";
			$flag_delete = "false";	
		}
	}
	else
	{
		//echo "main merchant";
		$flag_delete = "true";
	}
	
	// 09-01-2015 check delete permission when click on delete
	
	
	if($flag_delete=="false")
	{
		echo "delete_denied";
		return;
	}
	else 
	{
		if($_REQUEST['admin_image']==1)
		{
			$array_where = array();
			$array_where['merchant_id'] = $_SESSION['merchant_id'];
			$array_where['merchant_media_id'] = $_REQUEST['id'];
			$objDBWrt->Remove("media_import_image", $array_where);
			echo "success";
		}
		else
		{
			$folder ="";
			if($_REQUEST['image_type']=="1")
			{
				$folder = "campaign";
				$c_array = array();
				$c_array ['business_logo'] = $_REQUEST['src'];
				$merchant_info = $objDB->Show("campaigns",$c_array );
				$total = $merchant_info->RecordCount();
				
			}
			if($_REQUEST['image_type']=="2")
			{
				$folder = "location";
				$c_array = array();
				$c_array ['picture'] = $_REQUEST['src'];
				$merchant_info = $objDB->Show("locations",$c_array );
				$total = $merchant_info->RecordCount();
				
				$c_array = array();
				$c_array ['merchant_media_id'] = $_REQUEST['id'];
				$merchant_info = $objDB->Show("merchant_image_gallery_detail",$c_array );
				$total1 = $merchant_info->RecordCount();
				
				if($total==0 && $total1==0)
				{
					$total = 0;
				}
				else
				{
					$total = 1;
				}
			}
			if($_REQUEST['image_type']=="3")
			{
				$folder = "giftcard";
				$c_array = array();
				$c_array ['image'] = $_REQUEST['src'];
				$merchant_info = $objDB->Show("giftcards",$c_array );
				$total = $merchant_info->RecordCount();
			}
			//echo $total;
			//exit();
			if($total== 0) // means it is not linked so delete image
			{
				if($_REQUEST['image_type']=="1")
				{
					$array_where = array();
					$array_where['id'] = $_REQUEST['id'];
					$objDBWrt->Remove("merchant_media", $array_where);
					unlink(UPLOAD_IMG."/m/".$folder."/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/block/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/ldpi/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/mdpi/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/hdpi/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/xhdpi/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/xxhdpi/".$_REQUEST['src']);
				}
				
				if($_REQUEST['image_type'] == "2")
				{
					$array_where = array();
					$array_where['id'] = $_REQUEST['id'];
					$objDBWrt->Remove("merchant_media", $array_where);
					unlink(UPLOAD_IMG."/m/".$folder."/".$_REQUEST['src']);
					
					$thumb_image_folder=UPLOAD_IMG.'/m/location/mythumb/';
					unlink(UPLOAD_IMG."/m/".$folder."/mythumb/".$_REQUEST['src']); //unlink($thumb_image_folder.$_REQUEST['src']);
				}
				
				if($_REQUEST['image_type']=="3")
				{
					$array_where = array();
					$array_where['id'] = $_REQUEST['id'];
					$objDBWrt->Remove("merchant_media", $array_where);
					unlink(UPLOAD_IMG."/m/".$folder."/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/block/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/ldpi/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/mdpi/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/hdpi/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/xhdpi/".$_REQUEST['src']);
					unlink(UPLOAD_IMG."/m/".$folder."/xxhdpi/".$_REQUEST['src']);
				}
				// decrease image count when delete image
				
				$objJSON->decrease_image_count_for_merchant();
				
				// decrease image count when delete image
				
				//$_SESSION['msg']="Image is deleted successfully";
						echo "success";
						//echo "Image is deleted successfully";
				//header("Location: ".WEB_PATH."/merchant/media-management.php");
				//exit();
			}
			else
			{
				//$_SESSION['msg']="This image is used anywhere.";
					echo "error";
				//header("Location: ".WEB_PATH."/merchant/media-management.php");
			//exit();
			}
		}
	}
}

/******** 
@USE : delete media video 
@PARAMETER : video id
@RETURN : status(error/success)
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['videoactiondelete']))
{
	
	$RS = $objDB->Conn->Execute("select * from location_video_gallery_detail where merchant_videos_id=?",array($_REQUEST['id']));
    $count=$RS->RecordCount();
    if($count>0)
    {
		echo "failure";
	}
	else
	{
		$array_where = array();
		$array_where['merchant_id'] = $_SESSION['merchant_id'];
		$array_where['id'] = $_REQUEST['id'];
		$objDBWrt->Remove("merchant_videos", $array_where);
		
		$objJSON->decrease_video_count_for_merchant();
		 
		echo "success";
	}
						
}
/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST['getmoreimages']))
{
    /*$sql="select * from location_images where location_id=".$_REQUEST['location_id']." ORDER BY image_id";
    $RS_images = $objDB->execute_query($sql);*/
	$RS_images = $objDB->Conn->Execute("select * from location_images where location_id=? ORDER BY image_id",array($_REQUEST['location_id']));
    $count_images=$RS_images->RecordCount();
    
       
	$json_array['records'] =$RS_images;
        $json_array['query'] =$sql;
        $json_array['total_records'] = $count_images;       
	$json = json_encode($json_array);
	echo $json;
	return $json;	
}
/********* for campaign url ********************/
//create_camapign_url(759,80,

function create_camapign_url($campaign_id,$location_id,$title,$business,$category_id)
{
	/*$sql_user_category = "select * from categories where id=".$category_id;
	$RS_user_category =$this->Conn->Execute($sql_user_group);*/
	$RS_user_category =$this->Conn->Execute("select * from categories where id=?",array($category_id));
	while($Row_category = $RS_user_category->FetchRow())
	{ 
		$category_name = $Row_category['cat_name'];
	}
	$special_characters = array(" ","!","@","#","$","%","^","&","*","(",")","?","<",">","{","}","[","]",",",";",".");
	$url_string = WEB_PATH."/".$category_name."/";
	$str_cat = str_replace(" ","",$category_name);
	$str_cat = str_replace($special_characters,"-",$str);
	//$str_title = str_replace("!","-",$title);
		$url_string =$title;

	$url_string =  str_replace($special_characters,"-",$url_string);
	$url_string = str_replace("'","",$url_string);

	$str_arr = explode("-",$url_string);
	$count_lenght = 0;
	$connected_string  = "";
	for($i=0;$i<count($str_arr);$i++)
	{
		if( strlen($str_arr[$i]) == 0)
		{
			$count_lenght = $count_lenght+1;
			//echo  strlen($str_arr[$i])."-".$count_lenght;
		}
		else{

			$count_lenght = $count_lenght+ strlen($str_arr[$i]);
			//echo  strlen($str_arr[$i])."-".$count_lenght;
		}


		if($count_lenght <= 50 )
		{

			$connected_string = $connected_string.$str_arr[$i]."-";
			$count_lenght= $count_lenght+1;
			//echo "<br/><<<".$connected_string.">>>>>".strlen($connected_string)."==";
		} 
	}
	$url_string = $url_string.$connected_string.$campaign_id."-".$location_id;
 return $url_string;
	//$url_string = WEB_PATH."/"
} 
/****************** campaign url ****************/	

/******** 
@USE : get second category level
@PARAMETER : cat_first_id
@RETURN : json data
@USED IN PAGES : add-location.php,edit-location.php
*********/
if(isset($_REQUEST['get_second_category_level']))
{
    $json_array=$records=array();
    /*$Sql="select * from category_level where parent_id=".$_REQUEST['cat_first_id']." order by cat_name";
    $RS=$objDB->Conn->Execute($Sql);*/
	$RS=$objDB->Conn->Execute("select * from category_level where parent_id=? order by cat_name",array($_REQUEST['cat_first_id']));

    if($RS->RecordCount()>0)
    {
        $json_array['status']='true';
        $json_array['total_records']=$RS->RecordCount();
        $count=0;
		if($_REQUEST['lc']==1)
		{
			$html="<select name='first_cat_second_level' id='first_cat_second_level' size='9'>";
		}
		elseif($_REQUEST['lc']==2)
		{
			$html="<select name='second_cat_second_level' id='second_cat_second_level' size='9'>";
		}
		elseif($_REQUEST['lc']==3)
		{
			$html="<select name='third_cat_second_level' id='third_cat_second_level' size='9'>";
		}
        while($Row=$RS->FetchRow())
        {
			$Sql="select * from category_level where parent_id=".$Row['id']." order by cat_name";
			$RS1=$objDB->Conn->Execute($Sql);
			if($RS1->RecordCount()>0)
			{
				$html.="<option value='".$Row['id']."'>".$Row['cat_name']." ></option>";
			}
			else
			{
				$html.="<option value='".$Row['id']."'>".$Row['cat_name']."</option>";
			}
			$records[$count] = get_field_value($Row);
			
            $count++;
		}
		$html.="</select>";
		$json_array["records"]= $records;
		$json_array["html"]= $html;
    }
    else
    {
      $json_array['status'] = "false";
	  $json_array['total_records'] = 0;
      
      $json = json_encode($json_array);
      echo $json;
      exit();
    }
    
   $json = json_encode($json_array);
   echo $json;
   exit();
    
}

/******** 
@USE : get third category level
@PARAMETER : cat_second_id
@RETURN : json data
@USED IN PAGES : add-location.php,edit-location.php
*********/
if(isset($_REQUEST['get_third_category_level']))
{
    $json_array=$records=array();
    /*$Sql="select * from category_level where parent_id=".$_REQUEST['cat_second_id']." order by cat_name";
    $RS=$objDB->Conn->Execute($Sql);*/
	$RS=$objDB->Conn->Execute("select * from category_level where parent_id=? order by cat_name",array($_REQUEST['cat_second_id']));
    if($RS->RecordCount()>0)
    {
        $json_array['status']='true';
        $json_array['total_records']=$RS->RecordCount();
        $count=0;
		if($_REQUEST['lc']==1)
		{
			$html="<select name='first_cat_third_level' id='first_cat_third_level' size='9' style='margin-left:5px;'>";
		}
		elseif($_REQUEST['lc']==2)
		{
			$html="<select name='second_cat_third_level' id='second_cat_third_level' size='9' style='margin-left:5px;'>";
		}
		elseif($_REQUEST['lc']==3)
		{
			$html="<select name='third_cat_third_level' id='third_cat_third_level' size='9' style='margin-left:5px;'>";
		}
		
        while($Row=$RS->FetchRow())
        {
            $records[$count] = get_field_value($Row);
			$html.="<option value='".$Row['id']."'>".$Row['cat_name']."</option>";
            $count++;
		}
		$html.="</select>";
		$json_array["records"]= $records;
		$json_array["html"]= $html;
    }
    else
    {
      $json_array['status'] = "false";
      $json_array['total_records'] = 0;
      $json = json_encode($json_array);
      echo $json;
      exit();
    }
    
   $json = json_encode($json_array);
   echo $json;
   exit();
    
}

/******** 
@USE : get category name from id
@PARAMETER : id
@RETURN : json data
@USED IN PAGES : edit-location.php,edit-location-detail.php
*********/
if(isset($_REQUEST['getcatlevelnamefromid']))
{
    /*$sql="select * from category_level where id=".$_REQUEST['id'];
    $RS_cat = $objDB->execute_query($sql);*/
	$RS_cat = $objDB->Conn->Execute("select * from category_level where id=?",array($_REQUEST['id']));

	$json_array['status'] =true;
	$json_array['name'] = $RS_cat->fields['cat_name'];       
	$json = json_encode($json_array);
	echo $json;
	return $json;	
}

/******** 
@USE : notused
@PARAMETER : 
@RETURN : 
@USED IN PAGES : 
*********/
if(isset($_REQUEST["btnProcessMerchant"]))
{
	header("Location: ".WEB_PATH."/merchant/my-account.php");
}

/******** 
@USE : update password during merchant setup process
@PARAMETER : email,new_password,con_new_password
@RETURN : json data
@USED IN PAGES : merchant-setup.php
*********/
if(isset($_REQUEST['btnUpdatePasswordProcess']))
{
	if($_REQUEST['normal_register']==0)
	{
		$where_clause['email'] =  $_REQUEST['email'];
		$RS = $objDB->Show("merchant_user", $where_clause);
		if($RS->RecordCount()>0)
		{	 
			$json_array['status'] = "false";
			$json_array['message'] = $merchant_msg['login_register']['Msg_email_exist'];
			$json = json_encode($json_array);
			echo $json;
			exit();
			
		}
	}
	$array = $json_array =array();
	$merchant_id = $_REQUEST['merchant_id'];
	
	if($_REQUEST['new_password'] == ""){
		$json_array['message'] = $merchant_msg["changepassword"]["Msg_please_enter_new_password"];
		$json_array['status'] = "false";
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	if($_REQUEST['con_new_password'] == ""){
		$json_array['message'] = $merchant_msg["changepassword"]["Msg_please_enter_confirm_new_password"];
		$json_array['status'] = "false";
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	if($_REQUEST['new_password'] != $_REQUEST['con_new_password']){
		$json_array['message'] = $merchant_msg["changepassword"]["Msg_new_password_not_match"];
		$json_array['status'] = "false";
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	
	$PasswordLib = new \PasswordLib\PasswordLib;
	
	$array = $json_array = $where_clause = array();
	//echo $_REQUEST['normal_register'];
	if($_REQUEST['normal_register']==0)
	{
		$array['email'] = $_REQUEST['email'];
	}
	$array['password'] = $PasswordLib->createPasswordHash($_REQUEST['new_password']);
	$array['password_changed'] = 1;
	$where_clause['id'] = $merchant_id;
	$objDBWrt->Update($array, "merchant_user", $where_clause);
			
		
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : update profile during merchant setup process
@PARAMETER : merchant_id,firstname,lastname,address,city,zipcode,country,mobile_country_code,mobileno_area_code,mobileno2,mobileno,business,business_tags
@RETURN : json data
@USED IN PAGES : merchant-setup.php
*********/
if(isset($_REQUEST["btnUpdateProfileProcess"]))
{
	
	$array = $json_array =array();
	$merchant_id = $_REQUEST['merchant_id'];
	
	if(isset($_REQUEST['firstname']))
		$array['firstname'] = ucwords(strtolower($_REQUEST['firstname']));
	if(isset($_REQUEST['lastname']))
		$array['lastname'] = ucwords(strtolower($_REQUEST['lastname']));
	if(isset($_REQUEST['address']))
		$array['address'] = ucwords(strtolower($_REQUEST['address']));
    if(isset($_REQUEST['city']))
		$array['city'] = ucwords(strtolower($_REQUEST['city']));
	if(isset($_REQUEST['state']))
		$array['state'] = $_REQUEST['state'];
	if(isset($_REQUEST['zipcode']))
		$array['zipcode'] = strtoupper($_REQUEST['zipcode']);
	if(isset($_REQUEST['country']))
		$array['country'] = $_REQUEST['country'];
	
	$mobile_no=$_REQUEST['mobile_country_code']."-".$_REQUEST['mobileno_area_code']."-".$_REQUEST['mobileno2']."-".$_REQUEST['mobileno'];
	$array['phone_number']=$mobile_no;
		
	if(isset($_REQUEST['business']))
		$array['business'] = ucwords(strtolower($_REQUEST['business']));	
		
	if(isset($_REQUEST['business_tags']))
		$array['business_tags'] = $_REQUEST['business_tags'];
	
	$where_clause['id'] = $_SESSION["merchant_id"];
		
	$objDBWrt->Update($array, "merchant_user", $where_clause);
	
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : update about us during merchant setup process
@PARAMETER : merchant_id,aboutus,aboutus_short
@RETURN : json data
@USED IN PAGES : merchant-setup.php
*********/
if(isset($_REQUEST["btnUpdateAboutusProcess"]))
{
	$array = $json_array =array();
	$merchant_id = $_REQUEST['merchant_id'];
	/*
	echo "<br/>";
	echo rawUrlDecode($_REQUEST['aboutus']);
	echo "<br/>";
	echo urldecode($_REQUEST['aboutus']);
	echo "<br/>";
	echo htmlspecialchars_decode($_REQUEST['aboutus']);
	exit();
	*/
	if(isset($_REQUEST['aboutus']))
		$array['aboutus'] = $_REQUEST['aboutus'];

	if(isset($_REQUEST['aboutus_short']))
		$array['aboutus_short'] = $_REQUEST['aboutus_short'];		

	$where_clause['id'] = $_SESSION["merchant_id"];
		
	$objDBWrt->Update($array, "merchant_user", $where_clause);
	
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : update business logo during merchant setup process
@PARAMETER : merchant_id,hdn_image_path
@RETURN : json data
@USED IN PAGES : merchant-setup.php
*********/
if(isset($_REQUEST["btnUpdateBusinessLogoProcess"]))
{
	$array = $json_array =array();
	$merchant_id = $_REQUEST['merchant_id'];

	if($_REQUEST['hdn_image_path'] == "")
	{
		$array['merchant_icon'] = "";
	}
	else
	{		
		$array['merchant_icon'] = trim($_REQUEST['hdn_image_path']);
	}		

	$where_clause['id'] = $_SESSION["merchant_id"];
		
	$objDBWrt->Update($array, "merchant_user", $where_clause);
	
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : add location information during merchant setup process
@PARAMETER : mobileno_area_code_l,mobileno2_l,mobileno_l,hdn_image_path_l,email,address_l,city_l,state_l,zip_l,location_name,business,website,facebook,google,chk_is_primary,hdnlc1,pricerange,chk_parking,monhdn,tuehdn,wedhdn,thuhdn,frihdn,sathdn,sunhdn,hdnladdlocation
@RETURN : json data
@USED IN PAGES : merchant-setup.php
*********/
if(isset($_REQUEST["hdnProcessMerchant"]))
{
	//print_r($_REQUEST);
	//exit();
	
	
	// start add location
	
	$mobile_no=$_REQUEST['mobile_country_code_l']."-".$_REQUEST['mobileno_area_code_l']."-".$_REQUEST['mobileno2_l']."-".$_REQUEST['mobileno_l'];
	/*$Sql = "select * from locations where phone_number=".$mobile_no;
	$RS_loc = $objDB->Conn->Execute($Sql);*/
	$RS_loc = $objDB->Conn->Execute("select * from locations where phone_number=?",array($mobile_no));
    if($RS_loc->RecordCount()>0)
	{
		//echo "hello";
		//exit;
	}
	$array = $json_array = array();
	if($_REQUEST['hdn_image_path_l'] == "")
	{	
		$array['picture'] = "";
	}		
	else
	{		
		$array['picture'] = $_REQUEST['hdn_image_path_l'];	
	}
	$array['created_by'] = $_SESSION['merchant_id'];
	$array['email'] = $_REQUEST['email'];
	$string_address = $_REQUEST['address_l'].", ".$_REQUEST['city_l'].", ".$_REQUEST['state_l'].", ".$_REQUEST['zip_l'];
	$string_address = urlencode($string_address);
	$geocode= file_get_contents("https://maps.googleapis.com/maps/api/geocode/json?address=".$string_address."&sensor=false");
	$geojson= json_decode($geocode,true);
	if($geojson['status']=='OK'){
		$array['latitude'] = $geojson['results'][0]['geometry']['location']['lat'];
		$array['longitude'] = $geojson['results'][0]['geometry']['location']['lng'];
		/****** get location timezone information from lattitude and longitude *********/
		 $geocode= file_get_contents("http://api.timezonedb.com/?lat=".$array['latitude']."&lng=".$array['longitude']."&key=V5R3I13VWW28&format=json");
		$geojson_timezone= json_decode($geocode,true);	
		if($geojson_timezone['dst'] == 1)
		{
			$timezone_name = $geojson_timezone['zoneName'];
			$zonehouroffset = timezone_offsethour_string($geojson_timezone['gmtOffset']).",0";
			//echo $Row['id']."===old timezone-".$Row['timezone_name']."-".$Row['timezone']."===".$Row['latitude']."===".$Row['longitude']."==".timezone_offsethour_string($geojson['gmtOffset'])."=new time zone".$geojson['zoneName']."<br/>";
		}
		else
		{
			$timezone_name = $geojson_timezone['zoneName'];
			$zonehouroffset = getStandardOffsetUTC($geojson_timezone['zoneName'],$geojson_timezone['gmtOffset']).",0";
			//echo $Row['id']."===old timezone-".$Row['timezone_name']."-".$Row['timezone']."===".$Row['latitude']."===".$Row['longitude']."==".getStandardOffsetUTC($geojson['zoneName'],$geojson['gmtOffset'])."=new time zone".$geojson['zoneName']."<br/>";
		}
		$array['is_dst'] = $geojson_timezone['dst'];
		 $array['timezone'] = $zonehouroffset;
          $array['timezone_name'] = $timezone_name;
		/****** get location timezone information from lattitude and longitude *********/	
	}
    if($_REQUEST['location_name'] == "")
	{
		$b = ucwords(strtolower($_REQUEST['business']));
		$array['location_name'] = ucwords(strtolower($_REQUEST['business']));
	}
	else
	{
		$b = $_REQUEST['location_name'];
		$array['location_name'] = ucwords(strtolower($_REQUEST['location_name']));
	}
	$array['address'] = ucwords(strtolower($_REQUEST['address_l']));
	$array['country'] = $_REQUEST['country_l'];
	$array['state'] = $_REQUEST['state_l'];
	$array['city'] = ucwords(strtolower($_REQUEST['city_l']));
	$array['zip'] = strtoupper($_REQUEST['zip_l']);
	
	if($_REQUEST['website']!="")
	{		
		$website_array=array();
		$website_array = explode("/",$_REQUEST['website']);
		
		if($website_array[0] == "http:" || $website_array[0] == "https:")
		{
			
			$array['website'] = $_REQUEST['website'];
		}
		else
		{
		   $array['website'] = "http://".$_REQUEST['website'];
		}
	}
	else
	{
		$array['website'] = $_REQUEST['website'];
	}
	if($_REQUEST['facebook']!="")
	{
		$facebook_array=array();        
		 $facebook_array = explode("/",$_REQUEST['facebook']);
		if($facebook_array[0] == "http:" || $facebook_array[0] == "https:")
		{
			$array['facebook'] = $_REQUEST['facebook'];
			
		}
		else
		{
		  $array['facebook'] = "http://".$_REQUEST['facebook'];
		}
	}
	else
	{
		$array['facebook'] = $_REQUEST['facebook'];
	}
	if($_REQUEST['google']!="")
	{
		$google_array=array();
		$google_array = explode("/",$_REQUEST['google']);
		if($google_array[0] == "http:" || $google_array[0] == "https:")
		{
			$array['google'] = $_REQUEST['google'];
			
		}
		else
		{
		  $array['google'] = "http://".$_REQUEST['google'];
		}
	}
	else
	{
		$array['google'] = $_REQUEST['google'];
	}
	/*
	$array['location_publish']=$_REQUEST['facebookradio'];
    $array['location_publish_google']=$_REQUEST['googleradio'];
	*/
	$array['phone_number']=$mobile_no;
	$array['is_primary']=$_REQUEST['chk_is_primary'];	
	$array['created_date'] = date("Y-m-d H:i:s");
    $array['modified_date'] = date("Y-m-d H:i:s");
	$array['active'] = 1;
	/*$offset_n = timezone_offset_get(new DateTimeZone(  $_REQUEST['timezone']), new DateTime() );
	$offset_n=timezone_offset_string( $offset_n );
	$array['timezone'] = $offset_n.",0";
	$array['timezone_name'] = $_REQUEST['timezone'];*/
	
	/* start location category Task*/
	$location_categories=array();
	if($_POST['hdnlc1'])
	{
		array_push($location_categories,$_POST['hdnlc1']);
	}
	if($_POST['hdnlc2'])
	{
		array_push($location_categories,$_POST['hdnlc2']);
	}
	if($_POST['hdnlc3'])
	{
		array_push($location_categories,$_POST['hdnlc3']);
	}	
	$array['categories']=implode(",",$location_categories);
	/* end location category Task*/
	
	if(isset($_POST['pricerange']))
	{
		$pricerange=$_POST['pricerange'];
		$array['pricerange'] =$pricerange;
	}
	if(isset($_POST['chk_parking']))
	{
		$parking="";
		foreach($_POST['chk_parking'] as $parking1)
		{
			$parking.=$parking1.",";
		}
		$parking=substr($parking, 0, -1);
		$array['parking'] = $parking;
	}
	
	$id = $objDBWrt->Insert($array, "locations");
	
	$array_new = $where_clause1 = array();
	$permalink_url = $objJSON->create_location_url($id,$b,$_REQUEST['city_l']);
	$array_new['location_permalink'] = $permalink_url;	
	$where_clause1['id'] = $id;
	$objDBWrt->Update($array_new , "locations", $where_clause1);
	/*
	$group_array = array();
	$group_array['group_name'] = "private";
	$group_array['location_id'] = $id;
	$group_array['merchant_id'] = $_SESSION['merchant_id'];
	$group_array['active']= 1;
	$group_array['private'] = 1;
	$objDBWrt->Insert($group_array, "merchant_groups");	
	*/
	/* Image Upload Task*/
	$array_images_more = $where_clause_images  = array();
    $hdn_images=$_REQUEST['hdn_more_images'];
        
	if(count($hdn_images) > 0)
	{    
		for($i=0;$i<count($hdn_images);$i++)
		 {
			$array_images_more['location_id']=$id;
			$array_images_more['main_image']=$hdn_images[$i];
			$array_images_more['image_id']=$i;
			$objDBWrt->Insert($array_images_more, "location_images");

			copy(UPLOAD_IMG.'/m/location/temp_main/'.$hdn_images[$i],UPLOAD_IMG.'/m/location/'.$hdn_images[$i]);
			copy(UPLOAD_IMG.'/m/location/temp_thumb/'.$hdn_images[$i],UPLOAD_IMG.'/m/location/thumb/'.$hdn_images[$i] );

			unlink(UPLOAD_IMG."/m/location/temp_main/".$hdn_images[$i]);
			unlink(UPLOAD_IMG."/m/location/temp_thumb/".$hdn_images[$i]);
		 }
	}
	/* End Image Upload Task*/
	
	/* Add Hours Code */
	$array_hours = $where_clause_hours  = array();
	if($_REQUEST['monhdn']!="")
	{
		$array_monhdn=explode("-",$_REQUEST['monhdn']);
		
		$day= $array_monhdn[0];
		$starttime=$array_monhdn[1];
		$endtime=$array_monhdn[2];
		
		$array_hours['location_id']=$id;
		$array_hours['day']=$day;
		$array_hours['start_time']=strtoupper($starttime);
		$array_hours['end_time']=strtoupper($endtime);
		//echo $day.$starttime.$endtime;
		//$where_clause_hours['location_id'] = $_REQUEST['id'];
		//$where_clause_hours['day'] = $day;
		
		$objDBWrt->Insert($array_hours, "location_hours");
		
	}
	
	if($_REQUEST['tuehdn']!="")
	{
		$array_monhdn=explode("-",$_REQUEST['tuehdn']);
		
		$day= $array_monhdn[0];
		$starttime=$array_monhdn[1];
		$endtime=$array_monhdn[2];
		
		$array_hours['location_id']=$id;
		$array_hours['day']=$day;
		$array_hours['start_time']=strtoupper($starttime);
		$array_hours['end_time']=strtoupper($endtime);
		//echo $day.$starttime.$endtime;
		//$where_clause_hours['location_id'] = $_REQUEST['id'];
		//$where_clause_hours['day'] = $day;
		
		$objDBWrt->Insert($array_hours, "location_hours");
		
	}
	
	if($_REQUEST['wedhdn']!="")
	{
		$array_monhdn=explode("-",$_REQUEST['wedhdn']);
		$location_id=$_REQUEST['id'];
		$day= $array_monhdn[0];
		$starttime=$array_monhdn[1];
		$endtime=$array_monhdn[2];
		
		$array_hours['location_id']=$id;
		$array_hours['day']=$day;
		$array_hours['start_time']=strtoupper($starttime);
		$array_hours['end_time']=strtoupper($endtime);
		//echo $day.$starttime.$endtime;
		//$where_clause_hours['location_id'] = $_REQUEST['id'];
		//$where_clause_hours['day'] = $day;
		
		 $objDBWrt->Insert($array_hours, "location_hours");
		
	}
	
	if($_REQUEST['thuhdn']!="")
	{
		$array_monhdn=explode("-",$_REQUEST['thuhdn']);
		$location_id=$_REQUEST['id'];
		$day= $array_monhdn[0];
		$starttime=$array_monhdn[1];
		$endtime=$array_monhdn[2];
		
		$array_hours['location_id']=$id;
		$array_hours['day']=$day;
		$array_hours['start_time']=strtoupper($starttime);
		$array_hours['end_time']=strtoupper($endtime);
		//echo $day.$starttime.$endtime;
		//$where_clause_hours['location_id'] = $_REQUEST['id'];
		//$where_clause_hours['day'] = $day;
		
		$objDBWrt->Insert($array_hours, "location_hours");
		
	}
	
	 if($_REQUEST['frihdn']!="")
	{
		$array_monhdn=explode("-",$_REQUEST['frihdn']);
		
		$day= $array_monhdn[0];
		$starttime=$array_monhdn[1];
		$endtime=$array_monhdn[2];
		
		$array_hours['location_id']=$id;
		$array_hours['day']=$day;
		$array_hours['start_time']=strtoupper($starttime);
		$array_hours['end_time']=strtoupper($endtime);
		//echo $day.$starttime.$endtime;
		//$where_clause_hours['location_id'] = $_REQUEST['id'];
		//$where_clause_hours['day'] = $day;
		
		$objDBWrt->Insert($array_hours, "location_hours");
		
	}
	
	 if($_REQUEST['sathdn']!="")
	{
		$array_monhdn=explode("-",$_REQUEST['sathdn']);
		
		$day= $array_monhdn[0];
		$starttime=$array_monhdn[1];
		$endtime=$array_monhdn[2];
		
		$array_hours['location_id']=$id;
		$array_hours['day']=$day;
		$array_hours['start_time']=strtoupper($starttime);
		$array_hours['end_time']=strtoupper($endtime);
		//echo $day.$starttime.$endtime;
		//$where_clause_hours['location_id'] = $_REQUEST['id'];
		//$where_clause_hours['day'] = $day;
		
		$objDBWrt->Insert($array_hours, "location_hours");
		
	}
	
	if($_REQUEST['sunhdn']!="")
	{
		$array_monhdn=explode("-",$_REQUEST['sunhdn']);
		
		$day= $array_monhdn[0];
		$starttime=$array_monhdn[1];
		$endtime=$array_monhdn[2];
		
		$array_hours['location_id']=$id;
		$array_hours['day']=$day;
		$array_hours['start_time']=strtoupper($starttime);
		$array_hours['end_time']=strtoupper($endtime);
		//echo $day.$starttime.$endtime;
		//$where_clause_hours['location_id'] = $_REQUEST['id'];
		//$where_clause_hours['day'] = $day;
		
		$objDBWrt->Insert($array_hours, "location_hours");
		
	}
	/* End of Add Hours Code */
		
	// end start location
	
	// start update profile complete 
	
	$array = $json_array =array();
	$array['profile_complete'] = "1";
	$where_clause['id'] = $_SESSION["merchant_id"];
	$objDBWrt->Update($array, "merchant_user", $where_clause);
	
	// end update profile complete 
	
	$array123=array();
	$array123['id'] = $_SESSION["merchant_id"];
	
	$RS123 = $objDB->Show("merchant_user",$array123);
	
	$mail = new PHPMailer();
	$body='<body bgcolor="#e4e4e4" topmargin="0" leftmargin="0" marginheight="0" marginwidth="0" style="-webkit-font-smoothing: antialiased;width:100% !important;background:#e4e4e4;-webkit-text-size-adjust:none;">
	
<table width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="#e4e4e4">
    <tr>
        <td bgcolor="#e4e4e4" width="100%">
            <table width="600" cellpadding="0" cellspacing="0" border="0" align="center" class="table"
                style="background: #D2D2D2; border: 2px solid #ddd; padding: 20px; border-radius: 10px;">
                <tr>
                    <td width="600" class="cell">
                        <table width="600" cellpadding="0" cellspacing="0" border="0" class="table">
                            <tr>
                                <td width="250" class="logocell">
									<img src="'.ASSETS_IMG.'/m/logo-merchant.png" width="250" height="30" alt="Scanflip Merchant"
                                        style="-ms-interpolation-mode: bicubic; padding: 20px 0;">
                                </td>
                            </tr>
                        </table>
                        <repeater>
			<layout label="New feature">
			<table width="100%" cellpadding="0" cellspacing="0" border="0">
			<tr>
				<td bgcolor="#F37E0A" nowrap><img border="0" src="'.ASSETS_IMG.'/m/spacer.gif" width="5" height="1"></td>
				<td width="100%" bgcolor="#ffffff">
			
					<table width="100%" cellpadding="20" cellspacing="0" border="0">
					<tr>
						<td bgcolor="white" class="contentblock">
							<h4 style="color:black; font-size:16px; line-height:24px; font-family:Helvetica Neue,Helvetica,Arial,sans-serif; margin-top:0; margin-bottom:10px; padding-top:0; padding-bottom:0; font-weight:normal;"><strong><singleline label="Title">Hi '.$RS123->fields['firstname'].',</singleline></strong></h4>
							<multiline label="Description"><p style=" color: black; font-family:Helvetica Neue,Helvetica,Arial,sans-serif; font-size: 13px; font-weight: normal; line-height: 19px; margin-bottom: 12px; margin-top: 0; padding-bottom: 0; padding-top: 0;">Welcome to Scanflip! Please click the button below to verify your email address.</p></multiline>
                            <h5 style="margin-bottom:0px;"><a href="'.WEB_PATH.'/merchant/process.php?btnverifyemail=yes&email='.$RS123->fields['email'].'" style=" background: none repeat scroll 0 0 #F37E0A; font-family: Helvetica Neue,Helvetica,Arial,sans-serif; border-radius: 3px; color: #FFFFFF; font-size: 14px; padding: 5px 15px; text-align: center; text-decoration: none;">Verify</a></h5>                                
                    		<h5><p style=" color: black; font-family:Helvetica Neue,Helvetica,Arial,sans-serif; font-size: 13px; font-weight: normal; line-height: 19px; margin-bottom: 12px; margin-top: 0; padding-bottom: 0; padding-top: 0;">Thank You,<br/>Scanflip Support Team.</p></h5>
						</td>
					</tr>
					</table>
				</td>
			</tr>
			</table>  
			</layout>
		</repeater>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>

</body>';							
	/*
	$body.= "Hi ".$RS123->fields['firstname'].",";
	$body.="<p>Welcome to Scanflip! Please click the button below to verify your email address.</p>";
	$body.="<p><a href='".WEB_PATH."/merchant/process.php?btnverifyemail=yes&email=".$RS123->fields['email']."'>Verify</a></p>";
	$body .= "<p>Thank You,<br/>Scanflip Support Team.</p>";
	*/
	$mail->AddReplyTo('no-reply@scanflip.com','ScanFlip Support');
	$mail->AddAddress($RS123->fields['email']);
	$mail->From = "no-reply@scanflip.com";
	$mail->FromName = "ScanFlip Support";
	$mail->Subject    = $RS123->fields['firstname'].",Verify your email to finish setting up your merchant account.";
	$mail->MsgHTML($body);
				   //echo $body;
	$mail->Send();
	
	if($_REQUEST['hdnladdlocation']=='yes')
	{
		header("Location: ".WEB_PATH."/merchant/merchant-setup.php?tab=business_page");
	}	
	else
	{
		if($RS123->fields['approve']==1)
		{
			header("Location: ".WEB_PATH."/merchant/my-account.php");
		}
		else
		{
			$_SESSION = array();
			header("Location: ".WEB_PATH."/merchant/index.php");
		}
		
	}
	
	
				
}

/******** 
@USE : upload image from facebook during merchant setup
@PARAMETER : import_url
@RETURN : json data
@USED IN PAGES : grabimagescript.js
*********/
if(isset($_REQUEST['upload_import_image']))
{
	$image_path_main=UPLOAD_IMG."/m/icon/";
	$name ="icon_".strtotime(date("Y-m-d H:i:s")).".png";
	
	$street_main_image = file_get_contents($_REQUEST['import_url']); 
	$fp  = fopen($image_path_main.$name, 'w+');
	fputs($fp, $street_main_image);
	
	$image_path_main=UPLOAD_IMG."/m/icon/";
	
	$size = getimagesize($image_path_main.$name);
	$width=$size[0];
	$height=$size[1];
	
	$aspect_ratio=$width/$height;
	$height=144/$aspect_ratio;
	
	$image_path_main=UPLOAD_IMG."/m/icon/";
	//echo $image_path_main.$name;	
	$image = new SimpleImage();
	$image->load($image_path_main.$name);
	$image->resize(144,$height);
	$image->save($image_path_main.$name);
	
	$json_array=array();
	$json_array['status'] = "true";
	$json_array['filename'] = $name;
	$json_array['height'] = $height;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : upload location image from facebook during merchant setup
@PARAMETER : import_url
@RETURN : json data
@USED IN PAGES : merchant-setup.php
*********/
if(isset($_REQUEST['upload_facebook_location_image']))
{
	
	$image_path_main=UPLOAD_IMG."/m/location/temp_main/";
	
	$image_path_thumb=UPLOAD_IMG."/m/location/temp_thumb/";
	
	$name ="location_".strtotime(date("Y-m-d H:i:s")).".jpg";
	
	$appen_url="";
	
	if(isset($_REQUEST['oe']))
	{
		$appen_url.="&oe=".$_REQUEST['oe'];
	}
	
	if(isset($_REQUEST['__gda__']))
	{
		$appen_url.="&__gda__=".$_REQUEST['__gda__'];
	}
	
	$street_main_image = file_get_contents($_REQUEST['import_url'].$appen_url); 
	
	//print_r($street_main_image);
	//exit();
	$fp  = fopen($image_path_main.$name, 'w+');
	fputs($fp, $street_main_image);
	
	$street_main_image = file_get_contents($_REQUEST['import_url'].$appen_url); 
	$fp  = fopen($image_path_thumb.$name, 'w+');
	fputs($fp, $street_main_image);
	
	$image_path_main=UPLOAD_IMG."/m/location/temp_main/";
	
	$image_path_thumb=UPLOAD_IMG."/m/location/temp_thumb/";
	
	$size = getimagesize($image_path_main.$name);
	$width=$size[0];
	$height=$size[1];
	
	$min_width=200;
	$min_height=200;
	$max_width=400;
	$max_height=310;
	
	$image_path_main=UPLOAD_IMG."/m/location/temp_main/";
	$image_path_thumb=UPLOAD_IMG."/m/location/temp_thumb/";
	//echo "width=".$width." and height=".$height;
	//exit();
	if($width>=400 && $height>=310)
	{
		/*
		//echo $image_path_main.$name;	
		$image = new SimpleImage();
		$image->load($image_path_main.$name);
		$image->resize(400,310);
		$image->save($image_path_main.$name);
		
		$image = new SimpleImage();
		$image->load($image_path_thumb.$name);
		$image->resize(70,70);
		$image->save($image_path_thumb.$name);
		*/
		if($width>$height)
		{
			$aspect_ratio=$width/$height;
			$height=$max_width/$aspect_ratio;
					
			$image = new SimpleImage();
			$image->load($image_path_main.$name);
			$image->resize($max_width,$height);
			$image->save($image_path_main.$name);
		}
		else
		{
			$aspect_ratio=$width/$height;
			$width=$aspect_ratio*$max_height;
					
			$image = new SimpleImage();
			$image->load($image_path_main.$name);
			$image->resize($width,$max_height);
			$image->save($image_path_main.$name);
		}
		
		$image_folder=UPLOAD_IMG.'/m/location/temp_main/';
		$upload_filename = $image_folder . $name;
									
		passthru("/usr/bin/convert -define jpeg:size=400x200 ".$upload_filename." -thumbnail 10000@ \
          -gravity center -background white -extent 70x70 ".$image_path_thumb.$name);
		
	}
	else if($width >= 400)
	{
		/*
		if($height > $min_height)
		{
		   if($height<$max_height) 
		   {
			   
		   }
		   else
		   {
			   $height=310;
		   }
		   
		   $image = new SimpleImage();
			$image->load($image_path_main.$name);
			$image->resize(400,$height);
			$image->save($image_path_main.$name);
			
			$image = new SimpleImage();
		$image->load($image_path_thumb.$name);
		$image->resize(70,70);
		$image->save($image_path_thumb.$name);
		
		}
		else
		{
			//$_SESSION['msg']="image height must be at-least 200px";
			//echo "<div id='message'>image height must be at-least 200px</div>";
		}

		*/

		if($height<$max_height) 
	   {
		   $aspect_ratio=$width/$height;
			$height=$max_width/$aspect_ratio;

			$image = new SimpleImage();
			$image->load($image_path_main.$name);
			$image->resize(400,$height);
			$image->save($image_path_main.$name);
	   }
	   else
	   {
		   $height=310;
		   
			$image = new SimpleImage();
		   $image->load($image_path_main.$name);
		   $image->resize(400,$height);
		   $image->save($image_path_main.$name);
	   }
								   
		$image_folder=UPLOAD_IMG.'/m/location/temp_main/';
		$upload_filename = $image_folder . $name;
									
		passthru("/usr/bin/convert -define jpeg:size=400x200 ".$upload_filename." -thumbnail 10000@ \
          -gravity center -background white -extent 70x70 ".$image_path_thumb.$name);	
	}
	else if($height >= 310)
	{
		/*
		if($width > $min_width)
		{
			if($width < $max_width)
			{
				
			}
			else
			{
				 $width=400;
			}
			//$width=400;
			
			$image = new SimpleImage();
			$image->load($image_path_main.$name);
			$image->resize($width,310);
			$image->save($image_path_main.$name);
			
			$image = new SimpleImage();
		$image->load($image_path_thumb.$name);
		$image->resize(70,70);
		$image->save($image_path_thumb.$name);
			
		}
		else
		{
			//$_SESSION['msg']="image width must be at-least 200px";
			//echo "<div id='message'>image width must be at-least 200px</div>";
		}
		*/	
		if($width < $max_width)
		{
			$aspect_ratio=$width/$height;
			$width=$aspect_ratio*$max_height;

			$image = new SimpleImage();
			$image->load($image_path_main.$name);
			$image->resize($width,310);
			$image->save($image_path_main.$name);
		}
		else
		{
			 $width=400;
			 
			$image = new SimpleImage();
			$image->load($image_path_main.$name);
			$image->resize($width,310);
			$image->save($image_path_main.$name);
		}
		
		$image_folder=UPLOAD_IMG.'/m/location/temp_main/';
		$upload_filename = $image_folder . $name;		
		
		passthru("/usr/bin/convert -define jpeg:size=400x200 ".$upload_filename." -thumbnail 10000@ \
          -gravity center -background white -extent 70x70 ".$image_path_thumb.$name);	
	} 
	else
	{
		$json_array=array();
		$json_array['status'] = "false";
		$json_array['message'] = "image size must be at-least ( W X H) 400px x 200px";
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	
	$json_array=array();
	$json_array['status'] = "true";
	$json_array['filename'] = $name;
	$json = json_encode($json_array);
	echo $json;
	exit();
}


/******** 
@USE : to delete image
@PARAMETER : image_type,filename
@RETURN : json data
@USED IN PAGES : add-compaign.php,edit-compaign.php,copy-compaign.php,add-location.php,edit-location.php,add-template.php,edit-template.php,customize-template.php,merchant-setup.php
*********/
if(isset($_REQUEST['is_image_delete']))
{
	
	if($_REQUEST['image_type'] == "location")
	{	
	    //Main Image Delete
		$main_image_folder=UPLOAD_IMG.'/m/location/';
		unlink($main_image_folder.$_REQUEST['filename']);
		//Thumb Image Delete
		$thumb_image_folder=UPLOAD_IMG.'/m/location/mythumb/';
		unlink($thumb_image_folder.$_REQUEST['filename']);
		
		
	}
	else if($_REQUEST['image_type'] == "campaign")
	{
		$main_image_folder=UPLOAD_IMG.'/m/campaign/';
		unlink($main_image_folder.$_REQUEST['filename']);
		//search deal block image
		$block_image_folder=UPLOAD_IMG.'/m/campaign/block/';
		unlink($block_image_folder.$_REQUEST['filename']);
		// ldpi landscape
		$ldpi_image_folder=UPLOAD_IMG.'/m/campaign/ldpi/';
		unlink($ldpi_image_folder.$_REQUEST['filename']);
		// mdpi landscape
		$mdpi_image_folder=UPLOAD_IMG.'/m/campaign/mdpi/';
		unlink($mdpi_image_folder.$_REQUEST['filename']);
		// hdpi landscape
		$hdpi_image_folder=UPLOAD_IMG.'/m/campaign/hdpi/';
		unlink($hdpi_image_folder.$_REQUEST['filename']);
		// xhdpi landscape
		$xhdpi_image_folder=UPLOAD_IMG.'/m/campaign/xhdpi/';
		unlink($xhdpi_image_folder.$_REQUEST['filename']);
		// xxhdpi landscape
		$xxhdpi_image_folder=UPLOAD_IMG.'/m/campaign/xxhdpi/';
		unlink($xxhdpi_image_folder.$_REQUEST['filename']);
	}
	// decrease image count when delete image
		
	$objJSON->decrease_image_count_for_merchant();
	
	// decrease image count when delete image
	exit();	
}

/******** 
@USE : to make thumb image when assign from library
@PARAMETER : image_type,filename
@RETURN : json data
@USED IN PAGES : add-location.php,edit-location.php
*********/
if(isset($_REQUEST['make_thumb_image_when_assign']))
{
	$name = $_REQUEST['filename'];
	
	if($_REQUEST['image_type'] == "location")
	{	
		$sourefile_for_jpg = UPLOAD_IMG.'/m/location/'.$name;
		$image_folder=UPLOAD_IMG.'/m/location/mythumb/';
		
		list($width, $height, $type, $attr) = getimagesize(UPLOAD_IMG.'/m/location/'.$name);
		$min_width=200;
		$min_height=200;
		$max_width=400;
		$max_height=310;
						
		$upload_filename = $image_folder . $name;
		
		$aspect_ratio=$width/$height;
		
		if($width>=400 && $height>=310)
		{
			if($width>=$height)
			{
				if($aspect_ratio>=1.75)
				{
					passthru("/usr/bin/convert -define jpeg:size=400x310 ".$sourefile_for_jpg." -thumbnail 20000@ \          -gravity center -background white -extent 200x200  ".$upload_filename);	
				}
				else
				{
					passthru("/usr/bin/convert ".$sourefile_for_jpg." -resize 200x200! -filter Lanczos ".$upload_filename);	
				}
			}
			else
			{
				if($aspect_ratio<0.5)
				{
					passthru("/usr/bin/convert -define jpeg:size=400x310 ".$sourefile_for_jpg." -thumbnail 20000@ \          -gravity center -background white -extent 200x200  ".$upload_filename);	
				}
				else
				{
					passthru("/usr/bin/convert ".$sourefile_for_jpg." -resize 200x200! -filter Lanczos ".$upload_filename);	
				}
			}
		}
		else if($width > 400)
		{
			passthru("/usr/bin/convert ".$sourefile_for_jpg." -resize 200x200! -filter Lanczos ".$upload_filename);	
		}
		else if($height > 310)
		{
			passthru("/usr/bin/convert ".$sourefile_for_jpg." -resize 200x200! -filter Lanczos ".$upload_filename);	
		}
	}
	$json_array=array();
	$json_array['status'] = "true";
	$json_array['filename'] = $name;
	$json = json_encode($json_array);
	echo $json;
	exit();
}
function sendNotification( $apiKey, $registrationIdsArray, $messageData )
{
	$apiKey = GCM_API_KEY; 
	$headers = array("Content-Type:" . "application/json", "Authorization:" . "key=" . $apiKey);
	$data = array(
	'data' => $messageData,
	'registration_ids' => $registrationIdsArray
	);
	 
	$ch = curl_init();
	 
	curl_setopt( $ch, CURLOPT_HTTPHEADER, $headers );
	curl_setopt( $ch, CURLOPT_URL, "https://android.googleapis.com/gcm/send" );
	curl_setopt( $ch, CURLOPT_SSL_VERIFYHOST, 0 );
	curl_setopt( $ch, CURLOPT_SSL_VERIFYPEER, 0 );
	curl_setopt( $ch, CURLOPT_RETURNTRANSFER, true );
	curl_setopt( $ch, CURLOPT_POSTFIELDS, json_encode($data) );
	 
	$response = curl_exec($ch);
	curl_close($ch);
	 
	return $response;
}
/*
$message = "the test message";
$tickerText = "ticker text message";
$contentTitle = "content title";
$contentText = "content body";
 
$registrationId = 'DEVICE_ID';
$apiKey = "YOUR_BROWSER_API_KEY";
 
$response = sendNotification(
			$apiKey,
			array($registrationId),
			array('message' => $message, 'tickerText' => $tickerText, 'contentTitle' => $contentTitle, "contentText" => $contentText)
			);
 
echo $response;
*/

if(isset($_REQUEST['send_gcm_message']))
{
	$json_array = array();

	/*
	$message = "the test message";
	$tickerText = "ticker text message";
	$contentTitle = "content title";
	$contentText = "content body";
	*/

	$message = "";	
	/*
	$tickerText = $_REQUEST['ticker_text'];
	$contentTitle = $_REQUEST['content_title'];
	$contentText = $_REQUEST['content_text'];
	*/
	$redeem_point = $_REQUEST['redeem_point'];
	$business_name = urldecode($_REQUEST['business_name']);
	$notificationtype = $_REQUEST['notificationtype'];
	$customer_id = $_REQUEST['customer_id'];
	
	$tickerText = "You earned ".$redeem_point." Scanflip points for your recent visit at ".$business_name.". Rate your visit.";
	$contentTitle = $merchant_msg['redeem-deal']['Msg_gcm_title'];
	$contentText = "You earned ".$redeem_point." Scanflip points for your recent visit at ".$business_name.". Rate your visit.";
														
	$registrationId = $_REQUEST['device_id'];
	$apiKey = GCM_API_KEY;
	 
	$response = sendNotification(
				$apiKey,
				array($registrationId),
				array('message' => $message, 'tickerText' => $tickerText, 'contentTitle' => $contentTitle, "contentText" => $contentText,"notificationType" => $notificationtype,"customer_id" => $customer_id)
				);
	 
	//echo $response;
	
    $json_array['status'] = "true";
	$json_array['message'] = $response;
    $json = json_encode($json_array);
	echo $json;
	exit();
}


function sendPushNotification( $devideId, $messageData )
{
	// Put your device token here (without spaces):
	$deviceToken = $devideId;

	// Put your private key's passphrase here:
	$passphrase = 'scanflip';

	// Put your alert message here:
	$message = $messageData;
	
	$ctx = stream_context_create();
	stream_context_set_option($ctx, 'ssl', 'local_cert', 'Scanflipck.pem');
	stream_context_set_option($ctx, 'ssl', 'passphrase', $passphrase);

	// Open a connection to the APNS server
	$fp = stream_socket_client(
		'ssl://gateway.sandbox.push.apple.com:2195', $err,
		$errstr, 60, STREAM_CLIENT_CONNECT|STREAM_CLIENT_PERSISTENT, $ctx);

	if (!$fp)
		exit("Failed to connect: $err $errstr" . PHP_EOL);
	
	// Create the payload body
	$body['aps'] = array(
		'alert' => $message,
		'sound' => 'default'
		);

	// Encode the payload as JSON
	$payload = json_encode($body);

	// Build the binary notification
	$msg = chr(0) . pack('n', 32) . pack('H*', $deviceToken) . pack('n', strlen($payload)) . $payload;

	// Send it to the server
	$result = fwrite($fp, $msg, strlen($msg));

	if (!$result)
		echo 'Message not delivered' . PHP_EOL;
	else
		echo 'Message successfully delivered' . PHP_EOL;

	// Close the connection to the server
	fclose($fp);
	
	return $result;
}

if(isset($_REQUEST['send_push_message']))
{
	$json_array = array();

	/*
	$message = "the test message";
	$tickerText = "ticker text message";
	$contentTitle = "content title";
	$contentText = "content body";
	*/

	$message = "";	
	/*
	$tickerText = $_REQUEST['ticker_text'];
	$contentTitle = $_REQUEST['content_title'];
	$contentText = $_REQUEST['content_text'];
	*/
	$redeem_point = $_REQUEST['redeem_point'];
	$business_name = urldecode($_REQUEST['business_name']);
	$notificationtype = $_REQUEST['notificationtype'];
	$customer_id = $_REQUEST['customer_id'];
	
	$tickerText = "You earned ".$redeem_point." Scanflip points for your recent visit at ".$business_name.". Rate your visit.";
	$contentTitle = $merchant_msg['redeem-deal']['Msg_gcm_title'];
	$contentText = "You earned ".$redeem_point." Scanflip points for your recent visit at ".$business_name.". Rate your visit.";
														
	
	// Put your device token here (without spaces):
	$deviceToken = $_REQUEST['device_id'];

	// Put your private key's passphrase here:
	$passphrase = 'scanflip';

	// Put your alert message here:
	$message = $contentText;
	$arr= array();
	$arr['customer_id']=$customer_id;
	$arr['notificationType']=$notificationtype;
	
	$ctx = stream_context_create();
	stream_context_set_option($ctx, 'ssl', 'local_cert', 'Scanflipck.pem');
	stream_context_set_option($ctx, 'ssl', 'passphrase', $passphrase);

	// Open a connection to the APNS server
	$fp = stream_socket_client(
		'ssl://gateway.sandbox.push.apple.com:2195', $err,
		$errstr, 60, STREAM_CLIENT_CONNECT|STREAM_CLIENT_PERSISTENT, $ctx);

	if (!$fp)
		exit("Failed to connect: $err $errstr" . PHP_EOL);
	
	// Create the payload body
	$body['aps'] = array(
		'alert' => $message,
		'sound' => 'default',
		'param'=>$arr
		);

	// Encode the payload as JSON
	$payload = json_encode($body);

	// Build the binary notification
	$msg = chr(0) . pack('n', 32) . pack('H*', $deviceToken) . pack('n', strlen($payload)) . $payload;

	// Send it to the server
	$result = fwrite($fp, $msg, strlen($msg));

	if (!$result)
		echo 'Message not delivered' . PHP_EOL;
	else
		echo 'Message successfully delivered' . PHP_EOL;

	// Close the connection to the server
	fclose($fp);
	
    $json_array['status'] = "true";
	$json_array['message'] = $result;
    $json = json_encode($json_array);
	echo $json;
	exit();
}
/************* check emplaoyee exsits or not  ***********************/

/******** 
@USE : check emplayee active or not
@PARAMETER : 
@RETURN : json data
@USED IN PAGES : header.php
*********/
if(isset($_REQUEST['check_emplayee_active']))
{
 //echo "iinn";
	$json_array = array();
	$json_array['status'] = "true";
	if(isset($_SESSION['merchant_id']))
	{
		if($_SESSION['merchant_id'] != "")
		{
			if($_SESSION['profile_complete'] != 0)
			{
				/*$Sql = "select * from merchant_user where id=".$_SESSION['merchant_id']." and active= 1 and approve=1";
				$RS_loc = $objDB->Conn->Execute($Sql);*/
				$RS_loc = $objDB->Conn->Execute("select * from merchant_user where id=? and active= ? and approve=?",array($_SESSION['merchant_id'],1,1));

				if($RS_loc->RecordCount() == 0)
				{
					$json_array['redirecting'] = WEB_PATH."/merchant/logout-register.php";
					$json_array['status'] = "false";
				}
				else
				{	
					$json_array['status'] = "true";
				}
			}
			else
			{
				$json_array['status'] = "true";
			}
		}
		else
		{	
			$json_array['status'] = "true";
		}
	}
	else
	{	
		//$json_array['redirecting'] = WEB_PATH."/merchant/logout-register.php";
		$json_array['status'] = "true";
	}
	 $json = json_encode($json_array);
	echo $json;
	exit();
} 
function change_permalink($merchant_id)
{
	$objDB = new DB('read');
        $objDBWrt = new DB('write');
$objJSON = new JSON();

	$sql = "select * from locations";
//echo $sql;
$RS_location_groups = $objDB->Conn->Execute($sql);
while($Row_location = $RS_location_groups->FetchRow())
{

			$arr=file(WEB_PATH.'/process.php?getlocationbusinessname=yes&l_id='.$Row_location['id']);
                                                if(trim($arr[0]) == "")
                                                     {
                                                             unset($arr[0]);
                                                             $arr = array_values($arr);
                                                     }
                                                     $json = json_decode($arr[0]);
                                                $busines_name  = $json->bus_name;
                                               $b = $busines_name; 
											   //print_r($Row_location);
		$permalink_url = $objJSON->create_location_url($Row_location['id'],$Row_location['location_name'],$Row_location['city']);
		/*$sql = "update locations set location_permalink ='".$permalink_url."' where id=".$Row_location['id'];
		$objDB->Conn->Execute($sql); */
		$objDBWrt->Conn->Execute("update locations set location_permalink =? where id=?",array($permalink_url,$Row_location['id'])); 
		
	}
}

/******** 
@USE : change permalink
@PARAMETER : l_id,business_name
@RETURN : json data
@USED IN PAGES : process.php
*********/
if(isset($_REQUEST['chage_permalink']))
{

/*$sql = "select * from locations where created_by =".$_REQUEST['l_id'];
$RS_location_groups = $objDB->Conn->Execute($sql);*/
$RS_location_groups = $objDB->Conn->Execute("select * from locations where created_by =?",array($_REQUEST['l_id']));

while($Row_location = $RS_location_groups->FetchRow())
{

			
											   $b= $_REQUEST['business_name'];
											   //print_r($Row_location);
		$permalink_url = $objJSON->create_location_url($Row_location['id'],$Row_location['location_name'],$Row_location['city']);
		/*$sql = "update locations set location_permalink ='".$permalink_url."' where id=".$Row_location['id'];
		$objDB->Conn->Execute($sql); */
		$objDBWrt->Conn->Execute("update locations set location_permalink =? where id=?",array($permalink_url,$Row_location['id'])); 
		
	}

}

/******** 
@USE : remove merchant during setup
@PARAMETER : merchant_id
@RETURN : 
@USED IN PAGES : merchant-user.php
*********/
if(isset($_REQUEST['remove_setup']))
{
	$array_where = array();
	$array_where['id'] = $_REQUEST['merchant_id'];
	$objDBWrt->Remove("merchant_user", $array_where);
}
function create_unique_code($merchant_id)
{
    $code_length=16;
    //echo $alfa = "1AB2CD3EF4G5HI6JK7LM8N9OP10QRSTU".$campaign_id."VWXYZ";
    $alfa = "12345678910ABCDEFGHIJKLMNOPQRSTUVWXYZ".$merchant_id."abcdefghijklmnopqrstuvwxyz";
    $code="";
    for($i = 0; $i < $code_length; $i ++) 
    {
      $code .= $alfa[rand(0, strlen($alfa)-1)];
    } 
    return $code;
}

/******** 
@USE : to verify merchant user
@PARAMETER : email
@RETURN : 
@USED IN PAGES : process.php
*********/
if(isset($_REQUEST['btnverifyemail']))
{
	$json_array = $array_new = $where_clause1 = array();
	$array_new['email_verified'] = 1;
	$where_clause1['email'] = $_REQUEST['email'];
	
	if(isset($_REQUEST['employee']))
	{
		$array_new['approve'] = 1;	
	}
	
	$objDBWrt->Update($array_new , "merchant_user", $where_clause1);
	
	if(isset($_REQUEST['employee']))
	{
	
	$array123=array();
	$array123['email'] =  $_REQUEST['email'];
	
	$RS123 = $objDB->Show("merchant_user",$array123);
	
	$token=create_unique_code($RS123->fields['id']);
	$array_values['token'] = $token;
	$array_values['token_created_at'] = date('Y-m-d H:i:s');
	$array_where['email'] = $_REQUEST['email'];
	$objDBWrt->Update($array_values,"merchant_user", $array_where);
			
	$mail = new PHPMailer();
	$body='<body bgcolor="#e4e4e4" topmargin="0" leftmargin="0" marginheight="0" marginwidth="0" style="-webkit-font-smoothing: antialiased;width:100% !important;background:#e4e4e4;-webkit-text-size-adjust:none;">
	
<table width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="#e4e4e4">
    <tr>
        <td bgcolor="#e4e4e4" width="100%">
            <table width="600" cellpadding="0" cellspacing="0" border="0" align="center" class="table"
                style="background: #D2D2D2; border: 2px solid #ddd; padding: 20px; border-radius: 10px;">
                <tr>
                    <td width="600" class="cell">
                        <table width="600" cellpadding="0" cellspacing="0" border="0" class="table">
                            <tr>
                                <td width="250" class="logocell">
									<img src="'.ASSETS_IMG.'/m/logo-merchant.png" width="250" height="30" alt="Scanflip Merchant"
                                        style="-ms-interpolation-mode: bicubic; padding: 20px 0;">
                                </td>
                            </tr>
                        </table>
                        <repeater>
			<layout label="New feature">
			<table width="100%" cellpadding="0" cellspacing="0" border="0">
			<tr>
				<td bgcolor="#F37E0A" nowrap><img border="0" src="'.ASSETS_IMG.'/m/spacer.gif" width="5" height="1"></td>
				<td width="100%" bgcolor="#ffffff">
			
					<table width="100%" cellpadding="20" cellspacing="0" border="0">
					<tr>
						<td bgcolor="white" class="contentblock">
							<h4 style="color:black; font-size:16px; line-height:24px; font-family:Helvetica Neue,Helvetica,Arial,sans-serif; margin-top:0; margin-bottom:10px; padding-top:0; padding-bottom:0; font-weight:normal;"><strong><singleline label="Title">Hi '.$RS123->fields['firstname'].',</singleline></strong></h4>
							<multiline label="Description">
							<p style=" color: black; font-family:Helvetica Neue,Helvetica,Arial,sans-serif; font-size: 13px; font-weight: normal; line-height: 19px; margin-bottom: 12px; margin-top: 0; padding-bottom: 0; padding-top: 0;">
							Your merchant account has been approved and activated. Please click on the link below to set up your password and login into your scanflip account.<br/><br/>

							<p><a href="'.WEB_PATH.'/merchant/forgot_password.php?token='.$token.'">'.WEB_PATH.'/merchant/forgot_password.php?token='.$token.'</a></p>
							To protect your account, please keep your password safe. We recommend that you change your password periodically.</p></multiline>                 
                    		<h5><p style=" color: black; font-family:Helvetica Neue,Helvetica,Arial,sans-serif; font-size: 13px; font-weight: normal; line-height: 19px; margin-bottom: 12px; margin-top: 0; padding-bottom: 0; padding-top: 0;">Thank You,<br/>Scanflip Support Team.</p></h5>
						</td>
					</tr>
					</table>
				</td>
			</tr>
			</table>  
			</layout>
		</repeater>
                    </td>
                </tr>
            </table>
        </td>
    </tr>
</table>

</body>';	

		$mail->AddReplyTo('no-reply@scanflip.com','ScanFlip Support');
		$mail->AddAddress($RS123->fields['email']);
		$mail->From = "no-reply@scanflip.com";
		$mail->FromName = "ScanFlip Support";
		$mail->Subject    = "Scanflip Account Activation";
		$mail->MsgHTML($body);
					   //echo $body;
		$mail->Send();
			
	}
	
	header("Location:verify_email.php");
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();
}
// get UTC/GMT timezone from offset

function timezone_offsethour_string( $offset )
{
       return sprintf( "%s%02d:%02d", ( $offset >= 0 ) ? '+' : '-', abs( $offset / 3600 ), abs( $offset % 3600 ) );
}
function getStandardOffsetUTC($timezone,$offset)
{
if($timezone == 'UTC') {
	return '';
} else {
	$timezone = new DateTimeZone($timezone);
	$transitions = array_slice($timezone->getTransitions(), -3, null, true);

	foreach (array_reverse($transitions, true) as $transition)
	{
		if ($transition['isdst'] == 1)
		{
			continue;
		}

		return sprintf('%+03d:%02u', $offset / 3600, abs($offset) % 3600 / 60);
	}

	return false;

}
} 
/******** 
@USE : Update Location timezone according to according to dst format
@PARAMETER : location id
@RETURN : Status
@USED IN PAGES : locations.php
*********/
if(isset($_REQUEST['btnupdatetimezone']))
{
		try{
	/*$sql = "select * from locations where id=".$_REQUEST['id'];
	$RS = $objDB->Conn->Execute($sql);  */
	$RS = $objDB->Conn->Execute("select * from locations where id=?",array($_REQUEST['id']));  
	while($Row = $RS->FetchRow()){
	
    $geocode= file_get_contents("https://api.timezonedb.com/?lat=".$Row['latitude']."&lng=".$Row['longitude']."&key=V5R3I13VWW28&format=json");
	$geojson= json_decode($geocode,true);	
	
		if($geojson['dst'] == 1)
		{
			$timezone_name = $geojson['zoneName'];
			$zonehouroffset = timezone_offsethour_string($geojson['gmtOffset']).",0";
			
		}
		else
		{
			$timezone_name = $geojson['zoneName'];
			$zonehouroffset = getStandardOffsetUTC($geojson['zoneName'],$geojson['gmtOffset']).",0";
			
		} 
		$sql = "update locations set timezone_name='".$timezone_name."' , timezone='".$zonehouroffset."' where id=".$Row['id'];
		$objDB->Conn->Execute($sql);
		
	}
	}catch (Exception $e) {
		echo 'Caught exception: ',  $e->getMessage(), "\n";
	}
	//echo "Timezone updated successfully";
	$_SESSION['msg'] = "Timezone updated successfully";
	header("Location:".WEB_PATH."/merchant/locations.php");
}

/******** 
@USE : check online campaign enable or not
@PARAMETER : 
@RETURN : json data
@USED IN PAGES : compaigns.php
*********/
if(isset($_REQUEST['check_enable_online_campaign']))
{
	$merchant_id=$_SESSION['merchant_id'];
	/*$sql = "select * from merchant_user where id=".$merchant_id;
	$RS_mu= $objDB->Conn->Execute($sql);*/
	$RS_mu= $objDB->Conn->Execute("select * from merchant_user where id=?",array($merchant_id));
	$enable_online_campaign = $RS_mu->fields['enable_online_campaign'];
	if($enable_online_campaign==1)
	{
		$json_array = array();	
		$json_array['status'] = "true";
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
	else
	{
		$json_array = array();	
		$json_array['status'] = "false";
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
}
//add campaigns according to merchant id
if(isset($_REQUEST['mysqlscript'])){
	$error = "added successfully";
	
	
	$get_billing_pack_data->fields['transaction_fees'];
	$pack_data['merchant_id'] = $_REQUEST['merchant_id'];
    $get_pack_data = $objDB->Show("merchant_billing",$pack_data);
    $pack_data1['id'] = $get_pack_data->fields['pack_id'];
    $get_billing_pack_data = $objDB->Show("billing_packages",$pack_data1); 
	$transcation_fees = $get_billing_pack_data->fields['transaction_fees'];
	
	/*$sql = "select id from locations where created_by=".$_REQUEST['merchant_id'];
	
	$all_lolcations = $objDB->Conn->Execute($sql);*/
	$all_lolcations = $objDB->Conn->Execute("select id from locations where created_by=?",array($_REQUEST['merchant_id']));
		
	$location_arr= array();
	while($Row = $all_lolcations->FetchRow()){
		array_push($location_arr,$Row['id']);
	}
	
	for($k=0;$k<$_REQUEST['numberofcamp'];$k++)
	{
	
	$rand_number = rand(1, $all_lolcations->RecordCount());
	
	$random_locations_array = array_rand($location_arr, $rand_number);
	
	$random_single_location_array = array_rand($location_arr, 1);
		$sql = "select id from categories";
	$all_categories = $objDB->Conn->Execute($sql);
	$category_arr = array();
	while($Row = $all_categories->FetchRow()){
		array_push($category_arr,$Row[id]);
	}
	
	$random_locations_array = array_rand($location_arr, $rand_number);
	
	$random_campaign_type = array_rand(array(1,2,3),1);
	$random_is_walkin = array_rand(array(0,1),1);

	$is_unique_random_array = array_rand(array(0,1),1);
	$random_assigned_group = array_rand(array(0,1),1);
    
	$business_name = 'Business name';
	/**** add campaign coding ****/
	$arr_campaign_type= array(1,2,3);
	$random_campaign_type = array_rand($arr_campaign_type,1);
	$random_is_walkin = array_rand(array(0,1),1);
	$is_unique_random_array = array_rand(array(0,1),1);
	$random_assigned_group = array_rand(array(0,1),1);
     	$array['title'] = "campaign_".strtotime(date('Y-m-d h:i:s')) . substr((string)microtime(), 1, 8);
		$array['campaign_tag']='pizza,burger,garlic,bread';
		/*$sql  = "select business , available_point from merchant_user where id= ".$_REQUEST['merchant_id'];
		
		$business_data = $objDB->Conn->Execute($sql);*/
		$business_data = $objDB->Conn->Execute("select business , available_point from merchant_user where id=?",array($_REQUEST['merchant_id']));
		
		// 02 10 2013
		
		// 02 10 2013
		$array['category_id'] = $category_arr[array_rand($category_arr,1)];
		$array['description'] = '<p>This is temporary campaign.hamik optical gives u good facilitie , discount , viat shop to get advantage of special offers.</p>';
			$array['terms_condition'] = '<p>This is temporary campaign.hamik optical gives u good facilitie , discount , viat shop to get advantage of special offers.</p>';
			$array['deal_detail_description'] = '<p>This is temporary campaign.hamik optical gives u good facilitie , discount , viat shop to get advantage of special offers.</p>';
			
			$array['deal_value'] = 24;
			$array['discount'] = 50;
			$array['saving'] = 12;
			$date = date("Y-m-d H:i:s",strtotime("-1 days"));
			$date2 = date("Y-m-d H:i:s",strtotime("+1 month"));
			$array['start_date'] = $date;
			$array['expiration_date'] = $date2;
			$array['redeem_rewards'] = 5;
			$array['referral_rewards'] = 5;
			
		    $array['block_point'] = (((count($random_locations_array)*2)*5) +((count($random_locations_array)*2)*$transcation_fees) )+(2*5);
			$array['transaction_fees'] = $transcation_fees;
			$calculated_val = (((count($random_locations_array)*2)*5) +((count($random_locations_array)*2)*$transcation_fees) )+(2*5);
			$setblock_point = ($business_data->fields['available_point'] - ((((count($random_locations_array)*2)*5) +((count($random_locations_array)*2)*$transcation_fees) )+(2*5)) );
			if($business_data->fields['available_point'] >= $calculated_val)
			{
				
			/*$Sql = "Update merchant_user set available_point =".$setblock_point ." where id=".$_REQUEST['merchant_id'];
		
			$objDB->Conn->Execute($Sql);*/
			$objDBWrt->Conn->Execute("Update merchant_user set available_point =? where id=?",array($setblock_point,$_REQUEST['merchant_id']));
			}
		
		$array['max_no_sharing'] = 2;
		   
		
		$array['number_of_use'] = $arr_campaign_type[$random_campaign_type];
		if($is_unique_random_array == 1)
			{
				if($array['number_of_use'] ==1)
				{
					$array['new_customer']=1;
				}
				else{
					$array['new_customer']=0;
				}
			}
		
			if($random_is_walkin == 0)
			{
				   $array['is_walkin'] =0;
				   /* */
					 if($random_assigned_group == 0)
					 {
						$array['level'] = 1;
					 }
					 else{
						$array['level'] = 0;
					 }
			}
			else
			{
				$array['level'] = 0;
				$array['is_walkin'] = 1;
			}
		
		$array['created_date'] = date("Y-m-d H:i:s");
		$array['modified_date'] = date("Y-m-d H:i:s");
		$array['created_by'] = $_REQUEST['merchant_id'];
			
		$array['visible'] = 1;
		
		//$random_is_walkin = 0;
		if($business_data->fields['available_point'] >= $calculated_val)
		{
		$campaign_id = $objDBWrt->Insert($array, "campaigns");
		
		
		if(! is_array($random_locations_array))
		{
			$r = $random_locations_array;
			$random_locations_array = array();
			array_push($random_locations_array,$r);
		}
		else
		{
		}
		
	for($i=0;$i<count($random_locations_array);$i++)
	{
		$array_cl = array();
		$array_cl['campaign_id'] = $campaign_id;
			$array_cl['location_id'] = $location_arr[$random_locations_array[$i]];
						$camp_type = array_rand(array(2,3),1);
						if($camp_type == 1)
						{
							$camp_type =3 ;
						}
						else
						{
							$camp_type = 2;
						}
						
					
						if($array['level'] == 1)
						{
							$camp_type  = 1;
						}
					$array_cl['num_activation_code'] = 2;
					  $array_cl['offers_left'] = 2;
					  $array_cl['campaign_type'] = $camp_type;
	//				  $permalink_url = $objJSON->create_camapign_url($campaign_id,$random_locations_array[$i],$array['title'],$business_name,$array['category_id']);
					 $permalink_url = "https://www.scanflip.com/Gifts-Shopping/Business-logo-9-for-a-36-Piece-Fireworks-Lightning-Bolt-Package-OTkz-ODU=.html";
					  $array_cl['permalink'] = $permalink_url;
					  
					  
		
		//$camp_type = 3;
		if($camp_type ==1 ||  $camp_type ==2)
		{
			/*$group_sql = "select id from merchant_groups where location_id=".$location_arr[$random_locations_array[$i]]." and private=1";
			$RS_group = $objDB->Conn->Execute($group_sql);*/
			$RS_group = $objDB->Conn->Execute("select id from merchant_groups where location_id=? and private=?",array($location_arr[$random_locations_array[$i]],1));
			$group_id= $RS_group->fields['id'];
		}
		else{
			/*$group_sql = "select id from merchant_groups where location_id=".$location_arr[$random_locations_array[$i]]." and private <>1";
			$RS_group = $objDB->Conn->Execute($group_sql);*/
			$RS_group = $objDB->Conn->Execute("select id from merchant_groups where location_id=? and private <>?",array($location_arr[$random_locations_array[$i]],1));
			$group_array = array();
			if($RS_group->RecordCount() != 0)
			{
				while($Row = $RS_group->FetchRow()){
					array_push($group_array,$Row[id]);
				}
				$group_id = array_rand($group_array, 1);
				 $group_id = $group_array[$group_id];
				
			}
			else{
				if($array['level'] != 1)
				{
					 $array_cl['campaign_type'] = 2;
					
				}
				/*$group_sql = "select id from merchant_groups where location_id=".$location_arr[$random_locations_array[$i]]." and private=1";
				$RS_group = $objDB->Conn->Execute($group_sql);*/
				$RS_group = $objDB->Conn->Execute("select id from merchant_groups where location_id=? and private=?",array($location_arr[$random_locations_array[$i]],1));
				$group_id= $RS_group->fields['id'];
			}
			
			
		}
		
		
        if($random_is_walkin == 0)
		{
            /*$Sql = "INSERT  INTO campaign_groups SET group_id='$group_id', campaign_id='$campaign_id', merchant_id=".$_REQUEST['merchant_id'];
			 $objDB->Conn->Execute($Sql);	*/
			$objDBWrt->Conn->Execute("INSERT  INTO campaign_groups SET group_id=?, campaign_id=?, merchant_id=?",array($group_id,$campaign_id,$_REQUEST['merchant_id']));	
        }
		else
		{
			$array_cl['campaign_type'] = 0;
		}
		
		$objDBWrt->Insert($array_cl, "campaign_location");
	}
	$act_array = array();
	//$array['activation_code'] = md5($campaign_id.date("Y-m-d H:i:s"));
        $act_array['activation_code'] = create_campaign_code($campaign_id);
	$act_array['campaign_id'] = $campaign_id;
	
	$objDBWrt->Insert($act_array, "activation_codes");	
	}
	else
	{
		$error = "Not enough point available";
	}
	}
	echo $error;
}

/******** 
@USE : validate couponcode
@PARAMETER : apikey
@RETURN : json data
@USED IN PAGES : from api
*********/
if(isset($_REQUEST['validate_couponcode']))
{
	$json_array = array();
	$apikey="";
	$barcode="";
	$merchant_array = array();
	$merchant_id = "";
	$merchant_parent_id ="";
	
	$deal_value = "";
	$discount = "";
	$saving = "";  
	$campaign_type = 0;  
	
	if(isset($_REQUEST['apikey']))
	{
		$apikey = $_REQUEST['apikey'];
		
		if($apikey == "")
		{
			$json_array['status'] = "false";
			$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_apikey_invalid"];
			$json = json_encode($json_array);
			$objDB->Conn->CompleteTrans(); 
			echo $json;
			return $json;
		}
		else
		{
			
			$merchant_array['apikey'] = $apikey;
			$merchant_info = $objDB->Show("merchant_user",$merchant_array);
			$merchant_id = $merchant_info->fields['id'];
			$merchant_parent_id = $merchant_info->fields['merchant_parent'];
			
			if($merchant_info->RecordCount()==0)
			{
				$json_array['status'] = "false";
				$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_apikey_invalid"];
				$json = json_encode($json_array);
				$objDB->Conn->CompleteTrans(); 
				echo $json;
				return $json;
			}
		}		
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_apikey_invalid"];
		$json = json_encode($json_array);
        $objDB->Conn->CompleteTrans(); 
		echo $json;
		return $json;
	}
	
	if(isset($_REQUEST['couponcode']))
	{
		$barcode = $_REQUEST['couponcode'];
		
		if($barcode == "")
		{
			$json_array['status'] = "false";
			$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_enter_proper_coupon_code"];
			$json = json_encode($json_array);
			$objDB->Conn->CompleteTrans(); 
			echo $json;
			return $json;
		}
		else
		{
			/*$sql = "select * from coupon_codes where coupon_code='".$barcode."'";
			$RS_cc= $objDB->Conn->Execute($sql);*/
			$RS_cc= $objDB->Conn->Execute("select * from coupon_codes where coupon_code=?",array($barcode));
			$campaign_id = $RS_cc->fields['customer_campaign_code'];   
			
			/*$sql = "select * from campaigns where id='".$campaign_id."'";
			$RS_c= $objDB->Conn->Execute($sql);*/
			$RS_c= $objDB->Conn->Execute("select * from campaigns where id=?",array($campaign_id));
			
			$campaign_type = $RS_c->fields['campaign_type'];
			$deal_value = $RS_c->fields['deal_value'];   
			$discount = $RS_c->fields['discount'];   
			$saving = $RS_c->fields['saving']; 
			
		}
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_enter_proper_coupon_code"];
		$json = json_encode($json_array);
        $objDB->Conn->CompleteTrans(); 
		echo $json;
		return $json;
	}

	if($campaign_type != 2 )
	{
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_not_online_campaign"];
		$json = json_encode($json_array);
        $objDB->Conn->CompleteTrans(); 
		echo $json;
		return $json;
	}
	
	if($barcode != "")
	{
		/*$Sql = "SELECT * FROM coupon_codes where coupon_code='".$barcode."'";			
		$RS = $objDB->Conn->Execute($Sql);*/
		$RS = $objDB->Conn->Execute("SELECT * FROM coupon_codes where coupon_code=?",array($barcode));
		
		//echo $RS->fields['customer_campaign_code'];         
		//echo $RS->RecordCount();
		
		if($RS->RecordCount() > 0)
		{
			if($merchant_parent_id == 0)
			{
				 
				$arr_ids=getallsubmercahnt_id($merchant_id);
				$ids=  implode(",", $arr_ids);
				
				if($ids=="")
					$ids=$merchant_id;
				
				/*$Sql = "SELECT * FROM campaigns cp WHERE cp.id=".$RS->fields['customer_campaign_code']." and (cp.created_by = '$merchant_id' or cp.created_by in (".$ids."))";
				
				$RS = $objDB->Conn->Execute($Sql);*/
				$RS = $objDB->Conn->Execute("SELECT * FROM campaigns cp WHERE cp.id=? and (cp.created_by =? or cp.created_by in (?))",array($RS->fields['customer_campaign_code'],$merchant_id,$ids));

                $arr=file(WEB_PATH.'/merchant/process.php?get_point_package=yes');
				
				if(trim($arr[0]) == "")
				{
					unset($arr[0]);
					$arr = array_values($arr);
				}
				$json = json_decode($arr[0]);
				$total_records= $json->total_records;
				$records_array = $json->records;
				if($total_records>0)
				{
					foreach($records_array as $Row)
					{	
						$price =$Row->price;
						$point_=$Row->points;
						$p= (1*$price)/$point_;
					}
				}
				$B4 = (1*$price)/$point_;
				if($RS->RecordCount()<=0)
				{
					$json_array['status'] = "false";
					$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_different_merchant"];
					$json = json_encode($json_array);
                    $objDB->Conn->CompleteTrans(); 
					echo $json;
					return $json;
				} 
			}
			else
			{
				//$Sql = "SELECT * FROM campaigns cp WHERE cp.id=".$RS->fields['customer_campaign_code']." and cp.created_by = '$merchant_id'";
				
				//04 10 2013
				
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
							FROM coupon_codes c, campaigns cp WHERE c.active =1 and 
							c.coupon_code='".$barcode."' and cp.id=c.customer_campaign_code  and c.location_id in
								(select id from locations where active =1 )  and  cp.id in 
								(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
								mur.merchant_user_id = ".$merchant_id." and cl.location_id = mur.location_access and c.location_id=mur.location_access) ";
				
					
				//04 10 2013
				
				$RS = $objDB->Conn->Execute($Sql);*/
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing FROM coupon_codes c, campaigns cp WHERE c.active =? and c.coupon_code=? and cp.id=c.customer_campaign_code  and c.location_id in(select id from locations where active =? )  and  cp.id in(select cl.campaign_id from campaign_location cl , merchant_user_role mur where mur.merchant_user_id =? and cl.location_id = mur.location_access and c.location_id=mur.location_access) ",array(1,$barcode,1,$merchant_id));

				if($RS->RecordCount()<=0)
				{
					$json_array['status'] = "false";
					//$json_array['message'] = "This coupon is not for this store.";
					
					$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_different_location"];
					
					$json = json_encode($json_array);
                    $objDB->Conn->CompleteTrans(); 
					echo $json;
					return $json;
					exit;
				}
			}
		
			if($merchant_parent_id== 0)
			{
				// to redeem all child coupon
				$arr_ids=getallsubmercahnt_id($merchant_id);
				 $ids=  implode(",", $arr_ids);
			
				 if($ids=="")
					$ids=$merchant_id;
				// 	to redeem all child coupon
				
				//$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE start_date<='$date_f' AND expiration_date >='$date_f' AND visible='1' AND id =".$RS->fields['customer_campaign_code'] ." AND (created_by = '$merchant_id' or created_by in ( select id from merchant_user where merchant_parent = ". $merchant_id ." ))";
				
				//$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =1 ) and (cp.created_by = '$merchant_id' or cp.created_by in ( select id from merchant_user where merchant_parent = ". $merchant_id ." ))";
				
				// change query for all child 
				/*$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code='".$barcode."' and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =1 ) and (cp.created_by = '$merchant_id' or cp.created_by in (".$ids."))";*/
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =? and c.coupon_code=? and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =? ) and (cp.created_by = ? or cp.created_by in (?))",array(1,$barcode,1,$merchant_id,$ids));
				// change query for all child 
				
			}
			else
			{
					
				
					$Where_miles = "";	   
			
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
							FROM coupon_codes c, campaigns cp WHERE c.active =1 and 
							c.coupon_code='".$barcode."' and cp.id=c.customer_campaign_code  and c.location_id in
								(select id from locations where active =1 )  and ( cp.id in 
								(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
								mur.merchant_user_id = ".$merchant_id." and cl.location_id = mur.location_access ) ".$Where_miles." )";*/
			$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
							FROM coupon_codes c, campaigns cp WHERE c.active =? and 
							c.coupon_code=? and cp.id=c.customer_campaign_code  and c.location_id in
								(select id from locations where active =? )  and ( cp.id in 
								(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
								mur.merchant_user_id = ? and cl.location_id = mur.location_access ) ".$Where_miles." )",array(1,$barcode,1,$merchant_id));

			}
			
			//$RS = $objDB->Conn->Execute($Sql);
			if($RS->RecordCount()<=0)
			{
				$json_array['status'] = "false";
				//$json_array['message'] = "This coupon is not for this store.";
				$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_voucher_code_not_valid"];
				$json = json_encode($json_array);
                                $objDB->Conn->CompleteTrans(); 
				echo $json;
				return $json;
				
			}
			else
			{
				$array_loc['id']=$RS->fields['location_id'];
				$RS_location = $objDB->Show("locations",$array_loc);
				$time_zone=$RS_location->fields['timezone_name'];
				date_default_timezone_set($time_zone);
				
				//$dt_wh = " CONVERT_TZ(NOW(),'+00:00','+00:00') BETWEEN CONVERT_TZ(start_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) AND CONVERT_TZ(expiration_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) ";
						  //$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."','+00:00') BETWEEN CONVERT_TZ(c.start_date,'+00:00',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) AND CONVERT_TZ(c.expiration_date,'+00:00',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))"; 
				$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN  c.start_date AND c.expiration_date   and cl.active_in_future<>1"; 
				$date_f = date("Y-m-d H:i:s");
				/*$Sql = "SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible='1' AND c.id =".$RS->fields['customer_campaign_code']." and l.id =".$RS->fields['location_id'];
				
				$RS_t = $objDB->Conn->Execute($Sql);*/
				$RS_t = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible=? AND c.id =? and l.id =?",array(1,$RS->fields['customer_campaign_code'],$RS->fields['location_id']));
				if($RS_t->fields['total'] == 0)
				{
					$json_array['status'] = "false";
					$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_campaign_expire"];
					$json = json_encode($json_array);
                    $objDB->Conn->CompleteTrans(); 
					echo $json;
					return $json;
				}
				else
				{
					$sharing_msg = ".";
					/*$Sql = "SELECT number_of_use, redeem_rewards FROM campaigns WHERE id =".$RS->fields['customer_campaign_code'];
					$RS_camp_detail = $objDB->Conn->Execute($Sql);*/
					$RS_camp_detail = $objDB->Conn->Execute("SELECT number_of_use, redeem_rewards FROM campaigns WHERE id =?",array($RS->fields['customer_campaign_code']));

					//-- start for point deduction
					$array_where_user = array();
					$array_where_user['id'] = $merchant_id;
					$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
					$m_parent = $RS_merchant_User->fields['merchant_parent'];
					//if($RS_User->fields['merchant_parent'] == 0)
					if($RS_merchant_User->fields['merchant_parent'] == 0)
					{
						$merchant_id = $merchant_id;
					}
					else
					{
						$merchant_id = $RS_merchant_User->fields['merchant_parent'];
					}
					
					$array_where_user = array();
					$array_where_user['id'] = $merchant_id;
					$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
					//-- End of point deduction
												
					if($RS_camp_detail->fields['number_of_use'] == 1)
					{
						/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']. " and location_id=".$RS->fields['location_id'];
						$RS_user_exist = $objDB->Conn->Execute($Sql);*/
						$RS_user_exist = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(0,$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

						if($RS_user_exist->RecordCount() == 0)
						{
							$st = true;
													/* Don't give point if max nof sharing rich */
							
							 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";

								 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
								$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));
					
								 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] )
								 {
							
									/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
											
									$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
									$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

									if($RS_referral_customer->RecordCount() != 0)
									{
										$where = array();
										$where['referred_customer_id'] = $RS->fields['customer_id'];
										$where['campaign_id'] = $RS->fields['customer_campaign_code'];
										$where['referral_reward'] = 0;
										$where['location_id'] = $RS->fields['location_id'];
										
										$u_array = array();
										if(($RS->fields['block_point']-$RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
										{
											//$u_array['referral_reward'] = $RS->fields['referral_rewards'];
																				$sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
										}
										else
										{
											 $sharing_msg = ".";
										}
																			
									}
								 }
							/* Don't give point if max nof sharing rich */
							
						}
						else
						{
							$json_array['status'] = "false";
							$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_campaign_already_redeemed"];
							$json = json_encode($json_array);
                            $objDB->Conn->CompleteTrans(); 
							echo $json;
							return $json;
						}
					}
					else if($RS_camp_detail->fields['number_of_use'] == 2)
					{
	//                                    $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
	//                                    $RS_2_use = $objDB->Conn->Execute($Sql_2_use);
	//                                    if($RS_2_use->RecordCount() >0){
							/*$location_max_sql = "Select num_activation_code , offers_left from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
							 $location_max = $objDB->Conn->Execute($location_max_sql);*/
							$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));
							   $max_coupon = $location_max->fields['num_activation_code'];
							   $o_left = $location_max->fields['offers_left'];
													//    }
							   $flag_redeem =1;
							  // $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
								/*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
										$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
								$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));
									if($RS_2_use->RecordCount() <=0)
									{
											$flag_redeem =0;
									}
	
										if($o_left>0 || $flag_redeem==0)
										{
										   
					//	$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code'] ." and  DATE_FORMAT(reward_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  and location_id=".$RS->fields['location_id'];
											/*$Sql = "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  ";
						
											$RS_user_exist = $objDB->Conn->Execute($Sql);*/
					$RS_user_exist = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  =  ?  ",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id'],date('Y-m-d')));
										   
											if($RS_user_exist->RecordCount() == 0)
											{
							$st = true;
													 /* Don't give point if max nof sharing rich */
							
							 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
							
								 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
							$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));
					
								 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] )
								 {
							
									/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
													
									$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
								$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

									if($RS_referral_customer->RecordCount() != 0)
									{
										$where = array();
										$where['referred_customer_id'] = $RS->fields['customer_id'];
										$where['campaign_id'] = $RS->fields['customer_campaign_code'];
										$where['referral_reward'] = 0;
										$where['location_id'] = $RS->fields['location_id'];
										
										$u_array = array();
										if(($RS->fields['block_point']-$RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
										{
											
																				$sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
										}
										else
										{
											 $sharing_msg = ".";
										}
																			
									}
								 }
							/* Don't give point if max nof sharing rich */
							
						}
											else
											{
																	$msg = "Sorry!  This voucher is already redeemed today by customer at ".date("g:i A", strtotime($RS_user_exist->fields['redeem_date'])) ." . Offer Limit : 1 per customer per day";
												$json_array['status'] = "false";
												$json_array['message'] = $msg ;
												$json = json_encode($json_array);
																			$objDB->Conn->CompleteTrans();
												echo $json;
												return $json;
											}
										}
										else
										{
											$json_array['status'] = "false";
											$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_no_offer_available"];
																   
											$json = json_encode($json_array);
																		$objDB->Conn->CompleteTrans();
											echo $json;
											return $json;
										}
						
					}
					else if($RS_camp_detail->fields['number_of_use'] == 3)
					{
							/* $location_max_sql = "Select num_activation_code , offers_left from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
						$location_max = $objDB->Conn->Execute($location_max_sql);*/
			$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));
													  $max_coupon = $location_max->fields['num_activation_code'];
													  $o_left = $location_max->fields['offers_left'];
									//    }
									   $flag_redeem =1;
		  //     $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
				/* $Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
										$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
						$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));
										if($RS_2_use->RecordCount() <=0){
											$flag_redeem =0;
									}
										if($o_left>0 || $flag_redeem==0)
										{
						$st = true;
											  /* Don't give point if max nof sharing rich */
							
							/* $Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
							
								 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
						$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));

								 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] ){

									/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
									
														
									$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
									$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

									if($RS_referral_customer->RecordCount() != 0)
									{
										$where = array();
										$where['referred_customer_id'] = $RS->fields['customer_id'];
										$where['campaign_id'] = $RS->fields['customer_campaign_code'];
										$where['referral_reward'] = 0;
										$where['location_id'] = $RS->fields['location_id'];
										
										$u_array = array();
										if(($RS->fields['block_point'] - $RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
										{
											
																				$sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
										}
										else{
											 $sharing_msg = ".";
										}
																			
									}
								 }
							/* Don't give point if max nof sharing rich */
							
										}
										else{
													$json_array['loginstatus'] = "true";
							$json_array['status'] = "false";
							$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_no_offer_available"];
												   
							$json = json_encode($json_array);
                                                        $objDB->Conn->CompleteTrans();
							echo $json;
							return $json;
						}
					}
					
					
				}
			}
		}
		else
		{
            $json_array['status'] = "false";
            $json_array['message'] = $merchant_msg["redeem-deal"]["Msg_coupon_code_not_exist"];
            $json = json_encode($json_array);
            $objDB->Conn->CompleteTrans(); 
            echo $json;
            return $json;
		}
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_enter_proper_coupon_code"];
		$json = json_encode($json_array);
        $objDB->Conn->CompleteTrans(); 
		echo $json;
		return $json;
	}
	
	$json_array = array();	
	$json_array['status'] = "true";
	$json_array['couponcode'] = $barcode ;
	$json_array['deal_value'] = $deal_value ;
	$json_array['discount'] = $discount ;
	$json_array['saving'] = $saving ;
	$json = json_encode($json_array);
	echo $json;
	exit();

}

/******** 
@USE : redeem couponcode
@PARAMETER : apikey,couponcode,txt_redeem_deal_value
@RETURN : json data
@USED IN PAGES : from api
*********/
if(isset($_REQUEST['redeem_couponcode']))
{
	$json_array = array();
	$barcode="";
	$merchant_array = array();
	$merchant_id = "";
	$merchant_parent_id ="";
	
	$deal_value = "";
	$discount = "";
	$saving = "";  
	$campaign_type = 0;  
	
	if(isset($_REQUEST['apikey']))
	{
		$apikey = $_REQUEST['apikey'];
		
		if($apikey == "")
		{
			$json_array['status'] = "false";
			$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_apikey_invalid"];
			$json = json_encode($json_array);
			$objDB->Conn->CompleteTrans(); 
			echo $json;
			return $json;
		}
		else
		{
			
			$merchant_array['apikey'] = $apikey;
			$merchant_info = $objDB->Show("merchant_user",$merchant_array);
			$merchant_id = $merchant_info->fields['id'];
			$merchant_parent_id = $merchant_info->fields['merchant_parent'];
			
			if($merchant_info->RecordCount()==0)
			{
				$json_array['status'] = "false";
				$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_apikey_invalid"];
				$json = json_encode($json_array);
				$objDB->Conn->CompleteTrans(); 
				echo $json;
				return $json;
			}
		}		
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_apikey_invalid"];
		$json = json_encode($json_array);
        	$objDB->Conn->CompleteTrans(); 
		echo $json;
		return $json;
	}
	
	if(isset($_REQUEST['couponcode']))
	{
		$barcode = $_REQUEST['couponcode'];
		
		if($barcode == "")
		{
			$json_array['status'] = "false";
			$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_enter_proper_coupon_code"];
			$json = json_encode($json_array);
			$objDB->Conn->CompleteTrans(); 
			echo $json;
			return $json;
		}
		else
		{
			/*$sql = "select * from coupon_codes where coupon_code='".$barcode."'";
			$RS_cc= $objDB->Conn->Execute($sql);*/
			$RS_cc= $objDB->Conn->Execute("select * from coupon_codes where coupon_code=?",array($barcode));
			$campaign_id = $RS_cc->fields['customer_campaign_code'];   
			
			/*$sql = "select * from campaigns where id='".$campaign_id."'";
			$RS_c= $objDB->Conn->Execute($sql);*/
			$RS_c= $objDB->Conn->Execute("select * from campaigns where id=?",array($campaign_id));
			
			$campaign_type = $RS_c->fields['campaign_type'];
			$deal_value = $RS_c->fields['deal_value'];   
			$discount = $RS_c->fields['discount'];   
			$saving = $RS_c->fields['saving']; 
			
		}
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_enter_proper_coupon_code"];
		$json = json_encode($json_array);
        	$objDB->Conn->CompleteTrans(); 
		echo $json;
		return $json;
	}

	if(isset($_REQUEST['txt_redeem_deal_value']))
	{
		$txt_redeem_deal_value = $_REQUEST['txt_redeem_deal_value'];
		if($txt_redeem_deal_value=="")
		{
			$json_array['status'] = "false";
			$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_update_sales"];
			$json = json_encode($json_array);
			$objDB->Conn->CompleteTrans(); 
			echo $json;
			return $json;
		}	
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_update_sales"];
		$json = json_encode($json_array);
		$objDB->Conn->CompleteTrans(); 
		echo $json;
		return $json;
	}
	
	if($campaign_type != 2 )
	{
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_not_online_campaign"];
		$json = json_encode($json_array);
        $objDB->Conn->CompleteTrans(); 
		echo $json;
		return $json;
	}
	
	if($barcode != "")
	{
		/*$Sql = "SELECT * FROM coupon_codes where coupon_code='".$barcode."'";			
		$RS = $objDB->Conn->Execute($Sql);*/
		$RS = $objDB->Conn->Execute("SELECT * FROM coupon_codes where coupon_code=?",array($barcode));
		
		if($RS->RecordCount() > 0)
		{
			if($merchant_parent_id == 0)
			{
				 
				$arr_ids=getallsubmercahnt_id($merchant_id);
				$ids=  implode(",", $arr_ids);
				
				if($ids=="")
					$ids=$merchant_id;
				
				/*$Sql = "SELECT * FROM campaigns cp WHERE cp.id=".$RS->fields['customer_campaign_code']." and (cp.created_by = '$merchant_id' or cp.created_by in (".$ids."))";
				
				$RS = $objDB->Conn->Execute($Sql);*/
				$RS = $objDB->Conn->Execute("SELECT * FROM campaigns cp WHERE cp.id=? and (cp.created_by = ? or cp.created_by in (?))",array($RS->fields['customer_campaign_code'],$merchant_id,$ids));

                $arr=file(WEB_PATH.'/merchant/process.php?get_point_package=yes');
				
				if(trim($arr[0]) == "")
				{
					unset($arr[0]);
					$arr = array_values($arr);
				}
				$json = json_decode($arr[0]);
				$total_records= $json->total_records;
				$records_array = $json->records;
				if($total_records>0)
				{
					foreach($records_array as $Row)
					{	
						$price =$Row->price;
						$point_=$Row->points;
						$p= (1*$price)/$point_;
					}
				}
				$B4 = (1*$price)/$point_;
				if($RS->RecordCount()<=0)
				{
					$json_array['status'] = "false";
					$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_different_merchant"];
					$json = json_encode($json_array);
                    $objDB->Conn->CompleteTrans(); 
					echo $json;
					return $json;
				} 
			}
			else
			{
				//$Sql = "SELECT * FROM campaigns cp WHERE cp.id=".$RS->fields['customer_campaign_code']." and cp.created_by = '$merchant_id'";
				
				//04 10 2013
				
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
							FROM coupon_codes c, campaigns cp WHERE c.active =1 and 
							c.coupon_code='".$barcode."' and cp.id=c.customer_campaign_code  and c.location_id in
								(select id from locations where active =1 )  and  cp.id in 
								(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
								mur.merchant_user_id = ".$merchant_id." and cl.location_id = mur.location_access and c.location_id=mur.location_access) ";
				
					
				//04 10 2013
				
				$RS = $objDB->Conn->Execute($Sql);*/
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing FROM coupon_codes c, campaigns cp WHERE c.active =? and c.coupon_code=? and cp.id=c.customer_campaign_code  and c.location_id in(select id from locations where active =? )  and  cp.id in (select cl.campaign_id from campaign_location cl , merchant_user_role mur where mur.merchant_user_id =? and cl.location_id = mur.location_access and c.location_id=mur.location_access) ",array(1,$barcode,1,$merchant_id));

				if($RS->RecordCount()<=0)
				{
					$json_array['status'] = "false";
					//$json_array['message'] = "This coupon is not for this store.";
					
					$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_different_location"];
					
					$json = json_encode($json_array);
                    $objDB->Conn->CompleteTrans(); 
					echo $json;
					return $json;
					exit;
				}
			}
		
			if($merchant_parent_id== 0)
			{
				// to redeem all child coupon
				$arr_ids=getallsubmercahnt_id($merchant_id);
				 $ids=  implode(",", $arr_ids);
			
				 if($ids=="")
					$ids=$merchant_id;
				// 	to redeem all child coupon
				
				//$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE start_date<='$date_f' AND expiration_date >='$date_f' AND visible='1' AND id =".$RS->fields['customer_campaign_code'] ." AND (created_by = '$merchant_id' or created_by in ( select id from merchant_user where merchant_parent = ". $merchant_id ." ))";
				
				//$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code='".$_REQUEST['txt_barcode']."' and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =1 ) and (cp.created_by = '$merchant_id' or cp.created_by in ( select id from merchant_user where merchant_parent = ". $merchant_id ." ))";
				
				// change query for all child 
				/*$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code='".$barcode."' and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =1 ) and (cp.created_by = '$merchant_id' or cp.created_by in (".$ids."))";*/
				// change query for all child 
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.block_point,cp.max_no_sharing  FROM coupon_codes c, campaigns cp WHERE c.active =? and c.coupon_code=? and cp.id=c.customer_campaign_code and c.location_id in (select id from locations where active =? ) and (cp.created_by = ? or cp.created_by in (?))",array(1,$barcode,1,$merchant_id,$ids));
				
			}
			else
			{
					
				
					$Where_miles = "";	   
			
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
							FROM coupon_codes c, campaigns cp WHERE c.active =1 and 
							c.coupon_code='".$barcode."' and cp.id=c.customer_campaign_code  and c.location_id in
								(select id from locations where active =1 )  and ( cp.id in 
								(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
								mur.merchant_user_id = ".$merchant_id." and cl.location_id = mur.location_access ) ".$Where_miles." )";*/
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.transaction_fees, cp.referral_rewards ,cp.block_point,cp.max_no_sharing 
							FROM coupon_codes c, campaigns cp WHERE c.active =? and 
							c.coupon_code=? and cp.id=c.customer_campaign_code  and c.location_id in
								(select id from locations where active =? )  and ( cp.id in 
								(select cl.campaign_id from campaign_location cl , merchant_user_role mur where
								mur.merchant_user_id =? and cl.location_id = mur.location_access ) ".$Where_miles." )",array(1,$barcode,1,$merchant_id));
			}
			
			//$RS = $objDB->Conn->Execute($Sql);
			if($RS->RecordCount()<=0)
			{
				$json_array['status'] = "false";
				//$json_array['message'] = "This coupon is not for this store.";
				$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_voucher_code_not_valid"];
				$json = json_encode($json_array);
                                $objDB->Conn->CompleteTrans(); 
				echo $json;
				return $json;
				
			}
			else
			{
				$array_loc['id']=$RS->fields['location_id'];
				$RS_location = $objDB->Show("locations",$array_loc);
				$time_zone=$RS_location->fields['timezone_name'];
				date_default_timezone_set($time_zone);
				
				//$dt_wh = " CONVERT_TZ(NOW(),'+00:00','+00:00') BETWEEN CONVERT_TZ(start_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) AND CONVERT_TZ(expiration_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) ";
						  //$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."','+00:00') BETWEEN CONVERT_TZ(c.start_date,'+00:00',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) AND CONVERT_TZ(c.expiration_date,'+00:00',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1))"; 
				$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN  c.start_date AND c.expiration_date   and cl.active_in_future<>1"; 
				$date_f = date("Y-m-d H:i:s");
				/*$Sql = "SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible='1' AND c.id =".$RS->fields['customer_campaign_code']." and l.id =".$RS->fields['location_id'];
				
				$RS_t = $objDB->Conn->Execute($Sql);*/
				$RS_t = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible=? AND c.id =? and l.id =?",array(1,$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

				if($RS_t->fields['total'] == 0)
				{
					$json_array['status'] = "false";
					$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_campaign_expire"];
					$json = json_encode($json_array);
                    $objDB->Conn->CompleteTrans(); 
					echo $json;
					return $json;
				}
				else
				{
					$sharing_msg = ".";
					/*$Sql = "SELECT number_of_use, redeem_rewards FROM campaigns WHERE id =".$RS->fields['customer_campaign_code'];
					$RS_camp_detail = $objDB->Conn->Execute($Sql);*/
					$RS_camp_detail = $objDB->Conn->Execute("SELECT number_of_use, redeem_rewards FROM campaigns WHERE id =?",array($RS->fields['customer_campaign_code']));

					//-- start for point deduction
					$array_where_user = array();
					$array_where_user['id'] = $merchant_id;
					$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
					$m_parent = $RS_merchant_User->fields['merchant_parent'];
					//if($RS_User->fields['merchant_parent'] == 0)
					if($RS_merchant_User->fields['merchant_parent'] == 0)
					{
						$merchant_id = $merchant_id;
					}
					else
					{
						$merchant_id = $RS_merchant_User->fields['merchant_parent'];
					}
					
					$array_where_user = array();
					$array_where_user['id'] = $merchant_id;
					$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
					
					if($RS_camp_detail->fields['number_of_use'] == 1)
					{
						/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']. " and location_id=".$RS->fields['location_id'];
						$RS_user_exist = $objDB->Conn->Execute($Sql);*/
						$RS_user_exist = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(0,$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

						if($RS_user_exist->RecordCount() == 0)
						{
							$st = true;
													/* Don't give point if max nof sharing rich */
							
							 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
							
								 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
								$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));
					
								 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] )
								 {
							
									/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
													
									$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
									$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

									if($RS_referral_customer->RecordCount() != 0)
									{
										$where = array();
										$where['referred_customer_id'] = $RS->fields['customer_id'];
										$where['campaign_id'] = $RS->fields['customer_campaign_code'];
										$where['referral_reward'] = 0;
										$where['location_id'] = $RS->fields['location_id'];
										
										$u_array = array();
										if(($RS->fields['block_point']-$RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
										{
											
																				$sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
										}
										else
										{
											 $sharing_msg = ".";
										}
																			
									}
								 }
							/* Don't give point if max nof sharing rich */
							
						}
						else
						{
							$json_array['status'] = "false";
							$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_campaign_already_redeemed"];
							$json = json_encode($json_array);
                            $objDB->Conn->CompleteTrans(); 
							echo $json;
							return $json;
						}
					}
					else if($RS_camp_detail->fields['number_of_use'] == 2)
					{
	//                                    $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
	//                                    $RS_2_use = $objDB->Conn->Execute($Sql_2_use);
	//                                    if($RS_2_use->RecordCount() >0){
							/*$location_max_sql = "Select num_activation_code , offers_left from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
							 $location_max = $objDB->Conn->Execute($location_max_sql);*/
							$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));
							   $max_coupon = $location_max->fields['num_activation_code'];
							   $o_left = $location_max->fields['offers_left'];

													//    }
							   $flag_redeem =1;
							  // $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
								/*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
										$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
									$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

									if($RS_2_use->RecordCount() <=0)
									{
											$flag_redeem =0;
									}

										if($o_left>0 || $flag_redeem==0)
										{
										   
					//	$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code'] ." and  DATE_FORMAT(reward_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  and location_id=".$RS->fields['location_id'];
											/*$Sql = "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  ";
						
											$RS_user_exist = $objDB->Conn->Execute($Sql);*/
						$RS_user_exist = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  = ?  ",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id'],date('Y-m-d')));
										   
											if($RS_user_exist->RecordCount() == 0)
											{
							$st = true;
													 /* Don't give point if max nof sharing rich */
							
							 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";

								 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
								$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));
					
								 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] )
								 {
							
									/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
								
														
									$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
									$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

									if($RS_referral_customer->RecordCount() != 0)
									{
										$where = array();
										$where['referred_customer_id'] = $RS->fields['customer_id'];
										$where['campaign_id'] = $RS->fields['customer_campaign_code'];
										$where['referral_reward'] = 0;
										$where['location_id'] = $RS->fields['location_id'];
										
										$u_array = array();
										if(($RS->fields['block_point']-$RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
										{
											
																				$sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
										}
										else
										{
											 $sharing_msg = ".";
										}
																			
									}
								 }
							/* Don't give point if max nof sharing rich */
							
						}
											else
											{
																	$msg = "Sorry!  This voucher is already redeemed today by customer at ".date("g:i A", strtotime($RS_user_exist->fields['redeem_date'])) ." . Offer Limit : 1 per customer per day";
												$json_array['status'] = "false";
												$json_array['message'] = $msg ;
												$json = json_encode($json_array);
																			$objDB->Conn->CompleteTrans();
												echo $json;
												return $json;
											}
										}
										else
										{
											$json_array['status'] = "false";
											$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_no_offer_available"];
																   
											$json = json_encode($json_array);
																		$objDB->Conn->CompleteTrans();
											echo $json;
											return $json;
										}
						
					}
					else if($RS_camp_detail->fields['number_of_use'] == 3)
					{
														 /*$location_max_sql = "Select num_activation_code , offers_left from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
													$location_max = $objDB->Conn->Execute($location_max_sql);*/
			$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));

													  $max_coupon = $location_max->fields['num_activation_code'];
													  $o_left = $location_max->fields['offers_left'];
									//    }
									   $flag_redeem =1;
		  //     $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
				 /*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
										$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
					$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));
										if($RS_2_use->RecordCount() <=0){
											$flag_redeem =0;
									}
										if($o_left>0 || $flag_redeem==0)
										{
						$st = true;
											  /* Don't give point if max nof sharing rich */
							
							 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
							 
								 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));
								 if($RS_shared->RecordCount() <  $RS->fields['max_no_sharing'] ){
							
									/*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." AND referral_reward = 0  AND location_id=".$RS->fields['location_id'];
									
														
									$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
								$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id =? AND referral_reward = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],0,$RS->fields['location_id']));

									if($RS_referral_customer->RecordCount() != 0)
									{
										$where = array();
										$where['referred_customer_id'] = $RS->fields['customer_id'];
										$where['campaign_id'] = $RS->fields['customer_campaign_code'];
										$where['referral_reward'] = 0;
										$where['location_id'] = $RS->fields['location_id'];
										
										$u_array = array();
										if(($RS->fields['block_point'] - $RS->fields['redeem_rewards']) >= $RS->fields['referral_rewards'] )
										{
											//$u_array['referral_reward'] = $RS->fields['referral_rewards'];
																				$sharing_msg = " and referral customer will earn ".$RS->fields['referral_rewards'] ." scanflip points.";
										}
										else{
											 $sharing_msg = ".";
										}
																			
									}
								 }
							/* Don't give point if max nof sharing rich */
						
										}
										else{
													$json_array['loginstatus'] = "true";
							$json_array['status'] = "false";
							$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_no_offer_available"];
												   
							$json = json_encode($json_array);
                                                        $objDB->Conn->CompleteTrans();
							echo $json;
							return $json;
						}
					}
					
					
				}
			}
		
			$array_loc['id']=$RS->fields['location_id'];
			$RS_location = $objDB->Show("locations",$array_loc);
			$time_zone=$RS_location->fields['timezone_name'];
			date_default_timezone_set($time_zone);
				
			if($merchant_parent_id == 0)
			{
				
				// to redeem all child coupon
				$arr_ids=getallsubmercahnt_id($merchant_id);
				$ids=  implode(",", $arr_ids);
				if($ids=="")
				$ids=$merchant_id;
				// 	to redeem all child coupon

				//$Sql = "SELECT c.*,cp.redeem_rewards , cp.referral_rewards ,cp.max_no_sharing ,cp.block_point  FROM coupon_codes c, campaigns cp WHERE c.active =1 and  c.coupon_code='".$_REQUEST['hdn_coupon_code']."' and cp.id=c.customer_campaign_code  and c.location_id in (select id from locations where active =1 ) and (cp.created_by = '$merchant_id' or cp.created_by in ( select id from merchant_user where merchant_parent = ". $merchant_id ." ))";

				// change query for all child 
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.no_of_shared, cp.transaction_fees ,cp.referral_rewards ,cp.max_no_sharing ,cp.block_point 
				FROM coupon_codes c, campaigns cp WHERE c.active =1 and  c.coupon_code='".$barcode."' 
				and cp.id=c.customer_campaign_code  and c.location_id in (select l.id from locations l where l.active =1 ) 
				and (cp.created_by = '$merchant_id' or cp.created_by in (".$ids."))";*/
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.no_of_shared, cp.transaction_fees ,cp.referral_rewards ,cp.max_no_sharing ,cp.block_point 
				FROM coupon_codes c, campaigns cp WHERE c.active =? and  c.coupon_code=? 
				and cp.id=c.customer_campaign_code  and c.location_id in (select l.id from locations l where l.active =? ) 
				and (cp.created_by =? or cp.created_by in (?))",array(1,$barcode,1,$merchant_id,$ids));
				// change query for all child 
				
			}
			else
			{

				$Where_miles = "";	
				/*$Sql = "SELECT c.*,cp.redeem_rewards ,cp.no_of_shared,cp.transaction_fees , cp.referral_rewards  ,cp.max_no_sharing ,cp.block_point 
				FROM coupon_codes c, campaigns cp WHERE c.active =1 and c.coupon_code='".$barcode."'
				and cp.id=c.customer_campaign_code and ( c.location_id in (select l.id from locations l where l.active =1  ) 
				and cp.id in (select cl.campaign_id from 
				campaign_location cl , merchant_user_role mur where mur.merchant_user_id = ".$merchant_id." 
				and cl.location_id = mur.location_access ) ".$Where_miles." )";*/
			
				$RS = $objDB->Conn->Execute("SELECT c.*,cp.redeem_rewards ,cp.no_of_shared,cp.transaction_fees , cp.referral_rewards  ,cp.max_no_sharing ,cp.block_point 
				FROM coupon_codes c, campaigns cp WHERE c.active =? and c.coupon_code=?
				and cp.id=c.customer_campaign_code and ( c.location_id in (select l.id from locations l where l.active =?  ) 
				and cp.id in (select cl.campaign_id from 
				campaign_location cl , merchant_user_role mur where mur.merchant_user_id = ? 
				and cl.location_id = mur.location_access ) ".$Where_miles." )",array(1,$barcode,1,$merchant_id));

			}
			
			//$RS = $objDB->Conn->Execute($Sql);
			if($RS->RecordCount()<=0)
			{
				$json_array['status'] = "false";
				$json_array['message'] = "This coupon is not for this store";
				$json = json_encode($json_array);
                                $objDB->Conn->CompleteTrans(); 
				echo $json;
				return $json;
				
			}
			else
			{
			
                            $redeem_deal_value = 0;
                            if(($RS->fields['deal_value'] - $RS->fields['saving']) > $_REQUEST['txt_redeem_deal_value'] )
                            {
                               $redeem_deal_value = $RS->fields['deal_value'] - $RS->fields['saving'];
                            }
                            else
                            {
                                $redeem_deal_value = $_REQUEST['txt_redeem_deal_value'];
                            }
				
				//			$dt_wh = " CONVERT_TZ(NOW(),'+00:00','+00:00') BETWEEN CONVERT_TZ(start_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) AND CONVERT_TZ(expiration_date,'+00:00',SUBSTR(timezone,1, POSITION(',' IN timezone)-1)) ";
				//			$date_f = date("Y-m-d H:i:s");
				//			$Sql = "SELECT COUNT(*) as total FROM campaigns WHERE ".$dt_wh." AND visible='1' AND id =".$RS->fields['customer_campaign_code'];
				//$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN  c.start_date AND c.expiration_date"; 
				$date_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(l.timezone,1, POSITION(',' IN l.timezone)-1)) BETWEEN  c.start_date AND c.expiration_date  and cl.active_in_future<>1"; 
				//  $dt_wh = "AND CONVERT_TZ(NOW(),'".CURR_TIMEZONE."',SUBSTR(c.timezone,1, POSITION(',' IN c.timezone)-1)) BETWEEN b.start_date AND b.expiration_date and a.active =1 and a.active_in_future<>1";
				$date_f = date("Y-m-d H:i:s");
				/*$Sql = "SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible='1' AND c.id =".$RS->fields['customer_campaign_code']." and l.id =".$RS->fields['location_id'];

				$RS_t = $objDB->Conn->Execute($Sql);*/
				$RS_t = $objDB->Conn->Execute("SELECT COUNT(*) as total FROM campaigns c , locations l, campaign_location cl WHERE cl.location_id= l.id AND c.id =cl.campaign_id  ".$date_wh ." AND visible=? AND c.id =? and l.id =?",array(1,$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

				if($RS_t->fields['total'] == 0)
				{

				}
				else
				{
						/*$Sql = "SELECT number_of_use FROM campaigns WHERE id =".$RS->fields['customer_campaign_code'];
						$RS_camp_detail = $objDB->Conn->Execute($Sql);*/
						$RS_camp_detail = $objDB->Conn->Execute("SELECT number_of_use FROM campaigns WHERE id =?",array($RS->fields['customer_campaign_code']));

						$flag = true;
						if($RS_camp_detail->fields['number_of_use'] == 1)
						{
							//$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and  customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code'] ." and location_id=".$RS->fields['location_id'];
												/*$Sql =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";*/
							$RS_user_exist = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=?)",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));
							
						}
						else if($RS_camp_detail->fields['number_of_use'] == 2)
						{
											  
							//$Sql = "SELECT * FROM reward_user WHERE referred_customer_id = 0 and  customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code'] ." and  DATE_FORMAT(reward_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  and location_id=".$RS->fields['location_id'];
											 /*$Sql = "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  =  '".date('Y-m-d')."'  ";*/
						$RS_user_exist = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )  and  DATE_FORMAT(redeem_date, '%Y-%m-%d')  = ?  ",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id'],date('Y-m-d')));
							
						}
						else if($RS_camp_detail->fields['number_of_use'] == 3)
						{
							$flag = false;
						}
										/*$SQl_coupon_id = "select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." ";
									 
										$Rs_coupon_id =  $objDB->Conn->Execute($SQl_coupon_id);*/
						$Rs_coupon_id =  $objDB->Conn->Execute("select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

										$generated_coupon_id = $Rs_coupon_id->fields['id'];
									 
						if($flag){
											
											   /*$location_max_sql = "Select num_activation_code , offers_left, used_offers from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
														$location_max = $objDB->Conn->Execute($location_max_sql);*/
			$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left, used_offers from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));


														  $max_coupon = $location_max->fields['num_activation_code'];
														  $o_left = $location_max->fields['offers_left'];
														  $used_offer = $location_max->fields['used_offers'];
										//    }
														  $flag_redeem =1;
														//  $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
											/*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
										 
											$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
						$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

											if($RS_2_use->RecordCount() <=0){
												$flag_redeem =0;
										}
									   
											if($o_left>0 || $flag_redeem==0)
											{
										   
											  //  $Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
												 /* $Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
										  
											$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
							$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));
											if($RS_2_use->RecordCount() >0){
												$used= 1;
											}
							//$RS_user_exist = $objDB->Conn->Execute($Sql);
							if($RS_user_exist->RecordCount() == 0){
							
								$deduct_points = 0;
								//-- start for point deduction
								$array_where_user = array();
								$array_where_user['id'] =$merchant_id;
								$RS_User = $objDB->Show("merchant_user", $array_where_user);
								$m_parent = $RS_User->fields['merchant_parent'];
								if($RS_User->fields['merchant_parent'] == 0)
								{
									$merchant_id = $merchant_id;
								}
								else
								{
									$merchant_id = $RS_User->fields['merchant_parent'];
								}
								
								$array_where_user = array();
								$array_where_user['id'] = $merchant_id;
								$RS_User = $objDB->Show("merchant_user", $array_where_user);
								//-- End of point deduction
								
								$redeem_array = array();
								$redeem_array['customer_id'] = $RS->fields['customer_id'] ;
								$redeem_array['campaign_id'] = $RS->fields['customer_campaign_code'] ;
								if($RS->fields['block_point'] >= ($RS->fields['redeem_rewards'] - $RS->fields['transaction_fees']) )
								{
									$redeem_array['earned_reward'] = $RS->fields['redeem_rewards'] ;
																$giving_points = $RS->fields['redeem_rewards'];
									$deduct_points = $RS->fields['block_point'] - $RS->fields['redeem_rewards'] - $RS->fields['transaction_fees'];
								}else{
									$redeem_array['earned_reward'] = 0 ;
																$giving_points = 0;
									$deduct_points = $RS->fields['block_point'];
								}
		//					$Sql = "Update campaigns set block_point =".$deduct_points." where id=".$RS->fields['customer_campaign_code'];
		//						
		//						$objDB->Conn->Execute($Sql);
														if($flag_redeem == 0)
														{
														
														// insert here //
								$redeem_array['referral_reward'] = 0;
								$redeem_array['referred_customer_id'] = 0;
								$redeem_array['reward_date'] =  date("Y-m-d H:i:s");
													   $redeem_array['coupon_code_id'] =  $RS->fields['id'];
														$redeem_array['location_id'] =  $RS->fields['location_id'];
													$redeem_array['redeem_deal_value'] =  $redeem_deal_value;
								$objDBWrt->Insert($redeem_array, "reward_user");
														}
														else{
														// insert here //
															/*$sql_get_earned_reward = "select * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
															$rs_get_earned_reward =$objDB->Conn->Execute($sql_get_earned_reward);*/
				$rs_get_earned_reward =$objDB->Conn->Execute("select * FROM reward_user WHERE referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(0,$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

															$total_earned_reward = $rs_get_earned_reward->fields['earned_reward'];
															/*$up_sql ="Update reward_user set earned_reward =".($total_earned_reward + $giving_points)."  where referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
															$objDB->Conn->Execute($up_sql);       */
		$objDBWrt->Conn->Execute("Update reward_user set earned_reward =?  where referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(($total_earned_reward + $giving_points),0,$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));       

														}
												 
								$coupon_redeem_array = array();
								

															
														$coupon_redeem_array['coupon_id'] =  $RS->fields['id'];
														$coupon_redeem_array['redeem_date'] =  date("Y-m-d H:i:s");
														$coupon_redeem_array['redeem_value'] =  $redeem_deal_value;
														$coupon_redeem_array['redeem_merchant_id'] = $merchant_id;
                                                                                                                $coupon_redeem_array['transaction_fees'] = $RS->fields['transaction_fees'];
														$coupon_redeem_array['transaction_fees_price'] = ($RS->fields['transaction_fees'])* $B4;
														
                                                                                                                $objDBWrt->Insert($coupon_redeem_array, "coupon_redeem");

														
															// redeem trigger	
														
														$redeem_point=$redeem_array['earned_reward'];
														$arr_bus=file(WEB_PATH.'/process.php?getlocationbusinessname=yes&l_id='. $RS->fields['location_id']);
														if(trim($arr_bus[0]) == "")
															 {
																	 unset($arr_bus[0]);
																	 $arr_bus = array_values($arr_bus);
															 }
															 $json_bus = json_decode($arr_bus[0]);
														$business_name  = $json_bus->bus_name;
														
														$array_gcm = array();
														$array_gcm['id'] = $RS->fields['customer_id'];
														$RS_gcm = $objDB->Show("customer_user",$array_gcm);
														if($RS_gcm->fields['notification_setting']==1)
														{
															if($RS_gcm->fields['gcm_registration_id']!="")
															{
																$gcm_registration_id=$RS_gcm->fields['gcm_registration_id'];
		
																$device_id = $gcm_registration_id;
																$arr=file(WEB_PATH.'/merchant/process.php?send_gcm_message=yes&customer_id='.$RS->fields['customer_id'].'&device_id='.$device_id.'&redeem_point='.$redeem_point.'&business_name='.urlencode($business_name).'&notificationtype=point_for_visit');
															}
															if($RS_gcm->fields['device_id']!="")
															{
																$device_id=$RS_gcm->fields['device_id'];
	
																$arr=file(WEB_PATH.'/merchant/process.php?send_push_message=yes&customer_id='.$RS->fields['customer_id'].'&device_id='.$device_id.'&redeem_point='.$redeem_point.'&business_name='.urlencode($business_name).'&notificationtype=point_for_visit');
															}
														}
													
														// redeem trigger				  
													 
														 /* for make entry in subscribed store table */
														/*$Sql_r_c = "Select * from coupon_redeem where coupon_id =".$generated_coupon_id ;
													  
														$RS_r_c =  $objDB->Conn->Execute($Sql_r_c);*/
			$RS_r_c =  $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id =?",array($generated_coupon_id));

														if($RS_r_c->RecordCount() == 1)
														{
														   /*$sql_chk ="select * from subscribed_stores where customer_id= ".$RS->fields['customer_id'] ." and location_id=". $RS->fields['location_id'];
															$subscibed_store_rs =$objDB->Conn->Execute($sql_chk);*/

		$subscibed_store_rs =$objDB->Conn->Execute("select * from subscribed_stores where customer_id=? and location_id=?",array($RS->fields['customer_id'],$RS->fields['location_id']));
														  if($subscibed_store_rs->RecordCount()!=0 && $subscibed_store_rs->fields['first_redeemed_date']=="0000-00-00 00:00:00")
														  {
															   /*$up_subscribed_store = "Update subscribed_stores set first_redeemed_date='".date("Y-m-d H:i:s")."'  where  customer_id= ".$RS->fields['customer_id']." and location_id=".$RS->fields['location_id'];
																   $objDB->Conn->Execute($up_subscribed_store);*/
		$objDBWrt->Conn->Execute("Update subscribed_stores set first_redeemed_date=?  where  customer_id= ? and location_id=?",array(date("Y-m-d H:i:s"),$RS->fields['customer_id'],$RS->fields['location_id']));
														  }
														}
														/* for make entry in subscribed store table*/
														if($used==1)
														{
															/*$of_up=  "Update campaign_location set offers_left=".($o_left-1)." , used_offers=".($used_offer+1)."  where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
														   
														   $objDB->Conn->Execute($of_up);*/
		$objDBWrt->Conn->Execute("Update campaign_location set offers_left=? , used_offers=?  where  campaign_id=? and location_id=?",array(($o_left-1),($used_offer+1),$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

														}
								
								/* Don't give point if max nof sharing rich */
								
								 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
								
									 $RS_shared = $objDB->Conn->Execute($Sql_shared);*/
									$RS_shared = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>? and referral_reward<>?",array($RS->fields['customer_campaign_code'],0,0));
						
                                                                        $shared_counter = $RS->fields['no_of_shared'];
                                                                        
									 if($RS->fields['no_of_shared'] <  $RS->fields['max_no_sharing'] ){
									
                                                                         // set actually shared campaign 
									/* $sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id = ".$RS->fields['customer_campaign_code']."   AND location_id=".$RS->fields['location_id'];
									
									 $RS_referral_customer = $objDB->Conn->Execute($sql);*/
								$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id = ?   AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

									 $where = array();
									$where['referred_customer_id'] = $RS->fields['customer_id'];
									$where['campaign_id'] = $RS->fields['customer_campaign_code'];
									$where['referral_reward'] = 0;
									 $where['location_id'] = $RS->fields['location_id'];
									$u_array = array();
									
									 if($RS_referral_customer->RecordCount() != 0)
									 {
										if($RS_referral_customer->fields['referral_reward'] == 0 )
										{
										if($deduct_points >= $RS->fields['referral_rewards'] )
										{
											$u_array['referral_reward'] = $RS->fields['referral_rewards'];
											$u_array['reward_date'] =   date("Y-m-d H:i:s");
											$deduct_points = $deduct_points - $RS->fields['referral_rewards'];
											$shared_counter++;
										}else{
											$u_array['referral_reward']  = 0 ;
											$u_array['reward_date'] =   date("Y-m-d H:i:s");
											$deduct_points = $RS->fields['block_point'];
										}
										
										$objDBWrt->Update($u_array, "reward_user", $where);
										}
									 }
										 /*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']."  AND referral_reward = 0 AND location_id=".$RS->fields['location_id'];
										
									$RS_referral_customer = $objDB->Conn->Execute($Sql);*/

								$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=?  AND referral_reward = ? AND location_id=?",array($RS->fields['customer_id'],0,$RS->fields['location_id']));

																				
												if($RS_referral_customer->RecordCount() != 0)
												{
												        while($row_referral_customer = $RS_referral_customer->FetchRow() )
													{
													/*$sql = "Select * from reward_user where customer_id =".$row_referral_customer['referred_customer_id']." and location_id =".$row_referral_customer['location_id'] ." and campaign_id = ". $row_referral_customer['campaign_id'];
												
														$RS_coupon_redeem = $objDB->Conn->Execute($sql);*/
				$RS_coupon_redeem = $objDB->Conn->Execute("Select * from reward_user where customer_id =? and location_id =? and campaign_id = ?",array($row_referral_customer['referred_customer_id'],$row_referral_customer['location_id'],$row_referral_customer['campaign_id']));
														if($RS_coupon_redeem->RecordCount() != 0)
														{
														$where = array();
															$where['referred_customer_id'] = $RS->fields['customer_id'];
														$where['campaign_id'] =  $row_referral_customer['campaign_id'];
														$where['referral_reward'] = 0;
														 $where['location_id'] = $RS->fields['location_id'];
														$u_array = array();
												
														if($shared_counter <    $RS->fields['max_no_sharing'])	
														{
															if($deduct_points >= $RS->fields['referral_rewards'] )
															{
																$u_array['referral_reward'] = $RS->fields['referral_rewards'];
																$u_array['reward_date'] =   date("Y-m-d H:i:s");
																$deduct_points = $deduct_points - $RS->fields['referral_rewards'];
																$u_array['campaign_id'] = $RS->fields['customer_campaign_code'];
																$shared_counter++;
															}else{
																$u_array['referral_reward']  = 0 ;
																$u_array['reward_date'] =   date("Y-m-d H:i:s");
																$deduct_points = $RS->fields['block_point'];
															}
														
														$objDBWrt->Update($u_array, "reward_user", $where);
														}
													
													}
													
													}
												}
									 }
                                                                         //update sharing counter 
									 /*$sql = "update campaigns set no_of_shared=".$shared_counter." where id=". $RS->fields['customer_campaign_code'];
									
									 $objDB->Conn->Execute($sql);*/
				$objDBWrt->Conn->Execute("update campaigns set no_of_shared=? where id=?",array($shared_counter,$RS->fields['customer_campaign_code']));
																 
																 // if sharing point not available then send message
																 /*$Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 ";
																  $RS_shared_ = $objDB->Conn->Execute($Sql_shared);*/
		$RS_shared_ = $objDB->Conn->Execute("SELECT * from reward_user WHERE campaign_id=? and referred_customer_id<>?",array($RS->fields['customer_campaign_code'],0));
																	 if($RS_shared_->RecordCount() >  $RS->fields['max_no_sharing'] ){
																		 //$sql_get_merchant = "";
																	 }
																 // 
								/* Don't give point if max nof sharing rich  */
								
								//-- start for point deduction
								
								
								
								/*$Sql = "Update campaigns set block_point =".$deduct_points." where id=".$RS->fields['customer_campaign_code'];
								
								$objDB->Conn->Execute($Sql);*/
								$objDBWrt->Conn->Execute("Update campaigns set block_point =? where id=?",array($deduct_points,$RS->fields['customer_campaign_code']));
								
								//-- End of point deduction	
								
								// review insert here //
								/*$sql = "update reward_user set review_rating_visibility = 1 where customer_id=".$RS->fields['customer_id']." and location_id= ".$RS->fields['location_id']." and campaign_id=".$RS->fields['customer_campaign_code'];
									$rs = $objDB->Conn->Execute($sql);*/
								$rs = $objDBWrt->Conn->Execute("update reward_user set review_rating_visibility = ? where customer_id=? and location_id=? and campaign_id=?",array(1,$RS->fields['customer_id'],$RS->fields['location_id'],$RS->fields['customer_campaign_code']));

								$json_array['status'] = "true";
								$json_array['id'] = $RS->fields['customer_campaign_code'];
								$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_coupon_redeemed"];
								$_SESSION['msg'] = $merchant_msg["redeem-deal"]["Msg_coupon_redeemed"];						
								$json = json_encode($json_array);
                                                                //finish transaction - This will rollback the transcation if any error occure
							$objDB->Conn->CompleteTrans();
								echo $json;
								return $json;
							}
											}
						}
						else{
							  /*$location_max_sql = "Select num_activation_code , offers_left , used_offers from campaign_location where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
														$location_max = $objDB->Conn->Execute($location_max_sql);*/
					$location_max = $objDB->Conn->Execute("Select num_activation_code , offers_left , used_offers from campaign_location where  campaign_id=? and location_id=?",array($RS->fields['customer_campaign_code'],$RS->fields['location_id']));

														  $max_coupon = $location_max->fields['num_activation_code'];
														  $o_left = $location_max->fields['offers_left'];
										  $used_offer = $location_max->fields['used_offers'];
										//    }
											$flag_redeem =1;
										   //$Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
											/*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
											$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
										$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=?)",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

											if($RS_2_use->RecordCount() <=0){
												$flag_redeem =0;
										}
											if($o_left>0 || $flag_redeem==0)
											{
												//$Sql_2_use =  "SELECT * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
												/*$Sql_2_use =  "Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=".$RS->fields['customer_id']." and customer_campaign_code=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id']." )";
											$RS_2_use = $objDB->Conn->Execute($Sql_2_use);*/
								$RS_2_use = $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id = (select id from coupon_codes where customer_id=? and customer_campaign_code=? and location_id=? )",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

											if($RS_2_use->RecordCount() >0){
												$used= 1;
											}
							$deduct_points = 0;
							
							//-- start for point deduction
								$array_where_user = array();
								$array_where_user['id'] = $merchant_id;
								$RS_User = $objDB->Show("merchant_user", $array_where_user);
								$m_parent = $RS_User->fields['merchant_parent'];
								if($RS_User->fields['merchant_parent'] == 0)
								{
									$merchant_id = $merchant_id;
								}
								else
								{
									$merchant_id = $RS_User->fields['merchant_parent'];
								}
								
								$array_where_user = array();
								$array_where_user['id'] = $merchant_id;
								$RS_User = $objDB->Show("merchant_user", $array_where_user);
								//-- End of point deduction
								
							$redeem_array = array();
								$redeem_array['customer_id'] = $RS->fields['customer_id'] ;
								$redeem_array['campaign_id'] = $RS->fields['customer_campaign_code'] ;
								
								if($RS->fields['block_point'] >= $RS->fields['redeem_rewards'] )
								{
									$redeem_array['earned_reward'] = $RS->fields['redeem_rewards'] ;
									$deduct_points =  $RS->fields['block_point'] - $RS->fields['redeem_rewards'];
																$giving_points = $RS->fields['redeem_rewards'] ;
								}else{
									$redeem_array['earned_reward'] = 0 ;
									$deduct_points = $RS->fields['block_point'];
																$giving_points = 0;
								}
														if($flag_redeem == 0)
														{
															$redeem_array['referral_reward'] = 0;
															$redeem_array['referred_customer_id'] = 0;
															$redeem_array['reward_date'] =  date("Y-m-d H:i:s");
															$redeem_array['coupon_code_id'] =  $RS->fields['id'];
															$redeem_array['location_id'] =  $RS->fields['location_id'];
															$redeem_array['redeem_deal_value'] =  $redeem_deal_value;
															$objDBWrt->Insert($redeem_array, "reward_user");
														}
														 else{
															$sql_get_earned_reward = "select * FROM reward_user WHERE referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
															$rs_get_earned_reward =$objDB->Conn->Execute($sql_get_earned_reward);
															$total_earned_reward = $rs_get_earned_reward->fields['earned_reward'];
															/*$up_sql ="Update reward_user set earned_reward =".($total_earned_reward + $giving_points)."  where referred_customer_id = 0 and customer_id=".$RS->fields['customer_id']." and campaign_id =".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
															$objDB->Conn->Execute($up_sql);       */

		$objDBWrt->Conn->Execute("Update reward_user set earned_reward =?  where referred_customer_id = ? and customer_id=? and campaign_id =? and location_id=?",array(($total_earned_reward + $giving_points),0,$RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));  

														}
														   
								$coupon_redeem_array = array();

															
														$coupon_redeem_array['coupon_id'] =  $RS->fields['id'];
														$coupon_redeem_array['redeem_date'] =  date("Y-m-d H:i:s");
														$coupon_redeem_array['redeem_value'] =  $_REQUEST['txt_redeem_deal_value'];
															$coupon_redeem_array['redeem_merchant_id'] = $merchant_id;
																										$coupon_redeem_array['transaction_fees'] = $RS->fields['transaction_fees'];
															$coupon_redeem_array['transaction_fees_price'] = ($RS->fields['transaction_fees'])* $B4;
								$objDBWrt->Insert($coupon_redeem_array, "coupon_redeem");
														
														// redeem trigger	
														
														$redeem_point=$redeem_array['earned_reward'];
														$arr_bus=file(WEB_PATH.'/process.php?getlocationbusinessname=yes&l_id='. $RS->fields['location_id']);
														if(trim($arr_bus[0]) == "")
															 {
																	 unset($arr_bus[0]);
																	 $arr_bus = array_values($arr_bus);
															 }
															 $json_bus = json_decode($arr_bus[0]);
														$business_name  = $json_bus->bus_name;
														
														$array_gcm = array();
														$array_gcm['id'] = $RS->fields['customer_id'];
														$RS_gcm = $objDB->Show("customer_user",$array_gcm);
														if($RS_gcm->fields['notification_setting']==1)
														{
															if($RS_gcm->fields['gcm_registration_id']!="")
															{
																$gcm_registration_id=$RS_gcm->fields['gcm_registration_id'];
		
																$device_id = $gcm_registration_id;
																$arr=file(WEB_PATH.'/merchant/process.php?send_gcm_message=yes&customer_id='.$RS->fields['customer_id'].'&device_id='.$device_id.'&redeem_point='.$redeem_point.'&business_name='.urlencode($business_name).'&notificationtype=point_for_visit');
															}
															if($RS_gcm->fields['device_id']!="")
															{
																$device_id=$RS_gcm->fields['device_id'];
	
																$arr=file(WEB_PATH.'/merchant/process.php?send_push_message=yes&customer_id='.$RS->fields['customer_id'].'&device_id='.$device_id.'&redeem_point='.$redeem_point.'&business_name='.urlencode($business_name).'&notificationtype=point_for_visit');
															}
														}
													
														// redeem trigger
														
														  /* for make entry in subscribed store table */
													  //  $Sql_r_c = "Select * from reward_user where location_id=".$RS->fields['location_id']." and customer_id=".$RS->fields['customer_id'];
														 /*$Sql_r_c = "Select * from coupon_redeem where coupon_id =".$generated_coupon_id ;
														$RS_r_c =  $objDB->Conn->Execute($Sql_r_c);*/
		$RS_r_c =  $objDB->Conn->Execute("Select * from coupon_redeem where coupon_id =?",array($generated_coupon_id));
														if($RS_r_c->RecordCount() == 1)
														{
														  /* $sql_chk ="select * from subscribed_stores where customer_id= ".$RS->fields['customer_id'] ." and location_id=". $RS->fields['location_id'];
															$subscibed_store_rs =$objDB->Conn->Execute($sql_chk);*/

	$subscibed_store_rs =$objDB->Conn->Execute("select * from subscribed_stores where customer_id= ? and location_id=?",array($RS->fields['customer_id'],$RS->fields['location_id']));

														  if($subscibed_store_rs->RecordCount()!=0)
														  {
															   /*$up_subscribed_store = "Update subscribed_stores set first_redeemed_date='".date("Y-m-d H:i:s")."'  where  customer_id= ".$RS->fields['customer_id']." and location_id=".$RS->fields['location_id'];
																   $objDB->Conn->Execute($up_subscribed_store);*/
		$objDBWrt->Conn->Execute("Update subscribed_stores set first_redeemed_date=?  where  customer_id=? and location_id=?",array(date("Y-m-d H:i:s"),$RS->fields['customer_id'],$RS->fields['location_id']));

														  }
														}
														/* for make entry in subscribed store table*/
														if($used==1)
														{
															/*$of_up=  "Update campaign_location set offers_left=".($o_left-1)." , used_offers=".($used_offer+1)."  where  campaign_id=".$RS->fields['customer_campaign_code']." and location_id=".$RS->fields['location_id'];
														   $objDB->Conn->Execute($of_up);*/
		$objDBWrt->Conn->Execute("Update campaign_location set offers_left=? , used_offers=?  where  campaign_id=? and location_id=?",array(($o_left-1),($used_offer+1),$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

														}
							
									/* Don't give point if max nof sharing rich */
								
	/* Don't give point if max nof sharing rich */
								
								 $Sql_shared = "SELECT * from reward_user WHERE campaign_id=".$RS->fields['customer_campaign_code']." and referred_customer_id<>0 and referral_reward<>0";
									 //$RS_shared = $objDB->Conn->Execute($Sql_shared);
									 
									$shared_counter = $RS->fields['no_of_shared'];
									//echo $shared_counter."==share counter";
									 if($shared_counter <  $RS->fields['max_no_sharing'] ){
									 
									 // set actually shared campaign 
									 /*$sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']." and campaign_id = ".$RS->fields['customer_campaign_code']."  AND location_id=".$RS->fields['location_id'];
									 
									 $RS_referral_customer = $objDB->Conn->Execute($sql);*/
									$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=? and campaign_id = ?  AND location_id=?",array($RS->fields['customer_id'],$RS->fields['customer_campaign_code'],$RS->fields['location_id']));

									 $where = array();
														$where['referred_customer_id'] = $RS->fields['customer_id'];
														$where['campaign_id'] = $RS->fields['customer_campaign_code'];
														$where['referral_reward'] = 0;
														 $where['location_id'] = $RS->fields['location_id'];
														$u_array = array();
														
									 if($RS_referral_customer->RecordCount() != 0)
									 {
										if($RS_referral_customer->fields['referral_reward'] == 0)
										{
										if($deduct_points >= $RS->fields['referral_rewards'] )
										{
											$u_array['referral_reward'] = $RS->fields['referral_rewards'];
											$u_array['reward_date'] =   date("Y-m-d H:i:s");
											$deduct_points = $deduct_points - $RS->fields['referral_rewards'];
											$u_array['campaign_id'] = $RS->fields['customer_campaign_code'];
											$shared_counter++;
										}else{
											$u_array['referral_reward']  = 0 ;
											$u_array['reward_date'] =   date("Y-m-d H:i:s");
											$deduct_points = $RS->fields['block_point'];
										}
										
										$objDBWrt->Update($u_array, "reward_user", $where);
										}
									 }
										 /*$Sql = "SELECT * FROM reward_user WHERE referred_customer_id=".$RS->fields['customer_id']."  AND referral_reward = 0 AND location_id=".$RS->fields['location_id'];
									
												$RS_referral_customer = $objDB->Conn->Execute($Sql);*/
$RS_referral_customer = $objDB->Conn->Execute("SELECT * FROM reward_user WHERE referred_customer_id=?  AND referral_reward = ? AND location_id=?",array($RS->fields['customer_id'],0,$RS->fields['location_id']));

												if($RS_referral_customer->RecordCount() != 0)
												{
													
													while($row_referral_customer = $RS_referral_customer->FetchRow() )
													{
													/*$sql = "Select * from reward_user where customer_id =".$row_referral_customer['referred_customer_id']." and location_id =".$row_referral_customer['location_id'] ." and campaign_id = ".$row_referral_customer['campaign_id'];
													
														$RS_coupon_redeem = $objDB->Conn->Execute($sql);*/
					$RS_coupon_redeem = $objDB->Conn->Execute("Select * from reward_user where customer_id =? and location_id =? and campaign_id =?",array($row_referral_customer['referred_customer_id'],$row_referral_customer['location_id'] ,$row_referral_customer['campaign_id']));
														if($RS_coupon_redeem->RecordCount() != 0)
														{
														$where = array();
														$where['referred_customer_id'] = $RS->fields['customer_id'];
														$where['campaign_id'] = $row_referral_customer['campaign_id'];
														$where['referral_reward'] = 0;
														$where['location_id'] = $RS->fields['location_id'];
														$u_array = array();
													
									 
														if($shared_counter <    $RS->fields['max_no_sharing'])	
														{
															if($deduct_points >= $RS->fields['referral_rewards'] )
															{
																$u_array['referral_reward'] = $RS->fields['referral_rewards'];
																$u_array['reward_date'] =   date("Y-m-d H:i:s");
																$deduct_points = $deduct_points - $RS->fields['referral_rewards'];
																$shared_counter++;
															}else{
																$u_array['referral_reward']  = 0 ;
																$u_array['reward_date'] =   date("Y-m-d H:i:s");
																$deduct_points = $RS->fields['block_point'];
															}
															
														$objDBWrt->Update($u_array, "reward_user", $where);
														}
													
													}
													
													}
												}
									 }
									 
									 //update sharing counter 
									 /*$sql = "update campaigns set no_of_shared=".$shared_counter." where id=". $RS->fields['customer_campaign_code'];
									
									 $objDB->Conn->Execute($sql);*/
									$objDBWrt->Conn->Execute("update campaigns set no_of_shared=? where id=?",array($shared_counter,$RS->fields['customer_campaign_code']));
									 /***ich */
								

								
								//-- start for point deduction
								
								
								
								/*$Sql = "Update campaigns set block_point =".$deduct_points." where id=".$RS->fields['customer_campaign_code'];
								
								$objDB->Conn->Execute($Sql);*/
							$objDBWrt->Conn->Execute("Update campaigns set block_point =? where id=?",array($deduct_points,$RS->fields['customer_campaign_code']));
								
								//-- End of point deduction	
									// review insert here //
								/*$sql = "update reward_user set review_rating_visibility = 1 where customer_id=".$RS->fields['customer_id']." and location_id= ".$RS->fields['location_id']." and campaign_id=".$RS->fields['customer_campaign_code'];
									$rs = $objDB->Conn->Execute($sql);*/
								$rs = $objDBWrt->Conn->Execute("update reward_user set review_rating_visibility = ? where customer_id=? and location_id= ? and campaign_id=?",array(1,$RS->fields['customer_id'],$RS->fields['location_id'],$RS->fields['customer_campaign_code']));

								$json_array['status'] = "true";
								$json_array['id'] = $RS->fields['customer_campaign_code'];
								$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_coupon_redeemed"];
                                                                $_SESSION['msg'] = $merchant_msg["redeem-deal"]["Msg_coupon_redeemed"];
								$json = json_encode($json_array);
                                                                $objDB->Conn->CompleteTrans(); 
								echo $json;
								return $json;
						}
										else
										{
										// review insert here //
									/*$sql = "update reward_user set review_rating_visibility = 1 where customer_id=".$RS->fields['customer_id']." and location_id= ".$RS->fields['location_id']." and campaign_id=".$RS->fields['customer_campaign_code'];
									$rs = $objDB->Conn->Execute($sql);*/

							$rs = $objDBWrt->Conn->Execute("update reward_user set review_rating_visibility = ? where customer_id=? and location_id=? and campaign_id=?",array(1,$RS->fields['customer_id'],$RS->fields['location_id'],$RS->fields['customer_campaign_code']));

											//$rs = $objDB->Conn->Execute($sql);
											$json_array['status'] = "true";
								$json_array['id'] = $RS->fields['customer_campaign_code'];
								$json_array['message'] =$merchant_msg["redeem-deal"]["Msg_campaign_ended"];
								$_SESSION['msg'] = $merchant_msg["redeem-deal"]["Msg_campaign_ended"];
								$json = json_encode($json_array);
                                                                $objDB->Conn->CompleteTrans(); 	
								echo $json;
								return $json;
										}
									   }
						
				}
			}
		
		}
		else
		{
            $json_array['status'] = "false";
            $json_array['message'] = $merchant_msg["redeem-deal"]["Msg_coupon_code_not_exist"];
            $json = json_encode($json_array);
            $objDB->Conn->CompleteTrans(); 
            echo $json;
            return $json;
		}
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['message'] = $merchant_msg["redeem-deal"]["Msg_enter_proper_coupon_code"];
		$json = json_encode($json_array);
        $objDB->Conn->CompleteTrans(); 
		echo $json;
		return $json;
	}
	
	$json_array = array();	
	$json_array['status'] = "true";
	$json_array['couponcode'] = $barcode ;
	$json_array['deal_value'] = $deal_value ;
	$json_array['discount'] = $discount ;
	$json_array['saving'] = $saving ;
	$json = json_encode($json_array);
	echo $json;
	exit();

}

/******** 
@USE : show more media
@PARAMETER : next_index,num_of_records
@RETURN : json data
@USED IN PAGES : add-compaign.php,edit-compaign.php,copy-compaign.php,add-location.php,edit-location.php,add-template.php,edit-template.php,customize-template.php,media-management.php
*********/
if(isset($_REQUEST['show_more_media']))
{
	$start_index = $_REQUEST['next_index'];
	$num_of_records = $_REQUEST['num_of_records'];
	$next_index = $start_index + $num_of_records;
	
	$arr_ids1=getallmainmercahnt_id($_SESSION['merchant_id']);
	$ids1=  implode(",", $arr_ids1);

	if($ids1 == "")
	{
		$ids1 =$_SESSION['merchant_id'];
	}
	
	$arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
	$ids=  implode(",", $arr_ids);
	if($ids=="")
		$ids=$_SESSION['merchant_id'];  

	//9-10-2013 Display all images syblic  
	$main_merchant_id = getmainmercahnt_id($_SESSION['merchant_id']);

	$arr_ids_string=getallsubmercahnt_id($main_merchant_id);
	
	$sub_merchant=  implode(",", $arr_ids_string);
	if($sub_merchant=="")
	{
		$sub_merchant=$_SESSION['merchant_id'];
	}    
	
	$merchant_array = array();
	$merchant_array['id'] = $_SESSION['merchant_id'];
	$merchant_info = $objDB->Show("merchant_user",$merchant_array);

	if(isset($_REQUEST['imagetype']))
    {
		if($_REQUEST['imagetype']!='all')
		{

		$RS = $objDB->Conn->Execute("select * from merchant_media where media_type_id=? and (merchant_id in (?) or merchant_id=? or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?)) order by id desc limit $start_index,$num_of_records",array($_REQUEST['imagetype'],$ids1,$merchant_info->fields['merchant_parent'],$sub_merchant,$_SESSION['merchant_id']));
		}
		else
		{
		$RS = $objDB->Conn->Execute("select * from merchant_media where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc limit $start_index,$num_of_records",array($_SESSION['merchant_id'],$ids1,$sub_merchant,$_SESSION['merchant_id']));

		}
	}
    else 
	{
		$RS = $objDB->Conn->Execute("select * from merchant_media where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc limit $start_index,$num_of_records",array($_SESSION['merchant_id'],$ids1,$sub_merchant,$_SESSION['merchant_id']));
		
	}                
   
	$flag_delete = true;
	$flag_view = true;
	$flag_upload = true;
	
	if($merchant_info->fields['merchant_parent'] != 0)
	{	
		$media_acc_array = array();
		$media_acc_array['merchant_user_id'] = $_SESSION['merchant_id'];
		$RSmedia = $objDB->Show("merchant_user_role",$media_acc_array);
		$media_val = unserialize($RSmedia->fields['media_access']);
		if(in_array("delete",$media_val))
		{
			$flag_delete = true;
		}
		else
		{
			$flag_delete = false;	
		}
		if(in_array("view-use",$media_val))
		{
			$flag_view = true;
		}
		else
		{
			$flag_view = false;	
		}
		if(in_array("upload",$media_val))
		{
			$flag_upload = true;
		}
		else
		{
			$flag_upload = false;	
		}
	}
	else
	{
		$flag_delete = true;
		$flag_view = true;
		$flag_upload = true;
	}
	
	
	$json_array = array();	
	$html="";
	
	if($RS->RecordCount()>0)
	{
		while($Row = $RS->FetchRow())
		{
			if($Row['media_type_id'] == "1")
			{
				$target = "campaign" ;
			}
			if($Row['media_type_id'] == "2")
			{
				$target = "location";
			}
			if($Row['media_type_id'] == "3")
			{
				$target = "giftcard";
			}
			if($Row['media_type_id'] == "1")
			{
				$html.='
			<div class="mediya_img_blk campaignfilter">';
			} 
			if($Row['media_type_id'] == "2")
			{
				$html.='
			<div class="mediya_img_blk locationfilter">';
			}
			if($Row['media_type_id'] == "3")
			{
				$html.='
			<div class="mediya_img_blk giftcardfilter">';
			}
			$html.='
				<a href="javascript:void(0)" class="mediya_camp_loca">';
				
					if($Row['media_type_id'] == "1")
					{
						$html.='<img title="Campaign" src="'.ASSETS_IMG.'/m/mediya_campaign.png">';
					}
					if($Row['media_type_id'] == "2")
					{
						$html.='<img title="Location" src="'.ASSETS_IMG.'/m/mediya_location.png">';
					}
					if($Row['media_type_id'] == "3")
					{
						$html.='<img title="Giftcard" src="'.ASSETS_IMG.'/m/mediya_location.png">';
					}
					
				$html.='</a>
				<img src="'.ASSETS_IMG.'/m/'.$target.'/'.$Row['image'].'" class="mediya_grid"/>';
		
			if($flag_delete)
			{
				if($Row['merchant_id']==1)
				{
					$html.='<a href="javascript:void(0)" admin_image="1" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediadeleteid_'.$Row['id'].'" class="mediya_delete">
							<img src="'.ASSETS_IMG.'/m/mediya_delete.png">
						</a>';
				}
				else
				{
					if(in_array($Row['merchant_id'], $arr_ids1))
					{ 
					?>
					
					<?php  
					}
					else if(!in_array($Row['merchant_id'], $arr_ids1) && !in_array($Row['merchant_id'], $arr_ids_string) && $Row['merchant_id']!=$_SESSION['merchant_id'])
					{
					?>
						
					<?php
					}
					else
					{
						
						$html.='<a href="javascript:void(0)" admin_image="0" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediadeleteid_'.$Row['id'].'" class="mediya_delete">
							<img src="'.ASSETS_IMG.'/m/mediya_delete.png">
						</a>';		
						
					}
				} 
			}
			$html.='</div>';
		}
	}
	
	$json_array['status'] = "true";
	$json_array['html'] = $html ;
	$json_array['records_return'] = $RS->RecordCount();
	
	$json = json_encode($json_array);
	echo $json;
	exit();		
}


/******** 
@USE : show more video
@PARAMETER : next_index,num_of_records
@RETURN : json data
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['show_more_video']))
{
	$start_index = $_REQUEST['next_index'];
	$num_of_records = $_REQUEST['num_of_records'];
	$next_index = $start_index + $num_of_records;
	
	$arr_ids1=getallmainmercahnt_id($_SESSION['merchant_id']);
	$ids1=  implode(",", $arr_ids1);

	if($ids1 == "")
	{
		$ids1 =$_SESSION['merchant_id'];
	}
	
	$arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
	$ids=  implode(",", $arr_ids);
	if($ids=="")
		$ids=$_SESSION['merchant_id'];  

	//9-10-2013 Display all images syblic  
	$main_merchant_id = getmainmercahnt_id($_SESSION['merchant_id']);

	$arr_ids_string=getallsubmercahnt_id($main_merchant_id);
	
	$sub_merchant=  implode(",", $arr_ids_string);
	if($sub_merchant=="")
	{
		$sub_merchant=$_SESSION['merchant_id'];
	}    
	
	$merchant_array = array();
	$merchant_array['id'] = $_SESSION['merchant_id'];
	$merchant_info = $objDB->Show("merchant_user",$merchant_array);

	if(isset($_REQUEST['imagetype']))
    {
		if($_REQUEST['imagetype']!='all')
		{

		$RS = $objDB->Conn->Execute("select * from merchant_media where media_type_id=? and (merchant_id in (?) or merchant_id=? or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?)) order by id desc limit $start_index,$num_of_records",array($_REQUEST['imagetype'],$ids1,$merchant_info->fields['merchant_parent'],$sub_merchant,$_SESSION['merchant_id']));
		}
		else
		{
		$RS = $objDB->Conn->Execute("select * from merchant_media where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc limit $start_index,$num_of_records",array($_SESSION['merchant_id'],$ids1,$sub_merchant,$_SESSION['merchant_id']));

		}
	}
    else 
	{
		$RS = $objDB->Conn->Execute("select * from merchant_videos where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc limit $start_index,$num_of_records",array($_SESSION['merchant_id'],$ids1,$sub_merchant,$_SESSION['merchant_id']));
		
	}                
   
	$flag_delete = true;
	$flag_view = true;
	$flag_upload = true;
	
	if($merchant_info->fields['merchant_parent'] != 0)
	{	
		$media_acc_array = array();
		$media_acc_array['merchant_user_id'] = $_SESSION['merchant_id'];
		$RSmedia = $objDB->Show("merchant_user_role",$media_acc_array);
		$media_val = unserialize($RSmedia->fields['media_access']);
		if(in_array("delete",$media_val))
		{
			$flag_delete = true;
		}
		else
		{
			$flag_delete = false;	
		}
		if(in_array("view-use",$media_val))
		{
			$flag_view = true;
		}
		else
		{
			$flag_view = false;	
		}
		if(in_array("upload",$media_val))
		{
			$flag_upload = true;
		}
		else
		{
			$flag_upload = false;	
		}
	}
	else
	{
		$flag_delete = true;
		$flag_view = true;
		$flag_upload = true;
	}
	
	
	$json_array = array();	
	$html="";
	
	if($RS->RecordCount()>0)
	{
		while($Row = $RS->FetchRow())
		{
			
			if($Row['video_type'] == "youtube")
			{
				$html.='
			<div class="mediya_video_blk youtubefilter">';
			} 
			if($Row['video_type'] == "vimeo")
			{
				$html.='
			<div class="mediya_video_blk vimeofilter">';
			}
			
			
			$html.='<a href="'.$Row['video_link'].'" target="_new" >';
			$html.='<img src="'.$Row['thumbnail_url'].'" class="mediya_grid_video"/>';
			$html.='</a>';
			
			$html.='<a href="javascript:void(0)" image_type="'.$Row['video_type'].'" id="videodeleteid_'.$Row['id'].'" class="mediya_delete">
				<img src="'.ASSETS_IMG.'/m/mediya_delete.png">
			</a>';
						
			$html.='</div>';
		}
	}
	
	$json_array['status'] = "true";
	$json_array['html'] = $html ;
	$json_array['records_return'] = $RS->RecordCount();
	
	$json = json_encode($json_array);
	echo $json;
	exit();		
}

/******** 
@USE : show more media image gallery
@PARAMETER : next_index,num_of_records
@RETURN : json data
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['show_more_media_l']))
{
	$start_index = $_REQUEST['next_index'];
	$num_of_records = $_REQUEST['num_of_records'];
	$next_index = $start_index + $num_of_records;
	
	$arr_ids1=getallmainmercahnt_id($_SESSION['merchant_id']);
	$ids1=  implode(",", $arr_ids1);

	if($ids1 == "")
	{
		$ids1 =$_SESSION['merchant_id'];
	}
	
	$arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
	$ids=  implode(",", $arr_ids);
	if($ids=="")
		$ids=$_SESSION['merchant_id'];  

	//9-10-2013 Display all images syblic  
	$main_merchant_id = getmainmercahnt_id($_SESSION['merchant_id']);

	$arr_ids_string=getallsubmercahnt_id($main_merchant_id);
	
	$sub_merchant=  implode(",", $arr_ids_string);
	if($sub_merchant=="")
	{
		$sub_merchant=$_SESSION['merchant_id'];
	}    
	
	$merchant_array = array();
	$merchant_array['id'] = $_SESSION['merchant_id'];
	$merchant_info = $objDB->Show("merchant_user",$merchant_array);

	if(isset($_REQUEST['imagetype']))
    {
		if($_REQUEST['imagetype']!='all')
		{

		$RS = $objDB->Conn->Execute("select * from merchant_media where media_type_id=? and (merchant_id in (?) or merchant_id=? or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?)) order by id desc limit $start_index,$num_of_records",array($_REQUEST['imagetype'],$ids1,$merchant_info->fields['merchant_parent'],$sub_merchant,$_SESSION['merchant_id']));
		}
		else
		{
		$RS = $objDB->Conn->Execute("select * from merchant_media where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc limit $start_index,$num_of_records",array($_SESSION['merchant_id'],$ids1,$sub_merchant,$_SESSION['merchant_id']));

		}
	}
    else 
	{
		$RS = $objDB->Conn->Execute("select * from merchant_media where media_type_id=2 and ( merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) ) order by id desc limit $start_index,$num_of_records",array($_SESSION['merchant_id'],$ids1,$sub_merchant,$_SESSION['merchant_id']));
		
	}                
   
	$flag_delete = true;
	$flag_view = true;
	$flag_upload = true;
	
	if($merchant_info->fields['merchant_parent'] != 0)
	{	
		$media_acc_array = array();
		$media_acc_array['merchant_user_id'] = $_SESSION['merchant_id'];
		$RSmedia = $objDB->Show("merchant_user_role",$media_acc_array);
		$media_val = unserialize($RSmedia->fields['media_access']);
		if(in_array("delete",$media_val))
		{
			$flag_delete = true;
		}
		else
		{
			$flag_delete = false;	
		}
		if(in_array("view-use",$media_val))
		{
			$flag_view = true;
		}
		else
		{
			$flag_view = false;	
		}
		if(in_array("upload",$media_val))
		{
			$flag_upload = true;
		}
		else
		{
			$flag_upload = false;	
		}
	}
	else
	{
		$flag_delete = true;
		$flag_view = true;
		$flag_upload = true;
	}
	
	
	$json_array = array();	
	$html="";
	
	if($RS->RecordCount()>0)
	{
		while($Row = $RS->FetchRow())
		{
			if($Row['media_type_id'] == "1")
			{
				$target = "campaign" ;
			}
			if($Row['media_type_id'] == "2")
			{
				$target = "location";
			}
			if($Row['media_type_id'] == "3")
			{
				$target = "giftcard";
			}
			if($Row['media_type_id'] == "1")
			{
				$html.='
			<div class="mediya_img_blk campaignfilter">';
			} 
			if($Row['media_type_id'] == "2")
			{
				$html.='
			<div class="mediya_img_blk locationfilter">';
			}
			if($Row['media_type_id'] == "3")
			{
				$html.='
			<div class="mediya_img_blk giftcardfilter">';
			}
			
			$html.='
				<a href="javascript:void(0)" class="mediya_camp_loca" style="display:none;">';
				
					if($Row['media_type_id'] == "1")
					{
						$html.='<img title="Campaign" src="'.ASSETS_IMG.'/m/mediya_campaign.png">';
					}
					if($Row['media_type_id'] == "2")
					{
						$html.='<img title="Location" src="'.ASSETS_IMG.'/m/mediya_location.png">';
					}
					if($Row['media_type_id'] == "3")
					{
						$html.='<img title="Giftcard" src="'.ASSETS_IMG.'/m/mediya_location.png">';
					}
					
				$html.='</a>
				<img src="'.ASSETS_IMG.'/m/'.$target.'/'.$Row['image'].'" class="mediya_grid"/>';
			/*
			if($flag_delete)
			{
				if($Row['merchant_id']==1)
				{
					$html.='<a href="javascript:void(0)" admin_image="1" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediadeleteid_'.$Row['id'].'" class="mediya_delete">
							<img src="'.ASSETS_IMG.'/m/mediya_delete.png">
						</a>';
				}
				else
				{
					if(in_array($Row['merchant_id'], $arr_ids1))
					{ 
					?>
					
					<?php  
					}
					else if(!in_array($Row['merchant_id'], $arr_ids1) && !in_array($Row['merchant_id'], $arr_ids_string) && $Row['merchant_id']!=$_SESSION['merchant_id'])
					{
					?>
						
					<?php
					}
					else
					{
						
						$html.='<a href="javascript:void(0)" admin_image="0" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediadeleteid_'.$Row['id'].'" class="mediya_delete">
							<img src="'.ASSETS_IMG.'/m/mediya_delete.png">
						</a>';		
						
					}
				} 
			}
			*/
			$html.='<a title="Select Image" href="javascript:void(0)" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediaselect_'.$Row['id'].'" class="mediya_select">
									<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
									<span>Select Image</span>
								</a>';
			$html.='</div>';
		}
	}
	
	$json_array['status'] = "true";
	$json_array['html'] = $html ;
	$json_array['records_return'] = $RS->RecordCount();
	
	$json = json_encode($json_array);
	echo $json;
	exit();		
}

/******** 
@USE : show more media video gallery
@PARAMETER : next_index,num_of_records
@RETURN : json data
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['show_more_media_l_v']))
{
	//echo "1";
	$start_index = $_REQUEST['next_index'];
	$num_of_records = $_REQUEST['num_of_records'];
	$next_index = $start_index + $num_of_records;
	
	$arr_ids1=getallmainmercahnt_id($_SESSION['merchant_id']);
	$ids1=  implode(",", $arr_ids1);

	if($ids1 == "")
	{
		$ids1 =$_SESSION['merchant_id'];
	}
	
	$arr_ids=getallsubmercahnt_id($_SESSION['merchant_id']);
	$ids=  implode(",", $arr_ids);
	if($ids=="")
		$ids=$_SESSION['merchant_id'];  

	//9-10-2013 Display all images syblic  
	$main_merchant_id = getmainmercahnt_id($_SESSION['merchant_id']);

	$arr_ids_string=getallsubmercahnt_id($main_merchant_id);
	
	$sub_merchant=  implode(",", $arr_ids_string);
	if($sub_merchant=="")
	{
		$sub_merchant=$_SESSION['merchant_id'];
	}    
	
	$merchant_array = array();
	$merchant_array['id'] = $_SESSION['merchant_id'];
	$merchant_info = $objDB->Show("merchant_user",$merchant_array);
	//echo "2";
	$RS = $objDB->Conn->Execute("select * from merchant_videos where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc limit $start_index,$num_of_records",array($_SESSION['merchant_id'],$ids1,$sub_merchant,$_SESSION['merchant_id']));               	
	
	$json_array = array();	
	$html="";
	
	if($RS->RecordCount()>0)
	{
		//echo "3";
		while($Row = $RS->FetchRow())
		{
			//echo "4";
			$html.='<div class="mediya_video_blk">
				<a href="'.$Row['video_link'].'" target="_new" >
					<img src="'.$Row['thumbnail_url'].'" class= "mediya_grid_video" />
				</a>
				<img class="mediya_grid1_img_selected mediya_slctd" src="'.ASSETS_IMG.'/m/image_Added_to_lbry.png">
				<a title="Select Video" href="javascript:void(0)" id="mediaselectvideo_'.$Row['id'].'" class="mediya_select">
					<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
					<span>Select Video</span>
				</a>
			</div>';
		}
	}
	
	$json_array['status'] = "true";
	$json_array['html'] = $html ;
	$json_array['records_return'] = $RS->RecordCount();
	
	$json = json_encode($json_array);
	echo $json;
	exit();	
}

/******** 
@USE : show more media admin
@PARAMETER : next_index,num_of_records
@RETURN : json data
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['show_more_media_admin']))
{
	$start_index = $_REQUEST['next_index'];
	$num_of_records = $_REQUEST['num_of_records'];
	$next_index = $start_index + $num_of_records;
		
	$query = "select * from merchant_media where merchant_id=1 and id not in(select merchant_media_id from media_import_image where merchant_id=?) order by id desc limit $start_index,$num_of_records" ;
	
	$RS = $objDB->Conn->Execute($query,array($_SESSION['merchant_id']));
	
	$json_array = array();	
	$html="";
	
	if($RS->RecordCount()>0)
	{
		while($Row = $RS->FetchRow())
		{
			if($Row['media_type_id'] == "1")
			{
				$target = "campaign" ;
			}
			if($Row['media_type_id'] == "2")
			{
				$target = "location";
			}
			if($Row['media_type_id'] == "1")
			{
				$html.='
			<div class="mediya_img_blk campaignfilter">';
			} 
			if($Row['media_type_id'] == "2")
			{
				$html.='
			<div class="mediya_img_blk locationfilter">';
			}
			$html.='<a href="javascript:void(0)" class="mediya_camp_loca">';
				
					if($Row['media_type_id'] == "1")
					{
						$html.='<img title="Campaign" src="'.ASSETS_IMG.'/m/mediya_campaign.png">';
					}
					if($Row['media_type_id'] == "2")
					{
						$html.='<img title="Location" src="'.ASSETS_IMG.'/m/mediya_location.png">';
					}
				
				$html.='</a>
				<img src="'.ASSETS_IMG.'/m/'.$target.'/'.$Row['image'].'" class="mediya_grid"/>';
					
				$html.='<a title="Add to My Images" href="javascript:void(0)" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediaadd_'.$Row['id'].'" class="mediya_add">
						<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
						<span>Add to My Images</span>
					</a>';	
				$html.='</div>';
		}
	}
	
	$json_array['status'] = "true";
	$json_array['html'] = $html ;
	$json_array['records_return'] = $RS->RecordCount();
	
	$json = json_encode($json_array);
	echo $json;
	exit();		
}


/******** 
@USE : get payment history
@PARAMETER : days,mer_id
@RETURN : json data
@USED IN PAGES : payment-history.php
*********/
if(isset($_REQUEST['btngetpaymenthistory']))
{
//error_reporting(E_ALL);
//ini_set('display_errors', 'On');
	
	$mc = new Cache("paymenthistory_");
	$Json=array();
	
	//$memcached->delete("paymenthistory_".$_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days']);
	//$Json = $memcached->get("paymenthistory_".$_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days']);
	//$mc->delete($_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days']);
	
	$Json = $mc->get($_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days']);
	
	if(empty($Json)){
	   	/* 
		 * Paging
		 */
		$sLimit = "";
		if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
		{
			$sLimit = "LIMIT ".$_REQUEST['iDisplayStart'] .", ".
				 $_REQUEST['iDisplayLength'] ;
		}
		if($_REQUEST['days'] == 0)
		{
			$days_list = "";
		}
		else{
			$days_list =  " and DATEDIFF('".date("Y-m-d H:i:s")."',ppo.date ) <= ".$_REQUEST['days'];
		}

		/*$sql = "select ppo.date,ppo.order_id,ppo.amount,ppo.refrence_number ,DATEDIFF('".date("Y-m-d H:i:s")."',ppo.date )
		from purchase_point_order ppo inner join merchant_user mu on  mu.id=ppo.merchant_id 
		where  mu.id=".$_REQUEST['mer_id']." ".$days_list."   order by ppo.date desc";

	    $RS = $objDB->execute_query($sql);*/
		$RS = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS ppo.id,ppo.date,ppo.order_id,ppo.amount,ppo.transaction_id ,DATEDIFF(?,ppo.date )
		from purchase_point_order ppo inner join merchant_user mu on  mu.id=ppo.merchant_id 
		where  mu.id=? ".$days_list."   order by ppo.date desc ".$sLimit,array(date("Y-m-d H:i:s"),$_REQUEST['mer_id']));
	    
		$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
		$total= $sQuery->fields['FOUND_ROWS()'];
	
		$Json = array();
		$Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
		$Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
		$Json['iTotalDisplayRecords'] = $total;
		$Json['sEcho'] = $_REQUEST['sEcho'];
		//$Json['sSearch'] = $_REQUEST['sSearch'];
		$Json['aaData'] = array();

		if($RS->RecordCount()>0)
		{
		
			$k=0;
			while($Row = $RS->FetchRow())
			{
				$Json['aaData'][$k][]=date("Y-m-d g:i:s A", strtotime($Row['date']));
				$Json['aaData'][$k][]=$Row['order_id'];
				$Json['aaData'][$k][]=$Row['transaction_id'];
				$Json['aaData'][$k][]='$'.$Row['amount'];
				$Json['aaData'][$k][]='<a href="print_invoice.php?id='.$Row['id'].'" target="_blank" >Print</a>';
				//$Json['aaData'][$k][]='<a href="javascript:void(0)" data-link="process.php?print_invoice=true&id='.$Row['id'].'" >Print</a>';
				//$Json['aaData'][$k][]=$Row['refrence_number'];
				$k++;
			}
		
		}
		
		//$memcached->set("paymenthistory_".$_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days'],$Json,time()+CACHE_20_MIN);
		$mc->set($_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days'],$Json,time()+CACHE_20_MIN);
		
	}
	$Json['sEcho'] = $_REQUEST['sEcho'];
	$json = json_encode($Json);
	echo $json;

}
if(isset($_REQUEST['btngetpaymenthistory1']))
{
//error_reporting(E_ALL);
//ini_set('display_errors', 'On');
	
	$mc = new Cache("paymenthistory1_");
	$Json=array();
	
	//$memcached->delete("paymenthistory_".$_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days']);
	//$Json = $memcached->get("paymenthistory_".$_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days']);
	//$mc->delete($_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days']);
	
	$Json = $mc->get($_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days']);
	
	if(empty($Json)){
	   	/* 
		 * Paging
		 */
		$sLimit = "";
		if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
		{
			$sLimit = "LIMIT ".$_REQUEST['iDisplayStart'] .", ".
				 $_REQUEST['iDisplayLength'] ;
		}
		if($_REQUEST['days'] == 0)
		{
			$days_list = "";
		}
		else{
			$days_list =  " and DATEDIFF('".date("Y-m-d H:i:s")."',ppo.date ) <= ".$_REQUEST['days'];
		}

		/*$sql = "select ppo.date,ppo.order_id,ppo.amount,ppo.refrence_number ,DATEDIFF('".date("Y-m-d H:i:s")."',ppo.date )
		from purchase_point_order ppo inner join merchant_user mu on  mu.id=ppo.merchant_id 
		where  mu.id=".$_REQUEST['mer_id']." ".$days_list."   order by ppo.date desc";

	    $RS = $objDB->execute_query($sql);*/
		$RS = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS ppo.id,ppo.date,ppo.order_id,ppo.amount,ppo.transaction_id ,DATEDIFF(?,ppo.date )
		from purchase_point_order ppo inner join merchant_user mu on  mu.id=ppo.merchant_id 
		where  mu.id=? ".$days_list."   order by ppo.date desc ".$sLimit,array(date("Y-m-d H:i:s"),$_REQUEST['mer_id']));
	    
		$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
		$total= $sQuery->fields['FOUND_ROWS()'];
	
		$Json = array();
		$Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
		$Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
		$Json['iTotalDisplayRecords'] = $total;
		$Json['sEcho'] = $_REQUEST['sEcho'];
		//$Json['sSearch'] = $_REQUEST['sSearch'];
		$Json['aaData'] = array();

		if($RS->RecordCount()>0)
		{
		
			$k=0;
			while($Row = $RS->FetchRow())
			{
				$Json['aaData'][$k][]=date("Y-m-d g:i:s A", strtotime($Row['date']));
				$Json['aaData'][$k][]=$Row['order_id'];
				$Json['aaData'][$k][]=$Row['transaction_id'];
				$Json['aaData'][$k][]='$'.$Row['amount'];
				$Json['aaData'][$k][]='<a href="print_invoice_download.php?id='.$Row['id'].'" target="_blank" ><i class="fa fa-download"></i></a>';
				//$Json['aaData'][$k][]='<a href="javascript:void(0)" data-link="process.php?print_invoice=true&id='.$Row['id'].'" >Print</a>';
				//$Json['aaData'][$k][]=$Row['refrence_number'];
				$k++;
			}
		
		}
		
		//$memcached->set("paymenthistory_".$_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days'],$Json,time()+CACHE_20_MIN);
		$mc->set($_REQUEST['mer_id']."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['days'],$Json,time()+CACHE_20_MIN);
		
	}
	$Json['sEcho'] = $_REQUEST['sEcho'];
	$json = json_encode($Json);
	echo $json;

}

/******** 
@USE : add to myimages from library
@PARAMETER : id
@RETURN : success
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['add_to_myimages']))
{
	$merchant_media_id = $_REQUEST['id'];
	$merchant_id = $_SESSION['merchant_id'];
	
	
	$merchant_media = array();
	$merchant_media['id'] = $_REQUEST['id'];
	$merchant_media_info = $objDB->Show("merchant_media",$merchant_media);
	
	if($merchant_media_info->RecordCount()>0)
	{
		$media_import_image_array = array();
		$media_import_image_array['merchant_id'] = $merchant_id;
		$media_import_image_array['merchant_media_id'] = $merchant_media_id;
		$objDBWrt->Insert($media_import_image_array, "media_import_image");
		echo "success";
	}
	else
	{
		echo "failure";
	}
}

/******** 
@USE : get pricelist json data
@PARAMETER : id
@RETURN : success
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['getpricelistjsonfile']))
{	
	$filename = $_REQUEST['filename'];
	$pricelist_id = $_REQUEST['pricelist_id'];
	$json_array = array();
	$json_array['jsonurl'] = ASSETS.'/pricelist/json/'.str_replace(" ","%20",$filename)."_".$pricelist_id.".json";
	$data = file_get_contents(ASSETS.'/pricelist/json/'.str_replace(" ","%20",$filename)."_".$pricelist_id.".json");	
	//$data = file(ASSETS.'/pricelist/json/'.$filename."_".$pricelist_id.".json");

	$json_array['data'] = $data;
	$json = json_encode($json_array);
	echo $json;
	exit();
}
/******** 
@USE : Get all pricelist of merchant
@PARAMETER : merchant id
@RETURN : pricelist list
@USED IN PAGES : pricelists.php
*********/
if(isset($_REQUEST['btnGetAllPricelist']))
{
	$TableName= "pricelists";
	
	
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}
	
	$SQLstring = 'SELECT SQL_CALC_FOUND_ROWS p.*,pt.name FROM pricelists p,pricelist_type pt where p.pricelist_type_id=pt.id and merchant_id='.$_SESSION['merchant_id'].' ORDER BY last_update DESC '.$sLimit;
	//$QueryResult = mysql_query($SQLstring);
	$QueryResult = $objDB->Conn->Execute($SQLstring);

	
	$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
	$total= $sQuery->fields['FOUND_ROWS()'];
	
	$Json = array();
	$Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
	$Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
	$Json['iTotalDisplayRecords'] = $total;
	$Json['sEcho'] = $_REQUEST['sEcho'];
	$Json['sSearch'] = $_REQUEST['sSearch'];
	$Json['aaData'] = array();
		
	if($QueryResult->RecordCount() >0)
	{
		 $k =0;
		while($Row = $QueryResult->FetchRow())
		{
			if($Row['publish'] == 0 )
			{ 
				$publish= 'Publish';
				$pbls=1;
			 }
			 else{
			  $publish ='Unpublish';
			  $pbls=0;
			};
			if($Row['publish'] == 0 )
			{ 
				$publish_status= '<span class="label label-primary">not published</span>';
				$disable = 'data-disabled="false"';
			 }
			 else{
			  $publish_status ='<span class="label label-primary">published</span>';
			  $disable = 'data-disabled="true"';
			};
			$Json['aaData'][$k][]='<input type="checkbox" name="chkgrp" id="chk_'.$Row['id'].'" value="'.$Row['id'].'">';
			$Json['aaData'][$k][]='<label style="cursor:pointer;" for="chk_'.$Row['id'].'">'.str_replace("\dq",'"',$Row['pricelist_name']).'</label>';
			$Json['aaData'][$k][]=date("Y-m-d",strtotime($Row['last_update']));
			$Json['aaData'][$k][]=$Row['display_order'];
			$Json['aaData'][$k][]=$publish_status;
			$Json['aaData'][$k][]=$Row['name'];
			$html ='<div class="btn-group">
					  <button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
						More Action
					  </button>
					  <ul class="dropdown-menu" role="menu">
						<li><a  class="edit_pricelist">Edit</a></li>
						<li><a id="'.$Row['id'].'" class="delete_pricelist_row" '.$disable.'>Delete</a></li>
						<li><a id="'.$Row['id'].'" publish='.$pbls.' class="publish_pricelist_row">'.$publish.'</a></li>
					  </ul>
					   <form  class="edit_form" method="post" action="'.$Row['name'].'_edit_pricelist.php">
						<input name="id" type="hidden" value="'.$Row['id'].'"></div>
					  </form>
					  <form method="post" class="delete_form" action="delete_pricelist.php">
						<input name="id" type="hidden" value="'.$Row['id'].'" ></div>
					  </form>
					  <form method="post" class="publish_form" action="publish.php">
						<input name="id" type="hidden" value="'.$Row['id'].'"></div>
					  </form>
					</div>';
			$Json['aaData'][$k][]=$html;
			$k++;
		}
	}
	else
	{
	}
	echo json_encode($Json);
    exit;
}
/******** 
@USE : delete pricelist of merchant
@PARAMETER : merchant id,pricelist id
@RETURN : 
@USED IN PAGES : pricelists.php
*********/
if(isset($_REQUEST['delete_pricelist']))
{
//mysql_connect('localhost', 'root', 'root');
//mysql_select_db('test_scanflip');
if(isset($_REQUEST['pricelist_id']))
{
$id=$_REQUEST['pricelist_id'];
//include 'dbconnect.php';
$TableName= "pricelists";
$findId = 'SELECT * from '.$TableName.' WHERE id = '.$id.';';

//$Row = mysql_fetch_array(mysql_query($findId));
//$query= mysql_query($findId) or die($query."<br/><br/>".mysql_error());

$RS = $objDB->Conn->Execute($findId);
$Row = $RS->FetchRow();

//echo $Row['5'];

$query= $objDB->Conn->Execute($findId) or die($query."
;<br/><br/>".mysql_error());	
		
		if($query){
			$Reorderquery = 'UPDATE ' .$TableName.' set display_order = display_order-1 where display_order > '.$Row[5].';';
		}
		/*
		if(mysql_fetch_array($query) !== false){
			$sql ='select json_url from '.$TableName.' where id='.$id.';' ;
			$SQLstring = 'delete from '.$TableName.' where id='.$id.';' ;
			$SelectFile = mysql_query($sql);
			$QueryResult = mysql_query($SQLstring);
			if ($QueryResult && $SelectFile) {
				$Row = mysql_fetch_row($SelectFile);
				if(file_exists(ROOT.'/assets/pricelist/'.$Row[0])){
					unlink(ROOT.'/assets/pricelist/'.$Row[0]);
					mysql_query($Reorderquery);
				}
				else{
					echo 'file not there';
				}
				//header("Location: pricelists.php");
			}
		}
		*/
		if($Row){
			$sql ='select json_url from '.$TableName.' where id='.$id.';' ;
			$SQLstring = 'delete from '.$TableName.' where id='.$id.';' ;
			$SelectFile = $objDB->Conn->Execute($sql);
			
			// unassign pricelist from location when delete pricelist
			
			$array_where = array();
			$array_where['pricelist_id'] = $id;
			$objDBWrt->Remove("location_pricelist", $array_where);
			
			// unassign pricelist from location when delete pricelist
			
			$QueryResult = $objDB->Conn->Execute($SQLstring);
			if ($QueryResult && $SelectFile) {
				$Row = $SelectFile->FetchRow();
				if(file_exists(ROOT.'/assets/pricelist/'.$Row[0])){
					unlink(ROOT.'/assets/pricelist/'.$Row[0]);
					$objDB->Conn->Execute($Reorderquery);
				}
				else{
					echo 'file not there';
				}
				//header("Location: pricelists.php");
			}
		}
		else{
			echo '<script>alert("pricelist doesn\'t exist.")</script>';
			  echo '<script>window.location.href="pricelists.php"</script>';
		}

	}
}

/******** 
@USE : Get all cards of merchant
@PARAMETER : merchant id
@RETURN : card list
@USED IN PAGES : manage_cards.php
*********/
if(isset($_REQUEST['btnGetAllCardlist']))
{
	$TableName= "merchant_loyalty_card";
	
	$today_date = date("Y-m-d")." 00:00:00";
	$where_cond = "";
	
	if (isset($_REQUEST['year']))
	{
		$where_cond .= " and DATE_FORMAT(created_date,'%Y')=".$_REQUEST['year'];
	} 
	if (isset($_REQUEST['status']))
	{
		if($_REQUEST['status']=="all")
		{
			//$where_cond .= " and (card_status=2 or card_status=1 or card_status=4)";
		}
		else if($_REQUEST['status']==214)
		{
			$where_cond .= " and (card_status=2 or card_status=1 or card_status=4)";
		}
		else
		{
			$where_cond .= " and card_status=".$_REQUEST['status'];
		}
	}
	
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'];
	}
	
	$sSort = "";
	if ( isset($_REQUEST['iSortCol_0']) && $_REQUEST['iSortCol_0']==3 && $_REQUEST['bSortable_3'] == true )
	{
		$sSort = " order by card_status ".$_REQUEST['sSortDir_0'];
	}
	else
	{
		$sSort = " order by modified_date desc ";
	}
	
	//$SQLstring = 'SELECT SQL_CALC_FOUND_ROWS * FROM merchant_loyalty_card where card_status!=3 and merchant_id='. $_SESSION['merchant_id']." order by modified_date desc ".$sLimit;
	$SQLstring = 'SELECT SQL_CALC_FOUND_ROWS * FROM merchant_loyalty_card where merchant_id='. $_SESSION['merchant_id']." $where_cond $sSort ".$sLimit;
	//$QueryResult = mysql_query($SQLstring);
	$QueryResult = $objDB->Conn->Execute($SQLstring);

	
	$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
	$total= $sQuery->fields['FOUND_ROWS()'];
	
	$Json = array();
	$Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
	$Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
	$Json['iTotalDisplayRecords'] = $total;
	$Json['sEcho'] = $_REQUEST['sEcho'];
	$Json['sSearch'] = $_REQUEST['sSearch'];
	$Json['aaData'] = array();
		
	if($QueryResult->RecordCount() >0)
	{
		 $k =0;
		while($Row = $QueryResult->FetchRow())
		{
			
			//text for card status
			  if($Row['card_status']==1) // Editable
			  {
				//$card_status = 'Editable';
				$card_status = 'Unpublished';
				$button = 'activate_card';
				$text = 'Activate';
				$text = 'Publish';
			  }
			  elseif($Row['card_status']==2) // Active
			  {
				//$card_status= 'Active';
				$card_status = 'Published';
				$button = 'pause_card';
				$text = 'Pause';
				$text = 'Unpublish';
			  }
			  elseif($Row['card_status']==3) // Expire
			  {
				$card_status= 'Expired';
				$button = 'activate_card';
				$text = 'Activate';
				$text = 'Publish';
			  }
			  elseif($Row['card_status']==4) // Pause
			  {
				//$card_status= 'Pause';
				$card_status = 'Unpublished';
				$button = 'activate_card';
				$text = 'Activate';
				$text = 'Publish';
			  }
                 
			$Json['aaData'][$k][]=$Row['title'];
			$Json['aaData'][$k][]=$Row['card_volume'];
			$Json['aaData'][$k][]=$Row['cards_left'];
			$Json['aaData'][$k][]='<span class="label label-primary">'.$card_status.'</span>';
			$html ='<div class="btn-group">
                      <button class="btn btn-default btn-sm dropdown-toggle" type="button" data-toggle="dropdown" aria-expanded="false">
                        More Action
                      </button>
                      <ul class="dropdown-menu" role="menu">';
				
				    if($Row['card_status']==1) // Editable
					{
						$html .='<li><a  class="edit_card" value="'.$Row['id'].'">Edit</a></li>';
						$html .='<li><a class="'.$button.'" value="'.$Row['id'].'">'.$text.'</a></li>';	
					}			
                    elseif($Row['card_status']==2) // Active
					{
						//$html .='<li><a  class="edit_card" value="'.$Row['id'].'">Edit</a></li>';
						$html .='<li><a class="'.$button.'" value="'.$Row['id'].'">'.$text.'</a></li>';
						$html .='<li><a class="delete_card" value="'.$Row['id'].'">Expire</a></li>';
					}
					elseif($Row['card_status']==3) // Expire
					{
						$html .='<li><a class="copy_card" value="'.$Row['id'].'">Copy</a></li>';
					}
					elseif($Row['card_status']==4) // Pause
					{
						$html .='<li><a  class="edit_card" value="'.$Row['id'].'">Edit</a></li>';
						$html .='<li><a class="'.$button.'" value="'.$Row['id'].'">'.$text.'</a></li>';
						$html .='<li><a class="delete_card" value="'.$Row['id'].'">Expire</a></li>';
					}
					  
                 
                $html .='</ul>
                      <form action="edit_card.php" id="edit_card_form" method="post">
						<input name="card_id" type="hidden" id="card_id">
					</form>
					<form action="copy_card.php" id="copy_card_form" method="post">
						<input name="card_id_hdn" type="hidden" id="card_id_hdn">
					</form>
                    </div>';
			$Json['aaData'][$k][]=$html;
			$k++;
		}
	}
	else
	{
	}
	echo json_encode($Json);
    exit;
}

/******** 
@USE : Get all cards of merchant for report
@PARAMETER : merchant id
@RETURN : card list
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnGetAllCardlistReport']))
{
	$TableName= "merchant_loyalty_card";
	
	$today_date = date("Y-m-d")." 00:00:00";
	$where_cond = "";
	
	if (isset($_REQUEST['year']))
	{
		$where_cond .= " and DATE_FORMAT(created_date,'%Y')=".$_REQUEST['year'];
	} 
	if (isset($_REQUEST['status']))
	{
		if($_REQUEST['status']==24)
		{
			$where_cond .= " and (card_status=2 or card_status=4)";
		}
		else
		{
			$where_cond .= " and card_status=".$_REQUEST['status'];
		}
	}
	
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}
	
	//$SQLstring = 'SELECT SQL_CALC_FOUND_ROWS * FROM merchant_loyalty_card where card_status!=3 and merchant_id='. $_SESSION['merchant_id']." order by modified_date desc ".$sLimit;
	$SQLstring = 'SELECT SQL_CALC_FOUND_ROWS * FROM merchant_loyalty_card where is_published=1 and merchant_id='. $_SESSION['merchant_id']." $where_cond order by modified_date desc ".$sLimit;
	//$QueryResult = mysql_query($SQLstring);
	$QueryResult = $objDB->Conn->Execute($SQLstring);

	
	$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
	$total= $sQuery->fields['FOUND_ROWS()'];
	
	$Json = array();
	$Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
	$Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
	$Json['iTotalDisplayRecords'] = $total;
	$Json['sEcho'] = $_REQUEST['sEcho'];
	$Json['sSearch'] = $_REQUEST['sSearch'];
	$Json['aaData'] = array();
		
	if($QueryResult->RecordCount() >0)
	{
		 $k =0;
		while($Row = $QueryResult->FetchRow())
		{        
			if($Row['card_status']==2)
			{
				$Json['aaData'][$k][]="<a href='javascript:void(0)' class='getanalytics' cardid='".$Row['id']."' active='1' >".$Row['title']."</a>";
			}
			else
			{
				$Json['aaData'][$k][]="<a href='javascript:void(0)' class='getanalytics' cardid='".$Row['id']."' active='0' >".$Row['title']."</a>";
			}
			
			if($Row['card_status']==1) // Editable
			  {
				//$card_status = 'Editable';
				$card_status = '<span class="label label-primary">Unpublished</span>';
			  }
			  elseif($Row['card_status']==2) // Active
			  {
				//$card_status= 'Active';
				$card_status = '<span class="label label-primary">Published</span>';
			  }
			  elseif($Row['card_status']==3) // Expire
			  {
				$card_status= '<span class="label label-primary">Expired</span>';
			  }
			  elseif($Row['card_status']==4) // Pause
			  {
				//$card_status= 'Pause';
				$card_status = '<span class="label label-primary">Unpublished</span>';
			  }
			$Json['aaData'][$k][]=$card_status;
			$Json['aaData'][$k][]=date("Y-m-d",strtotime($Row['created_date']));
			$k++;
		}
	}
	else
	{
	}
	echo json_encode($Json);
    exit;
}

/******** 
@USE : Get all cards of merchant for qrcodes
@PARAMETER : merchant id
@RETURN : card list
@USED IN PAGES : 
*********/
if(isset($_REQUEST['btnGetAllCardlistQRCODE']))
{
	$TableName= "merchant_loyalty_card";
	$merchant_id = $_REQUEST['mer_id'];
	$today_date = date("Y-m-d")." 00:00:00";
	$where_cond = "";
	
	$where_cond .= " and card_status=2";
		
	//$SQLstring = 'SELECT SQL_CALC_FOUND_ROWS * FROM merchant_loyalty_card where card_status!=3 and merchant_id='. $_SESSION['merchant_id']." order by modified_date desc ".$sLimit;
	$SQLstring = 'SELECT id,title,qrcode_id,activationcode FROM merchant_loyalty_card where merchant_id='. $merchant_id." $where_cond order by modified_date desc ";
	//$QueryResult = mysql_query($SQLstring);
	$QueryResult = $objDB->Conn->Execute($SQLstring);
	
	$Json = array();
		
	if($QueryResult->RecordCount() >0)
	{
		$count =0;
		while($Row = $QueryResult->FetchRow())
		{        
			$records[$count] = get_field_value($Row);
            $count++;
		}
		$json_array['status'] = "true";
		$json_array['total_records'] = $count;
		$json_array["records"]= $records;
		
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['total_records'] = 0;
		$json_array["records"]= "";
	}
	$json = json_encode($json_array);
	echo $json;
	exit();
}

if(isset($_REQUEST['manage_marketing_material_location'])){

	/* 
	 * Paging
	 */
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}

	//$records_array_loc = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS l.id,l.state,l.city,l.address,l.zip,ql.qrcode_id,q.qrcode FROM locations l left Join qrcode_location ql on ql.location_id=l.id left join qrcodes q on q.id=ql.qrcode_id WHERE  l.active=1 and l.created_by=? ".$sLimit, array($_SESSION['merchant_id']));
	//echo $sql =  "SELECT SQL_CALC_FOUND_ROWS l.id,l.state,l.city,l.address,l.zip,l.qrcode_id,q.qrcode FROM locations l left join qrcodes q on q.id=l.qrcode_id WHERE  l.active=1 and l.created_by=".$_SESSION['merchant_id']." and l.qrcode_id!=0 ".$sLimit; 
	//exit();
	$records_array_loc = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS l.id,l.state,l.city,l.address,l.zip,l.qrcode_id,q.qrcode FROM locations l left join qrcodes q on q.id=l.qrcode_id WHERE  l.active=1 and l.created_by=? ".$sLimit, array($_SESSION['merchant_id']));
	
	$total_records_loc = $records_array_loc->RecordCount();

		$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
		$total= $sQuery->fields['FOUND_ROWS()'];

		$Json = array();
                $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
                $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
                $Json['iTotalDisplayRecords'] = $total;
                $Json['sEcho'] = $_REQUEST['sEcho'];
                $Json['sSearch'] = $_REQUEST['sSearch'];
                $Json['aaData'] = array();

	if ($total_records_loc > 0) {
		$k=0;
                while ($Row = $records_array_loc->FetchRow()) {
			$css = "";

	            	if ($Row['active'] != 1) {
	                    $css = "background-color:#E1E1E1";
	            	}
                   
			if(empty($Row['qrcode_id'])){
				$printclass = "pcoupon";
                            	$downloadclass = "downloadqrcode loc";
                            	$linktext = "Link";
                            	$qrcodestring = "";
			}else{
				$qrcodestring = $Row['qrcode'];
                            	$printclass = "rcoupon";
                            	$downloadclass = " rdownloadqrcode loc";
                            	$linktext = "Un-link";
			
			}
			$Json['aaData'][$k][]='<input type="radio"  visit="first" id="rd_campaigntitle_'.$Row['id'].'" name="rd_locationtitle" value="'.$Row['id'].'" />';
			
			$array_where = array();
			$array_where['id'] = $Row['state'];
			$RS_state = $objDB->Show("state", $array_where);

			$array_where = array();
			$array_where['id'] = $Row['city'];
			$RS_city = $objDB->Show("city", $array_where);
			
			$Json['aaData'][$k][]='<a href="javascript:void(0)" id="showCamp_'.$Row['id'].'"> '. $Row['address'] . ", " . $RS_city->fields['name'] . ", " . $RS_state->fields['short_form'] . ", " . $Row['zip'] .'</a>';
			$Json['aaData'][$k][]='<a href="javascript:void(0)" locid="'.$Row['id'].'" qval="'.$qrcodestring.'" class="'. $downloadclass.'" >'.$linktext.'</a>';
		$k++;
		}
	}
	echo json_encode($Json);
         
        exit;
}

function create_unique_code_for_getcard() 
{
        $code_length = 8;
        //echo $alfa = "1AB2CD3EF4G5HI6JK7LM8N9OP10QRSTU".$campaign_id."VWXYZ";
        $alfa = "12345678910ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        $code = "";
        for ($i = 0; $i < $code_length; $i ++) {
                $code .= $alfa[rand(0, strlen($alfa) - 1)];
        }
        return $code;
}
/******** 
@USE : punch card for user
@PARAMETER : merchant_id,code for card,revenue
@RETURN : status
@USED IN PAGES : 
*********/
if(isset($_REQUEST['punchcard_for_user']))
{
	$json_array = array();
	//$merchant_id=17;
	//echo "id = ".$_SESSION['merchant_id'];
	$merchant_id=$_REQUEST['merchant_id'];
	
	$array1 = array();
	$array1['id'] = $merchant_id;
	$RS1 = $objDB->Show("merchant_user",$array1);
	
	$redeem_location = 	$RS1->fields['redeem_location'];
	$code=$_REQUEST['code'];
	$revenue=$_REQUEST['revenue'];
	
	$array2 = array();
	$array2['code'] = $code;
	$RS2 = $objDB->Show("customer_loyalty_reward_card",$array2);
	
	$loyalty_location=array();
	
	if($RS2->RecordCount()>0)
	{
		
		$RS_loc = $objDB->Conn->Execute("SELECT * from loyaltycard_location where loyalty_card_id =?",array($RS2->fields['card_id']));
        if($RS_loc->RecordCount()>0)
		{
            while($Row_loc = $RS_loc->FetchRow())
            {
				array_push($loyalty_location,$Row_loc['location_id']);
			}   
        }
        else
        {
        
        }
        
		if(in_array($redeem_location,$loyalty_location)) // card must be on redeem location
		{
			if($RS2->fields['card_type']==1) // loyalty card
			{
				if($RS2->fields['card_status']==1) // card must be active
				{
					if($RS2->fields['total_stamp_left']>0) // total stamp left > 0
					{
						$array_loc = array();
						$array_loc['id'] = $redeem_location;
						$RS_location = $objDB->Show("locations",$array_loc);
						$time_zone=$RS_location->fields['timezone_name'];
						date_default_timezone_set($time_zone);
						
						$day_timezone_id="";	
						/*
						echo "on assigned location"."<br/>";		
						echo "user_card_id = ".$RS2->fields['id']."<br/>";
						echo "location_id = ".$redeem_location."<br/>";
						echo "revenue = ".$revenue."<br/>";
						echo "transaction_date = ".date("Y-m-d H:i:s")."<br/>";
						echo "hour = ".date("g:i a")."<br/>";
						*/
						$RS_dt = $objDB->Conn->Execute("SELECT * from day_timezone");
						if($RS_dt->RecordCount()>0)
						{
							while($Row_dt = $RS_dt->FetchRow())
							{
								$ta = explode("-",$Row_dt['timevalue']);
								//print_r($ta);
								//echo "<br/>";
								$current_time1 = date("g:i a");
								//$current_time1 = "11:58 pm";
								//$current_time1 = "12:00 am";
								//$current_time1 = "11:01 am";
								//$current_time1 = "11:58 pm";
								//$current_time1 = "11:58 pm";
								$starttime1 = $ta[0];
								$endtime1 = $ta[1];
								/*
								echo "<br/>";
								echo "current = ".$current_time1."<br/>";
								echo "start = ".$ta[0]."<br/>";
								echo "end = ".$ta[1]."<br/>";
								echo "<br/>";
								*/
								$cur_time = strtotime($current_time1);
								$st_time  = strtotime($starttime1);
								$end_time = strtotime($endtime1);
								/*
								echo "<br/>";
								echo "current = ".$cur_time."<br/>";
								echo "start = ".$st_time."<br/>";
								echo "end = ".$end_time."<br/>";
								echo "<br/>";
								*/
								if ($cur_time >= $st_time && $cur_time <= $end_time ) 
								{ 					  
									//echo $Row_dt['id'].'='.$Row_dt['timevalue']."<br/>";
									$day_timezone_id = $Row_dt['id'];
								}
							}   
						}
						
						//echo "day_timezone_id = ".$day_timezone_id."<br/>";
						
						//exit();
						
						
						// start point_spent calculation
						
						$point_spent=0;
						
						$array_mlc = array();
						$array_mlc['id'] = $RS2->fields['card_id'];
						$RS_mlc = $objDB->Show("merchant_loyalty_card",$array_mlc);
						
						$array_mlrc = array();
						$array_mlrc['loyalty_card_id'] = $RS2->fields['card_id'];
						$RS_mlrc = $objDB->Show("merchant_loyalty_reward_card",$array_mlrc);
						
						$pack_data = array();
						$pack_data['merchant_id'] = $_SESSION['merchant_id'];
						$get_pack_data = $objDB->Show("merchant_billing",$pack_data);

						$pack_data1 = array();
						$pack_data1['id'] = $get_pack_data->fields['pack_id'];
						$get_billing_pack_data = $objDB->Show("billing_packages",$pack_data1);

						$card_volume = $RS_mlc->fields['card_volume'];
						$number_of_stamps = $RS2->fields['total_stamp_left'];
						$transaction_fees_stamp = $get_billing_pack_data->fields['transaction_fees_stamp']; 
						$points_per_visit = $RS_mlc->fields['reward_per_visit'];
						$additional_reward = $RS_mlrc->fields['reward_points'];

						$point_spent =  $points_per_visit + $transaction_fees_stamp; 
			
						// end point_spent calculation
						
						//$objDB->Conn->StartTrans();
						
						$RS_per_day = $objDB->Conn->Execute("SELECT * FROM `customer_loyalty_card_transaction` 
						where user_card_id=".$RS2->fields['id']." and day(transaction_date)=day(now()) 
								and month(transaction_date)=month(now())
								and year(transaction_date)=year(now())");
								
						if($RS_per_day->RecordCount()>0 && $RS_mlc->fields['redeemption_limit']==1)
						{
							$json_array['status'] = "false";
							$json_array['message'] = "card already redeemed today.";
							$json = json_encode($json_array);
							echo $json;
							exit();
						}	
						else
						{
							$punch_card = array();
							$punch_card['user_card_id'] = $RS2->fields['id'];
							$punch_card['location_id'] = $redeem_location;
							$punch_card['revenue'] = $revenue;
							$punch_card['transaction_date'] = date("Y-m-d H:i:s"); 
							$punch_card['day_timezone_id'] = $day_timezone_id;
							$punch_card['point_spent'] = $point_spent;
							$objDBWrt->Insert($punch_card, "customer_loyalty_card_transaction");
							
							// start update points_spent_loyaltycard,points_spent_loyalty_rewardcard calculation
							
							$sql1='update merchant_point_management set ';
							$sql1.=' points_blocked = points_blocked - '.$point_spent;
							$sql1.=',points_blocked_loyaltycard = points_blocked_loyaltycard - '.$point_spent;
							$sql1.=',points_spent = points_spent + '.$point_spent;
							$sql1.=',points_spent_loyaltycard = points_spent_loyaltycard + '.$point_spent;
							$sql1.=' where merchant_id ='.$_SESSION['merchant_id'].';';
							$rs1=$objDBWrt->Conn->Execute($sql1);
							
							// end update points_spent_loyaltycard,points_spent_loyalty_rewardcard calculation
							
							if($RS2->fields['total_stamp_left']==1)
							{
								$Sql = "Update customer_loyalty_reward_card set block_point=block_point-".$point_spent.",spent_point=spent_point+".$point_spent.",card_status=3,total_stamp_left = total_stamp_left-1 where id=".$RS2->fields['id'];
							}
							else
							{
								$Sql = "Update customer_loyalty_reward_card set block_point=block_point-".$point_spent.",spent_point=spent_point+".$point_spent.",total_stamp_left = total_stamp_left-1 where id=".$RS2->fields['id'];
							}
							$objDBWrt->Conn->Execute($Sql);
							
							$array3 = array();
							$array3['code'] = $code;
							$RS3 = $objDB->Show("customer_loyalty_reward_card",$array3);
							
							if($RS3->RecordCount()>0)
							{
								if($RS3->fields['total_stamp_left']==0)
								{
							
									$user_card = array();
									
									$code ="";
									do
									{
										$code =  create_unique_code_for_getcard(); 
										$card_query1=  'select count(*) total from customer_loyalty_reward_card where code="'.$code.'" and code in(select code from customer_loyalty_reward_card)';
										$card_rs1 = $objDB->Conn->Execute($card_query1);
										$total = $card_rs1->fields['total'];		
									}while($total>0);
			
									$user_card['code'] = $code; 
									$user_card['user_id'] = $RS3->fields['user_id'];
									$user_card['card_id'] = $RS3->fields['card_id'];
									$user_card['card_type'] = 2; // reward
									$user_card['card_status'] = 1; // pending
									$user_card['date_activated'] = date("Y-m-d H:i:s");
									$objDBWrt->Insert($user_card, "customer_loyalty_reward_card");
								}
							}
						}
						/*
						$res = $objDB->Conn->CompleteTrans();

						if($res == true)
						{
							$json_array['status'] = "true";
							$json_array['message'] = "card redeemed successfully";
							$json = json_encode($json_array);
							echo $json;
							exit();
						}
						else
						{
							$json_array['status'] = "false";
							$json_array['message'] = "some error occured.";
							$json = json_encode($json_array);
							echo $json;
							exit();
						}
						*/
						$json_array['status'] = "true";
						$json_array['message'] = "card redeemed successfully";
						$json = json_encode($json_array);
						echo $json;
						exit();
					}
					else
					{
						$json_array['status'] = "false";
						$json_array['message'] = "no stamp left";
						$json = json_encode($json_array);
						echo $json;
						exit();
					}
				}
				else
				{		
					$json_array['status'] = "false";
					$json_array['message'] = "card not active";
					$json = json_encode($json_array);
					echo $json;
					exit();
				}
			}
			else // reward card
			{
				if($RS2->fields['card_status']==1) // card must be active
				{
					$array_loc = array();
					$array_loc['id'] = $redeem_location;
					$RS_location = $objDB->Show("locations",$array_loc);
					$time_zone=$RS_location->fields['timezone_name'];
					date_default_timezone_set($time_zone);
					
					$day_timezone_id="";	
					/*
					echo "on assigned location"."<br/>";		
					echo "user_card_id = ".$RS2->fields['id']."<br/>";
					echo "location_id = ".$redeem_location."<br/>";
					echo "revenue = ".$revenue."<br/>";
					echo "transaction_date = ".date("Y-m-d H:i:s")."<br/>";
					echo "hour = ".date("g:i a")."<br/>";
					*/
					$RS_dt = $objDB->Conn->Execute("SELECT * from day_timezone");
					if($RS_dt->RecordCount()>0)
					{
						while($Row_dt = $RS_dt->FetchRow())
						{
							$ta = explode("-",$Row_dt['timevalue']);
							//print_r($ta);
							//echo "<br/>";
							$current_time1 = date("g:i a");
							//$current_time1 = "11:58 pm";
							//$current_time1 = "12:00 am";
							//$current_time1 = "11:01 am";
							//$current_time1 = "11:58 pm";
							//$current_time1 = "11:58 pm";
							$starttime1 = $ta[0];
							$endtime1 = $ta[1];
							/*
							echo "<br/>";
							echo "current = ".$current_time1."<br/>";
							echo "start = ".$ta[0]."<br/>";
							echo "end = ".$ta[1]."<br/>";
							echo "<br/>";
							*/
							$cur_time = strtotime($current_time1);
							$st_time  = strtotime($starttime1);
							$end_time = strtotime($endtime1);
							/*
							echo "<br/>";
							echo "current = ".$cur_time."<br/>";
							echo "start = ".$st_time."<br/>";
							echo "end = ".$end_time."<br/>";
							echo "<br/>";
							*/
							if ($cur_time >= $st_time && $cur_time <= $end_time ) 
							{ 					  
								//echo $Row_dt['id'].'='.$Row_dt['timevalue']."<br/>";
								$day_timezone_id = $Row_dt['id'];
							}
						}   
					}
					
					//echo "day_timezone_id = ".$day_timezone_id."<br/>";
					
					//exit();
					
					// start point_spent calculation
						
					$point_spent=0;

					$array_mlc = array();
					$array_mlc['id'] = $RS2->fields['card_id'];
					$RS_mlc = $objDB->Show("merchant_loyalty_card",$array_mlc);

					$array_mlrc = array();
					$array_mlrc['loyalty_card_id'] = $RS2->fields['card_id'];
					$RS_mlrc = $objDB->Show("merchant_loyalty_reward_card",$array_mlrc);

					$pack_data = array();
					$pack_data['merchant_id'] = $_SESSION['merchant_id'];
					$get_pack_data = $objDB->Show("merchant_billing",$pack_data);

					$pack_data1 = array();
					$pack_data1['id'] = $get_pack_data->fields['pack_id'];
					$get_billing_pack_data = $objDB->Show("billing_packages",$pack_data1);

					$card_volume = $RS_mlc->fields['card_volume'];
					$number_of_stamps = $RS2->fields['total_stamp_left'];
					$transaction_fees_stamp = $get_billing_pack_data->fields['transaction_fees_stamp']; 
					$points_per_visit = $RS_mlc->fields['reward_per_visit'];
					$additional_reward = $RS_mlrc->fields['reward_points'];

					$point_spent =  $points_per_visit + $transaction_fees_stamp; 	

					// end point_spent calculation
					
					//$objDB->Conn->StartTrans();
					
					$punch_card = array();
					$punch_card['user_card_id'] = $RS2->fields['id'];
					$punch_card['location_id'] = $redeem_location;
					$punch_card['revenue'] = $revenue;
					$punch_card['transaction_date'] = date("Y-m-d H:i:s"); 
					$punch_card['day_timezone_id'] = $day_timezone_id;
					$punch_card['point_spent'] = $point_spent;
					$objDBWrt->Insert($punch_card, "customer_loyalty_card_transaction");
					
					// start update points_spent_loyaltycard,points_spent_loyalty_rewardcard calculation
						
					$sql1='update merchant_point_management set ';
					$sql1.=' points_blocked = points_blocked - '.$point_spent;
					$sql1.=',points_blocked_loyaltycard = points_blocked_loyaltycard - '.$point_spent;
					$sql1.=',points_spent = points_spent + '.$point_spent;
					$sql1.=',points_spent_loyalty_rewardcard = points_spent_loyalty_rewardcard + '.$point_spent;
					$sql1.=' where merchant_id ='.$_SESSION['merchant_id'].';';
					$rs1=$objDBWrt->Conn->Execute($sql1);

					// end update points_spent_loyaltycard,points_spent_loyalty_rewardcard calculation

					$Sql = "Update customer_loyalty_reward_card set card_status=4 where id=".$RS2->fields['id'];
					
					$objDBWrt->Conn->Execute($Sql);
					
					/*
					$res = $objDB->Conn->CompleteTrans();

					if($res == true)
					{
						$json_array['status'] = "true";
						$json_array['message'] = "card redeemed successfully";
						$json = json_encode($json_array);
						echo $json;
						exit();
					}
					else
					{
						$json_array['status'] = "false";
						$json_array['message'] = "some error occured.";
						$json = json_encode($json_array);
						echo $json;
						exit();
					}
					*/
					$json_array['status'] = "true";
					$json_array['message'] = "card redeemed successfully";
					$json = json_encode($json_array);
					echo $json;
					exit(); 
				}
				else
				{		
					$json_array['status'] = "false";
					$json_array['message'] = "card not active";
					$json = json_encode($json_array);
					echo $json;
					exit();
				}
			}
		}
		else
		{
			$json_array['status'] = "false";
			$json_array['message'] = "card not exist on assigned location";
			$json = json_encode($json_array);
			echo $json;
			exit();
		}
		
	}
	else
	{
		$json_array['status'] = "false";
		$json_array['message'] = "code not exist";
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
}

if(isset($_REQUEST['payment_cards'])){
	$array['card_id'] = $_REQUEST['card']['id'];
	$array['merchant_id'] = $_SESSION['merchant_id'];
	$array['card_number'] = $_REQUEST['card']['last4'];
	$array['type'] =$_REQUEST['card']['brand'];
	$array['exp_month'] =$_REQUEST['card']['exp_month'];
	$array['exp_year'] =$_REQUEST['card']['exp_year'];
	$array['country'] =$_REQUEST['card']['country'];
	$array['billing_address1'] =$_REQUEST['card']['address_line1'];
	$array['billing_address2'] =$_REQUEST['card']['address_line2'];
	$array['billing_city'] =$_REQUEST['card']['address_city'];
	$array['billing_state'] =$_REQUEST['card']['address_state'];
	$array['billing_country'] =$_REQUEST['card']['address_country'];
	$array['billing_zip'] =$_REQUEST['card']['address_zip'];
	$array['csv'] =$_REQUEST['csv'];
	$array['client_ip'] =$_REQUEST['client_ip'];
	$array['created'] =$_REQUEST['created'];
	$array['is_default'] =0;
	
	$objDBWrt->Insert($array, "stripe_payment_cards");

}
/*list on stripe payment gateway's credit card */
if(isset($_REQUEST['get_payment_cards'])){
	$mer_id = $_REQUEST['mer_id'];
	$Json =array();
	$memcached->deletekeysbyprefix("get_payment_cards_".$mer_id."_".$_REQUEST['iDisplayStart']);
	$Json = $memcached->get("get_payment_cards_".$mer_id."_".$_REQUEST['iDisplayStart']);
	if(empty($Json)){
			
	/* 
	 * Paging
	 */
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}

	$RS = $objDB->Conn->Execute('select SQL_CALC_FOUND_ROWS * from stripe_payment_cards where merchant_id=? AND customer_id =? order by is_default desc '.$sLimit,array($mer_id,$_SESSION['merchant_info']['stripe_customer_id'])); 
	//echo 'select SQL_CALC_FOUND_ROWS * from stripe_payment_cards where merchant_id='. $mer_id.' AND customer_id ='.$_SESSION['merchant_info']['stripe_customer_id'].' order by is_default desc '.$sLimit;
	$sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
	$total= $sQuery->fields['FOUND_ROWS()'];

	$Json = array();
        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
        $Json['iTotalDisplayRecords'] = $total;
        //$Json['sEcho'] = $_REQUEST['sEcho'];
        //$Json['sSearch'] = $_REQUEST['sSearch'];
        $Json['aaData'] = array();

	if($RS->RecordCount()>0)
		{
			
			$k =0;
			while($Row = $RS->FetchRow())
			{   
			$Json['aaData'][$k][]= $Row['type'];
			$Json['aaData'][$k][]='****'.$Row['card_number'];
			$Json['aaData'][$k][]=$Row['exp_month'].'/'.$Row['exp_year'];
			$Json['aaData'][$k][]=($Row['is_default'] == 1)?'<span class="label label-primary">default</span>':'<span class="label label-default sp_mk_df_card" data-id="'.$Row['id'].'">Make default</span>';
			$Json['aaData'][$k][]='<a href="javascript:void(0);" ><span  class="card_action" cardid="'.$Row['id'].'" data-ac="edit">Edit</span></a>&nbsp;<a href="javascript:void(0);" ><span  class="card_action" cardid="'.$Row['id'].'"  data-ac="delete">Delete</span></a>';
			$k++;
			}
                        
		}
		$memcached->set("get_payment_cards_".$mer_id."_".$_REQUEST['iDisplayStart'],$Json,time() + CACHE_30_MIN);
	}	
	$Json['sEcho'] = $_REQUEST['sEcho'];
	echo json_encode($Json);
         
        exit;

}
/*update stripe card*/
if(isset($_REQUEST['stripe_edit_card'])){
	require_once(LIBRARY . '/stripe-php/config.php');

	$json_array=array();
	$json_array['status'] = "true";
	try {
		//retrive customer
		$customer = \Stripe\Customer::retrieve($_REQUEST['customer_id']);
		//retrive customer's card
		$card = $customer->sources->retrieve($_REQUEST['card_id']);
		$cid = $_REQUEST['id'];
		unset($_REQUEST['customer_id']);
		unset($_REQUEST['card_id']);
		unset($_REQUEST['id']);
		unset($_REQUEST['load']);
		unset($_REQUEST['stripe_edit_card']);
		
		//update card on stripe
		$card->exp_month = $_REQUEST['exp_month'];
		$card->exp_year = $_REQUEST['exp_year'];
		if(!empty($_REQUEST['card_holder_name'])){
			$card->name = $_REQUEST['card_holder_name'];
		}
		$card->address_line1 = $_REQUEST['billing_address1'];
		//$card->address_line2 = $_REQUEST['billing_address2'];
		$card->address_city = $_REQUEST['billing_city'];
		$card->address_zip = $_REQUEST['billing_zip'];
		$card->address_state = $_REQUEST['billing_state'];
		$card->address_country = $_REQUEST['billing_country'];	
		$card->save();
		
		/*$where_clause['customer_id']=$_REQUEST['customer_id'];
		$where_clause['card_id']=$_REQUEST['card_id'];
		$where_clause['merchant_id']=$_SESSION['merchant_id'];*/
		$where_clause['id']=$cid;
		//update card in database
    		$objDBWrt->Update($_REQUEST, "stripe_payment_cards", $where_clause);
	
		
	}catch(Exception $e){
		$json_array['status'] = "false";
		$json_array['serror'] =$e->getMessage();
	}

	echo json_encode($json_array);
	exit;
	
}
/*delete stripe card*/
if(isset($_REQUEST['stripe_delete_card'])){
	//connect with stripe
	require_once(LIBRARY . '/stripe-php/config.php');
	$json_array= array();
	$json_array['status'] = "true";
	$card = $objDB->Conn->Execute("Select * from stripe_payment_cards where merchant_id=? and id=?", array($_SESSION['merchant_id'], $_REQUEST['cid']));

	if ($card->RecordCount() > 0) {
		$c = $card->FetchRow();
		try {
			//retrive custmer
			$customer = \Stripe\Customer::retrieve($c['customer_id']);
			//delete customer card
			$customer->sources->retrieve($c['card_id'])->delete();
			
			$objDBWrt->Conn->Execute("DELETE FROM stripe_payment_cards WHERE merchant_id=? and id=?",array($_SESSION['merchant_id'], $_REQUEST['cid']));
		}catch(Exception $e){
			$json_array['status'] = "false";
			$json_array['serror'] =$e->getMessage();
		}
	}
	echo json_encode($json_array);
	exit;
}

if(isset($_REQUEST['stripe_default_card'])){
	if(isset($_SESSION['merchant_id'])){
		require_once(LIBRARY . '/stripe-php/config.php');
		$json_array= array();
		$card = $objDB->Conn->Execute("Select * from stripe_payment_cards where merchant_id=? and id=?", array($_SESSION['merchant_id'], $_REQUEST['cid']));
		if ($card->RecordCount() > 0) {
			$c = $card->FetchRow();
			try {
				
				//retrive customer
				$customer = \Stripe\Customer::retrieve($c['customer_id']);
				//make default card
				$customer->default_source=$c['card_id'];
				$customer->save();

				//update card in database
				
				$objDBWrt->Conn->Execute("UPDATE stripe_payment_cards SET is_default=? WHERE merchant_id=?",array(0,$_SESSION['merchant_id']));

				$uc['is_default'] =1;
				$where_clause['id']=$_REQUEST['cid'];
				$where_clause['merchant_id']=$_SESSION['merchant_id'];
    			$objDBWrt->Update($uc, "stripe_payment_cards", $where_clause);
    			
			}catch(Exception $e){
				$json_array['serror'] =$e->getMessage();
			}
		}
		$json_array['card_id']=$c['card_id'];
		echo json_encode($json_array);
		exit;
	}else{
		header("Location:".WEB_PATH."/merchant/register.php");
	}
}

if(isset($_REQUEST['stripe_add_new_card'])){
	if(isset($_SESSION['merchant_id'])){
		//error_reporting(E_ALL);
		//ini_set('display_errors', 'On');
		$json_array =array();
		require_once(LIBRARY . '/stripe-php/config.php');

		$myCard = array('name'=>$_REQUEST['card_holder_name'],'number' => $_REQUEST['card_number'], 'exp_month' => $_REQUEST['exp_month'], 'exp_year' => $_REQUEST['exp_year'],'cvc'=>$_REQUEST['cvc'],'address_line1'=>$_REQUEST['billing_address1'],'address_city'=>$_REQUEST['billing_city'],'address_state'=>$_REQUEST['billing_state'],'address_zip'=>$_REQUEST['billing_zip'],'address_country'=>$_REQUEST['billing_country']);


		$tkn = \Stripe\Token::create(array(
		  "card" => $myCard
		));

		$array_where_user['id'] = $_SESSION['merchant_id'];
		$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
		$m_cid = $RS_merchant_User->fields['stripe_customer_id'];
		//echo "".$m_cid;
		$json_array['status'] = "true";
		if(!empty($m_cid)){
			try {
				//$m_cid = "cus_7KAXJ9OXzJ7yCc";
				$customer = \Stripe\Customer::retrieve($m_cid);
				//print_r($customer);
			}catch(Exception $e){
				$json_array['status'] = "false";
				$json_array['serror'] =$e->getMessage();
			}
			
			//check cards already exist or not
			$cardf = array();
			
			foreach($customer->sources->data as $c){

				$cardf[] = $c->fingerprint;
			}
			
			if(!in_array($tkn->card->fingerprint,$cardf)){
				try { 
					$c=$customer->sources->create(array("card" => $tkn->id));
				
				}catch(Exception $e){
					$json_array['status'] = "false";
					$json_array['serror'] =$e->getMessage();
				}
			
			}else{
				$json_array['status'] = "false";
				$json_array['serror'] ="card already exist";
			}

		}else{
			 try { echo "here ".$tkn->id;
                                    // Create a Customer

                                    $cus = \Stripe\Customer::create(array(
                                                    "description" => "Purchase ScanFlip Points",
                                                    "email" => $_SESSION['merchant_info']['email'],
                                                    "card" => $tkn->id // obtained with Stripe.js
                                    ));

                                    $m_cid = $cus->id;

                                    $array['is_default'] = 1;
					
				    $merwhere_clause['id'] = $_SESSION['merchant_id'];
				    $array_mer_up['stripe_customer_id'] = $m_cid;
                                    $SESSION['merchant_info']['stripe_customer_id'] = $m_cid;

                                    $objDBWrt->Update($array_mer_up, "merchant_user", $merwhere_clause);
                            } catch (Exception $e) {
                                    $json_array['status'] = "false";
                                    $json_array['serror'] = $e->getMessage();
                            }
                                            
                }

		if(empty($json_array['serror']) && ($json_array['status'] == 'true')){
			$array['card_id'] = $tkn->card->id;
			$array['merchant_id'] = $_SESSION['merchant_id'];
			$array['card_number'] = $tkn->card->last4;
			$array['type'] =$tkn->card->brand;
			$array['card_holder_name'] = $tkn->card->name;
			$array['exp_month'] =$tkn->card->exp_month;
			$array['exp_year'] =$tkn->card->exp_year;
			$array['country'] =$tkn->card->country;
			$array['billing_address1'] =$tkn->card->address_line1;
			$array['billing_address2'] =$tkn->card->address_line2;
			$array['billing_city'] =$tkn->card->address_city;
			$array['billing_state'] =$tkn->card->address_state;
			$array['billing_country'] =$tkn->card->address_country;
			$array['billing_zip'] =$tkn->card->address_zip;
			$array['cvv'] =$_REQUEST['cvc'];
			$array['client_ip'] =$tkn->client_ip;
			$array['customer_id'] =$m_cid;
			$array['created'] =$tkn->created;
			//print_r($array);
			$objDBWrt->Insert($array, "stripe_payment_cards");
		}
		echo json_encode($json_array);
		exit;

	}
}
/*stripe ipn*/
if(isset($_REQUEST['stripe_events'])){
	//error_reporting(E_ALL);
	//ini_set('display_errors', 'On');
	
	require_once(LIBRARY.'/stripe-php/config.php');
	//echo "ddd";exit;
	// retrieve the request's body and parse it as JSON
	$body = @file_get_contents('php://input');
	$event_json = json_decode($body); 

	// this will be used to retrieve the event from Stripe
	$event_id = $event_json->id;

	if(isset($event_json->id)) {
		// process event here
			try {
 
				// to verify this is a real event, we re-retrieve the event from Stripe 
				//$event = Stripe_Event::retrieve($event_id);
				$event = $event_json;
				//echo "ddd";print_r($event);exit;
				$invoice = $event->data->object;
 				$iid = $invoice->id;
				
 				

				// successful payment
				if($event->type == 'charge.succeeded') {
                                                $customer_id = $invoice->source->customer;
                                                $email = $event_json->data->object->receipt_email;
                                                //$email ='lanetteam.jay@gmail.com';
                                                $currency = $invoice->currency;
                                                $amount = $invoice->amount / 100; // amount comes in as amount in cents, so we need to convert to dollars
					
					$name = $objDB->Conn->Execute("SELECT mu.firstname,mu.lastname,ppo.id,ppo.order_id FROM merchant_user mu inner join purchase_point_order ppo on mu.id=ppo.merchant_id and ppo.transaction_id='$iid' WHERE mu.stripe_customer_id = '$customer_id'");

					if ($name->RecordCount() > 0) {
						$c = $name->FetchRow();
						$fname = $c['firstname'];
						$lname = $c['lastname'];
						$order_id = $c['order_id'];
						$invoice_id = $c['id'];	
					}			
					$url = WEB_PATH."/merchant/print_invoice.php?id=".$invoice_id;
					// send a payment receipt email here
 
					// retrieve the payer's information
						
					$mail_val = $objDB->Conn->Execute("SELECT * FROM emailtemplate WHERE template_key = 'purchase_scanflip_points'");
					if ($mail_val->RecordCount() > 0) {
						$c = $mail_val->FetchRow();
						$mess = $c['value'];
						$subj = $c['subject'];
						
					}									
					$search = array('{FULLNAME}','{AMOUNT}','{TRANSACTION_URL}','{ORDER_ID}','{ASSETS_IMG}');
					$replace = array($fname.' '.$lname,$amount.' '.strtoupper($currency),$url,$order_id,ASSETS_IMG);
					
					$final_message = str_replace($search, $replace, $mess);
					$final_subject = str_replace($search, $replace, $subj); 					
					
					$subject = $final_subject;
					$message = $final_message;
					//$message .= "You have successfully made a payment of $" . $amount ." ".strtoupper($currency). "<br>";
					//$message .= "Please check payment history at ".WEB_PATH."/merchant/payment-cards.php<br>";
					//$message .= "Thank you.";
 
					
				}else if ($event->type == 'charge.failed') { // failed payment
                                        $customer_id = $invoice->source->customer;
                                        $email = $event_json->data->object->receipt_email;
                                        //$email ='lanetteam.jay@gmail.com';
                                        $currency = $invoice->currency;
                                        $amount = $invoice->amount / 100; // amount comes in as amount in cents, so we need to convert to dollars
					// send a failed payment notice email here

					$name = $objDB->Conn->Execute("SELECT mu.firstname,mu.lastname,ppo.id,ppo.order_id FROM merchant_user mu inner join purchase_point_order ppo on mu.id=ppo.merchant_id and ppo.transaction_id='$iid' WHERE mu.stripe_customer_id = '$customer_id'");

					if ($name->RecordCount() > 0) {
						$c = $name->FetchRow();
						$fname = $c['firstname'];
						$lname = $c['lastname'];
						$order_id = $c['order_id'];
						$invoice_id = $c['id'];	
					}			
					//$url = WEB_PATH."/merchant/print_invoice.php?id=".$invoice_id;
					// send a payment receipt email here
 
					// retrieve the payer's information
						
					$mail_val = $objDB->Conn->Execute("SELECT * FROM emailtemplate WHERE template_key = 'payment_failed'");
					if ($mail_val->RecordCount() > 0) {
						$c = $mail_val->FetchRow();
						$mess = $c['value'];
						$subj = $c['subject'];
						
					}									
					$search = array('{FULLNAME}','{AMOUNT}','{TRANSACTION_URL}','{ORDER_ID}','{ASSETS_IMG}');
					$replace = array($fname.' '.$lname,$amount.' '.strtoupper($currency),$url,$order_id,ASSETS_IMG);
					
					$final_message = str_replace($search, $replace, $mess);
					$final_subject = str_replace($search, $replace, $subj); 					
					
					$subject = $final_subject;
					$message = $final_message;

					
				}else if ($event->type == 'customer.source.created') { // customer card created
					 $customer_id = $invoice->source->customer;
                                        //$email = $event_json->data->object->receipt_email;
					$card_id = $invoice->id;
                    $email ='lanetteam.jay@gmail.com';

					$name = $objDB->Conn->Execute("SELECT mu.firstname,mu.lastname,spc.id,spc.card_number,spc.type,spc.card_holder_name FROM merchant_user mu inner join stripe_payment_cards spc on mu.id=spc.merchant_id and spc.card_id='$card_id' WHERE spc.customer_id = '$customer_id'");

					if ($name->RecordCount() > 0) {
						$c = $name->FetchRow();
						$fname = $c['firstname'];
						$lname = $c['lastname'];
						$last4 = $c['card_number'];
						$card_holder_name = $c['card_holder_name'];
						$type = $c['type'];
			
					}			
					$url = WEB_PATH."/merchant/payment-cards.php";
					
					$mail_val = $objDB->Conn->Execute("SELECT * FROM emailtemplate WHERE template_key = 'card_created'");
					if ($mail_val->RecordCount() > 0) {
						$c = $mail_val->FetchRow();
						$mess = $c['value'];
						$subj = $c['subject'];
						
					}									
					$search = array('{FULLNAME}','{BRAND}','{LAST4}','{CARD_HOLDER_NAME}','{CARD_URL}','{ASSETS_IMG}');
					$replace = array($fname.' '.$lname,$type,$last4,$card_holder_name,$url,ASSETS_IMG);
					
					$final_message = str_replace($search, $replace, $mess);
					$final_subject = str_replace($search, $replace, $subj); 					
					
					$subject = $final_subject;
					$message = $final_message;


				}else if ($event->type == 'customer.source.updated') { // customer card updated
					$customer_id = $invoice->source->customer;
                    $email = $event_json->data->object->receipt_email;
					$card_id = $invoice->id;
					$address_city = $invoice->address_city;
					$address_country = $invoice->address_country;
					$address_line1 = $invoice->address_line1;
					$address_line2 = $invoice->address_line2;
					$address_state = $invoice->address_state;
					$address_zip = $invoice->address_zip;
					$country = $invoice->country;
					$customer_id = $invoice->customer;
					$exp_month = $invoice->exp_month;
					$exp_year = $invoice->exp_year;
                    //$email ='lanetteam.jay@gmail.com';

					$name = $objDB->Conn->Execute("SELECT mu.firstname,mu.lastname,spc.id,spc.card_number,spc.type,spc.card_holder_name FROM merchant_user mu inner join stripe_payment_cards spc on mu.id=spc.merchant_id and spc.card_id='$card_id' WHERE spc.customer_id = '$customer_id'");

					if ($name->RecordCount() > 0) {
						$c = $name->FetchRow();
						$fname = $c['firstname'];
						$lname = $c['lastname'];
						$last4 = $c['card_number'];
						$card_holder_name = $c['card_holder_name'];
						$type = $c['type'];
			
					}			
					$url = WEB_PATH."/merchant/payment-cards.php";
					
					$mail_val = $objDB->Conn->Execute("SELECT * FROM emailtemplate WHERE template_key = 'card_update'");
					if ($mail_val->RecordCount() > 0) {
						$c = $mail_val->FetchRow();
						$mess = $c['value'];
						$subj = $c['subject'];
						
					}									
					$search = array('{FULLNAME}','{BRAND}','{LAST4}','{CARD_HOLDER_NAME}','{CARD_URL}','{ASSETS_IMG}');
					$replace = array($fname.' '.$lname,$type,$last4,$card_holder_name,$url,ASSETS_IMG);
					
					$final_message = str_replace($search, $replace, $mess);
					$final_subject = str_replace($search, $replace, $subj); 					
					
					$subject = $final_subject;
					$message = $final_message;
					
					$query_update = $objDB->Conn->Execute("UPDATE stripe_payment_cards SET 
					exp_month='".$exp_month."',
					exp_year='".$exp_year."',
					billing_address1='".$address_line1."' ,
					billing_address2='".$address_line2."' ,
					billing_city='".$address_city."' ,
					billing_zip='".$address_zip."' ,
					billing_state='".$address_state."' ,
					billing_country='".$address_country."' ,
					country ='".$country."' 
					WHERE
					card_id='".$card_id."' && customer_id='".$customer_id."'");
					//echo "UPDATE stripe_payment_cards SET exp_month='".$exp_month."' ,exp_year='".$exp_year."' ,billing_address1='".$address_line1."' ,billing_address2='".$address_line2."' ,billing_city='".$address_city."' ,billing_zip='".$address_zip."' ,billing_state='".$address_state."' ,billing_country='".$address_country."' ,country ='".$country."' WHERE card_id='".$card_id."' && customer_id='".$customer_id."'";
					//echo "Card==".$card_id." ".$country;			
					
				}else if ($event->type == 'customer.source.deleted') { // customer card deleted

					
					$customer_id = $invoice->source->customer;
					$email = $event_json->data->object->receipt_email;
					$card_id = $invoice->id;
                   // $email ='sangeeta.lanetteam@gmail.com';
					
					$mail_val = $objDB->Conn->Execute("SELECT * FROM emailtemplate WHERE template_key = 'card_delete'");
					
					
					
					if ($mail_val->RecordCount() > 0) {
						$c = $mail_val->FetchRow();
						$mess = $c['value'];
						$subj = $c['subject'];
						
					}									
					$search = array('{CARD_ID}','{ASSETS_IMG}');
					$replace = array($card_id,ASSETS_IMG);
					
					$final_message = str_replace($search, $replace, $mess);
					$final_subject = str_replace($search, $replace, $subj); 					
					//echo $final_message." ".$final_subject;
					$subject = $final_subject;
					$message = $final_message;
					$query_d = $objDB->Conn->Execute("DELETE FROM stripe_payment_cards WHERE card_id='".$card_id."'");
					//echo "DELETE FROM stripe_payment_cards WHERE card_id='".$card_id."'";
					
				}else if ($event->type == 'customer.subscription.created') { // customer subscription created

                                        $customer_id = $invoice->customer;
                                        $plan_name = $invoice->plan->name;
                                        $plan_amount = $invoice->plan->amount/100;
                                        $plan_currency = $invoice->plan->currency;
                                        $plan_interval = $invoice->plan->interval;
                                        $start_date = date("Y-m-d",$invoice->start);
                                        $end_date = $invoice->ended_at;
                                        if(!empty($end_date)){
                                                $end_date = date("Y-m-d",$invoice->ended_at);
                                        }
                                        
                                        $name = $objDB->Conn->Execute("SELECT mu.firstname,mu.lastname,mu.email FROM merchant_user mu  WHERE mu.stripe_customer_id = '$customer_id'");

					if ($name->RecordCount() > 0) {
						$c = $name->FetchRow();
						$fname = $c['firstname'];
						$lname = $c['lastname'];
                                                $email = $c['email'];
					}
                                        
					
                    $mail_val = $objDB->Conn->Execute("SELECT * FROM emailtemplate WHERE template_key = 'subscription_success'");
					if ($mail_val->RecordCount() > 0) {
						$c = $mail_val->FetchRow();
						$mess = $c['value'];
						$subj = $c['subject'];
						
					}									
					$search = array('{FULLNAME}','{PLAN}','{START_DATE}','{END_DATE}','{AMOUNT}','{ASSETS_IMG}');
					$replace = array($fname.' '.$lname,$plan_name,$start_date,$end_date,$plan_amount.' '.strtoupper($currency),ASSETS_IMG);
					
					$final_message = str_replace($search, $replace, $mess);
					$final_subject = str_replace($search, $replace, $subj); 					
					
					$subject = $final_subject;
					$message = $final_message;
                                        
				}else if ($event->type == 'customer.subscription.updated') { // customer subscription updated

					$customer_id = $invoice->customer;
                                        $plan_name = $invoice->plan->name;
                                        $plan_amount = $invoice->plan->amount/100;
                                        $plan_currency = $invoice->plan->currency;
                                        $plan_interval = $invoice->plan->interval;
                                        $start_date = date("Y-m-d",$invoice->start);
                                        $end_date = $invoice->ended_at;
                                        if(!empty($end_date)){
                                                $end_date = date("Y-m-d",$invoice->ended_at);
                                        }
                                        
                                        $name = $objDB->Conn->Execute("SELECT mu.firstname,mu.lastname,mu.email FROM merchant_user mu  WHERE mu.stripe_customer_id = '$customer_id'");

					if ($name->RecordCount() > 0) {
						$c = $name->FetchRow();
						$fname = $c['firstname'];
						$lname = $c['lastname'];
                                                $email = $c['email'];
						$email = 'sangeeta.lanetteam@gmail.com';
					}
                                        
					// send a failed payment notice email here
                                        $mail_val = $objDB->Conn->Execute("SELECT * FROM emailtemplate WHERE template_key = 'subscription_updated'");
					if ($mail_val->RecordCount() > 0) {
						$c = $mail_val->FetchRow();
						$mess = $c['value'];
						$subj = $c['subject'];
						
					}									
					$search = array('{FULLNAME}','{PLAN}','{START_DATE}','{END_DATE}','{AMOUNT}','{ASSETS_IMG}');
					$replace = array($fname.' '.$lname,$plan_name,$start_date,$end_date,$plan_amount.' '.strtoupper($plan_currency),ASSETS_IMG);
					
					$final_message = str_replace($search, $replace, $mess);
					$final_subject = str_replace($search, $replace, $subj); 					
					
					$subject = $final_subject;
					$message = $final_message;

				}else if ($event->type == 'customer.subscription.deleted') { // customer subscription deleted

					// send a failed payment notice email here

					$subject = 'Payment Failed';
					$message = "Hello Customer<br>";
					$message .= "Oops! Your latest payment failed of $" . $amount . " " . strtoupper($currency) . "<br>";
					$message .= "Please check payment history at " . WEB_PATH . "/merchant/payment-cards.php<br>";
					$message .= "Thank you.";
				}else if ($event->type == 'customer.subscription.trial_will_end') { // customer subscription trial will end

					// send a failed payment notice email here

					$subject = 'Payment Failed';
					$message = "Hello Customer<br>";
					$message .= "Oops! Your latest payment failed of $" . $amount . " " . strtoupper($currency) . "<br>";
					$message .= "Please check payment history at " . WEB_PATH . "/merchant/payment-cards.php<br>";
					$message .= "Thank you.";
				}else if ($event->type == 'plan.created') { // plan created

					$email  = 'sangeeta.lanetteam@gmail.com';
					$fname = 'Admin';
					$lname ='';

					$name = $invoice->name;
					$amount = $invoice->amount/100;
					$interval = $invoice->interval;
					if($invoice->interval_count == 3){
						$interval = 'Quarter';
					}
					$currency = $invoice->currency;
					$trial_period_days = $invoice->trial_period_days;
					
					$mail_val = $objDB->Conn->Execute("SELECT * FROM emailtemplate WHERE template_key = 'plan_created'");
					if ($mail_val->RecordCount() > 0) {
						$c = $mail_val->FetchRow();
						$mess = $c['value'];
						$subj = $c['subject'];
						$search = array('{FULLNAME}','{PLAN}','{AMOUNT}','{INTERVAL}','{TRIAL_DAYS}','{ASSETS_IMG}');
						$replace = array($fname.' '.$lname,$name,$amount.' '.strtoupper($currency),$interval,$trial_period_days,ASSETS_IMG);
						$final_message = str_replace($search, $replace, $mess);
						$final_subject = str_replace($search, $replace, $subj); 					
						$subject = $final_subject;
						$message = $final_message;
					}
				}else if ($event->type == 'plan.updated') { // plan updated
					$email  = 'sangeeta.lanetteam@gmail.com';
					$fname = 'Admin';
					$lname ='';
					$name = $invoice->name;
					$mail_val = $objDB->Conn->Execute("SELECT * FROM emailtemplate WHERE template_key = 'plan_updated'");
					if ($mail_val->RecordCount() > 0) {
						$c = $mail_val->FetchRow();
						$mess = $c['value'];
						$subj = $c['subject'];
						
						$search = array('{FULLNAME}','{PLAN}','{ASSETS_IMG}');
						$replace = array($fname.' '.$lname,$name,ASSETS_IMG);
					
						$final_message = str_replace($search, $replace, $mess);
						$final_subject = str_replace($search, $replace, $subj); 					
					
						$subject = $final_subject;
						$message = $final_message;
					}

				}else if ($event->type == 'plan.deleted') { //plan deleted
					$email  = 'sangeeta.lanetteam@gmail.com';
					$fname = 'Admin';
					$lname ='';

					$name = $invoice->name;
					
					$mail_val = $objDB->Conn->Execute("SELECT * FROM emailtemplate WHERE template_key = 'plan_deleted'");
					if ($mail_val->RecordCount() > 0) {
						$c = $mail_val->FetchRow();
						$mess = $c['value'];
						$subj = $c['subject'];
						
						$search = array('{FULLNAME}','{PLAN}','{ASSETS_IMG}');
						$replace = array($fname.' '.$lname,$name,ASSETS_IMG);
					
						$final_message = str_replace($search, $replace, $mess);
						$final_subject = str_replace($search, $replace, $subj); 					
					
						$subject = $final_subject;
						$message = $final_message;
					}
				}

				//send mail 
				$mail = new PHPMailer();
				$body = $event_json;
				$mail->From = "no-reply@scanflip.com";
				$mail->FromName = "ScanFlip Support";
				$mail->AddReplyTo('no-reply@scanflip.com','ScanFlip Support');
				$mail->AddAddress($email);
				$mail->Subject = $subject;
				$mail->MsgHTML($message);
				$mail->Send();
 
			} catch (Exception $e) {
				// something failed, perhaps log a notice or email the site admin
			}
		
	}
}

if(isset($_REQUEST['check_object_in_memcached']))
{
	$var = $_REQUEST['var'];
	$mc = new Memcached();
	$mc->addServer("127.0.0.1", 11211);

	$result = $mc->get($var);
	//var_dump($result);
	if ($result) 
	{
		//echo $result;
		$json_array =array();
		$json_array['status'] = "true";
		$json_array['result'] = $result;
		echo json_encode($json_array);
		exit;
	} 
	else 
	{
		$json_array =array();
		$json_array['status'] = "false";
		$json_array['result'] = "";
		echo json_encode($json_array);
		exit;
	}
}

if(isset($_REQUEST['store_object_in_memcached']))
{
	$var = $_REQUEST['var'];
	$value = $_REQUEST['value'];
	//$time = $_REQUEST['time'];
	$mc = new Memcached();
	$mc->addServer("127.0.0.1", 11211);
	
	$mc->set($var,$value,time() + 300); // for 5 minutes 
	
	/*
	$st = time();
	echo "current ".date("Y-m-d g:i:s A",$st)."<br/>";

	$st1 = $st+300*1;
	echo "5 minute ".date("Y-m-d g:i:s A",$st1)."<br/>";

	$st2 = $st+300*2;
	echo "10 minute ".date("Y-m-d g:i:s A",$st2)."<br/>";

	$st3 = $st+300*3;
	echo "15 minute ".date("Y-m-d g:i:s A",$st3)."<br/>";
	*/
	
	$json_array =array();
	$json_array['status'] = "true";
	echo json_encode($json_array);
	exit;
}
/* stripe subscription for merchant*/
if(isset($_REQUEST['subscribe_plan'])){

	$json_array =array();
	$json_array['status'] = "true";
	if(isset($_SESSION['merchant_id'])){

		$json_array['status'] = "true";
		require_once(LIBRARY.'/stripe-php/config.php');	
		
		$array_where_user['id'] = $_SESSION['merchant_id'];
		$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
		$m_cid = $RS_merchant_User->fields['stripe_customer_id'];

		if($RS_merchant_User->fields['country'] == 'USA'){
			$currency = 'USD';
		}else{
			$currency = 'CAD';
		}

		$plan = $objDB->Conn->Execute("Select * from billing_packages where id=?", array($_REQUEST['pid']));
		if ($plan->RecordCount() > 0) {
			$p =$plan->FetchRow();
			$ret_plan['perror'] ='';
			$ret_plan['status'] = "true";
			//create plan if not exist			
			try{
				$exist_plan = \Stripe\Plan::retrieve(strtolower($p['slug']));
				
				/*if(!empty($exist_plan)){
					$ret_plan['status'] = "false";
				}*/
					
			} catch (Exception $e) {
                                    /*$ret_plan['status'] = "true";
                                    $ret_plan['perror'] = $e->getMessage();*/
				$json_array['status'] = "false";
		                            $json_array['serror'] = $e->getMessage();
                        }
			
			/*if(!empty($ret_plan['perror']) && $ret_plan['status'] == 'true'){
				try{
					/*$metadata = array(
							'location'=>$p['no_of_loca'],
							'active_campaign_per_locaion'=>$p['no_of_active_camp_per_loca'],
							'total_campaign_per_month'=>$p['total_no_of_camp_per_month'],
							'coupon_transaction_fee'=>$p['transaction_fees'],
							'enable_coupon_redeemption_fee'=>$p['enable_coupon_redeemption_fee'],
							'min_share_point'=>$p['min_share_point'],
							'min_reward_point'=>$p['min_reward_point'],
							'active_loyalty_cards'=>$p['active_loyalty_cards'],
							'enable_coupon_redeemption_fee'=>$p['enable_coupon_redeemption_fee'],
							'transaction_fees_stamp'=>$p['transaction_fees_stamp']
						);*/
						/*$s_plan = \Stripe\Plan::create(array(
						  "amount" => $p['price']*100,
						  "interval" => "month",
						  "name" => $p['pack_name'],
						  "currency" => $p['currency'],
						  //"metadata"=>$metadata,
						  "id" => strtolower($p['slug']))
						);
							
				} catch (Exception $e) {
		                            $json_array['status'] = "false";
		                            $json_array['serror'] = $e->getMessage();
		                }

			}*/

			if(!empty($m_cid)){
			
				try{
					$cu = \Stripe\Customer::retrieve($m_cid);
					
					$awu['merchant_id'] = $_SESSION['merchant_id'];
					$RS_mb = $objDB->Show("merchant_billing", $awu);
					if($RS_mb->RecordCount()>0){
					$subscription_id = $RS_mb->fields['subscription_id'];
					}else{
						$subscription_id = '';
					}

					if(empty($subscription_id)){ //if subscription not found

						$response = $cu->subscriptions->create(array("plan" => strtolower($p['slug'])));
						$subscription_id= $response->id;

					}else{ // change subscription plan

						$subscription = $cu->subscriptions->retrieve($subscription_id);
						$subscription->plan = strtolower($p['slug']);
						$subscription->save();
					}
					$json_array['plan'] =$p;
					$json_array['plan']['total_no_of_campaign'] = $RS_merchant_User->fields['total_no_of_campaign'];

				} catch (Exception $e) {
		                            $json_array['status'] = "false";
		                            $json_array['serror'] = $e->getMessage();
		                }

				if(empty($json_array['serror'])){

						 $array_where_mb['merchant_id'] = $_SESSION['merchant_id'];
						 //$RS_mb = $objDB->Show("merchant_billing", $array_where_mb);

				    		 $array_mer_up['pack_id'] = $_REQUEST['pid'];
						 $array_mer_up['subscription_id'] = $subscription_id;
						 $array_mer_up['is_canceled'] =0;
			                    	
			                    	 $objDBWrt->Update($array_mer_up, "merchant_billing", $array_where_mb);
					   			
				}
		
			}
		}
	
	}

	echo json_encode($json_array);
	exit;
	
}
//cancel stripe subscription
if(isset($_REQUEST['cancel_stripe_subcription'])){
	$at_period_end = $_REQUEST['at_period_end'];
	$json_array['status'] = "false";
	if(isset($_SESSION['merchant_id'])){

		$json_array['status'] = "true";
		require_once(LIBRARY.'/stripe-php/config.php');	

		$awu['merchant_id'] = $_SESSION['merchant_id'];

		$RS_merchant_User = $objDB->Show("merchant_user", $array_where_user);
		$m_cid = $RS_merchant_User->fields['stripe_customer_id'];

		$RS_mb = $objDB->Show("merchant_billing", $awu);
		$subscription_id = $RS_mb->fields['subscription_id'];

		try{
			$cu = \Stripe\Customer::retrieve($m_cid);
			$subscription = $cu->subscriptions->retrieve($subscription_id)->cancel(array('at_period_end'=>$at_period_end));

			
			$array_where_mb['merchant_id'] = $_SESSION['merchant_id'];
			$array_where_mb['pack_id'] = $_REQUEST['sid'];
			
			if($at_period_end == 'true'){ //update subscription in database
	    		        $array_where_mb['subscription_id'] = $subscription_id;
				$array_mer_up['is_canceled'] =1;
			                    	
			        $objDBWrt->Update($array_mer_up, "merchant_billing", $array_where_mb); 
			}else{
				$array_mer_up['pack_id'] = 0;
				$array_mer_up['subscription_id'] = '';
				$array_mer_up['is_canceled'] =0;
				$objDBWrt->Update($array_mer_up, "merchant_billing", $array_where_mb); 
			}

		} catch (Exception $e) {
                            $json_array['status'] = "false";
                            $json_array['serror'] = $e->getMessage();
                }

	}
	echo json_encode($json_array);
	exit;
}
//add gift card in manage reward zone
if(isset($_REQUEST['btnAddGiftCard'])){

    if($_SESSION['merchant_id']){
		
		$array = array();
		if(!empty($_SESSION['merchant_info']['currrency_symbol'])){
			$curr = $_SESSION['merchant_info']['currrency_symbol'];		
		}else{ $curr = $_SESSION['merchant_info']['currency_code']; }

		/*$currency = $objDB->Conn->Execute("select currency_code from currencies where country_name=?",array($_SESSION['merchant_info']['country']));*/

		//$array['title'] = $_REQUEST['title'];
		$array['title'] = $_SESSION['merchant_info']['business'].' '.$curr.$_REQUEST['giftcard_value'].' Gift Card ';	
		if($_REQUEST['hdn_image_path'] == "")
		{
			$array['image'] = "";
		}
		else
		{		
			$array['image'] = trim($_REQUEST['hdn_image_path']);	
		}

		$array['merchant_id'] = $_SESSION['merchant_id'];
	
		$array['category_id'] = $_REQUEST['category_id'];
		$array['card_value'] = $_REQUEST['giftcard_value'];
		$array['discount'] = $_REQUEST['giftcard_disc_value'];

		$array['keywords'] = $_REQUEST['keywords'];
		$array['description'] = $_REQUEST['description'];
		$array['is_merchant'] = 1;
		$array['ship_to'] = $_SESSION['merchant_info']['country'];
		$array['is_active'] = 0;
		$array['created'] =date('Y-m-d H:i:s');
		if($_REQUEST['is_per'] == 'per')
		{
			$array['is_per'] = 1;
		}else{
			$array['is_per'] = 0;
		}
		
		$objDBWrt->Insert($array, "giftcards");	
		$memcached->deletekeysbyprefix("get_gift_cards_".$_SESSION['merchant_id']."_");
		$_SESSION['msg'] = "Gift Card has been added successfully.";
		header("Location: manage-reward-zone.php");
		exit();
	}

}

// update gift card in manage reward zone.
if(isset($_REQUEST['btnUpdateGiftCard'])){
	
	if($_SESSION['merchant_id']){
		
         $array = array();
		//$array['title'] = $_REQUEST['title'];	
		/*$currency = $objDB->Conn->Execute("select currency_code from currencies where country_name=?",array($_SESSION['merchant_info']['country']));*/
            
		if(!empty($_SESSION['merchant_info']['currrency_symbol'])){
			$curr = $_SESSION['merchant_info']['currrency_symbol'];		
		}else{ $curr = $_SESSION['merchant_info']['currency_code']; }

		//$array['title'] = $_SESSION['merchant_info']['business'].' '.$curr.$_REQUEST['giftcard_value'].' Gift Card ';
		if($_REQUEST['hdn_image_path'] == "")
		{
			$array['image'] = "";
		}
		else
		{		
			$array['image'] = trim($_REQUEST['hdn_image_path']);	
		}

		$array_w['merchant_id'] = $_SESSION['merchant_id'];
		$array_w['id'] = $_REQUEST['id'];
	
		$array['category_id'] = $_REQUEST['category_id'];
		if(isset($_REQUEST['giftcard_value'])){
			$array['card_value'] = $_REQUEST['giftcard_value'] ;
		}
		$array['discount'] = $_REQUEST['giftcard_disc_value'] ;

		$array['keywords'] = $_REQUEST['keywords'];
		$array['description'] = $_REQUEST['description'];
		$array['is_per'] = $_REQUEST['is_per'];
             
                
		
		$objDBWrt->Update($array, "giftcards",$array_w);
                $memcached->deletekeysbyprefix("get_gift_cards_".$_SESSION['merchant_id']."_");
		$_SESSION['msg'] = "Gift Card has been updated successfully.";
		header("Location: manage-reward-zone.php");
		exit();
	}
}

//delete gift card from manage reward zone
if(isset($_REQUEST['del_rewardzone_giftcard']))
{
	if($_SESSION['merchant_id']){
		$array_w['merchant_id'] = $_SESSION['merchant_id'];
		$array_w['id'] = $_REQUEST['id'];
		$array['is_deleted'] = 1;
		$objDBWrt->Update($array,"giftcards",$array_w);
        $memcached->deletekeysbyprefix("get_gift_cards_".$_SESSION['merchant_id']."_");

		//$objDBWrt->Remove("giftcards",$array_w);

		echo 1;	
	}else{
		echo 0;	
	}

	
}
//active deactive giftcard of reward zone
if(isset($_REQUEST['activ_deactiv_rewardzone_giftcard'])){
	if($_SESSION['merchant_id']){

		$pack = $objDB->Conn->Execute('SELECT mb.id,mb.merchant_id,mb.pack_id,b.pack_name,b.reward_zone_active_campaign,b.reward_zone_active_gift_card FROM merchant_billing mb Inner join billing_packages b on b.id=mb.pack_id and mb.merchant_id=?', array($_SESSION['merchant_id']));
$reward_zone_active_gift_card = $pack->fields['reward_zone_active_gift_card'];
//$limit_reward_zone_active_campaign = $pack->fields['reward_zone_active_campaign'];

		$RS = $objDB->Conn->Execute('select count(id) as total from giftcards where merchant_id=? AND is_deleted=? AND is_active=? '.$sLimit,array($_SESSION['merchant_id'],0,1));
		$total_reward_zone_active_gift_card = $RS->fields['total'];
		
		if(($_REQUEST['active'] == 1) && ($reward_zone_active_gift_card <= $total_reward_zone_active_gift_card)){
			echo 0;
		}else{
			$array_w['merchant_id'] = $_SESSION['merchant_id'];
			$array_w['id'] = $_REQUEST['id'];
			if($_REQUEST['active'] == 1)
			{
			$array['is_edited'] = 1;
			}
			$array['is_active'] = $_REQUEST['active'];
			$objDBWrt->Update($array,"giftcards",$array_w);
			$memcached->deletekeysbyprefix("get_gift_cards_".$_SESSION['merchant_id']."_");
			echo 1;	
		}
	}else{
		echo 0;	
	}
}
//display list of gift card of manage reward zone.
if(isset($_REQUEST['get_gift_cards'])){
	$mer_id = $_REQUEST['mer_id'];
	$Json =array();
	$Json = $memcached->get("get_gift_cards_".$mer_id."_".$_REQUEST['iDisplayStart']);
        //echo "cache memory";
	if(empty($Json)){
			
	/* 
	 * Paging
	 */
	$sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'];
	}

	/*if(isset($_REQUEST['card_filter_year'])){
                        
                             $where .= ' AND created LIKE  "%'.$_REQUEST['card_filter_year'].'%"';   
                        
                        
                }else{
                        $where .=" AND created LIKE '%".date('Y')."%'";
                        
                }*/

	//echo 'select SQL_CALC_FOUND_ROWS * from giftcards where merchant_id=? '.$where;exit;
	$RS = $objDB->Conn->Execute('select SQL_CALC_FOUND_ROWS * from giftcards where merchant_id=? AND is_deleted=? ORDER BY modified DESC '.$sLimit,array($mer_id,0)); 
        $sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
	$total= $sQuery->fields['FOUND_ROWS()'];
	$Json = array();
        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
        $Json['iTotalDisplayRecords'] = $total;
       
        $Json['aaData'] = array();
	
	if($RS->RecordCount()>0)
		{
	
			$k =0;
			while($Row = $RS->FetchRow())
			{  
				$act = 'Publish';
				if($Row['is_active'] == 1){
					$act = 'Unpublish';
					$del = '<span class ="camp_action">Delete</span>';
				}else{
					$del = '<a href="javascript:void(0);" ><span  class="card_action" data-cardid="'.$Row['id'].'"  data-ac="delete">Delete</span></a>';
				}	
			 
			$Json['aaData'][$k][]= $Row['title'];
			$Json['aaData'][$k][]=($Row['is_active'] == 1)?'<span class="label label-primary">Published</span>':'<span class="label label-primary">Not Published</span>';
			
                        $Json['aaData'][$k][]='<a href="/merchant/edit-gift-card.php?id='.$Row['id'].'" ><span  class="card_action" data-cardid="'.$Row['id'].'" data-ac="edit">Edit</span></a>&nbsp;'.$del.'&nbsp;<a href="javascript:void(0);" ><span  class="card_action" data-cardid="'.$Row['id'].'"  data-ac="activ_deactiv" data-active="'.$Row['is_active'].'">'.$act.'</span></a>';
                        
                       
                        $k++;
			}        
		}
		$memcached->set("get_gift_cards_".$mer_id."_".$_REQUEST['iDisplayStart'],$Json,time() + CACHE_30_MIN);
	}	
	$Json['sEcho'] = $_REQUEST['sEcho'];
	echo json_encode($Json);
        exit;

}
/**
 *
 * add new campaign to reward zone
 */
if(isset($_REQUEST['btnRewardAddCampaigns'])){
       
        $rcampp =array();
        $rcampp['merchant_id'] =$_SESSION['merchant_id'];
        $rcampp['title'] =$_REQUEST['title'];
        $rcampp['image'] =$_REQUEST['hdn_image_path'];
        $rcampp['keywords'] =$_REQUEST['campaign_tag'];
        $rcampp['value'] =$_REQUEST['deal_value'];
        $rcampp['discount'] =$_REQUEST['campaign_disc_value'];
        $rcampp['category_id'] =$_REQUEST['category_id'];
        $rcampp['is_percentage'] =$_REQUEST['is_per'];
        $rcampp['description'] =$_REQUEST['description'];
        $rcampp['terms_cond'] =$_REQUEST['terms_condition'];
        $rcampp['created'] =date('Y-m-d H:i:s');
        $rcampp['is_deleted'] =0;
        $rcampp['active'] =0;
       // $rcampp['start_date'] =date('Y-m-d H:i:s');
      //  $rcampp['expiration_date'] =date('Y-m-d H:i:s',strtotime('1 year'));

        $objDBWrt->Insert($rcampp, "rewardzone_campaigns");	
        $memcached->deletekeysbyprefix("get_rewardzone_campaigns_".$_SESSION['merchant_id']."_");
	$_SESSION['msg'] = "Reward zone campaign has been added successfully.";
	header("Location: manage-reward-zone.php/#campaign");
	exit();
        
}

/**
 *
 * edit new campaign to reward zone
 */
if(isset($_REQUEST['btneditRewardAddCampaigns'])){
        
        $rcampp =array();
        
        $rcampp['title'] =$_REQUEST['title'];
        $rcampp['image'] =$_REQUEST['hdn_image_path'];
        $rcampp['keywords'] =$_REQUEST['campaign_tag'];
	if(isset($_REQUEST['deal_value'])){
        	$rcampp['value'] =$_REQUEST['deal_value'];
	}
        $rcampp['discount'] =$_REQUEST['campaign_disc_value'];
        $rcampp['category_id'] =$_REQUEST['category_id'];
        $rcampp['is_percentage'] =$_REQUEST['is_per'];
        if($_REQUEST['is_per'] === 'per')
        {
                $rcampp['is_percentage'] == 1;
        }else{
                $rcampp['is_percentage'] == 0;
        }
        $rcampp['description'] =$_REQUEST['description'];
        $rcampp['terms_cond'] =$_REQUEST['terms_condition'];
        
        $campp['id'] =$_REQUEST['id'];
        $campp['merchant_id'] =$_SESSION['merchant_id'];
        $campp['is_deleted'] =0;
        //print_r($rcampp);exit;
        
        $objDBWrt->Update($rcampp, "rewardzone_campaigns",$campp);	
	$_SESSION['msg'] = "Reward zone campaign has been updated successfully.";
	header("Location: manage-reward-zone.php/#campaign");
	exit();
        
}
/**
 * Get list of reward zone campaign
 */
if(isset($_REQUEST['get_rewardzone_campaigns'])){
//$memcached->deletekeysbyprefix("get_rewardzone_campaigns_".$_SESSION['merchant_id']."_");
        $mer_id = $_REQUEST['mer_id'];
	$Json =array();
        //$mc = new Cache("get_rewardzone_campaigns_");
        //$keys = $mc->getAllKeys();
        //print_r($keys);exit;
        
        $Json = $memcached->get("get_rewardzone_campaigns_".$mer_id."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['camp_filter_year']."_".$_REQUEST['camp_filter_category']."_".$_REQUEST['camp_filter_status']);
	if(empty($Json)){
			
                /* 
                 * Paging
                 */
                $sLimit = "";
                if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
                {
                        $sLimit = "LIMIT ".$_REQUEST['iDisplayStart'].", ".$_REQUEST['iDisplayLength'];
                }
                $where = '';
                if(isset($_REQUEST['camp_filter_status']) && ($_REQUEST['camp_filter_status'] < 2)){
                        $where = 'active='.$_REQUEST['camp_filter_status'];
                }else{
                        //$where = 'r.expiration_date < "'.date('Y-m-d H:i:s').'"';
							$where = 1;
                }
             
                if(isset($_REQUEST['camp_filter_category']) && !empty($_REQUEST['camp_filter_category'])){
                        $where .= ' AND category_id='.$_REQUEST['camp_filter_category'];
                }
                
                if(isset($_REQUEST['camp_filter_year'])){
                        if(isset($_REQUEST['camp_filter_month']) && !empty($_REQUEST['camp_filter_month'])){
                             $where .= ' AND created LIKE  "%'.$_REQUEST['camp_filter_year'].'-'.$_REQUEST['camp_filter_month'].'%"';  
                        }else{
                             $where .= ' AND created LIKE  "%'.$_REQUEST['camp_filter_year'].'%"';   
                        }
                        
                }else{
                        $where .=" AND created LIKE '%".date('Y')."%'";
                        
                }
                //echo 'select SQL_CALC_FOUND_ROWS * from rewardzone_campaigns r where '.$where.' AND r.merchant_id='.$mer_id.' AND r.is_deleted=0';exit;
                
                $RS = $objDB->Conn->Execute('select SQL_CALC_FOUND_ROWS * from rewardzone_campaigns r where '.$where.' AND r.merchant_id=? AND r.is_deleted=? '.$sLimit,array($mer_id,0)); 
		
                $sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");

                $total= $sQuery->fields['FOUND_ROWS()'];

                $Json = array();
                $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
                $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
                $Json['iTotalDisplayRecords'] = $total;

                $Json['aaData'] = array();
		
		if(!empty($_SESSION['merchant_info']['currrency_symbol'])){
			$curr = $_SESSION['merchant_info']['currrency_symbol'];		
		}else{ $curr = $_SESSION['merchant_info']['currency_code']; }
		
                if($RS->RecordCount()>0)
                        {

                                $k =0;
                                while($Row = $RS->FetchRow())
                                {  
				//print_r($Row);
                                        $act = 'Publish';
					$published = 'Not Published';
                                        if($Row['active'] == 1){
                                                $act = 'Unpublish';
						$published = 'Published';
						$del = '<span class ="camp_action">Delete</span>';

                                        }else{
						$del = 	'<a href="javascript:void(0);" ><span  class="camp_action" data-campid="'.$Row['id'].'"  data-ac="delete">Delete</span></a>';	
					}	

                                        $Json['aaData'][$k][]= $Row['title'];
                                        $Json['aaData'][$k][]= '<span class="label label-primary">'.$published.'</span>';
                                        $Json['aaData'][$k][]= $curr.$Row['value'];
                                        //$Json['aaData'][$k][]=($Row['active'] == 1)?'<span class="label label-primary">Active</span>':'<span class="label label-primary">Inactive</span>';
                                        $Json['aaData'][$k][]='<a href="/merchant/edit-rewardzone-campaign.php?id='.$Row['id'].'" ><span  class="camp_action" data-campid="'.$Row['id'].'" data-ac="edit">Edit</span></a>&nbsp;'.$del.'&nbsp;<a href="javascript:void(0);" ><span  class="camp_action" data-campid="'.$Row['id'].'"  data-ac="active-deactive" data-active="'.$Row['active'].'">'.$act.'</span></a>';
                                        $k++;
                                }        
                        }
                        $memcached->set("get_rewardzone_campaigns_".$mer_id."_".$_REQUEST['iDisplayStart']."_".$_REQUEST['camp_filter_year']."_".$_REQUEST['camp_filter_category']."_".$_REQUEST['camp_filter_status'],$Json,time() + CACHE_30_MIN);
		
	}	
	$Json['sEcho'] = $_REQUEST['sEcho'];
	echo json_encode($Json);
        exit;
}
/**
 * Delete reward zone campaign
 */
if(isset($_REQUEST['del_rewardzone_campaign'])){
        if($_SESSION['merchant_id']){
		$array_w['merchant_id'] = $_SESSION['merchant_id'];
		$array_w['id'] = $_REQUEST['id'];
		$array['is_deleted'] = 1;
		$objDBWrt->Update($array,"rewardzone_campaigns",$array_w);
		$memcached->deletekeysbyprefix("get_rewardzone_campaigns_".$_SESSION['merchant_id']."_");

		echo 1;	
	}else{
		echo 0;	
	}
}
/**
 * Active deactive reward zone campaign
 */
if(isset($_REQUEST['activ_deactiv_rewardzone_campaign'])){
      if($_SESSION['merchant_id']){
		$pack = $objDB->Conn->Execute('SELECT mb.id,mb.merchant_id,mb.pack_id,b.pack_name,b.reward_zone_active_campaign,b.reward_zone_active_gift_card FROM merchant_billing mb Inner join billing_packages b on b.id=mb.pack_id and mb.merchant_id=?', array($_SESSION['merchant_id']));
//$reward_zone_active_gift_card = $pack->fields['reward_zone_active_gift_card'];
$limit_reward_zone_active_campaign = $pack->fields['reward_zone_active_campaign'];

		$RS = $objDB->Conn->Execute('select count(id) as total from rewardzone_campaigns where merchant_id=? AND is_deleted=? AND active=? ',array($_SESSION['merchant_id'],0,1));

$total_reward_zone_active_campaign = $RS->fields['total'];
		//echo $limit_reward_zone_active_campaign.' -- '.$total_reward_zone_active_campaign;
		if(($_REQUEST['active'] == 1)&&($limit_reward_zone_active_campaign <= $total_reward_zone_active_campaign)){
			echo 0;
		}else{
			$array_w['merchant_id'] = $_SESSION['merchant_id'];
			$array_w['id'] = $_REQUEST['id'];
			//echo "Here".$_REQUEST['active'];
			if($_REQUEST['active'] == 1)
			{
			$array_w['is_edited'] = 1;
			}
			$array['active'] = $_REQUEST['active'];
			$objDBWrt->Update($array,"rewardzone_campaigns",$array_w);
		
			$memcached->deletekeysbyprefix("get_rewardzone_campaigns_".$_SESSION['merchant_id']."_");

			echo 1;	
		}	
	}else{
		echo 0;	
	}  
}
/**
 * Gift card terms and conditions
 */
if(isset($_REQUEST['gift_card_terms_conditions'])){
        if($_SESSION['merchant_id']){
		
                $array['condition'] = $_REQUEST['term'];
                if($_REQUEST['id']>0){
                        $array_w['id'] = $_REQUEST['id'];
                        $array_w['merchant_id'] = $_SESSION['merchant_id'];
                        $objDBWrt->Update($array,"giftcard_terms_conds",$array_w);    
                }else{
                        $array['merchant_id'] = $_SESSION['merchant_id'];
                        $array['created'] = date('Y-m-d H:i:s');
                        $id = $objDBWrt->Insert($array,"giftcard_terms_conds");
                        echo $id;
                }
			
	}else{
		echo 0;	
	}
}
/**
 * filter reward zone gift card's totals
 */
if(isset($_REQUEST['filter_reward_gift_total'])){
	if($_SESSION['merchant_id']){
		$mid  = $_SESSION['merchant_id'];
		$currency1= $_SESSION['merchant_info']['currrency_symbol'];
		//print_r($_SESSION);
		/*$year = $_REQUEST['year'];
		$month = $_REQUEST['month'];

		if(isset($_REQUEST['year'])){
                        if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
                             $where .= ' AND created LIKE  "%'.$_REQUEST['year'].'-'.$_REQUEST['month'].'%"';  
                        }else{
                             $where .= ' AND created LIKE  "%'.$_REQUEST['year'].'%"';   
                        }
                        
                }else{
                        $where .=" AND r.created LIKE '%".date('Y')."%'";
                        
                }
                
                if(isset($_REQUEST['year'])){
                        if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
                             $where1 .= ' WHERE date_issued LIKE "%'.$_REQUEST['year'].'-'.$_REQUEST['month'].'%"';  
                        }else{
                             $where1 .= ' WHERE date_issued LIKE "%'.$_REQUEST['year'].'%"';   
                        }
                        
                }*/

		//$RS = $objDB->Conn->Execute('select count(id) as total from giftcards where merchant_id=? AND is_deleted=? AND is_active=? '.$where.' '.$sLimit,array($mid,0,1));
       // $RS1 = $objDB->Conn->Execute('select points_earned_giftcard, points_earned_giftcard_pending from merchant_point_management where merchant_id=?',array($mid));
       // $RS2 = $objDB->Conn->Execute('select sum(card_value) as total_val from giftcard_certificate'.$where1); 
        $where =" AND created > DATE_SUB( NOW() , INTERVAL 18 MONTH )";
        $where1 =" AND gcc.date_issued > DATE_SUB( NOW() , INTERVAL 18 MONTH )";
        $where2 =" AND date > DATE_SUB( NOW() , INTERVAL 18 MONTH )";
        $RS = $objDB->Conn->Execute('select count(id) as total from giftcards where merchant_id=? AND is_deleted=? AND is_active=? '.$where.' ' .$sLimit,array($mid,0,1));
        
        $RS1 = $objDB->Conn->Execute('select points_earned_giftcard_pending from merchant_point_management where merchant_id=?',array($mid));
        $RS3 = $objDB->Conn->Execute('select SUM(points) as points_earned_giftcard from giftcard_transaction where merchant_id=? AND type=?'.$where2,array($mid,1));
       
        $RS2 = $objDB->Conn->Execute('select sum(gcc.card_value) as total_val , count(gcc.id) as total_sold from giftcard_certificate gcc inner join giftcards gc on gc.id = gcc.giftcard_id AND gc.merchant_id =? '.$where1,array($mid)); 
		
        //$RS3 = $objDB->Conn->Execute('select points_earned_giftcard_pending from merchant_point_management where merchant_id=?',array($mid));
        //echo 'select points_earned_giftcard_pending from merchant_point_management where merchant_id=17 '.$where;
        
		$json['total_points_avail_earn'] = $RS1->fields['points_earned_giftcard_pending'];
		$json['total_points_earn'] = $RS3->fields['points_earned_giftcard'];
		  $json['currency']= $currency1;
                $json['total_card_sold_val'] = $RS2->fields['total_val'];
                $json['total_card_sold'] = $RS2->fields['total_sold'];
              //  echo 'select sum(card_value) as total_val from giftcard_certificate'.$where1;
		$json['status'] = 'true';
		if($RS->RecordCount()>0){
			$json['total_card_active'] = $RS->fields['total'];
					
		}else{
			$json['total_card_active'] = 0;		
		}
		
		
	}else{
		$json['status'] = 'false';	
	}
	echo json_encode($json);
	exit;	
}
/**
 * Filter rewardzone campaign's total
 */
if(isset($_REQUEST['filter_reward_camp_total'])){
	if($_SESSION['merchant_id']){
		$mid  = $_SESSION['merchant_id'];
		$currency1= $_SESSION['merchant_info']['currrency_symbol'];
		/*$year = $_REQUEST['year'];
		$month = $_REQUEST['month'];
		if(isset($_REQUEST['year'])){
                        if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
                             $where .= ' AND created LIKE  "%'.$_REQUEST['year'].'-'.$_REQUEST['month'].'%"';  
                        }else{
                             $where .= ' AND created LIKE  "%'.$_REQUEST['year'].'%"';   
                        }
                        
                }else{
                        $where .=" AND r.created LIKE '%".date('Y')."%'";
                        
                }
                
                if(isset($_REQUEST['year'])){
                        if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
                             $where1 .= ' AND redeem_date LIKE  "%'.$_REQUEST['year'].'-'.$_REQUEST['month'].'%"';  
                        }else{
                             $where1 .= ' AND redeem_date LIKE  "%'.$_REQUEST['year'].'%"';   
                        }
                        
                }
                
                if(isset($_REQUEST['year'])){
                        if(isset($_REQUEST['month']) && !empty($_REQUEST['month'])){
                             $where2.= ' AND rct.redeem_date LIKE  "%'.$_REQUEST['year'].'-'.$_REQUEST['month'].'%"';  
                        }else{
                             $where2.= ' AND rct.redeem_date LIKE  "%'.$_REQUEST['year'].'%"';   
                        }
                        
                }*/
				 $where =" AND created > DATE_SUB( NOW( ) , INTERVAL 18 MONTH )";
				 $where1 =" AND rct.redeem_date > DATE_SUB( NOW( ) , INTERVAL 18 MONTH )";
				 $where2 =" AND rcc.date_issued > DATE_SUB( NOW( ) , INTERVAL 18 MONTH )";
		//$RS = $objDB->Conn->Execute('select count(id) as total from rewardzone_campaigns where merchant_id=? AND is_deleted=? AND active=? '.$where.' '.$sLimit,array($mid,0,1));
       //         $RS1 = $objDB->Conn->Execute('select count(id) as total from rewardzone_campaign_transaction where employee_id=?'.$where1,array($mid));
        //        $RS2 = $objDB->Conn->Execute('SELECT SUM(rcc.`merchants_points`) as total FROM `rewardzone_campaign_transaction` rct INNER JOIN `rewardzone_campaign_certificate` rcc WHERE rct.`employee_id`=? AND rct.`rewardzone_campaign_certificate_id`=rcc.`id` AND rcc.`status`=1'.$where2,array($mid));
		$RS = $objDB->Conn->Execute('select count(id) as total from rewardzone_campaigns where merchant_id=? AND is_deleted=? AND active=? '.$where.' '.$sLimit,array($mid,0,1));
        $RS1 = $objDB->Conn->Execute('select count(id) as total from rewardzone_campaign_transaction where employee_id=?',array($mid));
        $RS2 = $objDB->Conn->Execute('SELECT SUM(rcc.`merchants_points`) as total FROM `rewardzone_campaign_transaction` rct INNER JOIN `rewardzone_campaign_certificate` rcc WHERE rct.`employee_id`=? AND rct.`rewardzone_campaign_certificate_id`=rcc.`id` AND rcc.`status`=1'.$where1,array($mid));
		/*$RS3 = $objDB->Conn->Execute('SELECT SUM(rcc.`merchants_points`) as total1  FROM `rewardzone_campaign_certificate` rcc INNER JOIN rewardzone_campaigns rc WHERE rc.id=rcc.`rewardzone_campaign_id` AND rc.active = 1 AND rc.is_deleted = 0 AND rc.`merchant_id` = ?',array($mid));*/
		$RS3 = $objDB->Conn->Execute('SELECT SUM(rcc.`merchants_points`) as total1 ,count(rcc.id) as total_sold FROM `rewardzone_campaign_certificate` rcc INNER JOIN rewardzone_campaigns rc WHERE rc.id=rcc.`rewardzone_campaign_id` AND  rc.`merchant_id` = ?'.$where2,array($mid));
		
		$json['total_campagins_redeem'] = $RS1->fields['total'];
		$json['total_points_earn'] = $RS2->fields['total'];	
		$json['status'] = 'true';
		$json['currency']= $currency1;
        $json['total_camp_sold_val'] = $RS3->fields['total1'];
        $json['total_camp_sold'] = $RS3->fields['total_sold'];
                if($RS2->RecordCount()>0){
			$json['total_points_earn'] = $RS2->fields['total'];
					
		}else{
			$json['total_points_earn'] = 0;		
		}
		if($RS->RecordCount()>0){
			$json['total_camp_active'] = $RS->fields['total'];
					
		}else{
			$json['total_camp_active'] = 0;		
		}
		
		
	}else{
		$json['status'] = 'false';	
	}
	echo json_encode($json);
	exit;	
}

if (isset($_REQUEST['redeem_user_giftcard'])) {
    if ($_SESSION['merchant_id']) {
        $merchant_id = $_SESSION['merchant_id'];
        $gc_code = $_REQUEST['gc_code'];
        //$gc_points = $_REQUEST['gc_points'];
        $gc_value = $_REQUEST['gc_value'];
        $trans_type = $_REQUEST['trans'];

        $array = $array1 = $json = $media_acc_array = array();
        
        if ($_SESSION['merchant_info']['merchant_parent'] == 0) {
              $location_val = $_SESSION['merchant_info']['redeem_location'];
                } else {
                         $media_acc_array['merchant_user_id'] = $_SESSION['merchant_id'];
                         $RSmedia = $objDB->Show("merchant_user_role", $media_acc_array);
                          $location_val = $RSmedia->fields['location_access'];
                        }
//error_reporting(E_ALL);
        
        	
	          	
		        $RS = $objDB->Conn->Execute("SELECT * from giftcard_certificate where certificate_id=? and is_deleted=0", array($gc_code));
		        $total_records = $RS->RecordCount();
		        if ($total_records == 1) {
		            $gc_id = $RS->fields['giftcard_id'];
		            $gift_certi_id = $RS->fields['id'];
		            $user_id = $RS->fields['user_id'];
		            $merchant_points = $RS->fields['merchants_points'];
		            $card_value = $RS->fields['card_value'];
		            $mer_pts_cre = $RS->fields['merchant_points_credited'];
		            $status = $RS->fields['status'];
		            $date_issued = $RS->fields['date_issued'];
		            $expiry_date = date("Y-m-d H:i:s",strtotime("+365 day", strtotime($date_issued)));
		            $today = date("Y-m-d H:i:s", mktime());
		            //echo $date_issued.'exp'.$expiry_date.'tod'.$today;exit();
		            
		            if(strtotime($today) > strtotime($expiry_date)){
		                $array['status'] = "false";
		                $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_expire"];
		                $json = json_encode($array);
		                echo $json;
		                exit();
		            }
		            
		            //POINTS CALCULATION FORMULA
		            $gc_points = ($merchant_points/$card_value)*$gc_value;
                            
		            if ($trans_type == "debit") {
		                if ($status == 1) {
		                    $array['status'] = "false";
		                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_points_over"];
		                    $json = json_encode($array);
		                    echo $json;
		                    exit();
		                }
		                if (($merchant_points - $mer_pts_cre) < $gc_points) {
		                    $array['status'] = "false";
		                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_points_check"];
		                    $json = json_encode($array);
		                    echo $json;
		                    exit();
		                }
                                //START DEBIT TRANSACTION
                                $objDBWrt->Conn->StartTrans();
		                $RS1 = $objDB->Conn->Execute("SELECT points_earned_giftcard_pending, points_earned_giftcard, points_available from merchant_point_management where merchant_id=?", array($merchant_id));
		                $points_pending = $RS1->fields['points_earned_giftcard_pending'];
		                $points_earned = $RS1->fields['points_earned_giftcard'];
		                $points_avail = $RS1->fields['points_available'];
		                $points_avail_update = $points_avail + $gc_points;
		                $points_pending_update = $points_pending - $gc_points;  
		                $points_earned_update = $points_earned + $gc_points;
		                $objDBWrt->Conn->Execute("Update merchant_point_management set points_earned_giftcard_pending=?, points_earned_giftcard=?, points_available=? where merchant_id=?", array($points_pending_update,$points_earned_update,$points_avail_update,$merchant_id));
		                
		                $array1['date'] = date("Y-m-d H:i:s");
		                $array1['user_id'] = $user_id;
		                $array1['giftcard_certificate_id'] = $gift_certi_id;
		                $array1['amount'] = $gc_value;
		                $array1['type'] = 1;
		                $array1['location_id'] = $location_val;
		                $array1['merchant_id'] = $merchant_id;
		                $array1['points'] = $gc_points;
		                $objDBWrt->Insert($array1, "giftcard_transaction");

		                $new_mer_points = $mer_pts_cre + $gc_points;
		                $objDBWrt->Conn->Execute("Update giftcard_certificate set merchant_points_credited=? where user_id=? and certificate_id=?", array($new_mer_points,$user_id,$gc_code));
		                //$objDBWrt->Conn->Execute("Update giftcard_certificate set merchant_points_credited=? where user_id='k' and certificate_id=?", array($new_mer_points,$gc_code));
		                if($new_mer_points == $merchant_points){
		                    $objDBWrt->Conn->Execute("Update giftcard_certificate set status=1 where user_id=? and certificate_id=?", array($user_id,$gc_code));
		                    $objDBWrt->Conn->Execute("DELETE FROM `customer_card` WHERE `giftcard_certificate_id`=?",array($gift_certi_id));
//		                    $array['status'] = "true";
//		                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_points_over_and_redeem"];
//		                    $json = json_encode($array);
//		                    echo $json;
//		                    exit();
		                }
                                $res = $objDBWrt->Conn->CompleteTrans();
                                //DEBIT TRANSACTION SUCCESS
                                if($res == true){
                                    $array['status'] = "true";
                                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_redeem"];
                                    $json = json_encode($array);
                                    echo $json;
                                    exit();
                                 //DEBIT TRANSACTION FAILURE
                                }else{
                                    $file = $_SERVER['DOCUMENT_ROOT'] ."/redeem_log.txt";
                                    $myfile = fopen($file, "a+") or die("Unable to open file!");
                                    chmod($file, 0777);
                                    $txt = "Merchant id:".$merchant_id." Giftcard code:".$gc_code." Amount:".$_SESSION['merchant_info']['currency_code'].$gc_value." Points:".$gc_points." Transaction type:".$trans_type." Date/Time:".date("Y-m-d H:i:s")." Status:Failed\n";
                                    fwrite($myfile, $txt);
                                    fclose($myfile);
                                    $array['status'] = "false";
                                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_transaction_failure"];
                                    $json = json_encode($array);
                                    echo $json;
                                    exit();
                                }
		                
		            }
		            if ($trans_type == "credit") {
		            
		                $RES = $objDB->Conn->Execute("SELECT points_available from merchant_point_management where merchant_id=?", array($merchant_id));    
		                $points_avail = $RES->fields['points_available'];
		                if($gc_points > $points_avail){
		                    $array['status'] = "false";
		                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_no_balance_for_credit"];
		                    $json = json_encode($array);
		                    echo $json;
		                    exit();
		                }
		                
		                $val_check = $merchant_points - $mer_pts_cre;
                                $val_check = $merchant_points - $val_check;
		                if($gc_points > $val_check){
		                    $array['status'] = "false";
		                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_value_exceeds"];
		                    $json = json_encode($array);
		                    echo $json;
		                    exit(); 
		               }
		                
		                if($mer_pts_cre >= $gc_points){
		                //START CREDIT TRANSACTION
                                $objDBWrt->Conn->StartTrans();
                                $array1['date'] = date("Y-m-d H:i:s");
		                $array1['user_id'] = $user_id;
		                $array1['giftcard_certificate_id'] = $gift_certi_id;
		                $array1['amount'] = $gc_value;
		                $array1['type'] = 0;
		                $array1['location_id'] = $location_val;
		                $array1['merchant_id'] = $merchant_id;
		                $array1['points'] = $gc_points;
		                $objDB->Insert($array1, "giftcard_transaction");
		                $mer_pts_cred = $mer_pts_cre - $gc_points;
		                $objDBWrt->Conn->Execute("Update giftcard_certificate set merchant_points_credited=? where user_id=? and certificate_id=?", array($mer_pts_cred,$user_id,$gc_code));
		                
		                $RS1 = $objDB->Conn->Execute("SELECT points_earned_giftcard, points_available, points_earned_giftcard_pending from merchant_point_management where merchant_id=?", array($merchant_id));
		                $points_earned = $RS1->fields['points_earned_giftcard'];
		                $points_avail = $RS1->fields['points_available'];
                                $points_earned_pending = $RS1->fields['points_earned_giftcard_pending'];
		                $new_points_avail = $points_avail - $gc_points;
		                $new_points_earned = $points_earned - $gc_points;
                                $new_points_earned_pending = $points_earned_pending + $gc_points;
		                $objDBWrt->Conn->Execute("Update merchant_point_management set points_earned_giftcard=?, points_available=?, points_earned_giftcard_pending=? where merchant_id=?", array($new_points_earned,$new_points_avail,$new_points_earned_pending,$merchant_id));
		                $res = $objDBWrt->Conn->CompleteTrans();
                                //CREDIT TRANSACTION SUCCESS
                                if($res == true){
                                    $array['status'] = "true";
                                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_credit"];
                                    $json = json_encode($array);
                                    echo $json;
                                    exit();
                                //CREDIT TRANSACTION FAILURE    
                                }else{
                                    $file = $_SERVER['DOCUMENT_ROOT'] ."/redeem_log.txt";
                                    $myfile = fopen($file, "a+") or die("Unable to open file!");
                                    chmod($file, 0777);
                                    $txt = "Merchant id:".$merchant_id." Giftcard code:".$gc_code." Amount:".$_SESSION['merchant_info']['currency_code'].$gc_value." Points:".$gc_points." Transaction type:".$trans_type." Date/Time:".date("Y-m-d H:i:s")." Status:Failed\n";
                                    fwrite($myfile, $txt);
                                    fclose($myfile);
                                    $array['status'] = "false";
                                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_transaction_failure"];
                                    $json = json_encode($array);
                                    echo $json;
                                    exit();
                                }
		                }else{
		                    $array['status'] = "false";
		                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_not_credit"];
		                    $json = json_encode($array);
		                    echo $json;
		                    exit();
		                    
		                }
		                }
		                
		            }
		            else {
		            $array['status'] = "false";
		            $array['msg'] = $merchant_msg["redeem-deal"]["Msg_invalid_giftcard"];
		            $json = json_encode($array);
		            echo $json;
		            exit();
		        }
             
        }
}

if (isset($_REQUEST['redeem_reward_campaign'])) {
    if ($_SESSION['merchant_id']) {
        $merchant_id = $_SESSION['merchant_id'];
        $cp_code = $_REQUEST['cp_code'];
        //$cp_points = $_REQUEST['cp_points'];
        $array = $array1 = $json = $media_acc_array = array();
        
        if ($_SESSION['merchant_info']['merchant_parent'] == 0) {
              $location_val = $_SESSION['merchant_info']['redeem_location'];
                } else {
                         $media_acc_array['merchant_user_id'] = $_SESSION['merchant_id'];
                         $RSmedia = $objDB->Show("merchant_user_role", $media_acc_array);
                          $location_val = $RSmedia->fields['location_access'];
                        }

        $RS = $objDB->Conn->Execute("SELECT * from rewardzone_campaign_certificate where certificate_id=? and is_deleted=0 and is_redeem=0 and is_points_credited=0", array($cp_code));
        
        $total_records = $RS->RecordCount();
        if ($total_records == 1) {
            $cp_id = $RS->fields['id'];
            $user_id = $RS->fields['user_id'];
            $merchant_points = $RS->fields['merchants_points'];
            //$status = $RS->fields['status'];
            $date_issued = $RS->fields['date_issued'];
            $expiry_date = date("Y-m-d H:i:s",strtotime("+365 day", strtotime($date_issued)));
            $today = date("Y-m-d H:i:s", mktime());
            //echo $date_issued.'exp'.$expiry_date.'tod'.$today;exit();
            
            if(strtotime($today) > strtotime($expiry_date)){
                $array['status'] = "false";
                $array['msg'] = "Your campaign has been expired";
                $json = json_encode($array);
                echo $json;
                exit();
            }
            
            $objDBWrt->Conn->Execute("DELETE FROM `customer_card` WHERE `reward_campaign_certificate_id`=?",array($cp_id));
            
                /*if ($status == 1) {
                    $array['status'] = "false";
                    $array['msg'] = "Your card points has been finished";
                    $json = json_encode($array);
                    echo $json;
                    exit();
                }*/
                
                $RS1 = $objDB->Conn->Execute("SELECT points_available from merchant_point_management where merchant_id=?", array($merchant_id));
                $points_avail = $RS1->fields['points_available'];
                $points_avail_update = $points_avail + $merchant_points;
                $objDBWrt->Conn->Execute("Update merchant_point_management set points_available=? where merchant_id=?", array($points_avail_update,$merchant_id));
                
                $array1['redeem_date'] = date("Y-m-d H:i:s");
                $array1['location_id'] = $location_val;
                $array1['employee_id'] = $merchant_id;
                $array1['rewardzone_campaign_certificate_id'] = $cp_id;
                $objDB->Insert($array1, "rewardzone_campaign_transaction");
                
                $objDBWrt->Conn->Execute("Update rewardzone_campaign_certificate set is_redeem=1, is_points_credited=1 where user_id=? and certificate_id=?", array($user_id,$cp_code));
                $array['status'] = "true";
                $array['msg'] = "Your rewardzone campaign has been redeemed";
                $json = json_encode($array);
                echo $json;
                exit();
            
        } else {
            $array['status'] = "false";
            $array['msg'] = "Invalid code";
            $json = json_encode($array);
            echo $json;
            exit();
        }
    }
}

if (isset($_REQUEST['recent_giftcard_transactions'])) {
    if ($_SESSION['merchant_id']) {
        $sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
//		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
//			 $_REQUEST['iDisplayLength'] ;
                $sLimit = "LIMIT ".$_REQUEST['iDisplayStart'].", ".$_REQUEST['iDisplayLength'];
	}
        $merchant_id = $_SESSION['merchant_id'];
        $gc_code = $_REQUEST['gc_code'];
        $c_symbol = $_SESSION['merchant_info']['currrency_symbol'];
        $array = $array1 = array();
        $RS = $objDB->Conn->Execute("SELECT id from giftcard_certificate where certificate_id=? ", array($gc_code));
        
        $Json['aaData'] = array();
        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
        

        $id = $RS->fields['id'];
        $RS1 = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS date, location_id, amount from giftcard_transaction where type=1 AND giftcard_certificate_id=? ".$sLimit, array($id));
        $sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
	$total= $sQuery->fields['FOUND_ROWS()'];
        $Json['iTotalDisplayRecords'] = $total;
        
        if($RS->RecordCount()>0) {
            $k=0;
            while($Row = $RS1->FetchRow())
            {
                $l_id = $Row['location_id'];
                $RS2 = $objDB->Conn->Execute("SELECT location_name, address from locations where id=?", array($l_id));
                $Row2 = $RS2->FetchRow();
                $Row['location_name']=$Row2['location_name'];
                $Row['address']=$Row2['address'];

                $Json['aaData'][$k][]= $Row['date'];
                //$Json['aaData'][$k][]= $Row['location_name'];
                $Json['aaData'][$k][]= $Row['address'];
                $Json['aaData'][$k][]= $c_symbol.$Row['amount'];
                //$new[]=$Row;
                $k++;
            }
        }
        $Json['sEcho'] = $_REQUEST['sEcho'];    
        echo json_encode($Json);
        exit;
    }
}

if (isset($_REQUEST['giftcard_balance'])) {
    if ($_SESSION['merchant_id']) {
    $merchant_id = $_SESSION['merchant_id'];
    $gc_code = $_REQUEST['gc_code'];
    $RS = $objDB->Conn->Execute("SELECT * from giftcard_certificate where certificate_id=? and is_deleted=0", array($gc_code));    
    $total_records = $RS->RecordCount();
    $array = $json = array();

        if ($total_records == 1) {
            $gc_id = $RS->fields['giftcard_id'];
            $tot_pts = $RS->fields['merchants_points'];
            $card_value = $RS->fields['card_value'];
            $debited = $RS->fields['merchant_points_credited'];
            $balance_points = $tot_pts - $debited;
            $balance = $balance_points/($tot_pts/$card_value);
            $RS1 = $objDB->Conn->Execute("SELECT title,card_value from giftcards where id=?", array($gc_id));
            $title = $RS1->fields['title'];
            $c_symbol = $_SESSION['merchant_info']['currrency_symbol'];
            $card_value = $RS1->fields['card_value'];
            $array['status'] = 1;
            $array['title'] = $title;
            $array['balance'] = $c_symbol.number_format($balance,2); 
            $array['value'] = $c_symbol.$card_value;
            $json = json_encode($array);
            echo $json;
            exit();
        }else{
            $array['status'] = 0;
            $array['msg'] = 'Invalid Gift Card';
            $json = json_encode($array);
            echo $json;
            exit();
        }
    
    }
    
    }
    
if (isset($_REQUEST['view_user_giftcards'])) {
    if ($_SESSION['merchant_id']) {
        $sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}
        $Json['aaData'] = array();
        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
        $Json['iTotalDisplayRecords'] = $total;

        $merchant_id = $_SESSION['merchant_id'];
        $reward_card_number = $_REQUEST['reward_card_number'];
        $c_symbol = $_SESSION['merchant_info']['currrency_symbol'];
        $array = $array1 = array();
        $RS = $objDB->Conn->Execute("SELECT id from customer_user where card_id=?", array($reward_card_number));
        $id = $RS->fields['id'];
        $RS1 = $objDB->Conn->Execute("SELECT gc.title, gcc.card_value, gcc.certificate_id, gcc.merchants_points/gcc.card_value AS ratio, gcc.merchants_points - gcc.merchant_points_credited AS balance FROM giftcard_certificate gcc INNER JOIN giftcards gc ON gcc.giftcard_id = gc.id WHERE gcc.user_id = ? AND gcc.status=0 AND gc.merchant_id = ?", array($id,$merchant_id));
        if($RS->RecordCount()>0) {
            $k=0;
        while($Row = $RS1->FetchRow())
        {
            $Json['aaData'][$k][]= $Row['title'];
            $Json['aaData'][$k][]= $c_symbol.$Row['card_value'];
            $Json['aaData'][$k][]= $c_symbol.number_format($Row['balance']/$Row['ratio'],2);
            $Json['aaData'][$k][]= '<span class=rec_trans style="cursor:pointer" data-value="'.$Row['certificate_id'].'">View</span>';
            $Json['aaData'][$k][]= '<span class=redeem_gc style="cursor:pointer" data-value="'.$Row['certificate_id'].'">Redeem</span>';
            $k++;
        }
        }
        $Json['sEcho'] = $_REQUEST['sEcho'];    
        echo json_encode($Json);
        exit;
    }
}

if (isset($_REQUEST['view_user_loyalty_cards'])) {
    if ($_SESSION['merchant_id']) {
        $sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}
        $Json['aaData'] = array();
        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
        $Json['iTotalDisplayRecords'] = $total;

        $merchant_id = $_SESSION['merchant_id'];
        $reward_card_number = $_REQUEST['reward_card_number'];
        $c_symbol = $_SESSION['merchant_info']['currrency_symbol'];
        $array = $array1 = array();
        $RS = $objDB->Conn->Execute("SELECT id from customer_user where card_id=?", array($reward_card_number));
       
        $id = $RS->fields['id'];
        //$RS1 = $objDB->Conn->Execute("SELECT gc.title FROM giftcard_certificate gcc INNER JOIN giftcards gc ON gcc.giftcard_id = gc.id WHERE gcc.user_id = ? AND gcc.status=0 AND gc.merchant_id = ?", array($id,$merchant_id));
        $RS1 = $objDB->Conn->Execute("SELECT mlc.title as title,clrc.code as code,mlc.stamps_per_card as total_stamp,clrc.total_stamp_left as stamp_left,clrc.card_status as status
									  FROM merchant_loyalty_card mlc INNER JOIN customer_loyalty_reward_card clrc
									  WHERE mlc.id = clrc.card_id AND mlc.merchant_id =? AND clrc.card_status = ? AND  clrc.total_stamp_left != ? AND clrc.user_id = ? GROUP BY clrc.date_activated DESC "
									  , array($merchant_id,1,0,$id));
	    /*$RS1 = $objDB->Conn->Execute("SELECT mlc.title as title,clrc.card_type as card_type,mlrc.reward_title as reward_title,clrc.code as code,mlc.stamps_per_card as total_stamp,clrc.total_stamp_left as stamp_left,clrc.card_status as status
									  FROM merchant_loyalty_card mlc INNER JOIN customer_loyalty_reward_card clrc
									  WHERE mlc.id = clrc.card_id AND mlc.merchant_id =? AND clrc.card_status = ? AND  clrc.total_stamp_left != ? AND clrc.user_id = ? GROUP BY clrc.date_activated DESC "
									  , array($merchant_id,1,0,$id));*/
									  
		$RS1 = $objDB->Conn->Execute("SELECT mlc.title as title,mlrc.reward_title 'reward_title',clrc.card_type,clrc.code as code,mlc.stamps_per_card as total_stamp,clrc.total_stamp_left as stamp_left,clrc.card_status as status
FROM merchant_loyalty_card mlc,merchant_loyalty_reward_card mlrc,customer_loyalty_reward_card clrc
WHERE mlc.id = clrc.card_id and mlc.id=mlrc.loyalty_card_id AND mlc.merchant_id =? AND clrc.card_status = ? AND  clrc.user_id = ? GROUP BY clrc.date_activated DESC "
		, array($merchant_id,1,$id));
		
        if($RS->RecordCount()>0) 
        {
            $k=0;
			while($Row = $RS1->FetchRow())
			{
			   if($Row['card_type'] == 1 && $Row['stamp_left']>0)
			   {
				  
					$Json['aaData'][$k][]= $Row['title'];
					$Json['aaData'][$k][]= $Row['total_stamp'];
					$Json['aaData'][$k][]= $Row['stamp_left'];
				 
				   if($Row['stamp_left'] == 0 && $Row['status'] != 1){
					$Json['aaData'][$k][]= '<span class=redeem_lc1 style="cursor:pointer" data-value="'.$Row['code'].'">Redeem</span>';
				   
				   }
				   else{
					$Json['aaData'][$k][]= '<span class=redeem_lc style="cursor:pointer" data-value="'.$Row['code'].'">Redeem</span>';
				   }
					$k++;
				}
				else if($Row['card_type'] == 2)
				{
					$Json['aaData'][$k][]= $Row['reward_title'];
					$Json['aaData'][$k][]= 1;
					$Json['aaData'][$k][]= 1;
				 
				   if($Row['stamp_left'] == 0 && $Row['status'] != 1){
					$Json['aaData'][$k][]= '<span class=redeem_lc1 style="cursor:pointer" data-value="'.$Row['code'].'">Redeem</span>';
				   
				   }
				   else{
					$Json['aaData'][$k][]= '<span class=redeem_lc style="cursor:pointer" data-value="'.$Row['code'].'">Redeem</span>';
				   }
					$k++;
				}
			}
        }
        $Json['sEcho'] = $_REQUEST['sEcho'];    
        echo json_encode($Json);
        exit;
    }
}


if (isset($_REQUEST['view_user_reward_campaigns'])) {
    if ($_SESSION['merchant_id']) {
        $sLimit = "";
	if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
	{
		$sLimit = "LIMIT ". $_REQUEST['iDisplayStart'] .", ".
			 $_REQUEST['iDisplayLength'] ;
	}
        $Json['aaData'] = array();
        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
        $Json['iTotalDisplayRecords'] = $total;

        $merchant_id = $_SESSION['merchant_id'];
        $reward_card_number = $_REQUEST['reward_card_number'];
        $array = $array1 = array();
        $RS = $objDB->Conn->Execute("SELECT id from customer_user where card_id=?", array($reward_card_number));
        $id = $RS->fields['id'];
        $RS1 = $objDB->Conn->Execute("SELECT rc.title, rcc.certificate_id FROM rewardzone_campaign_certificate rcc INNER JOIN rewardzone_campaigns rc ON rcc.rewardzone_campaign_id = rc.id WHERE rcc.user_id = ? and rc.merchant_id = ? and rcc.is_redeem = 0 and rcc.is_deleted = 0 and rc.is_deleted = 0", array($id,$merchant_id));
        if($RS->RecordCount()>0) {
            $k=0;
        while($Row = $RS1->FetchRow())
        {
            
            $Json['aaData'][$k][]= $Row['title'];
            $Json['aaData'][$k][]= '<span class=redeem_cp style="cursor:pointer" data-value="'.$Row['certificate_id'].'">Redeem</span>';
            $k++;
        }
        }
        $Json['sEcho'] = $_REQUEST['sEcho'];    
        echo json_encode($Json);
        exit;
    }
}

if (isset($_REQUEST['check_info_ajax'])) {
    if ($_SESSION['merchant_id']) {
     $merchant_id = $_SESSION['merchant_id'];
        $gc_code = $_REQUEST['gc_code'];
        $gc_value = $_REQUEST['gc_value'];
        $trans_type = $_REQUEST['trans'];
        
        $RS = $objDB->Conn->Execute("SELECT * from giftcard_certificate where certificate_id=? and is_deleted=0", array($gc_code));
        $total_records = $RS->RecordCount();
        if ($total_records == 1) {
            $gc_id = $RS->fields['giftcard_id'];
            $gift_certi_id = $RS->fields['id'];
            $user_id = $RS->fields['user_id'];
            $merchant_points = $RS->fields['merchants_points'];
            $card_value = $RS->fields['card_value'];
            $mer_pts_cre = $RS->fields['merchant_points_credited'];
            $status = $RS->fields['status'];
            $date_issued = $RS->fields['date_issued'];
            $expiry_date = date("Y-m-d H:i:s",strtotime("+365 day", strtotime($date_issued)));
            $today = date("Y-m-d H:i:s", mktime());
            
            if(strtotime($today) > strtotime($expiry_date)){
                $array['status'] = "false";
                $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_expire"];
                $json = json_encode($array);
                echo $json;
                exit();
            }
            
            if (strpos($gc_value,'-') !== false) {
                $array['status'] = "false";
                $array['msg'] = $merchant_msg["redeem-deal"]["Msg_enter_giftcard_numeric"];
                $json = json_encode($array);
                echo $json;
                exit();
        }
            
            $gc_points = ($merchant_points/$card_value)*$gc_value;
            
            if ($trans_type == "debit") {
                if ($status == 1) {
                    $array['status'] = "false";
                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_points_over"];
                    $json = json_encode($array);
                    echo $json;
                    exit();
                }
                if (($merchant_points - $mer_pts_cre) < $gc_points) {
                    $array['status'] = "false";
                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_points_check"];
                    $json = json_encode($array);
                    echo $json;
                    exit();
                }
            }
                
                if ($trans_type == "credit") {
            
                $RES = $objDB->Conn->Execute("SELECT points_available from merchant_point_management where merchant_id=?", array($merchant_id));    
                $points_avail = $RES->fields['points_available'];
                if($gc_points >= $points_avail){
                    $array['status'] = "false";
                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_no_balance_for_credit"];
                    $json = json_encode($array);
                    echo $json;
                    exit();
                }
                
                 $val_check = $merchant_points - $mer_pts_cre;
                 $val_check = $merchant_points - $val_check;
                if($gc_points > $val_check){
                    $array['status'] = "false";
                    $array['msg'] = $merchant_msg["redeem-deal"]["Msg_giftcard_value_exceeds"];
                    $json = json_encode($array);
                    echo $json;
                    exit(); 
               }
        } 
    }
   }
}

if(isset($_REQUEST['filter_point_earned']))
{
    $merchant_id = $_SESSION['merchant_id'];
    
    $json['status'] = 'true';
    
    $RS = $objDB->Conn->Execute("SELECT points_earned_giftcard,points_available,points_blocked_loyaltycard,points_spent_loyaltycard from merchant_point_management where merchant_id=?", array($merchant_id));    
     
	$json['points_giftcard'] = $RS->fields['points_earned_giftcard']; 
	$json['points_available_total']= $RS->fields['points_available'];
	
    $RS1 = $objDB->Conn->Execute("SELECT SUM(merchants_points) as point_camp from rewardzone_campaign_certificate where is_redeem=?", array(1));
	
	$json['points_campaign'] = $RS1->fields['point_camp']; 
	$json['total_earned'] = $RS->fields['points_earned_giftcard'] + $RS1->fields['point_camp'];
	
	$RS2 = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS IFNULL(title,0), IFNULL(sum(block_point),0) 'block_point'
FROM merchant_loyalty_card mlc, customer_loyalty_reward_card clrc
WHERE mlc.id = clrc.card_id
AND mlc.merchant_id =?
AND clrc.card_status =1
AND block_point !=0
ORDER BY modified_date DESC", array($merchant_id));    
	
	$json['points_blocked_lc'] = $RS2->fields['block_point']; 
	
	$RS3 = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS IFNULL(title,0), IFNULL(sum(spent_point),0) 'spent_point'
FROM merchant_loyalty_card mlc, customer_loyalty_reward_card clrc
WHERE mlc.id = clrc.card_id
AND mlc.merchant_id =?
AND clrc.card_status =1
AND spent_point !=0
ORDER BY modified_date DESC", array($merchant_id));

	$json['points_spend_lc'] = $RS3->fields['spent_point'];
	
	//print_r($json);  
	echo json_encode($json);
	exit(); 
}
	if(isset($_REQUEST['point_earned_camp_show'])){
                                $mer_id = $_REQUEST['mer_id'];
                                $Json =array();

                                //echo "camp ".$mer_id;
                                $Json = $memcached->get("point_earned_camp_show_".$mer_id."_".$_REQUEST['iDisplayStart']);
                                if(empty($Json)){
                                        $sLimit = "";
                                        if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
                                        {
                                                $sLimit = "LIMIT ".$_REQUEST['iDisplayStart'].", ".$_REQUEST['iDisplayLength'];
                                        }
                                        //echo "SELECT rc.title,SUM(rcc.merchants_points) as sum_merchant_points from rewardzone_campaigns rc INNER JOIN  rewardzone_campaign_certificate rcc where  rc.merchant_id = 17 AND rc.id = rcc. rewardzone_campaign_id AND rc.active=1 AND rc.is_deleted=0 AND rcc.is_redeem = 1 AND rcc.is_points_credited = 1   GROUP BY rewardzone_campaign_id".$sLimit;
                                        $RS = $objDB->Conn->Execute("SELECT SQL_CALC_FOUND_ROWS rc.title,SUM(rcc.merchants_points) as sum_merchant_points from rewardzone_campaigns rc INNER JOIN  rewardzone_campaign_certificate rcc where  rc.merchant_id = ? AND rc.id = rcc. rewardzone_campaign_id AND rc.active=? AND rc.is_deleted=? AND rcc.is_redeem = ? AND rcc.is_points_credited =?  GROUP BY rewardzone_campaign_id ".$sLimit , array($mer_id,1,0,1,1));
                                        $sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
                                        $total= $sQuery->fields['FOUND_ROWS()'];
                                        $Json = array();
                                        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
                                        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
                                        $Json['iTotalDisplayRecords'] = $total;
                                        $Json['aaData'] = array();
                                        if($RS->RecordCount()>0)
                                                {
                                                        $k =0;
                                                        while($Row = $RS->FetchRow())
                                                        {  
                                                                                                        //print_r($Row);
                                                                $Json['aaData'][$k][]= $Row['title'];
                                                                $Json['aaData'][$k][]= $Row['sum_merchant_points'];
                                                                $k++;
                                                        }        
                                                }
                                                $memcached->set("point_earned_camp_show_".$mer_id."_".$_REQUEST['iDisplayStart'],$Json,time() + CACHE_30_MIN);
                                }	
                                $Json['sEcho'] = $_REQUEST['sEcho'];
                                //print_r($Json);
                                echo json_encode($Json);
                            exit;
                        }
                     
                    if(isset($_REQUEST['point_earned_gift_show'])){
                                $merchant_id = $_REQUEST['mer_id'];
                                //echo "here ".$merchant_id;
                               // echo "here "$_REQUEST['iDisplayLength']
                                $Json =array();


                                $Json = $memcached->get("point_earned_gift_show_".$merchant_id."_".$_REQUEST['iDisplayStart']);
                                if(empty($Json)){
                                        $sLimit = "";
                                        if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
                                        {
                                                $sLimit = " LIMIT ".$_REQUEST['iDisplayStart'].", ".$_REQUEST['iDisplayLength'];
                                        }
                                        //echo "select gc.title, sum(gcc.merchant_points_credited) as sum_merchant_points_credited from giftcards gc INNER JOIN giftcard_certificate gcc where merchant_id =17 AND gc.id=gcc.giftcard_id GROUP BY gcc.giftcard_id ".$sLimit;
                                        $RS = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS gc.title, sum(gcc.merchant_points_credited) as sum_merchant_points_credited from giftcards gc INNER JOIN giftcard_certificate gcc where merchant_id = ? AND gc.id=gcc.giftcard_id GROUP BY gcc.giftcard_id " .$sLimit, array($merchant_id));
                                        $sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
                                        $total= $sQuery->fields['FOUND_ROWS()'];
                                        $Json = array();
                                        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
                                        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
                                        $Json['iTotalDisplayRecords'] = $total;
                                        $Json['aaData'] = array();
                                        if($RS->RecordCount()>0)
                                                {
                                                        $k =0;
                                                        while($Row = $RS->FetchRow())
                                                        {  
                                                                                                        //print_r($Row);
                                                                $Json['aaData'][$k][]= $Row['title'];
                                                                $Json['aaData'][$k][]= $Row['sum_merchant_points_credited'];
                                                                $k++;
                                                        }        
                                                }
                                                $memcached->set("point_earned_gift_show_".$merchant_id."_".$_REQUEST['iDisplayStart'],$Json,time() + CACHE_30_MIN);
                                }	
                                $Json['sEcho'] = $_REQUEST['sEcho'];
                                echo json_encode($Json);
                            exit;
                        }

 if(isset($_REQUEST['point_block_loyalty_card_show'])){
                                $merchant_id = $_REQUEST['mer_id'];
                                //echo "here ".$merchant_id;
								// echo "here "$_REQUEST['iDisplayLength']
                                $Json =array();
										$Json = $memcached->get("point_block_loyalty_card_show".$merchant_id."_".$_REQUEST['iDisplayStart']);
										if(empty($Json)){
                                        $sLimit = "";
                                        if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
                                        {
                                                $sLimit = " LIMIT ".$_REQUEST['iDisplayStart'].", ".$_REQUEST['iDisplayLength'];
                                        }
                                       // $where =" AND created_date > DATE_SUB( NOW() , INTERVAL 18 MONTH )";
                                        //echo "select SQL_CALC_FOUND_ROWS title, points_required FROM merchant_loyalty_card WHERE merchant_id=? AND card_status = ? ".$where.$sLimit;
                                       // $RS = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS title, points_required FROM merchant_loyalty_card WHERE merchant_id=? AND card_status = ? ".$sLimit, array($merchant_id,2));
                                        
                                        //$RS = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS title, points_required FROM merchant_loyalty_card WHERE merchant_id=? AND is_published = ? AND card_status = ? ORDER BY modified_date DESC ".$sLimit, array($merchant_id,1,2));
                                        
                                        $RS = $objDB->Conn->Execute("select SQL_CALC_FOUND_ROWS title, block_point 'points_required'
FROM merchant_loyalty_card mlc,customer_loyalty_reward_card clrc
WHERE mlc.id=clrc.card_id and mlc.merchant_id=? AND clrc.card_status=? and block_point!=?
ORDER BY modified_date DESC ".$sLimit, array($merchant_id,1,0)); 

                                        $sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
                                        $total= $sQuery->fields['FOUND_ROWS()'];
                                        $Json = array();
                                        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
                                        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
                                        $Json['iTotalDisplayRecords'] = $total;
                                        $Json['aaData'] = array();
                                        if($RS->RecordCount()>0)
                                                {
                                                        $k =0;
                                                        while($Row = $RS->FetchRow())
                                                        {  
                                                                //print_r($Row);
                                                                $Json['aaData'][$k][]= $Row['title'];
                                                                $Json['aaData'][$k][]= $Row['points_required'];
                                                                $k++;
                                                        }        
                                                }
                                              //  $memcached->set("point_block_loyalty_card_show".$merchant_id."_".$_REQUEST['iDisplayStart'],$Json,time() + CACHE_30_MIN);
                                }	
                                $Json['sEcho'] = $_REQUEST['sEcho'];
                                echo json_encode($Json);
                            exit;
                        }


if(isset($_REQUEST['point_spend_loyalty_card_show'])){
                                $merchant_id = $_REQUEST['mer_id'];
                                //echo "here ".$merchant_id;
                               // echo "here "$_REQUEST['iDisplayLength']
                                $Json =array();


                                //$Json = $memcached->get("point_spend_loyalty_card_show_".$merchant_id."_".$_REQUEST['iDisplayStart']);
                                if(empty($Json)){
                                        $sLimit = "";
                                        if ( isset( $_REQUEST['iDisplayStart'] ) && $_REQUEST['iDisplayLength'] != '-1' )
                                        {
                                                $sLimit = " LIMIT ".$_REQUEST['iDisplayStart'].", ".$_REQUEST['iDisplayLength'];
                                        }
                                        $where =" AND created_date > DATE_SUB( NOW() , INTERVAL 18 MONTH )";
                                        //echo "select SQL_CALC_FOUND_ROWS title, points_required FROM merchant_loyalty_card WHERE merchant_id=? AND card_status = ? ".$where.$sLimit;
                                        /*
                                        $RS = $objDB->Conn->Execute("SELECT mlc.title, SUM( clct.point_spent ) 
													FROM merchant_loyalty_card mlc
													INNER JOIN customer_loyalty_reward_card clrc ON mlc.id = clrc.card_id
													INNER JOIN customer_loyalty_card_transaction clct ON clrc.id = clct.user_card_id
													WHERE mlc.merchant_id =? 
													AND mlc.card_status =?
													GROUP BY clrc.card_id".$where.$sLimit, array($merchant_id,2));
										*/			
										$RS = $objDB->Conn->Execute("SELECT mlc.title, clrc.spent_point 'point_spend'
FROM merchant_loyalty_card mlc
INNER JOIN customer_loyalty_reward_card clrc ON mlc.id = clrc.card_id
WHERE mlc.merchant_id =?
AND clrc.card_status =?
and spent_point!=? ".$where.$sLimit, array($merchant_id,1,0));			
                                        $sQuery = $objDB->Conn->Execute("SELECT FOUND_ROWS()");
                                        $total= $sQuery->fields['FOUND_ROWS()'];
                                        $Json = array();
                                        $Json['iDisplayLength'] = $_REQUEST['iDisplayLength'];
                                        $Json['iDisplayStart'] = $_REQUEST['iDisplayStart'];
                                        $Json['iTotalDisplayRecords'] = $total;
                                        $Json['aaData'] = array();
                                        if($RS->RecordCount()>0)
                                                {
                                                        $k =0;
                                                        while($Row = $RS->FetchRow())
                                                        {  
                                                                //print_r($Row);
                                                                $Json['aaData'][$k][]= $Row['title'];
                                                                $Json['aaData'][$k][]= $Row['point_spend'];
                                                                $k++;
                                                        }        
                                                }
                                              //  $memcached->set("point_spend_loyalty_card_show_".$merchant_id."_".$_REQUEST['iDisplayStart'],$Json,time() + CACHE_30_MIN);
                                }	
                                $Json['sEcho'] = $_REQUEST['sEcho'];
                                echo json_encode($Json);
                            exit;
                        }

/******** 
@USE : insert videos
@PARAMETER : video_link,video_id,thumbnail_url 
@RETURN :  json data
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['btnAddVideoOfMerchant']))
{
	/*
	echo "<pre>";
	print_r($_REQUEST);
	echo "</pre>";
	exit();
	*/ 
	$json_array = array();
	$records = array();
	
	$pack_data_mu_old =  array();
    $pack_data_mu_old['merchant_id'] =  $_SESSION['merchant_id'];
    $get_billing_pack_data_mu_old = $objDB->Show("merchant_billing", $pack_data_mu_old);
    
    $pack_data_mu_old1 =  array();
    $pack_data_mu_old1['id'] = $get_billing_pack_data_mu_old->fields['pack_id'];
    $get_billing_pack_data_mu_old1 = $objDB->Show("billing_packages", $pack_data_mu_old1);
    
    $mer_video_count_total = $get_billing_pack_data_mu_old1->fields['video_upload_limit'];        
    $mer_video_count_used = $_SESSION['merchant_info']['video_count'];
    if($mer_video_count_used < $mer_video_count_total)
    {
		
		$RS = $objDB->Conn->Execute("SELECT * from merchant_videos where video_id=? and merchant_id=?", array($_REQUEST['video_id'],$_SESSION['merchant_id']));
		$total_records = $RS->RecordCount();
		if ($total_records == 0) 
		{
				
			$array_insert = array();
			$array_insert['merchant_id'] =  $_SESSION['merchant_id'];
			$array_insert['video_link'] = $_REQUEST['video_link'];
			$array_insert['video_id'] = $_REQUEST['video_id'];
			$array_insert['thumbnail_url'] = $_REQUEST['thumbnail_url'];
			$array_insert['video_title'] = $_REQUEST['video_title'];
			$array_insert['video_type'] = $_REQUEST['video_type'];
			$objDBWrt->Insert($array_insert, "merchant_videos");
			
			$objJSON->increase_video_count_for_merchant();
			
			$_SESSION['is_video_added']=1;			
			$json_array['status'] = "true";
			$json = json_encode($json_array);
			echo $json;
			exit();
		}
		else
		{
			$json_array['status'] = "false";
			$json = json_encode($json_array);
			echo $json;
			exit();
		}
	}
	else
	{
		$json_array['status'] = "false_upload";
		$json_array['message'] = "Sorry, you can't upload more than ". $get_billing_pack_data_mu_old1->fields['video_upload_limit'] ."  videos.";
		$json = json_encode($json_array);
		echo $json;
		exit();
	}
}

/******** 
@USE : my images ajax tab
@PARAMETER : 
@RETURN :  json data
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['btnGetImageOfMerchantAjax']))
{
	//echo "1";
	
	$arr=file(WEB_PATH.'/merchant/process.php?getallmainmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);				 
	if(trim($arr[0]) == "")
	{
		unset($arr[0]);
		$arr = array_values($arr);
	}
	$json = json_decode($arr[0]);	
	$all_main_merchant_id= $json->all_main_merchant_id; 
	
	if($all_main_merchant_id == "")
	{
		$all_main_merchant_id =$_SESSION['merchant_id'];
	}
	else
	{
		$all_main_mer_array=explode(",",$all_main_merchant_id);
	}  
	//echo $all_main_merchant_id;
	
	$arr=file(WEB_PATH.'/merchant/process.php?getallsubmercahnt_id=yes&mer_id='.$main_merchant_id);
	if(trim($arr[0]) == "")
	{
		unset($arr[0]);
		$arr = array_values($arr);
	}
	$json = json_decode($arr[0]);
	$ids= $json->all_sub_merchant_id;
	if($ids == "")
	{
		$ids =$_SESSION['merchant_id'];
	}
	//echo $ids;
	
	$start_index = 0;
	$num_of_records = 16;
	$next_index = $start_index + $num_of_records;
	
	$query = "select * from merchant_media where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) or id in( select merchant_media_id from media_import_image where merchant_id=?) order by id desc limit 0,$num_of_records" ; // with prepare query				
	$query1 = "select count(*) total from merchant_media where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?)  or id in( select merchant_media_id from media_import_image where merchant_id=?) order by id desc" ;  // with prepare query
	
	$RS = $objDB->Conn->Execute($query,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id'],$_SESSION['merchant_id']));
	$RS1 = $objDB->Conn->Execute($query1,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id'],$_SESSION['merchant_id']));
	$total_images = $RS1->fields['total'];
	
	if($_SESSION['merchant_info']['merchant_parent'] != 0)
	{
		/* * **** get employee role ( which role is assigned to user ) check upload,view ,delete uplaod image permission of employee ************** */
		$media_acc_array = array();
		$media_acc_array['merchant_user_id'] = $_SESSION['merchant_id'];
		$RSmedia = $objDB->Show("merchant_user_role",$media_acc_array);
		$media_val = unserialize($RSmedia->fields['media_access']);
		if(in_array("delete",$media_val))
		{
			$flag_delete = true;
		}
		else{
			$flag_delete = false;	
		}
		if(in_array("view-use",$media_val))
		{
			$flag_view = true;
		}
		else{
			$flag_view = false;	
		}
		if(in_array("upload",$media_val))
		{
			$flag_upload = true;
		}
		else{
			$flag_upload = false;	
		}
	}
	else
	{
		$flag_delete = true;
		$flag_view = true;
		$flag_upload = true;
	}
		
	$html='<div align="center">';
				$html.='<div class="filtergroup">';
					$html.='<h3>Filter</h3>';
					$html.='<div class="filters">';
						$html.='<input type="button" id="imagetype_all" name="imagetype_all"  class="fltr_button fltr_selected" value="All Images" />';
						$html.='<input type="button" id="imagetype_campaign" name="imagetype_campaign"  class="fltr_button" value="Campaigns" />';
						$html.='<input type="button" id="imagetype_location" name="imagetype_location"  class="fltr_button" value="Locations" />';
						$html.='<input type="button" id="imagetype_giftcard" name="imagetype_giftcard"  class="fltr_button" value="Gift cards" />';
					$html.='</div>';
				$html.='</div>';
			$html.='</div>';
			
			if($RS->RecordCount()=="0")
			{			
				$html.='<div class="deletemsgclass deletemsgclass_media table_errore_message" >'.$merchant_msg["mediamanagement"]["Msg_no_images"].'</div>';
				$html.='<div class="deletemsgclass_close" >X</div>';
			}
			else
			{
				$html.='<div class="deletemsgclass deletemsgclass_media table_errore_message" style="display:none;"></div>';
				$html.='<div class="deletemsgclass_close" style="display:none;">X</div>';
			}
			
			$html.='<div id="upload_business_logo_ajax1" class="upload_business_logo_ajax nax_scrape_indicator hidden_elem" style="display:none;">';
				$html.='<img height="32" width="32" alt="" src="'.ASSETS_IMG.'/24.GIF" >';
			$html.='</div>';
	$html.="<div class='mediya_image_container_wrapper'><div id='mediya_image_container'>";
		
	if($RS->RecordCount()>0)
	{ 
		while($Row = $RS->FetchRow())
		{	
			if($Row['media_type_id'] == "1")
			{
				$target = "campaign" ;
				$html.='<div class="mediya_img_blk campaignfilter">';
			}
			if($Row['media_type_id'] == "2")
			{
				$target = "location";
				$html.='<div class="mediya_img_blk locationfilter">';
			}
			if($Row['media_type_id'] == "3")
			{
				$target = "giftcard";
				$html.='<div class="mediya_img_blk giftcardfilter">';
			}
			
			
			$html.='<a href="javascript:void(0)" class="mediya_camp_loca">';
			if($Row['media_type_id'] == "1")
			{
				$html.='<img title="Campaign" src="'.ASSETS_IMG.'/m/mediya_campaign.png" />'; 
			}
			if($Row['media_type_id'] == "2")
			{
				$html.='<img title="Location" src="'.ASSETS_IMG.'/m/mediya_location.png" />'; 
			}
			if($Row['media_type_id'] == "3")
			{
				$html.='<img title="Giftcard" src="'.ASSETS_IMG.'/m/mediya_giftcard.png" />'; 
			}
			$html.='</a>';
			$html.='<img src="'.ASSETS_IMG.'/m/'.$target.'/'.$Row['image'].'" class= "mediya_grid" />';
			
			if($flag_delete)
			{
				if($Row['merchant_id']==1)
				{			
					$html.='<a href="javascript:void(0)" admin_image="1" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediadeleteid_'.$Row['id'].'" class="mediya_delete">';
								$html.='<img src="'.ASSETS_IMG.'/m/mediya_delete.png">';
							$html.='</a>';
				}
				else
				{
					if(in_array($Row['merchant_id'], $all_main_mer_array))
					{
					}
					else if(!in_array($Row['merchant_id'], $all_main_mer_array) && !in_array($Row['merchant_id'], $sub_merchant) && $Row['merchant_id']!=$_SESSION['merchant_id'])
					{
					}
					else
					{
						$html.='<a href="javascript:void(0)" admin_image="0" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediadeleteid_'.$Row['id'].'" class="mediya_delete">';
									$html.='<img src="'.ASSETS_IMG.'/m/mediya_delete.png">';
								$html.='</a>';
					}
				} 
			}
			$html.='</div>';	
		}
	}
	$html.='</div>';
		
	if($RS->RecordCount()>0 && $total_images>$num_of_records)
	{
	$html.='<div id="mediya_showmore" style="display:block;">';
			$html.='<input type="button" id="show_more_mediya" name="show_more_mediya" value="Show More" next_index="'.$next_index.'" num_of_records="'.$num_of_records.'" total_images="'.$total_images.'" />';
		$html.='</div>';
	
	}				
	$json_array['status'] = "true";
	$json_array['html'] = $html;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

/******** 
@USE : my video ajax tab
@PARAMETER : 
@RETURN :  json data
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['btnGetVideoOfMerchantAjax']))
{
	//echo "1";
	
	$arr=file(WEB_PATH.'/merchant/process.php?getallmainmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);				 
	if(trim($arr[0]) == "")
	{
		unset($arr[0]);
		$arr = array_values($arr);
	}
	$json = json_decode($arr[0]);	
	$all_main_merchant_id= $json->all_main_merchant_id; 
	
	if($all_main_merchant_id == "")
	{
		$all_main_merchant_id =$_SESSION['merchant_id'];
	}
	//echo $all_main_merchant_id;
	
	$arr=file(WEB_PATH.'/merchant/process.php?getallsubmercahnt_id=yes&mer_id='.$main_merchant_id);
	if(trim($arr[0]) == "")
	{
		unset($arr[0]);
		$arr = array_values($arr);
	}
	$json = json_decode($arr[0]);
	$ids= $json->all_sub_merchant_id;
	if($ids == "")
	{
		$ids =$_SESSION['merchant_id'];
	}
	//echo $ids;
	
	$start_index = 0;
	$num_of_records = 16;
	$next_index = $start_index + $num_of_records;
	$query_v = "select * from merchant_videos where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc limit 0,$num_of_records" ; // with prepare query
	$query1_v = "select count(*) total from merchant_videos where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc" ;  // with prepare query
				
	$RS_v = $objDB->Conn->Execute($query_v,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id']));
	$RS1_v = $objDB->Conn->Execute($query1_v,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id']));
	$total_videos = $RS1_v->fields['total'];
	
	$html='<div align="center">
				<div class="filtergroup_video">
					<h3>Filter</h3>
					<div class="filters_video">
						<input type="button" id="videotype_all" name="videotype_all"  class="fltr_button_video fltr_selected_video" value="All Videos" />
						<input type="button" id="videotype_youtube" name="videotype_youtube"  class="fltr_button_video" value="Youtube" />
						<input type="button" id="videotype_vimeo" name="videotype_vimeo"  class="fltr_button_video" value="Vimeo" />
					</div>
				</div>
			</div>';
			
			if($RS_v->RecordCount()=="0")
			{			
				$html.='<div class="deletemsgclass deletemsgclass_media table_errore_message" >'.$merchant_msg["mediamanagement"]["Msg_no_videos"].'</div>';
				$html.='<div class="deletemsgclass_close" >X</div>';
			}
			else
			{
				$html.='<div class="deletemsgclass deletemsgclass_media table_errore_message" style="display:none;"></div>';
				$html.='<div class="deletemsgclass_close" style="display:none;">X</div>';
			}
			
			$html.='<div id="upload_business_logo_ajax1" class="upload_business_logo_ajax nax_scrape_indicator hidden_elem" style="display:none;">
				<img height="32" width="32" alt="" src="'.ASSETS_IMG.'/24.GIF" >
			</div>';
	$html.="<div class='mediya_video_container_wrapper'><div id='mediya_video_container'>";
		
	if($RS_v->RecordCount()>0)
	{ 
		while($Row = $RS_v->FetchRow())
		{	
			if($Row['video_type'] == "youtube")
			{
				$html.='<div class="mediya_video_blk youtubefilter">';
			}
			if($Row['video_type'] == "vimeo")
			{
				$html.='<div class="mediya_video_blk vimeofilter">';
			}
				$html.='<a href="'.$Row['video_link'].'" target="_new" >
					<img src="'.$Row['thumbnail_url'].'" class= "mediya_grid_video" />
				<a>
				<a href="javascript:void(0)" image_type='.$Row['video_type'].' id="videodeleteid_'.$Row['id'].'" class="mediya_delete">
					<img src="'.ASSETS_IMG.'/m/mediya_delete.png">
				</a>
			</div>';	
		}
	}
	$html.="</div></div>";
		
	if($RS_v->RecordCount()>0 && $total_videos>$num_of_records)
	{
	$html.='
		<div id="mediya_showmore_videos" style="display:block;">
			<input type="button" id="show_more_videos" name="show_more_videos" value="Show More" next_index="'.$next_index.'" num_of_records="'.$num_of_records.'" total_videos="'.$total_videos.'" />
		</div>';
	
	}				
	$json_array['status'] = "true";
	$json_array['html'] = $html;
	$json = json_encode($json_array);
	echo $json;
	exit();
}


/******** 
@USE : images in add location media gallery
@PARAMETER : 
@RETURN :  json data
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['btnGetImageOfMerchantAjaxInGallery']))
{
	//echo "1";
	$html="";
	$arr=file(WEB_PATH.'/merchant/process.php?getallmainmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);				 
	if(trim($arr[0]) == "")
	{
		unset($arr[0]);
		$arr = array_values($arr);
	}
	$json = json_decode($arr[0]);	
	$all_main_merchant_id= $json->all_main_merchant_id; 
	
	if($all_main_merchant_id == "")
	{
		$all_main_merchant_id =$_SESSION['merchant_id'];
	}
	else
	{
		$all_main_mer_array=explode(",",$all_main_merchant_id);
	}  
	//echo $all_main_merchant_id;
	
	$arr=file(WEB_PATH.'/merchant/process.php?getallsubmercahnt_id=yes&mer_id='.$main_merchant_id);
	if(trim($arr[0]) == "")
	{
		unset($arr[0]);
		$arr = array_values($arr);
	}
	$json = json_decode($arr[0]);
	$ids= $json->all_sub_merchant_id;
	if($ids == "")
	{
		$ids =$_SESSION['merchant_id'];
	}
	//echo $ids;
	
	$start_index = 0;
	$num_of_records_l = 16;
	$next_index = $start_index + $num_of_records_l;
	
	// image gallery queries
				
	$query_l = "select * from merchant_media where media_type_id=2 and ( merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) or id in( select merchant_media_id from media_import_image where merchant_id=?) ) order by id desc limit 0,$num_of_records_l" ; // with prepare query				
	
	$query1_l = "select count(*) total from merchant_media where media_type_id=2 and ( merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?)  or id in( select merchant_media_id from media_import_image where merchant_id=?) ) order by id desc" ;  // with prepare query
	
	$RS_l = $objDB->Conn->Execute($query_l,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id'],$_SESSION['merchant_id']));
	
	$RS1_l = $objDB->Conn->Execute($query1_l,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id'],$_SESSION['merchant_id']));
	
	$total_images_l = $RS1_l->fields['total'];
				 
	// image gallery queries
		
	if($RS_l->RecordCount()>0)
	{ 
		$RS_l->MoveFirst();
		while($Row = $RS_l->FetchRow())
		{
			if($Row['media_type_id'] == "2")
			{	
				if($Row['media_type_id'] == "1")
				{
					$target = "campaign" ;
					$html.='<div class="mediya_img_blk campaignfilter">';
				}
				if($Row['media_type_id'] == "2")
				{
					$target = "location";
					$html.='<div class="mediya_img_blk locationfilter">';
				}
				if($Row['media_type_id'] == "3")
				{
					$target = "giftcard";
					$html.='<div class="mediya_img_blk giftcardfilter">';
				}
			
				$html.='<a href="javascript:void(0)" class="mediya_camp_loca" style="display: none;">';
				if($Row['media_type_id'] == "1")
				{
					$html.='<img title="Campaign" src="'.ASSETS_IMG.'/m/mediya_campaign.png" />'; 
				}
				if($Row['media_type_id'] == "2")
				{
					$html.='<img title="Location" src="'.ASSETS_IMG.'/m/mediya_location.png" />'; 
				}
				if($Row['media_type_id'] == "3")
				{
					$html.='<img title="Giftcard" src="'.ASSETS_IMG.'/m/mediya_giftcard.png" />'; 
				}
				$html.='</a>';
				$html.='<img src="'.ASSETS_IMG.'/m/'.$target.'/'.$Row['image'].'" class= "mediya_grid" />';
				$html.='<img class="mediya_grid1_img_selected mediya_slctd" src="'.ASSETS_IMG.'/m/image_Added_to_lbry.png">';
				
				$html.='<a title="Select Image" href="javascript:void(0)" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediaselect_'.$Row['id'].'" class="mediya_select">';
					$html.='<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">';
					$html.='<span>Select Image</span>';
				$html.='</a>';
																
				$html.='</div>';	
			}	
		}
	}
		
	$json_array['status'] = "true";
	$json_array['html'] = $html;
	$json = json_encode($json_array);
	echo $json;
	exit();
}


/******** 
@USE : videos in add location media gallery
@PARAMETER : 
@RETURN :  json data
@USED IN PAGES : media-management.php
*********/
if(isset($_REQUEST['btnGetVideoOfMerchantAjaxInGallery']))
{
	//echo "1";
	$html="";
	$arr=file(WEB_PATH.'/merchant/process.php?getallmainmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);				 
	if(trim($arr[0]) == "")
	{
		unset($arr[0]);
		$arr = array_values($arr);
	}
	$json = json_decode($arr[0]);	
	$all_main_merchant_id= $json->all_main_merchant_id; 
	
	if($all_main_merchant_id == "")
	{
		$all_main_merchant_id =$_SESSION['merchant_id'];
	}
	//echo $all_main_merchant_id;
	
	$arr=file(WEB_PATH.'/merchant/process.php?getallsubmercahnt_id=yes&mer_id='.$main_merchant_id);
	if(trim($arr[0]) == "")
	{
		unset($arr[0]);
		$arr = array_values($arr);
	}
	$json = json_decode($arr[0]);
	$ids= $json->all_sub_merchant_id;
	if($ids == "")
	{
		$ids =$_SESSION['merchant_id'];
	}
	//echo $ids;
	
	$start_index = 0;
	$num_of_records_l_v = 16;
	$next_index = $start_index + $num_of_records_l_v;
	
	$query_l_v = "select * from merchant_videos where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc limit 0,$num_of_records_l_v" ; // with prepare query
	$query1_l_v = "select count(*) total from merchant_videos where merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) order by id desc" ;  // with prepare query
	
	$RS_l_v = $objDB->Conn->Execute($query_l_v,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id']));
	$RS1_l_v = $objDB->Conn->Execute($query1_l_v,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id']));
	
	$total_videos_l = $RS1_l_v->fields['total'];
		
	if($RS_l_v->RecordCount()>0)
	{ 
		while($Row = $RS_l_v->FetchRow())
		{				
			$html.='<div class="mediya_video_blk" >
					
					<img src="'.$Row['thumbnail_url'].'" class= "mediya_grid_video" />
				
				<img class="mediya_grid1_img_selected mediya_slctd" src="'.ASSETS_IMG.'/m/image_Added_to_lbry.png">
				<a title="Select Video" href="javascript:void(0)" id="mediaselectvideo_'.$Row['id'].'" class="mediya_select">
					<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
					<span>Select Video</span>
				</a>
			</div>';	
		}
	}
						
	$json_array['status'] = "true";
	$json_array['html'] = $html;
	$json = json_encode($json_array);
	echo $json;
	exit();
}

if(isset($_REQUEST['btngetlocationVideogalleryforviewgallery'])){
	$json_array = array();
	$html ="";
	$RS = $objDB->Conn->Execute("SELECT thumbnail_url from merchant_videos mv,location_video_gallery_detail lvgd,location_video_gallery lvg
								where lvgd.location_video_gallery_id=lvg.id and mv.id = lvgd.merchant_videos_id and lvg.location_id =".$_REQUEST['location_id']);
								
	$html.='<div id="mediya_image_container_popup" style="display:inline-block">';							
	if($RS->RecordCount()>0)
	{
		while($Row = $RS->FetchRow())
		{
			$html.='<div class="mediya_img_blk locationfilter">';
				
				$html.='<img class="mediya_grid1" src="'.$Row['thumbnail_url'].'">';
				
			$html.='</div>';
		}
	}
	else
	{
		$html.='<div>No videos available to display.</div>';
	}
	$html.='</div>';
	
	$json_array['status'] = "true";
	$json_array["html"]= $html;
	
	$json = json_encode($json_array);
	echo $json;
	return $json;							
}

/******** 
@USE : to get location Video assign gallery
@PARAMETER :
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['btngetlocationVideogalleryforassigngallery'])){
	$json_array = array();
	$html ="";
	
	$RS = $objDB->Conn->Execute("SELECT mv.id,thumbnail_url from merchant_videos mv,location_video_gallery_detail lvgd,location_video_gallery lvg
								where lvgd.location_video_gallery_id=lvg.id and mv.id = lvgd.merchant_videos_id and lvg.location_id =".$_REQUEST['location_id']);
															
	$html.='<div id="mediya_image_container_popup" style="display:inline-block">';							
	if($RS->RecordCount()>0)
	{
		while($Row = $RS->FetchRow())
		{
			$html.='<div class="mediya_img_blk locationfilter">';
				$html.='<img class="mediya_grid1" src="'.$Row['thumbnail_url'].'">';
				$html.='<img class="mediya_grid1_img_selected mediya_slctd" src="'.ASSETS_IMG.'/m/image_Added_to_lbry.png">';
				$html.='<a title="Select Image" href="javascript:void(0)" id="mediaselectunassigned_'.$Row['id'].'" class="mediya_select_pp">
										<img style="display: block;text-align: left;" src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
										<span>Select Video</span>
									</a>';
			$html.='</div>';
		}
	}
	else
	{
		$html.='<div>No videos available to remove.</div>';
	}
	$html.='</div>';
	
	$json_array['status'] = "true";
	$json_array["html"]= $html;
	
	$json = json_encode($json_array);
	echo $json;
	return $json;							
}

/******** 
@USE : to get location Video assign gallery
@PARAMETER :
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['btngetlocationVideogalleryforunassigngallery'])){
	$json_array = array();
	$html ="";
	
	$arr_1=file(WEB_PATH.'/merchant/process.php?getmainmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);
		if(trim($arr_1[0]) == "")
		{
		 unset($arr_1[0]);
		 $arr_1 = array_values($arr_1);
		}
		$json_1 = json_decode($arr_1[0]);
		$main_merchant_id = $json_1->main_merchant_id;
		
	$arr=file(WEB_PATH.'/merchant/process.php?getallsubmercahnt_id=yes&mer_id='.$main_merchant_id);
		if(trim($arr[0]) == "")
		{
				unset($arr[0]);
				$arr = array_values($arr);
		}
		$json = json_decode($arr[0]);
		$ids= $json->all_sub_merchant_id;
		if($ids == "")
		  {
			  $ids =$_SESSION['merchant_id'];
		  }
	$arr=file(WEB_PATH.'/merchant/process.php?getallmainmercahnt_id=yes&mer_id='.$_SESSION['merchant_id']);
					 
	 if(trim($arr[0]) == "")
	 {
	  unset($arr[0]);
	  $arr = array_values($arr);
	 }
	 $json = json_decode($arr[0]);
			
	  $all_main_merchant_id= $json->all_main_merchant_id; 
	  
	  $all_main_mer_array = array ();
	  
	  if($all_main_merchant_id == "")
	  {
		  $all_main_merchant_id =$_SESSION['merchant_id'];
	  }
	  else
	  {
		  $all_main_mer_array=explode(",",$all_main_merchant_id);
	  }   
	
	$arr_id= array();
	
	$RS = $objDB->Conn->Execute("SELECT mv.id,thumbnail_url from merchant_videos mv,location_video_gallery_detail lvgd,location_video_gallery lvg
								where lvgd.location_video_gallery_id=lvg.id and mv.id = lvgd.merchant_videos_id and lvg.location_id =".$_REQUEST['location_id']);
															
	//$html.='<div id="mediya_image_container_popup" style="display:inline-block">';							
	while($Row = $RS->FetchRow())
	{
		array_push($arr_id,$Row[id]);
	}
	//echo "<pre>";
	//print_r($arr_id);
	//echo "</pre>";	
	
	$query_l = "select * from merchant_videos where ( merchant_id=? or merchant_id in (?) or merchant_id in (?) or merchant_id in (select id from merchant_user where merchant_parent =?) ) order by id desc " ; // with prepare query				
	
	$RS_l = $objDB->Conn->Execute($query_l,array($_SESSION['merchant_id'],$all_main_merchant_id,$ids,$_SESSION['merchant_id']));
	
	$html.='<div id="mediya_image_container_popup" style="display:inline-block">';
	$remain_img_cnt=0;
	
	while($Row = $RS_l->FetchRow())
	{
		if(in_array($Row['id'], $arr_id))
		{
		}
		else
		{
			$html.='<div class="mediya_img_blk locationfilter">';
			$html.='<img class="mediya_grid1" src="'.$Row['thumbnail_url'].'">';
			$html.='<img class="mediya_grid1_img_selected mediya_slctd" src="'.ASSETS_IMG.'/m/image_Added_to_lbry.png">';
			$html.='<a title="Select Image" href="javascript:void(0)" id="mediaselectassigned_'.$Row['id'].'" class="mediya_select_pp">
									<img style="display: block;text-align: left;" src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">
									<span>Select Video</span>
								</a>';
			$html.='</div>';
			$remain_img_cnt++;
		}
	}
	
	if($remain_img_cnt>0)
	{
	}
	else
	{
		$html.='<div>No videos available to add.</div>';
	}
	$html.='</div>';
	
	
	$json_array['status'] = "true";
	$json_array["html"]= $html;
	
	$json = json_encode($json_array);
	echo $json;
	return $json;							
}   

/******** 
@USE : to get state of country
@PARAMETER :
@RETURN : json data
@USED IN PAGES : merchant-setup.php
*********/

if(isset($_REQUEST['btngetstateofcountry'])){
	$json_array = array();
	$array_where = array();
	$array_where['country_id'] = $_REQUEST['country_id'];
	$array_where['active'] = 1;
	$RS_state = $objDB->Show("state", $array_where," Order By `name` ASC ");
	$html="<option value='0'>Please Select</option>";
	if($RS_state->RecordCount()>0)
	{
		while($Row = $RS_state->FetchRow())
		{
			$html .="<option value='".$Row['id']."'>". $Row['name']."</option>";
		}
		$json_array['status'] = "true";
	}
	else
	{
		$json_array['status'] = "false";
	}
	$json_array["html"]= $html;
	$json_array["total_records"]= $RS_state->RecordCount();	
	$json = json_encode($json_array);
	echo $json;
	return $json;	
} 

/******** 
@USE : to get city of state
@PARAMETER :
@RETURN : json data
@USED IN PAGES : merchant-setup.php
*********/

if(isset($_REQUEST['btngetcityofstate'])){
	$json_array = array();
	$array_where = array();
	$array_where['state_id'] = $_REQUEST['state_id'];
	$array_where['active'] = 1;
	$RS_city = $objDB->Show("city", $array_where," Order By `name` ASC ");
	$html="<option value='0'>Please Select</option>";
	if($RS_city->RecordCount()>0)
	{
		while($Row = $RS_city->FetchRow())
		{
			$html .="<option value='".$Row['id']."'>". $Row['name']."</option>";
		}
		$json_array['status'] = "true";
	}
	else
	{
		$json_array['status'] = "false";
	}
	$json_array["html"]= $html;
	$json_array["total_records"]= $RS_city->RecordCount();	
	$json = json_encode($json_array);
	echo $json;
	return $json;	
}   

/******** 
@USE : update admin image library
@PARAMETER :
@RETURN : json data
@USED IN PAGES : media-management.php
*********/

if(isset($_REQUEST['update_admin_image_library'])){

	$html="";

	$start_index_admin = 0;
	$num_of_records_admin = 16;
	$next_index_admin = $start_index_admin + $num_of_records_admin;
	
	//$query_admin = "select * from merchant_media where merchant_id=1 and id not in(select merchant_media_id from media_import_image where merchant_id=".$_SESSION['merchant_id'].") order by id desc limit 0,$num_of_records_admin" ;
	$query_admin = "select * from merchant_media where merchant_id=1 and id not in(select merchant_media_id from media_import_image where merchant_id=?) order by id desc limit 0,$num_of_records_admin" ; // with prepare
	//$query1_admin = "select count(*) total from merchant_media where merchant_id=1 and id not in(select merchant_media_id from media_import_image where merchant_id=".$_SESSION['merchant_id'].") order by id desc" ;
	$query1_admin = "select count(*) total from merchant_media where merchant_id=1 and id not in(select merchant_media_id from media_import_image where merchant_id=?) order by id desc" ; // with prepare
	
	$myQuery_admin = $query_admin;    
	//$RS_admin = $objDB->execute_query($query_admin);
	$RS_admin = $objDB->Conn->Execute($query_admin,array($_SESSION['merchant_id']));
	//$RS1_admin = $objDB->execute_query($query1_admin);
	$RS1_admin = $objDB->Conn->Execute($query1_admin,array($_SESSION['merchant_id']));
	  
	$total_images_admin = $RS1_admin->fields['total'];
				 
	// image gallery queries
		
	if($RS_admin->RecordCount()>0)
	{ 
		$RS_admin->MoveFirst();
		while($Row = $RS_admin->FetchRow())
		{
			if($Row['media_type_id'] == "1")
			{
				$target = "campaign" ;
				$html.='<div class="mediya_img_blk campaignfilter">';
			}
			if($Row['media_type_id'] == "2")
			{
				$target = "location";
				$html.='<div class="mediya_img_blk campaignfilter">';
			}

			$html.='<a href="javascript:void(0)" class="mediya_camp_loca" >';
			if($Row['media_type_id'] == "1")
			{
				$html.='<img title="Campaign" src="'.ASSETS_IMG.'/m/mediya_campaign.png" />'; 
			}
			if($Row['media_type_id'] == "2")
			{
				$html.='<img title="Location" src="'.ASSETS_IMG.'/m/mediya_location.png" />'; 
			}
			$html.='</a>';
			$html.='<img src="'.ASSETS_IMG.'/m/'.$target.'/'.$Row['image'].'" class= "mediya_grid" />';
			$html.='<img class="mediya_grid1_img_selected mediya_slctd" src="'.ASSETS_IMG.'/m/image_Added_to_lbry.png">';
			
			$html.='<a title="Add to My Images" href="javascript:void(0)" src="'.$Row['image'].'" image_type="'.$Row['media_type_id'].'" id="mediaadd_'.$Row['id'].'" class="mediya_add">';
				$html.='<img src="'.ASSETS_IMG.'/m/add_image_to_lbry.png">';
				$html.='<span>Add to My Images</span>';
			$html.='</a>';
															
			$html.='</div>';	
				
		}
	}
		
	$json_array['status'] = "true";
	$json_array['html'] = $html;
	$json = json_encode($json_array);
	echo $json;
	exit();
}  
 
/******** 
@USE : create loyalty metrics view
@PARAMETER :
@RETURN : json data
@USED IN PAGES : card_report.php
*********/

if(isset($_REQUEST['create_loyalty_metrics_view'])){ 
	
	$card_id = $_REQUEST['card_id'];
	$merchant_id = $_REQUEST['merchant_id'];
	
	$RS =  $objDB->Conn->Execute("CREATE OR REPLACE VIEW `card_".$card_id."_metrics_30days` AS 
select distinct (select count(*) from customer_loyalty_reward_card where card_id=".$card_id." and (DATEDIFF(now(),date_activated ) <= 30))  total_cards_activated,
			   (select count(*) from customer_loyalty_reward_card where card_status=4 and card_id=".$card_id." and (DATEDIFF
(now(),date_activated ) <= 30))  total_cards_rewarded, 
			   (select count(*) from customer_loyalty_reward_card where card_status=2 and card_id=".$card_id." and (DATEDIFF
(now(),date_deleted ) <= 30))  total_cards_deleted,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30)) total_male_activated_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=1) total_male_activated_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=2) total_male_activated_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=3) total_male_activated_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30)) total_female_activated_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=1) total_female_activated_desktop_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=2) total_female_activated_mobile_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=3) total_female_activated_qr_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30)) total_male_rewarded_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=1) total_male_rewarded_desktop_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=2) total_male_rewarded_mobile_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=3) total_male_rewarded_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30)) total_female_rewarded_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=1) total_female_rewarded_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=2) total_female_rewarded_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 30) and uc.device_activation_mode=3) total_female_rewarded_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 30)) total_male_deleted_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 30) and uc.device_activation_mode=1) total_male_deleted_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 30) and uc.device_activation_mode=2) total_male_deleted_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 30) and uc.device_activation_mode=3) total_male_deleted_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 30)) total_female_deleted_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 30) and uc.device_activation_mode=1) total_female_deleted_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 30) and uc.device_activation_mode=2) total_female_deleted_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 30) and uc.device_activation_mode=3) total_female_deleted_qr_cards 
			   from merchant_loyalty_card where merchant_id=".$merchant_id);
			   
	$RS =  $objDB->Conn->Execute("CREATE OR REPLACE VIEW `card_".$card_id."_metrics_90days` AS 
select distinct (select count(*) from customer_loyalty_reward_card where card_id=".$card_id." and (DATEDIFF(now(),date_activated ) <= 90))  total_cards_activated,
	   (select count(*) from customer_loyalty_reward_card where card_status=4 and card_id=".$card_id." and (DATEDIFF
(now(),date_activated ) <= 90))  total_cards_rewarded, 
	   (select count(*) from customer_loyalty_reward_card where card_status=2 and card_id=".$card_id." and (DATEDIFF
(now(),date_deleted ) <= 90))  total_cards_deleted,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90)) total_male_activated_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=1) total_male_activated_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=2) total_male_activated_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=3) total_male_activated_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90)) total_female_activated_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=1) total_female_activated_desktop_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=2) total_female_activated_mobile_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=3) total_female_activated_qr_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90)) total_male_rewarded_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=1) total_male_rewarded_desktop_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=2) total_male_rewarded_mobile_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=3) total_male_rewarded_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90)) total_female_rewarded_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=1) total_female_rewarded_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=2) total_female_rewarded_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 90) and uc.device_activation_mode=3) total_female_rewarded_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 90)) total_male_deleted_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 90) and uc.device_activation_mode=1) total_male_deleted_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 90) and uc.device_activation_mode=2) total_male_deleted_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 90) and uc.device_activation_mode=3) total_male_deleted_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 90)) total_female_deleted_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 90) and uc.device_activation_mode=1) total_female_deleted_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 90) and uc.device_activation_mode=2) total_female_deleted_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 90) and uc.device_activation_mode=3) total_female_deleted_qr_cards 
	   from merchant_loyalty_card where merchant_id=".$merchant_id);
	   
	$RS =  $objDB->Conn->Execute("CREATE OR REPLACE VIEW `card_".$card_id."_metrics_180days` AS 
select distinct (select count(*) from customer_loyalty_reward_card where card_id=".$card_id." and (DATEDIFF(now(),date_activated ) <= 180))  total_cards_activated,
	   (select count(*) from customer_loyalty_reward_card where card_status=4 and card_id=".$card_id." and (DATEDIFF
(now(),date_activated ) <= 180))  total_cards_rewarded, 
	   (select count(*) from customer_loyalty_reward_card where card_status=2 and card_id=".$card_id." and (DATEDIFF
(now(),date_deleted ) <= 180))  total_cards_deleted,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180)) total_male_activated_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=1) total_male_activated_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=2) total_male_activated_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=3) total_male_activated_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180)) total_female_activated_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=1) total_female_activated_desktop_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=2) total_female_activated_mobile_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=3) total_female_activated_qr_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180)) total_male_rewarded_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=1) total_male_rewarded_desktop_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=2) total_male_rewarded_mobile_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=3) total_male_rewarded_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180)) total_female_rewarded_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=1) total_female_rewarded_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=2) total_female_rewarded_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 180) and uc.device_activation_mode=3) total_female_rewarded_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 180)) total_male_deleted_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 180) and uc.device_activation_mode=1) total_male_deleted_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 180) and uc.device_activation_mode=2) total_male_deleted_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 180) and uc.device_activation_mode=3) total_male_deleted_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 180)) total_female_deleted_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 180) and uc.device_activation_mode=1) total_female_deleted_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 180) and uc.device_activation_mode=2) total_female_deleted_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 180) and uc.device_activation_mode=3) total_female_deleted_qr_cards 
	   from merchant_loyalty_card where merchant_id=".$merchant_id);   
	
	$RS =  $objDB->Conn->Execute("CREATE OR REPLACE VIEW `card_".$card_id."_metrics_365days` AS 
select distinct (select count(*) from customer_loyalty_reward_card where card_id=".$card_id." and (DATEDIFF(now(),date_activated ) <= 365))  total_cards_activated,
	   (select count(*) from customer_loyalty_reward_card where card_status=4 and card_id=".$card_id." and (DATEDIFF
(now(),date_activated ) <= 365))  total_cards_rewarded, 
	   (select count(*) from customer_loyalty_reward_card where card_status=2 and card_id=".$card_id." and (DATEDIFF
(now(),date_deleted ) <= 365))  total_cards_deleted,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365)) total_male_activated_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=1) total_male_activated_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=2) total_male_activated_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=3) total_male_activated_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365)) total_female_activated_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=1) total_female_activated_desktop_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=2) total_female_activated_mobile_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and  uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=3) total_female_activated_qr_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365)) total_male_rewarded_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=1) total_male_rewarded_desktop_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=2) total_male_rewarded_mobile_cards,
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=3) total_male_rewarded_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365)) total_female_rewarded_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=1) total_female_rewarded_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=2) total_female_rewarded_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=4 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_activated ) <= 365) and uc.device_activation_mode=3) total_female_rewarded_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 365)) total_male_deleted_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 365) and uc.device_activation_mode=1) total_male_deleted_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 365) and uc.device_activation_mode=2) total_male_deleted_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=1 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 365) and uc.device_activation_mode=3) total_male_deleted_qr_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 365)) total_female_deleted_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 365) and uc.device_activation_mode=1) total_female_deleted_desktop_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 365) and uc.device_activation_mode=2) total_female_deleted_mobile_cards, 
(select count(*) from customer_loyalty_reward_card uc,customer_user cu where uc.user_id=cu.id and cu.gender=2 and uc.card_status=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),uc.date_deleted ) <= 365) and uc.device_activation_mode=3) total_female_deleted_qr_cards 
	   from merchant_loyalty_card where merchant_id=".$merchant_id);  
	
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();		   
}      

/******** 
@USE : create loyalty revenue view
@PARAMETER :
@RETURN : json data
@USED IN PAGES : card_report.php
*********/

if(isset($_REQUEST['create_loyalty_revenue_view'])){ 
	
	$card_id = $_REQUEST['card_id'];
	$merchant_id = $_REQUEST['merchant_id'];


	$RS =  $objDB->Conn->Execute("CREATE OR REPLACE VIEW `card_".$card_id."_revenue_30days` AS 
select 
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 30)) 'total_revenue',
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 30)) 'total_male_revenue',
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 30)) 'total_female_revenue',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=38 and (DATEDIFF(NOW(),transaction_date ) <= 30)) 'total_average_revenue_per_visit',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 30)) 'total_average_male_revenue_per_visit',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 30)) 'total_average_female_revenue_per_visit',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 30) group by location_id ) customer_loyalty_card_transaction) 'total_average_revenue_per_location',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 30) group by location_id ) customer_loyalty_card_transaction) 'total_average_male_revenue_per_location',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 30) group by location_id ) customer_loyalty_card_transaction) 'total_average_female_revenue_per_location'
");

$RS =  $objDB->Conn->Execute("CREATE OR REPLACE VIEW `card_".$card_id."_revenue_90days` AS 
select 
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 90)) 'total_revenue',
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 90)) 'total_male_revenue',
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 90)) 'total_female_revenue',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=38 and (DATEDIFF(NOW(),transaction_date ) <= 90)) 'total_average_revenue_per_visit',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 90)) 'total_average_male_revenue_per_visit',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 90)) 'total_average_female_revenue_per_visit',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 90) group by location_id ) customer_loyalty_card_transaction) 'total_average_revenue_per_location',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 90) group by location_id ) customer_loyalty_card_transaction) 'total_average_male_revenue_per_location',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 90) group by location_id ) customer_loyalty_card_transaction) 'total_average_female_revenue_per_location'
");

$RS =  $objDB->Conn->Execute("CREATE OR REPLACE VIEW `card_".$card_id."_revenue_180days` AS 
select 
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 180)) 'total_revenue',
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 180)) 'total_male_revenue',
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 180)) 'total_female_revenue',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=38 and (DATEDIFF(NOW(),transaction_date ) <= 180)) 'total_average_revenue_per_visit',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 180)) 'total_average_male_revenue_per_visit',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 180)) 'total_average_female_revenue_per_visit',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 180) group by location_id ) customer_loyalty_card_transaction) 'total_average_revenue_per_location',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 180) group by location_id ) customer_loyalty_card_transaction) 'total_average_male_revenue_per_location',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 180) group by location_id ) customer_loyalty_card_transaction) 'total_average_female_revenue_per_location'
");

$RS =  $objDB->Conn->Execute("CREATE OR REPLACE VIEW `card_".$card_id."_revenue_365days` AS 
select 
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 365)) 'total_revenue',
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 365)) 'total_male_revenue',
(select IFNULL(sum(revenue),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 365)) 'total_female_revenue',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=38 and (DATEDIFF(NOW(),transaction_date ) <= 365)) 'total_average_revenue_per_visit',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 365)) 'total_average_male_revenue_per_visit',
(select IFNULL(ROUND(AVG(revenue),2),0) from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 365)) 'total_average_female_revenue_per_visit',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 365) group by location_id ) customer_loyalty_card_transaction) 'total_average_revenue_per_location',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=1 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 365) group by location_id ) customer_loyalty_card_transaction) 'total_average_male_revenue_per_location',
(select IFNULL(ROUND(avg(total_average_revenue_per_location),2),0) from (select IFNULL(ROUND(avg(revenue),2),0) 'total_average_revenue_per_location' from customer_loyalty_card_transaction pc,customer_loyalty_reward_card uc,customer_user cu where pc.user_card_id=uc.id and uc.user_id=cu.id and cu.gender=2 and uc.card_id=".$card_id." and (DATEDIFF(NOW(),transaction_date ) <= 365) group by location_id ) customer_loyalty_card_transaction) 'total_average_female_revenue_per_location'
");

	$json_array = array();
	$json_array['status'] = "true";
	$json = json_encode($json_array);
	echo $json;
	exit();		   
}             
?>
